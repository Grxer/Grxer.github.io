<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="baidu-site-verification" content="codeva-ROfYcqLkCh" />
    <meta name="msvalidate.01" content="ECA3E06A0E52A2AC90C4B06F12981FB2" />
    <meta name="description" content="实验环境不做特殊说明均为vs2022 x64 release版本 关闭优化，固定基址，关闭canary  类特性没有数据成员的类是占一个字节的，为了实例化后可以调用函数成员 类的静态数据成员与局部静态变量类似，存放的位置和全局变量一致。只是编译器增加了作用域的检查，在作用域之外不可见。 this指针this指针中保存了所属对象的首地址,需要访问类数据成员时通过rcx传递this指针，默认调用约定称">
<meta property="og:type" content="article">
<meta property="og:title" content="C++反汇编 0x00">
<meta property="og:url" content="https://grxer.gitee.io/2023/10/24/Cpp-disassemble/index.html">
<meta property="og:site_name" content="Grxer&#39;s Blog">
<meta property="og:description" content="实验环境不做特殊说明均为vs2022 x64 release版本 关闭优化，固定基址，关闭canary  类特性没有数据成员的类是占一个字节的，为了实例化后可以调用函数成员 类的静态数据成员与局部静态变量类似，存放的位置和全局变量一致。只是编译器增加了作用域的检查，在作用域之外不可见。 this指针this指针中保存了所属对象的首地址,需要访问类数据成员时通过rcx传递this指针，默认调用约定称">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://grxer.gitee.io/2023/10/24/Cpp-disassemble/image-20231025163548674.png">
<meta property="article:published_time" content="2023-10-24T08:54:34.000Z">
<meta property="article:modified_time" content="2023-10-26T05:01:24.623Z">
<meta property="article:author" content="bxz">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://grxer.gitee.io/2023/10/24/Cpp-disassemble/image-20231025163548674.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>C++反汇编 0x00</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 lrt">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/10/26/Cpp-disassemble-1/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/10/22/windows-x64-calling-conventions/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/&text=C++反汇编 0x00"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/&title=C++反汇编 0x00"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/&is_video=false&description=C++反汇编 0x00"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=C++反汇编 0x00&body=Check out this article: https://grxer.gitee.io/2023/10/24/Cpp-disassemble/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/&title=C++反汇编 0x00"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/&title=C++反汇编 0x00"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/&title=C++反汇编 0x00"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/&title=C++反汇编 0x00"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/&name=C++反汇编 0x00&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/&t=C++反汇编 0x00"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">1.</span> <span class="toc-text">实验环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E7%89%B9%E6%80%A7"><span class="toc-number">2.</span> <span class="toc-text">类特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#this%E6%8C%87%E9%92%88"><span class="toc-number">3.</span> <span class="toc-text">this指针</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E4%BD%9C%E4%B8%BA%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0"><span class="toc-number">4.</span> <span class="toc-text">对象作为函数参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E4%BD%9C%E4%B8%BA%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">5.</span> <span class="toc-text">对象作为返回值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%97%B6%E6%9C%BA"><span class="toc-number">6.</span> <span class="toc-text">构造函数调用时机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.1.</span> <span class="toc-text">局部对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A0%86%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.2.</span> <span class="toc-text">堆对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E5%AF%B9%E8%B1%A1-amp-amp-%E8%BF%94%E5%9B%9E%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.3.</span> <span class="toc-text">参数对象&amp;&amp;返回对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%AF%B9%E8%B1%A1-amp-amp-%E9%9D%99%E6%80%81%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.4.</span> <span class="toc-text">全局对象&amp;&amp;静态对象</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%97%B6%E6%9C%BA"><span class="toc-number">7.</span> <span class="toc-text">析构函数调用时机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E5%AF%B9%E8%B1%A1-1"><span class="toc-number">7.1.</span> <span class="toc-text">局部对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A0%86%E5%AF%B9%E8%B1%A1-1"><span class="toc-number">7.2.</span> <span class="toc-text">堆对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E5%AF%B9%E8%B1%A1-amp-amp-%E8%BF%94%E5%9B%9E%E5%AF%B9%E8%B1%A1-1"><span class="toc-number">7.3.</span> <span class="toc-text">参数对象&amp;&amp;返回对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%AF%B9-amp-amp-%E9%9D%99%E6%80%81%E5%AF%B9%E8%B1%A1"><span class="toc-number">7.4.</span> <span class="toc-text">全局对&amp;&amp;静态对象</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">8.</span> <span class="toc-text">Reference</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        C++反汇编 0x00
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">bxz</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-10-24T08:54:34.000Z" itemprop="datePublished">2023-10-24</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h2><p>不做特殊说明均为vs2022 x64 release版本 关闭优化，固定基址，关闭canary</p>
<p><img src="/2023/10/24/Cpp-disassemble/image-20231025163548674.png" alt="image-20231025163548674"></p>
<h2 id="类特性"><a href="#类特性" class="headerlink" title="类特性"></a>类特性</h2><p>没有数据成员的类是占一个字节的，为了实例化后可以调用函数成员</p>
<p>类的静态数据成员与局部静态变量类似，存放的位置和全局变量一致。只是编译器增加了作用域的检查，在作用域之外不可见。</p>
<h2 id="this指针"><a href="#this指针" class="headerlink" title="this指针"></a>this指针</h2><p>this指针中保存了所属对象的首地址,需要访问类数据成员时通过rcx传递this指针，默认调用约定称为thiscall</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">  <span class="type">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;        <span class="comment">//公有成员函数</span></span><br><span class="line">    this-&gt;age = age;</span><br><span class="line">  &#125;</span><br><span class="line">public:</span><br><span class="line">  <span class="type">int</span> age;                <span class="comment">//公有数据成员</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  Person person;</span><br><span class="line">  person.setAge(<span class="number">5</span>);            <span class="comment">//调用成员函数</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Person : %d\n&quot;</span>, person.age);    <span class="comment">//获取数据成员</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000140001450 ; int __fastcall main(int argc, char **argv)</span><br><span class="line">.text:0000000140001450 main proc near                          ; CODE XREF: main_0↑j</span><br><span class="line">.text:0000000140001450                                         ; DATA XREF: .pdata:000000014000900C↓o</span><br><span class="line">.text:0000000140001450</span><br><span class="line">.text:0000000140001450 var_18= Person ptr -18h</span><br><span class="line">.text:0000000140001450 arg_0= dword ptr  8</span><br><span class="line">.text:0000000140001450 arg_8= qword ptr  10h</span><br><span class="line">.text:0000000140001450</span><br><span class="line">.text:0000000140001450 mov     [rsp+arg_8], rdx</span><br><span class="line">.text:0000000140001455 mov     [rsp+arg_0], ecx                ; 保护参数</span><br><span class="line">.text:0000000140001459 sub     rsp, 38h</span><br><span class="line">.text:000000014000145D mov     edx, 5                          ; 参数为5</span><br><span class="line">.text:0000000140001462 lea     rcx, [rsp+38h+var_18]           ; this指针指向person的首地址</span><br><span class="line">.text:0000000140001467 call    j_?setAge@Person@@QEAAXH@Z      ; Person::setAge(int)</span><br><span class="line">.text:0000000140001467</span><br><span class="line">.text:000000014000146C mov     edx, [rsp+38h+var_18.age]</span><br><span class="line">.text:0000000140001470 lea     rcx, _Format                    ; &quot;Person : %d\n&quot;</span><br><span class="line">.text:0000000140001477 call    j_printf</span><br><span class="line">.text:0000000140001477</span><br><span class="line">.text:000000014000147C xor     eax, eax</span><br><span class="line">.text:000000014000147E add     rsp, 38h</span><br><span class="line">.text:0000000140001482 retn</span><br><span class="line">.text:0000000140001482</span><br><span class="line">.text:0000000140001482 main endp</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:00000001400013C0 ; void __fastcall Person::setAge(Person *this, int age)</span><br><span class="line">.text:00000001400013C0 ?setAge@Person@@QEAAXH@Z proc near      ; CODE XREF: Person::setAge(int)↑j</span><br><span class="line">.text:00000001400013C0</span><br><span class="line">.text:00000001400013C0 arg_0= qword ptr  8</span><br><span class="line">.text:00000001400013C0 arg_8= dword ptr  10h</span><br><span class="line">.text:00000001400013C0</span><br><span class="line">.text:00000001400013C0 mov     [rsp+arg_8], edx                   ;参数：5</span><br><span class="line">.text:00000001400013C4 mov     [rsp+arg_0], rcx                ; this指针指向person首地址</span><br><span class="line">.text:00000001400013C9 mov     rax, [rsp+arg_0]                ; rax=this指针</span><br><span class="line">.text:00000001400013CE mov     ecx, [rsp+arg_8]                ; rcx=5</span><br><span class="line">.text:00000001400013D2 mov     [rax], ecx                      ; this-&gt;age=5</span><br><span class="line">.text:00000001400013D4 retn</span><br></pre></td></tr></table></figure>

<h2 id="对象作为函数参数"><a href="#对象作为函数参数" class="headerlink" title="对象作为函数参数"></a>对象作为函数参数</h2><p>进入函数前预先保留对象使用的栈空间，类中没有定义拷贝构造函数，编译器会对原对象与临时对象中的各数据成员直接进行数据复制，形成一个临时对象，称为默认复制构造函数，这种复制方式属于浅拷贝，如果类带有指针变量，并有动态内存分配，它必须有一个拷贝构造函数否则会有问题</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">  Person() &#123;</span><br><span class="line">    name = new <span class="type">char</span>[<span class="number">32</span>];  <span class="comment">//申请堆空间，只要不释放，进程退出前将一直存在</span></span><br><span class="line">    age = <span class="number">18</span>;</span><br><span class="line">    <span class="keyword">if</span> (name != <span class="literal">NULL</span>) &#123;   <span class="comment">//堆空间申请成功与否</span></span><br><span class="line">      <span class="built_in">strcpy</span>(name, <span class="string">&quot;tom&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ~Person() &#123;</span><br><span class="line">    <span class="keyword">if</span> (name != <span class="literal">NULL</span>) &#123;  <span class="comment">//检查资源</span></span><br><span class="line">      delete[] name;     <span class="comment">//释放堆空间</span></span><br><span class="line">      name = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> name;        <span class="comment">//获取数据成员</span></span><br><span class="line">  &#125;</span><br><span class="line">private:</span><br><span class="line">  <span class="type">char</span>* name;          <span class="comment">//数据成员定义，保存堆的首地址</span></span><br><span class="line">  <span class="type">int</span> age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//参数为Person类对象的函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">show</span><span class="params">(Person obj)</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(obj.getName());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  Person person;  <span class="comment">//类对象定义</span></span><br><span class="line">  show(person);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000140001650</span> var_48= dword ptr <span class="number">-48</span>h</span><br><span class="line">.text:<span class="number">0000000140001650</span> var_40= Person ptr <span class="number">-40</span>h</span><br><span class="line">.text:<span class="number">0000000140001650</span> obj= Person ptr <span class="number">-28</span>h</span><br><span class="line">.text:<span class="number">0000000140001650</span> arg_0= dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">0000000140001650</span> arg_8= qword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0000000140001650</span></span><br><span class="line">.text:<span class="number">0000000140001650</span> ; FUNCTION CHUNK AT .text:<span class="number">0000000140005260</span> SIZE <span class="number">00000018</span> BYTES</span><br><span class="line">.text:<span class="number">0000000140001650</span></span><br><span class="line">.text:<span class="number">0000000140001650</span> ; __unwind &#123; <span class="comment">// __CxxFrameHandler4_0</span></span><br><span class="line">.text:<span class="number">0000000140001650</span> mov     [rsp+arg_8], rdx</span><br><span class="line">.text:<span class="number">0000000140001655</span> mov     [rsp+arg_0], ecx</span><br><span class="line">.text:<span class="number">0000000140001659</span> push    rsi</span><br><span class="line">.text:<span class="number">000000014000165</span>A push    rdi</span><br><span class="line">.text:<span class="number">000000014000165B</span> sub     rsp, <span class="number">58</span>h</span><br><span class="line">.text:<span class="number">000000014000165F</span> lea     rcx, [rsp+<span class="number">68</span>h+var_40]           ; this</span><br><span class="line">.text:<span class="number">0000000140001664</span> call    j_??<span class="number">0</span>Person@@QEAA@XZ            ; Person::Person(<span class="type">void</span>)</span><br><span class="line">.text:<span class="number">0000000140001664</span></span><br><span class="line">.text:<span class="number">0000000140001669</span> nop</span><br><span class="line">.text:<span class="number">000000014000166</span>A lea     rax, [rsp+<span class="number">68</span>h+obj]</span><br><span class="line">.text:<span class="number">000000014000166F</span> lea     rcx, [rsp+<span class="number">68</span>h+var_40]</span><br><span class="line">.text:<span class="number">0000000140001674</span> mov     rdi, rax</span><br><span class="line">.text:<span class="number">0000000140001677</span> mov     rsi, rcx</span><br><span class="line">.text:<span class="number">000000014000167</span>A mov     ecx, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">000000014000167F</span> rep movsb                               ; 采用默认拷贝构造函数在rsp+<span class="number">68</span>+obj浅拷贝生成person复制品作为参数</span><br><span class="line">.text:<span class="number">0000000140001681</span> lea     rcx, [rsp+<span class="number">68</span>h+obj]              ; obj</span><br><span class="line">.text:<span class="number">0000000140001686</span> call    j_?show@@YAXVPerson@@@Z         ; show(Person)</span><br><span class="line">.text:<span class="number">0000000140001686</span></span><br><span class="line">.text:<span class="number">000000014000168B</span> mov     [rsp+<span class="number">68</span>h+var_48], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000140001693</span> lea     rcx, [rsp+<span class="number">68</span>h+var_40]           ; this</span><br><span class="line">.text:<span class="number">0000000140001698</span> call    j_??<span class="number">1</span>Person@@QEAA@XZ            ; Person::~Person(<span class="type">void</span>)</span><br><span class="line">.text:<span class="number">0000000140001698</span></span><br><span class="line">.text:<span class="number">000000014000169</span>D mov     eax, [rsp+<span class="number">68</span>h+var_48]</span><br><span class="line">.text:<span class="number">00000001400016</span>A1 add     rsp, <span class="number">58</span>h</span><br><span class="line">.text:<span class="number">00000001400016</span>A5 pop     rdi</span><br><span class="line">.text:<span class="number">00000001400016</span>A6 pop     rsi</span><br><span class="line">.text:<span class="number">00000001400016</span>A7 retn</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">00000001400015B</span>0 ; <span class="type">void</span> __fastcall <span class="title function_">show</span><span class="params">(Person obj)</span></span><br><span class="line">.text:00000001400015B0 ?show@@YAXVPerson@@@Z proc near         ; CODE XREF: show(Person)↑j</span><br><span class="line">.text:<span class="number">00000001400015B</span>0                                         ; DATA XREF: .pdata:<span class="number">000000014000B</span>018↓o</span><br><span class="line">.text:<span class="number">00000001400015B</span>0</span><br><span class="line">.text:<span class="number">00000001400015B</span>0 arg_0= qword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">00000001400015B</span>0</span><br><span class="line">.text:<span class="number">00000001400015B</span>0 ; FUNCTION CHUNK AT .text:<span class="number">0000000140005240</span> SIZE <span class="number">00000018</span> BYTES</span><br><span class="line">.text:<span class="number">00000001400015B</span>0</span><br><span class="line">.text:<span class="number">00000001400015B</span>0 ; __unwind &#123; <span class="comment">// __CxxFrameHandler4_0</span></span><br><span class="line">.text:<span class="number">00000001400015B</span>0 mov     [rsp+arg_0], rcx                ;临时对象地址</span><br><span class="line">.text:<span class="number">00000001400015B</span>5 sub     rsp, <span class="number">28</span>h                        </span><br><span class="line">.text:<span class="number">00000001400015B</span>9 mov     rcx, [rsp+<span class="number">28</span>h+arg_0]            ; 临时对象地址 this</span><br><span class="line">.text:<span class="number">00000001400015B</span>E call    j_?getName@Person@@QEAAPEBDXZ   ; Person::getName(<span class="type">void</span>)</span><br><span class="line">.text:<span class="number">00000001400015B</span>E</span><br><span class="line">.text:<span class="number">00000001400015</span>C3 mov     rcx, rax                        ; _Format</span><br><span class="line">.text:<span class="number">00000001400015</span>C6 call    j_printf</span><br><span class="line">.text:<span class="number">00000001400015</span>C6</span><br><span class="line">.text:<span class="number">00000001400015</span>CB nop</span><br><span class="line">.text:<span class="number">00000001400015</span>CC mov     rcx, [rsp+<span class="number">28</span>h+arg_0]            ; this</span><br><span class="line">.text:<span class="number">00000001400015</span>D1 call    j_??<span class="number">1</span>Person@@QEAA@XZ            ; Person::~Person(<span class="type">void</span>)</span><br><span class="line">.text:<span class="number">00000001400015</span>D1</span><br><span class="line">.text:<span class="number">00000001400015</span>D6 add     rsp, <span class="number">28</span>h</span><br><span class="line">.text:<span class="number">00000001400015</span>DA retn</span><br></pre></td></tr></table></figure>

<p>采用了浅拷贝将同一个堆地址赋值给name，show里调用了析构释放了堆，main里的也析构造成double free crash</p>
<p><strong>第一种解决方法</strong></p>
<p>设置引用计数,在进入复制构造函数时，记录类对象被复制引用的次数。当对象被销毁时，检查这个引用计数中保存的引用复制次数是否为0。如果是，则释放申请的资源，否则引用计数减1。</p>
<p><strong>第二种解决方案</strong></p>
<p>使用拷贝构造函数深拷贝数据</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">classname (<span class="type">const</span> classname &amp;obj) &#123;</span><br><span class="line">   <span class="comment">// 拷贝构造函数的主体</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Person(<span class="type">const</span> Person &amp;obj) &#123;</span><br><span class="line">    this-&gt;age = obj.age;</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">strlen</span>(obj.name);</span><br><span class="line">    this-&gt;name = new <span class="type">char</span>[len + <span class="keyword">sizeof</span>(<span class="type">char</span>)];</span><br><span class="line">    <span class="built_in">strcpy</span>(this-&gt;name, obj.name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">00000001400016B</span>0 ; __int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">.text:00000001400016B0 main proc near                          ; CODE XREF: main_0↑j</span><br><span class="line">.text:<span class="number">00000001400016B</span>0                                         ; DATA XREF: .pdata:<span class="number">000000014000B</span>018↓o</span><br><span class="line">.text:<span class="number">00000001400016B</span>0</span><br><span class="line">.text:<span class="number">00000001400016B</span>0 var_48= dword ptr <span class="number">-48</span>h</span><br><span class="line">.text:<span class="number">00000001400016B</span>0 var_40= qword ptr <span class="number">-40</span>h</span><br><span class="line">.text:<span class="number">00000001400016B</span>0 var_38= Person ptr <span class="number">-38</span>h</span><br><span class="line">.text:<span class="number">00000001400016B</span>0 obj= Person ptr <span class="number">-30</span>h</span><br><span class="line">.text:<span class="number">00000001400016B</span>0 var_20= qword ptr <span class="number">-20</span>h</span><br><span class="line">.text:<span class="number">00000001400016B</span>0 arg_0= dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">00000001400016B</span>0 arg_8= qword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">00000001400016B</span>0</span><br><span class="line">.text:<span class="number">00000001400016B</span>0 ; FUNCTION CHUNK AT .text:<span class="number">0000000140005260</span> SIZE <span class="number">00000018</span> BYTES</span><br><span class="line">.text:<span class="number">00000001400016B</span>0</span><br><span class="line">.text:<span class="number">00000001400016B</span>0 ; __unwind &#123; <span class="comment">// __CxxFrameHandler4_0</span></span><br><span class="line">.text:<span class="number">00000001400016B</span>0 mov     [rsp+arg_8], rdx</span><br><span class="line">.text:<span class="number">00000001400016B</span>5 mov     [rsp+arg_0], ecx</span><br><span class="line">.text:<span class="number">00000001400016B</span>9 sub     rsp, <span class="number">68</span>h</span><br><span class="line">.text:<span class="number">00000001400016B</span>D lea     rcx, [rsp+<span class="number">68</span>h+obj]              ; this</span><br><span class="line">.text:<span class="number">00000001400016</span>C2 call    j_??<span class="number">0</span>Person@@QEAA@XZ            ; Person::Person(<span class="type">void</span>)</span><br><span class="line">.text:<span class="number">00000001400016</span>C2</span><br><span class="line">.text:<span class="number">00000001400016</span>C7 nop</span><br><span class="line">.text:<span class="number">00000001400016</span>C8 lea     rax, [rsp+<span class="number">68</span>h+var_20]</span><br><span class="line">.text:<span class="number">00000001400016</span>CD mov     [rsp+<span class="number">68</span>h+var_40], rax</span><br><span class="line">.text:<span class="number">00000001400016</span>D2 lea     rdx, [rsp+<span class="number">68</span>h+obj]              ; obj</span><br><span class="line">.text:<span class="number">00000001400016</span>D7 mov     rcx, [rsp+<span class="number">68</span>h+var_40]           ; this</span><br><span class="line">.text:<span class="number">00000001400016</span>DC call    j_??<span class="number">0</span>Person@@QEAA@AEBV0@@Z      ; Person::Person(Person <span class="type">const</span> &amp;)深拷贝，返回新对象</span><br><span class="line">.text:<span class="number">00000001400016</span>DC</span><br><span class="line">.text:<span class="number">00000001400016E1</span> mov     [rsp+<span class="number">68</span>h+var_38.name], rax</span><br><span class="line">.text:<span class="number">00000001400016E6</span> mov     rcx, [rsp+<span class="number">68</span>h+var_38.name]      ; obj</span><br><span class="line">.text:<span class="number">00000001400016</span>EB call    j_?show@@YAXVPerson@@@Z         ; show(Person)</span><br><span class="line">.text:<span class="number">00000001400016</span>EB</span><br><span class="line">.text:<span class="number">00000001400016F</span>0 mov     [rsp+<span class="number">68</span>h+var_48], <span class="number">0</span></span><br><span class="line">.text:<span class="number">00000001400016F</span>8 lea     rcx, [rsp+<span class="number">68</span>h+obj]              ; this</span><br><span class="line">.text:<span class="number">00000001400016F</span>D call    j_??<span class="number">1</span>Person@@QEAA@XZ            ; Person::~Person(<span class="type">void</span>)</span><br><span class="line">.text:<span class="number">00000001400016F</span>D</span><br><span class="line">.text:<span class="number">0000000140001702</span> mov     eax, [rsp+<span class="number">68</span>h+var_48]</span><br><span class="line">.text:<span class="number">0000000140001706</span> add     rsp, <span class="number">68</span>h</span><br><span class="line">.text:<span class="number">000000014000170</span>A retn</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000140003140</span> ; <span class="type">void</span> __fastcall <span class="title function_">Person::Person</span><span class="params">(Person *this, <span class="type">const</span> Person *obj)</span></span><br><span class="line">.text:0000000140003140 ??0Person@@QEAA@AEBV0@@Z proc near      ; CODE XREF: Person::Person(Person <span class="type">const</span> &amp;)↑j</span><br><span class="line">.text:<span class="number">0000000140003140</span>                                         ; DATA XREF: .pdata:<span class="number">000000014000B</span>2AC↓o</span><br><span class="line">.text:<span class="number">0000000140003140</span></span><br><span class="line">.text:<span class="number">0000000140003140</span> var_48= byte ptr <span class="number">-48</span>h</span><br><span class="line">.text:<span class="number">0000000140003140</span> var_44= dword ptr <span class="number">-44</span>h</span><br><span class="line">.text:<span class="number">0000000140003140</span> var_40= qword ptr <span class="number">-40</span>h</span><br><span class="line">.text:<span class="number">0000000140003140</span> var_38= qword ptr <span class="number">-38</span>h</span><br><span class="line">.text:<span class="number">0000000140003140</span> var_30= qword ptr <span class="number">-30</span>h</span><br><span class="line">.text:<span class="number">0000000140003140</span> var_28= qword ptr <span class="number">-28</span>h</span><br><span class="line">.text:<span class="number">0000000140003140</span> var_20= qword ptr <span class="number">-20</span>h</span><br><span class="line">.text:<span class="number">0000000140003140</span> var_18= qword ptr <span class="number">-18</span>h</span><br><span class="line">.text:<span class="number">0000000140003140</span> arg_0= qword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">0000000140003140</span> arg_8= qword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0000000140003140</span></span><br><span class="line">.text:<span class="number">0000000140003140</span> mov     [rsp+arg_8], rdx</span><br><span class="line">.text:<span class="number">0000000140003145</span> mov     [rsp+arg_0], rcx                ; this</span><br><span class="line">.text:<span class="number">000000014000314</span>A sub     rsp, <span class="number">68</span>h</span><br><span class="line">.text:<span class="number">000000014000314</span>E mov     rax, [rsp+<span class="number">68</span>h+arg_0]            ; this</span><br><span class="line">.text:<span class="number">0000000140003153</span> mov     rcx, [rsp+<span class="number">68</span>h+arg_8]            ; obj</span><br><span class="line">.text:<span class="number">0000000140003158</span> mov     ecx, [rcx+<span class="number">8</span>]                    ; obj.age</span><br><span class="line">.text:<span class="number">000000014000315B</span> mov     [rax+<span class="number">8</span>], ecx                    ; this-&gt;age = obj.age;</span><br><span class="line">.text:<span class="number">000000014000315</span>E mov     rax, [rsp+<span class="number">68</span>h+arg_8]            ; obj</span><br><span class="line">.text:<span class="number">0000000140003163</span> mov     rax, [rax]                      ; rax=obj.name</span><br><span class="line">.text:<span class="number">0000000140003166</span> mov     [rsp+<span class="number">68</span>h+var_28], rax</span><br><span class="line">.text:<span class="number">000000014000316B</span> mov     [rsp+<span class="number">68</span>h+var_40], <span class="number">0F</span>FFFFFFFFFFFFFFFh</span><br><span class="line">.text:<span class="number">000000014000316B</span></span><br><span class="line">.text:<span class="number">0000000140003174</span></span><br><span class="line">.text:<span class="number">0000000140003174</span> loc_140003174:                          ; CODE XREF: Person::Person(Person <span class="type">const</span> &amp;)+<span class="number">47</span>↓j</span><br><span class="line">.text:<span class="number">0000000140003174</span> inc     [rsp+<span class="number">68</span>h+var_40]                ; rsp+<span class="number">68</span>h+var_40是局部变量len</span><br><span class="line">.text:<span class="number">0000000140003179</span> mov     rax, [rsp+<span class="number">68</span>h+var_28]</span><br><span class="line">.text:<span class="number">000000014000317</span>E mov     rcx, [rsp+<span class="number">68</span>h+var_40]</span><br><span class="line">.text:<span class="number">0000000140003183</span> cmp     byte ptr [rax+rcx], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000140003187</span> jnz     <span class="type">short</span> loc_140003174             ; rsp+<span class="number">68</span>h+var_40是局部变量len</span><br><span class="line">.text:<span class="number">0000000140003187</span></span><br><span class="line">.text:<span class="number">0000000140003189</span> mov     rax, [rsp+<span class="number">68</span>h+var_40]</span><br><span class="line">.text:<span class="number">000000014000318</span>E mov     [rsp+<span class="number">68</span>h+var_44], eax           ; <span class="type">int</span> len = <span class="built_in">strlen</span>(obj.name);</span><br><span class="line">.text:<span class="number">0000000140003192</span> movsxd  rax, [rsp+<span class="number">68</span>h+var_44]</span><br><span class="line">.text:<span class="number">0000000140003197</span> inc     rax</span><br><span class="line">.text:<span class="number">000000014000319</span>A mov     rcx, rax                        ; size</span><br><span class="line">.text:<span class="number">000000014000319</span>D call    j_??_U@YAPEAX_K@Z               ; operator new[](<span class="type">unsigned</span> __int64)</span><br><span class="line">.text:<span class="number">000000014000319</span>D</span><br><span class="line">.text:<span class="number">00000001400031</span>A2 mov     [rsp+<span class="number">68</span>h+var_20], rax</span><br><span class="line">.text:<span class="number">00000001400031</span>A7 mov     rax, [rsp+<span class="number">68</span>h+arg_0]</span><br><span class="line">.text:<span class="number">00000001400031</span>AC mov     rcx, [rsp+<span class="number">68</span>h+var_20]</span><br><span class="line">.text:<span class="number">00000001400031B</span>1 mov     [rax], rcx                      ;  this-&gt;name = new <span class="type">char</span>[len + <span class="keyword">sizeof</span>(<span class="type">char</span>)];</span><br><span class="line">.text:<span class="number">00000001400031B</span>4 mov     rax, [rsp+<span class="number">68</span>h+arg_8]</span><br><span class="line">.text:<span class="number">00000001400031B</span>9 mov     rax, [rax]</span><br><span class="line">.text:<span class="number">00000001400031B</span>C mov     [rsp+<span class="number">68</span>h+var_30], rax</span><br><span class="line">.text:<span class="number">00000001400031</span>C1 mov     rax, [rsp+<span class="number">68</span>h+arg_0]</span><br><span class="line">.text:<span class="number">00000001400031</span>C6 mov     rax, [rax]</span><br><span class="line">.text:<span class="number">00000001400031</span>C9 mov     [rsp+<span class="number">68</span>h+var_38], rax</span><br><span class="line">.text:<span class="number">00000001400031</span>CE mov     rax, [rsp+<span class="number">68</span>h+var_38]</span><br><span class="line">.text:<span class="number">00000001400031</span>D3 mov     [rsp+<span class="number">68</span>h+var_18], rax</span><br><span class="line">.text:<span class="number">00000001400031</span>D3</span><br><span class="line">.text:<span class="number">00000001400031</span>D8</span><br><span class="line">.text:<span class="number">00000001400031</span>D8 loc_1400031D8:                          ; CODE XREF: Person::Person(Person <span class="type">const</span> &amp;)+CF↓j</span><br><span class="line">.text:<span class="number">00000001400031</span>D8 mov     rax, [rsp+<span class="number">68</span>h+var_30]</span><br><span class="line">.text:<span class="number">00000001400031</span>DD movzx   eax, byte ptr [rax]</span><br><span class="line">.text:<span class="number">00000001400031E0</span> mov     [rsp+<span class="number">68</span>h+var_48], al</span><br><span class="line">.text:<span class="number">00000001400031E4</span> mov     rax, [rsp+<span class="number">68</span>h+var_38]</span><br><span class="line">.text:<span class="number">00000001400031E9</span> movzx   ecx, [rsp+<span class="number">68</span>h+var_48]</span><br><span class="line">.text:<span class="number">00000001400031</span>EE mov     [rax], cl</span><br><span class="line">.text:<span class="number">00000001400031F</span>0 mov     rax, [rsp+<span class="number">68</span>h+var_30]</span><br><span class="line">.text:<span class="number">00000001400031F</span>5 inc     rax</span><br><span class="line">.text:<span class="number">00000001400031F</span>8 mov     [rsp+<span class="number">68</span>h+var_30], rax</span><br><span class="line">.text:<span class="number">00000001400031F</span>D mov     rax, [rsp+<span class="number">68</span>h+var_38]</span><br><span class="line">.text:<span class="number">0000000140003202</span> inc     rax</span><br><span class="line">.text:<span class="number">0000000140003205</span> mov     [rsp+<span class="number">68</span>h+var_38], rax</span><br><span class="line">.text:<span class="number">000000014000320</span>A cmp     [rsp+<span class="number">68</span>h+var_48], <span class="number">0</span></span><br><span class="line">.text:<span class="number">000000014000320F</span> jnz     <span class="type">short</span> loc_1400031D8             ;  <span class="built_in">strcpy</span>(this-&gt;name, obj.name);</span><br><span class="line">.text:<span class="number">000000014000320F</span></span><br><span class="line">.text:<span class="number">0000000140003211</span> mov     rax, [rsp+<span class="number">68</span>h+arg_0]            ; 返回新对象</span><br><span class="line">.text:<span class="number">0000000140003216</span> add     rsp, <span class="number">68</span>h</span><br><span class="line">.text:<span class="number">000000014000321</span>A retn</span><br></pre></td></tr></table></figure>

<h2 id="对象作为返回值"><a href="#对象作为返回值" class="headerlink" title="对象作为返回值"></a>对象作为返回值</h2><p>不能用寄存器返回的采用在调用者函数里开辟局部空间，通过拷贝构造函数赋值，同样会存在作为函数参数时的一样的问题</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">  <span class="type">int</span> count;</span><br><span class="line">  <span class="type">int</span> buffer[<span class="number">10</span>]; <span class="comment">//定义两个数据成员，该类的大小为 44 字节</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Person <span class="title function_">getPerson</span><span class="params">()</span> &#123;</span><br><span class="line">  Person person;</span><br><span class="line">  person.count = <span class="number">10</span>;</span><br><span class="line">  person.buffer[<span class="number">0</span>] = <span class="string">&#x27;g&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> person;  <span class="comment">//返回局部对象</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  Person person;</span><br><span class="line">  person = getPerson();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d %d %d&quot;</span>, person.count, person.buffer[<span class="number">0</span>], person.buffer[<span class="number">9</span>]);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>汇编太长了，不贴了，伪代码基本可以把汇编实现反应出来</p>
<p>main里开辟局部变量，作为getPerson参数，返回后再复制给v4再给v3</p>
<p>没搞懂为什么不直接用result，还要再给v4赋值一下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall main(int argc, char **argv)</span><br><span class="line">&#123;</span><br><span class="line">  int v3[11]; // [rsp+20h] [rbp-A8h] BYREF</span><br><span class="line">  char v4[44]; // [rsp+50h] [rbp-78h] BYREF</span><br><span class="line">  Person result; // [rsp+80h] [rbp-48h] BYREF</span><br><span class="line"></span><br><span class="line">  qmemcpy(v4, getPerson(&amp;result), sizeof(v4));</span><br><span class="line">  qmemcpy(v3, v4, sizeof(v3));</span><br><span class="line">  j_printf(&quot;%d %d %d&quot;, (unsigned int)v3[0], (unsigned int)v3[1], (unsigned int)v3[10]);</span><br><span class="line">  return 0i64;</span><br><span class="line">&#125;</span><br><span class="line">Person *__fastcall getPerson(Person *result)</span><br><span class="line">&#123;</span><br><span class="line">  LODWORD(result-&gt;name) = 10;</span><br><span class="line">  HIDWORD(result-&gt;name) = &#x27;g&#x27;;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="构造函数调用时机"><a href="#构造函数调用时机" class="headerlink" title="构造函数调用时机"></a>构造函数调用时机</h2><h3 id="局部对象"><a href="#局部对象" class="headerlink" title="局部对象"></a>局部对象</h3><p>隐式传入this指针，返回this指针</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Person person; </span><br></pre></td></tr></table></figure>

<h3 id="堆对象"><a href="#堆对象" class="headerlink" title="堆对象"></a>堆对象</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">  Person() &#123;</span><br><span class="line">    age = <span class="number">20</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">int</span> age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  Person* p = new Person;</span><br><span class="line">  p-&gt;age = <span class="number">21</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, p-&gt;age);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>new完后会判断是否申请失败，决定是否调用构造函数，malloc不负责触发构造函数，它也不是运算符，无法进行运算符重载。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000140003010                               main proc near                          ; CODE XREF: main_0↑j</span><br><span class="line">.text:0000000140003010                                                                       ; DATA XREF: .pdata:000000014000B270↓o</span><br><span class="line">.text:0000000140003010</span><br><span class="line">.text:0000000140003010                               var_28= qword ptr -28h</span><br><span class="line">.text:0000000140003010                               var_20= qword ptr -20h</span><br><span class="line">.text:0000000140003010                               var_18= qword ptr -18h</span><br><span class="line">.text:0000000140003010                               var_10= qword ptr -10h</span><br><span class="line">.text:0000000140003010                               arg_0= dword ptr  8</span><br><span class="line">.text:0000000140003010                               arg_8= qword ptr  10h</span><br><span class="line">.text:0000000140003010</span><br><span class="line">.text:0000000140003010                               ; FUNCTION CHUNK AT .text:0000000140005240 SIZE 0000001D BYTES</span><br><span class="line">.text:0000000140003010</span><br><span class="line">.text:0000000140003010                               ; __unwind &#123; // __CxxFrameHandler4_0</span><br><span class="line">.text:0000000140003010 48 89 54 24 10                mov     [rsp+arg_8], rdx</span><br><span class="line">.text:0000000140003015 89 4C 24 08                   mov     [rsp+arg_0], ecx</span><br><span class="line">.text:0000000140003019 48 83 EC 48                   sub     rsp, 48h</span><br><span class="line">.text:000000014000301D B9 04 00 00 00                mov     ecx, 4                          ; size</span><br><span class="line">.text:0000000140003022 E8 F2 DF FF FF                call    j_??2@YAPEAX_K@Z                ; operator new(unsigned __int64)</span><br><span class="line">.text:0000000140003022</span><br><span class="line">.text:0000000140003027 48 89 44 24 20                mov     [rsp+48h+var_28], rax</span><br><span class="line">.text:000000014000302C 48 83 7C 24 20 00             cmp     [rsp+48h+var_28], 0</span><br><span class="line">.text:0000000140003032 74 11                         jz      short loc_140003045             ;跳过构造函数</span><br><span class="line">.text:0000000140003032</span><br><span class="line">.text:0000000140003034 48 8B 4C 24 20                mov     rcx, [rsp+48h+var_28]           ; this</span><br><span class="line">.text:0000000140003039 E8 3D E2 FF FF                call    j_??0Person@@QEAA@XZ            ; Person::Person(void)</span><br><span class="line">.text:0000000140003039</span><br><span class="line">.text:000000014000303E 48 89 44 24 28                mov     [rsp+48h+var_20], rax</span><br><span class="line">.text:0000000140003043 EB 09                         jmp     short loc_14000304E</span><br><span class="line">.text:0000000140003043</span><br><span class="line">.text:0000000140003045                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000140003045</span><br><span class="line">.text:0000000140003045                               loc_140003045:                          ; CODE XREF: main+22↑j</span><br><span class="line">.text:0000000140003045 48 C7 44 24 28 00 00 00 00    mov     [rsp+48h+var_20], 0</span><br><span class="line">.text:0000000140003045</span><br><span class="line">.text:000000014000304E</span><br><span class="line">.text:000000014000304E                               loc_14000304E:                          ; CODE XREF: main+33↑j</span><br><span class="line">.text:000000014000304E 48 8B 44 24 28                mov     rax, [rsp+48h+var_20]</span><br></pre></td></tr></table></figure>

<h3 id="参数对象-amp-amp-返回对象"><a href="#参数对象-amp-amp-返回对象" class="headerlink" title="参数对象&amp;&amp;返回对象"></a>参数对象&amp;&amp;返回对象</h3><h3 id="全局对象-amp-amp-静态对象"><a href="#全局对象-amp-amp-静态对象" class="headerlink" title="全局对象&amp;&amp;静态对象"></a>全局对象&amp;&amp;静态对象</h3><h2 id="析构函数调用时机"><a href="#析构函数调用时机" class="headerlink" title="析构函数调用时机"></a>析构函数调用时机</h2><h3 id="局部对象-1"><a href="#局部对象-1" class="headerlink" title="局部对象"></a>局部对象</h3><p>传递this指针</p>
<h3 id="堆对象-1"><a href="#堆对象-1" class="headerlink" title="堆对象"></a>堆对象</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">  Person() &#123;</span><br><span class="line">    age = <span class="number">20</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ~Person() &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;~Person()\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">int</span> age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  Person* person = new Person();</span><br><span class="line">  person-&gt;age = <span class="number">21</span>;              <span class="comment">//为了便于讲解，这里没检查指针</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, person-&gt;age);</span><br><span class="line">  delete person;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用delete时如果判断为0直接跳过析构函数，调用代理析构函数时，传入了两参数 tish指针和1</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:00000001400016E5 mov     [rsp+58h+var_20], rax           ; 对象地址</span><br><span class="line">.text:00000001400016EA cmp     [rsp+58h+var_20], 0</span><br><span class="line">.text:00000001400016F0 jz      short loc_140001708</span><br><span class="line">.text:00000001400016F0</span><br><span class="line">.text:00000001400016F2 mov     edx, 1                          ; unsigned int </span><br><span class="line">.text:00000001400016F7 mov     rcx, [rsp+58h+var_20]           ; this</span><br><span class="line">.text:00000001400016FC call    j_??_GPerson@@QEAAPEAXI@Z       ; Person::`scalar deleting destructor&#x27;(uint)</span><br></pre></td></tr></table></figure>

<p>第二个参数1表示应该如何析构，例如下面的情况</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  Person *objs = new Person[<span class="number">3</span>];  <span class="comment">//申请对象数组</span></span><br><span class="line">  delete[] objs;                 <span class="comment">//释放对象数组</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>new申请时申请了20大小，比Person[3]多了堆空间的首地址处的8字节来内容保存对象数量</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:000000014000169D mov     ecx, 14h                        ; size</span><br><span class="line">.text:00000001400016A2 call    j_??_U@YAPEAX_K@Z               ; operator new[](unsigned __int64)</span><br><span class="line">.text:00000001400016A2</span><br><span class="line">.text:00000001400016A7 mov     [rsp+68h+var_38], rax</span><br><span class="line">.text:00000001400016AC cmp     [rsp+68h+var_38], 0</span><br><span class="line">.text:00000001400016B2 jz      short loc_1400016FF</span><br><span class="line">.text:00000001400016B2</span><br><span class="line">.text:00000001400016B4 mov     rax, [rsp+68h+var_38]</span><br><span class="line">.text:00000001400016B9 mov     qword ptr [rax], 3             ;首地址处的8字节保存对象数量</span><br></pre></td></tr></table></figure>

<p>调用代理构造函数(第一个对象地址,对象大小，对象个数，构造函数地址),代理构造函数去一个一个构造对象</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:00000001400016C0 mov     rax, [rsp+68h+var_38]</span><br><span class="line">.text:00000001400016C5 add     rax, 8</span><br><span class="line">.........</span><br><span class="line">.text:00000001400016D5 lea     r9, j_??0Person@@QEAA@XZ        ; constructor</span><br><span class="line">.text:00000001400016DC mov     r8d, 3                          ; count</span><br><span class="line">.text:00000001400016E2 mov     edx, 4                          ; size</span><br><span class="line">.text:00000001400016E7 mov     rcx, rax                        ; ptr</span><br><span class="line">.text:00000001400016EA call    j_??_L@YAXPEAX_K1P6AX0@Z2@Z     ; `eh vector constructor iterator&#x27;(void *,unsigned __int64,unsigned __int64,void (*)(void *),void (*)(vo</span><br></pre></td></tr></table></figure>

<p>调用代理析构函数(第一个对象地址，释放对象类型标志:1为释放单个对象，3为释放对象数组，0表示单个对象仅仅执行析构函数，不释放堆空间，2调用对象数组析构函数，不释放堆空间)</p>
<p>delete[]参数二为3，delete为1</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:000000014000172E mov     edx, 3                          ; unsigned int</span><br><span class="line">.text:0000000140001733 mov     rcx, [rsp+68h+var_28]           ; this</span><br><span class="line">.text:0000000140001738 call    j_??_EPerson@@QEAAPEAXI@Z       ; Person::`vector deleting destructor&#x27;(uint)</span><br></pre></td></tr></table></figure>

<h3 id="参数对象-amp-amp-返回对象-1"><a href="#参数对象-amp-amp-返回对象-1" class="headerlink" title="参数对象&amp;&amp;返回对象"></a>参数对象&amp;&amp;返回对象</h3><h3 id="全局对-amp-amp-静态对象"><a href="#全局对-amp-amp-静态对象" class="headerlink" title="全局对&amp;&amp;静态对象"></a>全局对&amp;&amp;静态对象</h3><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><strong>C++反汇编与逆向分析技术揭秘</strong></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">1.</span> <span class="toc-text">实验环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B1%BB%E7%89%B9%E6%80%A7"><span class="toc-number">2.</span> <span class="toc-text">类特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#this%E6%8C%87%E9%92%88"><span class="toc-number">3.</span> <span class="toc-text">this指针</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E4%BD%9C%E4%B8%BA%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0"><span class="toc-number">4.</span> <span class="toc-text">对象作为函数参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E4%BD%9C%E4%B8%BA%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="toc-number">5.</span> <span class="toc-text">对象作为返回值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%97%B6%E6%9C%BA"><span class="toc-number">6.</span> <span class="toc-text">构造函数调用时机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.1.</span> <span class="toc-text">局部对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A0%86%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.2.</span> <span class="toc-text">堆对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E5%AF%B9%E8%B1%A1-amp-amp-%E8%BF%94%E5%9B%9E%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.3.</span> <span class="toc-text">参数对象&amp;&amp;返回对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%AF%B9%E8%B1%A1-amp-amp-%E9%9D%99%E6%80%81%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.4.</span> <span class="toc-text">全局对象&amp;&amp;静态对象</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%90%E6%9E%84%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%97%B6%E6%9C%BA"><span class="toc-number">7.</span> <span class="toc-text">析构函数调用时机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E5%AF%B9%E8%B1%A1-1"><span class="toc-number">7.1.</span> <span class="toc-text">局部对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A0%86%E5%AF%B9%E8%B1%A1-1"><span class="toc-number">7.2.</span> <span class="toc-text">堆对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E5%AF%B9%E8%B1%A1-amp-amp-%E8%BF%94%E5%9B%9E%E5%AF%B9%E8%B1%A1-1"><span class="toc-number">7.3.</span> <span class="toc-text">参数对象&amp;&amp;返回对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%AF%B9-amp-amp-%E9%9D%99%E6%80%81%E5%AF%B9%E8%B1%A1"><span class="toc-number">7.4.</span> <span class="toc-text">全局对&amp;&amp;静态对象</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">8.</span> <span class="toc-text">Reference</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/&text=C++反汇编 0x00"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/&title=C++反汇编 0x00"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/&is_video=false&description=C++反汇编 0x00"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=C++反汇编 0x00&body=Check out this article: https://grxer.gitee.io/2023/10/24/Cpp-disassemble/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/&title=C++反汇编 0x00"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/&title=C++反汇编 0x00"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/&title=C++反汇编 0x00"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/&title=C++反汇编 0x00"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/&name=C++反汇编 0x00&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/10/24/Cpp-disassemble/&t=C++反汇编 0x00"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2024
    bxz
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?a22ef0bec4e4a9c7337bea6e37ff55c1";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
