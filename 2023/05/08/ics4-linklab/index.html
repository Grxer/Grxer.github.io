<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="baidu-site-verification" content="codeva-ROfYcqLkCh" />
    <meta name="msvalidate.01" content="ECA3E06A0E52A2AC90C4B06F12981FB2" />
    <meta name="description" content="NJU ICS4 Linklabmooc上的好像是阉割版，作为一个被pwn噶过腰子的男人(bu shi)，怎么能放过这种hack性质的lab，就去找了貌似是完整的lab:) 链接：https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;1_tPhDGhKaF4HZ94oayqnMw提取码：fbex 实验文件都是x86-32的 阶段 1：静态数据对象与 ELF 数据节阶段 2：指令与 ELF 代码节阶段 3">
<meta property="og:type" content="article">
<meta property="og:title" content="NJU ICS4 Linklab">
<meta property="og:url" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/index.html">
<meta property="og:site_name" content="Grxer&#39;s Blog">
<meta property="og:description" content="NJU ICS4 Linklabmooc上的好像是阉割版，作为一个被pwn噶过腰子的男人(bu shi)，怎么能放过这种hack性质的lab，就去找了貌似是完整的lab:) 链接：https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;1_tPhDGhKaF4HZ94oayqnMw提取码：fbex 实验文件都是x86-32的 阶段 1：静态数据对象与 ELF 数据节阶段 2：指令与 ELF 代码节阶段 3">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230506171613189.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230506223216046.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230506221626593.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230506213529559.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230506223052595.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507173942701.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507174043686.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507174600892.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507200104767.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507200258182.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507202240463.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507202423749.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507202626683.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507202705410.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507205421832.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507205323580.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507205344052.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507205815532.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507210127236.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507210234694.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507210250054.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507212648240.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507213134515.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507214005609.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507220450148.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507220550289.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507222739182.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507222657681.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507223022320.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507223526485.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507223541678.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507232413843.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507232536405.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230507233555928.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230508011418971.png">
<meta property="article:published_time" content="2023-05-08T00:32:46.000Z">
<meta property="article:modified_time" content="2023-09-04T09:58:35.060Z">
<meta property="article:author" content="bxz">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://grxer.gitee.io/2023/05/08/ics4-linklab/image-20230506171613189.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>NJU ICS4 Linklab</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/05/13/x86-nemu-pa1/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/05/05/%E8%B0%83%E7%94%A8%E6%AC%BA%E9%AA%97%E6%8B%BE%E9%81%97/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/05/08/ics4-linklab/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/05/08/ics4-linklab/&text=NJU ICS4 Linklab"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/05/08/ics4-linklab/&title=NJU ICS4 Linklab"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/05/08/ics4-linklab/&is_video=false&description=NJU ICS4 Linklab"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=NJU ICS4 Linklab&body=Check out this article: https://grxer.gitee.io/2023/05/08/ics4-linklab/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/05/08/ics4-linklab/&title=NJU ICS4 Linklab"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/05/08/ics4-linklab/&title=NJU ICS4 Linklab"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/05/08/ics4-linklab/&title=NJU ICS4 Linklab"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/05/08/ics4-linklab/&title=NJU ICS4 Linklab"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/05/08/ics4-linklab/&name=NJU ICS4 Linklab&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/05/08/ics4-linklab/&t=NJU ICS4 Linklab"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NJU-ICS4-Linklab"><span class="toc-number">1.</span> <span class="toc-text">NJU ICS4 Linklab</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#phase1"><span class="toc-number">1.1.</span> <span class="toc-text">phase1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phase2"><span class="toc-number">1.2.</span> <span class="toc-text">phase2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phase3"><span class="toc-number">1.3.</span> <span class="toc-text">phase3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phase4"><span class="toc-number">1.4.</span> <span class="toc-text">phase4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phase5"><span class="toc-number">1.5.</span> <span class="toc-text">phase5</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#generate-code"><span class="toc-number">1.5.0.1.</span> <span class="toc-text">generate_code</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#transform-code"><span class="toc-number">1.5.0.2.</span> <span class="toc-text">transform_code</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#do-phase"><span class="toc-number">1.5.0.3.</span> <span class="toc-text">do_phase</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#encode-1"><span class="toc-number">1.5.0.4.</span> <span class="toc-text">encode_1</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phase6"><span class="toc-number">1.6.</span> <span class="toc-text">phase6</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#generate-code-1"><span class="toc-number">1.6.0.1.</span> <span class="toc-text">generate_code</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#transform-code-1"><span class="toc-number">1.6.0.2.</span> <span class="toc-text">transform_code</span></a></li></ol></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        NJU ICS4 Linklab
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">bxz</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-05-08T00:32:46.000Z" itemprop="datePublished">2023-05-08</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="NJU-ICS4-Linklab"><a href="#NJU-ICS4-Linklab" class="headerlink" title="NJU ICS4 Linklab"></a>NJU ICS4 Linklab</h1><p>mooc上的好像是阉割版，作为一个被pwn噶过腰子的男人(bu shi)，怎么能放过这种hack性质的lab，就去找了貌似是完整的lab:)</p>
<p>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1_tPhDGhKaF4HZ94oayqnMw">https://pan.baidu.com/s/1_tPhDGhKaF4HZ94oayqnMw</a><br>提取码：fbex</p>
<p>实验文件都是x86-32的</p>
<p>阶段 1：静态数据对象与 ELF 数据节<br>阶段 2：指令与 ELF 代码节<br>阶段 3：符号解析<br>阶段 4：switch 语句与重定位<br>阶段 5：可重定位目标文件<br>阶段 6：位置无关代码（Position-Independent Code，PIC）</p>
<h2 id="phase1"><a href="#phase1" class="headerlink" title="phase1"></a>phase1</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main) [<span class="number">1</span>]&gt; gcc -m32 -no-pie -o linkbomb main.o phase1.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">ddURHzFnm2mcxbehqVcVufpd68LdEePs        lYPCnZfPLLbMLzV3iM1A97QVLg7j8zcmDlD0clCtKV0kgLRshaBQ3kCaGG YMbr9ELE31xt2fau4zX7bEMCVf   qXOdnQ igVJcDsac1d9N7kSla5VLXAKDtjxAoNjW2tonwDzyASqLn5JKSf32EqapXP83B03NmDqUx</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"> grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; objdump -d phase1.o</span><br><span class="line"></span><br><span class="line">phase1.o:     file format elf32-i386</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;do_phase&gt;:</span><br><span class="line">   <span class="number">0</span>:   <span class="number">55</span>                      push   %ebp</span><br><span class="line">   <span class="number">1</span>:   <span class="number">89</span> e5                   mov    %esp,%ebp</span><br><span class="line">   <span class="number">3</span>:   <span class="number">83</span> ec <span class="number">08</span>                sub    $<span class="number">0x8</span>,%esp</span><br><span class="line">   <span class="number">6</span>:   b8 <span class="number">9</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x9a</span>,%eax</span><br><span class="line">   b:   <span class="number">83</span> ec <span class="number">0</span>c                sub    $<span class="number">0xc</span>,%esp</span><br><span class="line">   e:   <span class="number">50</span>                      push   %eax</span><br><span class="line">   f:   e8 fc ff ff ff          call   <span class="number">10</span> &lt;do_phase+<span class="number">0x10</span>&gt;</span><br><span class="line">  <span class="number">14</span>:   <span class="number">83</span> c4 <span class="number">10</span>                add    $<span class="number">0x10</span>,%esp</span><br><span class="line">  <span class="number">17</span>:   <span class="number">90</span>                      nop</span><br><span class="line">  <span class="number">18</span>:   c9                      leave</span><br><span class="line">  <span class="number">19</span>:   c3                      ret</span><br><span class="line">      </span><br><span class="line"> grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -r phase1.o</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x354</span> contains <span class="number">2</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000007</span>  <span class="number">00000301</span> R_386_32          <span class="number">00000000</span>   .data</span><br><span class="line"><span class="number">00000010</span>  <span class="number">00000e02</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">puts</span></span><br></pre></td></tr></table></figure>

<p>.rel.text给text做重定位，offset 10处为puts，所以0x9a处的数据压栈做puts参数，这里猜测就是.data的偏移了</p>
<p><img src="/2023/05/08/ics4-linklab/image-20230506171613189.png" alt="image-20230506171613189"></p>
<p>直接改掉</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase1.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">grxer</span><br></pre></td></tr></table></figure>

<h2 id="phase2"><a href="#phase2" class="headerlink" title="phase2"></a>phase2</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000061</span> &lt;kfSvKnbh&gt;:</span><br><span class="line">  <span class="number">61</span>:   <span class="number">55</span>                      push   %ebp</span><br><span class="line">  <span class="number">62</span>:   <span class="number">89</span> e5                   mov    %esp,%ebp</span><br><span class="line">  <span class="number">64</span>:   <span class="number">83</span> ec <span class="number">08</span>                sub    $<span class="number">0x8</span>,%esp</span><br><span class="line">  <span class="number">67</span>:   <span class="number">83</span> ec <span class="number">08</span>                sub    $<span class="number">0x8</span>,%esp</span><br><span class="line">  <span class="number">6</span>a:   <span class="number">68</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          push   $<span class="number">0x2</span></span><br><span class="line">  <span class="number">6f</span>:   ff <span class="number">75</span> <span class="number">08</span>                push   <span class="number">0x8</span>(%ebp)</span><br><span class="line">  <span class="number">72</span>:   e8 fc ff ff ff          call   <span class="number">73</span> &lt;kfSvKnbh+<span class="number">0x12</span>&gt;</span><br><span class="line">  <span class="number">77</span>:   <span class="number">83</span> c4 <span class="number">10</span>                add    $<span class="number">0x10</span>,%esp</span><br><span class="line">  <span class="number">7</span>a:   <span class="number">85</span> c0                   test   %eax,%eax</span><br><span class="line">  <span class="number">7</span>c:   <span class="number">75</span> <span class="number">10</span>                   jne    <span class="number">8</span>e &lt;kfSvKnbh+<span class="number">0x2d</span>&gt;</span><br><span class="line">  <span class="number">7</span>e:   <span class="number">83</span> ec <span class="number">0</span>c                sub    $<span class="number">0xc</span>,%esp</span><br><span class="line">  <span class="number">81</span>:   ff <span class="number">75</span> <span class="number">0</span>c                push   <span class="number">0xc</span>(%ebp)</span><br><span class="line">  <span class="number">84</span>:   e8 fc ff ff ff          call   <span class="number">85</span> &lt;kfSvKnbh+<span class="number">0x24</span>&gt;</span><br><span class="line">  <span class="number">89</span>:   <span class="number">83</span> c4 <span class="number">10</span>                add    $<span class="number">0x10</span>,%esp</span><br><span class="line">  <span class="number">8</span>c:   eb <span class="number">01</span>                   jmp    <span class="number">8f</span> &lt;kfSvKnbh+<span class="number">0x2e</span>&gt;</span><br><span class="line">  <span class="number">8</span>e:   <span class="number">90</span>                      nop</span><br><span class="line">  <span class="number">8f</span>:   c9                      leave</span><br><span class="line">  <span class="number">90</span>:   c3                      ret</span><br><span class="line">  <span class="number">00000091</span> &lt;do_phase&gt;:</span><br><span class="line">  <span class="number">91</span>:   <span class="number">55</span>                      push   %ebp</span><br><span class="line">  <span class="number">92</span>:   <span class="number">89</span> e5                   mov    %esp,%ebp</span><br><span class="line">  <span class="number">94</span>:   <span class="number">90</span>                      nop</span><br><span class="line">  <span class="number">95</span>:   <span class="number">90</span>                      nop</span><br><span class="line">  <span class="number">96</span>:   <span class="number">90</span>                      nop</span><br><span class="line">  <span class="number">97</span>:   <span class="number">90</span>                      nop</span><br><span class="line">  <span class="number">98</span>:   <span class="number">90</span>                      nop</span><br><span class="line">  ...一堆nop</span><br><span class="line">  d5:   <span class="number">5</span>d                      pop    %ebp</span><br><span class="line">  d6:   c3                      ret</span><br><span class="line"> grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -r phase1.ogrxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -r phase2.o</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x308</span> contains <span class="number">4</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000035</span>  <span class="number">00000</span>c02 R_386_PC32        <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">0000006b</span>  <span class="number">00000501</span> R_386_32          <span class="number">00000000</span>   .rodata</span><br><span class="line"><span class="number">00000073</span>  <span class="number">00000</span>d02 R_386_PC32        <span class="number">00000000</span>   <span class="built_in">strcmp</span></span><br><span class="line"><span class="number">00000085</span>  <span class="number">00000e02</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">puts</span></span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x354</span> contains <span class="number">2</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000007</span>  <span class="number">00000301</span> R_386_32          <span class="number">00000000</span>   .data</span><br><span class="line"><span class="number">00000010</span>  <span class="number">00000e02</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">puts</span></span><br></pre></td></tr></table></figure>

<p>do_phase里的都是nop，肯定要利用puts函数来输出，他的重定位信息只有在00000085有，所以我们可以在do_phase里布置好栈帧，然后e9 jmp相对跳转到这个puts就可以输出</p>
<p>先布置栈帧把</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sub esp,<span class="number">0x30</span></span><br><span class="line">mov dword ptr [ebp<span class="number">-0x10</span>],<span class="number">72</span>h</span><br><span class="line">mov dword ptr [ebp<span class="number">-0x14</span>],<span class="number">65787267</span>h</span><br><span class="line">lea eax, [ebp<span class="number">-0x18</span>]</span><br><span class="line">push eax</span><br></pre></td></tr></table></figure>

<p><img src="/2023/05/08/ics4-linklab/image-20230506223216046.png" alt="image-20230506223216046"></p>
<p>用ida patch了一下，接下来就是jmp到84</p>
<p>**intel手册 64-ia-32-architectures-software-developer-instruction-set-reference-manual-第2卷 **</p>
<p><img src="/2023/05/08/ics4-linklab/image-20230506221626593.png" alt="image-20230506221626593"></p>
<blockquote>
<p>为什么没有选择 相对地址的e8 call是因为如果是e8 call过去会把返回地址先push栈里，会把call puts的参数给破环掉</p>
<p><img src="/2023/05/08/ics4-linklab/image-20230506213529559.png" alt="image-20230506213529559"></p>
</blockquote>
<p>我们只能自己做重定位，call指令布置在a9处，占5个字节(一字节的操作码，四字节的偏移)，下一条指令在ae处，所以偏移为84-ae即FFFF FFD6</p>
<p>所以字节码为e9 d6 ff ff ff，用010改下</p>
<p><img src="/2023/05/08/ics4-linklab/image-20230506223052595.png" alt="image-20230506223052595"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000091</span> &lt;do_phase&gt;:</span><br><span class="line">  <span class="number">91</span>:   <span class="number">55</span>                      push   %ebp</span><br><span class="line">  <span class="number">92</span>:   <span class="number">89</span> e5                   mov    %esp,%ebp</span><br><span class="line">  <span class="number">94</span>:   <span class="number">83</span> ec <span class="number">30</span>                sub    $<span class="number">0x30</span>,%esp</span><br><span class="line">  <span class="number">97</span>:   c7 <span class="number">45</span> f0 <span class="number">72</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    movl   $<span class="number">0x72</span>,<span class="number">-0x10</span>(%ebp)</span><br><span class="line">  <span class="number">9</span>e:   c7 <span class="number">45</span> ec <span class="number">67</span> <span class="number">72</span> <span class="number">78</span> <span class="number">65</span>    movl   $<span class="number">0x65787267</span>,<span class="number">-0x14</span>(%ebp)</span><br><span class="line">  a5:   <span class="number">8</span>d <span class="number">45</span> ec                lea    <span class="number">-0x14</span>(%ebp),%eax</span><br><span class="line">  a8:   <span class="number">50</span>                      push   %eax</span><br><span class="line">  a9:   e9 d6 ff ff ff          jmp    <span class="number">84</span> &lt;kfSvKnbh+<span class="number">0x23</span>&gt;</span><br></pre></td></tr></table></figure>

<p>kfSvKnbh里的 leave ret会帮我们平栈后返回到main里调用do_phase的下一条指令处</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase2.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">grxer</span><br></pre></td></tr></table></figure>

<h2 id="phase3"><a href="#phase3" class="headerlink" title="phase3"></a>phase3</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">gcc -m32 -no-pie -o linkbomb main.o phase3.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br></pre></td></tr></table></figure>

<p>什么也没输出</p>
<p>看下汇编</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">080491c6 &lt;do_phase&gt;:</span><br><span class="line"> 80491c6:       55                      push   %ebp</span><br><span class="line"> 80491c7:       89 e5                   mov    %esp,%ebp</span><br><span class="line"> 80491c9:       83 ec 18                sub    $0x18,%esp</span><br><span class="line"> 80491cc:       c7 45 ea 79 7a 67 69    movl   $0x69677a79,-0x16(%ebp);从这里开始就是一种到 80491da都是在赋值给ebp-0x16处的局部变量cookie</span><br><span class="line"> 80491d3:       c7 45 ee 75 68 6e 62    movl   $0x626e6875,-0x12(%ebp)</span><br><span class="line"> 80491da:       66 c7 45 f2 65 00       movw   $0x65,-0xe(%ebp);赋值cookie结束</span><br><span class="line"> 80491e0:       c7 45 f4 00 00 00 00    movl   $0x0,-0xc(%ebp) ;ebp-c这个地方存的就是计数器</span><br><span class="line"> 80491e7:       eb 28                   jmp    8049211 &lt;do_phase+0x4b&gt;</span><br><span class="line"> </span><br><span class="line"> 80491e9:       8d 55 ea                lea    -0x16(%ebp),%edx</span><br><span class="line"> 80491ec:       8b 45 f4                mov    -0xc(%ebp),%eax</span><br><span class="line"> 80491ef:       01 d0                   add    %edx,%eax</span><br><span class="line"> 80491f1:       0f b6 00                movzbl (%eax),%eax;拿出cookie[计数器]里的值</span><br><span class="line"> 80491f4:       0f b6 c0                movzbl %al,%eax</span><br><span class="line"> 80491f7:       0f b6 80 60 c0 04 08    movzbl 0x804c060(%eax),%eax;0x804c060处是一个叫做NQqPQyqUth的变量符号，所以eax就是NQqPQyqUth+cookie[计数器]地址里的值</span><br><span class="line"> 80491fe:       0f be c0                movsbl %al,%eax</span><br><span class="line"> 8049201:       83 ec 0c                sub    $0xc,%esp</span><br><span class="line"> 8049204:       50                      push   %eax</span><br><span class="line"> 8049205:       e8 56 fe ff ff          call   8049060 &lt;putchar@plt&gt;</span><br><span class="line"> 804920a:       83 c4 10                add    $0x10,%esp</span><br><span class="line"> 804920d:       83 45 f4 01             addl   $0x1,-0xc(%ebp);计数器加1</span><br><span class="line"> </span><br><span class="line"> 8049211:       8b 45 f4                mov    -0xc(%ebp),%eax</span><br><span class="line"> 8049214:       83 f8 08                cmp    $0x8,%eax;计数器大于8之后就输出换行结束了</span><br><span class="line"> 8049217:       76 d0                   jbe    80491e9 &lt;do_phase+0x23&gt;</span><br><span class="line"> 8049219:       83 ec 0c                sub    $0xc,%esp</span><br><span class="line"> 804921c:       6a 0a                   push   $0xa ;最后输出一个换行</span><br><span class="line"> 804921e:       e8 3d fe ff ff          call   8049060 &lt;putchar@plt&gt;</span><br><span class="line"> 8049223:       83 c4 10                add    $0x10,%esp</span><br><span class="line"> 8049226:       90                      nop</span><br><span class="line"> 8049227:       c9                      leave</span><br><span class="line"> 8049228:       c3                      ret</span><br></pre></td></tr></table></figure>

<p>看一下符号表</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -s phase3.o</span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.symtab&#x27; contains 14 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 00000000     0 FILE    LOCAL  DEFAULT  ABS phase3.c</span><br><span class="line">     2: 00000000     0 SECTION LOCAL  DEFAULT    1 .text</span><br><span class="line">     3: 00000000     0 SECTION LOCAL  DEFAULT    3 .data</span><br><span class="line">     4: 00000000     0 SECTION LOCAL  DEFAULT    5 .bss</span><br><span class="line">     5: 00000000     0 SECTION LOCAL  DEFAULT    6 .rodata</span><br><span class="line">     6: 00000000     0 SECTION LOCAL  DEFAULT    8 .note.GNU-stack</span><br><span class="line">     7: 00000000     0 SECTION LOCAL  DEFAULT    9 .eh_frame</span><br><span class="line">     8: 00000000     0 SECTION LOCAL  DEFAULT    7 .comment</span><br><span class="line">     9: 00000000     4 OBJECT  GLOBAL DEFAULT    3 phase_id</span><br><span class="line">    10: 00000020   256 OBJECT  GLOBAL DEFAULT  COM NQqPQyqUth</span><br><span class="line">    11: 00000000    99 FUNC    GLOBAL DEFAULT    1 do_phase</span><br><span class="line">    12: 00000000     0 NOTYPE  GLOBAL DEFAULT  UND putchar</span><br><span class="line">    13: 00000004     4 OBJECT  GLOBAL DEFAULT    3 phase</span><br></pre></td></tr></table></figure>

<p>经过上面的分析，逆向为c代码大致就是</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> NQqPQyqUth[<span class="number">256</span>];</span><br><span class="line">do_phase&#123;</span><br><span class="line">    <span class="type">char</span> cookie[<span class="number">10</span>]=&#123; <span class="number">79</span> <span class="number">7</span>a <span class="number">67</span> <span class="number">69</span>  <span class="number">75</span> <span class="number">68</span> <span class="number">6</span>e <span class="number">62</span>  <span class="number">65</span> <span class="number">00</span>&#125;;<span class="comment">//懒得加逗号了</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">9</span> ; i++)</span><br><span class="line">        <span class="built_in">putchar</span>(NQqPQyqUth[cookie[i]]);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>NQqPQyqUth在COMMon块，数据都为0，所以没有输出，由于属于是弱符号，链接时会被强符号给挤掉， <a target="_blank" rel="noopener" href="https://grxer.github.io/2023/04/28/static-link/">https://grxer.github.io/2023/04/28/static-link/</a> 里有分析过</p>
<p>所以我们定义一个强符号NQqPQyqUth，并按照cookie赋值就可以输出了</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//phase3_patch.c</span></span><br><span class="line"><span class="type">char</span> NQqPQyqUth[<span class="number">256</span>]=<span class="string">&quot;0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000x0e00000000000r000gr&quot;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie  -c phase3_patch.c</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase3.o phase3_patch.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">grxer0000</span><br></pre></td></tr></table></figure>

<h2 id="phase4"><a href="#phase4" class="headerlink" title="phase4"></a>phase4</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase4.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">B9[wL:Nec</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">00000029 &lt;do_phase&gt;:</span><br><span class="line">  29:   55                      push   %ebp</span><br><span class="line">  2a:   89 e5                   mov    %esp,%ebp</span><br><span class="line">  2c:   83 ec 28                sub    $0x28,%esp</span><br><span class="line">  2f:   c7 45 e6 53 4e 58 47    movl   $0x47584e53,-0x1a(%ebp)</span><br><span class="line">  36:   c7 45 ea 4a 54 43 46    movl   $0x4643544a,-0x16(%ebp)</span><br><span class="line">  3d:   66 c7 45 ee 50 00       movw   $0x50,-0x12(%ebp);从ebp-0x1a处开始的cookie赋值结束</span><br><span class="line">  43:   c7 45 f0 00 00 00 00    movl   $0x0,-0x10(%ebp);ebp-0x10处计数器置零</span><br><span class="line">  4a:   e9 e0 00 00 00          jmp    12f &lt;do_phase+0x106&gt;</span><br><span class="line">  </span><br><span class="line">  4f:   8d 55 e6                lea    -0x1a(%ebp),%edx</span><br><span class="line">  52:   8b 45 f0                mov    -0x10(%ebp),%eax</span><br><span class="line">  55:   01 d0                   add    %edx,%eax</span><br><span class="line">  57:   0f b6 00                movzbl (%eax),%eax;eax=cookie[计数器]</span><br><span class="line">  5a:   88 45 f7                mov    %al,-0x9(%ebp)</span><br><span class="line">  5d:   0f be 45 f7             movsbl -0x9(%ebp),%eax</span><br><span class="line">  61:   83 e8 41                sub    $0x41,%eax;cookie[计数器]-0x41 相当于我们的case值</span><br><span class="line">  64:   83 f8 19                cmp    $0x19,%eax;cookie[计数器]-0x41和19比较</span><br><span class="line">  67:   0f 87 b0 00 00 00       ja     11d &lt;do_phase+0xf4&gt;;大于跳转类似于我们switch的default</span><br><span class="line">  6d:   8b 04 85 04 00 00 00    mov    0x4(,%eax,4),%eax;从下面的重定位信息来看，这里有一个需要重定位的地址.rodata，eax=*(eax*4+.rodata+4)</span><br><span class="line">  74:   ff e0                   jmp    *%eax;switch的跳转，这里和我平时见的switch都不太一样，就去实验了一下，发现当case情况过多时，就会采用这种jmp *eax的跳转方式,会有一张跳转表</span><br><span class="line">  76:   c6 45 f7 38             movb   $0x38,-0x9(%ebp)</span><br><span class="line">  7a:   e9 9e 00 00 00          jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  7f:   c6 45 f7 65             movb   $0x65,-0x9(%ebp)</span><br><span class="line">  83:   e9 95 00 00 00          jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  88:   c6 45 f7 35             movb   $0x35,-0x9(%ebp)</span><br><span class="line">  8c:   e9 8c 00 00 00          jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  91:   c6 45 f7 39             movb   $0x39,-0x9(%ebp)</span><br><span class="line">  95:   e9 83 00 00 00          jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  9a:   c6 45 f7 6d             movb   $0x6d,-0x9(%ebp)</span><br><span class="line">  9e:   eb 7d                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  a0:   c6 45 f7 6d             movb   $0x6d,-0x9(%ebp)</span><br><span class="line">  a4:   eb 77                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  a6:   c6 45 f7 4c             movb   $0x4c,-0x9(%ebp)</span><br><span class="line">  aa:   eb 71                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  ac:   c6 45 f7 73             movb   $0x73,-0x9(%ebp)</span><br><span class="line">  b0:   eb 6b                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  b2:   c6 45 f7 45             movb   $0x45,-0x9(%ebp)</span><br><span class="line">  b6:   eb 65                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  b8:   c6 45 f7 37             movb   $0x37,-0x9(%ebp)</span><br><span class="line">  bc:   eb 5f                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  be:   c6 45 f7 42             movb   $0x42,-0x9(%ebp)</span><br><span class="line">  c2:   eb 59                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  c4:   c6 45 f7 77             movb   $0x77,-0x9(%ebp)</span><br><span class="line">  c8:   eb 53                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  ca:   c6 45 f7 36             movb   $0x36,-0x9(%ebp)</span><br><span class="line">  ce:   eb 4d                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  d0:   c6 45 f7 3a             movb   $0x3a,-0x9(%ebp)</span><br><span class="line">  d4:   eb 47                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  d6:   c6 45 f7 5b             movb   $0x5b,-0x9(%ebp)</span><br><span class="line">  da:   eb 41                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  dc:   c6 45 f7 63             movb   $0x63,-0x9(%ebp)</span><br><span class="line">  e0:   eb 3b                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  e2:   c6 45 f7 5b             movb   $0x5b,-0x9(%ebp)</span><br><span class="line">  e6:   eb 35                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  e8:   c6 45 f7 33             movb   $0x33,-0x9(%ebp)</span><br><span class="line">  ec:   eb 2f                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  ee:   c6 45 f7 55             movb   $0x55,-0x9(%ebp)</span><br><span class="line">  f2:   eb 29                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  f4:   c6 45 f7 77             movb   $0x77,-0x9(%ebp)</span><br><span class="line">  f8:   eb 23                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  fa:   c6 45 f7 32             movb   $0x32,-0x9(%ebp)</span><br><span class="line">  fe:   eb 1d                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line"> 100:   c6 45 f7 4e             movb   $0x4e,-0x9(%ebp)</span><br><span class="line"> 104:   eb 17                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line"> 106:   c6 45 f7 30             movb   $0x30,-0x9(%ebp)</span><br><span class="line"> 10a:   eb 11                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line"> 10c:   c6 45 f7 31             movb   $0x31,-0x9(%ebp)</span><br><span class="line"> 110:   eb 0b                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line"> 112:   c6 45 f7 34             movb   $0x34,-0x9(%ebp)</span><br><span class="line"> 116:   eb 05                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line"> 118:   c6 45 f7 67             movb   $0x67,-0x9(%ebp)</span><br><span class="line"> 11c:   90                      nop</span><br><span class="line"> </span><br><span class="line"> 11d:   8d 55 dc                lea    -0x24(%ebp),%edx</span><br><span class="line"> 120:   8b 45 f0                mov    -0x10(%ebp),%eax</span><br><span class="line"> 123:   01 c2                   add    %eax,%edx;edx=ebp-0x24+计数器</span><br><span class="line"> 125:   0f b6 45 f7             movzbl -0x9(%ebp),%eax</span><br><span class="line"> 129:   88 02                   mov    %al,(%edx);*(ebp-0x24+计数器)=*(ebp-9）</span><br><span class="line"> 12b:   83 45 f0 01             addl   $0x1,-0x10(%ebp);计数器+1</span><br><span class="line"> </span><br><span class="line"> 12f:   8b 45 f0                mov    -0x10(%ebp),%eax</span><br><span class="line"> 132:   83 f8 08                cmp    $0x8,%eax</span><br><span class="line"> 135:   0f 86 14 ff ff ff       jbe    4f &lt;do_phase+0x26&gt;;计数器&gt;9直接结束</span><br><span class="line"> </span><br><span class="line"> 13b:   8d 55 dc                lea    -0x24(%ebp),%edx</span><br><span class="line"> 13e:   8b 45 f0                mov    -0x10(%ebp),%eax</span><br><span class="line"> 141:   01 d0                   add    %edx,%eax</span><br><span class="line"> 143:   c6 00 00                movb   $0x0,(%eax)</span><br><span class="line"> 146:   83 ec 0c                sub    $0xc,%esp</span><br><span class="line"> 149:   8d 45 dc                lea    -0x24(%ebp),%eax </span><br><span class="line"> 14c:   50                      push   %eax;ebp-0x24做puts参数</span><br><span class="line"> 14d:   e8 fc ff ff ff          call   14e &lt;do_phase+0x125&gt;;puts函数</span><br><span class="line"> 152:   83 c4 10                add    $0x10,%esp</span><br><span class="line"> 155:   90                      nop</span><br><span class="line"> 156:   c9                      leave</span><br><span class="line"> 157:   c3                      ret</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -r phase4.o</span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rel.text&#x27; at offset 0x3e0 contains 2 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">00000070  00000701 R_386_32          00000000   .rodata</span><br><span class="line">0000014e  00000d02 R_386_PC32        00000000   puts</span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rel.data&#x27; at offset 0x3f0 contains 2 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">00000030  00000701 R_386_32          00000000   .rodata</span><br><span class="line">00000034  00000c01 R_386_32          00000029   do_phase</span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rel.rodata&#x27; at offset 0x400 contains 26 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">00000004  00000201 R_386_32          00000000   .text</span><br><span class="line">00000008  00000201 R_386_32          00000000   .text</span><br><span class="line">0000000c  00000201 R_386_32          00000000   .text</span><br><span class="line">00000010  00000201 R_386_32          00000000   .text</span><br><span class="line">00000014  00000201 R_386_32          00000000   .text</span><br><span class="line">00000018  00000201 R_386_32          00000000   .text</span><br><span class="line">0000001c  00000201 R_386_32          00000000   .text</span><br><span class="line">00000020  00000201 R_386_32          00000000   .text</span><br><span class="line">00000024  00000201 R_386_32          00000000   .text</span><br><span class="line">00000028  00000201 R_386_32          00000000   .text</span><br><span class="line">0000002c  00000201 R_386_32          00000000   .text</span><br><span class="line">00000030  00000201 R_386_32          00000000   .text</span><br><span class="line">00000034  00000201 R_386_32          00000000   .text</span><br><span class="line">00000038  00000201 R_386_32          00000000   .text</span><br><span class="line">0000003c  00000201 R_386_32          00000000   .text</span><br><span class="line">00000040  00000201 R_386_32          00000000   .text</span><br><span class="line">00000044  00000201 R_386_32          00000000   .text</span><br><span class="line">00000048  00000201 R_386_32          00000000   .text</span><br><span class="line">0000004c  00000201 R_386_32          00000000   .text</span><br><span class="line">00000050  00000201 R_386_32          00000000   .text</span><br><span class="line">00000054  00000201 R_386_32          00000000   .text</span><br><span class="line">00000058  00000201 R_386_32          00000000   .text</span><br><span class="line">0000005c  00000201 R_386_32          00000000   .text</span><br><span class="line">00000060  00000201 R_386_32          00000000   .text</span><br><span class="line">00000064  00000201 R_386_32          00000000   .text</span><br><span class="line">00000068  00000201 R_386_32          00000000   .text</span><br></pre></td></tr></table></figure>

<p>分析过后逆出大致c代码</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">do_phase&#123;</span><br><span class="line">    <span class="type">char</span> cookie[<span class="number">10</span>]=&#123; <span class="number">53</span> <span class="number">4</span>e <span class="number">58</span> <span class="number">47</span>  <span class="number">4</span>a <span class="number">54</span> <span class="number">43</span> <span class="number">46</span>  <span class="number">50</span> <span class="number">00</span>&#125;;</span><br><span class="line">    <span class="type">char</span> answer[<span class="number">10</span>];</span><br><span class="line">    <span class="type">char</span> tmp;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;=<span class="number">8</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">switch</span> （tmp=cookie[i]<span class="number">-0x41</span>）&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                tmp=xxx;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            .....</span><br><span class="line">            <span class="keyword">case</span> <span class="number">26</span>:</span><br><span class="line">                tmp=xxx;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">              <span class="keyword">break</span>;  </span><br><span class="line">        &#125;</span><br><span class="line">        answer[i]=tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    answer[<span class="number">10</span>]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(answer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>多个swith会在.rodata里生成一张跳转表，跳转表在链接时需要重定位，.rel.rodata里有大量的重定位信息，都是绝对寻址修正，offset表示要修正的位置距离.rel.rodata的值，Sym. Name表示要把修正位置加上.text符号的地址，重定位是在符号表里的地址确定后进行的， <a target="_blank" rel="noopener" href="https://grxer.github.io/2023/04/28/static-link/">https://grxer.github.io/2023/04/28/static-link/</a> 里分析过</p>
<p>比如说我们的cookie第一个为53，0x53-0x41&#x3D;0x12，</p>
<p>根据<code>  6d:   8b 04 85 04 00 00 00    mov    0x4(,%eax,4),%eax;</code>在.rodata的偏移为0x12*4+4&#x3D;0x4c</p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507173942701.png" alt="image-20230507173942701"></p>
<p>jmp *%eax所以跳转到0be，即<code> be:   c6 45 f7 42             movb   $0x42,-0x9(%ebp)</code></p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507174043686.png" alt="image-20230507174043686"></p>
<p>所以第一个输出了B，我们只需要把跳转表里得值根据cookie跳转到把对应数字送入ebp-9处即可</p>
<p>我把它都改为6吧哈</p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507174600892.png" alt="image-20230507174600892"></p>
<p>懒得查第几个，所以都改了。。。。。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase4.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line"><span class="number">666666666</span></span><br></pre></td></tr></table></figure>

<h2 id="phase5"><a href="#phase5" class="headerlink" title="phase5"></a>phase5</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase5.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">fish: Job <span class="number">1</span>, <span class="string">&#x27;./linkbomb&#x27;</span> terminated by signal <span class="title function_">SIGILL</span> <span class="params">(Illegal instruction)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -r phase5.o</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x7f8</span> contains <span class="number">23</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000066</span>  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000075</span>  <span class="number">00000501</span> R_386_32          <span class="number">00000000</span>   .rodata</span><br><span class="line"><span class="number">00000086</span>  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">000000b</span>d  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000</span>cc  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">000000f</span>9  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000107</span>  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000118</span>  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000138</span>  <span class="number">00001302</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000162</span>  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">000001</span>c0  <span class="number">00001302</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">000001e4</span>  <span class="number">00001101</span> R_386_32          <span class="number">00000080</span>   AycPNh</span><br><span class="line"><span class="number">000001</span>ea  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000246</span>  <span class="number">00001002</span> R_386_PC32        <span class="number">000000</span>ef   generate_code</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000256</span>  <span class="number">00000</span>c01 R_386_32          <span class="number">00000100</span>   tqdzfNje</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000268</span>  <span class="number">00001702</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">puts</span></span><br></pre></td></tr></table></figure>

<p>可以看到有7个重定位信息被抹除了</p>
<p>贴一下符号表信息，后面要用</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -s phase5.o</span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.symtab&#x27; contains 25 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 00000000     0 FILE    LOCAL  DEFAULT  ABS phase5.c</span><br><span class="line">     2: 00000000     0 SECTION LOCAL  DEFAULT    1 .text</span><br><span class="line">     3: 00000000     0 SECTION LOCAL  DEFAULT    3 .data</span><br><span class="line">     4: 00000000     0 SECTION LOCAL  DEFAULT    5 .bss</span><br><span class="line">     5: 00000000     0 SECTION LOCAL  DEFAULT    6 .rodata</span><br><span class="line">     6: 00000000     0 SECTION LOCAL  DEFAULT    9 .note.GNU-stack</span><br><span class="line">     7: 00000000     0 SECTION LOCAL  DEFAULT   10 .eh_frame</span><br><span class="line">     8: 00000000     0 SECTION LOCAL  DEFAULT    8 .comment</span><br><span class="line">     9: 00000000   250 OBJECT  GLOBAL DEFAULT    3 ohMkhV</span><br><span class="line">    10: 00000000    93 FUNC    GLOBAL DEFAULT    1 OOtZxJJdNH</span><br><span class="line">    11: 000000fc     4 OBJECT  GLOBAL DEFAULT    3 phase_id</span><br><span class="line">    12: 00000100    10 OBJECT  GLOBAL DEFAULT    3 tqdzfNje</span><br><span class="line">    13: 00000020    52 OBJECT  GLOBAL DEFAULT    6 yAnKQn</span><br><span class="line">    14: 0000010c     4 OBJECT  GLOBAL DEFAULT    3 aQSEth</span><br><span class="line">    15: 0000005d   146 FUNC    GLOBAL DEFAULT    1 transform_code</span><br><span class="line">    16: 000000ef    60 FUNC    GLOBAL DEFAULT    1 generate_code</span><br><span class="line">    17: 00000080   128 OBJECT  GLOBAL DEFAULT    6 AycPNh</span><br><span class="line">    18: 0000012b   136 FUNC    GLOBAL DEFAULT    1 encode_1</span><br><span class="line">    19: 00000000     0 NOTYPE  GLOBAL DEFAULT  UND strlen</span><br><span class="line">    20: 000001b3   135 FUNC    GLOBAL DEFAULT    1 encode_2</span><br><span class="line">    21: 00000110     8 OBJECT  GLOBAL DEFAULT    3 encoder</span><br><span class="line">    22: 0000023a    56 FUNC    GLOBAL DEFAULT    1 do_phase</span><br><span class="line">    23: 00000000     0 NOTYPE  GLOBAL DEFAULT  UND puts</span><br><span class="line">    24: 00000118     4 OBJECT  GLOBAL DEFAULT    3 phase</span><br></pre></td></tr></table></figure>



<p>gdb调试一个一个改吧</p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507200104767.png" alt="image-20230507200104767"></p>
<h4 id="generate-code"><a href="#generate-code" class="headerlink" title="generate_code"></a>generate_code</h4><p>第一个错误发生在generate_code里</p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507200258182.png" alt="image-20230507200258182"></p>
<p>确实没有做重定位</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">generate_code</span><span class="params">( <span class="type">int</span> cookie )</span> &#123;</span><br><span class="line">... = cookie;</span><br><span class="line"><span class="keyword">for</span>( i=<span class="number">0</span>; i&lt;...; i++ ) &#123;</span><br><span class="line">... = transform_code( ..., i );</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从框架里看出是调用了transform_code函数</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">000000</span>ef &lt;generate_code&gt;:</span><br><span class="line">  ef:    <span class="number">55</span>                   	push   %ebp</span><br><span class="line">  f0:    <span class="number">89</span> e5                	mov    %esp,%ebp</span><br><span class="line">  f2:    <span class="number">83</span> ec <span class="number">10</span>             	sub    $<span class="number">0x10</span>,%esp</span><br><span class="line">  f5:    <span class="number">8b</span> <span class="number">45</span> <span class="number">08</span>             	mov    <span class="number">0x8</span>(%ebp),%eax</span><br><span class="line">  f8:    a3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    %eax,<span class="number">0x0</span></span><br><span class="line">  fd:    c7 <span class="number">45</span> fc <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	movl   $<span class="number">0x0</span>,<span class="number">-0x4</span>(%ebp)</span><br><span class="line"> <span class="number">104</span>:    eb <span class="number">1</span>a                	jmp    <span class="number">120</span> &lt;generate_code+<span class="number">0x31</span>&gt;</span><br><span class="line"> <span class="number">106</span>:    a1 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    <span class="number">0x0</span>,%eax</span><br><span class="line"> <span class="number">10b</span>:    ff <span class="number">75</span> fc             	push   <span class="number">-0x4</span>(%ebp)</span><br><span class="line"> <span class="number">10</span>e:    <span class="number">50</span>                   	push   %eax</span><br><span class="line"> <span class="number">10f</span>:    e8 fc ff ff ff       	call   <span class="number">110</span> &lt;generate_code+<span class="number">0x21</span>&gt;</span><br><span class="line"> <span class="number">114</span>:    <span class="number">83</span> c4 <span class="number">08</span>             	add    $<span class="number">0x8</span>,%esp</span><br><span class="line"> <span class="number">117</span>:    a3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    %eax,<span class="number">0x0</span></span><br><span class="line"> <span class="number">11</span>c:    <span class="number">83</span> <span class="number">45</span> fc <span class="number">01</span>          	addl   $<span class="number">0x1</span>,<span class="number">-0x4</span>(%ebp)</span><br><span class="line"> <span class="number">120</span>:    <span class="number">8b</span> <span class="number">45</span> fc             	mov    <span class="number">-0x4</span>(%ebp),%eax</span><br><span class="line"> <span class="number">123</span>:    <span class="number">83</span> f8 <span class="number">0</span>c             	cmp    $<span class="number">0xc</span>,%eax</span><br><span class="line"> <span class="number">126</span>:    <span class="number">76</span> de                	jbe    <span class="number">106</span> &lt;generate_code+<span class="number">0x17</span>&gt;</span><br><span class="line"> <span class="number">128</span>:    <span class="number">90</span>                   	nop</span><br><span class="line"> <span class="number">129</span>:    c9                   	leave  </span><br><span class="line"> <span class="number">12</span>a:    c3                   	ret    </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">10f</span>:    e8 fc ff ff ff       	call   <span class="number">110</span> &lt;generate_code+<span class="number">0x21</span>&gt;</span><br></pre></td></tr></table></figure>

<p>这是我们要重定位得地方，怎么重定位可以看   <a target="_blank" rel="noopener" href="https://grxer.github.io/2023/04/28/static-link/">https://grxer.github.io/2023/04/28/static-link/</a></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">uint32_t</span> Elf32_Addr;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">uint32_t</span> Elf32_Word;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Addr    r_offset;		<span class="comment">/* Address */</span></span><br><span class="line">  Elf32_Word    r_info;			<span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">&#125; Elf32_Rel;</span><br></pre></td></tr></table></figure>

<p><strong>r_offset</strong>表示要修正的位置第一个字节相对于这个段的偏移</p>
<p>r_info 低8位表示要重定位类型，高24位是符号在符号表里的下标</p>
<p>r_offset为110，相对重定位类型 02 ，符号表里的下标 15即f</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">10</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">02</span> <span class="number">0f</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>

<p><img src="/2023/05/08/ics4-linklab/image-20230507202240463.png" alt="image-20230507202240463"></p>
<p>ok了</p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507202423749.png" alt="image-20230507202423749"></p>
<h4 id="transform-code"><a href="#transform-code" class="headerlink" title="transform_code"></a>transform_code</h4><p>接下来错误发生在transform_code里</p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507202626683.png" alt="image-20230507202626683"></p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507202705410.png" alt="image-20230507202705410"></p>
<p>很熟悉的指令8b 04 85，我们上一个switch刚碰到过…</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">transform_code</span><span class="params">( <span class="type">int</span> code, <span class="type">int</span> mode )</span> &#123;</span><br><span class="line"><span class="keyword">switch</span> ( yAnKQn[mode] ... )</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0</span>: ......</span><br><span class="line"><span class="keyword">case</span> <span class="number">1</span>: ......</span><br><span class="line">......</span><br><span class="line"><span class="keyword">default</span>: ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0000005</span>d &lt;transform_code&gt;:</span><br><span class="line">  <span class="number">5</span>d:    <span class="number">55</span>                   	push   %ebp</span><br><span class="line">  <span class="number">5</span>e:    <span class="number">89</span> e5                	mov    %esp,%ebp</span><br><span class="line">  <span class="number">60</span>:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             	mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  <span class="number">63</span>:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  <span class="number">6</span>a:    <span class="number">83</span> e0 <span class="number">07</span>             	and    $<span class="number">0x7</span>,%eax</span><br><span class="line">  <span class="number">6</span>d:    <span class="number">83</span> f8 <span class="number">07</span>             	cmp    $<span class="number">0x7</span>,%eax</span><br><span class="line">  <span class="number">70</span>:    <span class="number">77</span> <span class="number">74</span>                	ja     e6 &lt;transform_code+<span class="number">0x89</span>&gt;</span><br><span class="line">  <span class="number">72</span>:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">54</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x54</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  <span class="number">79</span>:    ff e0                	jmp    *%eax</span><br><span class="line">  <span class="number">7b</span>:    f7 <span class="number">55</span> <span class="number">08</span>             	notl   <span class="number">0x8</span>(%ebp)</span><br><span class="line">  <span class="number">7</span>e:    eb <span class="number">6</span>a                	jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  <span class="number">80</span>:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             	mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  <span class="number">83</span>:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  <span class="number">8</span>a:    <span class="number">83</span> e0 <span class="number">03</span>             	and    $<span class="number">0x3</span>,%eax</span><br><span class="line">  <span class="number">8</span>d:    <span class="number">89</span> c1                	mov    %eax,%ecx</span><br><span class="line">  <span class="number">8f</span>:    d3 <span class="number">7</span>d <span class="number">08</span>             	sarl   %cl,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  <span class="number">92</span>:    eb <span class="number">56</span>                	jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  <span class="number">94</span>:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             	mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  <span class="number">97</span>:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  <span class="number">9</span>e:    f7 d0                	not    %eax</span><br><span class="line">  a0:    <span class="number">21</span> <span class="number">45</span> <span class="number">08</span>             	and    %eax,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  a3:    eb <span class="number">45</span>                	jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  a5:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             	mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  a8:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  af:    c1 e0 <span class="number">08</span>             	shl    $<span class="number">0x8</span>,%eax</span><br><span class="line">  b2:    <span class="number">09</span> <span class="number">45</span> <span class="number">08</span>             	or     %eax,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  b5:    eb <span class="number">33</span>                	jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  b7:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             	mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  ba:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  c1:    <span class="number">31</span> <span class="number">45</span> <span class="number">08</span>             	xor    %eax,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  c4:    eb <span class="number">24</span>                	jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  c6:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             	mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  c9:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  d0:    f7 d0                	not    %eax</span><br><span class="line">  d2:    <span class="number">09</span> <span class="number">45</span> <span class="number">08</span>             	or     %eax,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  d5:    eb <span class="number">13</span>                	jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  d7:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             	mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  da:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  e1:    <span class="number">01</span> <span class="number">45</span> <span class="number">08</span>             	add    %eax,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  e4:    eb <span class="number">04</span>                	jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  e6:    f7 <span class="number">5</span>d <span class="number">08</span>             	negl   <span class="number">0x8</span>(%ebp)</span><br><span class="line">  e9:    <span class="number">90</span>                   	nop</span><br><span class="line">  ea:    <span class="number">8b</span> <span class="number">45</span> <span class="number">08</span>             	mov    <span class="number">0x8</span>(%ebp),%eax</span><br><span class="line">  ed:    <span class="number">5</span>d                   	pop    %ebp</span><br><span class="line">  ee:    c3                   	ret    </span><br></pre></td></tr></table></figure>

<p>5d+58(十进制)&#x3D;0x97</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">97</span>:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br></pre></td></tr></table></figure>

<p>这里应该是.rodata数据yAnKQn的重定位了</p>
<p>r_offset 97+3&#x3D;9a 类型 01 yAnKQn符号下标13即d</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">9</span>A <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">0</span>D <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>

<p><img src="/2023/05/08/ics4-linklab/image-20230507205421832.png" alt="image-20230507205421832"></p>
<p>下一个错误</p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507205323580.png" alt="image-20230507205323580"></p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507205344052.png" alt="image-20230507205344052"></p>
<p>还是一样的</p>
<p>0x5d+75(十进制)&#x3D;0xA8</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">a8:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br></pre></td></tr></table></figure>

<p>offset &#x3D;a8+3&#x3D;AB 其余和上面一样</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">AB <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">0</span>D <span class="number">00</span> <span class="number">00</span> </span><br></pre></td></tr></table></figure>

<p><img src="/2023/05/08/ics4-linklab/image-20230507205815532.png" alt="image-20230507205815532"></p>
<p>后面又改了一个一样的</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">da:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">DD <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">0</span>D <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>

<p><img src="/2023/05/08/ics4-linklab/image-20230507210127236.png" alt="image-20230507210127236"></p>
<h4 id="do-phase"><a href="#do-phase" class="headerlink" title="do_phase"></a>do_phase</h4><p><img src="/2023/05/08/ics4-linklab/image-20230507210234694.png" alt="image-20230507210234694"></p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507210250054.png" alt="image-20230507210250054"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">do_phase</span><span class="params">()</span> &#123;</span><br><span class="line">generate_code(...);</span><br><span class="line">......; <span class="comment">// Call one encoder here</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, ...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0000023</span>a &lt;do_phase&gt;:</span><br><span class="line"> <span class="number">23</span>a:    <span class="number">55</span>                   	push   %ebp</span><br><span class="line"> <span class="number">23b</span>:    <span class="number">89</span> e5                	mov    %esp,%ebp</span><br><span class="line"> <span class="number">23</span>d:    <span class="number">83</span> ec <span class="number">08</span>             	sub    $<span class="number">0x8</span>,%esp</span><br><span class="line"> <span class="number">240</span>:    <span class="number">68</span> f3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	push   $<span class="number">0xf3</span></span><br><span class="line"> <span class="number">245</span>:    e8 fc ff ff ff       	call   <span class="number">246</span> &lt;do_phase+<span class="number">0xc</span>&gt;<span class="comment">//call 的是generate_code</span></span><br><span class="line"> <span class="number">24</span>a:    <span class="number">83</span> c4 <span class="number">04</span>             	add    $<span class="number">0x4</span>,%esp</span><br><span class="line"> <span class="number">24</span>d:    a1 <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    <span class="number">0x4</span>,%eax</span><br><span class="line"> <span class="number">252</span>:    <span class="number">83</span> ec <span class="number">0</span>c             	sub    $<span class="number">0xc</span>,%esp</span><br><span class="line"> <span class="number">255</span>:    <span class="number">68</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	push   $<span class="number">0x0</span></span><br><span class="line"> <span class="number">25</span>a:    ff d0                	call   *%eax</span><br><span class="line"> <span class="number">25</span>c:    <span class="number">83</span> c4 <span class="number">10</span>             	add    $<span class="number">0x10</span>,%esp</span><br><span class="line"> <span class="number">25f</span>:    <span class="number">83</span> ec <span class="number">0</span>c             	sub    $<span class="number">0xc</span>,%esp</span><br><span class="line"> <span class="number">262</span>:    <span class="number">68</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	push   $<span class="number">0x0</span></span><br><span class="line"> <span class="number">267</span>:    e8 fc ff ff ff       	call   <span class="number">268</span> &lt;do_phase+<span class="number">0x2e</span>&gt;<span class="comment">//框架里虽然是printf，被编译器优化为了puts</span></span><br><span class="line"> <span class="number">26</span>c:    <span class="number">83</span> c4 <span class="number">10</span>             	add    $<span class="number">0x10</span>,%esp</span><br><span class="line"> <span class="number">26f</span>:    <span class="number">90</span>                   	nop</span><br><span class="line"> <span class="number">270</span>:    c9                   	leave  </span><br><span class="line"> <span class="number">271</span>:    c3                   	ret    </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">24</span>d:    a1 <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    <span class="number">0x4</span>,%eax</span><br></pre></td></tr></table></figure>

<p>结合框架和call   *%eax，这里应该重定位一个encoder函数，</p>
<p>offset 24d+1&#x3D;24e,他的初始偏移为4估计是绝对地址重定位 01 encoder符号下标21即0x15</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">4</span>E <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">15</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>

<p>下一个错误</p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507212648240.png" alt="image-20230507212648240"></p>
<p>push了0做参数，puts必报错，这里就是我们的空指针指向的地方</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">262</span>:    <span class="number">68</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	push   $<span class="number">0x0</span></span><br></pre></td></tr></table></figure>

<p>那push什么呢</p>
<p>可以看到encoder函数参数，是tqdzfNje</p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507213134515.png" alt="image-20230507213134515"></p>
<p>输出的想必就是encode后的内容</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">63</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">0</span>C <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>

<p><img src="/2023/05/08/ics4-linklab/image-20230507214005609.png" alt="image-20230507214005609"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">UuUHH[[!?</span><br></pre></td></tr></table></figure>

<p>有输出但结果不太对，tmd</p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507220450148.png" alt="image-20230507220450148"></p>
<p>看来一下encoder调用的是encode_2</p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507220550289.png" alt="image-20230507220550289"></p>
<p>发现他是一个指针数组，确实他在符号表里的size显示的也是8</p>
<p>那肯定encode_1是正确答案了,由于是<code>call   *%eax</code>call的eax里的内容所以不能直接把 encode_1的函数符号写到重定位信息里</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Relocation section <span class="string">&#x27;.rel.data&#x27;</span> at offset <span class="number">0x8b0</span> contains <span class="number">4</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">000000f</span>c  <span class="number">00000501</span> R_386_32          <span class="number">00000000</span>   .rodata</span><br><span class="line"><span class="number">00000110</span>  <span class="number">00001201</span> R_386_32          <span class="number">0000012b</span>   encode_1</span><br><span class="line"><span class="number">00000114</span>  <span class="number">00001401</span> R_386_32          <span class="number">000001b</span>3   encode_2</span><br><span class="line"><span class="number">00000118</span>  <span class="number">00001601</span> R_386_32          <span class="number">0000023</span>a   do_phase</span><br></pre></td></tr></table></figure>

<p>那就直接把他encode_2的重定位信息改成encode_1就好了，这样调用encode_2的也就是encode_1了</p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507222739182.png" alt="image-20230507222739182"></p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507222657681.png" alt="image-20230507222657681"></p>
<p>欧克了</p>
<h4 id="encode-1"><a href="#encode-1" class="headerlink" title="encode_1"></a>encode_1</h4><p>运行一下，额，encode_1报错了，不过也说明方向对了</p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507223022320.png" alt="image-20230507223022320"></p>
<p>不过重定位什么呢</p>
<p>看了下encode_2</p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507223526485.png" alt="image-20230507223526485"></p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507223541678.png" alt="image-20230507223541678"></p>
<p>他填了AycPNh,我们也填这个试试看把</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">159</span>:    <span class="number">0f</span> b6 <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	movzbl <span class="number">0x0</span>(%eax),%eax</span><br></pre></td></tr></table></figure>

<p>0x159+3&#x3D;15C  17&#x3D;0x11</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">5</span>C <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">11</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase5.</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">%?%<span class="number">00</span>##Y?</span><br></pre></td></tr></table></figure>

<p>额，后面我试光了所以变量符号，都没有和pdf里一样的输出，就这样把，反正已经重定位了7处</p>
<p>重定位完后的重定位表</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -r phase5.o</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x7f8</span> contains <span class="number">23</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000066</span>  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000075</span>  <span class="number">00000501</span> R_386_32          <span class="number">00000000</span>   .rodata</span><br><span class="line"><span class="number">00000086</span>  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000110</span>  <span class="number">00000f</span>02 R_386_PC32        <span class="number">0000005</span>d   transform_code</span><br><span class="line"><span class="number">0000009</span>a  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000b</span>d  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000</span>cc  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000</span>ab  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000f</span>9  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000107</span>  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">000000</span>dd  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000118</span>  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000138</span>  <span class="number">00001302</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">0000024</span>e  <span class="number">00001501</span> R_386_32          <span class="number">00000110</span>   encoder</span><br><span class="line"><span class="number">00000162</span>  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">000001</span>c0  <span class="number">00001302</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">000001e4</span>  <span class="number">00001101</span> R_386_32          <span class="number">00000080</span>   AycPNh</span><br><span class="line"><span class="number">000001</span>ea  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000246</span>  <span class="number">00001002</span> R_386_PC32        <span class="number">000000</span>ef   generate_code</span><br><span class="line"><span class="number">00000263</span>  <span class="number">00000</span>c01 R_386_32          <span class="number">00000100</span>   tqdzfNje</span><br><span class="line"><span class="number">00000256</span>  <span class="number">00000</span>c01 R_386_32          <span class="number">00000100</span>   tqdzfNje</span><br><span class="line"><span class="number">0000015</span>c  <span class="number">00001101</span> R_386_32          <span class="number">00000080</span>   AycPNh</span><br><span class="line"><span class="number">00000268</span>  <span class="number">00001702</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">puts</span></span><br></pre></td></tr></table></figure>

<h2 id="phase6"><a href="#phase6" class="headerlink" title="phase6"></a>phase6</h2><p>主要用到的知识 <a target="_blank" rel="noopener" href="https://grxer.github.io/2023/05/04/ELF%20Dynamical-link/">https://grxer.github.io/2023/05/04/ELF%20Dynamical-link/</a></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase6.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">fish: Job <span class="number">1</span>, <span class="string">&#x27;./linkbomb&#x27;</span> terminated by signal <span class="title function_">SIGSEGV</span> <span class="params">(Address boundary error)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main) [SIGSEGV]&gt; readelf -r phase6.o</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x9e0</span> contains <span class="number">35</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000007</span>  <span class="number">00001902</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.ax</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">0000005</span>c  <span class="number">00001902</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.ax</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000067</span>  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000083</span>  <span class="number">00000509</span> R_386_GOTOFF      <span class="number">00000000</span>   .rodata</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">000000b</span>b  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">000000e0</span>  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000f</span>3  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000113</span>  <span class="number">00002102</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.bx</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000141</span>  <span class="number">00001f</span>04 R_386_PLT32       <span class="number">00000058</span>   transform_code</span><br><span class="line"><span class="number">0000014</span>c  <span class="number">00001e2</span>b R_386_GOT32X      <span class="number">000000</span>ac   aQSEth</span><br><span class="line"><span class="number">0000016</span>c  <span class="number">00002102</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.bx</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>符号表</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -s phase6.o</span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">&#x27;.symtab&#x27;</span> contains <span class="number">42</span> entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     <span class="number">0</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     <span class="number">1</span>: <span class="number">00000000</span>     <span class="number">0</span> FILE    LOCAL  DEFAULT  ABS phase6.c</span><br><span class="line">     <span class="number">2</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">3</span> .text</span><br><span class="line">     <span class="number">3</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">5</span> .data</span><br><span class="line">     <span class="number">4</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">6</span> .bss</span><br><span class="line">     <span class="number">5</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">7</span> .rodata</span><br><span class="line">     <span class="number">6</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">9</span> .data.rel.local</span><br><span class="line">     <span class="number">7</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">11</span> .data.rel</span><br><span class="line">     <span class="number">8</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">13</span> .text.__x86.get_[...]</span><br><span class="line">     <span class="number">9</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">14</span> .text.__x86.get_[...]</span><br><span class="line">    <span class="number">10</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">16</span> .note.GNU-<span class="built_in">stack</span></span><br><span class="line">    <span class="number">11</span>: <span class="number">00000102</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L6</span><br><span class="line">    <span class="number">12</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">17</span> .eh_frame</span><br><span class="line">    <span class="number">13</span>: <span class="number">0000008b</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L14</span><br><span class="line">    <span class="number">14</span>: <span class="number">00000090</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L13</span><br><span class="line">    <span class="number">15</span>: <span class="number">000000</span>a6     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L12</span><br><span class="line">    <span class="number">16</span>: <span class="number">000000b</span>9     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L11</span><br><span class="line">    <span class="number">17</span>: <span class="number">000000</span>cd     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L10</span><br><span class="line">    <span class="number">18</span>: <span class="number">000000</span>de     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L9</span><br><span class="line">    <span class="number">19</span>: <span class="number">000000f</span>1     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L7</span><br><span class="line">    <span class="number">20</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">15</span> .comment</span><br><span class="line">    <span class="number">21</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">1</span> .group</span><br><span class="line">    <span class="number">22</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">2</span> .group</span><br><span class="line">    <span class="number">23</span>: <span class="number">00000000</span>   <span class="number">158</span> OBJECT  GLOBAL DEFAULT    <span class="number">5</span> cjHQHR</span><br><span class="line">    <span class="number">24</span>: <span class="number">00000000</span>    <span class="number">88</span> FUNC    GLOBAL DEFAULT    <span class="number">3</span> OOtZxJJdNH</span><br><span class="line">    <span class="number">25</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    GLOBAL HIDDEN    <span class="number">13</span> __x86.get_pc_thunk.ax</span><br><span class="line">    <span class="number">26</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND _GLOBAL_OFFSET_TABLE_</span><br><span class="line">    <span class="number">27</span>: <span class="number">00000000</span>     <span class="number">4</span> OBJECT  GLOBAL DEFAULT    <span class="number">9</span> phase_id</span><br><span class="line">    <span class="number">28</span>: <span class="number">000000</span>a0    <span class="number">10</span> OBJECT  GLOBAL DEFAULT    <span class="number">5</span> tqdzfNje</span><br><span class="line">    <span class="number">29</span>: <span class="number">00000020</span>    <span class="number">52</span> OBJECT  GLOBAL DEFAULT    <span class="number">7</span> yAnKQn</span><br><span class="line">    <span class="number">30</span>: <span class="number">000000</span>ac     <span class="number">4</span> OBJECT  GLOBAL DEFAULT    <span class="number">5</span> aQSEth</span><br><span class="line">    <span class="number">31</span>: <span class="number">00000058</span>   <span class="number">179</span> FUNC    GLOBAL DEFAULT    <span class="number">3</span> transform_code</span><br><span class="line">    <span class="number">32</span>: <span class="number">0000010b</span>    <span class="number">89</span> FUNC    GLOBAL DEFAULT    <span class="number">3</span> generate_code</span><br><span class="line">    <span class="number">33</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    GLOBAL HIDDEN    <span class="number">14</span> __x86.get_pc_thunk.bx</span><br><span class="line">    <span class="number">34</span>: <span class="number">00000080</span>   <span class="number">128</span> OBJECT  GLOBAL DEFAULT    <span class="number">7</span> AycPNh</span><br><span class="line">    <span class="number">35</span>: <span class="number">00000164</span>   <span class="number">156</span> FUNC    GLOBAL DEFAULT    <span class="number">3</span> encode_1</span><br><span class="line">    <span class="number">36</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND <span class="built_in">strlen</span></span><br><span class="line">    <span class="number">37</span>: <span class="number">00000200</span>   <span class="number">155</span> FUNC    GLOBAL DEFAULT    <span class="number">3</span> encode_2</span><br><span class="line">    <span class="number">38</span>: <span class="number">00000000</span>     <span class="number">8</span> OBJECT  GLOBAL DEFAULT   <span class="number">11</span> encoder</span><br><span class="line">    <span class="number">39</span>: <span class="number">0000029b</span>    <span class="number">82</span> FUNC    GLOBAL DEFAULT    <span class="number">3</span> do_phase</span><br><span class="line">    <span class="number">40</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND <span class="built_in">puts</span></span><br><span class="line">    <span class="number">41</span>: <span class="number">00000008</span>     <span class="number">4</span> OBJECT  GLOBAL DEFAULT   <span class="number">11</span> phase</span><br></pre></td></tr></table></figure>

<p>首先呢他的getpc函数都是nop，所以需要先修复这个</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Disassembly of section .text.__x86.get_pc_thunk.ax:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;__x86.get_pc_thunk.ax&gt;:</span><br><span class="line">   <span class="number">0</span>:    <span class="number">90</span>                   	nop</span><br><span class="line">   <span class="number">1</span>:    <span class="number">90</span>                   	nop</span><br><span class="line">   <span class="number">2</span>:    <span class="number">90</span>                   	nop</span><br><span class="line">   <span class="number">3</span>:    <span class="number">90</span>                   	nop</span><br><span class="line"></span><br><span class="line">Disassembly of section .text.__x86.get_pc_thunk.bx:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;__x86.get_pc_thunk.bx&gt;:</span><br><span class="line">   <span class="number">0</span>:    <span class="number">90</span>                   	nop</span><br><span class="line">   <span class="number">1</span>:    <span class="number">90</span>                   	nop</span><br><span class="line">   <span class="number">2</span>:    <span class="number">90</span>                   	nop</span><br><span class="line">   <span class="number">3</span>:    <span class="number">90</span>                   	nop</span><br></pre></td></tr></table></figure>

<p>修复后</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Disassembly of section .text.__x86.get_pc_thunk.ax:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;__x86.get_pc_thunk.ax&gt;:</span><br><span class="line">   <span class="number">0</span>:   <span class="number">8b</span> <span class="number">04</span> <span class="number">24</span>                mov    (%esp),%eax</span><br><span class="line">   <span class="number">3</span>:   c3                      ret</span><br><span class="line"></span><br><span class="line">Disassembly of section .text.__x86.get_pc_thunk.bx:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;__x86.get_pc_thunk.bx&gt;:</span><br><span class="line">   <span class="number">0</span>:   <span class="number">8b</span> <span class="number">1</span>c <span class="number">24</span>                mov    (%esp),%ebx</span><br><span class="line">   <span class="number">3</span>:   c3                      ret</span><br></pre></td></tr></table></figure>

<h4 id="generate-code-1"><a href="#generate-code-1" class="headerlink" title="generate_code"></a>generate_code</h4><p>第一个错误</p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507232413843.png" alt="image-20230507232413843"></p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507232536405.png" alt="image-20230507232536405"></p>
<p><img src="/2023/05/08/ics4-linklab/image-20230507233555928.png" alt="image-20230507233555928"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0000010b</span> &lt;generate_code&gt;:</span><br><span class="line"> <span class="number">10b</span>:    <span class="number">55</span>                   	push   %ebp</span><br><span class="line"> <span class="number">10</span>c:    <span class="number">89</span> e5                	mov    %esp,%ebp</span><br><span class="line"> <span class="number">10</span>e:    <span class="number">53</span>                   	push   %ebx</span><br><span class="line"> <span class="number">10f</span>:    <span class="number">83</span> ec <span class="number">14</span>             	sub    $<span class="number">0x14</span>,%esp</span><br><span class="line"> <span class="number">112</span>:    e8 fc ff ff ff       	call   <span class="number">113</span> &lt;generate_code+<span class="number">0x8</span>&gt; <span class="comment">//__x86.get_pc_thunk.bx</span></span><br><span class="line"> <span class="number">117</span>:    <span class="number">81</span> c3 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	add    $<span class="number">0x2</span>,%ebx</span><br><span class="line"> <span class="number">11</span>d:    <span class="number">8b</span> <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x0</span>(%ebx),%eax</span><br><span class="line"> <span class="number">123</span>:    <span class="number">8b</span> <span class="number">55</span> <span class="number">08</span>             	mov    <span class="number">0x8</span>(%ebp),%edx</span><br><span class="line"> <span class="number">126</span>:    <span class="number">89</span> <span class="number">10</span>                	mov    %edx,(%eax)</span><br><span class="line"> <span class="number">128</span>:    c7 <span class="number">45</span> f4 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	movl   $<span class="number">0x0</span>,<span class="number">-0xc</span>(%ebp)</span><br><span class="line"> <span class="number">12f</span>:    eb <span class="number">25</span>                	jmp    <span class="number">156</span> &lt;generate_code+<span class="number">0x4b</span>&gt;</span><br><span class="line"> <span class="number">131</span>:    <span class="number">8b</span> <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x0</span>(%ebx),%eax</span><br><span class="line"> <span class="number">137</span>:    <span class="number">8b</span> <span class="number">00</span>                	mov    (%eax),%eax</span><br><span class="line"> <span class="number">139</span>:    <span class="number">83</span> ec <span class="number">08</span>             	sub    $<span class="number">0x8</span>,%esp</span><br><span class="line"> <span class="number">13</span>c:    ff <span class="number">75</span> f4             	push   <span class="number">-0xc</span>(%ebp)</span><br><span class="line"> <span class="number">13f</span>:    <span class="number">50</span>                   	push   %eax</span><br><span class="line"> <span class="number">140</span>:    e8 fc ff ff ff       	call   <span class="number">141</span> &lt;generate_code+<span class="number">0x36</span>&gt;</span><br><span class="line"> <span class="number">145</span>:    <span class="number">83</span> c4 <span class="number">10</span>             	add    $<span class="number">0x10</span>,%esp</span><br><span class="line"> <span class="number">148</span>:    <span class="number">89</span> c2                	mov    %eax,%edx</span><br><span class="line"> <span class="number">14</span>a:    <span class="number">8b</span> <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x0</span>(%ebx),%eax</span><br><span class="line"> <span class="number">150</span>:    <span class="number">89</span> <span class="number">10</span>                	mov    %edx,(%eax)</span><br><span class="line"> <span class="number">152</span>:    <span class="number">83</span> <span class="number">45</span> f4 <span class="number">01</span>          	addl   $<span class="number">0x1</span>,<span class="number">-0xc</span>(%ebp)</span><br><span class="line"> <span class="number">156</span>:    <span class="number">8b</span> <span class="number">45</span> f4             	mov    <span class="number">-0xc</span>(%ebp),%eax</span><br><span class="line"> <span class="number">159</span>:    <span class="number">83</span> f8 <span class="number">0</span>c             	cmp    $<span class="number">0xc</span>,%eax</span><br><span class="line"> <span class="number">15</span>c:    <span class="number">76</span> d3                	jbe    <span class="number">131</span> &lt;generate_code+<span class="number">0x26</span>&gt;</span><br><span class="line"> <span class="number">15</span>e:    <span class="number">90</span>                   	nop</span><br><span class="line"> <span class="number">15f</span>:    <span class="number">8b</span> <span class="number">5</span>d fc             	mov    <span class="number">-0x4</span>(%ebp),%ebx</span><br><span class="line"> <span class="number">162</span>:    c9                   	leave  </span><br><span class="line"> <span class="number">163</span>:    c3                   	ret  </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">126</span>:    <span class="number">89</span> <span class="number">10</span>                	mov    %edx,(%eax)</span><br></pre></td></tr></table></figure>

<p>失败的原因是eax里的内容是0x2，往上溯源，通过之前在动态链接里的学习,能够发现下面两句是关键</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">117</span>:    <span class="number">81</span> c3 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	add    $<span class="number">0x2</span>,%ebx</span><br><span class="line"><span class="number">11</span>d:    <span class="number">8b</span> <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x0</span>(%ebx),%eax</span><br></pre></td></tr></table></figure>

<p><code> 117:	81 c3 02 00 00 00    	add    $0x2,%ebx</code>这句肯定是在找重定位got表的位置</p>
<p><code>11d:	8b 83 00 00 00 00      mov    0x0(%ebx)</code>是在根据偏移找变量在got表里的位置</p>
<p>下面这句也一样</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">131</span>:    <span class="number">8b</span> <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x0</span>(%ebx),%eax</span><br></pre></td></tr></table></figure>

<p>仿照下面去写got重定位就行</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">000002</span>a9  <span class="number">00001</span>a0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">19</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">0</span>A <span class="number">1</span>A <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>

<p>在got里找偏移的就根据下面这个去改写</p>
<p><code> 14a:	8b 83 00 00 00 00    	mov    0x0(%ebx),%eax</code>这句已经被重定位过了</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0000014</span>c  <span class="number">00001e2</span>b R_386_GOT32X      <span class="number">000000</span>ac   aQSEth</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">1F</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">2B</span> <span class="number">1</span>E <span class="number">00</span> <span class="number">00</span> </span><br><span class="line"><span class="number">33</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">2B</span> <span class="number">1</span>E <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>

<h4 id="transform-code-1"><a href="#transform-code-1" class="headerlink" title="transform_code"></a>transform_code</h4><p><img src="/2023/05/08/ics4-linklab/image-20230508011418971.png" alt="image-20230508011418971"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000058</span> &lt;transform_code&gt;:</span><br><span class="line">  <span class="number">58</span>:    <span class="number">55</span>                   	push   %ebp</span><br><span class="line">  <span class="number">59</span>:    <span class="number">89</span> e5                	mov    %esp,%ebp</span><br><span class="line">  <span class="number">5b</span>:    e8 fc ff ff ff       	call   <span class="number">5</span>c &lt;transform_code+<span class="number">0x4</span>&gt;<span class="comment">//__x86.get_pc_thunk.ax</span></span><br><span class="line">  <span class="number">60</span>:    <span class="number">05</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	add    $<span class="number">0x1</span>,%eax</span><br><span class="line">  <span class="number">65</span>:    <span class="number">8b</span> <span class="number">90</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x0</span>(%eax),%edx</span><br><span class="line">  <span class="number">6b</span>:    <span class="number">8b</span> <span class="number">4</span>d <span class="number">0</span>c             	mov    <span class="number">0xc</span>(%ebp),%ecx</span><br><span class="line">  <span class="number">6</span>e:    <span class="number">8b</span> <span class="number">14</span> <span class="number">8</span>a             	<span class="title function_">mov</span>    <span class="params">(%edx,%ecx,<span class="number">4</span>)</span>,%edx</span><br><span class="line">  71:    83 e2 07             	and    $0x7,%edx</span><br><span class="line">  74:    83 fa 07             	cmp    $0x7,%edx</span><br><span class="line">  77:    0f 87 85 00 00 00    	ja     102 &lt;.L6&gt;</span><br><span class="line">  7d:    c1 e2 02             	shl    $0x2,%edx</span><br><span class="line">  80:    8b 94 02 54 00 00 00 	mov    0<span class="title function_">x54</span><span class="params">(%edx,%eax,<span class="number">1</span>)</span>,%edx</span><br><span class="line">  87:    01 c2                	add    %eax,%edx</span><br><span class="line">  89:    ff e2                	jmp    *%edx</span><br><span class="line"></span><br><span class="line">0000008b &lt;.L14&gt;:</span><br><span class="line">  8b:    f7 55 08             	notl   0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line">  8e:    eb 76                	jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">00000090 &lt;.L13&gt;:</span><br><span class="line">  90:    8b 80 00 00 00 00    	mov    0<span class="title function_">x0</span><span class="params">(%eax)</span>,%eax</span><br><span class="line">  96:    8b 55 0c             	mov    0<span class="title function_">xc</span><span class="params">(%ebp)</span>,%edx</span><br><span class="line">  99:    8b 04 90             	<span class="title function_">mov</span>    <span class="params">(%eax,%edx,<span class="number">4</span>)</span>,%eax</span><br><span class="line">  9c:    83 e0 03             	and    $0x3,%eax</span><br><span class="line">  9f:    89 c1                	mov    %eax,%ecx</span><br><span class="line">  a1:    d3 7d 08             	sarl   %cl,0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line">  a4:    eb 60                	jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">000000a6 &lt;.L12&gt;:</span><br><span class="line">  a6:    8b 80 00 00 00 00    	mov    0<span class="title function_">x0</span><span class="params">(%eax)</span>,%eax</span><br><span class="line">  ac:    8b 55 0c             	mov    0<span class="title function_">xc</span><span class="params">(%ebp)</span>,%edx</span><br><span class="line">  af:    8b 04 90             	<span class="title function_">mov</span>    <span class="params">(%eax,%edx,<span class="number">4</span>)</span>,%eax</span><br><span class="line">  b2:    f7 d0                	not    %eax</span><br><span class="line">  b4:    21 45 08             	and    %eax,0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line">  b7:    eb 4d                	jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">000000b9 &lt;.L11&gt;:</span><br><span class="line">  b9:    8b 80 00 00 00 00    	mov    0<span class="title function_">x0</span><span class="params">(%eax)</span>,%eax</span><br><span class="line">  bf:    8b 55 0c             	mov    0<span class="title function_">xc</span><span class="params">(%ebp)</span>,%edx</span><br><span class="line">  c2:    8b 04 90             	<span class="title function_">mov</span>    <span class="params">(%eax,%edx,<span class="number">4</span>)</span>,%eax</span><br><span class="line">  c5:    c1 e0 08             	shl    $0x8,%eax</span><br><span class="line">  c8:    09 45 08             	or     %eax,0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line">  cb:    eb 39                	jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">000000cd &lt;.L10&gt;:</span><br><span class="line">  cd:    8b 80 00 00 00 00    	mov    0<span class="title function_">x0</span><span class="params">(%eax)</span>,%eax</span><br><span class="line">  d3:    8b 55 0c             	mov    0<span class="title function_">xc</span><span class="params">(%ebp)</span>,%edx</span><br><span class="line">  d6:    8b 04 90             	<span class="title function_">mov</span>    <span class="params">(%eax,%edx,<span class="number">4</span>)</span>,%eax</span><br><span class="line">  d9:    31 45 08             	xor    %eax,0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line">  dc:    eb 28                	jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">000000de &lt;.L9&gt;:</span><br><span class="line">  de:    8b 80 00 00 00 00    	mov    0<span class="title function_">x0</span><span class="params">(%eax)</span>,%eax</span><br><span class="line">  e4:    8b 55 0c             	mov    0<span class="title function_">xc</span><span class="params">(%ebp)</span>,%edx</span><br><span class="line">  e7:    8b 04 90             	<span class="title function_">mov</span>    <span class="params">(%eax,%edx,<span class="number">4</span>)</span>,%eax</span><br><span class="line">  ea:    f7 d0                	not    %eax</span><br><span class="line">  ec:    09 45 08             	or     %eax,0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line">  ef:    eb 15                	jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">000000f1 &lt;.L7&gt;:</span><br><span class="line">  f1:    8b 80 00 00 00 00    	mov    0<span class="title function_">x0</span><span class="params">(%eax)</span>,%eax</span><br><span class="line">  f7:    8b 55 0c             	mov    0<span class="title function_">xc</span><span class="params">(%ebp)</span>,%edx</span><br><span class="line">  fa:    8b 04 90             	<span class="title function_">mov</span>    <span class="params">(%eax,%edx,<span class="number">4</span>)</span>,%eax</span><br><span class="line">  fd:    01 45 08             	add    %eax,0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line"> 100:    eb 04                	jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">00000102 &lt;.L6&gt;:</span><br><span class="line"> 102:    f7 5d 08             	negl   0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line"> 105:    90                   	nop</span><br><span class="line"> 106:    8b 45 08             	mov    0<span class="title function_">x8</span><span class="params">(%ebp)</span>,%eax</span><br><span class="line"> 109:    5d                   	pop    %ebp</span><br><span class="line"> 10a:    c3                   	ret    </span><br></pre></td></tr></table></figure>

<p>getpc后</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">5b</span>:    e8 fc ff ff ff       	call   <span class="number">5</span>c &lt;transform_code+<span class="number">0x4</span>&gt;<span class="comment">//__x86.get_pc_thunk.ax</span></span><br><span class="line"><span class="number">60</span>:    <span class="number">05</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	add    $<span class="number">0x1</span>,%eax</span><br></pre></td></tr></table></figure>

<p>基本上下一句都是获取got表位置的重定位,直接把00000007  00001902 R_386_PC32        00000000   __x86.get_pc_thunk.ax这一个一块改了</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">61</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">0</span>A <span class="number">1</span>A <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">0</span>C <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">0</span>A <span class="number">1</span>A <span class="number">00</span> <span class="number">00</span> </span><br></pre></td></tr></table></figure>

<p>switch case需要重定位的地方</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">90</span>:    <span class="number">8b</span> <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x0</span>(%eax),%eax</span><br><span class="line">a6:    <span class="number">8b</span> <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x0</span>(%eax),%eax</span><br><span class="line">cd:    <span class="number">8b</span> <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    <span class="number">0x0</span>(%eax),%eax</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">92</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">2B</span> <span class="number">1</span>D <span class="number">00</span> <span class="number">00</span>  </span><br><span class="line">A8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">2B</span> <span class="number">1</span>D <span class="number">00</span> <span class="number">00</span>  </span><br><span class="line">CF <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">2B</span> <span class="number">1</span>D <span class="number">00</span> <span class="number">00</span>  </span><br></pre></td></tr></table></figure>

<p>修正后重定位表</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x9e0</span> contains <span class="number">35</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000007</span>  <span class="number">00001902</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.ax</span><br><span class="line"><span class="number">00000119</span>  <span class="number">00001</span>a0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">0000005</span>c  <span class="number">00001902</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.ax</span><br><span class="line"><span class="number">0000011f</span>  <span class="number">00001e2</span>b R_386_GOT32X      <span class="number">000000</span>ac   aQSEth</span><br><span class="line"><span class="number">00000067</span>  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000083</span>  <span class="number">00000509</span> R_386_GOTOFF      <span class="number">00000000</span>   .rodata</span><br><span class="line"><span class="number">00000133</span>  <span class="number">00001e2</span>b R_386_GOT32X      <span class="number">000000</span>ac   aQSEth</span><br><span class="line"><span class="number">0000000</span>c  <span class="number">00001</span>a0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">000000b</span>b  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000061</span>  <span class="number">00001</span>a0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">000000e0</span>  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000f</span>3  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000113</span>  <span class="number">00002102</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.bx</span><br><span class="line"><span class="number">00000092</span>  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000</span>a8  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000</span>cf  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000141</span>  <span class="number">00001f</span>04 R_386_PLT32       <span class="number">00000058</span>   transform_code</span><br><span class="line"><span class="number">0000014</span>c  <span class="number">00001e2</span>b R_386_GOT32X      <span class="number">000000</span>ac   aQSEth</span><br><span class="line"><span class="number">0000016</span>c  <span class="number">00002102</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.bx</span><br><span class="line"><span class="number">00000172</span>  <span class="number">00001</span>a0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">0000017</span>d  <span class="number">00002404</span> R_386_PLT32       <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">000001</span>a0  <span class="number">0000222b</span> R_386_GOT32X      <span class="number">00000080</span>   AycPNh</span><br><span class="line"><span class="number">000001</span>aa  <span class="number">00001e2</span>b R_386_GOT32X      <span class="number">000000</span>ac   aQSEth</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase6.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">a*aTTgg-K</span><br></pre></td></tr></table></figure>


  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NJU-ICS4-Linklab"><span class="toc-number">1.</span> <span class="toc-text">NJU ICS4 Linklab</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#phase1"><span class="toc-number">1.1.</span> <span class="toc-text">phase1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phase2"><span class="toc-number">1.2.</span> <span class="toc-text">phase2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phase3"><span class="toc-number">1.3.</span> <span class="toc-text">phase3</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phase4"><span class="toc-number">1.4.</span> <span class="toc-text">phase4</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phase5"><span class="toc-number">1.5.</span> <span class="toc-text">phase5</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#generate-code"><span class="toc-number">1.5.0.1.</span> <span class="toc-text">generate_code</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#transform-code"><span class="toc-number">1.5.0.2.</span> <span class="toc-text">transform_code</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#do-phase"><span class="toc-number">1.5.0.3.</span> <span class="toc-text">do_phase</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#encode-1"><span class="toc-number">1.5.0.4.</span> <span class="toc-text">encode_1</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#phase6"><span class="toc-number">1.6.</span> <span class="toc-text">phase6</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#generate-code-1"><span class="toc-number">1.6.0.1.</span> <span class="toc-text">generate_code</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#transform-code-1"><span class="toc-number">1.6.0.2.</span> <span class="toc-text">transform_code</span></a></li></ol></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/05/08/ics4-linklab/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/05/08/ics4-linklab/&text=NJU ICS4 Linklab"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/05/08/ics4-linklab/&title=NJU ICS4 Linklab"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/05/08/ics4-linklab/&is_video=false&description=NJU ICS4 Linklab"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=NJU ICS4 Linklab&body=Check out this article: https://grxer.gitee.io/2023/05/08/ics4-linklab/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/05/08/ics4-linklab/&title=NJU ICS4 Linklab"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/05/08/ics4-linklab/&title=NJU ICS4 Linklab"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/05/08/ics4-linklab/&title=NJU ICS4 Linklab"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/05/08/ics4-linklab/&title=NJU ICS4 Linklab"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/05/08/ics4-linklab/&name=NJU ICS4 Linklab&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/05/08/ics4-linklab/&t=NJU ICS4 Linklab"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023
    bxz
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?a22ef0bec4e4a9c7337bea6e37ff55c1";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
