<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="baidu-site-verification" content="codeva-ROfYcqLkCh" />
    <meta name="msvalidate.01" content="ECA3E06A0E52A2AC90C4B06F12981FB2" />
    <meta name="description" content="NEMU PA1https:&#x2F;&#x2F;nju-projectn.github.io&#x2F;ics-pa-gitbook&#x2F;ics2020&#x2F;PA1.html 没用bash，用的fish export NEMU_HOME&#x3D;&#x2F;mnt&#x2F;hgfs&#x2F;share&#x2F;ics2020&#x2F;nemuexport AM_HOME&#x3D;&#x2F;mnt&#x2F;hgfs&#x2F;share&#x2F;ics2020&#x2F;abstract-machinesource ~&#x2F;.confi">
<meta property="og:type" content="article">
<meta property="og:title" content="x86 NEMU PA1">
<meta property="og:url" content="https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/index.html">
<meta property="og:site_name" content="Grxer&#39;s Blog">
<meta property="og:description" content="NEMU PA1https:&#x2F;&#x2F;nju-projectn.github.io&#x2F;ics-pa-gitbook&#x2F;ics2020&#x2F;PA1.html 没用bash，用的fish export NEMU_HOME&#x3D;&#x2F;mnt&#x2F;hgfs&#x2F;share&#x2F;ics2020&#x2F;nemuexport AM_HOME&#x3D;&#x2F;mnt&#x2F;hgfs&#x2F;share&#x2F;ics2020&#x2F;abstract-machinesource ~&#x2F;.confi">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2023-05-13T04:16:03.000Z">
<meta property="article:modified_time" content="2023-09-17T08:15:54.773Z">
<meta property="article:author" content="bxz">
<meta property="article:tag" content="NEMU">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>x86 NEMU PA1</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 lrt">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/05/19/PE-FILE/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/05/08/ics4-linklab/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/&text=x86 NEMU PA1"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/&title=x86 NEMU PA1"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/&is_video=false&description=x86 NEMU PA1"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=x86 NEMU PA1&body=Check out this article: https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/&title=x86 NEMU PA1"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/&title=x86 NEMU PA1"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/&title=x86 NEMU PA1"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/&title=x86 NEMU PA1"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/&name=x86 NEMU PA1&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/&t=x86 NEMU PA1"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NEMU-PA1"><span class="toc-number">1.</span> <span class="toc-text">NEMU PA1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.1.</span> <span class="toc-text">寄存器结构体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Eassert%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%B0%81%E8%A3%85"><span class="toc-number">1.2.</span> <span class="toc-text">关于assert实现与封装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#info-r"><span class="toc-number">1.3.</span> <span class="toc-text">info r</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#si-N"><span class="toc-number">1.4.</span> <span class="toc-text">si N</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#x-N-EXPR"><span class="toc-number">1.5.</span> <span class="toc-text">x N EXPR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#p-%E8%A1%A8%E7%A4%BA%E5%BC%8F%E6%B1%82%E5%80%BC"><span class="toc-number">1.6.</span> <span class="toc-text">p 表示式求值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E8%A7%86%E7%82%B9"><span class="toc-number">1.7.</span> <span class="toc-text">监视点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#info-w"><span class="toc-number">1.7.1.</span> <span class="toc-text">info w</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#d-NUM"><span class="toc-number">1.7.2.</span> <span class="toc-text">d NUM</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%99%A8%E6%89%80%E6%9C%89command"><span class="toc-number">1.8.</span> <span class="toc-text">调试器所有command</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        x86 NEMU PA1
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">bxz</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-05-13T04:16:03.000Z" itemprop="datePublished">2023-05-13</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/NEMU/" rel="tag">NEMU</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="NEMU-PA1"><a href="#NEMU-PA1" class="headerlink" title="NEMU PA1"></a>NEMU PA1</h1><p><a target="_blank" rel="noopener" href="https://nju-projectn.github.io/ics-pa-gitbook/ics2020/PA1.html">https://nju-projectn.github.io/ics-pa-gitbook/ics2020/PA1.html</a></p>
<p>没用bash，用的fish</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">export NEMU_HOME=/mnt/hgfs/share/ics2020/nemu</span><br><span class="line">export AM_HOME=/mnt/hgfs/share/ics2020/abstract-machine</span><br><span class="line">source ~/.config/fish/config.fish</span><br></pre></td></tr></table></figure>

<p>abstruct machine 里change SIGSTKSZ to 8192</p>
<p>vscode 配置c_cpp_properties.json里一些预编译，来配置解析选项解锁正确的代码解析</p>
<p>可以用make -nB查看一下项目里原本定义的预编译宏</p>
<ul>
<li>-n 仅显示将要执行的命令，而不实际执行它们。</li>
<li>-B 表示 “always-make”，它告诉 make 忽略时间戳检查，强制重新构建目标文件</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 /m/h/s/i/nemu (pa1)&gt; make ARCH=x86-nemu ALL=dummy run -nB</span><br><span class="line">gcc -D__DIFF_REF_KVM__ -O2 -MMD -Wall -Werror -ggdb3 -I./include -I./src/engine/interpreter -D__ENGINE_interpreter__ -D__ISA__=x86 -D__ISA_x86__ -D_ISA_H_=\<span class="string">&quot;isa/x86.h\&quot;  -c -o build/obj-x86-interpreter/monitor/monitor.o src/monitor/monitor.c</span></span><br><span class="line"><span class="string">echo + CC src/isa/x86/decode.c</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">//c_cpp_properties.json</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;includePath&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;$&#123;workspaceFolder&#125;/**&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;defines&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;__DIFF_REF_KVM__&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;__ENGINE_interpreter__&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;__ISA__=x86 &quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;__ISA_x86__&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;_ISA_H_=\&quot;isa/x86.h\&quot;&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;compilerPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/usr/bin/gcc&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cStandard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c17&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cppStandard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gnu++17&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;intelliSenseMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux-gcc-x64&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;configurationProvider&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ms-vscode.makefile-tools&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>额，后来用了clangd做解析。。。。 bear –make自动生成数据库，好用尼</strong></p>
<p>或者，下面这个好像是专门给makefile用的</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">pip install compiledb</span><br><span class="line">compiledb -n make ARCH=x86-nemu ALL=dummy</span><br><span class="line"><span class="comment">//-n 表示no-build</span></span><br></pre></td></tr></table></figure>

<p>开始pa之旅:)</p>
<h2 id="寄存器结构体"><a href="#寄存器结构体" class="headerlink" title="寄存器结构体"></a>寄存器结构体</h2><p>利用匿名union和匿名struct去写</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Do NOT change the order of the GPRs&#x27; definitions. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* In NEMU, rtlreg_t is exactly uint32_t. This makes RTL instructions</span></span><br><span class="line"><span class="comment">   * in PA2 able to directly access these registers.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">      <span class="type">uint32_t</span> _32;</span><br><span class="line">      <span class="type">uint16_t</span> _16;</span><br><span class="line">      <span class="type">uint8_t</span> _8[<span class="number">2</span>];</span><br><span class="line">    &#125; gpr[<span class="number">8</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">      <span class="type">rtlreg_t</span> eax, ecx, edx, ebx, esp, ebp, esi, edi;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="type">vaddr_t</span> pc;</span><br><span class="line">&#125; x86_CPU_state;</span><br></pre></td></tr></table></figure>

<h2 id="关于assert实现与封装"><a href="#关于assert实现与封装" class="headerlink" title="关于assert实现与封装"></a>关于assert实现与封装</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> assert(cond) <span class="keyword">if</span> (!(cond)) panic(...);</span></span><br></pre></td></tr></table></figure>

<p>上面写法在一些特殊情况是有问题的</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (...) assert(xxx); <span class="comment">// 上面的assert对么？</span></span><br><span class="line"><span class="keyword">else</span> ...</span><br></pre></td></tr></table></figure>

<p>assert展开后下面的else会被宏里的if吸收，所以我们吸收后面的if是一个整体</p>
<p>nemu里采用了下面的写法</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> assert(cond) \</span></span><br><span class="line"><span class="meta">  do &#123; \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (!(cond)) &#123; \</span></span><br><span class="line"><span class="meta">      fprintf(stderr, <span class="string">&quot;Fail @ %s:%d&quot;</span>, __FILE__, __LINE__); \</span></span><br><span class="line"><span class="meta">      exit(1); \</span></span><br><span class="line"><span class="meta">    &#125; \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br></pre></td></tr></table></figure>

<p>GNU提供C语言扩展<code>(&#123; ... &#125;)</code>来吧这个语句当作整体,但这不是c标准</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> assert(cond) (&#123; ... &#125;)</span></span><br></pre></td></tr></table></figure>

<p>去看了一下glibc2.35的源码，依旧存在<code>#define assert(cond) if (!(cond)) panic(...);</code>的写法，但是基本上后面都没有else，但或许是个隐患</p>
<h2 id="info-r"><a href="#info-r" class="headerlink" title="info r"></a>info r</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_info</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(<span class="string">&quot;r&quot;</span>, args, <span class="number">1</span>)) &#123;</span><br><span class="line">    isa_reg_display();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">isa_reg_display</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%s:0x%x\t\033[0m &quot;</span>, regsl[i], cpu.gpr[i]._32);</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">3</span>) <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;33m\n%s:0x%x\n\033[0m&quot;</span>, <span class="string">&quot;pc&quot;</span>, cpu.pc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="si-N"><a href="#si-N" class="headerlink" title="si N"></a>si N</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_si</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">NULL</span> != args) &#123;</span><br><span class="line">    cpu_exec(strtoul(args, <span class="literal">NULL</span>, <span class="number">10</span>));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    cpu_exec(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="x-N-EXPR"><a href="#x-N-EXPR" class="headerlink" title="x N EXPR"></a>x N EXPR</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_x</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line">  <span class="type">int</span> times = atoi(strtok(<span class="literal">NULL</span>, <span class="string">&quot; &quot;</span>));</span><br><span class="line">  <span class="type">vaddr_t</span> address = (<span class="type">vaddr_t</span>)strtoul(strtok(<span class="literal">NULL</span>, <span class="string">&quot; &quot;</span>), <span class="literal">NULL</span>, <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; times; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == i % <span class="number">4</span>)</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34m%08x: \033[0m&quot;</span>, address);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0x%08x  &quot;</span>, vaddr_read(address, <span class="number">4</span>));</span><br><span class="line">    address += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == (i+<span class="number">1</span>) % <span class="number">4</span>)<span class="comment">//在地址输出前输出换行</span></span><br><span class="line">      <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(times%<span class="number">4</span>)</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="p-表示式求值"><a href="#p-表示式求值" class="headerlink" title="p 表示式求值"></a>p 表示式求值</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> Add more token types */</span></span><br><span class="line">    TK_NOTYPE = <span class="number">256</span>,</span><br><span class="line">    TK_EQ = <span class="number">1</span>,</span><br><span class="line">    TK_DEC = <span class="number">2</span>,</span><br><span class="line">    TK_ADD = <span class="number">3</span>,</span><br><span class="line">    TK_SUB = <span class="number">4</span>,</span><br><span class="line">    TK_MUL = <span class="number">5</span>,</span><br><span class="line">    TK_DIV = <span class="number">6</span>,</span><br><span class="line">    TK_BRAL = <span class="number">7</span>,</span><br><span class="line">    TK_BRAR = <span class="number">8</span>,</span><br><span class="line">    TK_DEREF = <span class="number">9</span>,</span><br><span class="line">    TK_HEX = <span class="number">10</span>,</span><br><span class="line">    TK_REG=<span class="number">11</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">rule</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> *regex;</span><br><span class="line">    <span class="type">int</span> token_type;</span><br><span class="line">&#125; rules[] = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> Add more rules.</span></span><br><span class="line"><span class="comment">     * Pay attention to the precedence level of different rules.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &#123;<span class="string">&quot;0[xX][0-9a-fA-F]+&quot;</span>, TK_HEX&#125;,<span class="comment">//这个要比十进制靠前，不然会被十进制把0x的0给匹配走</span></span><br><span class="line">    &#123;<span class="string">&quot;[0-9]+&quot;</span>, TK_DEC&#125;, &#123;<span class="string">&quot; +&quot;</span>, TK_NOTYPE&#125;,  <span class="comment">// spaces</span></span><br><span class="line">    &#123;<span class="string">&quot;\\+&quot;</span>, TK_ADD&#125;,  <span class="comment">// plus第一个/是为了转义c语言，第二个/是为了转义正则</span></span><br><span class="line">    &#123;<span class="string">&quot;-&quot;</span>, TK_SUB&#125;,      &#123;<span class="string">&quot;\\*&quot;</span>, TK_MUL&#125;,   &#123;<span class="string">&quot;/&quot;</span>, TK_DIV&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;\\(&quot;</span>, TK_BRAL&#125;,   &#123;<span class="string">&quot;\\)&quot;</span>, TK_BRAR&#125;,  &#123;<span class="string">&quot;==&quot;</span>, TK_EQ&#125;,  <span class="comment">// equal</span></span><br><span class="line">    &#123;<span class="string">&quot;\\$[a-z]+&quot;</span>, TK_REG&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* <span class="doctag">TODO:</span> Now a new token is recognized with rules[i]. Add codes</span></span><br><span class="line"><span class="comment">                 * to record the token in the array `tokens&#x27;. For certain types</span></span><br><span class="line"><span class="comment">                 * of tokens, some extra actions should be performed.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (rules[i].token_type) &#123;</span><br><span class="line">    <span class="keyword">case</span> TK_NOTYPE:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TK_EQ:</span><br><span class="line">    <span class="keyword">case</span> TK_DEC:</span><br><span class="line">    <span class="keyword">case</span> TK_ADD:</span><br><span class="line">    <span class="keyword">case</span> TK_SUB:</span><br><span class="line">    <span class="keyword">case</span> TK_MUL:</span><br><span class="line">    <span class="keyword">case</span> TK_DIV:</span><br><span class="line">    <span class="keyword">case</span> TK_BRAL:</span><br><span class="line">    <span class="keyword">case</span> TK_BRAR:</span><br><span class="line">    <span class="keyword">case</span> TK_HEX:</span><br><span class="line">    <span class="keyword">case</span> TK_REG:</span><br><span class="line">        tokens[nr_token].type = rules[i].token_type;</span><br><span class="line">        <span class="built_in">strncpy</span>(tokens[nr_token].str, substr_start, substr_len);</span><br><span class="line">        tokens[nr_token].str[substr_len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        nr_token++;</span><br><span class="line">        <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//检测是否被括号包围</span></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">check_parentheses</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">    <span class="type">int</span> bracket = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (tokens[start].type == TK_BRAL &amp;&amp; tokens[end].type == TK_BRAR) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = start; i &lt;= end; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tokens[i].type == TK_BRAL) &#123;</span><br><span class="line">                bracket++;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tokens[i].type == TK_BRAR) &#123;</span><br><span class="line">                bracket--;</span><br><span class="line">                <span class="keyword">if</span> (i != end &amp;&amp; <span class="number">0</span> == bracket) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == bracket) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//检测括号是否表达式</span></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">check_exp_is_valid</span><span class="params">(<span class="type">int</span> start,<span class="type">int</span> end)</span> &#123;</span><br><span class="line">    <span class="type">int</span> bracket = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = start; i &lt;= end; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tokens[i].type == TK_BRAL) &#123;</span><br><span class="line">            bracket++;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tokens[i].type == TK_BRAR) &#123;</span><br><span class="line">            bracket--;</span><br><span class="line">            <span class="keyword">if</span> (bracket &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//找出主运算符</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">principal_operator</span><span class="params">(<span class="type">int</span> start,<span class="type">int</span> end)</span> &#123;</span><br><span class="line">    <span class="type">int</span> bracket=<span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> operator= <span class="number">0</span>;</span><br><span class="line">    <span class="type">bool</span> is_add_or_sub=<span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=start; i&lt;=end; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tokens[i].type == TK_BRAL) &#123;</span><br><span class="line">            bracket++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(tokens[i].type==TK_BRAR)&#123;</span><br><span class="line">            bracket--;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span>==bracket) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tokens[i].type == TK_ADD || tokens[i].type == TK_SUB) &#123;</span><br><span class="line">                operator=i;</span><br><span class="line">                is_add_or_sub=<span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">false</span> == is_add_or_sub &amp;&amp;</span><br><span class="line">                       (tokens[i].type == TK_DIV || tokens[i].type == TK_MUL||tokens[i].type ==TK_DEREF||tokens[i].type==TK_REG)) &#123;<span class="comment">//应该把优先级最高的放后面</span></span><br><span class="line">                operator=i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> operator;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> answer_valid=<span class="literal">true</span>;</span><br><span class="line"><span class="comment">//递归求值</span></span><br><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">eval</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (start == end) &#123;</span><br><span class="line">        <span class="keyword">if</span>(tokens[start].type==TK_DEC)</span><br><span class="line">            <span class="keyword">return</span> atoi(tokens[start].str);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(tokens[start].type==TK_HEX)</span><br><span class="line">            <span class="keyword">return</span> strtol(tokens[start].str,<span class="literal">NULL</span>,<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tokens[start].type==TK_REG) &#123;</span><br><span class="line">           <span class="type">int</span> res= isa_reg_str2val(tokens[start].str,&amp;answer_valid);</span><br><span class="line">           <span class="keyword">if</span> (!answer_valid) &#123;</span><br><span class="line">               <span class="built_in">printf</span>(<span class="string">&quot;reg exp error&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">true</span> == check_parentheses(start, end)) &#123;</span><br><span class="line">        <span class="keyword">return</span> eval(start+<span class="number">1</span>,end<span class="number">-1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (check_exp_is_valid(start,end)==<span class="literal">false</span>) &#123;<span class="comment">//check_parentheses返回false有两种情况，一种是没有被括号包围但表表达式正确，另一种是表达式就不对</span></span><br><span class="line">            answer_valid=<span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">//这里不会有太多无意义的性能消耗，第一次就会被检测出来</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> operator=principal_operator(start, end);</span><br><span class="line">        <span class="keyword">if</span> (tokens[operator].type==TK_DEREF) &#123;</span><br><span class="line">            <span class="keyword">return</span> vaddr_read(strtoul(tokens[operator+<span class="number">1</span>].str,<span class="literal">NULL</span>,<span class="number">16</span>),<span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">int32_t</span> sum1=eval(start,operator<span class="number">-1</span>);</span><br><span class="line">        <span class="type">int32_t</span> sum2=eval(operator+<span class="number">1</span>,end);</span><br><span class="line">        <span class="keyword">switch</span> (tokens[operator].type) &#123;</span><br><span class="line">            <span class="keyword">case</span> TK_ADD:</span><br><span class="line">                <span class="keyword">return</span> sum1 + sum2;</span><br><span class="line">            <span class="keyword">case</span> TK_SUB:</span><br><span class="line">                <span class="keyword">return</span> sum1 - sum2;</span><br><span class="line">            <span class="keyword">case</span> TK_MUL:</span><br><span class="line">                <span class="keyword">return</span> sum1 * sum2;</span><br><span class="line">            <span class="keyword">case</span> TK_DIV:</span><br><span class="line">                <span class="keyword">return</span> sum1 / sum2;</span><br><span class="line">          &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int32_t</span> <span class="title function_">expr</span><span class="params">(<span class="type">char</span> *e, <span class="type">bool</span> *success)</span> &#123;</span><br><span class="line">    answer_valid=<span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (!make_token(e)) &#123;</span><br><span class="line">        *success = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;=nr_token<span class="number">-1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tokens[i].type == TK_MUL &amp;&amp;</span><br><span class="line">            (i == <span class="number">0</span> ||</span><br><span class="line">             (tokens[i - <span class="number">1</span>].type != TK_DEC || tokens[i - <span class="number">1</span>].type != TK_BRAL ||</span><br><span class="line">              tokens[i - <span class="number">1</span>].type != TK_HEX))) &#123;</span><br><span class="line">                tokens[i].type =TK_DEREF;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> Insert codes to evaluate the expression. */</span></span><br><span class="line">    <span class="type">int32_t</span> answer=eval(<span class="number">0</span>,nr_token<span class="number">-1</span>);</span><br><span class="line">    *success=answer_valid;</span><br><span class="line">    <span class="keyword">return</span> answer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_p</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line">    <span class="type">bool</span> flag=<span class="literal">true</span>;</span><br><span class="line">    <span class="type">int32_t</span> answer = expr(args, &amp;flag);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span>==flag) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Error expression&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s: %d 0x%x\n&quot;</span>,args,answer,answer);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="监视点"><a href="#监视点" class="headerlink" title="监视点"></a>监视点</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">watchpoint</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> NO;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">watchpoint</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* <span class="doctag">TODO:</span> Add more members if necessary */</span></span><br><span class="line">  <span class="type">sword_t</span> value;</span><br><span class="line">  <span class="type">char</span> expr[<span class="number">32</span>];</span><br><span class="line">&#125; WP;</span><br><span class="line">WP* <span class="title function_">new_wp</span><span class="params">(<span class="type">int32_t</span> value,<span class="type">char</span> *expr)</span>; </span><br><span class="line"><span class="type">void</span> <span class="title function_">free_wp</span><span class="params">(WP *wp)</span>;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">check_wp</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">dispaly_wp</span><span class="params">()</span>;</span><br><span class="line">WP* <span class="title function_">get_wp</span><span class="params">(<span class="type">char</span>* s)</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">init_wp_pool</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NR_WP; i ++) &#123;</span><br><span class="line">    wp_pool[i].NO = i;</span><br><span class="line">    wp_pool[i].next = &amp;wp_pool[i + <span class="number">1</span>];</span><br><span class="line">    <span class="built_in">memset</span>(wp_pool[i].expr, <span class="number">0</span>, <span class="number">32</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  wp_pool[NR_WP - <span class="number">1</span>].next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  head = <span class="literal">NULL</span>;</span><br><span class="line">  free_ = wp_pool;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* <span class="doctag">TODO:</span> Implement the functionality of watchpoint */</span></span><br><span class="line">WP* <span class="title function_">new_wp</span><span class="params">(<span class="type">int32_t</span> value,<span class="type">char</span> *expr)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span>==free_) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Dont hava free watch pointer&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    WP* temp = free_;</span><br><span class="line">    free_=free_-&gt;next;</span><br><span class="line">    temp-&gt;next = head;</span><br><span class="line">    head = temp;</span><br><span class="line">    head-&gt;value=value;</span><br><span class="line">    <span class="built_in">memcpy</span>(head-&gt;expr,expr,<span class="built_in">strlen</span>(expr));</span><br><span class="line">    <span class="keyword">return</span> head;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">free_wp</span><span class="params">(WP* wp)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!wp) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;dont have this watch pointer&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (wp==head) &#123;</span><br><span class="line">        head =head-&gt;next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      WP *temp=head;</span><br><span class="line">     <span class="keyword">while</span> (temp !=<span class="literal">NULL</span> &amp;&amp;temp-&gt;next!=wp) &#123;</span><br><span class="line">      temp=temp-&gt;next;</span><br><span class="line">     &#125;</span><br><span class="line">     temp-&gt;next=temp-&gt;next-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    wp-&gt;next=free_;</span><br><span class="line">    free_=wp;</span><br><span class="line">    wp-&gt;value = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(wp-&gt;expr, <span class="number">0</span>, <span class="number">32</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">check_wp</span><span class="params">()</span> &#123;</span><br><span class="line">    WP* temp=head;</span><br><span class="line">    <span class="type">bool</span> equal=<span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">while</span> (temp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="type">word_t</span> new_value=expr(temp-&gt;expr,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span>(new_value!=temp-&gt;value) &#123; </span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;Num:%d  Expr:%s  at:%x\n&quot;</span>,temp-&gt;NO,temp-&gt;expr,temp-&gt;value);</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;old value = 0x%x\nnew value = 0x%x\n&quot;</span>,temp-&gt;value,new_value);</span><br><span class="line">          equal = <span class="literal">false</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125; </span><br><span class="line">        temp=temp-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> equal;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">dispaly_wp</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span>==head) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;No watchpoints.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    WP* temp = head;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Num\tWhat\t&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (temp!=<span class="literal">NULL</span>) &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;%d\t0x%x\t\n&quot;</span>,temp-&gt;NO,temp-&gt;value);</span><br><span class="line">          temp=temp-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">WP* <span class="title function_">get_wp</span><span class="params">(<span class="type">char</span>* s)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (wp_pool + atoi(s));  <span class="comment">// wp_pool为WP*类型，所以他+n=(char *)wp_pool+sizeof(WP)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_w</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">    <span class="type">bool</span> flag;</span><br><span class="line">    WP* temp= new_wp(expr(args,&amp;flag),args);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span> == flag) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Error expression in watch&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;watch pointer at 0x%x\n&quot;</span>, temp-&gt;value);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;NOT ON DEBUG PATTERN&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cpu-exec.c</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">    asm_print(this_pc, seq_pc - this_pc, n &lt; MAX_INSTR_TO_PRINT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> check watchpoints here. */</span></span><br><span class="line">    <span class="keyword">if</span> (check_wp()) &#123;</span><br><span class="line">     nemu_state.state=NEMU_STOP; </span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h3 id="info-w"><a href="#info-w" class="headerlink" title="info w"></a>info w</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_info</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(<span class="string">&quot;r&quot;</span>, args, <span class="number">1</span>)) &#123;</span><br><span class="line">    isa_reg_display();</span><br><span class="line">  &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(<span class="string">&quot;w&quot;</span>, args, <span class="number">1</span>)) &#123;</span><br><span class="line">    dispaly_wp();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="d-NUM"><a href="#d-NUM" class="headerlink" title="d NUM"></a>d NUM</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_d</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line">  WP * temp=get_wp(args);</span><br><span class="line">  free_wp(temp);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调试器所有command"><a href="#调试器所有command" class="headerlink" title="调试器所有command"></a>调试器所有command</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="type">char</span> *name;</span><br><span class="line">  <span class="type">char</span> *description;</span><br><span class="line">  <span class="type">int</span> (*handler)(<span class="type">char</span> *);</span><br><span class="line">&#125; cmd_table[] = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;help&quot;</span>, <span class="string">&quot;Display informations about all supported commands&quot;</span>, cmd_help&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;c&quot;</span>, <span class="string">&quot;Continue the execution of the program&quot;</span>, cmd_c&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;q&quot;</span>, <span class="string">&quot;Exit NEMU&quot;</span>, cmd_q&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;si&quot;</span>, <span class="string">&quot;Single Instruction&quot;</span>, cmd_si&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;info&quot;</span>, <span class="string">&quot;info reg or watch&quot;</span>, cmd_info&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;x&quot;</span>, <span class="string">&quot;show memcory info&quot;</span>, cmd_x&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;p&quot;</span>, <span class="string">&quot;pppp&quot;</span>, cmd_p&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;watch&quot;</span>, <span class="string">&quot;watch a point&quot;</span>, cmd_w&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;d&quot;</span>,<span class="string">&quot;delete a watch pointer&quot;</span>,cmd_d&#125;</span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> Add more commands */</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NEMU-PA1"><span class="toc-number">1.</span> <span class="toc-text">NEMU PA1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.1.</span> <span class="toc-text">寄存器结构体</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Eassert%E5%AE%9E%E7%8E%B0%E4%B8%8E%E5%B0%81%E8%A3%85"><span class="toc-number">1.2.</span> <span class="toc-text">关于assert实现与封装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#info-r"><span class="toc-number">1.3.</span> <span class="toc-text">info r</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#si-N"><span class="toc-number">1.4.</span> <span class="toc-text">si N</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#x-N-EXPR"><span class="toc-number">1.5.</span> <span class="toc-text">x N EXPR</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#p-%E8%A1%A8%E7%A4%BA%E5%BC%8F%E6%B1%82%E5%80%BC"><span class="toc-number">1.6.</span> <span class="toc-text">p 表示式求值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E8%A7%86%E7%82%B9"><span class="toc-number">1.7.</span> <span class="toc-text">监视点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#info-w"><span class="toc-number">1.7.1.</span> <span class="toc-text">info w</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#d-NUM"><span class="toc-number">1.7.2.</span> <span class="toc-text">d NUM</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%99%A8%E6%89%80%E6%9C%89command"><span class="toc-number">1.8.</span> <span class="toc-text">调试器所有command</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/&text=x86 NEMU PA1"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/&title=x86 NEMU PA1"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/&is_video=false&description=x86 NEMU PA1"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=x86 NEMU PA1&body=Check out this article: https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/&title=x86 NEMU PA1"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/&title=x86 NEMU PA1"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/&title=x86 NEMU PA1"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/&title=x86 NEMU PA1"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/&name=x86 NEMU PA1&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/05/13/x86-nemu-pa1/&t=x86 NEMU PA1"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023
    bxz
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?a22ef0bec4e4a9c7337bea6e37ff55c1";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
