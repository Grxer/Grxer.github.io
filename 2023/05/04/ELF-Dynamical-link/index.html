<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="baidu-site-verification" content="codeva-ROfYcqLkCh" />
    <meta name="msvalidate.01" content="ECA3E06A0E52A2AC90C4B06F12981FB2" />
    <meta name="description" content="ELF Dynamical link对于静态链接的缺点  对于一些可以共用的库，每个程序在磁盘上都有一份代码副本，加载到内存也是这样，造成了空间的浪费  静态链接的程序更新起来麻烦，需要重新编译并发送给用户   动态链接思路:把程序分为不同的模块，不再是在编译时进行链接，在程序运行时再链接，这个工作由动态链接器来完成  这里说的不在编译时做链接，其实还是有一个整合的过程的，比如说我们在主程序里调用">
<meta property="og:type" content="article">
<meta property="og:title" content="ELF动态链接(ELF Dynamical link)">
<meta property="og:url" content="https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/index.html">
<meta property="og:site_name" content="Grxer&#39;s Blog">
<meta property="og:description" content="ELF Dynamical link对于静态链接的缺点  对于一些可以共用的库，每个程序在磁盘上都有一份代码副本，加载到内存也是这样，造成了空间的浪费  静态链接的程序更新起来麻烦，需要重新编译并发送给用户   动态链接思路:把程序分为不同的模块，不再是在编译时进行链接，在程序运行时再链接，这个工作由动态链接器来完成  这里说的不在编译时做链接，其实还是有一个整合的过程的，比如说我们在主程序里调用">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/image-20230506083401085.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/image-20230506013722990.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/image-20230506014213830.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/image-20230506014305987.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/image-20230506014448462.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/image-20230506015302033.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/image-20230506015707950.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/image-20230506015613569.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/image-20230506091935404.png">
<meta property="article:published_time" content="2023-05-04T06:50:44.000Z">
<meta property="article:modified_time" content="2023-07-07T13:30:52.030Z">
<meta property="article:author" content="bxz">
<meta property="article:tag" content="ELF">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/image-20230506083401085.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>ELF动态链接(ELF Dynamical link)</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 lrt">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/05/05/%E8%B0%83%E7%94%A8%E6%AC%BA%E9%AA%97%E6%8B%BE%E9%81%97/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/04/30/VIM/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/&text=ELF动态链接(ELF Dynamical link)"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/&title=ELF动态链接(ELF Dynamical link)"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/&is_video=false&description=ELF动态链接(ELF Dynamical link)"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ELF动态链接(ELF Dynamical link)&body=Check out this article: https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/&title=ELF动态链接(ELF Dynamical link)"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/&title=ELF动态链接(ELF Dynamical link)"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/&title=ELF动态链接(ELF Dynamical link)"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/&title=ELF动态链接(ELF Dynamical link)"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/&name=ELF动态链接(ELF Dynamical link)&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/&t=ELF动态链接(ELF Dynamical link)"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ELF-Dynamical-link"><span class="toc-number">1.</span> <span class="toc-text">ELF Dynamical link</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5"><span class="toc-number">1.1.</span> <span class="toc-text">动态链接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E6%97%A0%E5%85%B3"><span class="toc-number">1.2.</span> <span class="toc-text">地址无关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#share"><span class="toc-number">1.2.1.</span> <span class="toc-text">-share</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fPIC"><span class="toc-number">1.2.2.</span> <span class="toc-text">-fPIC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-gt-%E6%A8%A1%E5%9D%97%E5%86%85%E7%9A%84%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%E5%92%8C%E8%B7%B3%E8%BD%AC"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">&gt;&gt;&gt; 模块内的过程调用和跳转</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-gt-%E6%A8%A1%E5%9D%97%E5%86%85%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">&gt;&gt;&gt;模块内数据访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-gt-%E6%A8%A1%E5%9D%97%E9%97%B4%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">&gt;&gt;&gt;模块间数据访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-gt-%E6%A8%A1%E5%9D%97%E9%97%B4%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%E5%92%8C%E8%B7%B3%E8%BD%AC"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">&gt;&gt;&gt;模块间过程调用和跳转</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dynamic"><span class="toc-number">1.2.3.</span> <span class="toc-text">.dynamic</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%99%A8"><span class="toc-number">1.3.</span> <span class="toc-text">动态链接器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#interp"><span class="toc-number">1.3.1.</span> <span class="toc-text">.interp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E7%AC%A6%E5%8F%B7%E8%A1%A8-dynsym"><span class="toc-number">1.3.2.</span> <span class="toc-text">动态符号表 .dynsym</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E7%9A%84%E8%BF%90%E8%A1%8C%E6%97%B6%E9%93%BE%E6%8E%A5"><span class="toc-number">1.4.</span> <span class="toc-text">显示的运行时链接</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        ELF动态链接(ELF Dynamical link)
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">bxz</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-05-04T06:50:44.000Z" itemprop="datePublished">2023-05-04</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/ELF/" rel="tag">ELF</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="ELF-Dynamical-link"><a href="#ELF-Dynamical-link" class="headerlink" title="ELF Dynamical link"></a>ELF Dynamical link</h1><p>对于静态链接的缺点</p>
<ul>
<li><p>对于一些可以共用的库，每个程序在磁盘上都有一份代码副本，加载到内存也是这样，造成了空间的浪费</p>
</li>
<li><p>静态链接的程序更新起来麻烦，需要重新编译并发送给用户</p>
</li>
</ul>
<h2 id="动态链接"><a href="#动态链接" class="headerlink" title="动态链接"></a>动态链接</h2><p>思路:把程序分为不同的模块，不再是在编译时进行链接，在程序运行时再链接，这个工作由动态链接器来完成</p>
<blockquote>
<p>这里说的不在编译时做链接，其实还是有一个整合的过程的，比如说我们在主程序里调用了printf，如果按照静态编译的话就是把静态库libc.a里的printf.o模块和主程序模块合并，并做重定位工作，动态链接的话其实也会把printf符号信息从动态库里放到主程序模块，但是不做重定位，重定位是留到运行时去做，可以理解为动态链接库给了主程序一个借条，运行时找动态链接库去要，hh</p>
</blockquote>
<p>一些共用的模块逐渐就形成了动态链接库.so</p>
<p>so，程序&#x3D;主模块+动态链接库</p>
<p>我们把动态链接库映射到内存一次，其他程序再加载时需要用到动态链接库，就不用再从磁盘加载一份了，直接建个页目录映射到这一块内存</p>
<h2 id="地址无关"><a href="#地址无关" class="headerlink" title="地址无关"></a>地址无关</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">gcc -fPIC -share -o xx.so x.c 可以生成动态链接库</span><br></pre></td></tr></table></figure>

<h3 id="share"><a href="#share" class="headerlink" title="-share"></a>-share</h3><p>-share时指示生成动态链接库</p>
<p>动态链接要去把不同的共享模块做映射，映射到的虚拟地址空间是随机的这个要求我们共享模块是地址无关的，就是不管映射到哪里都可以执行</p>
<blockquote>
<p>这让我想起，之前说开了pie保护的程序的elf heade里的e_type为什么是ET_DYN共享目标文件，而不是ET_EXEC可执行文件的原因</p>
<p><a target="_blank" rel="noopener" href="https://grxer.github.io/2023/03/19/23-2-21-elf/">https://grxer.github.io/2023/03/19/23-2-21-elf/</a></p>
<p>因为开了pie地址我们程序映射的虚拟地址要随机化，就要求我们的可执行程序也是地址无关的，合情合理</p>
</blockquote>
<p>地址无关，一种方法是借鉴我们静态链接时方法，就是把链接搬到了运行时模块地址确定后，遍历重定位表去给绝对引用做重定位，因为要去修改指令所以没有办法做到多进程共享代码，这也是只加-share不加-fpic 时使用的重定位方法</p>
<h3 id="fPIC"><a href="#fPIC" class="headerlink" title="-fPIC"></a>-fPIC</h3><p>-fPIC指示生成位置无关代码(Postive Independent Code, PIC)</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> a;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> b;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">ext</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">bar</span><span class="params">()</span>&#123;</span><br><span class="line">    a=<span class="number">1</span>;</span><br><span class="line">    b=<span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">foo</span><span class="params">()</span>&#123;</span><br><span class="line">    bar();</span><br><span class="line">    ext();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; gcc -m32 -fPIC -shared -o xxx.so test.c</span><br><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; file xxx.so</span><br><span class="line">xxx.so: ELF 32-bit LSB shared object, Intel 80386, version 1 (SYSV), dynamically linked, BuildID[sha1]=9a4e584b71c83ff881f77f68b5483d63929ca339, not stripped</span><br><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; checksec xxx.so</span><br><span class="line">[*] &#x27;/mnt/hgfs/share/link-load-library-code/chapter7/xxx.so&#x27;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<h4 id="gt-gt-gt-模块内的过程调用和跳转"><a href="#gt-gt-gt-模块内的过程调用和跳转" class="headerlink" title="&gt;&gt;&gt; 模块内的过程调用和跳转"></a><strong>&gt;&gt;&gt; 模块内的过程调用和跳转</strong></h4><p>foo里调用bar()</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">000003f0 &lt;bar@plt&gt;:</span><br><span class="line">3f0:   ff a3 0c 00 00 00       jmp    *0xc(%ebx)</span><br><span class="line">3f6:   68 00 00 00 00          push   $0x0</span><br><span class="line">3fb:   e9 e0 ff ff ff          jmp    3e0 &lt;_init+0x30&gt;</span><br><span class="line">00000576 &lt;foo&gt;:</span><br><span class="line">588:   e8 63 fe ff ff          call   3f0 &lt;bar@plt&gt;</span><br><span class="line">58d:   e8 6e fe ff ff          call   400 &lt;ext@plt&gt;</span><br><span class="line">592:   90                      nop</span><br></pre></td></tr></table></figure>

<p>模块内指令与指令之间的距离不变，直接按不变的相对地址来寻址就可以地址无关， 0x58d-0x19d(fffffe63)&#x3D;0x3f0，这里直接用了plt表，先把他理解为就是那个函数地址吧，plt表后面再说</p>
<blockquote>
<p>模块内原本可以不采用plt表和got表，直接利用偏移就可以做到地址无关，采用plt和got表是为了防止多个模块中全局符号(模块内的函数，全局变量等)出现重复定义的情况</p>
<p>在动态链接过程中是按最先在某个模块里发现的符号来的，万一是原本对本模块里的符号引用被其他模块里的符号绑定到了，那就是模块间的关系，只能利用got表来做PIC</p>
</blockquote>
<h4 id="gt-gt-gt-模块内数据访问"><a href="#gt-gt-gt-模块内数据访问" class="headerlink" title="&gt;&gt;&gt;模块内数据访问"></a><strong>&gt;&gt;&gt;模块内数据访问</strong></h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">bar</span><span class="params">()</span>&#123;</span><br><span class="line"> <span class="number">550</span>:   <span class="number">55</span>                      push   %ebp</span><br><span class="line"> <span class="number">551</span>:   <span class="number">89</span> e5                   mov    %esp,%ebp</span><br><span class="line"> <span class="number">553</span>:   e8 <span class="number">41</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          call   <span class="number">599</span> &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class="line"> <span class="number">558</span>:   <span class="number">05</span> a8 <span class="number">1</span>a <span class="number">00</span> <span class="number">00</span>          add    $<span class="number">0x1aa8</span>,%eax</span><br><span class="line">   a=<span class="number">1</span>;</span><br><span class="line"> <span class="number">55</span>d:   c7 <span class="number">80</span> <span class="number">1</span>c <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span>    movl   $<span class="number">0x1</span>,<span class="number">0x1c</span>(%eax)</span><br><span class="line"> <span class="number">564</span>:   <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>

<p>指令段和数据段之间的距离是固定的，知道指令地址就可以找到模块内数据</p>
<p>指令地址使用这个<code> 553:   e8 41 00 00 00      call   599 &lt;__x86.get_pc_thunk.ax&gt;</code>来获取的，这也是一个一个模块内调用的例子，0x558+0x41&#x3D;0x599</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000599</span> &lt;__x86.get_pc_thunk.ax&gt;:</span><br><span class="line"> <span class="number">599</span>:   <span class="number">8b</span> <span class="number">04</span> <span class="number">24</span>                mov    (%esp),%eax</span><br><span class="line"> <span class="number">59</span>c:   c3                      ret</span><br></pre></td></tr></table></figure>

<p>call会把下一条指令地址压栈，就是0x558，然后把0x558赋值给eax，指令地址就保存到了eax</p>
<p><code>add    $0x1aa8,%eax</code>，然后eax&#x3D;0x1aa8+0x558&#x3D;0x2000</p>
<p><code> 55d:   c7 80 1c 00 00 00 01    movl   $0x1,0x1c(%eax)</code></p>
<p>0x2000再加上0x1c 0x201c是什么呢?</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">readelf -S  xxx.so</span><br><span class="line">There are <span class="number">33</span> section headers, starting at offset <span class="number">0x1964</span>:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">[Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">[<span class="number">23</span>] .bss              NOBITS          <span class="number">00002018</span> <span class="number">001018</span> <span class="number">000008</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -s  xxx.so</span><br><span class="line">Symbol table <span class="string">&#x27;.symtab&#x27;</span> contains <span class="number">67</span> entries:</span><br><span class="line">Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line"><span class="number">40</span>: <span class="number">0000201</span>c     <span class="number">4</span> OBJECT  LOCAL  DEFAULT   <span class="number">23</span> a</span><br></pre></td></tr></table></figure>

<p>正好是在未初始化的全局变量和局部静态变量的.bss段的a，也符合我们在静态链接时的分析</p>
<h4 id="gt-gt-gt-模块间数据访问"><a href="#gt-gt-gt-模块间数据访问" class="headerlink" title="&gt;&gt;&gt;模块间数据访问"></a><strong>&gt;&gt;&gt;模块间数据访问</strong></h4><p><strong>敲黑板了</strong>，模块间才是重点，这个时候相对地址已经不存在了，而是在数据段的开始处设立了一个叫做全局偏移量表(Global Offset Table, GOT)的指针数组(pwn手最爱哈哈)</p>
<p>汇编器为GOT中的每一个项生成一个重定位项，类似于我们静态链接的数据段的重定位表.rel.data,动态链接里叫做.rel.dyn用来修正数据引用，两种表数据结构一样</p>
<p>动态链接器在把引用数据所在模块的加载地址确定后，把正确地址写入他的got，就完成了重定位，同时由于这个数据段是进程私有的，也就实现了内存里的代码段可以多个进程共享</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -S  xxx.so</span><br><span class="line">There are 33 section headers, starting at offset 0x1964:</span><br><span class="line">Section Headers:</span><br><span class="line">[Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">[20] .got              PROGBITS        00001fe8 000fe8 000018 04  WA  0   0  4</span><br><span class="line"></span><br><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -r  xxx.so</span><br><span class="line">Relocation section &#x27;.rel.dyn&#x27; at offset 0x358 contains 9 entries:</span><br><span class="line">Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">00001fec  00000206 R_386_GLOB_DAT    00000000   b</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">void bar()&#123;</span><br><span class="line"> 550:   55                      push   %ebp</span><br><span class="line"> 551:   89 e5                   mov    %esp,%ebp</span><br><span class="line"> 553:   e8 41 00 00 00          call   599 &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class="line"> 558:   05 a8 1a 00 00          add    $0x1aa8,%eax</span><br><span class="line">    a=1;</span><br><span class="line"> 55d:   c7 80 1c 00 00 00 01    movl   $0x1,0x1c(%eax)</span><br><span class="line"> 564:   00 00 00</span><br><span class="line">    b=2;</span><br><span class="line"> 567:   8b 80 ec ff ff ff       mov    -0x14(%eax),%eax</span><br><span class="line"> 56d:   c7 00 02 00 00 00       movl   $0x2,(%eax)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样是利用固定偏移找到got表，eax在前面已经算过是0x2000，再-0x14正好是0x1FEC 正好对应b的got表的位置，往它里面的指针写入值就行了</p>
<blockquote>
<p>关于获取pc值，我在资料上还看到一种直接call下一条指令的方式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">000357:e8 00 00 00 00    call 00035c</span><br><span class="line">00035c:5b                 popl %ebx</span><br></pre></td></tr></table></figure>

<p>比call getpc的函数少了ret，速度和空间都有提升</p>
<p>64位程序都是采用rip直接加偏移,32位程序不知道为什么不直接用eip寄存器里的值加偏移</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0000000000001139 &lt;bar&gt;:</span><br><span class="line">    1139:       f3 0f 1e fa             endbr64</span><br><span class="line">    113d:       55                      push   %rbp</span><br><span class="line">    113e:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">    1141:       c7 05 e9 2e 00 00 01    movl   $0x1,0x2ee9(%rip)        # 4034 &lt;a&gt;</span><br><span class="line">    1148:       00 00 00</span><br><span class="line">    114b:       48 8b 05 86 2e 00 00    mov    0x2e86(%rip),%rax        # 3fd8 &lt;b&gt;</span><br><span class="line">    1152:       c7 00 02 00 00 00       movl   $0x2,(%rax)</span><br><span class="line">    1158:       90                      nop</span><br><span class="line">    1159:       5d                      pop    %rbp</span><br><span class="line">    115a:       c3                      ret</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="gt-gt-gt-模块间过程调用和跳转"><a href="#gt-gt-gt-模块间过程调用和跳转" class="headerlink" title="&gt;&gt;&gt;模块间过程调用和跳转"></a><strong>&gt;&gt;&gt;模块间过程调用和跳转</strong></h4><p>对于模块间的调用等，也可以往got表里写入函数地址，就像上面一样，ELF把got分为了.got和.got.plt。 其中.got用来保存全局变量引用的地址，.got.plt用来保存函数引用的地址</p>
<p>类似于我们静态链接的代码段的重定位表.rel.text，动态链接里.rel.plt对函数引用的修正，两种表数据结构一样</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">[21] .got.plt          PROGBITS        00002000 001000 000014 04  WA  0   0  4</span><br><span class="line">Relocation section &#x27;.rel.plt&#x27; at offset 0x3c0 contains 2 entries:</span><br><span class="line">Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">00002010  00000507 R_386_JUMP_SLOT   00000000   ext</span><br></pre></td></tr></table></figure>

<p>但是在实现的过程中每次程序启动时动态链接器都要对got表做修正，但是被修正的大量函数我们程序使用的只是一小部分，就出现了延迟绑定(lazy binding)的方法，在程序用到时在进行动态链接修正got，是借助过程链接表(Procedure Linkage Table, PLT）[代码段]和got[数据段]配合来实现的</p>
<p>got.plt前三项是特殊值</p>
<ul>
<li>第一项是.dynamic段的装载地址</li>
<li>第二项是动态链接的标识信息 link_map的地址</li>
<li>第三项是动态链接器的做动态链接的函数入口 _dl_runtime_resolve</li>
</ul>
<h3 id="dynamic"><a href="#dynamic" class="headerlink" title=".dynamic"></a>.dynamic</h3><blockquote>
<p>.dynamic段保存了动态链接器所需要的基本信息</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Dynamic section entry.  */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Sword    d_tag;			<span class="comment">/* Dynamic entry type */</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      Elf32_Word d_val;            <span class="comment">/* Integer value */</span></span><br><span class="line">      Elf32_Addr d_ptr;            <span class="comment">/* Address value */</span></span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506083401085.png" alt="image-20230506083401085"></p>
<p>地址是在文件里的偏移</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -d  xxx.so</span><br><span class="line"></span><br><span class="line">Dynamic section at offset 0xf04 contains 24 entries:</span><br><span class="line">  Tag        Type                         Name/Value</span><br><span class="line"> 0x00000001 (NEEDED)                     Shared library: [libc.so.6]</span><br><span class="line"> 0x0000000c (INIT)                       0x3d0</span><br><span class="line"> 0x0000000d (FINI)                       0x5cc</span><br><span class="line"> 0x00000019 (INIT_ARRAY)                 0x1ef8</span><br><span class="line"> 0x0000001b (INIT_ARRAYSZ)               4 (bytes)</span><br><span class="line"> 0x0000001a (FINI_ARRAY)                 0x1efc</span><br><span class="line"> 0x0000001c (FINI_ARRAYSZ)               4 (bytes)</span><br><span class="line"> 0x6ffffef5 (GNU_HASH)                   0x138</span><br><span class="line"> 0x00000005 (STRTAB)                     0x27c</span><br><span class="line"> 0x00000006 (SYMTAB)                     0x17c</span><br><span class="line"> 0x0000000a (STRSZ)                      179 (bytes)</span><br><span class="line"> 0x0000000b (SYMENT)                     16 (bytes)</span><br><span class="line"> 0x00000003 (PLTGOT)                     0x2000</span><br><span class="line"> 0x00000002 (PLTRELSZ)                   16 (bytes)</span><br><span class="line"> 0x00000014 (PLTREL)                     REL</span><br><span class="line"> 0x00000017 (JMPREL)                     0x3c0</span><br><span class="line"> 0x00000011 (REL)                        0x370</span><br><span class="line"> 0x00000012 (RELSZ)                      80 (bytes)</span><br><span class="line"> 0x00000013 (RELENT)                     8 (bytes)</span><br><span class="line"> 0x6ffffffe (VERNEED)                    0x350</span><br><span class="line"> 0x6fffffff (VERNEEDNUM)                 1</span><br><span class="line"> 0x6ffffff0 (VERSYM)                     0x330</span><br><span class="line"> 0x6ffffffa (RELCOUNT)                   3</span><br><span class="line"> 0x00000000 (NULL)                       0x0</span><br></pre></td></tr></table></figure>
</blockquote>
<p>每个模块外的函数都有一个.rel.plt表项，每个表项大小都是16字节，前两项特殊</p>
<ul>
<li>第一项<ul>
<li>pushq *GOT[1];jmpq *GOT[2]</li>
<li>因为每一个函数延迟绑定时都需要执行上面这两条指令，为了减少重复代码就把他们放到了固定位置，供调用</li>
</ul>
</li>
<li>第二项是系统启动函数__libc_start_main来初始化环境</li>
</ul>
<p>剩下的都是jmp *got[id]; push id;jump plt[0];的16字节指令</p>
<p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506013722990.png" alt="image-20230506013722990"></p>
<ol>
<li>第一次调用函数是进入函数所在plt表条目	</li>
<li>第一条plt指令跳到对应got表存储地址，由于刚开始每个GOT条目都指向对应PLT条目的第二条指令，故回到plt条目中</li>
<li>将函数id压入栈，跳到plt[0]条目</li>
<li>plt[0]把got[1]压入栈通过gotp[2]调用动态链接器，动态链接器确定函数真实地址并填入got条目</li>
<li>再次回到该函数调用这次及以后可以直接通过plt表找到函数真实地址</li>
</ol>
<p>看个实际例子，害，还是经典的hello world，看printf是如何lazy binding的</p>
<p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506014213830.png" alt="image-20230506014213830"></p>
<p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506014305987.png" alt="image-20230506014305987"></p>
<p>jmp到printf got表项里的值</p>
<p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506014448462.png" alt="image-20230506014448462"></p>
<p>没有做重定位时默认就是下一条指令，把函数id压栈</p>
<p>jmp到0x4003f0执行</p>
<p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506015302033.png" alt="image-20230506015302033"></p>
<p>随后jmp到0x601010里存的动态链接的函数入口_dl_runtime_resolve_xsavec</p>
<p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506015707950.png" alt="image-20230506015707950"></p>
<p>跳到printf的同时往got里写入真实地址</p>
<p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506015613569.png" alt="image-20230506015613569"></p>
<p>下次就可以直接跳过去了</p>
<h2 id="动态链接器"><a href="#动态链接器" class="headerlink" title="动态链接器"></a>动态链接器</h2><h3 id="interp"><a href="#interp" class="headerlink" title=".interp"></a>.interp</h3><p>interp段规定了可执行程序的动态链接器</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -p .interp  a.out</span><br><span class="line">String dump of section &#x27;.interp&#x27;:</span><br><span class="line">  [     0]  /lib/ld-linux.so.2</span><br></pre></td></tr></table></figure>

<p>&#x2F;lib&#x2F;ld-linux.so.2是一个符号链接，这样我们更新动态库的时候只需要把符号链接链接到新库上，而不用更改程序本体</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; ll  /lib/ld-linux.so<span class="number">.2</span></span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">25</span> Apr <span class="number">22</span>  <span class="number">2021</span> /lib/ld-linux.so<span class="number">.2</span> -&gt; i386-linux-gnu/ld<span class="number">-2.23</span>.so*</span><br></pre></td></tr></table></figure>

<p>动态链接器也是一个特殊共享文件，而且他是可执行的</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; file /lib/i386-linux-gnu/ld<span class="number">-2.23</span>.so*</span><br><span class="line">/lib/i386-linux-gnu/ld<span class="number">-2.23</span>.so: ELF <span class="number">32</span>-bit LSB shared object, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), dynamically linked, BuildID[sha1]=<span class="number">2b</span>ea6d29e841fecacc546b9b5ab802bd061e8b29, stripped</span><br></pre></td></tr></table></figure>

<p>他是动态链接的,但是他不能依赖如何库(所以在ldd进行分析的时候，会把他分析为静态链接)，在重定位之前不能调用任何放在got里的任何东西，挺夸张的，毕竟自己定义的函数也会被放到got里</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; ldd /lib/i386-linux-gnu/ld<span class="number">-2.23</span>.so*</span><br><span class="line">        statically linked</span><br></pre></td></tr></table></figure>

<blockquote>
<p>关于ldd</p>
<p>ldd其实是一段shell脚本</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/D/s/i/nemu (pa1)&gt; file /usr/bin/ldd</span><br><span class="line">/usr/bin/ldd: Bourne-Again shell script, ASCII text executable</span><br></pre></td></tr></table></figure>

<p>他会尝试从下面几个ld去解析文件</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">RTLDLIST=<span class="string">&quot;/lib/ld-linux.so.2 /lib64/ld-linux-x86-64.so.2 /libx32/ld-linux-x32.so.2&quot;</span></span><br></pre></td></tr></table></figure>

<p>ld 会有如下的选项，用来模拟加载找到依赖，但不会执行文件</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">--<span class="built_in">list</span>                <span class="built_in">list</span> all dependencies and how they are resolved</span><br></pre></td></tr></table></figure>

<p>所以我们下面会得到相同的东西，程序开了pie所以加载地址会不同</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/D/s/i/nemu (pa1)&gt; ldd a.out</span><br><span class="line">    linux-vdso.so<span class="number">.1</span> (<span class="number">0x00007ffde81e7000</span>)</span><br><span class="line">    libc.so<span class="number">.6</span> =&gt; /lib/x86_64-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0x00007f68d5200000</span>)</span><br><span class="line">    /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007f68d54ab000</span>)</span><br><span class="line">grxer@Ubuntu22 ~/D/s/i/nemu (pa1)&gt; /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> --<span class="built_in">list</span> ./a.out</span><br><span class="line">    linux-vdso.so<span class="number">.1</span> (<span class="number">0x00007fff141e7000</span>)</span><br><span class="line">    libc.so<span class="number">.6</span> =&gt; /lib/x86_64-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0x00007efd08400000</span>)</span><br><span class="line">    /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007efd08773000</span>)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>他也会被随机映射到内存，所以他也会有个重定位的过程，这个过程由他自己完成，叫做自举</p>
<p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506091935404.png" alt="image-20230506091935404"></p>
<p>所以对于动态链接的程序，操作系统在完成程序映射到进程空间后，不会再像静态链接的程序那样把控制权给到程序的入口地址，而是给到动态链接器的自举代码入口，接下来就是根据dynamic里保存的信息去做符号的整合和重定位，如果动态库有.init或.finit段会去先执行这些段里的指令(例如c++里的全局对象的构造和析构函数)，随后才把控制权转移到可执行文件的入口函数</p>
<p>所以我们可以把程序直接交给动态链接器，也可以跑起来</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/D/s/i/nemu (pa1)&gt; /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>  ./a.out</span><br><span class="line">hello⏎     </span><br></pre></td></tr></table></figure>

<h3 id="动态符号表-dynsym"><a href="#动态符号表-dynsym" class="headerlink" title="动态符号表 .dynsym"></a>动态符号表 .dynsym</h3><p>.symtab一般保存了所有符号，.dynsym只保存了动态链接的符号，数据结构用的是一样的，.dynstr保存了动态符号字符串表</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -s xxx.so</span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">&#x27;.dynsym&#x27;</span> contains <span class="number">16</span> entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     <span class="number">0</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     <span class="number">1</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  WEAK   DEFAULT  UND _ITM_deregisterTMCloneTab</span><br><span class="line">     <span class="number">2</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND b</span><br><span class="line">     <span class="number">3</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    WEAK   DEFAULT  UND __cxa_finalize@GLIBC_2<span class="number">.1</span><span class="number">.3</span> (<span class="number">2</span>)</span><br><span class="line">     <span class="number">4</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  WEAK   DEFAULT  UND __gmon_start__</span><br><span class="line">     <span class="number">5</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND ext</span><br><span class="line">     <span class="number">6</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  WEAK   DEFAULT  UND _Jv_RegisterClasses</span><br><span class="line">     <span class="number">7</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  WEAK   DEFAULT  UND _ITM_registerTMCloneTable</span><br><span class="line">     <span class="number">8</span>: <span class="number">00002018</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT   <span class="number">22</span> _edata</span><br><span class="line">     <span class="number">9</span>: <span class="number">00000570</span>    <span class="number">50</span> FUNC    GLOBAL DEFAULT   <span class="number">12</span> bar</span><br><span class="line">    <span class="number">10</span>: <span class="number">00002020</span>     <span class="number">4</span> OBJECT  GLOBAL DEFAULT   <span class="number">23</span> x</span><br><span class="line">    <span class="number">11</span>: <span class="number">000005</span>a2    <span class="number">35</span> FUNC    GLOBAL DEFAULT   <span class="number">12</span> foo</span><br><span class="line">    <span class="number">12</span>: <span class="number">00002024</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT   <span class="number">23</span> _end</span><br><span class="line">    <span class="number">13</span>: <span class="number">00002018</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT   <span class="number">23</span> __bss_start</span><br><span class="line">    <span class="number">14</span>: <span class="number">000003</span>d0     <span class="number">0</span> FUNC    GLOBAL DEFAULT    <span class="number">9</span> _init</span><br><span class="line">    <span class="number">15</span>: <span class="number">000005</span>cc     <span class="number">0</span> FUNC    GLOBAL DEFAULT   <span class="number">13</span> _fini</span><br></pre></td></tr></table></figure>

<h2 id="显示的运行时链接"><a href="#显示的运行时链接" class="headerlink" title="显示的运行时链接"></a>显示的运行时链接</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SETUP_STACK                                               \</span></span><br><span class="line"><span class="meta">    i = 2;                                                        \</span></span><br><span class="line"><span class="meta">    while (++i &lt; argc - 1) &#123;                                      \</span></span><br><span class="line"><span class="meta">        switch (argv[i][0]) &#123;                                     \</span></span><br><span class="line"><span class="meta">            case <span class="string">&#x27;i&#x27;</span>:                                             \</span></span><br><span class="line"><span class="meta">                asm volatile(<span class="string">&quot;push %0&quot;</span> ::<span class="string">&quot;r&quot;</span>(atoi(&amp;argv[i][1]))); \</span></span><br><span class="line"><span class="meta">                esp += 4;                                         \</span></span><br><span class="line"><span class="meta">                break;                                            \</span></span><br><span class="line"><span class="meta">            case <span class="string">&#x27;d&#x27;</span>:                                             \</span></span><br><span class="line"><span class="meta">                atof(&amp;argv[i][1]);                                \</span></span><br><span class="line"><span class="meta">                asm volatile(                                     \</span></span><br><span class="line"><span class="meta">                    <span class="string">&quot;subl $8,%esp\n&quot;</span>                              \</span></span><br><span class="line"><span class="meta">                    <span class="string">&quot;fstpl (%esp)&quot;</span>);                              \</span></span><br><span class="line"><span class="meta">                esp += 8;                                         \</span></span><br><span class="line"><span class="meta">                break;                                            \</span></span><br><span class="line"><span class="meta">            case <span class="string">&#x27;s&#x27;</span>:                                             \</span></span><br><span class="line"><span class="meta">                asm volatile(<span class="string">&quot;push %0&quot;</span> ::<span class="string">&quot;r&quot;</span>(&amp;argv[i][1]));       \</span></span><br><span class="line"><span class="meta">                esp += 4;                                         \</span></span><br><span class="line"><span class="meta">                break;                                            \</span></span><br><span class="line"><span class="meta">            default:                                              \</span></span><br><span class="line"><span class="meta">                printf(<span class="string">&quot;error argument type&quot;</span>);                    \</span></span><br><span class="line"><span class="meta">                goto exit_runso;                                  \</span></span><br><span class="line"><span class="meta">        &#125;                                                         \</span></span><br><span class="line"><span class="meta">    &#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RESTORE_STACK asm volatile(<span class="string">&quot;add %0,%%esp&quot;</span> ::<span class="string">&quot;r&quot;</span>(esp))</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">    <span class="type">void</span>* handle;</span><br><span class="line">    <span class="type">char</span>* error;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">int</span> esp = <span class="number">0</span>;</span><br><span class="line">    <span class="type">void</span>* func;</span><br><span class="line">    handle = dlopen(argv[<span class="number">1</span>], RTLD_NOW);</span><br><span class="line">    <span class="keyword">if</span> (handle == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Can&#x27;t find library: %s\n&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    func = dlsym(handle, argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">if</span> ((error = dlerror()) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Find symbol %s error: %s\n&quot;</span>, argv[<span class="number">2</span>], error);</span><br><span class="line">        <span class="keyword">goto</span> exit_runso;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (argv[argc - <span class="number">1</span>][<span class="number">0</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;i&#x27;</span>: &#123;</span><br><span class="line">            <span class="type">int</span> (*func_int)() = func;</span><br><span class="line">            SETUP_STACK;</span><br><span class="line">            <span class="type">int</span> ret = func_int();</span><br><span class="line">            RESTORE_STACK;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ret = %d\n&quot;</span>, ret);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>: &#123;</span><br><span class="line">            <span class="type">double</span> (*func_double)() = func;</span><br><span class="line">            SETUP_STACK;</span><br><span class="line">            <span class="type">double</span> ret = func_double();</span><br><span class="line">            RESTORE_STACK;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ret = %f\n&quot;</span>, ret);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>: &#123;</span><br><span class="line">            <span class="type">char</span>* (*func_str)() = func;</span><br><span class="line">            SETUP_STACK;</span><br><span class="line">            <span class="type">char</span>* ret = func_str();</span><br><span class="line">            RESTORE_STACK;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ret = %s\n&quot;</span>, ret);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;v&#x27;</span>: &#123;</span><br><span class="line">            <span class="type">void</span> (*func_void)() = func;</span><br><span class="line">            SETUP_STACK</span><br><span class="line">            <span class="title function_">func_void</span><span class="params">()</span>;</span><br><span class="line">            RESTORE_STACK;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ret = void&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  <span class="comment">// end of switch</span></span><br><span class="line">exit_runso:</span><br><span class="line">    dlclose(handle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; gcc -m32 get.c -ldl</span><br><span class="line">get.c: In function ‘main’:</span><br><span class="line">get.c:<span class="number">8</span>:<span class="number">46</span>: warning: implicit declaration of function ‘atoi’ [-Wimplicit-function-declaration]</span><br><span class="line">                 <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;push %0&quot;</span> ::<span class="string">&quot;r&quot;</span>(atoi(&amp;argv[i][<span class="number">1</span>])))</span>; \</span><br><span class="line">                                              ^</span><br><span class="line">get.c:<span class="number">47</span>:<span class="number">13</span>: note: in expansion of macro ‘SETUP_STACK’</span><br><span class="line">             SETUP_STACK;</span><br><span class="line">             ^</span><br><span class="line">get.c:<span class="number">12</span>:<span class="number">17</span>: warning: implicit declaration of function ‘atof’ [-Wimplicit-function-declaration]</span><br><span class="line">                 atof(&amp;argv[i][<span class="number">1</span>]);                                \</span><br><span class="line">                 ^</span><br><span class="line">get.c:<span class="number">47</span>:<span class="number">13</span>: note: in expansion of macro ‘SETUP_STACK’</span><br><span class="line">             SETUP_STACK;</span><br><span class="line">             ^</span><br><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; </span><br><span class="line">./a.out  /lib/i386-linux-gnu/libm<span class="number">-2.23</span>.so <span class="built_in">sin</span> d2<span class="number">.0</span> d</span><br><span class="line">ret = <span class="number">0.909297</span></span><br></pre></td></tr></table></figure>

<p>由于库里有非常多的函数，我们不可能为每一个函数都定于一个函数指针，这段代码有意思的点在于他把返回值的情况都列了出来，然后调用空函数前自己去传参，调用后自己去平栈，其中定义了全局变量esp来记录需要平栈的大小</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ELF-Dynamical-link"><span class="toc-number">1.</span> <span class="toc-text">ELF Dynamical link</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5"><span class="toc-number">1.1.</span> <span class="toc-text">动态链接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%B0%E5%9D%80%E6%97%A0%E5%85%B3"><span class="toc-number">1.2.</span> <span class="toc-text">地址无关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#share"><span class="toc-number">1.2.1.</span> <span class="toc-text">-share</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fPIC"><span class="toc-number">1.2.2.</span> <span class="toc-text">-fPIC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-gt-%E6%A8%A1%E5%9D%97%E5%86%85%E7%9A%84%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%E5%92%8C%E8%B7%B3%E8%BD%AC"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">&gt;&gt;&gt; 模块内的过程调用和跳转</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-gt-%E6%A8%A1%E5%9D%97%E5%86%85%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">&gt;&gt;&gt;模块内数据访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-gt-%E6%A8%A1%E5%9D%97%E9%97%B4%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">&gt;&gt;&gt;模块间数据访问</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gt-gt-gt-%E6%A8%A1%E5%9D%97%E9%97%B4%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%E5%92%8C%E8%B7%B3%E8%BD%AC"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">&gt;&gt;&gt;模块间过程调用和跳转</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dynamic"><span class="toc-number">1.2.3.</span> <span class="toc-text">.dynamic</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%99%A8"><span class="toc-number">1.3.</span> <span class="toc-text">动态链接器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#interp"><span class="toc-number">1.3.1.</span> <span class="toc-text">.interp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E7%AC%A6%E5%8F%B7%E8%A1%A8-dynsym"><span class="toc-number">1.3.2.</span> <span class="toc-text">动态符号表 .dynsym</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%98%BE%E7%A4%BA%E7%9A%84%E8%BF%90%E8%A1%8C%E6%97%B6%E9%93%BE%E6%8E%A5"><span class="toc-number">1.4.</span> <span class="toc-text">显示的运行时链接</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/&text=ELF动态链接(ELF Dynamical link)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/&title=ELF动态链接(ELF Dynamical link)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/&is_video=false&description=ELF动态链接(ELF Dynamical link)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=ELF动态链接(ELF Dynamical link)&body=Check out this article: https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/&title=ELF动态链接(ELF Dynamical link)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/&title=ELF动态链接(ELF Dynamical link)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/&title=ELF动态链接(ELF Dynamical link)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/&title=ELF动态链接(ELF Dynamical link)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/&name=ELF动态链接(ELF Dynamical link)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/05/04/ELF-Dynamical-link/&t=ELF动态链接(ELF Dynamical link)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2024
    bxz
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?a22ef0bec4e4a9c7337bea6e37ff55c1";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
