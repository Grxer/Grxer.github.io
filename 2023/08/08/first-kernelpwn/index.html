<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="baidu-site-verification" content="codeva-ROfYcqLkCh" />
    <meta name="msvalidate.01" content="ECA3E06A0E52A2AC90C4B06F12981FB2" />
    <meta name="description" content="环境以CISCN2017-babydriver为例 busybox文件系统简单的文件系统，提供基本用户环境，如一些常用命令和工具 https:&#x2F;&#x2F;www.busybox.net&#x2F; make menuconfig  将busybox编译为静态链接的文件  make -j6make install  编译其他架构busybox make -j4 CROSS_COMPILE &#x3D; 其他架构交叉编译器  在">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel Pwn 基础">
<meta property="og:url" content="https://grxer.gitee.io/2023/08/08/first-kernelpwn/index.html">
<meta property="og:site_name" content="Grxer&#39;s Blog">
<meta property="og:description" content="环境以CISCN2017-babydriver为例 busybox文件系统简单的文件系统，提供基本用户环境，如一些常用命令和工具 https:&#x2F;&#x2F;www.busybox.net&#x2F; make menuconfig  将busybox编译为静态链接的文件  make -j6make install  编译其他架构busybox make -j4 CROSS_COMPILE &#x3D; 其他架构交叉编译器  在">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://grxer.gitee.io/2023/08/08/first-kernelpwn/image-20230808234139406.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/08/08/first-kernelpwn/image-20230814231519956.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/08/08/first-kernelpwn/image-20230811154518221.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/08/08/first-kernelpwn/image-20230811165305116.png">
<meta property="article:published_time" content="2023-08-08T15:26:28.000Z">
<meta property="article:modified_time" content="2023-09-24T02:40:03.751Z">
<meta property="article:author" content="bxz">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://grxer.gitee.io/2023/08/08/first-kernelpwn/image-20230808234139406.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Kernel Pwn 基础</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
		<script type="text/x-mathjax-config">
		  MathJax.Hub.Config({
			tex2jax: {
			  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			  inlineMath: [['$','$']]
			}
		  });
		</script>
		<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 lrt">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/08/10/2023-securinets-ctf/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/08/06/House-Of-Roman/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/08/08/first-kernelpwn/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&text=Kernel Pwn 基础"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=Kernel Pwn 基础"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&is_video=false&description=Kernel Pwn 基础"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Kernel Pwn 基础&body=Check out this article: https://grxer.gitee.io/2023/08/08/first-kernelpwn/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=Kernel Pwn 基础"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=Kernel Pwn 基础"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=Kernel Pwn 基础"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=Kernel Pwn 基础"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&name=Kernel Pwn 基础&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&t=Kernel Pwn 基础"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83"><span class="toc-number">1.</span> <span class="toc-text">环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#busybox%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.1.</span> <span class="toc-text">busybox文件系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E6%A0%B8"><span class="toc-number">1.2.</span> <span class="toc-text">内核</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%B7%B1%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8"><span class="toc-number">1.2.1.</span> <span class="toc-text">自己编译内核</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E7%8E%B0%E6%9C%89%E5%86%85%E6%A0%B8%E9%95%9C%E5%83%8F"><span class="toc-number">1.2.2.</span> <span class="toc-text">下载现有内核镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8%E9%95%9C%E5%83%8F"><span class="toc-number">1.2.3.</span> <span class="toc-text">系统内核镜像</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%86%85%E6%A0%B8"><span class="toc-number">1.3.</span> <span class="toc-text">启动内核</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%86%85%E6%A0%B8"><span class="toc-number">1.4.</span> <span class="toc-text">调试内核</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Loadable-Kernel-Modules%EF%BC%88LKMs%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">Loadable Kernel Modules（LKMs）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%82%E9%A1%B9%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87"><span class="toc-number">2.1.</span> <span class="toc-text">杂项字符设备</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E9%98%B2%E6%8A%A4"><span class="toc-number">3.</span> <span class="toc-text">内核防护</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#KASLR"><span class="toc-number">3.1.</span> <span class="toc-text">KASLR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FGKASLR"><span class="toc-number">3.2.</span> <span class="toc-text">FGKASLR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#STACK-PROTECTOR"><span class="toc-number">3.3.</span> <span class="toc-text">STACK PROTECTOR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SMEP-x2F-SMAP"><span class="toc-number">3.4.</span> <span class="toc-text">SMEP&#x2F;SMAP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KPTI"><span class="toc-number">3.5.</span> <span class="toc-text">KPTI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="toc-number">3.6.</span> <span class="toc-text">访问控制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#dmesg-restrict"><span class="toc-number">3.6.1.</span> <span class="toc-text">dmesg_restrict</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kptr-restrict"><span class="toc-number">3.6.2.</span> <span class="toc-text">kptr_restrict</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Kernel Pwn 基础
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">bxz</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-08-08T15:26:28.000Z" itemprop="datePublished">2023-08-08</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>以<a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-challenges/blob/master/pwn/kernel/CISCN2017-babydriver/babydriver.tar">CISCN2017-babydriver</a>为例</p>
<h3 id="busybox文件系统"><a href="#busybox文件系统" class="headerlink" title="busybox文件系统"></a><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/BusyBox">busybox文件系统</a></h3><p>简单的文件系统，提供基本用户环境，如一些常用命令和工具</p>
<p><a target="_blank" rel="noopener" href="https://www.busybox.net/">https://www.busybox.net/</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></table></figure>

<p>将busybox编译为静态链接的文件</p>
<p><img src="/2023/08/08/first-kernelpwn/image-20230808234139406.png" alt="image-20230808234139406"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">make -j6</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>编译其他架构busybox</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make -j4 CROSS_COMPILE = 其他架构交叉编译器</span><br></pre></td></tr></table></figure>

<p>在编译好的文件夹下(默认为_install)</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir -p  proc sys dev etc/init.d</span><br></pre></td></tr></table></figure>

<p>写下init 脚本 chmod +x init </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">echo &quot;INIT SCRIPT&quot;</span><br><span class="line">mkdir /tmp</span><br><span class="line">mount -t proc none /proc    </span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line">echo -e &quot;Boot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds&quot;</span><br><span class="line">insmod /babydriver.ko</span><br><span class="line">setsid /bin/cttyhack setuidgid 0 /bin/sh</span><br></pre></td></tr></table></figure>

<p>打包脚本</p>
<p>pack.sh</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">sudo cp -r rootfs rootfs_tmp</span><br><span class="line">sudo cp init rootfs_tmp/</span><br><span class="line">sudo cp babydriver.ko rootfs_tmp/</span><br><span class="line"></span><br><span class="line">sudo chmod +x rootfs_tmp/</span><br><span class="line">sudo chmod g-w -R rootfs_tmp/</span><br><span class="line">sudo chmod o-w -R rootfs_tmp/</span><br><span class="line">sudo chown -R root rootfs_tmp/</span><br><span class="line">sudo chgrp -R root rootfs_tmp/</span><br><span class="line">sudo chmod u+s rootfs_tmp/bin/busybox</span><br><span class="line"></span><br><span class="line">cd rootfs_tmp</span><br><span class="line">sudo mkdir -p  proc sys dev etc/init.d</span><br><span class="line">find . | cpio -o --format=newc &gt; ../rootfs.img</span><br><span class="line">cd ../</span><br><span class="line">sudo rm -rf ./rootfs_tmp</span><br></pre></td></tr></table></figure>

<p>解包</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cpio -idmv &lt; rootfs.img</span><br></pre></td></tr></table></figure>

<h3 id="内核"><a href="#内核" class="headerlink" title="内核"></a>内核</h3><h4 id="自己编译内核"><a href="#自己编译内核" class="headerlink" title="自己编译内核"></a>自己编译内核</h4><p><a target="_blank" rel="noopener" href="https://www.kernel.org/">https://www.kernel.org/</a></p>
<p><a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/kernel/">https://mirrors.tuna.tsinghua.edu.cn/kernel/</a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.kernel.org/pub/linux/kernel/">https://cdn.kernel.org/pub/linux/kernel/</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/SweeNeil/article/details/88655995">不要在共享目录下来解压kernel，不然会有些符号链接的问题</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make help</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make menuconfig</span><br><span class="line">make -j4 bzImage</span><br></pre></td></tr></table></figure>

<p>跨平台</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ARCH=平台 CROSS_COMPILE= 其他架构交叉编译器 make -j4 bzImage</span><br></pre></td></tr></table></figure>

<p>一般按照题目给的内核文件bzImage编译指定版本内核</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/kernel-env&gt; file ./bzImage</span><br><span class="line">./bzImage: Linux kernel x86 boot executable bzImage, version 4.4.72 (atum@ubuntu) #1 SMP Thu Jun 15 19:52:50 PDT 2017, RO-rootFS, swap_dev 0X6, Normal VGA</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.4.72.tar.gz">https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.4.72.tar.gz</a></p>
<p>确定一下gcc版本,防止一些不必要的问题</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/kernel-env&gt; strings ./bzImage | grep &#x27;gcc&#x27;</span><br><span class="line">4.4.72 (atum@ubuntu) (gcc version 5.4.0 20160609 (Ubuntu 5.4.0-6ubuntu1~16.04.4) ) #1 SMP Thu Jun 15 19:52:50 PDT 2017</span><br></pre></td></tr></table></figure>

<p>自己编译时遇到的问题</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/k/linux-4.4.42&gt; make menuconfig</span><br><span class="line">  HOSTCC  scripts/kconfig/mconf.o</span><br><span class="line">In file included from scripts/kconfig/mconf.c:23:0:</span><br><span class="line">scripts/kconfig/lxdialog/dialog.h:38:20: fatal error: curses.h: No such file or directory</span><br><span class="line">compilation terminated.</span><br><span class="line">scripts/Makefile.host:108: recipe for target &#x27;scripts/kconfig/mconf.o&#x27; failed</span><br><span class="line">make[1]: *** [scripts/kconfig/mconf.o] Error 1</span><br><span class="line">Makefile:542: recipe for target &#x27;menuconfig&#x27; failed</span><br><span class="line">make: *** [menuconfig] Error 2</span><br><span class="line">解决</span><br><span class="line">sudo apt-get install libncurses5-dev</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">scripts/sign-file.c:23:30: fatal error: openssl/opensslv.h: No such file or directory</span><br><span class="line">compilation terminated.</span><br><span class="line">scripts/Makefile.host:91: recipe for target &#x27;scripts/sign-file&#x27; failed</span><br><span class="line">make[1]: *** [scripts/sign-file] Error 1</span><br><span class="line">make[1]: *** Waiting for unfinished jobs....</span><br><span class="line">  HOSTCC  arch/x86/tools/relocs_common.o</span><br><span class="line">  HOSTLD  arch/x86/tools/relocs</span><br><span class="line">Makefile:556: recipe for target &#x27;scripts&#x27; failed</span><br><span class="line">make: *** [scripts] Error 2</span><br><span class="line">make: *** Waiting for unfinished jobs....</span><br><span class="line">解决</span><br><span class="line">grxer@Ubuntu16 /m/h/s/k/linux-4.4.42&gt;  sudo apt-get install libssl-dev </span><br></pre></td></tr></table></figure>

<p>编译成功</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Setup is 17404 bytes (padded to 17408 bytes).</span><br><span class="line">System is 6820 kB</span><br><span class="line">CRC df8a19f</span><br><span class="line">Kernel: arch/x86/boot/bzImage is ready  (#1)</span><br></pre></td></tr></table></figure>

<p>两个比较重要的文件就是</p>
<ul>
<li>bzImage：<code>arch/x86/boot/bzImage</code></li>
<li>vmlinux：用来调试</li>
</ul>
<p>内核镜像详细介绍: <a target="_blank" rel="noopener" href="https://gohalo.me/post/kernel-compile.html">https://gohalo.me/post/kernel-compile.html</a></p>
<h4 id="下载现有内核镜像"><a href="#下载现有内核镜像" class="headerlink" title="下载现有内核镜像"></a>下载现有内核镜像</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt search linux-image- </span><br><span class="line">sudo apt download xxxxx</span><br><span class="line">dpkg -X xxxx extract</span><br><span class="line">./boot/xxx-generic即为bzImage内核镜像文件</span><br></pre></td></tr></table></figure>

<h4 id="系统内核镜像"><a href="#系统内核镜像" class="headerlink" title="系统内核镜像"></a>系统内核镜像</h4><p>&#x2F;boot&#x2F;目录下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~&gt; ll -a /boot</span><br><span class="line">total 177M</span><br><span class="line">drwxr-xr-x  4 root root 4.0K  7月 12 09:06 .</span><br><span class="line">drwxr-xr-x 20 root root 4.0K  7月 28 15:44 ..</span><br><span class="line">-rw-r--r--  1 root root 264K  6月  7 22:23 config-5.19.0-45-generic</span><br><span class="line">-rw-r--r--  1 root root 264K  6月 21 22:38 config-5.19.0-46-generic</span><br><span class="line">drwx------  3 root root 4.0K  1月  1  1970 efi</span><br><span class="line">drwxr-xr-x  6 root root 4.0K  7月 12 09:05 grub</span><br><span class="line">lrwxrwxrwx  1 root root   28  7月 12 09:03 initrd.img -&gt; initrd.img-5.19.0-46-generic</span><br><span class="line">-rw-r--r--  1 root root  70M  7月 12 09:04 initrd.img-5.19.0-45-generic</span><br><span class="line">-rw-r--r--  1 root root  70M  7月 12 09:04 initrd.img-5.19.0-46-generic</span><br><span class="line">lrwxrwxrwx  1 root root   28  7月 12 09:03 initrd.img.old -&gt; initrd.img-5.19.0-45-generic</span><br><span class="line">-rw-r--r--  1 root root 179K  2月  7  2022 memtest86+.bin</span><br><span class="line">-rw-r--r--  1 root root 181K  2月  7  2022 memtest86+.elf</span><br><span class="line">-rw-r--r--  1 root root 181K  2月  7  2022 memtest86+_multiboot.bin</span><br><span class="line">-rw-------  1 root root 6.2M  6月  7 22:23 System.map-5.19.0-45-generic</span><br><span class="line">-rw-------  1 root root 6.2M  6月 21 22:38 System.map-5.19.0-46-generic</span><br><span class="line">lrwxrwxrwx  1 root root   25  7月 12 09:03 vmlinuz -&gt; vmlinuz-5.19.0-46-generic</span><br><span class="line">-rw-------  1 root root  12M  6月  7 22:23 vmlinuz-5.19.0-45-generic</span><br><span class="line">-rw-------  1 root root  12M  6月 21 22:43 vmlinuz-5.19.0-46-generic</span><br><span class="line">lrwxrwxrwx  1 root root   25  7月 12 09:03 vmlinuz.old -&gt; vmlinuz-5.19.0-45-generic</span><br><span class="line">grxer@Ubuntu22 ~&gt; <span class="built_in">uname</span> -r</span><br><span class="line">5.19.0-46-generic</span><br><span class="line">grxer@Ubuntu22 ~&gt; sudo file /boot/vmlinuz-5.19.0-46-generic</span><br><span class="line">[sudo] password <span class="keyword">for</span> grxer:</span><br><span class="line">/boot//vmlinuz-5.19.0-46-generic: Linux kernel x86 boot executable bzImage, version 5.19.0-46-generic (buildd@lcy02-amd64-025) <span class="comment">#47~22.04.1-Ubuntu SMP PREEMPT_DYNAMIC Wed Jun 21 15:35:31 UTC 2, RO-rootFS, swap_dev 0XB, Normal VGA</span></span><br></pre></td></tr></table></figure>

<p>vmlinuz-5.19.0-46-generic 内核</p>
<p>initrd.img-5.19.0-46-generic 引导文件</p>
<h3 id="启动内核"><a href="#启动内核" class="headerlink" title="启动内核"></a>启动内核</h3><p>start.sh</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m <span class="number">64</span>M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd  ./rootfs.img \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr&quot;</span> \</span><br><span class="line">    -smp cores=<span class="number">2</span>,threads=<span class="number">1</span> \</span><br><span class="line">    -cpu kvm64</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-m</code>：虚拟机内存大小</li>
<li><code>-nographic</code>：以非图形界面模式运行虚拟机</li>
<li><code>-kernel</code>：指定内核镜像文件</li>
<li><code>initrd</code>：指定初始RAM磁盘镜像文件</li>
<li><code>append</code>：设置内核启动附加参数</li>
<li><code>smp</code>:设置虚拟机的处理器拓扑，此处使用 2 个核心和 1 个线程</li>
<li><code>cpu</code>:设置CPU安全选项</li>
</ul>
<h3 id="调试内核"><a href="#调试内核" class="headerlink" title="调试内核"></a>调试内核</h3><p>启动脚本里关掉aslr</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 nokaslr&quot; \</span><br></pre></td></tr></table></figure>

<p>开启调试接口</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">启动参数中添加  -gdb dev，如-gdb tcp::1234 可简写为-s 如果希望 qemu 启动后立即挂起，额外添加-S参数</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">~ # lsmod</span><br><span class="line">babydriver 16384 0 - Live 0xffffffffc0000000 (OE)</span><br><span class="line">~ # find /sys/| grep babydriver</span><br><span class="line">/sys/module/babydriver</span><br><span class="line">/sys/module/babydriver/srcversion</span><br><span class="line">/sys/module/babydriver/notes</span><br><span class="line">/sys/module/babydriver/notes/.note.gnu.build-id</span><br><span class="line">/sys/module/babydriver/taint</span><br><span class="line">/sys/module/babydriver/initstate</span><br><span class="line">/sys/module/babydriver/coresize</span><br><span class="line">/sys/module/babydriver/sections</span><br><span class="line">/sys/module/babydriver/sections/.bss</span><br><span class="line">/sys/module/babydriver/sections/.init.text</span><br><span class="line">/sys/module/babydriver/sections/.data</span><br><span class="line">/sys/module/babydriver/sections/.text</span><br><span class="line">/sys/module/babydriver/sections/__mcount_loc</span><br><span class="line">/sys/module/babydriver/sections/.strtab</span><br><span class="line">/sys/module/babydriver/sections/.symtab</span><br><span class="line">/sys/module/babydriver/sections/.gnu.linkonce.this_module</span><br><span class="line">/sys/module/babydriver/sections/.rodata.str1.1</span><br><span class="line">/sys/module/babydriver/sections/.note.gnu.build-id</span><br><span class="line">/sys/module/babydriver/sections/.exit.text</span><br><span class="line">/sys/module/babydriver/refcnt</span><br><span class="line">/sys/module/babydriver/uevent</span><br><span class="line">/sys/module/babydriver/holders</span><br><span class="line">/sys/module/babydriver/initsize</span><br><span class="line">~ # cat /sys/module/babydriver/sections/.text</span><br><span class="line">0xffffffffc0000000</span><br><span class="line">~ $ cat /sys/module/babydriver/sections/.bss</span><br><span class="line">0xffffffffc0002440</span><br><span class="line">~ $ cat /sys/module/babydriver/sections/.data</span><br><span class="line">0xffffffffc0002000</span><br></pre></td></tr></table></figure>

<p>gdb.sh</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">sudo gdb -q \</span><br><span class="line">      -ex &quot;file vmlinux&quot;\</span><br><span class="line">    -ex &quot;add-symbol-file babydriver.ko 0xffffffffc0000000 -s .data 0xffffffffc0002000 -s .bss 0xffffffffc0002440&quot;\</span><br><span class="line">    -ex &quot;target remote localhost:1234&quot;\</span><br><span class="line">    -ex &quot;b babyopen&quot; </span><br></pre></td></tr></table></figure>

<h2 id="Loadable-Kernel-Modules（LKMs）"><a href="#Loadable-Kernel-Modules（LKMs）" class="headerlink" title="Loadable Kernel Modules（LKMs）"></a>Loadable Kernel Modules（LKMs）</h2><p>Linux Kernle采用的是宏内核架构，一切的系统服务都需要由内核来提供，效率较高，但是缺乏可扩展性与可维护性，然后就有了<strong>可装载内核模块</strong>（<strong>Loadable Kernel Modules</strong>，简称<strong>LKMs</strong>，LKMs可以提供<strong>新的系统调用</strong>或其他服务，驱动等，LKMs是ELF文件格式，运行在内核</p>
<ul>
<li><code>lsmod</code>：列出现有的LKMs</li>
<li><code>insmod</code>：装载新的LKM（需要root）</li>
<li><code>rmmod</code>：从内核中移除LKM（需要root）、</li>
<li><code>modprobe</code>: 添加或删除模块，modprobe 在加载模块时会查找依赖关系</li>
</ul>
<p>一般ctf就是分析这个文件，了解一下程序的编写</p>
<p>在之前下载的源码文件夹下</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir testdrive &amp; cd testdrive</span><br></pre></td></tr></table></figure>

<p>kotest.c</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;Dual BSD/GPL&quot;</span>);</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ko_test_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  printk(<span class="string">&quot;This is a test ko!\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ko_test_exit</span><span class="params">(<span class="type">void</span>)</span> &#123; printk(<span class="string">&quot;Bye Bye~\n&quot;</span>); &#125;</span><br><span class="line">module_init(ko_test_init);<span class="comment">//模块入口函数 加载时执行</span></span><br><span class="line">module_exit(ko_test_exit);<span class="comment">//模块出口函数 卸载时执行</span></span><br></pre></td></tr></table></figure>

<p>Makefile</p>
<figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">obj-m += ko_test.o</span><br><span class="line"></span><br><span class="line">KDIR =/home/grxer/kernel-env/linux-4.4.72/</span><br><span class="line"></span><br><span class="line"><span class="section">all:</span></span><br><span class="line">    <span class="variable">$(MAKE)</span> -C <span class="variable">$(KDIR)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    rm -rf *.o *.ko *.mod.* *.symvers *.order</span><br></pre></td></tr></table></figure>

<ul>
<li><code>obj-m</code>： 指定了编译的结果应当为可装载内核模块，指定要声称哪些模块</li>
<li><code>KDIR</code> 用来标识内核源码目录，提供驱动编译所需环境</li>
<li><code>-C</code> 表示进入到指定的内核目录</li>
<li><code>M</code> 指定驱动源码的环境，使 Makefile 在构建模块之前返回到 驱动源码 目录，并在该目录中生成驱动模块</li>
</ul>
<p>make</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 ~/k/l/testdrive&gt; make</span><br><span class="line">make -C /home/grxer/kernel-env/linux<span class="number">-4.4</span><span class="number">.72</span>/ M=/home/grxer/kernel-env/linux<span class="number">-4.4</span><span class="number">.72</span>/testdrive modules</span><br><span class="line">make[<span class="number">1</span>]: Entering directory <span class="string">&#x27;/home/grxer/kernel-env/linux-4.4.72&#x27;</span></span><br><span class="line">  CC [M]  /home/grxer/kernel-env/linux<span class="number">-4.4</span><span class="number">.72</span>/testdrive/ko_test.o</span><br><span class="line">  Building modules, stage <span class="number">2.</span></span><br><span class="line">  MODPOST <span class="number">1</span> modules</span><br><span class="line">  CC      /home/grxer/kernel-env/linux<span class="number">-4.4</span><span class="number">.72</span>/testdrive/ko_test.mod.o</span><br><span class="line">  LD [M]  /home/grxer/kernel-env/linux<span class="number">-4.4</span><span class="number">.72</span>/testdrive/ko_test.ko</span><br><span class="line">make[<span class="number">1</span>]: Leaving directory <span class="string">&#x27;/home/grxer/kernel-env/linux-4.4.72&#x27;</span></span><br><span class="line">grxer@Ubuntu16 ~/k/l/testdrive&gt; ls</span><br><span class="line">ko_test.c*  ko_test.mod.c  ko_test.o  modules.order</span><br><span class="line">ko_test.ko  ko_test.mod.o  Makefile*  Module.symvers</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里的gcc尽量还是之前确定的那个gcc</p>
</blockquote>
<p>ko_test.ko复制到文件系统根目录，然后在init装载新的LKM，重新打包</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">insmod /ko_test.ko</span><br></pre></td></tr></table></figure>

<p>开机后dmesg就可以看到了</p>
<p><img src="/2023/08/08/first-kernelpwn/image-20230814231519956.png" alt="image-20230814231519956"></p>
<h3 id="杂项字符设备"><a href="#杂项字符设备" class="headerlink" title="杂项字符设备"></a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ggzhangxiaochao/p/12894883.html">杂项字符设备</a></h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">注册：<span class="type">int</span> <span class="title function_">misc_register</span><span class="params">(<span class="keyword">struct</span> miscdevice *misc)</span></span><br><span class="line">释放：<span class="type">int</span> <span class="title function_">misc_deregister</span><span class="params">(<span class="keyword">struct</span> miscdevice *misc)</span></span><br></pre></td></tr></table></figure>

<p>misc_register注册杂项字符设备，该类设备使用同一个主设备号10,会自动创建设备节点，即设备文件。无需mknod指令创建设备文件。因为misc_register()会调用class_device_creat或者device_creat().</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span>  &#123;</span></span><br><span class="line">    <span class="type">int</span> minor;<span class="comment">//次设备号,一般使用 MISC_DYNAMIC_MINOR 宏来使用动态分配的次设备号</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;<span class="comment">//字符设备的名称</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">fops</span>;</span><span class="comment">//指向字符设备操作函数集的指针</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">class_device</span> *<span class="keyword">class</span>;</span></span><br><span class="line">    <span class="type">char</span> devfs_name[<span class="number">64</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.5-rc2/source/include/linux/fs.h#L1821">file_operations</a>结构体成员基本上都是函数指针，可以通过修改其中的函数指针来达到重写某个函数的目的，如果对这个驱动调用某个其中的函数，就会调用结构体中的函数指针</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/miscdevice.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">misc_ioctl</span><span class="params">(<span class="keyword">struct</span> file* file, <span class="type">unsigned</span> <span class="type">int</span> request,  <span class="type">size_t</span> arg)</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (request)</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0x666</span>:</span><br><span class="line">    printk(<span class="string">&quot;0x666\n&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0x888</span>:</span><br><span class="line">    printk(<span class="string">&quot;0x888\n&quot;</span>); </span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">dev_fops</span> =</span> &#123;</span><br><span class="line">  .owner = THIS_MODULE,</span><br><span class="line">  .unlocked_ioctl = misc_ioctl,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span> <span class="title">test_misc</span> =</span> &#123;</span><br><span class="line">  .minor = MISC_DYNAMIC_MINOR,</span><br><span class="line">  .name = <span class="string">&quot;testmisc&quot;</span>,</span><br><span class="line">  .fops = &amp;dev_fops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;Dual BSD/GPL&quot;</span>);</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">ko_test_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  printk(<span class="string">&quot;This is a test ko!\n&quot;</span>);</span><br><span class="line">  <span class="type">int</span> err = misc_register(&amp;test_misc);</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    printk(<span class="string">&quot;envctrl: Unable to get misc minor %d/n&quot;</span>,test_misc.minor);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">ko_test_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  printk(<span class="string">&quot;Bye Bye~\n&quot;</span>);</span><br><span class="line">  misc_deregister(&amp;test_misc);</span><br><span class="line">&#125;</span><br><span class="line">module_init(ko_test_init);</span><br><span class="line">module_exit(ko_test_exit);</span><br></pre></td></tr></table></figure>

<p><strong>重写了驱动的ioctl函数</strong></p>
<blockquote>
<p>32位的APP运行在64位的kernel上，调用的是<strong>compat_ioctl</strong></p>
<p>64位的用户程序运行在64位的kernel上，调用的是<strong>unlocked_ioctl</strong>，如果是32位的APP运行在32位的kernel上，调用的也是<strong>unlocked_ioctl</strong></p>
</blockquote>
<p>用户态测试程序</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">int</span> fd=open(<span class="string">&quot;/dev/testmisc&quot;</span>,O_RDONLY);</span><br><span class="line">  <span class="keyword">if</span>(<span class="number">-1</span>==fd)&#123;</span><br><span class="line">    perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">int</span> res=ioctl(fd, <span class="number">0x666</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;res:%d\n&quot;</span>,res);</span><br><span class="line">  res=ioctl(fd, <span class="number">0x888</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;res:%d\n&quot;</span>,res);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="内核防护"><a href="#内核防护" class="headerlink" title="内核防护"></a>内核防护</h2><h3 id="KASLR"><a href="#KASLR" class="headerlink" title="KASLR"></a>KASLR</h3><p>kernel address space layout randomize 内核空间地址随机化</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemu开启smep -append ”kaslr“</span><br><span class="line">    关闭	   -append ”nokaslr“</span><br></pre></td></tr></table></figure>

<h3 id="FGKASLR"><a href="#FGKASLR" class="headerlink" title="FGKASLR"></a>FGKASLR</h3><p>FGKASLR 在KASLR基地址随机化的基础上，在加载时刻，以函数粒度重新排布内核代码</p>
<h3 id="STACK-PROTECTOR"><a href="#STACK-PROTECTOR" class="headerlink" title="STACK PROTECTOR"></a>STACK PROTECTOR</h3><p>类似于用户态程序的 canary,x86 架构下 Canary 实现的特点是同一个 task 共享 Canary</p>
<p>内核中的 canary 的值通常取自 gs 段寄存器某个固定偏移处的值</p>
<h3 id="SMEP-x2F-SMAP"><a href="#SMEP-x2F-SMAP" class="headerlink" title="SMEP&#x2F;SMAP"></a>SMEP&#x2F;SMAP</h3><p><img src="/2023/08/08/first-kernelpwn/image-20230811154518221.png" alt="image-20230811154518221"></p>
<p>Supervisor Mode <strong>Execution</strong> Protection 管理模式执行保护 内核态不可执行用户态的代码</p>
<p>ARM里叫做PXN</p>
<p>CR4寄存器中的第<strong>20</strong>位来标记</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemu开启smep     -cpu qemu64-v1,smep</span><br></pre></td></tr></table></figure>

<p>Supervisor Mode <strong>Access</strong> Prevention 管理模式访问保护 内核态不可访问用户态的数据</p>
<p>ARM里叫做PAN</p>
<p>CR4寄存器中的第<strong>21</strong>位来标记</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemu开启smep     -cpu qemu64-v1,smap</span><br></pre></td></tr></table></figure>

<h3 id="KPTI"><a href="#KPTI" class="headerlink" title="KPTI"></a><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/137277724">KPTI</a></h3><p><img src="/2023/08/08/first-kernelpwn/image-20230811165305116.png" alt="image-20230811165305116"></p>
<p>Kernel Page Table Isolation 用户态不可看到内核态的页表；内核态<strong>不可执行</strong>用户态的代码</p>
<p>KPTI的发明也修复了Meltdown漏洞</p>
<ul>
<li>内核态中的页表包括用户空间内存的页表和内核空间内存的页表， x86_64 的 PTI 机制中，内核态的用户空间内存映射部分被全部标记为不可执行</li>
<li>用户态的页表只包括用户空间内存的页表以及必要的内核空间内存的页表，如用于处理系统调用、中断等信息的内存。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemu开启smep -append ”kpti=1“</span><br><span class="line">    关闭	   -append ”nopti“</span><br></pre></td></tr></table></figure>

<p>Linux 4.15 中引入了 KPTI 机制，并且该机制被反向移植到了 Linux 4.14.11，4.9.75，4.4.110</p>
<h3 id="访问控制"><a href="#访问控制" class="headerlink" title="访问控制"></a>访问控制</h3><h4 id="dmesg-restrict"><a href="#dmesg-restrict" class="headerlink" title="dmesg_restrict"></a>dmesg_restrict</h4><p><code>/proc/sys/kernel/dmesg_restrict</code></p>
<p>该选项用于控制是否可以使用 <code>dmesg</code> 来查看内核日志 </p>
<ul>
<li>0 没有任何限制</li>
<li>1 只有具有 <code>CAP_SYSLOG</code> 权限的用户才可以通过 <code>dmesg</code> 命令来查看内核日志。</li>
</ul>
<h4 id="kptr-restrict"><a href="#kptr-restrict" class="headerlink" title="kptr_restrict"></a>kptr_restrict</h4><p> <code>/proc/sys/kernel/kptr_restrict</code></p>
<p>该选项用于控制在输出内核地址时施加的限制,如通过&#x2F;proc</p>
<ul>
<li>0：默认情况下，没有任何限制。</li>
<li>1：使用 <code>％pK</code> 输出的内核指针地址将被替换为 0，除非用户具有 CAP_SYSLOG 特权，并且 group id 和真正的 id 相等。</li>
<li>2：使用 <code>％pK</code> 输出的内核指针都将被替换为 0 ，即与权限无关。</li>
</ul>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83"><span class="toc-number">1.</span> <span class="toc-text">环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#busybox%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.1.</span> <span class="toc-text">busybox文件系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E6%A0%B8"><span class="toc-number">1.2.</span> <span class="toc-text">内核</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%B7%B1%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8"><span class="toc-number">1.2.1.</span> <span class="toc-text">自己编译内核</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E7%8E%B0%E6%9C%89%E5%86%85%E6%A0%B8%E9%95%9C%E5%83%8F"><span class="toc-number">1.2.2.</span> <span class="toc-text">下载现有内核镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8%E9%95%9C%E5%83%8F"><span class="toc-number">1.2.3.</span> <span class="toc-text">系统内核镜像</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%86%85%E6%A0%B8"><span class="toc-number">1.3.</span> <span class="toc-text">启动内核</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%86%85%E6%A0%B8"><span class="toc-number">1.4.</span> <span class="toc-text">调试内核</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Loadable-Kernel-Modules%EF%BC%88LKMs%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">Loadable Kernel Modules（LKMs）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%82%E9%A1%B9%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87"><span class="toc-number">2.1.</span> <span class="toc-text">杂项字符设备</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E9%98%B2%E6%8A%A4"><span class="toc-number">3.</span> <span class="toc-text">内核防护</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#KASLR"><span class="toc-number">3.1.</span> <span class="toc-text">KASLR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FGKASLR"><span class="toc-number">3.2.</span> <span class="toc-text">FGKASLR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#STACK-PROTECTOR"><span class="toc-number">3.3.</span> <span class="toc-text">STACK PROTECTOR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SMEP-x2F-SMAP"><span class="toc-number">3.4.</span> <span class="toc-text">SMEP&#x2F;SMAP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KPTI"><span class="toc-number">3.5.</span> <span class="toc-text">KPTI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="toc-number">3.6.</span> <span class="toc-text">访问控制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#dmesg-restrict"><span class="toc-number">3.6.1.</span> <span class="toc-text">dmesg_restrict</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kptr-restrict"><span class="toc-number">3.6.2.</span> <span class="toc-text">kptr_restrict</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/08/08/first-kernelpwn/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&text=Kernel Pwn 基础"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=Kernel Pwn 基础"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&is_video=false&description=Kernel Pwn 基础"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Kernel Pwn 基础&body=Check out this article: https://grxer.gitee.io/2023/08/08/first-kernelpwn/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=Kernel Pwn 基础"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=Kernel Pwn 基础"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=Kernel Pwn 基础"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=Kernel Pwn 基础"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&name=Kernel Pwn 基础&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&t=Kernel Pwn 基础"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023
    bxz
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?a22ef0bec4e4a9c7337bea6e37ff55c1";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
