<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="baidu-site-verification" content="codeva-ROfYcqLkCh" />
    <meta name="msvalidate.01" content="ECA3E06A0E52A2AC90C4B06F12981FB2" />
    <meta name="description" content="环境搭建以CISCN2017-babydriver为例 busybox文件系统简单的文件系统，提供基本用户环境，如一些常用命令和工具 https:&#x2F;&#x2F;www.busybox.net&#x2F; make menuconfig  将busybox编译为静态链接的文件  make -j6make install  编译其他架构busybox make -j4 CROSS_COMPILE &#x3D; 其他架构交叉编译器">
<meta property="og:type" content="article">
<meta property="og:title" content="kernel pwn">
<meta property="og:url" content="https://grxer.gitee.io/2023/08/08/first-kernelpwn/index.html">
<meta property="og:site_name" content="Grxer&#39;s Blog">
<meta property="og:description" content="环境搭建以CISCN2017-babydriver为例 busybox文件系统简单的文件系统，提供基本用户环境，如一些常用命令和工具 https:&#x2F;&#x2F;www.busybox.net&#x2F; make menuconfig  将busybox编译为静态链接的文件  make -j6make install  编译其他架构busybox make -j4 CROSS_COMPILE &#x3D; 其他架构交叉编译器">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://grxer.gitee.io/2023/08/08/first-kernelpwn/image-20230808234139406.png">
<meta property="article:published_time" content="2023-08-08T15:26:28.000Z">
<meta property="article:modified_time" content="2023-08-09T16:14:07.278Z">
<meta property="article:author" content="bxz">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://grxer.gitee.io/2023/08/08/first-kernelpwn/image-20230808234139406.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>kernel pwn</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2222/02/22/EnglishLearn/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/08/06/House-Of-Roman/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/08/08/first-kernelpwn/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&text=kernel pwn"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=kernel pwn"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&is_video=false&description=kernel pwn"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=kernel pwn&body=Check out this article: https://grxer.gitee.io/2023/08/08/first-kernelpwn/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=kernel pwn"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=kernel pwn"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=kernel pwn"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=kernel pwn"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&name=kernel pwn&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&t=kernel pwn"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.</span> <span class="toc-text">环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#busybox%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.1.</span> <span class="toc-text">busybox文件系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E6%A0%B8"><span class="toc-number">1.2.</span> <span class="toc-text">内核</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%B7%B1%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8"><span class="toc-number">1.2.1.</span> <span class="toc-text">自己编译内核</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E7%8E%B0%E6%9C%89%E5%86%85%E6%A0%B8%E9%95%9C%E5%83%8F"><span class="toc-number">1.2.2.</span> <span class="toc-text">下载现有内核镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8%E9%95%9C%E5%83%8F"><span class="toc-number">1.2.3.</span> <span class="toc-text">系统内核镜像</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%86%85%E6%A0%B8"><span class="toc-number">1.3.</span> <span class="toc-text">启动内核</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%86%85%E6%A0%B8"><span class="toc-number">1.4.</span> <span class="toc-text">调试内核</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        kernel pwn
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">bxz</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-08-08T15:26:28.000Z" itemprop="datePublished">2023-08-08</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>以<a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-challenges/blob/master/pwn/kernel/CISCN2017-babydriver/babydriver.tar">CISCN2017-babydriver</a>为例</p>
<h3 id="busybox文件系统"><a href="#busybox文件系统" class="headerlink" title="busybox文件系统"></a><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/BusyBox">busybox文件系统</a></h3><p>简单的文件系统，提供基本用户环境，如一些常用命令和工具</p>
<p><a target="_blank" rel="noopener" href="https://www.busybox.net/">https://www.busybox.net/</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></table></figure>

<p>将busybox编译为静态链接的文件</p>
<p><img src="/2023/08/08/first-kernelpwn/image-20230808234139406.png" alt="image-20230808234139406"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">make -j6</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>编译其他架构busybox</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make -j4 CROSS_COMPILE = 其他架构交叉编译器</span><br></pre></td></tr></table></figure>

<p>在编译好的文件夹下(默认为_install)</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir -p  proc sys dev etc/init.d</span><br></pre></td></tr></table></figure>

<p>写下init 脚本 chmod +x init </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">echo &quot;INIT SCRIPT&quot;</span><br><span class="line">mkdir /tmp</span><br><span class="line">mount -t proc none /proc    </span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line">echo -e &quot;Boot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds&quot;</span><br><span class="line">insmod /babydriver.ko</span><br><span class="line">setsid /bin/cttyhack setuidgid 0 /bin/sh</span><br></pre></td></tr></table></figure>

<p>打包脚本</p>
<p>pack.sh</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">sudo cp -r rootfs rootfs_tmp</span><br><span class="line">sudo cp init rootfs_tmp/</span><br><span class="line">sudo cp babydriver.ko rootfs_tmp/</span><br><span class="line"></span><br><span class="line">sudo chmod +x rootfs_tmp/</span><br><span class="line">sudo chmod g-w -R rootfs_tmp/</span><br><span class="line">sudo chmod o-w -R rootfs_tmp/</span><br><span class="line">sudo chown -R root rootfs_tmp/</span><br><span class="line">sudo chgrp -R root rootfs_tmp/</span><br><span class="line">sudo chmod u+s rootfs_tmp/bin/busybox</span><br><span class="line"></span><br><span class="line">cd rootfs_tmp</span><br><span class="line">sudo mkdir -p  proc sys dev etc/init.d</span><br><span class="line">find . | cpio -o --format=newc &gt; ../rootfs.img</span><br><span class="line">cd ../</span><br><span class="line">sudo rm -rf ./rootfs_tmp</span><br></pre></td></tr></table></figure>

<h3 id="内核"><a href="#内核" class="headerlink" title="内核"></a>内核</h3><h4 id="自己编译内核"><a href="#自己编译内核" class="headerlink" title="自己编译内核"></a>自己编译内核</h4><p><a target="_blank" rel="noopener" href="https://www.kernel.org/">https://www.kernel.org/</a></p>
<p><a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/kernel/">https://mirrors.tuna.tsinghua.edu.cn/kernel/</a></p>
<p><a target="_blank" rel="noopener" href="https://cdn.kernel.org/pub/linux/kernel/">https://cdn.kernel.org/pub/linux/kernel/</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/SweeNeil/article/details/88655995">不要在共享目录下来解压kernel，不然会有些符合链接的问题</a></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make help</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make menuconfig</span><br><span class="line">make -j4 bzImage</span><br></pre></td></tr></table></figure>

<p>跨平台</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ARCH=平台 CROSS_COMPILE= 其他架构交叉编译器 make -j4 bzImage</span><br></pre></td></tr></table></figure>

<p>一般按照题目给的内核文件bzImage编译指定版本内核</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/kernel-env&gt; file ./bzImage</span><br><span class="line">./bzImage: Linux kernel x86 boot executable bzImage, version 4.4.72 (atum@ubuntu) #1 SMP Thu Jun 15 19:52:50 PDT 2017, RO-rootFS, swap_dev 0X6, Normal VGA</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.4.72.tar.gz">https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.4.72.tar.gz</a></p>
<p>确定一下gcc版本,防止一些不必要的问题</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/kernel-env&gt; strings ./bzImage | grep &#x27;gcc&#x27;</span><br><span class="line">4.4.72 (atum@ubuntu) (gcc version 5.4.0 20160609 (Ubuntu 5.4.0-6ubuntu1~16.04.4) ) #1 SMP Thu Jun 15 19:52:50 PDT 2017</span><br></pre></td></tr></table></figure>

<p>自己编译时遇到的问题</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/k/linux-4.4.42&gt; make menuconfig</span><br><span class="line">  HOSTCC  scripts/kconfig/mconf.o</span><br><span class="line">In file included from scripts/kconfig/mconf.c:23:0:</span><br><span class="line">scripts/kconfig/lxdialog/dialog.h:38:20: fatal error: curses.h: No such file or directory</span><br><span class="line">compilation terminated.</span><br><span class="line">scripts/Makefile.host:108: recipe for target &#x27;scripts/kconfig/mconf.o&#x27; failed</span><br><span class="line">make[1]: *** [scripts/kconfig/mconf.o] Error 1</span><br><span class="line">Makefile:542: recipe for target &#x27;menuconfig&#x27; failed</span><br><span class="line">make: *** [menuconfig] Error 2</span><br><span class="line">解决</span><br><span class="line">sudo apt-get install libncurses5-dev</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">scripts/sign-file.c:23:30: fatal error: openssl/opensslv.h: No such file or directory</span><br><span class="line">compilation terminated.</span><br><span class="line">scripts/Makefile.host:91: recipe for target &#x27;scripts/sign-file&#x27; failed</span><br><span class="line">make[1]: *** [scripts/sign-file] Error 1</span><br><span class="line">make[1]: *** Waiting for unfinished jobs....</span><br><span class="line">  HOSTCC  arch/x86/tools/relocs_common.o</span><br><span class="line">  HOSTLD  arch/x86/tools/relocs</span><br><span class="line">Makefile:556: recipe for target &#x27;scripts&#x27; failed</span><br><span class="line">make: *** [scripts] Error 2</span><br><span class="line">make: *** Waiting for unfinished jobs....</span><br><span class="line">解决</span><br><span class="line">grxer@Ubuntu16 /m/h/s/k/linux-4.4.42&gt;  sudo apt-get install libssl-dev </span><br></pre></td></tr></table></figure>

<p>编译成功</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Setup is 17404 bytes (padded to 17408 bytes).</span><br><span class="line">System is 6820 kB</span><br><span class="line">CRC df8a19f</span><br><span class="line">Kernel: arch/x86/boot/bzImage is ready  (#1)</span><br></pre></td></tr></table></figure>

<p>两个比较重要的文件就是</p>
<ul>
<li>bzImage：<code>arch/x86/boot/bzImage</code></li>
<li>vmlinux：用来调试</li>
</ul>
<h4 id="下载现有内核镜像"><a href="#下载现有内核镜像" class="headerlink" title="下载现有内核镜像"></a>下载现有内核镜像</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt search linux-image- </span><br><span class="line">sudo apt download xxxxx</span><br><span class="line">dpkg -X xxxx extract</span><br><span class="line">./boot/xxx-generic即为bzImage内核镜像文件</span><br></pre></td></tr></table></figure>

<h4 id="系统内核镜像"><a href="#系统内核镜像" class="headerlink" title="系统内核镜像"></a>系统内核镜像</h4><p>&#x2F;boot&#x2F;目录下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~&gt; ll -a /boot</span><br><span class="line">total 177M</span><br><span class="line">drwxr-xr-x  4 root root 4.0K  7月 12 09:06 .</span><br><span class="line">drwxr-xr-x 20 root root 4.0K  7月 28 15:44 ..</span><br><span class="line">-rw-r--r--  1 root root 264K  6月  7 22:23 config-5.19.0-45-generic</span><br><span class="line">-rw-r--r--  1 root root 264K  6月 21 22:38 config-5.19.0-46-generic</span><br><span class="line">drwx------  3 root root 4.0K  1月  1  1970 efi</span><br><span class="line">drwxr-xr-x  6 root root 4.0K  7月 12 09:05 grub</span><br><span class="line">lrwxrwxrwx  1 root root   28  7月 12 09:03 initrd.img -&gt; initrd.img-5.19.0-46-generic</span><br><span class="line">-rw-r--r--  1 root root  70M  7月 12 09:04 initrd.img-5.19.0-45-generic</span><br><span class="line">-rw-r--r--  1 root root  70M  7月 12 09:04 initrd.img-5.19.0-46-generic</span><br><span class="line">lrwxrwxrwx  1 root root   28  7月 12 09:03 initrd.img.old -&gt; initrd.img-5.19.0-45-generic</span><br><span class="line">-rw-r--r--  1 root root 179K  2月  7  2022 memtest86+.bin</span><br><span class="line">-rw-r--r--  1 root root 181K  2月  7  2022 memtest86+.elf</span><br><span class="line">-rw-r--r--  1 root root 181K  2月  7  2022 memtest86+_multiboot.bin</span><br><span class="line">-rw-------  1 root root 6.2M  6月  7 22:23 System.map-5.19.0-45-generic</span><br><span class="line">-rw-------  1 root root 6.2M  6月 21 22:38 System.map-5.19.0-46-generic</span><br><span class="line">lrwxrwxrwx  1 root root   25  7月 12 09:03 vmlinuz -&gt; vmlinuz-5.19.0-46-generic</span><br><span class="line">-rw-------  1 root root  12M  6月  7 22:23 vmlinuz-5.19.0-45-generic</span><br><span class="line">-rw-------  1 root root  12M  6月 21 22:43 vmlinuz-5.19.0-46-generic</span><br><span class="line">lrwxrwxrwx  1 root root   25  7月 12 09:03 vmlinuz.old -&gt; vmlinuz-5.19.0-45-generic</span><br><span class="line">grxer@Ubuntu22 ~&gt; <span class="built_in">uname</span> -r</span><br><span class="line">5.19.0-46-generic</span><br><span class="line">grxer@Ubuntu22 ~&gt; sudo file /boot/vmlinuz-5.19.0-46-generic</span><br><span class="line">[sudo] password <span class="keyword">for</span> grxer:</span><br><span class="line">/boot//vmlinuz-5.19.0-46-generic: Linux kernel x86 boot executable bzImage, version 5.19.0-46-generic (buildd@lcy02-amd64-025) <span class="comment">#47~22.04.1-Ubuntu SMP PREEMPT_DYNAMIC Wed Jun 21 15:35:31 UTC 2, RO-rootFS, swap_dev 0XB, Normal VGA</span></span><br></pre></td></tr></table></figure>

<p>vmlinuz-5.19.0-46-generic 内核</p>
<p>initrd.img-5.19.0-46-generic 引导文件</p>
<h3 id="启动内核"><a href="#启动内核" class="headerlink" title="启动内核"></a>启动内核</h3><p>start.sh</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m <span class="number">64</span>M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd  ./rootfs.img \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr&quot;</span> \</span><br><span class="line">    -smp cores=<span class="number">2</span>,threads=<span class="number">1</span> \</span><br><span class="line">    -cpu kvm64</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-m</code>：虚拟机内存大小</li>
<li><code>-nographic</code>：以非图形界面模式运行虚拟机</li>
<li><code>-kernel</code>：指定内核镜像文件</li>
<li><code>initrd</code>：指定初始RAM磁盘镜像文件</li>
<li><code>append</code>：设置内核启动附加参数</li>
<li><code>smp</code>:设置虚拟机的处理器拓扑，此处使用 2 个核心和 1 个线程</li>
<li><code>cpu</code>:设置CPU安全选项</li>
</ul>
<h3 id="调试内核"><a href="#调试内核" class="headerlink" title="调试内核"></a>调试内核</h3><p>启动脚本里关掉aslr</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 nokaslr&quot; \</span><br></pre></td></tr></table></figure>

<p>开启调试接口</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">启动参数中添加  -gdb dev，如-gdb tcp::1234 可简写为-s 如果希望 qemu 启动后立即挂起，额外添加-S参数</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">~ # lsmod</span><br><span class="line">babydriver 16384 0 - Live 0xffffffffc0000000 (OE)</span><br><span class="line">~ # find /sys/| grep babydriver</span><br><span class="line">/sys/module/babydriver</span><br><span class="line">/sys/module/babydriver/srcversion</span><br><span class="line">/sys/module/babydriver/notes</span><br><span class="line">/sys/module/babydriver/notes/.note.gnu.build-id</span><br><span class="line">/sys/module/babydriver/taint</span><br><span class="line">/sys/module/babydriver/initstate</span><br><span class="line">/sys/module/babydriver/coresize</span><br><span class="line">/sys/module/babydriver/sections</span><br><span class="line">/sys/module/babydriver/sections/.bss</span><br><span class="line">/sys/module/babydriver/sections/.init.text</span><br><span class="line">/sys/module/babydriver/sections/.data</span><br><span class="line">/sys/module/babydriver/sections/.text</span><br><span class="line">/sys/module/babydriver/sections/__mcount_loc</span><br><span class="line">/sys/module/babydriver/sections/.strtab</span><br><span class="line">/sys/module/babydriver/sections/.symtab</span><br><span class="line">/sys/module/babydriver/sections/.gnu.linkonce.this_module</span><br><span class="line">/sys/module/babydriver/sections/.rodata.str1.1</span><br><span class="line">/sys/module/babydriver/sections/.note.gnu.build-id</span><br><span class="line">/sys/module/babydriver/sections/.exit.text</span><br><span class="line">/sys/module/babydriver/refcnt</span><br><span class="line">/sys/module/babydriver/uevent</span><br><span class="line">/sys/module/babydriver/holders</span><br><span class="line">/sys/module/babydriver/initsize</span><br><span class="line">~ # cat /sys/module/babydriver/sections/.text</span><br><span class="line">0xffffffffc0000000</span><br><span class="line">~ $ cat /sys/module/babydriver/sections/.bss</span><br><span class="line">0xffffffffc0002440</span><br><span class="line">~ $ cat /sys/module/babydriver/sections/.data</span><br><span class="line">0xffffffffc0002000</span><br></pre></td></tr></table></figure>

<p>gdb.sh</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">sudo gdb -q \</span><br><span class="line">      -ex &quot;file vmlinux&quot;\</span><br><span class="line">    -ex &quot;add-symbol-file babydriver.ko 0xffffffffc0000000 -s .data 0xffffffffc0002000 -s .bss 0xffffffffc0002440&quot;\</span><br><span class="line">    -ex &quot;target remote localhost:1234&quot;\</span><br><span class="line">    -ex &quot;b babyopen&quot; </span><br></pre></td></tr></table></figure>






  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.</span> <span class="toc-text">环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#busybox%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.1.</span> <span class="toc-text">busybox文件系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E6%A0%B8"><span class="toc-number">1.2.</span> <span class="toc-text">内核</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%B7%B1%E7%BC%96%E8%AF%91%E5%86%85%E6%A0%B8"><span class="toc-number">1.2.1.</span> <span class="toc-text">自己编译内核</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BD%E7%8E%B0%E6%9C%89%E5%86%85%E6%A0%B8%E9%95%9C%E5%83%8F"><span class="toc-number">1.2.2.</span> <span class="toc-text">下载现有内核镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8%E9%95%9C%E5%83%8F"><span class="toc-number">1.2.3.</span> <span class="toc-text">系统内核镜像</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%86%85%E6%A0%B8"><span class="toc-number">1.3.</span> <span class="toc-text">启动内核</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%86%85%E6%A0%B8"><span class="toc-number">1.4.</span> <span class="toc-text">调试内核</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/08/08/first-kernelpwn/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&text=kernel pwn"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=kernel pwn"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&is_video=false&description=kernel pwn"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=kernel pwn&body=Check out this article: https://grxer.gitee.io/2023/08/08/first-kernelpwn/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=kernel pwn"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=kernel pwn"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=kernel pwn"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&title=kernel pwn"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&name=kernel pwn&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/08/08/first-kernelpwn/&t=kernel pwn"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023
    bxz
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?a22ef0bec4e4a9c7337bea6e37ff55c1";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
